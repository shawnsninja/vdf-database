# 3.1 regions

  
https://gemini.google.com/u/1/app/cc0bffb89378d0df?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/e2231210a6330ec4 
https://gemini.google.com/u/1/app/a3fdff8118a11194 ### 3\. Updated 
Production-Ready Specification: `public.regions` 1\. Purpose & Primary 
Use-Cases This table stores core identifying, geographical, and relational 
information for major administrative or geographical regions relevant to 
pilgrimage trails (e.g., Toscana, Umbria). It serves as an anchor for regional 
data, linking to translated descriptive content, media, and other contextual 
details. All textual content is managed via `public.translations`, and 
characteristic tags are codes from `public.characteristic_tags_master`. Key 
User-Story Touchpoints: - Pilgrim: Browses regions (names/details via 
`translations`, characteristic tags via `characteristic_tags_master` and 
`translations`). - Admin: Manages core region records (slug, codes, links) and 
initiates translation. Manages `is_featured` status. - Manager: May 
contribute/verify primary language content for regional fields in 
`translations`. 2\. Schema | Column Name | Data Type | Constraints | 
Description | | `id` | `SERIAL` | `PRIMARY KEY` | Unique identifier for each 
region. Used as `row_foreign_key` in `translations`. | | `slug` | `TEXT` | `NOT 
NULL`, `UNIQUE` | URL-friendly identifier (e.g., "tuscany"). | | `country_code` 
| `TEXT` | `NOT NULL DEFAULT 'IT'`, `REFERENCES 
public.countries(iso_3166_1_alpha_2) ON DELETE RESTRICT ON UPDATE CASCADE` | 
2-letter ISO 3166-1 alpha-2 country code. | | `iso_3166_2_code` | `TEXT` | 
`UNIQUE` | ISO 3166-2 subdivision code (e.g., "IT-52"). | | 
`characteristics_tags` | `TEXT[]` | | Array of `code` values from 
`public.characteristic_tags_master`. (Translatable names via `translations`). | 
| `primary_media_id` | `INTEGER` | `REFERENCES public.media(id) ON DELETE SET 
NULL` | FK to `media` table for the primary representative image. (Alt text via 
`translations` linked to `media`). | | `official_tourism_url` | `TEXT` | `CHECK 
(official_tourism_url IS NULL OR official_tourism_url ~* '^https?://.+')` | URL 
to the region's official tourism website. | | `map_default_latitude` | `DOUBLE 
PRECISION` | `CHECK (map_default_latitude >= -90 AND map_default_latitude <= 
90)` | Default latitude (WGS 84) for centering maps. | | 
`map_default_longitude` | `DOUBLE PRECISION` | `CHECK (map_default_longitude >= 
-180 AND map_default_longitude <= 180)` | Default longitude (WGS 84) for 
centering maps. | | `map_default_zoom` | `SMALLINT` | `CHECK (map_default_zoom 
>= 0 AND map_default_zoom <= 22)` | Default zoom level for maps. | | 
`geo_boundary` | `GEOMETRY(Geometry, 4326)` | | Geographical boundary 
(Polygon/MultiPolygon, SRID 4326). | | `is_featured` | `BOOLEAN` | `NOT NULL 
DEFAULT false` | Flag to highlight the region in UI sections. | | 
`content_visibility_status` | `content_visibility_status_enum` | `NOT NULL 
DEFAULT 'draft'` | Moderation status of the core region entity. | | 
`created_by_profile_id` | `UUID` | `REFERENCES public.profiles(id) ON DELETE 
SET NULL` | Profile ID of the user who created the core region record. | | 
`updated_by_profile_id` | `UUID` | `REFERENCES public.profiles(id) ON DELETE 
SET NULL` | Profile ID of the user who last updated the core region record. | | 
`created_at` | `TIMESTAMPTZ` | `NOT NULL DEFAULT now()` | Timestamp of core 
record creation. | | `updated_at` | `TIMESTAMPTZ` | `NOT NULL DEFAULT now()` | 
Timestamp of core record last update. Auto-updated by trigger. | | `deleted_at` 
| `TIMESTAMPTZ` | | Timestamp for soft deletion. Active records have 
`deleted_at IS NULL`. | Translatable Fields (Managed in public.translations 
table): table_identifier = 'regions', row_foreign_key = regions.id::text - 
`name` (`column_identifier = 'name'`) - `description` (`column_identifier = 
'description'`) - `cultural_highlights` (`column_identifier = 
'cultural_highlights'`) (Translatable via `public.translations`) - 
`regional_contact_info` (`column_identifier = 'regional_contact_info'`) 
(Translatable via `public.translations`) - `best_time_to_visit` 
(`column_identifier = 'best_time_to_visit'`) (Translatable via 
`public.translations`) 3\. PostgreSQL DDL SQL ``` -- Assumed ENUM Type: 
content_visibility_status_enum -- Assumed dependent tables: public.countries, 
public.media, public.profiles, public.characteristic_tags_master -- Assumed 
i18n tables: public.translations CREATE TABLE IF NOT EXISTS public.regions ( id 
SERIAL PRIMARY KEY, slug TEXT NOT NULL UNIQUE, country_code TEXT NOT NULL 
DEFAULT 'IT' REFERENCES public.countries(iso_3166_1_alpha_2) ON DELETE RESTRICT 
ON UPDATE CASCADE, iso_3166_2_code TEXT UNIQUE, characteristics_tags TEXT[], -- 
Stores codes from characteristic_tags_master.code primary_media_id INTEGER 
REFERENCES public.media(id) ON DELETE SET NULL, official_tourism_url TEXT, 
map_default_latitude DOUBLE PRECISION CHECK (map_default_latitude >= -90 AND 
map_default_latitude <= 90), map_default_longitude DOUBLE PRECISION CHECK 
(map_default_longitude >= -180 AND map_default_longitude <= 180), 
map_default_zoom SMALLINT CHECK (map_default_zoom >= 0 AND map_default_zoom <= 
22), geo_boundary GEOMETRY(Geometry, 4326), is_featured BOOLEAN NOT NULL 
DEFAULT false, content_visibility_status content_visibility_status_enum NOT 
NULL DEFAULT 'draft', created_by_profile_id UUID REFERENCES public.profiles(id) 
ON DELETE SET NULL, updated_by_profile_id UUID REFERENCES public.profiles(id) 
ON DELETE SET NULL, created_at TIMESTAMPTZ NOT NULL DEFAULT now(), updated_at 
TIMESTAMPTZ NOT NULL DEFAULT now(), deleted_at TIMESTAMPTZ, CONSTRAINT 
check_official_tourism_url_format CHECK (official_tourism_url IS NULL OR 
official_tourism_url ~* '^https?://.+') ); COMMENT ON TABLE public.regions IS 
'Stores core identifying, geographical, and relational information for major 
regions. Textual content is in public.translations. Version: 2.0'; COMMENT ON 
COLUMN public.regions.id IS 'Unique identifier for each region. Used as 
row_foreign_key in translations table.'; COMMENT ON COLUMN public.regions.slug 
IS 'URL-friendly identifier (e.g., "tuscany"). Typically derived from the 
primary language name.'; COMMENT ON COLUMN public.regions.country_code IS 
'2-letter ISO 3166-1 alpha-2 country code this region belongs to.'; COMMENT ON 
COLUMN public.regions.iso_3166_2_code IS 'ISO 3166-2 subdivision code for the 
region (e.g., "IT-52" for Toscana).'; COMMENT ON COLUMN 
public.regions.characteristics_tags IS 'Array of code values from 
public.characteristic_tags_master. Describes general features. Translated names 
via translations linked to characteristic_tags_master.'; COMMENT ON COLUMN 
public.regions.primary_media_id IS 'FK to media table for the primary 
representative image. Alt text for this image is in translations via media 
table.'; COMMENT ON COLUMN public.regions.official_tourism_url IS 'URL to the 
region''s official tourism website. Validated for basic URL format.'; COMMENT 
ON COLUMN public.regions.map_default_latitude IS 'Default latitude (WGS 84) for 
centering maps on this region.'; COMMENT ON COLUMN 
public.regions.map_default_longitude IS 'Default longitude (WGS 84) for 
centering maps on this region.'; COMMENT ON COLUMN 
public.regions.map_default_zoom IS 'Default zoom level for maps when displaying 
this region.'; COMMENT ON COLUMN public.regions.geo_boundary IS 'Geographical 
boundary (Polygon/MultiPolygon, SRID 4326) of the region.'; COMMENT ON COLUMN 
public.regions.is_featured IS 'Flag to highlight the region in UI sections 
(e.g., homepage).'; COMMENT ON COLUMN public.regions.content_visibility_status 
IS 'Moderation status of the core region entity (translations have their own 
status).'; COMMENT ON COLUMN public.regions.created_by_profile_id IS 'Profile 
ID of the user who created the core region record.'; COMMENT ON COLUMN 
public.regions.updated_by_profile_id IS 'Profile ID of the user who last 
updated the core region record.'; COMMENT ON COLUMN public.regions.created_at 
IS 'Timestamp of core record creation.'; COMMENT ON COLUMN 
public.regions.updated_at IS 'Timestamp of core record last update. 
Auto-updated by trigger.'; COMMENT ON COLUMN public.regions.deleted_at IS 
'Timestamp for soft deletion. Active records have deleted_at IS NULL. Deleting 
a region will require deleting its translations via trigger.'; -- Indexing 
CREATE INDEX IF NOT EXISTS idx_regions_slug ON public.regions(slug); CREATE 
INDEX IF NOT EXISTS idx_regions_country_code ON public.regions(country_code); 
CREATE INDEX IF NOT EXISTS idx_regions_iso_3166_2_code ON 
public.regions(iso_3166_2_code) WHERE iso_3166_2_code IS NOT NULL; CREATE INDEX 
IF NOT EXISTS idx_regions_geo_boundary ON public.regions USING GIST 
(geo_boundary); CREATE INDEX IF NOT EXISTS idx_regions_is_featured ON 
public.regions(is_featured); CREATE INDEX IF NOT EXISTS 
idx_regions_content_visibility_status ON 
public.regions(content_visibility_status); CREATE INDEX IF NOT EXISTS 
idx_regions_characteristics_tags ON public.regions USING GIN 
(characteristics_tags); -- For array searching -- Trigger for updated_at 
(ensure public.handle_updated_at() function exists) CREATE TRIGGER 
trigger_regions_set_updated_at BEFORE UPDATE ON public.regions FOR EACH ROW 
EXECUTE FUNCTION public.handle_updated_at(); -- Trigger for deleting related 
translations (ensure public.cleanup_related_translations() function exists) 
CREATE TRIGGER trigger_delete_region_translations AFTER DELETE ON 
public.regions FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_related_translations(); -- Uses OLD.id::TEXT and 'regions' -- 
Trigger for validating characteristics_tags CREATE OR REPLACE FUNCTION 
public.validate_region_characteristics_tags() RETURNS TRIGGER AS $$ DECLARE 
tag_code TEXT; tag_record public.characteristic_tags_master; BEGIN IF TG_OP = 
'INSERT' OR (TG_OP = 'UPDATE' AND NEW.characteristics_tags IS DISTINCT FROM 
OLD.characteristics_tags) THEN IF NEW.characteristics_tags IS NOT NULL THEN 
FOREACH tag_code IN ARRAY NEW.characteristics_tags LOOP SELECT * INTO 
tag_record FROM public.characteristic_tags_master WHERE code = tag_code; IF NOT 
FOUND THEN RAISE EXCEPTION 'Invalid characteristic_tag_code "%" does not exist 
in characteristic_tags_master.', tag_code; END IF; IF NOT tag_record.is_active 
THEN RAISE EXCEPTION 'Characteristic tag "%" is not active.', tag_code; END IF; 
END LOOP; END IF; END IF; RETURN NEW; END; $$ LANGUAGE plpgsql SECURITY 
DEFINER; -- SECURITY DEFINER if characteristic_tags_master has restrictive RLS 
for invoking user. Review implications. CREATE TRIGGER 
trigger_validate_characteristics_tags BEFORE INSERT OR UPDATE ON public.regions 
FOR EACH ROW EXECUTE FUNCTION public.validate_region_characteristics_tags(); -- 
RLS Policies ALTER TABLE public.regions ENABLE ROW LEVEL SECURITY; CREATE 
POLICY "Allow admin full access on regions" ON public.regions FOR ALL USING 
(public.is_platform_admin()) -- Assumes helper function WITH CHECK 
(public.is_platform_admin()); CREATE POLICY "Allow authenticated users read 
access on regions" ON public.regions FOR SELECT TO authenticated USING 
(deleted_at IS NULL AND content_visibility_status = 'published'); -- Example, 
adjust as per full requirements CREATE POLICY "Allow anonymous users read 
access on regions" ON public.regions FOR SELECT TO anon USING (deleted_at IS 
NULL AND content_visibility_status = 'published'); -- Example, adjust ``` 4\. 
JSON Schema Mirror JSON ``` { "title": "region", "description": "Core 
identifying and geographical information for regions. Textual content is in 
'translations' table. Characteristic tags are codes from 
'characteristic_tags_master'. Version: 2.0", "type": "object", "properties": { 
"id": { "type": "integer", "readOnly": true, "description": "Unique identifier. 
Used as 'row_foreign_key' in 'translations'." }, "slug": { "type": "string", 
"description": "URL-friendly identifier (e.g., \"tuscany\"). Unique.", 
"pattern": "^[a-z0-9]+(?:-[a-z0-9]+)*$", "maxLength": 255 }, "country_code": { 
"type": "string", "description": "2-letter ISO 3166-1 alpha-2 country code. 
Defaults to 'IT'.", "default": "IT", "pattern": "^[A-Z]{2}$" }, 
"iso_3166_2_code": { "type": ["string", "null"], "description": "ISO 3166-2 
subdivision code (e.g., \"IT-52\" for Toscana). Unique if provided.", 
"pattern": "^[A-Z]{2}-[A-Z0-9]{1,3}$" }, "characteristics_tags": { "type": 
["array", "null"], "items": { "type": "string" }, "description": "Array of 
codes from public.characteristic_tags_master.code." }, "primary_media_id": { 
"type": ["integer", "null"], "description": "FK to 'media' table for the 
primary image." }, "official_tourism_url": { "type": ["string", "null"], 
"format": "url", "description": "URL to the region's official tourism website." 
}, "map_default_latitude": { "type": ["number", "null"], "minimum": -90, 
"maximum": 90 }, "map_default_longitude": { "type": ["number", "null"], 
"minimum": -180, "maximum": 180 }, "map_default_zoom": { "type": ["integer", 
"null"], "minimum": 0, "maximum": 22 }, "geo_boundary": { "type": ["object", 
"null"], "description": "GeoJSON representation of the geometry." }, 
"is_featured": { "type": "boolean", "default": false }, 
"content_visibility_status": { "type": "string", "default": "draft", "enum": 
["draft", "pending_review", "published", "archived", "rejected"], 
"description": "Moderation status." }, "created_by_profile_id": { "type": 
["string", "null"], "format": "uuid" }, "updated_by_profile_id": { "type": 
["string", "null"], "format": "uuid" }, "created_at": { "type": "string", 
"format": "date-time", "readOnly": true }, "updated_at": { "type": "string", 
"format": "date-time", "readOnly": true }, "deleted_at": { "type": ["string", 
"null"], "format": "date-time", "readOnly": true } }, "required": [ "slug", 
"country_code", "is_featured", "content_visibility_status" ] } ``` 5\. 
Relationships & Integrity - Primary Key: `id` (SERIAL). - Foreign Keys: 
`country_code` to `public.countries`, `primary_media_id` to `public.media`, 
`created_by_profile_id`/`updated_by_profile_id` to `public.profiles`. - Array 
FK Integrity: `characteristics_tags` elements are validated against 
`public.characteristic_tags_master.code` (and its `is_active` status) via 
`trigger_validate_characteristics_tags`. - URL Validation: 
`official_tourism_url` uses a `CHECK` constraint. - Referenced By: 
`public.translations`, `public.towns.region_id`, `public.provinces.region_id`. 
Potentially `trail_regions.region_id`. - Orphaned Translations: Managed by 
`trigger_delete_region_translations`. 6\. Multilingual Strategy All displayable 
text content for regions is stored in public.translations (table_identifier = 
'regions'). characteristics_tags codes are translated by looking up their 
respective entries in translations (where table_identifier = 
'characteristic_tags_master'). 7\. Role-Based Workflow & RLS Notes - Content 
Management: Admins/Regional Managers manage core `regions` records. Textual 
content via `public.translations` workflow. - RLS Policies: Admins full access. 
Authenticated/Anonymous users have read access to published and non-deleted 
regions. `content_visibility_status` and `deleted_at` are key for RLS. 8\. ENUM 
vs Lookup Discussion characteristics_tags correctly uses codes from a master 
table (characteristic_tags_master), replacing an ENUM approach for better 
flexibility and i18n. content_visibility_status_enum is a suitable global ENUM. 
9\. UI/UX Enablement - UI fetches core data from `public.regions` and textual 
content from `public.translations`. - `characteristics_tags` codes are used to 
fetch translated names and icons from `characteristic_tags_master` and 
`translations`. - Helper functions (e.g., for translations) can simplify data 
retrieval for the API. 10\. Key Considerations & Definitions - Canonical Name: 
Defined by entry in `public.translations` for the primary content language. - 
Slug Generation: Ideally from primary language name; consider update strategy 
if name changes. - Media Galleries: If multiple images per region are needed 
beyond `primary_media_id`, a `public.region_media` linking table (with 
`media_id` and `media_role_code`) should be implemented. - 
`validate_region_characteristics_tags` Security: The trigger function may need 
`SECURITY DEFINER` if the invoking user might not have direct SELECT permission 
on `characteristic_tags_master`, but this must be used cautiously with a 
hardened `search_path`. 11\. Scalability & Future-Proofing Centralized i18n is 
scalable. GIST/GIN indexes aid performance. translations table is the primary 
candidate for future scaling considerations like partitioning. 12\. Next-Action 
Checklist - ðŸ”´ Define Helper Function: Ensure `public.is_platform_admin()` is 
defined and secure. - ðŸ”´ Define `updated_at` Trigger Function: Ensure 
`public.handle_updated_at()` is defined. - ðŸ”´ Define 
`content_visibility_status_enum`: Ensure this ENUM type is created. - ðŸ”´ Review 
`validate_region_characteristics_tags`: Finalize the function logic and decide 
on `SECURITY DEFINER` vs. `SECURITY INVOKER` based on permissions. - ðŸŸ  Deploy 
DDL: Apply the `CREATE TABLE` and `COMMENT` DDL for `public.regions`. - ðŸŸ  
Implement Triggers: Create/apply `trigger_regions_set_updated_at`, 
`trigger_delete_region_translations`, and 
`trigger_validate_characteristics_tags`. - ðŸŸ  Implement RLS Policies: Apply the 
RLS policies as defined. - ðŸŸ¢ Data Migration: Plan migration if updating from 
an older schema (especially for `characteristics_tags` if it was previously an 
enum). - ðŸŸ¢ Consider `region_media` Table: Evaluate need for a dedicated 
gallery media linking table for regions. ### 4\. Diff Summary - Added Columns: 
- None (the input spec `3.1 regions.docx` was already quite complete for 
columns). - Modified Columns: - `official_tourism_url`: Added a `CHECK` 
constraint for URL format. - Removed Columns: - None. - Added DDL Elements: - 
`COMMENT ON TABLE` and `COMMENT ON COLUMN` statements. - `CHECK` constraint 
`check_official_tourism_url_format`. - `validate_region_characteristics_tags()` 
function and `trigger_validate_characteristics_tags` trigger. - RLS policies 
updated: admin policy uses `public.is_platform_admin()` and `WITH CHECK`; 
public read policies now explicitly check `deleted_at IS NULL` and 
`content_visibility_status = 'published'`. - Modified DDL Elements: - 
`updated_at` trigger function reference standardized to 
`public.handle_updated_at()`. - RLS policies updated to be more robust and 
aligned with checklist. - Added Documentation/Sections: - Section 10 ("Key 
Considerations & Definitions") expanded to include media galleries and trigger 
security. - "Next-Action Checklist" made more specific. - JSON Schema: - Added 
`enum` to `content_visibility_status`. - Included comments from DDL where 
appropriate. - Notes: - The original spec `3.1 regions.docx` was already V3 and 
i18n-aligned, so fewer structural changes were needed compared to a V1 spec. 
The focus was on V2 checklist compliance items like array FK integrity, 
explicit comments, and RLS hardening. 
