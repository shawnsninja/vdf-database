# 3.5 characteristic_tags_master

  https://gemini.google.com/u/1/app/e2231210a6330ec4 
https://gemini.google.com/u/1/app/a3fdff8118a11194 Here is the full updated 
production-ready specification for `public.characteristic_tags_master`. ### 
Updated Production-Ready Specification: `public.characteristic_tags_master` 1\. 
Purpose & Primary Use-Cases This table serves as a master lookup for 
categorizing region characteristics (e.g., "mountainous," "coastal," "historic 
towns"). It provides unique, stable codes for these characteristics and allows 
association with non-translatable metadata like icons or display order. All 
display names and descriptions for these characteristic tags are managed in the 
`public.translations` table, ensuring consistent and translatable 
classification. This table is referenced by 
`public.regions.characteristics_tags`. Key User-Story Touchpoints: - Pilgrim: 
Sees translated characteristic tags (names fetched from `translations`) on a 
region's page or as filter options. - Admin/Manager: Uses characteristic codes 
to tag regions and manages primary language names/descriptions in 
`translations`. Manages codes, icons, and display order in this master table. - 
Platform: Uses codes for filtering regions. 2\. Schema | Column Name | Data 
Type | Constraints | Description | | `code` | `TEXT` | `PRIMARY KEY` | Unique, 
stable code for the tag (e.g., 'mountainous'). Non-changing. Used as 
`row_foreign_key` in `translations`. | | `icon_identifier` | `TEXT` | | 
Optional identifier for a UI icon (e.g., 'icon-mountain'). | | `display_order` 
| `INTEGER` | `NOT NULL DEFAULT 0`, `UNIQUE` | For ordering tags in UI. Ensures 
deterministic sorting. | | `is_active` | `BOOLEAN` | `NOT NULL DEFAULT true` | 
Whether the tag is active and usable. | | `created_at` | `TIMESTAMPTZ` | `NOT 
NULL DEFAULT now()` | Timestamp of creation. | | `updated_at` | `TIMESTAMPTZ` | 
`NOT NULL DEFAULT now()` | Timestamp of last update. Auto-updated by trigger. | 
| `created_by_profile_id` | `UUID` | `REFERENCES public.profiles(id) ON DELETE 
SET NULL` | Profile ID of the user who created the record. | | 
`updated_by_profile_id` | `UUID` | `REFERENCES public.profiles(id) ON DELETE 
SET NULL` | Profile ID of the user who last updated the record. | Translatable 
Fields (Managed in public.translations table): The following conceptual fields 
for a characteristic tag will have their content stored in public.translations 
with table_identifier = 'characteristic_tags_master' and row_foreign_key = 
characteristic_tags_master.code: - `name` (e.g., `column_identifier = 'name'`) 
- `description` (e.g., `column_identifier = 'description'`, optional) 3\. 
PostgreSQL DDL SQL ``` CREATE TABLE IF NOT EXISTS 
public.characteristic_tags_master ( code TEXT PRIMARY KEY, icon_identifier 
TEXT, display_order INTEGER NOT NULL DEFAULT 0 UNIQUE, is_active BOOLEAN NOT 
NULL DEFAULT true, created_at TIMESTAMPTZ NOT NULL DEFAULT now(), updated_at 
TIMESTAMPTZ NOT NULL DEFAULT now(), created_by_profile_id UUID REFERENCES 
public.profiles(id) ON DELETE SET NULL, updated_by_profile_id UUID REFERENCES 
public.profiles(id) ON DELETE SET NULL ); COMMENT ON TABLE 
public.characteristic_tags_master IS 'Master lookup for region characteristic 
tags. Names/descriptions are in the public.translations table. Referenced by 
regions.characteristics_tags. Version: 2.0'; COMMENT ON COLUMN 
public.characteristic_tags_master.code IS 'Primary Key. Unique, stable code for 
the characteristic tag (e.g., ''mountainous'', ''historic_towns''). 
Non-changing. Used as row_foreign_key in translations.'; COMMENT ON COLUMN 
public.characteristic_tags_master.icon_identifier IS 'Optional identifier for a 
UI icon associated with this tag (e.g., ''icon-mountain'', ''icon-castle'').'; 
COMMENT ON COLUMN public.characteristic_tags_master.display_order IS 'For 
ordering tags in UI dropdowns, filter lists, or displays. Ensures deterministic 
sorting.'; COMMENT ON COLUMN public.characteristic_tags_master.is_active IS 
'Indicates if the characteristic tag is active and available for use in the 
system.'; COMMENT ON COLUMN public.characteristic_tags_master.created_at IS 
'Timestamp of when the characteristic tag record was created.'; COMMENT ON 
COLUMN public.characteristic_tags_master.updated_at IS 'Timestamp of when the 
characteristic tag record was last updated. Auto-updated by a trigger.'; 
COMMENT ON COLUMN public.characteristic_tags_master.created_by_profile_id IS 
'Profile ID of the user who created the characteristic tag record.'; COMMENT ON 
COLUMN public.characteristic_tags_master.updated_by_profile_id IS 'Profile ID 
of the user who last updated the characteristic tag record.'; -- Indexing: -- 
PRIMARY KEY on 'code' already creates a unique index. [cite: 535] -- UNIQUE 
constraint on 'display_order' already creates an index. [cite: 535] -- Trigger 
for updated_at (ensure public.handle_updated_at() or equivalent function 
exists) CREATE TRIGGER trigger_characteristic_tags_master_set_updated_at BEFORE 
UPDATE ON public.characteristic_tags_master FOR EACH ROW EXECUTE FUNCTION 
public.handle_updated_at(); -- Or extensions.moddatetime, or 
public.set_current_timestamp_updated_at [cite: 536] -- Trigger for deleting 
related translations -- (ensure public.cleanup_related_translations() function 
is adaptable for TEXT PKs -- or a specific version is made that correctly uses 
OLD.code as the row_foreign_key -- for table_identifier = 
'characteristic_tags_master') CREATE TRIGGER 
trigger_delete_characteristic_tag_translations AFTER DELETE ON 
public.characteristic_tags_master FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_related_translations(); [cite: 537] -- RLS Policies ALTER TABLE 
public.characteristic_tags_master ENABLE ROW LEVEL SECURITY; [cite: 538] CREATE 
POLICY "Allow admin full access on characteristic_tags_master" ON 
public.characteristic_tags_master FOR ALL USING (public.is_platform_admin()) -- 
Assumes helper function [cite: 539] WITH CHECK (public.is_platform_admin()); 
CREATE POLICY "Allow authenticated users read access on 
characteristic_tags_master" ON public.characteristic_tags_master FOR SELECT TO 
authenticated USING (is_active = true); [cite: 540] CREATE POLICY "Allow 
anonymous users read access on characteristic_tags_master" ON 
public.characteristic_tags_master FOR SELECT TO anon USING (is_active = true); 
[cite: 541] ``` 4\. JSON Schema Mirror JSON ``` { "title": 
"characteristic_tag_master", "description": "Master lookup for region 
characteristic tags. Names/descriptions are in 'translations' table. Version: 
2.0", "type": "object", "properties": { "code": { "type": "string", 
"description": "Primary Key. Unique, stable code for the tag (e.g., 
'mountainous'). Used as 'row_foreign_key' in 'translations'.", "pattern": 
"^[a-z0-9_]+$" }, "icon_identifier": { "type": ["string", "null"], 
"description": "Optional identifier for a UI icon.", "maxLength": 50 [cite: 
543] }, "display_order": { "type": "integer", "default": 0, "description": 
"Order for displaying tags in UI. Must be unique." [cite: 544] }, "is_active": 
{ "type": "boolean", "default": true, "description": "Indicates if the 
characteristic tag is active and available for use." }, "created_at": { "type": 
"string", "format": "date-time", "readOnly": true }, "updated_at": { "type": 
"string", "format": "date-time", "readOnly": true }, "created_by_profile_id": { 
"type": ["string", "null"], "format": "uuid", "description": "Profile ID of the 
user who created the record." }, "updated_by_profile_id": { "type": ["string", 
"null"], "format": "uuid", "description": "Profile ID of the user who last 
updated the record." } }, "required": [ "code", "display_order", "is_active" ] 
} ``` 5\. Relationships & Integrity - Primary Key: `code` (TEXT). - Referenced 
By: - `public.regions.characteristics_tags` (this column in regions will need 
to be changed from `region_characteristic_tag_enum[]` to `TEXT[]`, and its 
values will be codes from this table). - `public.translations.row_foreign_key` 
(conceptually, when `table_identifier = 'characteristic_tags_master'`). This is 
managed by the `cleanup_related_translations` trigger on delete and application 
logic for inserts/updates. - Unique Constraints: `code` (PK), `display_order`. 
6\. Impact on regions Table The regions table schema needs the 
characteristics_tags column definition to be changed from 
region_characteristic_tag_enum[] to TEXT[]. Data in 
regions.characteristics_tags will need migration from old ENUM values to the 
new TEXT codes. The region_characteristic_tag_enum type should be dropped after 
migration. 7\. Multilingual Strategy All display names and descriptions are 
stored in public.translations. The characteristic_tags_master table itself 
contains no translatable text. To fetch a translated name for a tag code: SQL 
``` SELECT translated_text FROM public.translations WHERE table_identifier = 
'characteristic_tags_master' AND column_identifier = 'name' -- Or 'description' 
AND row_foreign_key = 'tag_code_value' -- e.g., 'mountainous' AND language_code 
= 'user_language_code' AND translation_status = 'published_live'; -- Or 
relevant status ``` 8\. Role-Based Workflow & RLS Notes - Content Management: 
Core records (`code`, `icon_identifier`, `display_order`, `is_active`) are 
managed by Administrators. Textual names/descriptions are managed via 
`public.translations` workflow. - RLS Policies: - Admins: Full access via 
`public.is_platform_admin()`. - Authenticated/Anonymous Users: Read access to 
`is_active = true` tags. Access to translated text is governed by RLS on 
`public.translations`. 9\. ENUM vs Lookup Discussion This table correctly 
implements the lookup table pattern, replacing the previous 
region_characteristic_tag_enum. This allows richer attributes (icons, order) 
and proper i18n of names/descriptions via public.translations. 10\. UI/UX 
Enablement - UI uses `code` for internal logic and fetching translations. - 
`icon_identifier` and `display_order` drive visual presentation. - Translated 
`name` (and `description`) from `public.translations` are displayed to users. - 
Enables filtering regions by characteristics. 11\. Scalability & 
Future-Proofing The structure is scalable for languages and flexible for adding 
future non-translatable attributes. The table size is expected to remain small. 
12\. Next-Action Checklist - ðŸ”´ Define Helper Function: Ensure 
`public.is_platform_admin()` is defined and securely implemented. - ðŸ”´ Define 
`updated_at` Trigger Function: Ensure a standard `public.handle_updated_at()` 
(or chosen equivalent like `extensions.moddatetime`) is defined and used 
consistently. - ðŸ”´ Verify/Adapt `cleanup_related_translations`: Confirm the 
generic `public.cleanup_related_translations()` function correctly handles 
`TEXT` primary keys (`OLD.code`) for the `row_foreign_key` when `TG_TABLE_NAME` 
is `characteristic_tags_master`. Document its exact parameters. - ðŸŸ  Deploy 
DDL: Apply the `CREATE TABLE` and `COMMENT` DDL for 
`public.characteristic_tags_master`. - ðŸŸ  Populate Initial Data: Insert seed 
data for `code`, `icon_identifier`, `display_order`, `is_active` (e.g., 
{'mountainous', 'icon-peaks', 10, true}). - ðŸŸ  Populate Translations: For each 
seed `code`, create corresponding `name` (and `description`, if used) entries 
in `public.translations` for primary and supported languages. - ðŸŸ  Implement 
Triggers: Create `trigger_characteristic_tags_master_set_updated_at` and 
`trigger_delete_characteristic_tag_translations`. - ðŸŸ  Implement RLS Policies: 
Apply the RLS policies as defined. - ðŸŸ¢ Update `regions` Table: Plan 
modification of `regions.characteristics_tags` to `TEXT[]` and data migration. 
- ðŸŸ¢ Drop Old ENUM: Plan `DROP TYPE IF EXISTS 
public.region_characteristic_tag_enum` after `regions` table migration. 
