# 3.0.2 View v_towns_list_localized

  https://gemini.google.com/u/1/app/a3fdff8118a11194 Okay, let's define the 
specification for the view v_towns_list_localized . Specification: 
public.v_towns_list_localized (View) 1. Purpose & Primary Use-Cases Purpose : 
To provide a simplified and denormalized representation of essential town 
information required for list displays, with textual fields already translated 
into available languages. Each row in the view represents a town in a specific 
language. Primary Use-Cases : Populating lists of towns in a user's selected 
language on websites and mobile applications (e.g., search results, regional 
town lists). Simplifying queries for the GET /towns API endpoint by pre-joining 
towns with translations and key related entities. Providing a basis for 
filtering towns by various criteria while displaying localized names. 2. View 
Definition (SQL DDL) SQL CREATE OR REPLACE VIEW public.v_towns_list_localized 
AS SELECT t.id AS town_id, t.slug AS town_slug, -- Core town attributes for 
list display & filtering t.latitude_centroid, t.longitude_centroid, 
t.is_major_stage_town, t.content_visibility_status AS 
town_content_visibility_status, -- For admin filtering or specific UI 
t.deleted_at AS town_deleted_at, -- For RLS and potential admin UI -- Language 
of this localized record town_name_trans.language_code, -- Translated Town 
Fields town_name_trans.translated_text AS town_name, 
town_short_desc_trans.translated_text AS town_short_description, -- Linked 
Region Info (Translated Name & Key Fields) r.id AS region_id, r.slug AS 
region_slug, region_name_trans.translated_text AS region_name, -- r.is_active 
AS region_is_active, -- regions use deleted_at & status, not is_active 
(r.deleted_at IS NULL AND r.content_visibility_status = 'published' ) AS 
region_is_visible, -- Linked Province Info (Translated Name & Key Fields) p.id 
AS province_id, p.code AS province_code, province_name_trans.translated_text AS 
province_name, p.is_active AS province_is_active, -- Linked Town Type Info 
(Translated Name & Icon) ttm.code AS town_type_code, 
town_type_name_trans.translated_text AS town_type_name, ttm.icon_identifier AS 
town_type_icon_identifier, ttm.is_active AS town_type_is_active, -- Primary 
Image Thumbnail Info m.id AS primary_media_id, -- Assuming 'thumbnail_S' is a 
defined key in image_variants_json m.image_variants_json ->> 'thumbnail_S' AS 
primary_image_thumbnail_url, media_alt_text_trans.translated_text AS 
primary_image_alt_text, (m.media_status = 'approved' ) AS media_is_approved -- 
Assuming media has a status like 'approved' FROM public.towns t -- Join for 
Town Name (drives the language for each view row) INNER JOIN 
public.translations town_name_trans ON town_name_trans.table_identifier = 
'towns' AND town_name_trans.row_foreign_key = t.id::TEXT AND 
town_name_trans.column_identifier = 'name' AND 
town_name_trans.translation_status = 'published_live' -- Assuming this status 
indicates ready-to-use -- Join for Town Short Description LEFT JOIN 
public.translations town_short_desc_trans ON 
town_short_desc_trans.table_identifier = 'towns' AND 
town_short_desc_trans.row_foreign_key = t.id::TEXT AND 
town_short_desc_trans.column_identifier = 'short_description' AND 
town_short_desc_trans.language_code = town_name_trans.language_code AND 
town_short_desc_trans.translation_status = 'published_live' -- Join for Region 
(and its translated name) LEFT JOIN public.regions r ON t.region_id = r.id LEFT 
JOIN public.translations region_name_trans ON 
region_name_trans.table_identifier = 'regions' AND 
region_name_trans.row_foreign_key = r.id::TEXT AND 
region_name_trans.column_identifier = 'name' AND 
region_name_trans.language_code = town_name_trans.language_code AND 
region_name_trans.translation_status = 'published_live' -- Join for Province 
(and its translated name) LEFT JOIN public.provinces p ON t.province_id = p.id 
LEFT JOIN public.translations province_name_trans ON 
province_name_trans.table_identifier = 'provinces' AND 
province_name_trans.row_foreign_key = p.id::TEXT AND 
province_name_trans.column_identifier = 'name' AND 
province_name_trans.language_code = town_name_trans.language_code AND 
province_name_trans.translation_status = 'published_live' -- Join for Town Type 
(and its translated name) LEFT JOIN public.town_types_master ttm ON 
t.town_type_code = ttm.code LEFT JOIN public.translations town_type_name_trans 
ON town_type_name_trans.table_identifier = 'town_types_master' AND 
town_type_name_trans.row_foreign_key = ttm.code -- PK is TEXT 'code' AND 
town_type_name_trans.column_identifier = 'name' AND 
town_type_name_trans.language_code = town_name_trans.language_code AND 
town_type_name_trans.translation_status = 'published_live' -- Join for Primary 
Media (and its translated alt text) LEFT JOIN public.media m ON 
t.primary_media_id = m.id LEFT JOIN public.translations media_alt_text_trans ON 
media_alt_text_trans.table_identifier = 'media' -- Assuming 'media' as 
table_identifier for media text AND media_alt_text_trans.row_foreign_key = 
m.id::TEXT -- Assuming media.id is the FK AND 
media_alt_text_trans.column_identifier = 'alt_text' AND 
media_alt_text_trans.language_code = town_name_trans.language_code AND 
media_alt_text_trans.translation_status = 'published_live' WHERE -- Ensure only 
active/published towns are initially considered by the view's base query 
t.deleted_at IS NULL AND t.content_visibility_status = 'published' ; -- Further 
filtering for linked entities' visibility (is_active, deleted_at, status) -- 
should ideally be handled in the WHERE clause of queries *against* the view, -- 
or embedded here if the business rule is strict that a town list item shouldn't 
appear -- if its region is (e.g.) not active. -- Example: AND (r.id IS NULL OR 
(r.deleted_at IS NULL AND r.content_visibility_status = 'published')) -- AND 
(p.id IS NULL OR p.is_active = true) -- AND (ttm.code IS NULL OR ttm.is_active 
= true) -- AND (m.id IS NULL OR m.media_status = 'approved') -- For simplicity 
in the base view, these are exposed as boolean flags (e.g., region_is_visible). 
-- The API can then decide to filter based on these flags. COMMENT ON VIEW 
public.v_towns_list_localized IS 'Provides a denormalized and localized list of 
towns for display purposes, joining towns with their translations and key 
related entity names in various languages. Each row represents a town in one 
specific language. Version 1.0' ; 3. Output Columns Column Name Data Type 
Description town_id INTEGER The unique ID of the town (from public.towns.id ). 
town_slug TEXT The URL-friendly slug of the town (from public.towns.slug ). 
latitude_centroid DOUBLE PRECISION Latitude of the town's centroid. 
longitude_centroid DOUBLE PRECISION Longitude of the town's centroid. 
is_major_stage_town BOOLEAN Flag indicating if the town is a major stage town. 
town_content_visibility_status content_visibility_status_enum Visibility status 
of the base town record. town_deleted_at TIMESTAMPTZ Soft deletion timestamp 
for the base town record. language_code TEXT The language code (e.g., 'en', 
'it') for the translated textual fields in this row. town_name TEXT The 
translated name of the town in the specified language_code . 
town_short_description TEXT The translated short description of the town in the 
specified language_code . region_id INTEGER The ID of the town's primary 
region. region_slug TEXT The slug of the town's primary region. region_name 
TEXT The translated name of the town's primary region in the specified 
language_code . region_is_visible BOOLEAN Indicates if the linked region is 
currently visible (published and not deleted). province_id INTEGER The ID of 
the town's province. province_code TEXT The official code of the town's 
province. province_name TEXT The translated name of the town's province in the 
specified language_code . province_is_active BOOLEAN Indicates if the linked 
province is active. town_type_code TEXT The code of the town's type. 
town_type_name TEXT The translated name of the town's type in the specified 
language_code . town_type_icon_identifier TEXT The icon identifier for the 
town's type. town_type_is_active BOOLEAN Indicates if the linked town type is 
active. primary_media_id INTEGER The ID of the town's primary media image. 
primary_image_thumbnail_url TEXT URL for a small thumbnail of the town's 
primary image (e.g., from image_variants_json ->> 'thumbnail_S' ). 
primary_image_alt_text TEXT The translated alt text for the town's primary 
image in the specified language_code . media_is_approved BOOLEAN Indicates if 
the linked media item is approved. 4. Example Usage To get a list of towns in 
Italian, ordered by name: SQL SELECT town_id, town_slug, town_name, 
town_short_description, region_name, primary_image_thumbnail_url FROM 
public.v_towns_list_localized WHERE language_code = 'it' -- AND 
region_is_visible = TRUE -- Example additional filter -- AND province_is_active 
= TRUE -- AND town_type_is_active = TRUE -- AND (media_is_approved = TRUE OR 
primary_media_id IS NULL) ORDER BY town_name ASC LIMIT 20 OFFSET 0 ; Filtering 
by other attributes like region_id or is_major_stage_town can also be done in 
the WHERE clause. 5. Underlying Tables & Key Joins Primary Table : public.towns 
(aliased as t ) Key Joins : public.translations (multiple times for town_name , 
town_short_description , region_name , province_name , town_type_name , 
media_alt_text ). Joins are based on table_identifier , row_foreign_key , 
column_identifier , and language_code . Crucially, translation_status = 
'published_live' should be part of these join conditions. public.regions (as r 
): For region details. public.provinces (as p ): For province details. 
public.town_types_master (as ttm ): For town type details. public.media (as m 
): For primary image details. 6. RLS (Row-Level Security) Considerations The 
view will be defined with SECURITY INVOKER by default. This means that RLS 
policies defined on the underlying tables ( towns , regions , provinces , 
town_types_master , media , and translations ) will be applied based on the 
querying user's permissions. The WHERE clause in the view definition ( 
t.deleted_at IS NULL AND t.content_visibility_status = 'published' ) provides a 
baseline filtering for publicly visible towns. Querying users will only see 
rows they have access to in all joined tables. The exposed region_is_visible , 
province_is_active , town_type_is_active , media_is_approved flags allow API 
consumers to further filter if the view's base WHERE clause is made less 
restrictive on linked entities for flexibility. 7. Performance & Optimization 
Notes Indexing : Crucial indexes on public.translations : A composite index on 
(table_identifier, column_identifier, language_code, row_foreign_key, 
translation_status) or similar, tailored to these joins, is vital. Also, an 
index on (row_foreign_key, language_code, translation_status) can be beneficial 
if table_identifier and column_identifier are usually fixed in queries. Ensure 
all foreign key columns used in joins ( t.region_id , t.province_id , 
t.town_type_code , t.primary_media_id ) are indexed in their respective tables. 
Indexes on code for town_types_master (PK) are already in place. Join Strategy 
: The INNER JOIN on town_name_trans ensures that only towns with at least a 
translated name (in any language with 'published_live' status) will appear in 
the view. Subsequent LEFT JOIN s for other translations ensure the town row is 
not dropped if a secondary translation (like short description) is missing for 
that language. Materialized View : If read performance for very common language 
queries becomes a bottleneck, this view could be a candidate for conversion to 
a MATERIALIZED VIEW , refreshed periodically. Filtering : Queries against the 
view should always include WHERE language_code = 'desired_lang' . Additional 
filters should leverage indexed columns from the base tables where possible. 
Column Selection : Select only necessary columns when querying the view to 
reduce data transfer. 8. Assumptions & Dependencies Assumes 
public.translations.translation_status column exists and 'published_live' is 
the correct value for visible translations. Assumes public.media.media_status 
column exists and 'approved' is the correct value for visible media. Assumes 
specific keys like 'thumbnail_S' exist in public.media.image_variants_json . 
Assumes table_identifier for media translations is 'media' and 
column_identifier is 'alt_text' . The base tables ( regions , provinces , 
town_types_master ) have is_active or equivalent visibility logic ( deleted_at 
, content_visibility_status ) which is reflected in the view's boolean 
visibility flags for these linked entities. 9. Next-Action Checklist 🟠 
Finalize translation_status and media_status values : Confirm the exact values 
to use for 'published' or 'approved' statuses in translations and media tables. 
🟠 Confirm image_variants_json keys : Verify the specific keys (e.g., 
thumbnail_S ) that will be reliably present in media.image_variants_json . 🟠 
Refine Join Conditions for Linked Entity Visibility : Decide whether to 
strictly filter out list items in the view's main WHERE clause if linked 
entities (like region or province) are not active/visible, or to rely on the 
exposed boolean flags for API-level filtering (current approach leans towards 
flags for flexibility). 🟠 Test View Definition : Create and thoroughly test 
the view with sample data, covering various languages and missing 
translations/media. 🟢 Create Indexes : Ensure optimal indexes exist on 
public.translations and other base tables supporting the view's joins. 🟢 
Integrate into API : Update the GET /towns API endpoint logic to query this 
view. 🟢 Monitor Performance : After deployment, monitor the performance of 
queries using this view and consider materialization if necessary. 🟢 Document 
for API Consumers : Clearly document the view's output columns and how to use 
it effectively (especially language_code filtering). 
