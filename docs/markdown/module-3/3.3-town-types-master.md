# 3.3 town_types_master

  
https://gemini.google.com/u/1/app/cc0bffb89378d0df?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/a3fdff8118a11194 ### 3\. Updated 
Production-Ready Specification: `public.town_types_master` 1\. Purpose & 
Primary Use-Cases This table serves as a master lookup for categorizing towns 
and settlements. It provides unique codes (e.g., 'city_large', 'village_paese') 
and associated non-translatable metadata like icons or display order. All 
display names and descriptions for these town types are managed in the 
`public.translations` table, ensuring consistent and translatable 
classification. It is referenced by `public.towns.town_type_code`. Key 
User-Story Touchpoints: - Pilgrim: Sees the translated town type on a town's 
page. - Admin/Manager: Uses codes to classify towns; manages primary language 
names/descriptions in `translations`. - Platform: Uses codes for consistent 
categorization. 2\. Schema | Column Name | Data Type | Constraints | 
Description | | `code` | `TEXT` | `PRIMARY KEY` | Unique, stable code for the 
town type (e.g., 'city_large'). Used as `row_foreign_key` in `translations`. | 
| `icon_identifier` | `TEXT` | | Optional identifier for a UI icon (e.g., 
'icon-city'). | | `display_order` | `INTEGER` | `NOT NULL DEFAULT 0`, `UNIQUE` 
| For ordering types in UI. Ensures deterministic sorting. | | `is_active` | 
`BOOLEAN` | `NOT NULL DEFAULT true` | Whether the town type is active and 
usable. | | `created_at` | `TIMESTAMPTZ` | `NOT NULL DEFAULT now()` | Timestamp 
of creation. | | `updated_at` | `TIMESTAMPTZ` | `NOT NULL DEFAULT now()` | 
Timestamp of last update. Auto-updated by trigger. | | `created_by_profile_id` 
| `UUID` | `REFERENCES public.profiles(id) ON DELETE SET NULL` | Profile ID of 
the user who created the record. | | `updated_by_profile_id` | `UUID` | 
`REFERENCES public.profiles(id) ON DELETE SET NULL` | Profile ID of the user 
who last updated the record. | Translatable Fields (Managed in 
public.translations table): The following conceptual fields for a town type 
will have their content stored in public.translations with table_identifier = 
'town_types_master' and row_foreign_key = town_types_master.code: - `name` 
(e.g., `column_identifier = 'name'`) - `description` (e.g., `column_identifier 
= 'description'`) 3\. PostgreSQL DDL SQL ``` CREATE TABLE IF NOT EXISTS 
public.town_types_master ( code TEXT PRIMARY KEY, icon_identifier TEXT, 
display_order INTEGER NOT NULL DEFAULT 0 UNIQUE, is_active BOOLEAN NOT NULL 
DEFAULT true, created_at TIMESTAMPTZ NOT NULL DEFAULT now(), updated_at 
TIMESTAMPTZ NOT NULL DEFAULT now(), created_by_profile_id UUID REFERENCES 
public.profiles(id) ON DELETE SET NULL, updated_by_profile_id UUID REFERENCES 
public.profiles(id) ON DELETE SET NULL ); COMMENT ON TABLE 
public.town_types_master IS 'Master lookup for categorizing towns and 
settlements. Names/descriptions are in public.translations. Referenced by 
towns.town_type_code. Version: 2.0'; COMMENT ON COLUMN 
public.town_types_master.code IS 'Primary Key. Unique code for the town type 
(e.g., ''city_large'', ''village_paese''). Short, stable, non-changing. Used as 
row_foreign_key in translations.'; COMMENT ON COLUMN 
public.town_types_master.icon_identifier IS 'Optional identifier for a UI icon 
associated with this town type (e.g., ''icon-city'', ''icon-village'').'; 
COMMENT ON COLUMN public.town_types_master.display_order IS 'Optional: for 
ordering types in dropdowns or lists. Unique if used for deterministic 
sorting.'; COMMENT ON COLUMN public.town_types_master.is_active IS 'Indicates 
if the town type is active and available for use.'; COMMENT ON COLUMN 
public.town_types_master.created_at IS 'Timestamp of when the town type record 
was created.'; COMMENT ON COLUMN public.town_types_master.updated_at IS 
'Timestamp of when the town type record was last updated. Auto-updated by a 
trigger.'; COMMENT ON COLUMN public.town_types_master.created_by_profile_id IS 
'Profile ID of the user who created the town type record.'; COMMENT ON COLUMN 
public.town_types_master.updated_by_profile_id IS 'Profile ID of the user who 
last updated the town type record.'; -- Indexing: -- PRIMARY KEY on 'code' 
already creates an index. [cite: 429] -- UNIQUE constraint on 'display_order' 
already creates an index. [cite: 429] -- Trigger for updated_at (ensure 
public.handle_updated_at() or equivalent function exists) CREATE TRIGGER 
trigger_town_types_master_set_updated_at BEFORE UPDATE ON 
public.town_types_master FOR EACH ROW EXECUTE FUNCTION 
public.handle_updated_at(); -- Or extensions.moddatetime, or 
public.set_current_timestamp_updated_at [cite: 430] -- Trigger for deleting 
related translations -- (ensure public.cleanup_related_translations() function 
is adaptable for TEXT PKs -- or a specific version is made that correctly uses 
OLD.code as the row_foreign_key -- for table_identifier = 'town_types_master') 
CREATE TRIGGER trigger_delete_town_type_translations AFTER DELETE ON 
public.town_types_master FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_related_translations(); -- [cite: 431] Function needs to handle 
OLD.code -- RLS Policies ALTER TABLE public.town_types_master ENABLE ROW LEVEL 
SECURITY; CREATE POLICY "Allow admin full access on town_types_master" ON 
public.town_types_master FOR ALL USING (public.is_platform_admin()) -- Assumes 
helper function WITH CHECK (public.is_platform_admin()); CREATE POLICY "Allow 
authenticated users read access on town_types_master" ON 
public.town_types_master FOR SELECT TO authenticated USING (is_active = true); 
CREATE POLICY "Allow anonymous users read access on town_types_master" ON 
public.town_types_master FOR SELECT TO anon USING (is_active = true); ``` 4\. 
JSON Schema Mirror JSON ``` { "title": "town_type_master", "description": 
"Master lookup for categorizing towns and settlements. Names/descriptions are 
in 'translations' table. Version: 2.0", "type": "object", "properties": { 
"code": { "type": "string", "description": "Primary Key. Unique code for the 
town type (e.g., 'city_large'). Used as 'row_foreign_key' in 'translations'.", 
"pattern": "^[a-z0-9_]+$" }, "icon_identifier": { "type": ["string", "null"], 
"description": "Optional identifier for a UI icon associated with this town 
type.", "maxLength": 50 }, "display_order": { "type": "integer", "default": 0, 
"description": "Order for displaying types in UI. Must be unique." }, 
"is_active": { "type": "boolean", "default": true, "description": "Indicates if 
the town type is active and available for use." }, "created_at": { "type": 
"string", "format": "date-time", "readOnly": true }, "updated_at": { "type": 
"string", "format": "date-time", "readOnly": true }, "created_by_profile_id": { 
"type": ["string", "null"], "format": "uuid", "description": "Profile ID of the 
user who created the record." }, "updated_by_profile_id": { "type": ["string", 
"null"], "format": "uuid", "description": "Profile ID of the user who last 
updated the record." } }, "required": [ "code", "display_order", "is_active" ] 
} ``` 5\. Relationships & Integrity - Primary Key: `code` (TEXT). - Referenced 
By: - `public.towns.town_type_code` REFERENCES `public.town_types_master(code)` 
ON DELETE SET NULL (or RESTRICT). - `public.translations.row_foreign_key` 
(conceptually, when `table_identifier = 'town_types_master'`). Managed by 
trigger and application logic. - Unique Constraints: `code` (PK), 
`display_order`. 6\. Multilingual Strategy All display names and descriptions 
for town types are stored in the public.translations table. The 
town_types_master table itself holds no direct user-facing textual name or 
description. To get the name of a town type: SQL ``` SELECT translated_text 
FROM public.translations WHERE table_identifier = 'town_types_master' AND 
column_identifier = 'name' -- Or 'description' AND row_foreign_key = 
'type_code_value' -- e.g., 'village_paese' [cite: 441] AND language_code = 
'user_language_code' AND translation_status = 'published_live'; -- Or relevant 
status [cite: 441] ``` 7\. Role-Based Workflow & RLS Notes - Content 
Management: Core records (`code`, `icon_identifier`, `display_order`, 
`is_active`) managed by Administrators. Textual content via 
`public.translations` workflow. - RLS Policies: Admins full access (via 
`public.is_platform_admin()`). Authenticated/Anonymous read access to 
`is_active = true` types. `public.translations` RLS governs text access. 8\. 
ENUM vs Lookup Discussion This table is the lookup table, replacing an ENUM for 
richer functionality and i18n. 9\. UI/UX Enablement - UI uses `code` for 
logic/translation fetching. `icon_identifier` and `display_order` for 
presentation. - Translated `name`/`description` from `public.translations` are 
displayed. - Enables filtering towns by type, displaying categorized lists. 
10\. Key Considerations & Definitions - `code` Stability: `code` values must be 
stable as they are PKs and FKs. - Data Entry Workflow: Create record in 
`town_types_master`, then add corresponding `name`/`description` in 
`public.translations` for primary and other languages. 11\. Scalability & 
Future-Proofing Highly scalable for languages and flexible for adding 
non-translatable attributes. The number of town types is expected to be small. 
12\. Next-Action Checklist - ðŸ”´ Define Helper Function: Ensure 
`public.is_platform_admin()` is defined and secure. - ðŸ”´ Define `updated_at` 
Trigger Function: Ensure standard `public.handle_updated_at()` is defined. - ðŸ”´ 
Verify/Adapt `cleanup_related_translations`: Confirm function handles `TEXT` 
PKs (`OLD.code`) for `town_types_master`. - ðŸŸ  Deploy DDL: Apply `CREATE TABLE` 
and `COMMENT` DDL for `public.town_types_master`. - ðŸŸ  Populate Initial Data: 
Insert seed data (e.g., `{'city_large', 'landmark-city', 10, true}`). - ðŸŸ  
Populate Translations: For each seed `code`, create `name`/`description` 
entries in `public.translations`. - ðŸŸ  Implement Triggers: Create 
`trigger_town_types_master_set_updated_at` and 
`trigger_delete_town_type_translations`. - ðŸŸ  Implement RLS Policies: Apply 
defined RLS policies. - ðŸŸ¢ Update `towns` Table FK: Ensure 
`towns.town_type_code` correctly references this table. - ðŸŸ¢ Adapt Data Access 
Layer: Ensure application fetches names/descriptions from `public.translations` 
using `town_types_master.code`. ### 4\. Diff Summary - Added Columns: - 
`is_active BOOLEAN NOT NULL DEFAULT true` - `created_by_profile_id UUID 
REFERENCES public.profiles(id) ON DELETE SET NULL` - `updated_by_profile_id 
UUID REFERENCES public.profiles(id) ON DELETE SET NULL` - Modified Columns: - 
None. - Removed Columns: - None (original spec `3.3 town_types_master.docx` was 
already aligned with removing `name_en`, `description_en`). - Added DDL 
Elements: - `COMMENT ON TABLE` and `COMMENT ON COLUMN` statements. - Explicit 
RLS policies for admin, authenticated, and anonymous users, with admin using 
`public.is_platform_admin()` and `WITH CHECK`. - RLS policies for 
authenticated/anonymous now filter by `is_active = true`. - Modified DDL 
Elements: - `updated_at` trigger function reference standardized to 
`public.handle_updated_at()`. - Added Documentation/Sections: - Enhanced 
details in all 12 sections of the specification. - "Next-Action Checklist" now 
includes severity icons and specific references. - JSON Schema: - Added 
`is_active`, `created_by_profile_id`, `updated_by_profile_id`. - Updated main 
description to include version. - `is_active` added to `required` properties. 
