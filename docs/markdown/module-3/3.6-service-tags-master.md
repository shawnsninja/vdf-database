# 3.6 service_tags_master

  https://gemini.google.com/u/1/app/e2231210a6330ec4 
https://gemini.google.com/u/1/app/a3fdff8118a11194 ### 3\. Updated 
Production-Ready Specification: `public.service_tags_master` 1\. Purpose & 
Primary Use-Cases This table serves as a master lookup for key services or 
amenities available in towns (e.g., "pharmacy," "atm," "potable_water"). It 
provides unique, stable codes and allows association with non-translatable 
metadata like icons, categories, or display order. All display names and 
descriptions for these service tags are managed in `public.translations`. This 
table is referenced by `public.towns.key_services_summary_tags`. Key User-Story 
Touchpoints: - Pilgrim: Sees translated service tags with icons on a town's 
page or as filter options. - Admin/Manager: Uses service codes to tag towns and 
manages their primary language names/descriptions in `translations`. Manages 
codes, icons, categories, and display order in this master table. - Platform: 
Uses codes for filtering towns and displaying service information. 2\. Schema | 
Column Name | Data Type | Constraints | Description | | `code` | `TEXT` | 
`PRIMARY KEY` | Unique, stable code for the service (e.g., 'pharmacy'). 
Non-changing. Used as `row_foreign_key` in `translations`. | | 
`icon_identifier` | `TEXT` | | Optional identifier for a UI icon (e.g., 
'icon-pharmacy'). | | `category` | `TEXT` | | Optional: A category for the 
service tag (e.g., 'health', 'financial') for grouping. May become an FK if 
complexity increases. | | `display_order` | `INTEGER` | `NOT NULL DEFAULT 0`, 
`UNIQUE` | For ordering tags in UI. Ensures deterministic sorting. | | 
`is_active` | `BOOLEAN` | `NOT NULL DEFAULT true` | Whether the tag is active 
and usable. | | `created_at` | `TIMESTAMPTZ` | `NOT NULL DEFAULT now()` | 
Timestamp of creation. | | `updated_at` | `TIMESTAMPTZ` | `NOT NULL DEFAULT 
now()` | Timestamp of last update. Auto-updated by trigger. | | 
`created_by_profile_id` | `UUID` | `REFERENCES public.profiles(id) ON DELETE 
SET NULL` | Profile ID of the user who created the record. | | 
`updated_by_profile_id` | `UUID` | `REFERENCES public.profiles(id) ON DELETE 
SET NULL` | Profile ID of the user who last updated the record. | Translatable 
Fields (Managed in public.translations table): The following conceptual fields 
for a service tag will have their content stored in public.translations with 
table_identifier = 'service_tags_master' and row_foreign_key = 
service_tags_master.code: - `name` (e.g., `column_identifier = 'name'`) - 
`description` (e.g., `column_identifier = 'description'`, optional) 3\. 
PostgreSQL DDL SQL ``` CREATE TABLE IF NOT EXISTS public.service_tags_master ( 
code TEXT PRIMARY KEY, icon_identifier TEXT, category TEXT, -- Consider FK to a 
service_tag_categories_master if categories become complex or need their own 
attributes/translations. display_order INTEGER NOT NULL DEFAULT 0 UNIQUE, 
is_active BOOLEAN NOT NULL DEFAULT true, created_at TIMESTAMPTZ NOT NULL 
DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), 
created_by_profile_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL, 
updated_by_profile_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL ); 
COMMENT ON TABLE public.service_tags_master IS 'Master lookup for town service 
tags (amenities). Names/descriptions are in public.translations. Referenced by 
towns.key_services_summary_tags. Version: 2.0'; COMMENT ON COLUMN 
public.service_tags_master.code IS 'Primary Key. Unique, stable code for the 
service tag (e.g., ''pharmacy'', ''atm''). Non-changing. Used as 
row_foreign_key in translations.'; COMMENT ON COLUMN 
public.service_tags_master.icon_identifier IS 'Optional identifier for a UI 
icon associated with this service (e.g., ''icon-pharmacy'', ''icon-atm'').'; 
COMMENT ON COLUMN public.service_tags_master.category IS 'Optional: A category 
for the service tag (e.g., ''health'', ''financial'', ''food_drink'') for 
grouping in UI or filtering.'; COMMENT ON COLUMN 
public.service_tags_master.display_order IS 'For ordering tags in UI dropdowns, 
filter lists, or displays. Ensures deterministic sorting.'; COMMENT ON COLUMN 
public.service_tags_master.is_active IS 'Indicates if the service tag is active 
and available for use.'; COMMENT ON COLUMN 
public.service_tags_master.created_at IS 'Timestamp of when the service tag 
record was created.'; COMMENT ON COLUMN public.service_tags_master.updated_at 
IS 'Timestamp of when the service tag record was last updated. Auto-updated by 
a trigger.'; COMMENT ON COLUMN public.service_tags_master.created_by_profile_id 
IS 'Profile ID of the user who created the service tag record.'; COMMENT ON 
COLUMN public.service_tags_master.updated_by_profile_id IS 'Profile ID of the 
user who last updated the service tag record.'; -- Indexing: -- PRIMARY KEY on 
'code' already creates a unique index. [cite: 569] -- UNIQUE constraint on 
'display_order' already creates an index. [cite: 569] CREATE INDEX IF NOT 
EXISTS idx_service_tags_master_category ON public.service_tags_master(category) 
WHERE category IS NOT NULL; -- For filtering/grouping by category [cite: 570] 
-- Trigger for updated_at (ensure public.handle_updated_at() or equivalent 
function exists) CREATE TRIGGER trigger_service_tags_master_set_updated_at 
BEFORE UPDATE ON public.service_tags_master FOR EACH ROW EXECUTE FUNCTION 
public.handle_updated_at(); -- Or extensions.moddatetime, or 
public.set_current_timestamp_updated_at -- Trigger for deleting related 
translations -- (ensure public.cleanup_related_translations() function is 
adaptable for TEXT PKs -- or a specific version is made that correctly uses 
OLD.code as the row_foreign_key -- for table_identifier = 
'service_tags_master') CREATE TRIGGER trigger_delete_service_tag_translations 
AFTER DELETE ON public.service_tags_master FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_related_translations(); -- RLS Policies ALTER TABLE 
public.service_tags_master ENABLE ROW LEVEL SECURITY; CREATE POLICY "Allow 
admin full access on service_tags_master" ON public.service_tags_master FOR ALL 
USING (public.is_platform_admin()) -- Assumes helper function WITH CHECK 
(public.is_platform_admin()); CREATE POLICY "Allow authenticated users read 
access on service_tags_master" ON public.service_tags_master FOR SELECT TO 
authenticated USING (is_active = true); CREATE POLICY "Allow anonymous users 
read access on service_tags_master" ON public.service_tags_master FOR SELECT TO 
anon USING (is_active = true); ``` 4\. JSON Schema Mirror JSON ``` { "title": 
"service_tag_master", "description": "Master lookup for town service tags. 
Names/descriptions are in 'translations' table. Version: 2.0", "type": 
"object", "properties": { "code": { "type": "string", "description": "Primary 
Key. Unique, stable code for the service tag (e.g., 'pharmacy'). Used as 
'row_foreign_key' in 'translations'.", "pattern": "^[a-z0-9_]+$" }, 
"icon_identifier": { "type": ["string", "null"], "description": "Optional 
identifier for a UI icon.", "maxLength": 50 }, "category": { "type": ["string", 
"null"], "description": "Optional category for grouping service tags.", 
"maxLength": 50 }, "display_order": { "type": "integer", "default": 0, 
"description": "Order for displaying tags in UI. Must be unique." }, 
"is_active": { "type": "boolean", "default": true, "description": "Indicates if 
the service tag is active and available for use." }, "created_at": { "type": 
"string", "format": "date-time", "readOnly": true }, "updated_at": { "type": 
"string", "format": "date-time", "readOnly": true }, "created_by_profile_id": { 
"type": ["string", "null"], "format": "uuid", "description": "Profile ID of the 
user who created the record." }, "updated_by_profile_id": { "type": ["string", 
"null"], "format": "uuid", "description": "Profile ID of the user who last 
updated the record." } }, "required": [ "code", "display_order", "is_active" ] 
} ``` 5\. Relationships & Integrity - Primary Key: `code` (TEXT). - Referenced 
By: - `public.towns.key_services_summary_tags` (`TEXT[]` of codes from this 
table). - `public.translations.row_foreign_key` (conceptually, when 
`table_identifier = 'service_tags_master'`). Managed by trigger and application 
logic. - Unique Constraints: `code` (PK), `display_order`. - Index: 
`idx_service_tags_master_category` on `category` for efficient 
filtering/grouping. 6\. Impact on towns Table The towns table's 
key_services_summary_tags column must be TEXT[]. Data migration from 
town_service_tag_enum[] will be needed. The town_service_tag_enum type will be 
dropped post-migration. 7\. Multilingual Strategy Display names/descriptions 
are in public.translations. To fetch a translated name: SQL ``` SELECT 
translated_text FROM public.translations WHERE table_identifier = 
'service_tags_master' AND column_identifier = 'name' -- Or 'description' AND 
row_foreign_key = 'tag_code_value' -- e.g., 'pharmacy' AND language_code = 
'user_language_code' AND translation_status = 'published_live'; -- Or relevant 
status ``` 8\. Role-Based Workflow & RLS Notes - Content Management: Core 
records (`code`, `icon_identifier`, etc.) managed by Admins. Textual 
names/descriptions via `public.translations` workflow. - RLS Policies: Admins 
full access (via `public.is_platform_admin()`). Authenticated/Anonymous read 
access to `is_active = true` tags. `public.translations` RLS governs text 
access. 9\. ENUM vs Lookup Discussion This table correctly implements the 
lookup pattern, replacing town_service_tag_enum for richer attributes and i18n. 
10\. UI/UX Enablement - UI uses `code` for logic/translation fetching. 
`icon_identifier`, `category`, `display_order` for presentation. - Translated 
`name`/`description` from `public.translations` are displayed. - Enables 
filtering towns by services. 11\. Scalability & Future-Proofing Scalable for 
languages and flexible for future non-translatable attributes. Table size 
expected to be small. The category field provides simple grouping; if 
categories require their own metadata or translation, they could be promoted to 
a separate master table. 12\. Next-Action Checklist - 🔴 Define Helper 
Function: Ensure `public.is_platform_admin()` is defined and secure. - 🔴 
Define `updated_at` Trigger Function: Ensure standard 
`public.handle_updated_at()` is defined. - 🔴 Verify/Adapt 
`cleanup_related_translations`: Confirm function handles `TEXT` PKs 
(`OLD.code`) for `service_tags_master`. - 🟠 Deploy DDL: Apply `CREATE TABLE` 
and `COMMENT` DDL for `public.service_tags_master`. - 🟠 Populate Initial Data: 
Insert seed data (e.g., `{'pharmacy', 'icon-rx', 'health', 10, true}`). - 🟠 
Populate Translations: For each seed `code`, create `name`/`description` 
entries in `public.translations` for supported languages. - 🟠 Implement 
Triggers: Create `trigger_service_tags_master_set_updated_at` and 
`trigger_delete_service_tag_translations`. - 🟠 Implement RLS Policies: Apply 
defined RLS policies. - 🟢 Update `towns` Table: Plan 
`towns.key_services_summary_tags` modification to `TEXT[]` and data migration. 
- 🟢 Drop Old ENUM: Plan `DROP TYPE IF EXISTS public.town_service_tag_enum` 
after `towns` table migration. ### 4\. Diff Summary - Added Columns: - 
`is_active BOOLEAN NOT NULL DEFAULT true` - `created_by_profile_id UUID 
REFERENCES public.profiles(id) ON DELETE SET NULL` - `updated_by_profile_id 
UUID REFERENCES public.profiles(id) ON DELETE SET NULL` - Modified Columns: - 
`category TEXT` - Added comment regarding potential future FK. - Removed 
Columns: - None. - Added DDL Elements: - `COMMENT ON TABLE` and `COMMENT ON 
COLUMN` statements. - RLS `WITH CHECK` clause for admin write policy. - RLS 
policies for authenticated/anonymous now filter by `is_active = true`. - 
Modified DDL Elements: - Admin RLS policy uses `public.is_platform_admin()`. - 
`updated_at` trigger function reference standardized. - Added 
Documentation/Sections: - Enhanced details in all 12 sections of the 
specification. - "Next-Action Checklist" now includes severity icons. - JSON 
Schema: - Added `is_active`, `created_by_profile_id`, `updated_by_profile_id`. 
- Updated main description to include version. - `is_active` added to 
`required` properties. 
