# 7.0.2 - API Concept

  https://gemini.google.com/u/1/app/42a77d08d7a45bcb Key Conceptual API 
Endpoints Endpoint: List Curated Itineraries Purpose : Retrieve a list of 
curated itineraries, allowing for filtering and pagination, with key 
information presented in the requested language. Path Pattern : GET 
/itineraries Query Params / Filters / Options : lang (optional, string, e.g., 
it , en ): ISO language code for localized text fields. Defaults to primary 
platform language (e.g., 'en'). category_code (optional, string, 
comma-separated): Filter by one or more itinerary category codes (e.g., 
FRANCISCAN_SITES_FOCUS,SHORT_TRIP_UNDER_7_DAYS ). season_code (optional, 
string, comma-separated): Filter by one or more season codes (e.g., 
SPRING,AUTUMN ). difficulty_level_code (optional, string, comma-separated): 
Filter by one or more difficulty level codes. is_featured (optional, boolean): 
Filter for featured itineraries. page (optional, integer, default 1 ): For 
pagination. per_page (optional, integer, default 20 ): For pagination. sort_by 
(optional, string, e.g., name , total_distance_km_approx , updated_at ): Field 
to sort by. order (optional, string, default asc ): Sort order ( asc or desc ). 
Endpoint: Get Curated Itinerary Details Purpose : Retrieve comprehensive, 
localized details for a single curated itinerary, including its translatable 
text, linked master data (difficulty, status), media, and associated categories 
and seasons. Path Pattern : GET /itineraries/{itinerary_id_or_slug} Query 
Params / Filters / Options : lang (optional, string, e.g., it , en ): ISO 
language code for localized text fields. Defaults to primary platform language. 
include_segments (optional, boolean, default false ): If true, includes a 
summary list of segments for the itinerary. (Could also be a separate endpoint: 
GET /itineraries/{id}/segments ) Endpoint: List Itinerary Segments Purpose : 
Retrieve the ordered list of segments for a specific curated itinerary, with 
key segment information presented in the requested language. Path Pattern : GET 
/itineraries/{itinerary_id_or_slug}/segments Query Params / Filters / Options : 
lang (optional, string, e.g., it , en ): ISO language code for localized text 
fields in segments (e.g., notes). Defaults to primary platform language. 
day_number (optional, integer): Filter segments for a specific day number 
within the itinerary. Example JSON Responses GET 
/itineraries?lang=it&category_code=FRANCISCAN_SITES_FOCUS&sort_by=name&per_page=
1 (Leveraging public.v_curated_itineraries_list_localized) JSON { "data" : [ { 
"itinerary_id" : 123 , "language_code" : "it" , "name" : "Pellegrinaggio 
Francescano: Tappa Umbra (Italiano)" , "slug" : 
"pellegrinaggio-francescano-tappa-umbra" , "short_description" : "Un breve 
itinerario attraverso i luoghi chiave di San Francesco in Umbria, tradotto in 
italiano." , "banner_image_media_id" : "uuid-for-banner-image" , // Client 
fetches actual URL via /media endpoint or a pre-signed URL 
"total_distance_km_approx" : 150.5 , "total_walking_days_approx" : 7 , 
"difficulty_level_code" : "MODERATE" , "difficulty_level_name" : "Moderato 
(Italiano)" , "content_status_code" : "PUBLISHED" , "content_status_name" : 
"Pubblicato (Italiano)" , "category_codes" : [ "FRANCISCAN_SITES_FOCUS" , 
"HISTORICAL_CULTURAL_FOCUS" ], "season_codes" : [ "SPRING" , "AUTUMN" ], 
"is_featured_itinerary" : true , "itinerary_updated_at" : 
"2025-05-10T14:30:00Z" } ], "meta" : { "current_page" : 1 , "per_page" : 1 , 
"total_items" : 5 , // Example total matching criteria "total_pages" : 5 } } 
GET /itineraries/pellegrinaggio-francescano-tappa-umbra?lang=it (Leveraging 
public.v_curated_itinerary_detail_localized) JSON { "itinerary_id" : 123 , 
"language_code" : "it" , "name" : "Pellegrinaggio Francescano: Tappa Umbra 
(Italiano)" , "slug" : "pellegrinaggio-francescano-tappa-umbra" , 
"itinerary_code" : "VDF-UMB-01" , "long_description" : "Descrizione dettagliata 
dell'itinerario umbro sulle orme di San Francesco, in italiano..." , 
"theme_or_focus" : "Luoghi Francescani e spiritualitÃ  (Italiano)" , 
"suitability_notes" : "Adatto a pellegrini con preparazione moderata, 
interessati alla storia francescana (Italiano)." , 
"primary_start_location_text" : "La Verna (Italiano)" , 
"primary_end_location_text" : "Assisi (Italiano)" , "total_walking_days_approx" 
: 7 , "total_nights_approx" : 8 , "total_distance_km_approx" : 150.5 , 
"difficulty_details" : { "code" : "MODERATE" , "name" : "Moderato (Italiano)" , 
"description" : "Richiede una preparazione fisica discreta, alcuni tratti 
impegnativi (Italiano)." , "icon_identifier" : "difficulty_moderate_icon" }, 
"status_details" : { "code" : "PUBLISHED" , "name" : "Pubblicato (Italiano)" , 
"description" : "Contenuto verificato e disponibile al pubblico (Italiano)." }, 
"banner_image_details" : { "media_id" : "a1b2c3d4-e5f6-7890-1234-567890abcdef" 
, "original_url" : "path/to/originals/banner_umbra.jpg" , "variants" : { 
"thumb_s_webp" : "path/to/variants/banner_umbra_thumb_s.webp" , 
"display_l_jpeg" : "path/to/variants/banner_umbra_display_l.jpg" }, "alt_text" 
: "Banner dell'itinerario umbro (Italiano)" }, "map_overview_image_details" : { 
"media_id" : "b2c3d4e5-f6a7-8901-2345-67890abcdef0" , "original_url" : 
"path/to/originals/map_umbra.png" , "variants" : { "display_m_png" : 
"path/to/variants/map_umbra_display_m.png" }, "alt_text" : "Mappa generale del 
percorso umbro (Italiano)" }, "categories" : [ { "category_code" : 
"FRANCISCAN_SITES_FOCUS" , "name" : "Focus Siti Francescani (Italiano)" , 
"description" : "Itinerari con particolare enfasi sui luoghi legati a San 
Francesco (Italiano)." , "icon_identifier" : "franciscan_cross_icon" }, { 
"category_code" : "HISTORICAL_CULTURAL_FOCUS" , "name" : "Focus 
Storico-Culturale (Italiano)" , "description" : "Itinerari ricchi di storia e 
cultura locale (Italiano)." , "icon_identifier" : "history_icon" } ], "seasons" 
: [ { "season_code" : "SPRING" , "name" : "Primavera (Italiano)" , 
"description" : "Ideale per temperature miti e natura in fiore (Italiano)." , 
"icon_identifier" : "flower_icon" }, { "season_code" : "AUTUMN" , "name" : 
"Autunno (Italiano)" , "description" : "Colori magnifici e temperature 
piacevoli per camminare (Italiano)." , "icon_identifier" : "leaf_icon" } ], 
"created_by_display_name" : "Sofia Rossi" , "itinerary_updated_at" : 
"2025-05-10T14:30:00Z" } GET /itineraries/123/segments?lang=it (Leveraging 
public.curated_itinerary_segments joined with public.segments and their 
translations. A dedicated view like v_curated_itinerary_segments_localized 
would be ideal here.) JSON { "data" : [ { "itinerary_segment_id" : 1001 , // ID 
from curated_itinerary_segments "segment_id" : 201 , // ID from segments table 
"day_number_in_itinerary" : 1 , "order_of_segment_within_day" : 1 , 
"segment_name" : "Da La Verna a Pieve Santo Stefano (Italiano)" , 
"segment_slug" : "la-verna-pieve-santo-stefano" , "distance_km" : 15.2 , 
"estimated_walking_time_minutes" : 300 , "notes_for_segment_in_itinerary" : 
"Primo giorno facile, principalmente in discesa. Attenzione al bivio per 
Caprese Michelangelo (Italiano)." , "is_optional_segment_for_day" : false }, { 
"itinerary_segment_id" : 1002 , "segment_id" : 202 , "day_number_in_itinerary" 
: 2 , "order_of_segment_within_day" : 1 , "segment_name" : "Da Pieve Santo 
Stefano a Sansepolcro (Italiano)" , "segment_slug" : 
"pieve-santo-stefano-sansepolcro" , "distance_km" : 12.8 , 
"estimated_walking_time_minutes" : 240 , "notes_for_segment_in_itinerary" : 
"Tappa pianeggiante lungo il Tevere (Italiano)." , 
"is_optional_segment_for_day" : false } // ... other segments ], "meta" : { 
"total_segments_for_itinerary" : 15 // Example } } Database-Support Analysis 
Endpoint: GET /itineraries Indexes : Relies on 
public.v_curated_itineraries_list_localized . Underlying indexes on 
curated_itineraries (e.g., content_status_id , is_featured_itinerary , 
deleted_at ), translations (composite key), trail_difficulty_levels_master ( 
code ), content_statuses_master ( code ), itinerary_categories_master ( 
category_code ), seasons_master ( season_code ) are crucial. Indexes for 
sorting fields ( name , updated_at on curated_itineraries ) are also important. 
The view's array aggregation for codes is efficient. Join Complexity : The view 
public.v_curated_itineraries_list_localized handles the primary joins for 
localization and basic master data. Filtering by category_code or season_code 
array columns in the view might require specific indexing strategies on the 
view itself if performance is an issue (e.g., GIN index on array columns, 
though Supabase might not support this directly on views without 
materialization) or careful query construction. It's often better to filter on 
the base junction tables. Performance Gotchas : RLS on curated_itineraries and 
translations applies. Filtering by multiple category_code or season_code (e.g., 
category_codes @> ARRAY['CODE1', 'CODE2'] ) on the aggregated array in the view 
can be less performant than joining and filtering on the base junction tables. 
The query optimizer might handle this well if the view definition is simple 
enough, or the API could construct queries against base tables for complex 
filtering. Missing Data? : The list view is summary-oriented. No obvious 
missing data for this purpose. Endpoint: GET 
/itineraries/{itinerary_id_or_slug} Indexes : Relies on 
public.v_curated_itinerary_detail_localized . Critical indexes include PK/slug 
on curated_itineraries , the composite index on translations , PKs on all 
master tables, and FKs involved in joins. Join Complexity : Handled by 
public.v_curated_itinerary_detail_localized . This view is complex, involving 
multiple joins to translations and CTEs with JSONB aggregations for categories 
and seasons. Performance Gotchas : The primary gotcha is the complexity of 
v_curated_itinerary_detail_localized . Numerous LEFT JOIN s to translations can 
be costly if not all translations are present (though LEFT JOIN is correct 
here). JSONB aggregation can also be intensive. RLS applies to all underlying 
tables. Mitigation : Ensure the translations table is highly optimized. 
Consider if a materialized view for v_curated_itinerary_detail_localized 
(refreshed periodically) would be beneficial if this endpoint is very high 
traffic and underlying data doesn't change too frequently. Alternatively, a 
database function that takes itinerary_id and language_code and constructs the 
JSONB object might offer more control and performance tuning opportunities. 
Missing Data? : The view aims to be comprehensive. The structure for 
total_walking_days_approx and total_nights_approx being separate from 
total_distance_km_approx is fine; if these need to be presented as a range 
(e.g., "7-9 days"), that's application-layer formatting. Endpoint: GET 
/itineraries/{itinerary_id_or_slug}/segments Indexes : Requires efficient 
lookup on curated_itineraries (by id or slug ), then querying 
curated_itinerary_segments (indexed on itinerary_id , day_number_in_itinerary , 
order_of_segment_within_day ). Joins to segments (on id ) and translations (for 
segments.name , segments.short_description , 
curated_itinerary_segments.notes_for_segment_in_itinerary ). Join Complexity : 
Moderate. Joins curated_itinerary_segments with segments and potentially 
translations multiple times (for segment fields and itinerary-specific segment 
notes). A dedicated view, e.g., 
v_curated_itinerary_segments_localized(itinerary_id, language_code) , would be 
highly beneficial here. Performance Gotchas : RLS on all involved tables. If 
fetching segments for many itineraries frequently, ensure efficient pagination 
and filtering. Missing Data? : The example shows key fields. If more detailed 
segment geometry or attributes are needed, the query/view would expand. 
Immediate Schema Tweaks (if any) Based on this API conceptualization for Module 
7, and assuming the underlying table specifications and the proposed views ( 
v_curated_itineraries_list_localized , v_curated_itinerary_detail_localized ) 
are implemented as discussed: ðŸŸ¢ Optional future/Optimization - Dedicated View 
for Itinerary Segments : Tweak : Define a 
public.v_curated_itinerary_segments_localized view. Rationale : To simplify the 
GET /itineraries/{id}/segments endpoint. This view would join 
curated_itinerary_segments with segments and translations to provide localized 
segment names, notes, and key segment statistics (like distance, estimated 
time) directly. This follows the pattern of having detailed localized views for 
primary entities and their components. ðŸŸ  Review Performance of JSONB 
Aggregation in v_curated_itinerary_detail_localized : Tweak : No immediate 
schema change, but a strong recommendation to performance test the JSONB 
aggregation for categories and seasons within the 
v_curated_itinerary_detail_localized view. Rationale : If performance is an 
issue, alternatives include: API-level aggregation (fetching categories/seasons 
via separate calls). A PL/pgSQL database function to construct the final JSON, 
which can offer more procedural control over optimization. Materializing the 
view. ðŸŸ¢ Consider banner_image_thumbnail_url in 
v_curated_itineraries_list_localized : Tweak : The list view currently includes 
banner_image_media_id . For API convenience, it could directly join with 
public.media and extract a specific thumbnail URL from image_variants_json 
(e.g., media.image_variants_json->>'thumb_s_webp' AS banner_thumbnail_url ). 
Rationale : Reduces the need for the client to make a separate call to 
/media/{id} just for a thumbnail for each item in a list. This adds a join to 
the list view but might improve overall client-side experience. No ðŸ”´ critical 
(Must-fix) schema adjustments are identified solely from this API 
conceptualization exercise for Module 7 that were not already covered during 
the table spec reviews and initial view design. The main challenges will be in 
query/view optimization for the detailed endpoints. 
