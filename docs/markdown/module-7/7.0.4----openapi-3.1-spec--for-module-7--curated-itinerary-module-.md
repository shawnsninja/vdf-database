# 7.0.4 -  OpenAPI 3.1 Spec (for Module 7_ Curated Itinerary Module)

  https://gemini.google.com/u/1/app/42a77d08d7a45bcb ### OpenAPI 3.1 Spec (for 
Module 7: Curated Itinerary Module) YAML ``` openapi: 3.1.0 info: title: 
Curated Itinerary Module API version: v2.1 description: API for managing and 
accessing curated pilgrimage itineraries and related master data. servers: - 
url: https://<YOUR_SUPABASE_PROJECT_REF>.supabase.co/rest/v1 description: 
Supabase Edge (PostgREST) components: securitySchemes: bearerAuth: type: http 
scheme: bearer bearerFormat: JWT # Standard Supabase JWT schemas: Error: type: 
object properties: code: type: string description: Error code string. message: 
type: string description: Human-readable summary of the error. detail: type: 
string nullable: true description: More specific details or field errors. hint: 
type: string nullable: true description: Suggestion on how to resolve the 
error. required: - code - message Pagination: type: object properties: 
current_page: type: integer example: 1 per_page: type: integer example: 20 
total_items: type: integer example: 150 total_pages: type: integer example: 8 
CuratedItineraryBase: # Base fields for POST/PATCH, excluding read-only and 
linked objects type: object properties: name: # Stored as base language (e.g., 
English) type: string maxLength: 255 description: "The human-readable name of 
the itinerary (Base language). Translatable. Max 255 chars." slug: type: string 
maxLength: 255 pattern: '^[a-z0-9]+(?:-[a-z0-9]+)*$' description: "URL-friendly 
identifier. Auto-generated from name recommended. Max 255 chars." 
itinerary_code: type: string nullable: true maxLength: 50 pattern: 
'^[A-Z0-9_-]+$' description: "Optional short code for internal reference. Max 
50 chars. Unique when present." primary_trail_id: type: integer # Should be 
bigint if trails.id is bigint format: int64 nullable: true description: "The 
main trail this itinerary is primarily associated with (FK to 
public.trails.id)." based_on_primary_route_id: type: integer # Should be bigint 
if routes.id is bigint format: int64 nullable: true description: "Optional: If 
this itinerary largely follows an existing official route (FK to 
public.routes.id)." short_description: # Base language type: string nullable: 
true maxLength: 500 description: "A brief summary of the itinerary (Base 
language). Translatable. Max 500 chars." long_description: # Base language 
type: string nullable: true description: "Detailed description of the itinerary 
(Base language). Translatable." theme_or_focus: # Base language type: string 
nullable: true maxLength: 255 description: "Primary theme or focus (Base 
language). Translatable. Max 255 chars." suitability_notes: # Base language 
type: string nullable: true description: "Notes on who this itinerary is best 
suited for (Base language). Translatable." total_walking_days_approx: type: 
integer nullable: true minimum: 1 total_nights_approx: type: integer nullable: 
true minimum: 0 total_distance_km_approx: type: number format: float nullable: 
true exclusiveMinimum: 0 overall_difficulty_level_id: # FK to 
trail_difficulty_levels_master type: integer nullable: true 
primary_start_location_text: # Base language type: string nullable: true 
maxLength: 255 description: "Descriptive starting point (Base language). 
Translatable." primary_end_location_text: # Base language type: string 
nullable: true maxLength: 255 description: "Descriptive ending point (Base 
language). Translatable." start_waypoint_id_approx: type: integer # Should be 
bigint if waypoints.id is bigint format: int64 nullable: true 
end_waypoint_id_approx: type: integer # Should be bigint if waypoints.id is 
bigint format: int64 nullable: true banner_image_media_id: type: string format: 
uuid nullable: true map_overview_image_media_id: type: string format: uuid 
nullable: true content_status_id: # FK to content_statuses_master type: integer 
description: "Publication status. Default for 'draft' handled by backend/app." 
published_at: type: string format: date-time nullable: true 
is_featured_itinerary: type: boolean default: false version_notes: type: string 
nullable: true data_last_verified_at: type: string format: date-time nullable: 
true # For POST/PATCH, categories and seasons are typically managed via 
separate endpoints # e.g., POST /itineraries/{id}/categories with body { 
"category_id": 123 } CuratedItineraryResponseItem: # For list view allOf: - 
$ref: '#/components/schemas/CuratedItineraryBase' # Includes most fields type: 
object properties: itinerary_id: # Read-only in response type: integer format: 
int64 readOnly: true language_code: type: string example: "it" name: # 
Localized type: string short_description: # Localized type: string nullable: 
true difficulty_level_code: type: string nullable: true difficulty_level_name: 
# Localized type: string nullable: true content_status_code: type: string 
content_status_name: # Localized type: string category_codes: type: array 
items: type: string example: ["FRANCISCAN_SITES_FOCUS", 
"HISTORICAL_CULTURAL_FOCUS"] season_codes: type: array items: type: string 
example: ["SPRING", "AUTUMN"] itinerary_created_at: # Renamed to avoid conflict 
with base created_at type: string format: date-time readOnly: true 
itinerary_updated_at: # Renamed type: string format: date-time readOnly: true # 
Note: The prompt's 'name_en' + 'translations' object pattern is handled by # 
the 'lang' query param and the view providing the localized 'name'. # If 
explicit base + translations array needed, schema & view must change. 
CuratedItineraryDetail: allOf: - $ref: 
'#/components/schemas/CuratedItineraryBase' type: object properties: 
itinerary_id: type: integer format: int64 readOnly: true language_code: type: 
string name: # Localized type: string # All other translatable fields from 
CuratedItineraryBase would be localized here # e.g., long_description, 
theme_or_focus, etc. difficulty_details: type: object properties: code: type: 
string name: # Localized type: string description: # Localized type: string 
nullable: true icon_identifier: type: string nullable: true status_details: 
type: object properties: code: type: string name: # Localized type: string 
description: # Localized type: string nullable: true banner_image_details: 
type: object nullable: true properties: media_id: type: string format: uuid 
original_url: type: string format: uri variants: # Example, actual structure 
depends on media.image_variants_json type: object properties: thumb_s_webp: 
type: string format: uri display_l_jpeg: type: string format: uri alt_text: # 
Localized type: string nullable: true map_overview_image_details: # Similar to 
banner_image_details type: object nullable: true categories: type: array items: 
type: object properties: category_code: type: string name: # Localized type: 
string description: # Localized type: string nullable: true icon_identifier: 
type: string nullable: true seasons: # Similar to categories type: array items: 
type: object # Read-only audit fields from base table created_at: type: string 
format: date-time readOnly: true updated_at: type: string format: date-time 
readOnly: true created_by_display_name: # Example from view type: string 
nullable: true updated_by_display_name: # Example from view type: string 
nullable: true CuratedItinerarySegmentItem: # For listing segments of an 
itinerary type: object properties: itinerary_segment_id: # PK of the 
curated_itinerary_segments table type: integer format: int64 segment_id: # FK 
to segments table type: integer format: int64 day_number_in_itinerary: type: 
integer order_of_segment_within_day: type: integer segment_name: # Localized 
name of the segment type: string segment_slug: type: string distance_km: type: 
number format: float estimated_walking_time_minutes: type: integer nullable: 
true notes_for_segment_in_itinerary: # Localized type: string nullable: true 
is_optional_segment_for_day: type: boolean # Schemas for Master Data 
(abbreviated, assuming simple GET /<table> for them) ItineraryCategoryMaster: 
type: object properties: id: type: integer category_code: type: string name: # 
Localized type: string description: # Localized type: string nullable: true 
icon_identifier: type: string nullable: true sort_order: type: integer 
is_active: type: boolean # ... (Similar schemas for SeasonsMaster, 
TrailDifficultyLevelsMaster, ContentStatusesMaster) paths: /itineraries: get: 
summary: List Curated Itineraries tags: - Curated Itineraries parameters: - 
name: lang in: query required: false schema: type: string default: "en" # 
Default language description: Language code for localized content. - name: 
category_code in: query required: false schema: type: string description: 
Comma-separated itinerary category codes. - name: season_code in: query 
required: false schema: type: string description: Comma-separated season codes. 
- name: difficulty_level_code in: query required: false schema: type: string 
description: Comma-separated difficulty level codes. - name: is_featured in: 
query required: false schema: type: boolean - name: page in: query required: 
false schema: type: integer default: 1 - name: per_page # Note: Supabase uses 
'limit' and 'offset' in: query required: false schema: type: integer default: 
20 - name: sort_by in: query required: false schema: type: string - name: order 
in: query required: false schema: type: string enum: [asc, desc] default: asc 
responses: '200': description: A list of curated itineraries. # Relies on 
public.v_curated_itineraries_list_localized view content: application/json: 
schema: type: object properties: data: type: array items: $ref: 
'#/components/schemas/CuratedItineraryResponseItem' meta: $ref: 
'#/components/schemas/Pagination' default: description: Unexpected error 
content: application/json: schema: $ref: '#/components/schemas/Error' security: 
- bearerAuth: [] # Assumes authentication might be needed even for lists if 
non-public data is possible - apiKey: [] # Supabase requires anon key post: 
summary: Create a Curated Itinerary tags: - Curated Itineraries requestBody: 
required: true content: application/json: schema: $ref: 
'#/components/schemas/CuratedItineraryBase' responses: '201': description: 
Curated Itinerary created successfully. content: application/json: schema: 
$ref: '#/components/schemas/CuratedItineraryDetail' # Returns the full detail 
default: description: Error creating itinerary content: application/json: 
schema: $ref: '#/components/schemas/Error' security: - bearerAuth: [] # 
Requires authentication - apiKey: [] /itineraries/{itinerary_id_or_slug}: get: 
summary: Get Curated Itinerary Details tags: - Curated Itineraries parameters: 
- name: itinerary_id_or_slug in: path required: true schema: type: string # Can 
be integer ID or string slug description: The ID or slug of the curated 
itinerary. - name: lang in: query required: false schema: type: string default: 
"en" description: Language code for localized content. responses: '200': 
description: Detailed information about the curated itinerary. # Relies on 
public.v_curated_itinerary_detail_localized view content: application/json: 
schema: $ref: '#/components/schemas/CuratedItineraryDetail' '404': description: 
Itinerary not found. content: application/json: schema: $ref: 
'#/components/schemas/Error' default: description: Unexpected error content: 
application/json: schema: $ref: '#/components/schemas/Error' security: - 
bearerAuth: [] - apiKey: [] patch: summary: Update a Curated Itinerary tags: - 
Curated Itineraries parameters: - name: itinerary_id_or_slug # Usually ID for 
PATCH in: path required: true schema: type: integer # Assuming ID for updates 
format: int64 description: The ID of the curated itinerary to update. 
requestBody: required: true content: application/json: schema: $ref: 
'#/components/schemas/CuratedItineraryBase' # Partial updates allowed 
responses: '200': description: Curated Itinerary updated successfully. content: 
application/json: schema: $ref: '#/components/schemas/CuratedItineraryDetail' 
'404': description: Itinerary not found. default: description: Error updating 
itinerary security: - bearerAuth: [] # Requires authentication - apiKey: [] 
/itineraries/{itinerary_id_or_slug}/segments: get: summary: List Segments for a 
Curated Itinerary tags: - Curated Itineraries parameters: - name: 
itinerary_id_or_slug in: path required: true schema: type: string description: 
The ID or slug of the curated itinerary. - name: lang in: query required: false 
schema: type: string default: "en" - name: day_number in: query required: false 
schema: type: integer description: Filter segments for a specific day number. 
responses: '200': description: An ordered list of segments for the itinerary. # 
Would benefit from a public.v_curated_itinerary_segments_localized view 
content: application/json: schema: type: object properties: data: type: array 
items: $ref: '#/components/schemas/CuratedItinerarySegmentItem' meta: # e.g., 
total_segments_for_itinerary type: object '404': description: Itinerary not 
found. default: description: Unexpected error security: - bearerAuth: [] - 
apiKey: [] # Placeholder endpoints for master data (categories, seasons, 
difficulties, statuses) # Example: /itinerary_categories /itinerary_categories: 
get: summary: List Itinerary Categories tags: - Master Data parameters: - name: 
lang in: query required: false schema: type: string default: "en" - name: 
is_active in: query required: false schema: type: boolean default: true 
responses: '200': description: A list of itinerary categories. # Queries 
itinerary_categories_master and joins translations content: application/json: 
schema: type: array items: $ref: '#/components/schemas/ItineraryCategoryMaster' 
default: description: Unexpected error security: - bearerAuth: [] - apiKey: [] 
# ... (Similar GET endpoints for /seasons, /trail_difficulty_levels, 
/content_statuses) ``` * * * * * ### Quick-Start Examples 1. List Curated 
Itineraries (filtered, Italian): Bash ``` curl -X GET\ 
"https://<YOUR_SUPABASE_PROJECT_REF>.supabase.co/rest/v1/itineraries?lang=it&cat
egory_code=eq.FRANCISCAN_SITES_FOCUS&select=itinerary_id,name,slug,difficulty_le
vel_name,category_codes&limit=1"\ -H "apikey: <YOUR_SUPABASE_ANON_KEY>"\ -H 
"Authorization: Bearer <YOUR_USER_JWT>" ``` Sample Response (leveraging 
`v_curated_itineraries_list_localized` columns): JSON ``` [ { "itinerary_id": 
123, "name": "Pellegrinaggio Francescano: Tappa Umbra", "slug": 
"pellegrinaggio-francescano-tappa-umbra", "difficulty_level_name": "Moderato", 
"category_codes": ["FRANCISCAN_SITES_FOCUS", "HISTORICAL_CULTURAL_FOCUS"] } ] 
``` 2. Get Curated Itinerary Details (English): Bash ``` curl -X GET\ 
"https://<YOUR_SUPABASE_PROJECT_REF>.supabase.co/rest/v1/itineraries?itinerary_i
d_or_slug=eq.pellegrinaggio-francescano-tappa-umbra&lang=en&select=itinerary_id,
name,long_description,difficulty_details,categories,seasons,banner_image_details
"\ -H "apikey: <YOUR_SUPABASE_ANON_KEY>"\ -H "Authorization: Bearer 
<YOUR_USER_JWT>" ``` Sample Response (leveraging 
`v_curated_itinerary_detail_localized` columns): JSON ``` [ { "itinerary_id": 
123, "name": "Franciscan Pilgrimage: Umbrian Stage", "long_description": 
"Detailed description of the Umbrian itinerary in the footsteps of St. 
Francis...", "difficulty_details": { "code": "MODERATE", "name": "Moderate", 
"description": "Requires a fair level of fitness, some challenging sections.", 
"icon_identifier": "difficulty_moderate_icon" }, "categories": [ { 
"category_code": "FRANCISCAN_SITES_FOCUS", "name": "Franciscan Sites Focus", 
"icon_identifier": "franciscan_cross_icon" } ], "seasons": [ { "season_code": 
"SPRING", "name": "Spring", "icon_identifier": "flower_icon" } ], 
"banner_image_details": { "media_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef", 
"alt_text": "Banner of the Umbrian itinerary" } } ] ``` *(Note: Supabase 
PostgREST with `eq.` on a view might require careful view definition or RPC for 
slug/id resolution. For simplicity, assuming the view handles this or the 
client uses the ID directly if slug resolution is complex for PostgREST on 
views.)* 3. Create a Curated Itinerary: Bash ``` curl -X POST\ 
"https://<YOUR_SUPABASE_PROJECT_REF>.supabase.co/rest/v1/curated_itineraries"\ 
-H "apikey: <YOUR_SUPABASE_ANON_KEY>"\ -H "Authorization: Bearer 
<YOUR_ADMIN_JWT>"\ -H "Content-Type: application/json"\ -H "Prefer: 
return=representation"\ -d '{ "name": "New Test Itinerary (Base English)", 
"slug": "new-test-itinerary", "short_description": "A short test description 
(Base English).", "content_status_id": 1, # Assuming ID for DRAFT status 
"overall_difficulty_level_id": 2 # Assuming ID for MODERATE }' ``` Sample 
Response (actual itinerary created, then re-fetched for detail view): JSON ``` 
{ "itinerary_id": 126, "language_code": "en", # Default or based on system 
"name": "New Test Itinerary (Base English)", "slug": "new-test-itinerary", 
"short_description": "A short test description (Base English).", 
"content_status_id": 1, "overall_difficulty_level_id": 2, "created_at": 
"2025-05-18T21:15:00Z" // ... other fields from CuratedItineraryDetail schema } 
``` * * * * * ### Implementation Notes - 🟢 Schema OK. The existing database 
schema for Module 7, including the master tables 
(`trail_difficulty_levels_master`, `content_statuses_master`, 
`itinerary_categories_master`, `seasons_master`) and the core tables 
(`curated_itineraries`, `curated_itinerary_segments`, and junction tables), is 
generally well-suited to support these API endpoints. - 🟢 SQL Views are Key 
for READ Endpoints: - The `public.v_curated_itineraries_list_localized` view is 
essential for efficiently serving the `GET /itineraries` endpoint. - The 
`public.v_curated_itinerary_detail_localized` view is crucial for the `GET 
/itineraries/{id_or_slug}` endpoint. Its complexity means performance testing 
is vital. Consider if all JSONB aggregations are best here or if some (like 
categories/seasons) might be split to separate calls by the API gateway/BFF if 
the view becomes too slow. - A new view, e.g., 
`public.v_curated_itinerary_segments_localized`, would greatly benefit the `GET 
/itineraries/{id}/segments` endpoint by pre-joining 
`curated_itinerary_segments`, `segments`, and their translations. - 🟢 
Indexing: - Ensure comprehensive indexing on all foreign keys and commonly 
filtered/sorted columns in the base tables, as well as on the 
`public.translations` table (especially the composite index: 
`(table_identifier, column_identifier, row_foreign_key, language_code, 
translation_status)`). This is critical for the performance of the localized 
views. - 🟢 Language Fallback: The `COALESCE` pattern in the views provides a 
good fallback to base language content if a translation is missing. This should 
be clearly documented for API consumers. - 🟢 Write Operations (POST, PATCH, 
DELETE): - These will operate directly on the base tables 
(`public.curated_itineraries`, `public.curated_itinerary_to_category`, etc.). - 
RLS policies on these tables will enforce permissions. - Audit triggers will 
populate `created_by/updated_by` fields. - The application/API layer will need 
to handle creating/updating base language content in the main table columns and 
then managing corresponding entries in the `public.translations` table for 
various languages. - 🟠 Pagination for Supabase: Supabase PostgREST uses 
`limit` and `offset` for pagination rather than `page` and `per_page`. The API 
gateway or BFF would need to translate these if `page/per_page` is the desired 
external interface. The `Pagination` object in the OpenAPI spec reflects a 
common pattern; actual response headers from PostgREST might differ (e.g., 
`Content-Range`). - 🔴 No critical schema tweaks are required *solely* from 
this API conceptualization, assuming the views are implemented effectively and 
underlying table indexing is robust. The main focus should be on view 
performance and RLS policy correctness. 
