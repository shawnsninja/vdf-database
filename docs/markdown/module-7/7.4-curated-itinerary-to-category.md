# 7.4 curated_itinerary_to_category

  
https://gemini.google.com/u/1/app/b76d14705d5101f9?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/42a77d08d7a45bcb * * * * * Production-Ready 
Specification: public.curated_itinerary_to_category Table Version: 2.1 (V2.1 
Checklist REV 05-18-25-A Applied) Date: May 18, 2025 1\. Purpose & Primary 
Use-Cases Establishes a many-to-many relationship between curated itineraries 
(`curated_itineraries`) and itinerary categories 
(`itinerary_categories_master`). Each row signifies that a specific itinerary 
is associated with a particular category. This table enables filtering and 
classification of itineraries. *Key User-Story Touchpoints:* - Pilgrim (Anna): 
Enables filtering itineraries by category (A7). - Platform Administrator (Admin 
Team) / Regional Content Manager (Sofia): Allows assignment of multiple 
categories to itineraries (D2). 2\. Schema | Column | Data Type | Constraints | 
Description | | `itinerary_id` | `bigint` | Primary Key (Composite), Foreign 
Key to `curated_itineraries(id)` ON DELETE CASCADE, Not Null | Identifier of 
the curated itinerary. | | `category_id` | `integer` | Primary Key (Composite), 
Foreign Key to `itinerary_categories_master(id)` ON DELETE RESTRICT, Not Null | 
Identifier of the itinerary category. | | `created_at` | `timestamp with time 
zone` | Not Null, Default `now()` | Timestamp when the association was created. 
| | `created_by_profile_id` | `uuid` | Foreign Key to `public.profiles(id)` ON 
DELETE SET NULL, Nullable | Profile ID of the user who created this link. | | 
`updated_at` | `timestamp with time zone` | Not Null, Default `now()` | 
Timestamp when this link record was last updated (auto-updated by trigger). | | 
`updated_by_profile_id` | `uuid` | Foreign Key to `public.profiles(id)` ON 
DELETE SET NULL, Nullable | Profile ID of the user who last updated this link. 
| 3\. PostgreSQL DDL SQL ``` CREATE TABLE public.curated_itinerary_to_category 
( itinerary_id BIGINT NOT NULL REFERENCES public.curated_itineraries(id) ON 
DELETE CASCADE, category_id INTEGER NOT NULL REFERENCES 
public.itinerary_categories_master(id) ON DELETE RESTRICT, created_at 
TIMESTAMPTZ NOT NULL DEFAULT now(), created_by_profile_id UUID REFERENCES 
public.profiles(id) ON DELETE SET NULL, updated_at TIMESTAMPTZ NOT NULL DEFAULT 
now(), updated_by_profile_id UUID REFERENCES public.profiles(id) ON DELETE SET 
NULL, PRIMARY KEY (itinerary_id, category_id) ); -- Indexes -- Composite PK 
creates a unique index on (itinerary_id, category_id). CREATE INDEX IF NOT 
EXISTS idx_curated_itinerary_to_category_itinerary_id ON 
public.curated_itinerary_to_category(itinerary_id); CREATE INDEX IF NOT EXISTS 
idx_curated_itinerary_to_category_category_id ON 
public.curated_itinerary_to_category(category_id); CREATE INDEX IF NOT EXISTS 
idx_curated_itinerary_to_category_created_by ON 
public.curated_itinerary_to_category(created_by_profile_id) WHERE 
created_by_profile_id IS NOT NULL; CREATE INDEX IF NOT EXISTS 
idx_curated_itinerary_to_category_updated_by ON 
public.curated_itinerary_to_category(updated_by_profile_id) WHERE 
updated_by_profile_id IS NOT NULL; -- Comments COMMENT ON TABLE 
public.curated_itinerary_to_category IS 'Junction table linking curated 
itineraries to their assigned categories (Many-to-Many relationship). Version 
2.1.'; COMMENT ON COLUMN public.curated_itinerary_to_category.itinerary_id IS 
'Foreign key to the public.curated_itineraries table. Part of composite PK. ON 
DELETE CASCADE. Version 2.1.'; COMMENT ON COLUMN 
public.curated_itinerary_to_category.category_id IS 'Foreign key to the 
public.itinerary_categories_master table. Part of composite PK. ON DELETE 
RESTRICT. Version 2.1.'; COMMENT ON COLUMN 
public.curated_itinerary_to_category.created_at IS 'Timestamp when the 
itinerary-category association was made. Version 2.1.'; COMMENT ON COLUMN 
public.curated_itinerary_to_category.created_by_profile_id IS 'Profile ID of 
the user who created this link. FK to public.profiles.id. ON DELETE SET NULL. 
Version 2.1.'; COMMENT ON COLUMN 
public.curated_itinerary_to_category.updated_at IS 'Timestamp when this link 
record was last updated (auto-updated by trigger). Version 2.1.'; COMMENT ON 
COLUMN public.curated_itinerary_to_category.updated_by_profile_id IS 'Profile 
ID of the user who last updated this link. FK to public.profiles.id. ON DELETE 
SET NULL. Version 2.1.'; ``` 4\. Triggers/Functions - Audit Metadata Trigger: 
SQL ``` -- Assuming a generic public.set_linking_table_audit_meta() or 
public.set_master_table_audit_meta() function is defined -- that handles 
created_at, updated_at, created_by_profile_id, and updated_by_profile_id. -- 
Example: -- CREATE OR REPLACE FUNCTION public.set_linking_table_audit_meta()... 
(as defined previously) CREATE TRIGGER 
trigger_set_curated_itinerary_to_category_audit_meta BEFORE INSERT OR UPDATE ON 
public.curated_itinerary_to_category FOR EACH ROW EXECUTE FUNCTION 
public.set_linking_table_audit_meta(); -- Or a more generic audit trigger ``` 
*Comment on Trigger*: Manages `created_at`, `updated_at`, 
`created_by_profile_id`, and `updated_by_profile_id` columns. 5\. JSON Schema 
Mirror JSON ``` { "title": "curated_itinerary_to_category", "description": 
"Junction table linking curated itineraries to their assigned categories 
(Many-to-Many relationship). Version 2.1.", "type": "object", "properties": { 
"itinerary_id": { "type": "integer", "format": "int64", "description": 
"Identifier of the curated itinerary. FK to public.curated_itineraries.id. Part 
of composite PK. Version 2.1." }, "category_id": { "type": "integer", 
"description": "Identifier of the itinerary category. FK to 
public.itinerary_categories_master.id. Part of composite PK. Version 2.1." }, 
"created_at": { "type": "string", "format": "date-time", "readOnly": true, 
"description": "Timestamp when the association was created. Read-only. Version 
2.1." }, "created_by_profile_id": { "type": ["string", "null"], "format": 
"uuid", "description": "Profile ID of the user who created this link. FK to 
public.profiles.id. Read-only. Version 2.1.", "readOnly": true }, "updated_at": 
{ "type": "string", "format": "date-time", "readOnly": true, "description": 
"Timestamp when this link record was last updated (auto-updated by trigger). 
Read-only. Version 2.1." }, "updated_by_profile_id": { "type": ["string", 
"null"], "format": "uuid", "description": "Profile ID of the user who last 
updated this link. FK to public.profiles.id. Read-only. Version 2.1.", 
"readOnly": true } }, "required": [ "itinerary_id", "category_id", 
"created_at", "updated_at" ], "primary_key": ["itinerary_id", "category_id"] } 
``` 6\. Relationships & Integrity - Composite Primary Key: `(itinerary_id, 
category_id)`. - `itinerary_id` -> `public.curated_itineraries(id)`: `ON DELETE 
CASCADE`. - `category_id` -> `public.itinerary_categories_master(id)`: `ON 
DELETE RESTRICT`. - Audit FKs to `public.profiles(id)`. - Mermaid ER Snippet: 
Code snippet ``` erDiagram curated_itineraries { bigint id PK } 
itinerary_categories_master { integer id PK } profiles { uuid id PK } 
curated_itinerary_to_category { bigint itinerary_id PK FK integer category_id 
PK FK timestamptz created_at uuid created_by_profile_id FK timestamptz 
updated_at uuid updated_by_profile_id FK } curated_itineraries ||--|{ 
curated_itinerary_to_category : "has categories (CASCADE)" 
itinerary_categories_master ||--|{ curated_itinerary_to_category : "categorizes 
itineraries (RESTRICT)" curated_itinerary_to_category }o--|| profiles : 
"created_by (SET NULL)" curated_itinerary_to_category }o--|| profiles : 
"updated_by (SET NULL)" ``` 7\. Multilingual Strategy - âšª N/A - This table 
contains no direct translatable text. It links records that have their own 
multilingual strategies. 8\. Role-Based Workflow & RLS Notes - Workflow: 
`created_at` and other audit columns track link creation/modification. - RLS 
Policies (Conceptual): Aligned with parent `curated_itineraries` permissions. 
If a user can edit an itinerary, they can manage its category links. 9\. ENUM 
vs Lookup Discussion - âšª N/A - This junction table supports the 
`itinerary_categories_master` lookup table. 10\. UI/UX Enablement - Fundamental 
for assigning categories to itineraries and enabling category-based filtering. 
- PK and FK indexes support query performance. 11\. Auditing & Lifecycle 
Management - Audit Columns: `created_at`, `updated_at`, 
`created_by_profile_id`, `updated_by_profile_id`. - Lifecycle: No soft delete. 
Rows are hard-deleted when a link is removed or parent itinerary is deleted 
(CASCADE). 12\. Scalability & Future-Proofing - Standard junction table design, 
scales with number of itineraries and average categories per itinerary. 13\. 
Seed Data - âšª N/A - Transactional linking data. 14\. Next-Action Checklist - 
ðŸ”´ Implement DDL: Execute `CREATE TABLE` for 
`public.curated_itinerary_to_category` with all audit columns, PK, FKs, and 
indexes. - ðŸ”´ Implement Audit Trigger: Apply 
`public.set_linking_table_audit_meta` (or similar). - ðŸŸ  Verify FK Data Types: 
Ensure `itinerary_id` is `bigint` and `category_id` is `integer`. - ðŸŸ  
Implement RLS Policies. - ðŸŸ¢ Test integrity rules (`ON DELETE 
CASCADE`/`RESTRICT`). - ðŸŸ¢ Update Admin UI for category assignment. * * * * * 
