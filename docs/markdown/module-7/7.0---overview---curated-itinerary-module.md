# 7.0 - overview - Curated Itinerary Module

  https://gemini.google.com/u/1/app/67787f5b9ee9db46 
https://gemini.google.com/u/1/app/42a77d08d7a45bcb * * * * * Curated Itinerary 
Module Overview Version: 2.1 (Checklist REV 05-18-25-A Applied, ENUM Promotion, 
Audit Columns, Translation Handling Finalized) Date: May 18, 2025 This document 
provides a master recap and architecture overview for the Curated Itinerary 
Module (Module 7) of the pilgrimage-platform database. It details how tables, 
master data (formerly ENUMs), translation mechanisms, security policies, API 
considerations, and other database objects interlock, along with a recommended 
build order for successful deployment. ### 1\. Executive Summary This database 
module provides the backbone for managing and presenting editorially curated 
pilgrimage itineraries. It allows administrators to define itineraries, their 
day-by-day structure (via segments), categorize them by themes and seasons, 
assign difficulty levels, and control their publication status using dedicated 
master tables. Key enhancements include the promotion of former ENUMs 
(difficulty, status, categories, seasons) to fully-fledged master lookup 
tables, the addition of comprehensive audit columns (`created_at`, 
`updated_at`, `created_by_profile_id`, `updated_by_profile_id`) to all tables, 
and standardized orphan-translation cleanup triggers. This module enables 
pilgrims to browse, filter, and select rich, localized journeys tailored to 
their preferences. ### 2\. Group-Level Snapshot | Group | Key Tables | Primary 
Purpose | Top Inter-Group Links | | 7\. Curated Itinerary Module | 
`curated_itineraries`, `curated_itinerary_segments`, 
`itinerary_categories_master`, `curated_itinerary_to_category`, 
`seasons_master`, `curated_itinerary_to_season`, 
`trail_difficulty_levels_master`, `content_statuses_master` | Defines, 
structures, categorizes, and manages the lifecycle of pre-defined pilgrimage 
itineraries and their associated lookup data (difficulty, status, categories, 
seasons). | `profiles` (for audit columns), `media` (for itinerary images), 
`segments` (for itinerary composition), `public.translations` (for all 
multilingual content). | * * * * * ### 3\. Narrative Walkthrough This module, 
"7. Curated Itinerary Module," is central to presenting rich, predefined 
pilgrimage experiences, now with enhanced structure and auditability. - 
`trail_difficulty_levels_master` (v2.1 - New Master Table): - Stores the 
definitive, translatable list of difficulty levels (e.g., "Easy," "Moderate") 
with `code`, `name`, `description`, `icon_identifier`, `sort_order`, 
`is_active` flag, and full V2 audit columns. - Replaces the former 
`trail_difficulty_enum`. - `AFTER DELETE` trigger cleans up related 
translations. - `content_statuses_master` (v2.1 - New Master Table): - Manages 
the translatable lifecycle statuses for content (e.g., "DRAFT," "PUBLISHED") 
with `code`, `name`, `description`, `icon_identifier`, `sort_order`, 
`is_active` flag, and full V2 audit columns. - Ensures content entities always 
have a defined status via a FK relationship. - Replaces the former 
`content_visibility_status_enum`. - `AFTER DELETE` trigger cleans up related 
translations. - `itinerary_categories_master` (v2.1 - New Master Table): - A 
lookup table for translatable itinerary categories (e.g., "Franciscan Sites 
Focus") with `category_code`, `name`, `description`, `icon_identifier`, 
`sort_order`, `is_active` flag, and full V2 audit columns. - Replaces the 
former `itinerary_category_tag_enum[]`. - `AFTER DELETE` trigger cleans up 
related translations. - `seasons_master` (v2.1 - New Master Table): - A lookup 
table for translatable seasons (e.g., "Spring," "Year-round") with 
`season_code`, `name`, `description`, `icon_identifier`, `sort_order`, 
`is_active` flag, and full V2 audit columns. - Replaces former `TEXT[]` for 
seasons. - `AFTER DELETE` trigger cleans up related translations. - 
`curated_itineraries` (v3.1): - Core table holding metadata for each curated 
journey. Includes translatable fields like `name`, `short_description`, 
`long_description`, etc. - Links to `trail_difficulty_levels_master` via 
`overall_difficulty_level_id` (FK). - Links to `content_statuses_master` via 
`content_status_id` (FK, NOT NULL). - Includes full V2 audit columns 
(`created_at`, `updated_at`, `created_by_profile_id`, `updated_by_profile_id`) 
and `deleted_at` for soft deletion. - Comprehensive audit trigger and 
orphan-translation cleanup trigger are implemented. - Default 
`content_status_id` (to 'DRAFT') and `slug` generation are application/trigger 
responsibilities. - `curated_itinerary_to_category` (v2.1 - New Junction 
Table): - Establishes M-M relationship between `curated_itineraries` and 
`itinerary_categories_master`. - Includes `itinerary_id` (CASCADE DELETE), 
`category_id` (RESTRICT DELETE), and full V2 audit columns. - Comprehensive 
audit trigger implemented. - `curated_itinerary_to_season` (v2.1 - New Junction 
Table): - Establishes M-M relationship between `curated_itineraries` and 
`seasons_master`. - Includes `itinerary_id` (CASCADE DELETE), `season_id` 
(RESTRICT DELETE), and full V2 audit columns. - Comprehensive audit trigger 
implemented. - `curated_itinerary_segments` (v2.1): - Defines the ordered 
"playlist" of `segments` for each day of an itinerary. - Includes 
`itinerary_id` (CASCADE DELETE), `segment_id` (RESTRICT DELETE), 
`day_number_in_itinerary`, `order_of_segment_within_day`. - 
`notes_for_segment_in_itinerary` is translatable. - Includes full V2 audit 
columns. - Comprehensive audit trigger and orphan-translation cleanup trigger 
implemented. - `UNIQUE (itinerary_id, day_number_in_itinerary, 
order_of_segment_within_day)` constraint. * * * * * ### 4\. Cross-Cutting 
Concerns - Users & Roles: - All tables in this module now include standardized 
V2 audit columns: `created_at`, `updated_at`, `created_by_profile_id` (FK to 
`profiles.id`), and `updated_by_profile_id` (FK to `profiles.id`). - 
Comprehensive audit triggers populate these fields. - RLS policies 
differentiate access based on roles, utilizing helper functions. - Translations 
/ i18n: - A central `public.translations` table stores all multilingual 
content. - Base language (English) versions are stored directly in respective 
table columns (e.g., `curated_itineraries.name`, 
`itinerary_categories_master.description`). Column names are now generic (e.g., 
`name`, not `name_en`). - Translatable Fields Mapping (Module 7 - V2.1): - 
`curated_itineraries`: `name`, `short_description`, `long_description`, 
`theme_or_focus`, `suitability_notes`, `primary_start_location_text`, 
`primary_end_location_text`. - `curated_itinerary_segments`: 
`notes_for_segment_in_itinerary`. - `itinerary_categories_master`: `name`, 
`description`. - `seasons_master`: `name`, `description`. - 
`trail_difficulty_levels_master`: `name`, `description`. - 
`content_statuses_master`: `name`, `description`. - ðŸ”´ Crucial: All tables with 
translatable fields (`curated_itineraries`, `curated_itinerary_segments`, and 
all four new master tables) now have `AFTER DELETE` triggers that call specific 
cleanup functions (e.g., `public.cleanup_curated_itineraries_translations()`) 
to remove orphaned entries from `public.translations`. - ENUM & Taxonomy 
Registry (V2.1 Update: Promotion to Master Tables): - 
`curated_itineraries.overall_difficulty_level_id` (FK) now points to 
`public.trail_difficulty_levels_master(id)`. - 
`curated_itineraries.content_status_id` (FK) now points to 
`public.content_statuses_master(id)`. - Itinerary categories are managed via 
`public.itinerary_categories_master` and linked through 
`public.curated_itinerary_to_category`. - Recommended seasons are managed via 
`public.seasons_master` and linked through 
`public.curated_itinerary_to_season`. - All new master tables include `code`, 
`name` (translatable), `description` (translatable), `icon_identifier` 
(optional), `sort_order`, `is_active`, and full audit columns. - Media & Files: 
- `curated_itineraries` links to `public.media(id)` (UUID PK) for 
`banner_image_media_id` and `map_overview_image_media_id` using `uuid` FKs. - 
`ON DELETE SET NULL` is used for these media FKs. - Audit / Soft-Delete / 
Versioning: - Audit: All tables feature full V2 audit columns, managed by 
triggers. - Soft-Delete: `curated_itineraries` uses `deleted_at timestamp with 
time zone`. Master lookup tables use an `is_active boolean` flag. Junction 
tables and `curated_itinerary_segments` do not have soft delete; their 
lifecycle is tied to parent records. - Versioning: `curated_itineraries` has 
`version_notes text`. `updated_at` provides basic versioning hooks. * * * * * 
### 5\. Security & Access Control ðŸ” - RLS Overview: - Row-Level Security 
policies are defined for all tables to control access based on user roles 
(e.g., Admin, Regional Content Manager, Authenticated User, Anonymous) and 
content status (e.g., 'PUBLISHED', `is_active=true`). - Policies typically 
grant full CUD to Admins. Content Managers have conditional write access. 
Public users have read access to published/active content. - RLS Helper 
Functions: Policies rely on helper functions like `public.has_role(TEXT)`, 
`public.is_platform_admin()`, and potentially module-specific helpers (e.g., 
`user_manages_itinerary_content()`). These functions query 
`public.profiles.roles` using `auth.uid()`. - SECURITY DEFINER Functions: Audit 
triggers and translation cleanup triggers are `SECURITY DEFINER` and must have 
their `search_path` appropriately set (e.g., `ALTER FUNCTION ... SET 
search_path = public;`). * * * * * ### 6\. Prerequisite Objects & Build Order âš™ï¸ 
1. Global/Shared Prerequisite Objects: - `public.profiles` table (for audit 
FKs). - `public.media` table (for image FKs). - `public.segments` table (for 
`curated_itinerary_segments.segment_id` FK). - `public.translations` table (for 
storing all translations). - Core RLS helper functions 
(`public.has_role(TEXT)`, `public.is_platform_admin()`). - Standard audit 
trigger function (e.g., `public.set_master_table_audit_meta()` or 
`public.set_linking_table_audit_meta()`). - Standard translation cleanup 
function template adapted for each table. 2. Module 7 Tables & Objects 
(Recommended Build Order): 1. Master Tables (Lookup Data): - 
`public.trail_difficulty_levels_master` (DDL, Triggers: Audit, Translations 
Cleanup) - `public.content_statuses_master` (DDL, Triggers: Audit, Translations 
Cleanup) - `public.itinerary_categories_master` (DDL, Triggers: Audit, 
Translations Cleanup) - `public.seasons_master` (DDL, Triggers: Audit, 
Translations Cleanup) 2. Seed Master Tables: Populate the above master tables 
with initial data and their base language translations in 
`public.translations`. 3. Core Entity Table: - `public.curated_itineraries` 
(DDL including FKs to master tables, Triggers: Audit, Translations Cleanup) 4. 
Linking/Detail Tables: - `public.curated_itinerary_to_category` (DDL, Triggers: 
Audit) - `public.curated_itinerary_to_season` (DDL, Triggers: Audit) - 
`public.curated_itinerary_segments` (DDL, Triggers: Audit, Translations 
Cleanup) 5. Views (for API support): - 
`public.v_curated_itineraries_list_localized` - 
`public.v_curated_itinerary_detail_localized` - *(Consider 
`public.v_curated_itinerary_segments_localized`)* 6. Indexes & Constraints: 
Apply all remaining indexes and constraints not created with table DDLs. 7. RLS 
Policies: Enable RLS and apply policies to all tables. * * * * * ### 7\. 
Performance & Optimization Extras - Key Indexes: Comprehensive indexing is 
defined for all tables, including on PKs, FKs, unique constraints (`code`, 
`name`, `slug`), boolean flags (`is_active`, `is_featured_itinerary`), and 
`sort_order` on master tables. The `translations` table requires a robust 
composite index. - Views for API Performance: - 
`public.v_curated_itineraries_list_localized`: Designed for efficient listing 
of itineraries with key localized information. - 
`public.v_curated_itinerary_detail_localized`: Provides comprehensive localized 
details for a single itinerary, using CTEs for JSONB aggregation of categories 
and seasons. Performance should be monitored, and materialization or DB 
functions considered if necessary. - Partitioning: Not anticipated as necessary 
for Module 7 tables in V2.1. - Caching: Application-level caching for 
frequently accessed, relatively static data (like master table content or 
published itinerary details) is recommended. * * * * * ### 8\. Visuals 
(Conceptual ERD - Module 7 Focus) Code snippet ``` erDiagram profiles { uuid id 
PK text public_display_name } media { uuid id PK text 
storage_object_path_original jsonb image_variants_json text default_alt_text 
"Translatable" } segments { bigint id PK text name "Translatable" } 
translations { bigint id PK text table_identifier text column_identifier text 
row_foreign_key text language_code FK text translated_text } 
trail_difficulty_levels_master { integer id PK text code UK text name "Base 
Lang, Translatable" text description "Base Lang, Translatable" text 
icon_identifier integer sort_order boolean is_active uuid created_by_profile_id 
FK uuid updated_by_profile_id FK } content_statuses_master { integer id PK text 
code UK text name "Base Lang, Translatable" text description "Base Lang, 
Translatable" text icon_identifier integer sort_order boolean is_active uuid 
created_by_profile_id FK uuid updated_by_profile_id FK } 
itinerary_categories_master { integer id PK text category_code UK text name 
"Base Lang, Translatable" text description "Base Lang, Translatable" text 
icon_identifier integer sort_order boolean is_active uuid created_by_profile_id 
FK uuid updated_by_profile_id FK } seasons_master { integer id PK text 
season_code UK text name "Base Lang, Translatable" text description "Base Lang, 
Translatable" text icon_identifier integer sort_order boolean is_active uuid 
created_by_profile_id FK uuid updated_by_profile_id FK } curated_itineraries { 
bigint id PK text name "Base Lang, Translatable" text slug UK text 
short_description "Base Lang, Translatable" text long_description "Base Lang, 
Translatable" integer overall_difficulty_level_id FK integer content_status_id 
FK uuid banner_image_media_id FK uuid map_overview_image_media_id FK uuid 
created_by_profile_id FK uuid updated_by_profile_id FK timestamptz deleted_at } 
curated_itinerary_to_category { bigint itinerary_id PK FK integer category_id 
PK FK uuid created_by_profile_id FK uuid updated_by_profile_id FK } 
curated_itinerary_to_season { bigint itinerary_id PK FK integer season_id PK FK 
uuid created_by_profile_id FK uuid updated_by_profile_id FK } 
curated_itinerary_segments { bigint id PK bigint itinerary_id FK bigint 
segment_id FK text notes_for_segment_in_itinerary "Base Lang, Translatable" 
uuid created_by_profile_id FK uuid updated_by_profile_id FK } 
curated_itineraries }o--|| trail_difficulty_levels_master : "difficulty (SET 
NULL)" curated_itineraries }o--|| content_statuses_master : "status (RESTRICT)" 
curated_itineraries }o--|| media : "banner_image (SET NULL)" 
curated_itineraries }o--|| media : "map_image (SET NULL)" curated_itineraries 
}o--|| profiles : "created_by (SET NULL)" curated_itineraries }o--|| profiles : 
"updated_by (SET NULL)" curated_itineraries ||--|{ 
curated_itinerary_to_category : "has_categories (CASCADE)" 
itinerary_categories_master ||--|{ curated_itinerary_to_category : "categorizes 
(RESTRICT)" curated_itinerary_to_category }o--|| profiles : "link_created_by 
(SET NULL)" curated_itinerary_to_category }o--|| profiles : "link_updated_by 
(SET NULL)" curated_itineraries ||--|{ curated_itinerary_to_season : 
"has_seasons (CASCADE)" seasons_master ||--|{ curated_itinerary_to_season : 
"applies_to (RESTRICT)" curated_itinerary_to_season }o--|| profiles : 
"link_created_by (SET NULL)" curated_itinerary_to_season }o--|| profiles : 
"link_updated_by (SET NULL)" curated_itineraries ||--|{ 
curated_itinerary_segments : "composed_of (CASCADE)" curated_itinerary_segments 
}o--|| segments : "uses_segment (RESTRICT)" curated_itinerary_segments }o--|| 
profiles : "segment_link_created_by (SET NULL)" curated_itinerary_segments 
}o--|| profiles : "segment_link_updated_by (SET NULL)" 
trail_difficulty_levels_master }o--|| profiles : "master_created_by (SET NULL)" 
trail_difficulty_levels_master }o--|| profiles : "master_updated_by (SET NULL)" 
content_statuses_master }o--|| profiles : "master_created_by (SET NULL)" 
content_statuses_master }o--|| profiles : "master_updated_by (SET NULL)" 
itinerary_categories_master }o--|| profiles : "master_created_by (SET NULL)" 
itinerary_categories_master }o--|| profiles : "master_updated_by (SET NULL)" 
seasons_master }o--|| profiles : "master_created_by (SET NULL)" seasons_master 
}o--|| profiles : "master_updated_by (SET NULL)" %% Conceptual links to 
translations table for translatable fields in each relevant table 
curated_itineraries ..> translations : "translatable_fields" 
itinerary_categories_master ..> translations : "translatable_fields" 
seasons_master ..> translations : "translatable_fields" 
trail_difficulty_levels_master ..> translations : "translatable_fields" 
content_statuses_master ..> translations : "translatable_fields" 
curated_itinerary_segments ..> translations : "translatable_fields" ``` * * * * 
* ### 9\. Critical Gaps & Risks (Post V2.1 Review) - ðŸŸ  Default 
`content_status_id` and `slug` Generation for `curated_itineraries`: Requires 
robust implementation (application logic or DB trigger). If inconsistent, 
itineraries might be unusable or have poor SEO. - ðŸŸ  Performance of Detailed 
Views: `v_curated_itinerary_detail_localized` with its multiple joins and JSONB 
aggregations needs thorough performance testing under load. Consider 
materialization or DB functions if it becomes a bottleneck. - ðŸŸ¢ RLS Helper 
Function Implementation: Assumed helper functions (`is_platform_admin()`, etc.) 
must be securely and correctly implemented. - ðŸŸ¢ Seed Data Accuracy: Initial 
values for master tables require business/content team validation. - ðŸŸ¢ 
Application Layer Logic for Translations: The DB provides the mechanism, but 
the application layer must correctly request localized content, manage 
translations for new/updated base language text, and handle fallbacks if a 
translation is missing. * * * * * ### 10\. Scalability & Future-Proof Notes - 
Promotion to Master Tables: Using dedicated master tables for difficulty, 
status, categories, and seasons provides excellent scalability and flexibility 
for adding new attributes or options without schema changes to 
`curated_itineraries`. - Standardized Auditing & i18n: Full audit trails and a 
central translation mechanism with orphan cleanup improve data integrity and 
maintainability. - Surrogate PKs on Junctions (if applicable): 
`curated_itinerary_segments` uses a surrogate PK, which can be beneficial if 
these links ever need their own direct translations or more complex attributes. 
`curated_itinerary_to_category` and `curated_itinerary_to_season` use composite 
PKs, suitable for pure M-M links. - Views for API Decoupling: Using views helps 
decouple the API from the physical schema. * * * * * ### 11\. Next Steps 
(Module 7 Deployment) 1. P1: Implement Prerequisite Global Objects: Ensure 
`public.profiles`, `public.media`, `public.segments`, `public.translations` 
tables, RLS helper functions, and standard audit trigger functions are in 
place. 2. P1: Execute DDL for Module 7: Create all master tables, then 
`curated_itineraries`, then junction/detail tables, including all indexes and 
triggers (audit and translation cleanup). 3. P1: Seed Master Tables: Populate 
`trail_difficulty_levels_master`, `content_statuses_master`, 
`itinerary_categories_master`, `seasons_master` with initial data and their 
base language translations. 4. P1: Implement and Test RLS Policies: Apply and 
rigorously test all RLS policies for all Module 7 tables. 5. P2: Implement 
Views: Create and test `public.v_curated_itineraries_list_localized` and 
`public.v_curated_itinerary_detail_localized`. 6. P2: Develop/Update 
Application Logic: Adapt backend services and admin UIs to use the new V2.1 
structures, manage translations, and interact with the new master tables and 
views. 7. P2: Data Migration (If Applicable): Migrate any existing itinerary 
data to the new V2.1 schema, including populating new FKs and audit columns. * 
* * * * 
