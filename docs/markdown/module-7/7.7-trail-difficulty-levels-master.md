# 7.7 trail_difficulty_levels_master

  https://gemini.google.com/u/1/app/a7603b60134369c2 
https://gemini.google.com/u/1/app/42a77d08d7a45bcb * * * * * Production-Ready 
Specification: public.trail_difficulty_levels_master Table Version: 2.1 (V2.1 
Checklist REV 05-18-25-A Applied) Date: May 18, 2025 1\. Purpose & Primary 
Use-Cases Stores the definitive list of trail difficulty levels (e.g., Easy, 
Moderate, Challenging) that can be assigned to trails, routes, and curated 
itineraries. This provides a structured, translatable, and manageable way to 
classify difficulty across the platform. *Key User-Story Touchpoints:* - 
Pilgrim (Anna): Enables understanding and filtering of routes/itineraries by 
difficulty (A1, A2, A7). - Platform Administrator (Admin Team) / Regional 
Content Manager (Sofia): Allows management of available difficulty levels and 
consistent assignment (D1, D2). 2\. Schema | Column | Data Type | Constraints | 
Description (Translatable fields marked) | | `id` | `integer` | Primary Key, 
Generated always as identity | Unique identifier for each difficulty level. | | 
`code` | `text` | Not Null, Unique, `CHECK (char_length(code) <= 50 AND code = 
upper(code) AND code ~ '^[A-Z_]+$')` | Stable, machine-readable code (e.g., 
"EASY"). Uppercase, letters, underscores. Max 50 chars. | | `name` | `text` | 
Not Null, Unique, `CHECK (char_length(name) <= 100)` | Display name in the base 
language (English). (Translatable) Max 100 chars. | | `description` | `text` | 
Nullable | Short description of the difficulty level in the base language 
(English). (Translatable) | | `icon_identifier` | `text` | Nullable, `CHECK 
(icon_identifier IS NULL OR char_length(icon_identifier) <= 100)` | Optional 
identifier for an icon representing this difficulty level. Max 100 chars. | | 
`sort_order` | `integer` | Not Null, Default `0` | Optional integer for display 
order in UI lists/filters. | | `is_active` | `boolean` | Not Null, Default 
`true` | Whether the difficulty level is active and available for 
assignment/display. | | `created_at` | `timestamp with time zone` | Not Null, 
Default `now()` | Timestamp of record creation. | | `created_by_profile_id` | 
`uuid` | Foreign Key to `public.profiles(id)` ON DELETE SET NULL, Nullable | 
Profile ID of the user who created this record. | | `updated_at` | `timestamp 
with time zone` | Not Null, Default `now()` | Timestamp of last update 
(auto-updated by trigger). | | `updated_by_profile_id` | `uuid` | Foreign Key 
to `public.profiles(id)` ON DELETE SET NULL, Nullable | Profile ID of the user 
who last updated this record. | 3\. PostgreSQL DDL SQL ``` CREATE TABLE 
public.trail_difficulty_levels_master ( id INTEGER GENERATED ALWAYS AS IDENTITY 
PRIMARY KEY, code TEXT NOT NULL UNIQUE CHECK (char_length(code) <= 50 AND code 
= upper(code) AND code ~ '^[A-Z_]+$'), name TEXT NOT NULL UNIQUE CHECK 
(char_length(name) <= 100), -- (Translatable) description TEXT, -- 
(Translatable) icon_identifier TEXT CHECK (icon_identifier IS NULL OR 
char_length(icon_identifier) <= 100), sort_order INTEGER NOT NULL DEFAULT 0, 
is_active BOOLEAN NOT NULL DEFAULT true, created_at TIMESTAMPTZ NOT NULL 
DEFAULT now(), created_by_profile_id UUID REFERENCES public.profiles(id) ON 
DELETE SET NULL, updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), 
updated_by_profile_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL ); 
-- Indexes CREATE INDEX IF NOT EXISTS 
idx_trail_difficulty_levels_master_is_active ON 
public.trail_difficulty_levels_master(is_active); CREATE INDEX IF NOT EXISTS 
idx_trail_difficulty_levels_master_sort_order ON 
public.trail_difficulty_levels_master(sort_order); CREATE INDEX IF NOT EXISTS 
idx_trail_difficulty_levels_master_created_by ON 
public.trail_difficulty_levels_master(created_by_profile_id) WHERE 
created_by_profile_id IS NOT NULL; CREATE INDEX IF NOT EXISTS 
idx_trail_difficulty_levels_master_updated_by ON 
public.trail_difficulty_levels_master(updated_by_profile_id) WHERE 
updated_by_profile_id IS NOT NULL; -- Comments COMMENT ON TABLE 
public.trail_difficulty_levels_master IS 'Master lookup table for trail 
difficulty levels (e.g., Easy, Moderate). Name and description are 
translatable. Version 2.1.'; COMMENT ON COLUMN 
public.trail_difficulty_levels_master.id IS 'PK. Unique identifier for each 
difficulty level. Version 2.1.'; COMMENT ON COLUMN 
public.trail_difficulty_levels_master.code IS 'Stable, machine-readable code 
(e.g., "EASY"). Uppercase, letters, underscores. Max 50 chars. Must be unique. 
Version 2.1.'; COMMENT ON COLUMN public.trail_difficulty_levels_master.name IS 
'Display name of the difficulty level (Base language: English). Translatable 
via public.translations. Max 100 chars. Must be unique. Version 2.1.'; COMMENT 
ON COLUMN public.trail_difficulty_levels_master.description IS 'Short 
description of the difficulty level (Base language: English). Translatable via 
public.translations. Version 2.1.'; COMMENT ON COLUMN 
public.trail_difficulty_levels_master.icon_identifier IS 'Optional identifier 
for an icon representing this difficulty level. Max 100 chars. Version 2.1.'; 
COMMENT ON COLUMN public.trail_difficulty_levels_master.sort_order IS 'Optional 
integer for display order in UI lists/filters. Lower numbers display first. 
Default 0. Version 2.1.'; COMMENT ON COLUMN 
public.trail_difficulty_levels_master.is_active IS 'Whether the difficulty 
level is active and available for assignment/display. Default true. Version 
2.1.'; COMMENT ON COLUMN public.trail_difficulty_levels_master.created_at IS 
'Timestamp of record creation. Version 2.1.'; COMMENT ON COLUMN 
public.trail_difficulty_levels_master.created_by_profile_id IS 'Profile ID of 
the user who created this record. FK to public.profiles.id. Version 2.1.'; 
COMMENT ON COLUMN public.trail_difficulty_levels_master.updated_at IS 
'Timestamp of last update (auto-updated by trigger). Version 2.1.'; COMMENT ON 
COLUMN public.trail_difficulty_levels_master.updated_by_profile_id IS 'Profile 
ID of the user who last updated this record. FK to public.profiles.id. Version 
2.1.'; -- Initial Population Example (adapt 'PUT_SYSTEM_USER_UUID_HERE' as 
needed) INSERT INTO public.trail_difficulty_levels_master (code, name, 
description, icon_identifier, sort_order, created_by_profile_id, 
updated_by_profile_id) VALUES ('EASY', 'Easy', 'Suitable for most fitness 
levels, relatively flat terrain.', 'difficulty_easy_icon', 10, 
'PUT_SYSTEM_USER_UUID_HERE', 'PUT_SYSTEM_USER_UUID_HERE'), ('MODERATE', 
'Moderate', 'Some inclines or uneven terrain, requires a reasonable level of 
fitness.', 'difficulty_moderate_icon', 20, 'PUT_SYSTEM_USER_UUID_HERE', 
'PUT_SYSTEM_USER_UUID_HERE'), ('CHALLENGING', 'Challenging', 'Steep inclines, 
rugged terrain, for experienced hikers.', 'difficulty_challenging_icon', 30, 
'PUT_SYSTEM_USER_UUID_HERE', 'PUT_SYSTEM_USER_UUID_HERE'), ('VERY_CHALLENGING', 
'Very Challenging', 'Long distances, significant elevation changes, potentially 
exposed sections, requires high fitness and experience.', 
'difficulty_very_challenging_icon', 40, 'PUT_SYSTEM_USER_UUID_HERE', 
'PUT_SYSTEM_USER_UUID_HERE'); -- Seed corresponding English 'name' and 
'description' into public.translations table. ``` 4\. Triggers/Functions - 
Audit Metadata Trigger: SQL ``` -- Assuming 
public.set_master_table_audit_meta() is defined (see terrain_types_master 
example) CREATE TRIGGER trigger_trail_difficulty_levels_master_audit_meta 
BEFORE INSERT OR UPDATE ON public.trail_difficulty_levels_master FOR EACH ROW 
EXECUTE FUNCTION public.set_master_table_audit_meta(); ``` *Comment on 
Trigger*: Manages `created_at`, `updated_at`, `created_by_profile_id`, and 
`updated_by_profile_id` columns. - Orphaned Translation Cleanup Trigger: SQL 
``` CREATE OR REPLACE FUNCTION 
public.cleanup_trail_difficulty_levels_master_translations() RETURNS TRIGGER AS 
$$ BEGIN DELETE FROM public.translations WHERE table_identifier = 
'trail_difficulty_levels_master' AND row_foreign_key = OLD.id::text; RETURN 
OLD; END; $$ LANGUAGE plpgsql SECURITY DEFINER; ALTER FUNCTION 
public.cleanup_trail_difficulty_levels_master_translations() SET search_path = 
public; CREATE TRIGGER 
trigger_cleanup_trail_difficulty_levels_master_translations AFTER DELETE ON 
public.trail_difficulty_levels_master FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_trail_difficulty_levels_master_translations(); ``` *Comment on 
Trigger*: After a difficulty level is deleted, this trigger removes associated 
translations for its `name` and `description` from `public.translations`. 5\. 
JSON Schema Mirror JSON ``` { "title": "trail_difficulty_level_master", 
"description": "Master lookup table for trail difficulty levels (e.g., Easy, 
Moderate). Name and description are translatable. Version 2.1.", "type": 
"object", "properties": { "id": { "type": "integer", "readOnly": true, 
"description": "PK. Unique identifier for each difficulty level. Version 2.1." 
}, "code": { "type": "string", "maxLength": 50, "pattern": "^[A-Z_]+$", 
"description": "Stable, machine-readable code (e.g., \"EASY\"). Uppercase, 
letters, underscores. Max 50 chars. Must be unique. Version 2.1." }, "name": { 
"type": "string", "maxLength": 100, "description": "Display name of the 
difficulty level (Base language: English). Translatable via 
public.translations. Max 100 chars. Must be unique. Version 2.1." }, 
"description": { "type": ["string", "null"], "description": "Short description 
of the difficulty level (Base language: English). Translatable via 
public.translations. Version 2.1." }, "icon_identifier": { "type": ["string", 
"null"], "maxLength": 100, "description": "Optional identifier for an icon 
representing this difficulty level. Max 100 chars. Version 2.1." }, 
"sort_order": { "type": "integer", "default": 0, "description": "Optional 
integer for display order in UI lists/filters. Lower numbers display first. 
Default 0. Version 2.1." }, "is_active": { "type": "boolean", "default": true, 
"description": "Whether the difficulty level is active and available for 
assignment/display. Default true. Version 2.1." }, "created_at": { "type": 
"string", "format": "date-time", "readOnly": true, "description": "Timestamp of 
record creation. Read-only. Version 2.1." }, "created_by_profile_id": { "type": 
["string", "null"], "format": "uuid", "description": "Profile ID of the user 
who created this record. FK to public.profiles.id. Read-only. Version 2.1.", 
"readOnly": true }, "updated_at": { "type": "string", "format": "date-time", 
"readOnly": true, "description": "Timestamp of last update (auto-updated by 
trigger). Read-only. Version 2.1." }, "updated_by_profile_id": { "type": 
["string", "null"], "format": "uuid", "description": "Profile ID of the user 
who last updated this record. FK to public.profiles.id. Read-only. Version 
2.1.", "readOnly": true } }, "required": [ "code", "name", "sort_order", 
"is_active", "created_at", "updated_at" ], "primary_key": ["id"], 
"unique_constraints": [ {"columns": ["code"], "name": 
"trail_difficulty_levels_master_code_key"}, {"columns": ["name"], "name": 
"trail_difficulty_levels_master_name_key"} ] } ``` 6\. Relationships & 
Integrity - This is a parent table. - Referenced by 
`curated_itineraries.overall_difficulty_level_id` and potentially other tables 
like `routes` and `segments`. Referencing FKs should typically use `ON DELETE 
SET NULL` or `ON DELETE RESTRICT`. - Audit FKs to `public.profiles(id)`. 7\. 
Multilingual Strategy - `name` and `description` store base language (English) 
text. - Translations managed in `public.translations`, linked by 
`table_identifier = 'trail_difficulty_levels_master'`, `column_identifier = 
'name'` or `'description'`, and `row_foreign_key = 
trail_difficulty_levels_master.id::TEXT`. - An `AFTER DELETE` trigger handles 
orphan cleanup. 8\. Role-Based Workflow & RLS Notes - Workflow: `is_active` 
flag. Audit columns track changes. - RLS Policies: Admins have full CUD. 
Authenticated/Anonymous users have `SELECT` on active levels. 9\. ENUM vs 
Lookup Discussion - This table *is* the result of promoting a previous 
`trail_difficulty_enum` for better translatability, metadata (icons, sort 
order), and manageability. 10\. UI/UX Enablement - `name` (translated), 
`icon_identifier`, `sort_order` power UI filters and displays. `is_active` 
filters selection lists. 11\. Auditing & Lifecycle Management - Audit Columns: 
`created_at`, `updated_at`, `created_by_profile_id`, `updated_by_profile_id`. - 
Lifecycle: `is_active` flag. `ON DELETE RESTRICT` or `SET NULL` from 
referencing tables. 12\. Scalability & Future-Proofing - Small table, easily 
extensible. 13\. Seed Data - Initial seed data for `code`, `name` (base 
English), `description`, `icon_identifier`, `sort_order`, and audit FKs 
required. - Corresponding English `name` and `description` translations to be 
seeded into `public.translations`. (Example DDL includes seed data for the 
master table). 14\. Next-Action Checklist - 🔴 Implement DDL: Create 
`public.trail_difficulty_levels_master` with audit columns, indexes, and 
comments. - 🔴 Implement Audit Trigger: Apply 
`public.set_master_table_audit_meta` (or similar). - 🔴 Implement Orphaned 
Translation Cleanup Trigger. - 🔴 Populate Seed Data: Insert initial difficulty 
levels into this table and their English names/descriptions into 
`public.translations`. - 🟠 Implement RLS Policies. - 🟠 Verify FK constraints 
in referencing tables (e.g., `curated_itineraries`) point correctly. - 🟢 
Ensure Admin UI uses this table for difficulty level management and selection. 
* * * * * 
