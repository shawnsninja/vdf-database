# 7.0.3 - views

  https://gemini.google.com/u/1/app/42a77d08d7a45bcb Database Views 
Specification - Module 7: Curated Itinerary Module (V2.1) 1. Introduction This 
document outlines the specifications for database views created to support the 
"Curated Itinerary Module" (Module 7) of the Via di Francesco Pilgrimage 
Platform V2.1. Views are virtual tables whose contents are defined by a query. 
They are used to simplify complex queries, encapsulate logic, improve read 
performance for common data aggregations, and provide a stable interface for 
applications and APIs, even if underlying table structures change. Each view 
specification will include its name, purpose, DDL, key columns, and usage 
notes. 2. Module 7: Curated Itinerary Module Views These views are designed to 
support common API queries related to curated itineraries, providing localized 
and aggregated information. 2.1. View: 
public.v_curated_itineraries_list_localized Purpose : To provide a summarized, 
localized list of curated itineraries suitable for Browse, filtering, and 
display in list UIs. Each row represents an itinerary in a specific language, 
including key translated fields and references to related master data. DDL : 
SQL CREATE OR REPLACE VIEW public.v_curated_itineraries_list_localized AS 
SELECT ci.id AS itinerary_id, ci.slug AS itinerary_slug, 
ci.is_featured_itinerary, ci.total_walking_days_approx, 
ci.total_distance_km_approx, ci.content_status_id, -- For filtering by status 
ID cs_master.code AS content_status_code, -- For displaying status code 
tdl_master.code AS difficulty_level_code, -- For displaying difficulty code 
ci.banner_image_media_id, -- For fetching a thumbnail via media table -- 
Primarily translated fields for the list name_trans.language_code, COALESCE 
(name_trans.translated_text, ci.name) AS name, -- Fallback to base name 
COALESCE (short_desc_trans.translated_text, ci.short_description) AS 
short_description, -- Fallback to base short_description COALESCE 
(cs_name_trans.translated_text, cs_master_base.name) AS content_status_name, -- 
Translated status name COALESCE (tdl_name_trans.translated_text, 
tdl_master_base.name) AS difficulty_level_name, -- Translated difficulty name 
-- Aggregated category and season codes for filtering/display - names would 
require more complex joins/subqueries or API-level fetching ( SELECT array_agg 
(icm.category_code) FROM public.curated_itinerary_to_category citc JOIN 
public.itinerary_categories_master icm ON citc.category_id = icm.id WHERE 
citc.itinerary_id = ci.id AND icm.is_active = true ) AS category_codes, ( 
SELECT array_agg (sm.season_code) FROM public.curated_itinerary_to_season cits 
JOIN public.seasons_master sm ON cits.season_id = sm.id WHERE cits.itinerary_id 
= ci.id AND sm.is_active = true ) AS season_codes, ci.created_at AS 
itinerary_created_at, ci.updated_at AS itinerary_updated_at, ci.deleted_at AS 
itinerary_deleted_at -- For filtering out deleted items FROM 
public.curated_itineraries ci -- Join for Itinerary Name (drives the language 
for this view row) LEFT JOIN public.translations name_trans ON 
name_trans.table_identifier = 'curated_itineraries' AND 
name_trans.row_foreign_key = ci.id::TEXT AND name_trans.column_identifier = 
'name' AND name_trans.translation_status = 'published_live' -- Assuming this 
status -- Join for Itinerary Short Description LEFT JOIN public.translations 
short_desc_trans ON short_desc_trans.table_identifier = 'curated_itineraries' 
AND short_desc_trans.row_foreign_key = ci.id::TEXT AND 
short_desc_trans.column_identifier = 'short_description' AND 
short_desc_trans.language_code = name_trans.language_code -- Match language AND 
short_desc_trans.translation_status = 'published_live' -- Join for Content 
Status Master (to get base name and code) LEFT JOIN 
public.content_statuses_master cs_master ON ci.content_status_id = cs_master.id 
LEFT JOIN public.content_statuses_master cs_master_base ON ci.content_status_id 
= cs_master_base.id -- Separate alias for base name LEFT JOIN 
public.translations cs_name_trans ON cs_name_trans.table_identifier = 
'content_statuses_master' AND cs_name_trans.row_foreign_key = 
cs_master.id::TEXT AND cs_name_trans.column_identifier = 'name' -- Assuming 
'name' is the translatable field in content_statuses_master AND 
cs_name_trans.language_code = name_trans.language_code AND 
cs_name_trans.translation_status = 'published_live' -- Join for Trail 
Difficulty Levels Master (to get base name and code) LEFT JOIN 
public.trail_difficulty_levels_master tdl_master ON 
ci.overall_difficulty_level_id = tdl_master.id LEFT JOIN 
public.trail_difficulty_levels_master tdl_master_base ON 
ci.overall_difficulty_level_id = tdl_master_base.id -- Separate alias for base 
name LEFT JOIN public.translations tdl_name_trans ON 
tdl_name_trans.table_identifier = 'trail_difficulty_levels_master' AND 
tdl_name_trans.row_foreign_key = tdl_master.id::TEXT AND 
tdl_name_trans.column_identifier = 'name' -- Assuming 'name' is translatable in 
trail_difficulty_levels_master AND tdl_name_trans.language_code = 
name_trans.language_code AND tdl_name_trans.translation_status = 
'published_live' WHERE ci.deleted_at IS NULL ; -- Typically, RLS policies would 
further filter by content_status_id COMMENT ON VIEW 
public.v_curated_itineraries_list_localized IS 'Provides a summarized, 
localized list of curated itineraries with key identifying information, 
statistics, status, difficulty, and aggregated category/season codes. Version 
2.1.' ; COMMENT ON COLUMN public.v_curated_itineraries_list_localized.name IS 
'Localized name of the curated itinerary.' ; COMMENT ON COLUMN 
public.v_curated_itineraries_list_localized.short_description IS 'Localized 
short description of the curated itinerary.' ; COMMENT ON COLUMN 
public.v_curated_itineraries_list_localized.content_status_name IS 'Localized 
name of the content status.' ; COMMENT ON COLUMN 
public.v_curated_itineraries_list_localized.difficulty_level_name IS 'Localized 
name of the difficulty level.' ; COMMENT ON COLUMN 
public.v_curated_itineraries_list_localized.category_codes IS 'Array of 
category codes associated with the itinerary (from active categories).' ; 
COMMENT ON COLUMN public.v_curated_itineraries_list_localized.season_codes IS 
'Array of season codes associated with the itinerary (from active seasons).' ; 
Key Columns : itinerary_id : BIGINT - Unique ID of the itinerary. language_code 
: TEXT - Language code for the localized fields in this row. name : TEXT - 
Localized name of the itinerary. slug : TEXT - URL-friendly slug. 
short_description : TEXT - Localized short description. banner_image_media_id : 
UUID - ID of the banner media item (for thumbnail lookup). 
total_distance_km_approx : REAL - Approximate total distance. 
total_walking_days_approx : INTEGER - Approximate walking days. 
difficulty_level_code : TEXT - Code of the difficulty level. 
difficulty_level_name : TEXT - Localized name of the difficulty level. 
content_status_code : TEXT - Code of the content status. content_status_name : 
TEXT - Localized name of the content status. category_codes : TEXT[] - Array of 
category_code s from itinerary_categories_master . season_codes : TEXT[] - 
Array of season_code s from seasons_master . is_featured_itinerary : BOOLEAN - 
Flag if itinerary is featured. itinerary_deleted_at : TIMESTAMPTZ - For 
filtering soft-deleted items. Usage Notes : This view is intended for read-only 
operations. RLS policies on curated_itineraries , translations , and master 
tables will apply. API queries should filter by content_status_code = 
'PUBLISHED' (or equivalent) for public listings. Performance relies on good 
indexing on curated_itineraries (PK, content_status_id , 
overall_difficulty_level_id , deleted_at ), translations (composite index on 
table_identifier, column_identifier, row_foreign_key, language_code, 
translation_status ), and the master/junction tables used in subqueries. The 
language_code in the output is primarily driven by the translation of 
curated_itineraries.name . If a translation for the name doesn't exist for a 
requested language, that itinerary might not appear for that language via this 
view's logic, or a fallback mechanism using COALESCE with the base language 
from curated_itineraries itself is used. Fetching translated names for 
category_codes and season_codes within this list view (rather than just codes) 
would add significant complexity (e.g., more joins, array manipulations, or 
JSON functions); it's often more efficient for the API to fetch codes here and 
then fetch their translations separately if needed for filter UIs, or for the 
client to map codes to translated names from a pre-fetched list of all 
categories/seasons. 2.2. View: public.v_curated_itinerary_detail_localized 
Purpose : To provide a comprehensive, denormalized, and localized 
representation of a single curated itinerary's attributes. This includes its 
direct translatable fields, linked master data (difficulty, status with their 
translated names), primary media details (with translated alt text), and 
aggregated categories & seasons. DDL : SQL CREATE OR REPLACE VIEW 
public.v_curated_itinerary_detail_localized AS WITH localized_categories AS ( 
SELECT citc.itinerary_id, name_trans.language_code, jsonb_agg( DISTINCT 
jsonb_build_object( 'category_code' , icm.category_code, 'name' , COALESCE 
(cat_name_trans.translated_text, icm.name), -- Assuming icm.name is base lang 
'description' , COALESCE (cat_desc_trans.translated_text, icm.description), -- 
Assuming icm.description is base lang 'icon_identifier' , icm.icon_identifier ) 
ORDER BY icm.sort_order, icm.name) AS categories_jsonb FROM 
public.curated_itinerary_to_category citc JOIN 
public.itinerary_categories_master icm ON citc.category_id = icm.id AND 
icm.is_active = true JOIN public.translations name_trans -- This join 
determines the overall language context from itinerary name ON 
name_trans.table_identifier = 'curated_itineraries' AND 
name_trans.row_foreign_key = citc.itinerary_id::TEXT -- links to the itinerary 
ID AND name_trans.column_identifier = 'name' AND name_trans.translation_status 
= 'published_live' LEFT JOIN public.translations cat_name_trans ON 
cat_name_trans.table_identifier = 'itinerary_categories_master' AND 
cat_name_trans.row_foreign_key = icm.id::TEXT AND 
cat_name_trans.column_identifier = 'name' AND cat_name_trans.language_code = 
name_trans.language_code AND cat_name_trans.translation_status = 
'published_live' LEFT JOIN public.translations cat_desc_trans ON 
cat_desc_trans.table_identifier = 'itinerary_categories_master' AND 
cat_desc_trans.row_foreign_key = icm.id::TEXT AND 
cat_desc_trans.column_identifier = 'description' AND 
cat_desc_trans.language_code = name_trans.language_code AND 
cat_desc_trans.translation_status = 'published_live' GROUP BY 
citc.itinerary_id, name_trans.language_code ), localized_seasons AS ( SELECT 
cits.itinerary_id, name_trans.language_code, jsonb_agg( DISTINCT 
jsonb_build_object( 'season_code' , sm.season_code, 'name' , COALESCE 
(season_name_trans.translated_text, sm.name), -- Assuming sm.name is base lang 
'description' , COALESCE (season_desc_trans.translated_text, sm.description), 
-- Assuming sm.description is base lang 'icon_identifier' , sm.icon_identifier 
) ORDER BY sm.sort_order, sm.name) AS seasons_jsonb FROM 
public.curated_itinerary_to_season cits JOIN public.seasons_master sm ON 
cits.season_id = sm.id AND sm.is_active = true JOIN public.translations 
name_trans -- This join determines the overall language context from itinerary 
name ON name_trans.table_identifier = 'curated_itineraries' AND 
name_trans.row_foreign_key = cits.itinerary_id::TEXT -- links to the itinerary 
ID AND name_trans.column_identifier = 'name' AND name_trans.translation_status 
= 'published_live' LEFT JOIN public.translations season_name_trans ON 
season_name_trans.table_identifier = 'seasons_master' AND 
season_name_trans.row_foreign_key = sm.id::TEXT AND 
season_name_trans.column_identifier = 'name' AND 
season_name_trans.language_code = name_trans.language_code AND 
season_name_trans.translation_status = 'published_live' LEFT JOIN 
public.translations season_desc_trans ON season_desc_trans.table_identifier = 
'seasons_master' AND season_desc_trans.row_foreign_key = sm.id::TEXT AND 
season_desc_trans.column_identifier = 'description' AND 
season_desc_trans.language_code = name_trans.language_code AND 
season_desc_trans.translation_status = 'published_live' GROUP BY 
cits.itinerary_id, name_trans.language_code ) SELECT ci.id AS itinerary_id, 
ci.slug AS itinerary_slug, ci.itinerary_code, ci.primary_trail_id, -- Keep FKs 
for potential client-side linking or further API calls 
ci.based_on_primary_route_id, ci.total_walking_days_approx, 
ci.total_nights_approx, ci.total_distance_km_approx, 
ci.overall_difficulty_level_id, ci.start_waypoint_id_approx, 
ci.end_waypoint_id_approx, ci.content_status_id, ci.published_at, 
ci.is_featured_itinerary, ci.version_notes, 
ci.summary_stats_last_calculated_at, ci.data_last_verified_at, ci.created_at AS 
itinerary_created_at, ci.updated_at AS itinerary_updated_at, ci.deleted_at AS 
itinerary_deleted_at, creator_profile.public_display_name AS 
created_by_display_name, updater_profile.public_display_name AS 
updated_by_display_name, -- Language of this particular localized record 
name_trans.language_code, -- Translated Curated Itinerary Fields COALESCE 
(name_trans.translated_text, ci.name) AS name, COALESCE 
(short_desc_trans.translated_text, ci.short_description) AS short_description, 
COALESCE (long_desc_trans.translated_text, ci.long_description) AS 
long_description, COALESCE (theme_focus_trans.translated_text, 
ci.theme_or_focus) AS theme_or_focus, COALESCE 
(suitability_notes_trans.translated_text, ci.suitability_notes) AS 
suitability_notes, COALESCE (start_loc_trans.translated_text, 
ci.primary_start_location_text) AS primary_start_location_text, COALESCE 
(end_loc_trans.translated_text, ci.primary_end_location_text) AS 
primary_end_location_text, -- Difficulty Level Details (Localized) 
tdl_master.code AS difficulty_level_code, COALESCE 
(tdl_name_trans.translated_text, tdl_master_base.name) AS 
difficulty_level_name, COALESCE (tdl_desc_trans.translated_text, 
tdl_master_base.description) AS difficulty_level_description, 
tdl_master.icon_identifier AS difficulty_level_icon, -- Content Status Details 
(Localized) cs_master.code AS content_status_code, COALESCE 
(cs_name_trans.translated_text, cs_master_base.name) AS content_status_name, 
COALESCE (cs_desc_trans.translated_text, cs_master_base.description) AS 
content_status_description, -- Banner Image Details (Localized Alt Text) 
banner_media.id AS banner_media_id, banner_media.storage_object_path_original 
AS banner_media_original_url, banner_media.image_variants_json AS 
banner_media_variants, COALESCE (banner_alt_trans.translated_text, 
banner_media.default_alt_text) AS banner_media_alt_text, -- Assuming 
default_alt_text in media table -- Map Overview Image Details (Localized Alt 
Text) map_media.id AS map_overview_media_id, 
map_media.storage_object_path_original AS map_overview_media_original_url, 
map_media.image_variants_json AS map_overview_media_variants, COALESCE 
(map_alt_trans.translated_text, map_media.default_alt_text) AS 
map_overview_media_alt_text, -- Aggregated Categories (Localized) 
lc.categories_jsonb, -- Aggregated Seasons (Localized) ls.seasons_jsonb FROM 
public.curated_itineraries ci -- Profile Joins LEFT JOIN public.profiles 
creator_profile ON ci.created_by_profile_id = creator_profile.id LEFT JOIN 
public.profiles updater_profile ON ci.updated_by_profile_id = 
updater_profile.id -- Join for Itinerary Name (drives the language for this 
view row) INNER JOIN public.translations name_trans ON 
name_trans.table_identifier = 'curated_itineraries' AND 
name_trans.row_foreign_key = ci.id::TEXT AND name_trans.column_identifier = 
'name' AND name_trans.translation_status = 'published_live' -- Assuming this 
status -- Left Joins for other translatable fields of the itinerary entity 
itself LEFT JOIN public.translations short_desc_trans ON 
short_desc_trans.table_identifier = 'curated_itineraries' AND 
short_desc_trans.row_foreign_key = ci.id::TEXT AND 
short_desc_trans.column_identifier = 'short_description' AND 
short_desc_trans.language_code = name_trans.language_code AND 
short_desc_trans.translation_status = 'published_live' LEFT JOIN 
public.translations long_desc_trans ON long_desc_trans.table_identifier = 
'curated_itineraries' AND long_desc_trans.row_foreign_key = ci.id::TEXT AND 
long_desc_trans.column_identifier = 'long_description' AND 
long_desc_trans.language_code = name_trans.language_code AND 
long_desc_trans.translation_status = 'published_live' LEFT JOIN 
public.translations theme_focus_trans ON theme_focus_trans.table_identifier = 
'curated_itineraries' AND theme_focus_trans.row_foreign_key = ci.id::TEXT AND 
theme_focus_trans.column_identifier = 'theme_or_focus' AND 
theme_focus_trans.language_code = name_trans.language_code AND 
theme_focus_trans.translation_status = 'published_live' LEFT JOIN 
public.translations suitability_notes_trans ON 
suitability_notes_trans.table_identifier = 'curated_itineraries' AND 
suitability_notes_trans.row_foreign_key = ci.id::TEXT AND 
suitability_notes_trans.column_identifier = 'suitability_notes' AND 
suitability_notes_trans.language_code = name_trans.language_code AND 
suitability_notes_trans.translation_status = 'published_live' LEFT JOIN 
public.translations start_loc_trans ON start_loc_trans.table_identifier = 
'curated_itineraries' AND start_loc_trans.row_foreign_key = ci.id::TEXT AND 
start_loc_trans.column_identifier = 'primary_start_location_text' AND 
start_loc_trans.language_code = name_trans.language_code AND 
start_loc_trans.translation_status = 'published_live' LEFT JOIN 
public.translations end_loc_trans ON end_loc_trans.table_identifier = 
'curated_itineraries' AND end_loc_trans.row_foreign_key = ci.id::TEXT AND 
end_loc_trans.column_identifier = 'primary_end_location_text' AND 
end_loc_trans.language_code = name_trans.language_code AND 
end_loc_trans.translation_status = 'published_live' -- Join for Difficulty 
Level Master and its translations LEFT JOIN 
public.trail_difficulty_levels_master tdl_master ON 
ci.overall_difficulty_level_id = tdl_master.id LEFT JOIN 
public.trail_difficulty_levels_master tdl_master_base ON 
ci.overall_difficulty_level_id = tdl_master_base.id LEFT JOIN 
public.translations tdl_name_trans ON tdl_name_trans.table_identifier = 
'trail_difficulty_levels_master' AND tdl_name_trans.row_foreign_key = 
tdl_master.id::TEXT AND tdl_name_trans.column_identifier = 'name' AND 
tdl_name_trans.language_code = name_trans.language_code AND 
tdl_name_trans.translation_status = 'published_live' LEFT JOIN 
public.translations tdl_desc_trans ON tdl_desc_trans.table_identifier = 
'trail_difficulty_levels_master' AND tdl_desc_trans.row_foreign_key = 
tdl_master.id::TEXT AND tdl_desc_trans.column_identifier = 'description' AND 
tdl_desc_trans.language_code = name_trans.language_code AND 
tdl_desc_trans.translation_status = 'published_live' -- Join for Content Status 
Master and its translations LEFT JOIN public.content_statuses_master cs_master 
ON ci.content_status_id = cs_master.id LEFT JOIN public.content_statuses_master 
cs_master_base ON ci.content_status_id = cs_master_base.id LEFT JOIN 
public.translations cs_name_trans ON cs_name_trans.table_identifier = 
'content_statuses_master' AND cs_name_trans.row_foreign_key = 
cs_master.id::TEXT AND cs_name_trans.column_identifier = 'name' AND 
cs_name_trans.language_code = name_trans.language_code AND 
cs_name_trans.translation_status = 'published_live' LEFT JOIN 
public.translations cs_desc_trans ON cs_desc_trans.table_identifier = 
'content_statuses_master' AND cs_desc_trans.row_foreign_key = 
cs_master.id::TEXT AND cs_desc_trans.column_identifier = 'description' AND 
cs_desc_trans.language_code = name_trans.language_code AND 
cs_desc_trans.translation_status = 'published_live' -- Join for Banner Media 
and its alt text translation LEFT JOIN public.media banner_media ON 
ci.banner_image_media_id = banner_media.id LEFT JOIN public.translations 
banner_alt_trans ON banner_alt_trans.table_identifier = 'media' AND 
banner_alt_trans.row_foreign_key = banner_media.id::TEXT AND 
banner_alt_trans.column_identifier = 'default_alt_text' AND 
banner_alt_trans.language_code = name_trans.language_code AND 
banner_alt_trans.translation_status = 'published_live' -- Join for Map Overview 
Media and its alt text translation LEFT JOIN public.media map_media ON 
ci.map_overview_image_media_id = map_media.id LEFT JOIN public.translations 
map_alt_trans ON map_alt_trans.table_identifier = 'media' AND 
map_alt_trans.row_foreign_key = map_media.id::TEXT AND 
map_alt_trans.column_identifier = 'default_alt_text' AND 
map_alt_trans.language_code = name_trans.language_code AND 
map_alt_trans.translation_status = 'published_live' -- Join CTEs for aggregated 
categories and seasons LEFT JOIN localized_categories lc ON ci.id = 
lc.itinerary_id AND name_trans.language_code = lc.language_code LEFT JOIN 
localized_seasons ls ON ci.id = ls.itinerary_id AND name_trans.language_code = 
ls.language_code WHERE ci.deleted_at IS NULL ; COMMENT ON VIEW 
public.v_curated_itinerary_detail_localized IS 'Provides comprehensive, 
denormalized, and localized details for a single curated itinerary, including 
direct attributes, linked master data (difficulty, status), primary media, and 
aggregated categories/seasons. Each row represents an itinerary in a specific 
language. Segments are fetched separately. Version 2.1.' ; Key Columns 
(Abridged) : itinerary_id : BIGINT - Unique ID of the itinerary. language_code 
: TEXT - Language code for the localized fields. name : TEXT - Localized name. 
slug : TEXT. long_description : TEXT - Localized long description. 
difficulty_level_name : TEXT - Localized difficulty name. content_status_name : 
TEXT - Localized status name. banner_media_variants : JSONB - Variants for 
banner image. banner_media_alt_text : TEXT - Localized alt text for banner. 
map_overview_media_variants : JSONB - Variants for map image. 
map_overview_media_alt_text : TEXT - Localized alt text for map. 
categories_jsonb : JSONB - Array of localized category objects {category_code, 
name, description, icon_identifier} . seasons_jsonb : JSONB - Array of 
localized season objects {season_code, name, description, icon_identifier} . 
Plus all other relevant fields from curated_itineraries and linked master 
tables. Example Usage : SQL SELECT itinerary_id, name, -- Localized name 
long_description, -- Localized description difficulty_level_name, -- Localized 
categories_jsonb, seasons_jsonb, banner_media_variants ->> 'display_l_jpeg' AS 
banner_url FROM public.v_curated_itinerary_detail_localized WHERE itinerary_id 
= 123 AND language_code = 'it' AND content_status_code = 'PUBLISHED' ; -- 
Further filtered by API or RLS Underlying Tables & Key Joins : 
curated_itineraries (Primary) public.translations (Multiple LEFT JOINs for 
itinerary fields, master data fields, media alt text; INNER JOIN for primary 
itinerary name). trail_difficulty_levels_master , content_statuses_master , 
itinerary_categories_master (via CTE), seasons_master (via CTE). public.media 
(for banner, map images). public.profiles (for creator/updater display names). 
RLS (Row-Level Security) Considerations : View should be defined with SECURITY 
INVOKER (default). RLS policies on underlying tables ( curated_itineraries , 
translations , media , etc.) will apply. API queries should additionally filter 
by content_status_code = 'PUBLISHED' for public access, or rely on RLS on 
curated_itineraries which should already incorporate this. Performance & 
Optimization Notes : Indexing on public.translations (composite index on 
table_identifier, column_identifier, row_foreign_key, language_code, 
translation_status ) is critical. Indexes on all FKs and commonly filtered 
fields in curated_itineraries and master tables are essential. The CTEs for 
categories and seasons aim to pre-aggregate data to avoid excessive joins in 
the final select. Performance should be tested. Consider materializing this 
view if read performance for frequently accessed, complex itinerary details 
becomes a bottleneck. Assumptions & Dependencies : Assumes the structure of 
public.translations , public.media (with default_alt_text , image_variants_json 
), and master tables. Assumes translation_status = 'published_live' for 
production-ready translations. Translatable fields in master tables like 
itinerary_categories_master.name are indeed translated via the translations 
table. The COALESCE pattern provides a fallback to the base language content 
stored directly in curated_itineraries or master tables if a translation is not 
found for the requested language_code . Next-Action Checklist : 🔴 Finalize all 
translatable field identifiers for curated_itineraries , media , and all 
involved master tables used in translations . 🟠 Implement and thoroughly test 
the DDL for v_curated_itineraries_list_localized and 
v_curated_itinerary_detail_localized . 🟠 Test query performance extensively, 
especially for v_curated_itinerary_detail_localized due to its complexity. 🟢 
Optimize underlying table indexes based on view query plans. 🟢 Document these 
views for API developers, including output columns, query patterns, and how 
related data (like segments) should be fetched. This provides a starting point 
for creating production-ready views for Module 7. The exact implementation of 
JSON aggregation and CTEs might need adjustments based on your PostgreSQL 
version and specific performance characteristics. 
