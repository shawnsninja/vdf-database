# 4.2 Accommodations

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/34bd37922031b95a 
https://gemini.google.com/u/1/app/21b8e85b3e611787 * * * * * ### 3\. Updated 
Production-Ready Specification 4.2 Accommodations Table Module (Version 1.5) 
--------------------------------------------- This document details the 
structure, purpose, and considerations for the `accommodations` table, which 
stores specifics for lodging options. Version 1.5 updates the RLS policies to 
align with the platform-wide security and authentication strategy using the 
`public.has_role()` helper function. ### 1\. Purpose & Primary Use-Cases The 
`accommodations` table stores detailed, specific information about lodging 
options available to pilgrims, extending the generic `waypoints` entry for an 
accommodation. Its purpose is to provide structured, filterable data on 
accommodation types, contact details, booking information, operational details 
(check-in/out), pricing notes, and specific pilgrim-related services or 
considerations. Key user-story touchpoints: - Pilgrim: Finding suitable lodging 
by type, availability (including seasonal), and key features. (Story A3) - 
Pilgrim: Accessing contact information, booking links, and notes for securing 
accommodation. (Story A3) - Pilgrim: Understanding check-in/out times, seasonal 
availability, and potential pilgrim-specific offers. (Story A3, B2) - 
Accommodation Host: Managing their listing's core details, contact information, 
booking status, and seasonal availability. (Story B1, B2) - Admin/Content 
Manager: Reviewing and ensuring accuracy of accommodation listings, including 
managing their lifecycle via the parent waypoint. ### 2\. Schema (Markdown 
Table) *(No change to column structure from Version 1.4)* | column | data_type 
| constraints | description | | waypoint_id | `bigint` | Primary Key, Foreign 
Key to `waypoints(id)` ON DELETE CASCADE | Links to the generic `waypoints` 
table. This is the PK. Matches `waypoints.id` type. | | accommodation_type_id | 
`integer` | Not Null, Foreign Key to `accommodation_types_master(id)` ON DELETE 
RESTRICT | The primary type of accommodation, linking to a master table. | | 
host_profile_id | `uuid` | Nullable, Foreign Key to `profiles(id)` ON DELETE 
SET NULL | Links this accommodation to a specific host's profile, useful for 
RLS and management. | | host_name_or_organization | `text` | Nullable, CHECK 
(`host_name_or_organization` IS NULL OR length(`host_name_or_organization`) 
&lt;= 255) | Name of the host, family, or organization running the 
accommodation. Primary reference language (English) text. Translatable. | | 
contact_person | `text` | Nullable, CHECK (`contact_person` IS NULL OR 
length(`contact_person`) &lt;= 150) | Name of the primary contact person for 
bookings or inquiries. Primary reference language (English) text. Translatable. 
| | phone_number | `text` | Nullable, CHECK (`phone_number` IS NULL OR 
length(`phone_number`) &lt;= 50) | Primary contact phone number. Consider E.164 
format validation at app level. | | whatsapp_number | `text` | Nullable, CHECK 
(`whatsapp_number` IS NULL OR length(`whatsapp_number`) &lt;= 50) | WhatsApp 
contact number, if available. Consider E.164 format validation. | | 
email_address | `text` | Nullable, CHECK (`email_address` IS NULL OR 
(length(`email_address`) &lt;= 254 AND `email_address` ~* 
'^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+.[A-Za-z]{2,}$')) | Primary contact email 
address. Basic email format check. | | website_url | `text` | Nullable, CHECK 
(`website_url` IS NULL OR (length(`website_url`) &lt;= 2048 AND `website_url` 
~* '^https?://.+')) | Official website URL for the accommodation. Basic URL 
format check. | | booking_url_primary | `text` | Nullable, CHECK 
(`booking_url_primary` IS NULL OR (length(`booking_url_primary`) &lt;= 2048 AND 
`booking_url_primary` ~* '^https?://.+')) | Direct link to a primary booking 
platform or their own booking page. Basic URL format check. | | 
booking_url_secondary | `text` | Nullable, CHECK (`booking_url_secondary` IS 
NULL OR (length(`booking_url_secondary`) &lt;= 2048 AND `booking_url_secondary` 
~* '^https?://.+')) | Optional secondary booking link. Basic URL format check. 
| | booking_notes | `text` | Nullable | Specific instructions about the booking 
process. Primary reference language (English) text. Translatable. | | 
booking_availability_status_id | `integer` | Nullable, Foreign Key to 
`booking_statuses_master(id)` ON DELETE SET NULL, Default (SELECT id FROM 
`public.booking_statuses_master` WHERE code = 'unknown' LIMIT 1) | Current 
booking availability status, linking to a master table. | | 
booking_status_last_updated_by_host | `timestamp with time zone` | Nullable | 
Timestamp of the last known update to `booking_availability_status_id` by the 
host. | | check_in_time_start | `time without time zone` | Nullable | Usual 
earliest check-in time (e.g., "14:00"). | | check_in_time_end | `time without 
time zone` | Nullable | Usual latest check-in time (e.g., "20:00"). | | 
check_out_time_latest | `time without time zone` | Nullable | Usual latest 
check-out time (e.g., "10:00"). | | check_in_out_notes | `text` | Nullable | 
Specific notes about check-in/out procedures or flexibility. Primary reference 
language (English) text. Translatable. | | price_summary_notes | `text` | 
Nullable | General notes about pricing. Detailed pricing via 
`accommodation_room_configurations`. Primary reference language (English) text. 
Translatable. | | display_currency_code | `char(3)` | Not Null, Default 'EUR', 
CHECK (length(`display_currency_code`) = 3 AND `display_currency_code` = 
upper(`display_currency_code`)) | Primary currency code for display purposes 
(e.g., "EUR"). | | pilgrim_special_offer_exists | `boolean` | Not Null, Default 
false | Is there any special offer, discount, or service for pilgrims with 
credentials? | | pilgrim_special_offer_details | `text` | Nullable | 
Description of the pilgrim special offer. Primary reference language (English) 
text. Translatable. | | meal_service_summary_notes | `text` | Nullable | 
General notes about meals. Specifics via `accommodation_meal_services`. Primary 
reference language (English) text. Translatable. | | laundry_summary_notes | 
`text` | Nullable | General notes about laundry. Specifics via 
`accommodation_amenities`. Primary reference language (English) text. 
Translatable. | | luggage_transfer_offered | `boolean` | Not Null, Default 
false | Does the accommodation directly offer or facilitate luggage transfer 
services? | | luggage_transfer_notes | `text` | Nullable | Notes about luggage 
transfer services. Primary reference language (English) text. Translatable. | | 
bicycle_storage_notes | `text` | Nullable | Notes about bicycle storage. 
Amenity can also flag this. Primary reference language (English) text. 
Translatable. | | pet_policy_notes | `text` | Nullable | Detailed policy on 
pets. Amenity can also flag this. Primary reference language (English) text. 
Translatable. | | is_suitable_for_groups | `boolean` | Not Null, Default false 
| Is this accommodation generally suitable for hosting groups? | | 
group_suitability_notes | `text` | Nullable | Notes regarding group bookings, 
capacity, facilities for groups, or discounts. Primary reference language 
(English) text. Translatable. | | max_group_size_accepted | `integer` | 
Nullable, CHECK (`max_group_size_accepted` IS NULL OR `max_group_size_accepted` 
> 0) | Approximate maximum group size the accommodation can comfortably host. | 
| pilgrim_specific_guidance_notes | `text` | Nullable | Other important notes, 
rules, or guidance specifically for pilgrims. Primary reference language 
(English) text. Translatable. | | opening_months | `integer[]` | Nullable, 
CHECK (`opening_months` IS NULL OR (array_length(`opening_months`, 1) > 0 AND 
`public.are_valid_months`(`opening_months`))) | Array of month numbers [1-12] 
when typically open. Validated by `are_valid_months` function for range and 
uniqueness. | | opening_season_details_notes | `text` | Nullable | Textual 
notes for specific opening dates, exceptions, "by reservation only" periods. 
Primary reference language (English) text. Translatable. | | 
is_part_of_official_network | `boolean` | Not Null, Default false | Is this 
accommodation part of an official pilgrim hospitality network? | | 
official_network_name | `text` | Nullable, CHECK (`official_network_name` IS 
NULL OR length(`official_network_name`) &lt;= 150) | Name of the official 
network, if applicable. Primary reference language (English) text. 
Translatable. | | maps_place_id | `text` | Nullable, Unique, CHECK 
(`maps_place_id` IS NULL OR length(`maps_place_id`) &lt;= 255) | Google Maps 
Place ID for this specific accommodation. | | maps_url | `text` | Nullable, 
CHECK (`maps_url` IS NULL OR (length(`maps_url`) &lt;= 2048 AND `maps_url` ~* 
'^https?://.+')) | Direct link to the Google Maps listing. Basic URL format 
check. | | data_last_verified_at | `timestamp with time zone` | Nullable | 
Timestamp indicating when these details were last verified. | | created_at | 
`timestamp with time zone` | Not Null, Default `now()` | Timestamp of record 
creation. | | created_by_profile_id | `uuid` | Nullable, Foreign Key to 
`profiles(id)` ON DELETE SET NULL | Profile ID of the user who created this 
accommodation record. | | updated_at | `timestamp with time zone` | Not Null, 
Default `now()` | Timestamp of last update (auto-updated by trigger). | | 
updated_by_profile_id | `uuid` | Nullable, Foreign Key to `profiles(id)` ON 
DELETE SET NULL | Profile ID of the user who last updated this accommodation 
record. | ### 3\. PostgreSQL DDL *(DDL for table structure, comments, triggers, 
and indexes remain the same as Version 1.4, including the GIN index on 
`opening_months`. Only the version in the table comment changes.)* SQL ``` -- 
Assumes master tables (accommodation_types_master, booking_statuses_master), -- 
waypoints, profiles tables are already defined. -- Assumes 
public.set_current_timestamp_updated_at() and 
public.are_valid_months(INTEGER[]) functions exist. -- Assumes 
public.cleanup_related_translations(TEXT, TEXT) function and specific per-table 
wrapper exist. CREATE TABLE public.accommodations ( waypoint_id BIGINT PRIMARY 
KEY, accommodation_type_id INTEGER NOT NULL, host_profile_id UUID NULL, 
host_name_or_organization TEXT NULL CHECK (host_name_or_organization IS NULL OR 
length(host_name_or_organization) <= 255), contact_person TEXT NULL CHECK 
(contact_person IS NULL OR length(contact_person) <= 150), phone_number TEXT 
NULL CHECK (phone_number IS NULL OR length(phone_number) <= 50), 
whatsapp_number TEXT NULL CHECK (whatsapp_number IS NULL OR 
length(whatsapp_number) <= 50), email_address TEXT NULL CHECK (email_address IS 
NULL OR (length(email_address) <= 254 AND email_address ~* 
'^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')), website_url TEXT NULL 
CHECK (website_url IS NULL OR (length(website_url) <= 2048 AND website_url ~* 
'^https?://.+')), booking_url_primary TEXT NULL CHECK (booking_url_primary IS 
NULL OR (length(booking_url_primary) <= 2048 AND booking_url_primary ~* 
'^https?://.+')), booking_url_secondary TEXT NULL CHECK (booking_url_secondary 
IS NULL OR (length(booking_url_secondary) <= 2048 AND booking_url_secondary ~* 
'^https?://.+')), booking_notes TEXT NULL, booking_availability_status_id 
INTEGER NULL DEFAULT (SELECT id FROM public.booking_statuses_master WHERE code 
= 'unknown' LIMIT 1), booking_status_last_updated_by_host TIMESTAMPTZ NULL, 
check_in_time_start TIME WITHOUT TIME ZONE NULL, check_in_time_end TIME WITHOUT 
TIME ZONE NULL, check_out_time_latest TIME WITHOUT TIME ZONE NULL, 
check_in_out_notes TEXT NULL, price_summary_notes TEXT NULL, 
display_currency_code CHAR(3) NOT NULL DEFAULT 'EUR' CHECK 
(length(display_currency_code) = 3 AND display_currency_code = 
upper(display_currency_code)), pilgrim_special_offer_exists BOOLEAN NOT NULL 
DEFAULT FALSE, pilgrim_special_offer_details TEXT NULL, 
meal_service_summary_notes TEXT NULL, laundry_summary_notes TEXT NULL, 
luggage_transfer_offered BOOLEAN NOT NULL DEFAULT FALSE, luggage_transfer_notes 
TEXT NULL, bicycle_storage_notes TEXT NULL, pet_policy_notes TEXT NULL, 
is_suitable_for_groups BOOLEAN NOT NULL DEFAULT FALSE, group_suitability_notes 
TEXT NULL, max_group_size_accepted INTEGER NULL CHECK (max_group_size_accepted 
IS NULL OR max_group_size_accepted > 0), pilgrim_specific_guidance_notes TEXT 
NULL, opening_months INTEGER[] NULL CHECK (opening_months IS NULL OR 
(array_length(opening_months, 1) > 0 AND 
public.are_valid_months(opening_months))), opening_season_details_notes TEXT 
NULL, is_part_of_official_network BOOLEAN NOT NULL DEFAULT FALSE, 
official_network_name TEXT NULL CHECK (official_network_name IS NULL OR 
length(official_network_name) <= 150), maps_place_id TEXT NULL UNIQUE CHECK 
(maps_place_id IS NULL OR length(maps_place_id) <= 255), maps_url TEXT NULL 
CHECK (maps_url IS NULL OR (length(maps_url) <= 2048 AND maps_url ~* 
'^https?://.+')), data_last_verified_at TIMESTAMPTZ NULL, created_at 
TIMESTAMPTZ NOT NULL DEFAULT now(), created_by_profile_id UUID NULL, updated_at 
TIMESTAMPTZ NOT NULL DEFAULT now(), updated_by_profile_id UUID NULL, CONSTRAINT 
fk_waypoint FOREIGN KEY(waypoint_id) REFERENCES public.waypoints(id) ON DELETE 
CASCADE, CONSTRAINT fk_accommodation_type FOREIGN KEY(accommodation_type_id) 
REFERENCES public.accommodation_types_master(id) ON DELETE RESTRICT, CONSTRAINT 
fk_host_profile FOREIGN KEY(host_profile_id) REFERENCES public.profiles(id) ON 
DELETE SET NULL, CONSTRAINT fk_booking_availability_status FOREIGN 
KEY(booking_availability_status_id) REFERENCES 
public.booking_statuses_master(id) ON DELETE SET NULL, CONSTRAINT 
fk_created_by_profile FOREIGN KEY(created_by_profile_id) REFERENCES 
public.profiles(id) ON DELETE SET NULL, CONSTRAINT fk_updated_by_profile 
FOREIGN KEY(updated_by_profile_id) REFERENCES public.profiles(id) ON DELETE SET 
NULL ); COMMENT ON TABLE public.accommodations IS 'Detailed information for 
lodging options, extending the generic waypoints table. Version 1.5'; -- Column 
comments from Version 1.4 remain valid. -- Trigger for updated_at CREATE 
TRIGGER trigger_accommodations_set_updated_at BEFORE UPDATE ON 
public.accommodations FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); COMMENT ON TRIGGER 
trigger_accommodations_set_updated_at ON public.accommodations IS 'Trigger to 
automatically update updated_at timestamp on row modification.'; -- Trigger for 
orphan translation cleanup CREATE OR REPLACE FUNCTION 
public.cleanup_accommodations_translations() RETURNS TRIGGER AS $$ BEGIN IF 
TG_OP = 'DELETE' THEN DELETE FROM public.translations WHERE table_identifier = 
'accommodations' AND row_foreign_key = OLD.waypoint_id::TEXT; END IF; RETURN 
OLD; END; $$ LANGUAGE plpgsql SECURITY DEFINER; CREATE TRIGGER 
trigger_cleanup_accommodations_translations AFTER DELETE ON 
public.accommodations FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_accommodations_translations(); COMMENT ON TRIGGER 
trigger_cleanup_accommodations_translations ON public.accommodations IS 'Cleans 
up orphaned translations from public.translations when an accommodations record 
is deleted.'; -- Indexes (including GIN index from previous update) CREATE 
INDEX idx_accommodations_host_profile_id ON 
public.accommodations(host_profile_id) WHERE host_profile_id IS NOT NULL; 
CREATE INDEX idx_accommodations_accommodation_type_id ON 
public.accommodations(accommodation_type_id); CREATE INDEX 
idx_accommodations_booking_availability_status_id ON 
public.accommodations(booking_availability_status_id) WHERE 
booking_availability_status_id IS NOT NULL; CREATE INDEX IF NOT EXISTS 
idx_accommodations_opening_months ON public.accommodations USING GIN 
(opening_months); -- VIEW for accommodation capacity (remains as defined in 
Version 1.4) CREATE OR REPLACE VIEW public.accommodations_capacity_summary_view 
AS SELECT acc.waypoint_id, COALESCE(SUM(arc.count_of_this_room_type * 
rtm.typical_capacity_persons), 0) AS calculated_total_beds, 
COALESCE(SUM(arc.count_of_this_room_type), 0) AS calculated_total_rooms FROM 
public.accommodations acc LEFT JOIN public.accommodation_room_configurations 
arc ON acc.waypoint_id = arc.accommodation_waypoint_id LEFT JOIN 
public.room_types_master rtm ON arc.room_type_id = rtm.id GROUP BY 
acc.waypoint_id; COMMENT ON VIEW public.accommodations_capacity_summary_view IS 
'Provides calculated total beds and total rooms for each accommodation based on 
its room configurations. Join with accommodations or waypoints on 
waypoint_id.'; ``` ### 4\. JSON Schema Mirror *(No change from Version 1.4)* 
JSON ``` { "title": "accommodation_detail", "description": "Detailed 
information for lodging options, extending the generic waypoints table. Version 
1.5", "type": "object", "properties": { /* ... all properties as in Version 1.4 
... */ }, "required": [ /* ... as in Version 1.4 ... */ ] } ``` ### 5\. 
Relationships & Integrity *(No change from Version 1.4)* - Primary Key: 
`waypoint_id` (BIGINT) - Foreign Keys: As defined in V1.4. - URL Validation: 
`CHECK` constraints with regex for URL fields. - Capacity Summary: Via 
`public.accommodations_capacity_summary_view`. ### 6\. Multilingual Strategy 
*(No change from Version 1.4)* - Translatable Fields: 
`host_name_or_organization`, `contact_person`, `booking_notes`, 
`check_in_out_notes`, etc. - Translation Management: `AFTER DELETE` trigger 
`trigger_cleanup_accommodations_translations`. ### 7\. Role-Based Workflow & 
RLS Notes *(This section is updated to reflect the new auth strategy)* - Key 
Fields for Workflow: - `host_profile_id`: Crucial for allowing hosts to manage 
their own listings. - `booking_availability_status_id`, 
`booking_status_last_updated_by_host`: Allow hosts to update their 
availability. - `data_last_verified_at`: For content managers to track data 
freshness. - `created_by_profile_id`, `updated_by_profile_id`: For auditing. - 
The linked `waypoints.content_visibility_status_id` (via 
`accommodations.waypoint_id`) controls overall publication. - Recommended 
Row-Level Security (RLS) Policies (Assumes `public.has_role(TEXT)` helper 
function exists): - Public Users (Read Only Published): SQL ``` -- Name: Allow 
public read access to published accommodations -- Target: accommodations -- 
Operation: SELECT -- Role(s): anon, authenticated CREATE POLICY "Allow public 
read access to published accommodations" ON public.accommodations FOR SELECT 
USING ( EXISTS ( SELECT 1 FROM public.waypoints w WHERE w.id = 
accommodations.waypoint_id AND w.deleted_at IS NULL AND 
w.content_visibility_status_id = (SELECT id FROM public.content_statuses_master 
WHERE code = 'published' LIMIT 1) ) ); ``` - Accommodation Hosts (Role: 
`host`): - Viewing Own Listings: SQL ``` -- Name: Hosts can view their own 
accommodation records -- Target: accommodations -- Operation: SELECT -- 
Role(s): authenticated CREATE POLICY "Hosts can view their own accommodation 
records" ON public.accommodations FOR SELECT USING ( auth.role() = 
'authenticated' AND host_profile_id = auth.uid() ); ``` - Updating Own 
Listings: SQL ``` -- Name: Hosts can update their own accommodation records -- 
Target: accommodations -- Operation: UPDATE -- Role(s): authenticated CREATE 
POLICY "Hosts can update their own accommodation records" ON 
public.accommodations FOR UPDATE USING ( auth.role() = 'authenticated' AND 
host_profile_id = auth.uid() ) WITH CHECK ( auth.role() = 'authenticated' AND 
host_profile_id = auth.uid() AND waypoint_id IS NOT DISTINCT FROM 
OLD.waypoint_id ); ``` - Content Managers/Admins (Broader Access): - Viewing 
All: SQL ``` -- Name: Platform content team can view all accommodation records 
-- Target: accommodations -- Operation: SELECT -- Role(s): 
regional_content_manager, admin_platform CREATE POLICY "Platform content team 
can view all accommodation records" ON public.accommodations FOR SELECT USING ( 
auth.role() = 'authenticated' AND (public.has_role('regional_content_manager') 
OR public.has_role('admin_platform')) ); ``` - Updating Any: SQL ``` -- Name: 
Platform content team can update any accommodation records -- Target: 
accommodations -- Operation: UPDATE -- Role(s): regional_content_manager, 
admin_platform CREATE POLICY "Platform content team can update any 
accommodation records" ON public.accommodations FOR UPDATE USING ( auth.role() 
= 'authenticated' AND (public.has_role('regional_content_manager') OR 
public.has_role('admin_platform')) ) WITH CHECK ( auth.role() = 'authenticated' 
AND (public.has_role('regional_content_manager') OR 
public.has_role('admin_platform')) ); ``` - Inserting New (Admin/Manager 
Workflow): SQL ``` -- Name: Platform content team can insert accommodation 
records -- Target: accommodations -- Operation: INSERT -- Role(s): 
regional_content_manager, admin_platform CREATE POLICY "Platform content team 
can insert accommodation records" ON public.accommodations FOR INSERT WITH 
CHECK ( auth.role() = 'authenticated' AND 
(public.has_role('regional_content_manager') OR 
public.has_role('admin_platform')) AND created_by_profile_id = auth.uid() AND 
EXISTS ( SELECT 1 FROM public.waypoints w JOIN 
public.waypoint_categories_master wcm ON w.waypoint_primary_category_id = 
wcm.id WHERE w.id = waypoint_id AND wcm.code = 'accommodation_location' ) ); 
``` - Enable RLS: SQL ``` ALTER TABLE public.accommodations ENABLE ROW LEVEL 
SECURITY; ``` ### 8\. ENUM vs Lookup Discussion *(No change from Version 1.4)* 
- Relies on `accommodation_types_master` and `booking_statuses_master`. ### 9\. 
UI/UX Enablement *(No change from Version 1.4)* - Columns and their UI/UX 
implications remain as detailed. ### 10\. Key Considerations & Definitions *(No 
change from Version 1.4)* - Data Integrity: Relationship with `waypoints` 
(category 'accommodation_location') enforced by RLS. `opening_months` validated 
by function. URL fields have DB-level CHECKs. ### 11\. Scalability & 
Future-Proofing *(No change from Version 1.4)* - Audit columns, 1:1 with 
`waypoints`, and use of lookup tables contribute positively. - Media: Relies on 
parent `waypoints` for primary media. - Future Consideration: Implement a 
standardized SQL function (e.g., `public.is_valid_url(TEXT)`) for URL 
validation. ### 12\. Next-Action Checklist *(No DDL changes required for this 
specific update beyond what was in V1.4, the main change is to the RLS policy 
definition in this document)* - 🔴 Verify/Implement RLS Helper: Ensure the 
`public.has_role(TEXT)` helper function is correctly implemented and available. 
- 🔴 Apply RLS Policies: Implement and thoroughly test the updated RLS 
policies. - 🟢 Confirm Prerequisite Functions: Ensure 
`public.are_valid_months(INTEGER[])` is correctly implemented. - 🟢 Translation 
Entries: Prepare/verify English entries for all translatable fields. 
