# 4.11 meal_type_tags_master

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
http://gemini.google.com/u/1/app/34bd37922031b95a 
https://gemini.google.com/u/1/app/21b8e85b3e611787 ### 3\. Updated 
Production-Ready Specification 4.11 Meal Type Tags Master Table (Version 1.4) 
---------------------------------------------- This document details the 
structure, purpose, and considerations for the `meal_type_tags_master` table, 
which is part of the food/water module. This table will standardize the tags 
used to indicate what types of meals an establishment serves. Version 1.4 
updates the RLS policies to align with the platform-wide security and 
authentication strategy using the `public.has_role()` helper function. ### 1\. 
Purpose & Primary Use-Cases The `meal_type_tags_master` table provides a 
definitive list of meal types that can be associated with food establishments 
(e.g., "Breakfast," "Lunch," "Dinner," "Snacks"). Its purpose is to enable 
standardized tagging for consistent filtering, multilingual display of meal 
types, and potentially associating icons with each meal type. Key user-story 
touchpoints: - Pilgrim: Filtering food establishments based on meals served 
(e.g., "find places open for dinner"). (Story A4) - Pilgrim: Quickly seeing 
what meals an establishment offers (e.g., icons for breakfast, lunch, dinner on 
a listing). - Admin/Content Manager: Tagging establishments with the 
appropriate meal types from a predefined, managed list, and managing the 
lifecycle of these tags (active/inactive). - System/UI: Populating filter 
options for meal types and displaying meal availability in a structured way 
using active tags. ### 2\. Schema (Markdown Table) *(No change to column 
structure from Version 1.3)* | column | data_type | constraints | description | 
| id | `integer` | Primary Key (Generated as identity always) | Unique 
identifier for the meal type tag. | | code | `text` | Unique, Not Null, CHECK 
(length(code) > 0 AND length(code) &lt;= 50 AND code ~ '^[a-z0-9_]+$') | Short, 
stable, machine-readable code (e.g., 'breakfast_colazione', 'lunch_pranzo'). 
Snake_case. | | label | `text` | Not Null, CHECK (length(label) > 0 AND 
length(label) &lt;= 100) | Human-readable name in the primary reference 
language (English) for UI display and as a base for translation. Translatable. 
| | description | `text` | Nullable | Optional description for the meal type in 
the primary reference language (English). Translatable. | | icon_identifier | 
`text` | Nullable, CHECK (icon_identifier IS NULL OR length(icon_identifier) 
&lt;= 100) | Name, class, or path for a UI icon associated with this meal type. 
| | sort_order | `integer` | Not Null, Default 0 | Determines the display order 
in UI lists or filters. | | is_active | `boolean` | Not Null, Default true | 
True if the tag is active and available for use; false if retired/archived. 
Important for array FK validation. | | created_at | `timestamp with time zone` 
| Not Null, Default `now()` | Timestamp of record creation. | | updated_at | 
`timestamp with time zone` | Not Null, Default `now()` | Timestamp of last 
update (auto-updated by trigger). | | created_by_profile_id | `uuid` | 
Nullable, Foreign Key to `public.profiles(id)` ON DELETE SET NULL | Profile ID 
of the user/admin who created this meal type tag record. | | 
updated_by_profile_id | `uuid` | Nullable, Foreign Key to `public.profiles(id)` 
ON DELETE SET NULL | Profile ID of the user/admin who last updated this meal 
type tag record. | ### 3\. PostgreSQL DDL *(DDL for table structure, comments, 
triggers, and indexes remain the same as Version 1.3. Only the version in the 
table comment changes.)* SQL ``` -- Assumes public.profiles table exists -- 
Assumes public.set_current_timestamp_updated_at() function exists -- Assumes 
public.cleanup_related_translations(TEXT, TEXT) function and specific per-table 
wrapper exist CREATE TABLE public.meal_type_tags_master ( id INTEGER GENERATED 
ALWAYS AS IDENTITY PRIMARY KEY, code TEXT UNIQUE NOT NULL CHECK (length(code) > 
0 AND length(code) <= 50 AND code ~ '^[a-z0-9_]+$'), label TEXT NOT NULL CHECK 
(length(label) > 0 AND length(label) <= 100), description TEXT NULL, 
icon_identifier TEXT NULL CHECK (icon_identifier IS NULL OR 
length(icon_identifier) <= 100), sort_order INTEGER NOT NULL DEFAULT 0, 
is_active BOOLEAN NOT NULL DEFAULT true, created_at TIMESTAMPTZ NOT NULL 
DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), 
created_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE SET 
NULL, updated_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE 
SET NULL ); COMMENT ON TABLE public.meal_type_tags_master IS 'Master list of 
meal type tags (e.g., breakfast, lunch, dinner). Replaces meal_type_tag_enum. 
Version 1.4'; -- Column comments from Version 1.3 remain unchanged. E.g.: 
COMMENT ON COLUMN public.meal_type_tags_master.label IS 'Human-readable name in 
the primary reference language (English) for UI and as a base for translation. 
Translatable via the ''translations'' table. Max 100 chars.'; COMMENT ON COLUMN 
public.meal_type_tags_master.is_active IS 'True if the tag is active and 
available for use; false if retired. Important for array FK validation.'; 
COMMENT ON COLUMN public.meal_type_tags_master.created_by_profile_id IS 
'Profile ID of the user/admin who created this record.'; COMMENT ON COLUMN 
public.meal_type_tags_master.updated_by_profile_id IS 'Profile ID of the 
user/admin who last updated this record.'; -- Indexes (including idx_mttm_label 
from previous update) CREATE INDEX IF NOT EXISTS idx_mttm_is_active ON 
public.meal_type_tags_master(is_active); CREATE INDEX IF NOT EXISTS 
idx_mttm_sort_order ON public.meal_type_tags_master(sort_order); CREATE INDEX 
IF NOT EXISTS idx_mttm_label ON public.meal_type_tags_master(label); CREATE 
INDEX IF NOT EXISTS idx_mttm_created_by_profile_id ON 
public.meal_type_tags_master(created_by_profile_id) WHERE created_by_profile_id 
IS NOT NULL; CREATE INDEX IF NOT EXISTS idx_mttm_updated_by_profile_id ON 
public.meal_type_tags_master(updated_by_profile_id) WHERE updated_by_profile_id 
IS NOT NULL; -- Trigger for updated_at CREATE TRIGGER 
trigger_meal_type_tags_master_set_updated_at BEFORE UPDATE ON 
public.meal_type_tags_master FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); COMMENT ON TRIGGER 
trigger_meal_type_tags_master_set_updated_at ON public.meal_type_tags_master IS 
'Trigger to automatically update updated_at timestamp on row modification.'; -- 
Trigger for orphan translation cleanup CREATE OR REPLACE FUNCTION 
public.cleanup_meal_type_tags_master_translations() RETURNS TRIGGER AS $$ BEGIN 
IF TG_OP = 'DELETE' THEN DELETE FROM public.translations WHERE table_identifier 
= 'meal_type_tags_master' AND row_foreign_key = OLD.id::TEXT; END IF; RETURN 
OLD; END; $$ LANGUAGE plpgsql SECURITY DEFINER; CREATE TRIGGER 
trigger_cleanup_meal_type_tags_master_translations AFTER DELETE ON 
public.meal_type_tags_master FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_meal_type_tags_master_translations(); COMMENT ON TRIGGER 
trigger_cleanup_meal_type_tags_master_translations ON 
public.meal_type_tags_master IS 'Cleans up orphaned translations from 
public.translations when a meal_type_tags_master record is deleted.'; -- 
Initial Data Example (ensure created_by_profile_id and updated_by_profile_id 
are set appropriately for seed data) INSERT INTO public.meal_type_tags_master 
(code, label, icon_identifier, sort_order, description, is_active, 
created_by_profile_id, updated_by_profile_id) VALUES ('breakfast_colazione', 
'Breakfast (Colazione)', 'icon-breakfast', 10, 'Morning meal service.', true, 
NULL, NULL), ('brunch', 'Brunch', 'icon-brunch', 20, 'Combination of breakfast 
and lunch, typically served late morning to early afternoon.', true, NULL, 
NULL), -- ... other seed data from V1.3 ... ('take_away_available', 'Take Away 
Available', 'icon-take-away', 100, 'Food can be ordered for consumption 
off-premises.', true, NULL, NULL); ``` ### 4\. JSON Schema Mirror *(No change 
from Version 1.3)* JSON ``` { "title": "meal_type_tag_master", "description": 
"Master list of meal type tags (e.g., breakfast, lunch, dinner). Version 1.4", 
"type": "object", "properties": { "id": { /* ... */ }, "code": { /* ... */ }, 
"label": { /* ... */ }, "description": { /* ... */ }, "icon_identifier": { /* 
... */ }, "sort_order": { /* ... */ }, "is_active": { /* ... */ }, 
"created_at": { /* ... */ }, "updated_at": { /* ... */ }, 
"created_by_profile_id": { /* ... */ }, "updated_by_profile_id": { /* ... */ } 
}, "required": [ /* ... */ ] } ``` ### 5\. Relationships & Integrity *(No 
change from Version 1.3)* - Primary Key: `id` (INTEGER) - Unique Constraint: 
`code` must be unique. - Foreign Key References FROM other tables: - 
`food_water_sources_details.serves_meal_type_tag_ids` (an `INTEGER[]` column) 
will contain IDs that reference `meal_type_tags_master.id`. - Foreign Key 
References TO other tables: - `created_by_profile_id` REFERENCES 
`public.profiles(id)` ON DELETE SET NULL. - `updated_by_profile_id` REFERENCES 
`public.profiles(id)` ON DELETE SET NULL. - Data Integrity Notes: - ðŸ”´ 
CRITICAL: Database triggers on referencing tables (e.g., 
`food_water_sources_details`) *must* be implemented to ensure all IDs in their 
`serves_meal_type_tag_ids` array correspond to valid `id` entries in 
`meal_type_tags_master` AND that `meal_type_tags_master.is_active = true`. - 
Retiring a meal type tag should be done by setting `is_active = false`. ### 6\. 
Multilingual Strategy *(No change from Version 1.3)* - Translatable Fields: 
`label`, `description`. - Translation Management: Via `public.translations` 
table and orphan cleanup trigger. ### 7\. Role-Based Workflow & RLS Notes 
*(This section is updated to reflect the new auth strategy)* - Content 
Management: This table is typically managed by users with the `admin_platform` 
role. `regional_content_manager` might also manage these if meal types are 
considered part of regional content characteristics. - Lifecycle: Meal type 
tags are made inactive by setting `is_active = false`. Physical deletion should 
be rare. - RLS Policies (Assumes `public.has_role(TEXT)` helper function 
exists): - Public Users (Read-Only on active tags): SQL ``` -- Name: Allow 
public read access to active meal type tags -- Target: meal_type_tags_master -- 
Operation: SELECT -- Role(s): anon, authenticated CREATE POLICY "Allow public 
read access to active meal type tags" ON public.meal_type_tags_master FOR 
SELECT USING (is_active = true); ``` - Platform Administrators / Content 
Managers (Full Control): SQL ``` -- Name: Allow platform content administrators 
to manage meal type tags -- Target: meal_type_tags_master -- Operation: ALL -- 
Role(s): admin_platform, regional_content_manager CREATE POLICY "Allow platform 
content administrators to manage meal type tags" ON 
public.meal_type_tags_master FOR ALL USING ( auth.role() = 'authenticated' AND 
(public.has_role('admin_platform') OR 
public.has_role('regional_content_manager')) ) WITH CHECK ( auth.role() = 
'authenticated' AND (public.has_role('admin_platform') OR 
public.has_role('regional_content_manager')) ); ``` - Enable RLS: SQL ``` ALTER 
TABLE public.meal_type_tags_master ENABLE ROW LEVEL SECURITY; ``` - Notes: RLS 
must filter by `is_active = true` for general read access. Array FK validation 
triggers on referencing tables must also check `is_active = true`. ### 8\. ENUM 
vs Lookup Discussion *(No change from Version 1.3)* - ðŸŸ¢ Decision: Correctly a 
lookup table. - Reasoning: Translatable names, descriptions, icons, sort order, 
auditability, lifecycle management. ### 9\. UI/UX Enablement *(No change from 
Version 1.3)* - `label` (translated): For filter labels, display tags. - 
`icon_identifier`: To show icons. - `sort_order`: To list meal types logically. 
- `is_active`: UI should only use active tags. ### 10\. Key Considerations & 
Definitions *(No change from Version 1.3)* - Tag Granularity: Initial list is a 
good start. - Multiple Selections: Establishments can offer multiple meal 
types. - Array FK Integrity: Referencing table's trigger logic must check 
`is_active = true`. ### 11\. Scalability & Future-Proofing *(No change from 
Version 1.3)* - Manageable List: Number of distinct meal types likely small. - 
Flexibility: Easy to add new meal types or attributes. - Audit Fields & 
`is_active` flag: Robust. ### 12\. Next-Action Checklist *(No DDL changes 
required for this specific update beyond what was in V1.3, the main change is 
to the RLS policy definition in this document)* - ðŸ”´ Verify/Implement RLS 
Helper: Ensure the `public.has_role(TEXT)` helper function is correctly 
implemented and available. - ðŸ”´ Apply RLS Policies: Implement and thoroughly 
test the updated RLS policies. - ðŸ”´ Initial Population/Seed Data: Ensure 
`created_by_profile_id`/`updated_by_profile_id` are correctly set for seed 
data. - ðŸŸ  Array FK Integrity: Ensure validation trigger on 
`food_water_sources_details` (for `serves_meal_type_tag_ids`) checks `is_active 
= true` in this table. - ðŸŸ¢ Icon Set Development: Coordinate with UI/UX team. - 
ðŸŸ¢ Translation Entries: Prepare/verify English entries for `label` and 
`description` in `public.translations`. 
