# 4.3 accommodation_types_master

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/34bd37922031b95a 
https://gemini.google.com/u/1/app/21b8e85b3e611787 * * * * * ### 3\. Updated 
Production-Ready Specification 4.3 Accommodation Types Master Table (Version 
1.4) -------------------------------------------------- This document details 
the structure, purpose, and considerations for the `accommodation_types_master` 
table. Version 1.4 updates the RLS policies to align with the platform-wide 
security and authentication strategy using the `public.has_role()` helper 
function. ### 1\. Purpose & Primary Use-Cases The `accommodation_types_master` 
table serves as a centralized, definitive list of all valid accommodation types 
available on the platform (e.g., "Pilgrim Hostel," "B&amp;B," "Hotel"). Its 
purpose is to ensure data consistency, provide standardized categories for 
filtering and display, and support multilingual representation of accommodation 
types with associated icons and descriptions. Key user-story touchpoints: - 
Pilgrim: Filtering accommodation searches by type. (Story A3) - Pilgrim: 
Understanding the type of an accommodation from its listing via a clear, 
translated name and potentially an icon. - Accommodation Host: Selecting the 
appropriate type for their listing during setup or update. (Story B1) - 
Admin/Content Manager: Managing the official list of recognized accommodation 
types, ensuring clarity, appropriate categorization, and lifecycle 
(active/inactive). - System/UI: Driving UI elements like filter dropdowns, 
icons next to accommodation listings, and grouping search results based on 
active types. ### 2\. Schema (Markdown Table) *(No change to column structure 
from Version 1.3)* | column | data_type | constraints | description | | id | 
`integer` | Primary Key (Generated as identity always) | Unique identifier for 
the accommodation type. | | code | `text` | Unique, Not Null, CHECK 
(length(code) > 0 AND length(code) &lt;= 50 AND code ~ '^[a-z0-9_]+$') | Short, 
stable, machine-readable code (e.g., 'ospitale_pilgrim_hostel', 'b_and_b'). 
Snake_case. | | label | `text` | Not Null, CHECK (length(label) > 0 AND 
length(label) &lt;= 100) | Human-readable name in the primary reference 
language (English) for UI display and as a base for translation. Translatable. 
| | description | `text` | Nullable | Optional description of the accommodation 
type in the primary reference language (English). Translatable. | | 
icon_identifier | `text` | Nullable, CHECK (icon_identifier IS NULL OR 
length(icon_identifier) &lt;= 100) | Name, class, or path for a UI icon 
associated with this accommodation type. | | sort_order | `integer` | Not Null, 
Default 0 | Determines the display order in UI lists or filters. Lower numbers 
appear first. | | is_active | `boolean` | Not Null, Default true | True if the 
category is active and available for use; false if retired/archived. | | 
created_at | `timestamp with time zone` | Not Null, Default `now()` | Timestamp 
of record creation. | | updated_at | `timestamp with time zone` | Not Null, 
Default `now()` | Timestamp of last update (auto-updated by trigger). | | 
created_by_profile_id | `uuid` | Nullable, Foreign Key to `public.profiles(id)` 
ON DELETE SET NULL | Profile ID of the user/admin who created this 
accommodation type record. | | updated_by_profile_id | `uuid` | Nullable, 
Foreign Key to `public.profiles(id)` ON DELETE SET NULL | Profile ID of the 
user/admin who last updated this accommodation type record. | ### 3\. 
PostgreSQL DDL *(DDL for table structure, comments, triggers, and indexes 
remain the same as Version 1.3. Only the version in the table comment 
changes.)* SQL ``` -- Assumes public.profiles table exists -- Assumes 
public.set_current_timestamp_updated_at() function exists -- Assumes 
public.cleanup_related_translations(TEXT, TEXT) function and specific per-table 
wrapper exist CREATE TABLE public.accommodation_types_master ( id INTEGER 
GENERATED ALWAYS AS IDENTITY PRIMARY KEY, code TEXT UNIQUE NOT NULL CHECK 
(length(code) > 0 AND length(code) <= 50 AND code ~ '^[a-z0-9_]+$'), label TEXT 
NOT NULL CHECK (length(label) > 0 AND length(label) <= 100), description TEXT 
NULL, icon_identifier TEXT NULL CHECK (icon_identifier IS NULL OR 
length(icon_identifier) <= 100), sort_order INTEGER NOT NULL DEFAULT 0, 
is_active BOOLEAN NOT NULL DEFAULT true, created_at TIMESTAMPTZ NOT NULL 
DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), 
created_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE SET 
NULL, updated_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE 
SET NULL ); COMMENT ON TABLE public.accommodation_types_master IS 'Master list 
of official accommodation types (e.g., hostel, B&B, hotel). Replaces 
accommodation_type_enum. Version 1.4'; -- Column comments from Version 1.3 
remain unchanged. E.g.: COMMENT ON COLUMN 
public.accommodation_types_master.label IS 'Human-readable name in the primary 
reference language (English) for UI display and as a base for translation. 
Translatable via the ''translations'' table. Max 100 chars.'; COMMENT ON COLUMN 
public.accommodation_types_master.is_active IS 'True if the category is active 
and available for use; false if retired/archived. Defaults to true.'; COMMENT 
ON COLUMN public.accommodation_types_master.created_by_profile_id IS 'Profile 
ID of the user/admin who created this record.'; COMMENT ON COLUMN 
public.accommodation_types_master.updated_by_profile_id IS 'Profile ID of the 
user/admin who last updated this record.'; -- Indexes (including idx_atm_label 
from previous update) CREATE INDEX IF NOT EXISTS idx_atm_is_active ON 
public.accommodation_types_master(is_active); CREATE INDEX IF NOT EXISTS 
idx_atm_sort_order ON public.accommodation_types_master(sort_order); CREATE 
INDEX IF NOT EXISTS idx_atm_label ON public.accommodation_types_master(label); 
CREATE INDEX IF NOT EXISTS idx_atm_created_by_profile_id ON 
public.accommodation_types_master(created_by_profile_id) WHERE 
created_by_profile_id IS NOT NULL; CREATE INDEX IF NOT EXISTS 
idx_atm_updated_by_profile_id ON 
public.accommodation_types_master(updated_by_profile_id) WHERE 
updated_by_profile_id IS NOT NULL; -- Trigger for updated_at CREATE TRIGGER 
trigger_accommodation_types_master_set_updated_at BEFORE UPDATE ON 
public.accommodation_types_master FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); COMMENT ON TRIGGER 
trigger_accommodation_types_master_set_updated_at ON 
public.accommodation_types_master IS 'Trigger to automatically update 
updated_at timestamp on row modification.'; -- Trigger for orphan translation 
cleanup CREATE OR REPLACE FUNCTION 
public.cleanup_accommodation_types_master_translations() RETURNS TRIGGER AS $$ 
BEGIN IF TG_OP = 'DELETE' THEN DELETE FROM public.translations WHERE 
table_identifier = 'accommodation_types_master' AND row_foreign_key = 
OLD.id::TEXT; END IF; RETURN OLD; END; $$ LANGUAGE plpgsql SECURITY DEFINER; 
CREATE TRIGGER trigger_cleanup_accommodation_types_master_translations AFTER 
DELETE ON public.accommodation_types_master FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_accommodation_types_master_translations(); COMMENT ON TRIGGER 
trigger_cleanup_accommodation_types_master_translations ON 
public.accommodation_types_master IS 'Cleans up orphaned translations from 
public.translations when an accommodation_types_master record is deleted.'; -- 
Seed data (as per Version 1.3, with audit columns populated appropriately) 
INSERT INTO public.accommodation_types_master (code, label, description, 
icon_identifier, sort_order, is_active, created_by_profile_id, 
updated_by_profile_id) VALUES ('ospitale_pilgrim_hostel', 'Pilgrim Hostel 
(Ospitale)', 'Simple lodging specifically for pilgrims, often with shared 
facilities.', 'icon-hostel', 10, true, NULL, NULL), ('b_and_b', 'Bed & 
Breakfast', 'Accommodation in a private home offering breakfast.', 
'icon-b-and-b', 20, true, NULL, NULL), -- ... other seed data ... ('other', 
'Other Accommodation', 'Other types of lodging not fitting standard 
categories.', 'icon-other-pin', 900, true, NULL, NULL); ``` ### 4\. JSON Schema 
Mirror *(No change from Version 1.3)* JSON ``` { "title": 
"accommodation_type_master", "description": "Master list of official 
accommodation types (e.g., hostel, B&B, hotel). Replaces 
accommodation_type_enum. Version 1.4", "type": "object", "properties": { "id": 
{ /* ... */ }, "code": { /* ... */ }, "label": { /* ... */ }, "description": { 
/* ... */ }, "icon_identifier": { /* ... */ }, "sort_order": { /* ... */ }, 
"is_active": { /* ... */ }, "created_at": { /* ... */ }, "updated_at": { /* ... 
*/ }, "created_by_profile_id": { /* ... */ }, "updated_by_profile_id": { /* ... 
*/ } }, "required": [ /* ... */ ] } ``` ### 5\. Relationships & Integrity *(No 
change from Version 1.3)* - Primary Key: `id` (INTEGER) - Unique Constraint: 
`code` must be unique. - Foreign Key References FROM other tables: - 
`accommodations.accommodation_type_id` REFERENCES 
`public.accommodation_types_master(id)` (ON DELETE RESTRICT). - Foreign Key 
References TO other tables: - `created_by_profile_id` REFERENCES 
`public.profiles(id)` ON DELETE SET NULL. - `updated_by_profile_id` REFERENCES 
`public.profiles(id)` ON DELETE SET NULL. - Data Integrity Notes: Retiring an 
accommodation type by `is_active = false`. ### 6\. Multilingual Strategy *(No 
change from Version 1.3)* - Translatable Fields: `label`, `description`. - 
Translation Management: Via `public.translations` table and orphan cleanup 
trigger. ### 7\. Role-Based Workflow & RLS Notes *(This section is updated to 
reflect the new auth strategy)* - Content Management: This table is typically 
managed by users with the `admin_platform` role. Depending on operational 
needs, `regional_content_manager` might also be granted some management 
capabilities, though typically master data like this is centrally managed. - 
Lifecycle: Accommodation types are made inactive by setting `is_active = 
false`. Physical deletion is restricted by foreign key constraints if the type 
is in use and should be an exceptional administrative action by an 
`admin_platform`. - RLS Policies (Assumes `public.has_role(TEXT)` helper 
function exists and checks `public.profiles.roles` for the current 
`auth.uid()`): - Public Users (Read-Only on active types): SQL ``` -- Name: 
Allow public read access to active accommodation types -- Target: 
accommodation_types_master -- Operation: SELECT -- Role(s): anon, authenticated 
CREATE POLICY "Allow public read access to active accommodation types" ON 
public.accommodation_types_master FOR SELECT USING (is_active = true); ``` - 
Platform Administrators (Full Control): SQL ``` -- Name: Allow platform 
administrators to manage accommodation types -- Target: 
accommodation_types_master -- Operation: ALL -- Role(s): admin_platform CREATE 
POLICY "Allow platform administrators to manage accommodation types" ON 
public.accommodation_types_master FOR ALL USING ( auth.role() = 'authenticated' 
AND public.has_role('admin_platform') ) WITH CHECK ( auth.role() = 
'authenticated' AND public.has_role('admin_platform') ); ``` - Enable RLS: SQL 
``` ALTER TABLE public.accommodation_types_master ENABLE ROW LEVEL SECURITY; 
``` - Notes: - The `public.has_role('admin_platform')` function is crucial. If 
other roles (e.g., `regional_content_manager`) need similar access, the `USING` 
and `WITH CHECK` conditions should be expanded (e.g., 
`(public.has_role('admin_platform') OR 
public.has_role('regional_content_manager'))`). For core master data, 
restricting full CRUD to `admin_platform` is often preferred. ### 8\. ENUM vs 
Lookup Discussion *(No change from Version 1.3)* - 🟢 Decision: Correctly a 
lookup table. - Reasoning: Richness, i18n, maintainability, data integrity, 
auditability, lifecycle. ### 9\. UI/UX Enablement *(No change from Version 
1.3)* - `label` (translated): For display names. - `icon_identifier`: For 
icons. - `sort_order`: For consistent presentation. - `description` 
(translated): For tooltips. - `is_active`: UI should only use active 
categories. ### 10\. Key Considerations & Definitions *(No change from Version 
1.3)* - `code` vs. `label`: Stable system ID vs. display name. - Icon Strategy: 
UI assets match `icon_identifier`. - Data Management: Administrative task; 
lifecycle via `is_active`. ### 11\. Scalability & Future-Proofing *(No change 
from Version 1.3)* - Lookup Table Structure: Scalable, flexible. - Audit Fields 
& `is_active` flag: Good for history and lifecycle. ### 12\. Next-Action 
Checklist *(No DDL changes required for this specific update beyond what was in 
V1.3, the main change is to the RLS policy definition in this document)* - 🔴 
Verify/Implement RLS Helper: Ensure the `public.has_role(TEXT)` helper function 
is correctly implemented and available. - 🔴 Apply RLS Policies: Implement and 
thoroughly test the updated RLS policies. - 🔴 Initial Population/Seed Data: 
Ensure `created_by_profile_id`/`updated_by_profile_id` are correctly set for 
seed data (e.g., system admin UUID). - 🟢 Review Role Assignments: Confirm 
which roles (`admin_platform`, `regional_content_manager`, etc.) should have 
management rights over this specific master table and adjust RLS if necessary. 
