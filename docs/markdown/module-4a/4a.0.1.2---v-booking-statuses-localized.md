# 4a.0.1.2 - v_booking_statuses_localized

  https://gemini.google.com/u/1/app/21b8e85b3e611787 New View Spec: 
v_booking_statuses_localized 1. View Name public.v_booking_statuses_localized 
2. Purpose & Primary Use-Cases Purpose : To provide a consolidated and 
denormalized view of booking_statuses_master records, including all their 
available translations for label and description fields in a structured JSONB 
format, alongside all other master table attributes. Primary Use-Cases : 
Simplify API development by providing a single source for a booking status and 
all its translations. Support API endpoints that list booking statuses or 
display details for a specific booking status where multilingual representation 
is required (e.g., for accommodation booking interfaces or admin panels). 
Facilitate easier data fetching for frontend components that need to display 
localized booking status information. 3. View Schema (Columns) Column Data Type 
Description id integer Inherited from booking_statuses_master . Unique 
identifier for the booking status. code text Inherited from 
booking_statuses_master . Short, stable, machine-readable code (e.g., 
'open_bookings_available'). label text Inherited from booking_statuses_master . 
Primary reference language (English) label for the booking status. description 
text Inherited from booking_statuses_master . Optional primary reference 
language (English) description of the booking status. is_positive_status 
boolean Inherited from booking_statuses_master . Indicates if the status 
generally represents positive availability. sort_order integer Inherited from 
booking_statuses_master . Determines display order in UI lists. is_active 
boolean Inherited from booking_statuses_master . True if the booking status is 
active and available for use. created_at timestamp with time zone Inherited 
from booking_statuses_master . Timestamp of record creation. updated_at 
timestamp with time zone Inherited from booking_statuses_master . Timestamp of 
last update. created_by_profile_id uuid Inherited from booking_statuses_master 
. Profile ID of the user/admin who created this record. updated_by_profile_id 
uuid Inherited from booking_statuses_master . Profile ID of the user/admin who 
last updated this record. all_translations jsonb A JSONB object containing all 
available translations for label and description , keyed by language code. 
Example: {"en": {"label": "...", "description": "..."}, "it": {"label": "...", 
"description": "..."}} . Includes primary English text if present in 
translations table. 4. Underlying SQL Definition SQL CREATE OR REPLACE VIEW 
public.v_booking_statuses_localized AS SELECT bsm.id, bsm.code, bsm.label, -- 
Primary English label bsm.description, -- Primary English description 
bsm.is_positive_status, bsm.sort_order, bsm.is_active, bsm.created_at, 
bsm.updated_at, bsm.created_by_profile_id, bsm.updated_by_profile_id, ( SELECT 
jsonb_object_agg( tr.language_code, jsonb_build_object( 'label' , MAX ( CASE 
WHEN tr.column_identifier = 'label' THEN tr.translated_text ELSE NULL END ), 
'description' , MAX ( CASE WHEN tr.column_identifier = 'description' THEN 
tr.translated_text ELSE NULL END ) ) ) FROM public.translations tr WHERE 
tr.table_identifier = 'booking_statuses_master' AND tr.row_foreign_key = 
bsm.id::TEXT GROUP BY tr.row_foreign_key ) AS all_translations FROM 
public.booking_statuses_master bsm; COMMENT ON VIEW 
public.v_booking_statuses_localized IS 'Provides booking statuses with their 
base English fields and a JSONB column "all_translations" containing all 
available label and description translations keyed by language code. Version 
1.0' ; COMMENT ON COLUMN public.v_booking_statuses_localized.label IS 'Primary 
reference language (English) label from booking_statuses_master.' ; COMMENT ON 
COLUMN public.v_booking_statuses_localized.description IS 'Primary reference 
language (English) description from booking_statuses_master.' ; COMMENT ON 
COLUMN public.v_booking_statuses_localized.all_translations IS 'JSONB object 
with all translations for label and description, keyed by language code. E.g., 
{"en": {"label": "...", "description": "..."}, "it": {"label": "...", 
"description": "..."}}. Base English text from master table should be merged by 
application/API layer if not also present in translations table with code 
''en''.' ; 5. Key Dependencies public.booking_statuses_master (Version 1.3 or 
later, which includes is_active and audit columns) public.translations (Version 
2.1 or later) 6. Performance Considerations The subquery using jsonb_object_agg 
can be resource-intensive without proper indexing on public.translations . 
Required Index on public.translations : A composite index on ( table_identifier 
, row_foreign_key , language_code , column_identifier ) is crucial. (Assumed to 
be idx_translations_lookup_multi_col as defined for the previous view). Queries 
on this view filtering by is_active will benefit from the idx_bsm_is_active 
index on booking_statuses_master . For very high-read scenarios, a materialized 
view could be a V2+ optimization. 7. RLS & Security Notes RLS policies from 
public.booking_statuses_master (e.g., filtering by is_active = true ) will be 
inherited by this view. Access to public.translations is assumed if a user can 
see the master record. Define with SECURITY INVOKER (default for views). 8. API 
Endpoints Supported (Conceptual) GET /meta/booking-statuses?lang=it : List all 
active booking statuses with translations. GET 
/meta/booking-statuses/{status_code} : Get a specific booking status with 
translations. Simplifies providing localized status information to frontend 
interfaces where accommodations display their booking status. 9. Rationale for 
Creation Decouples API data retrieval from complex translation join/aggregation 
logic. Provides a consistent, denormalized structure for accessing localized 
booking status content. Improves query readability and maintainability for 
developers. 10. Key Considerations & Definitions Primary Language Fallback : 
The API/application layer needs to handle fallback to primary English fields if 
a translation for a requested language is not available in all_translations . 
Data Freshness : As a standard view, it reflects the current state. 11. 
Scalability & Future-Proofing Performance depends on translations table 
indexing. Adding new translatable fields to booking_statuses_master would 
require updating this view definition. 12. Next-Action Checklist ðŸ”´ Create View 
: Execute the DDL to create public.v_booking_statuses_localized . ðŸ”´ Verify 
Index on translations : Ensure the recommended composite index on 
public.translations exists. ðŸŸ  API Layer Integration : Plan API consumption of 
this view. ðŸŸ¢ Testing : Test view performance. ðŸŸ¢ Documentation : Document this 
view. 
