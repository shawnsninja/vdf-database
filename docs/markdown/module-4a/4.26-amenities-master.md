# 4.26 amenities_master

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/34bd37922031b95a 
https://gemini.google.com/u/1/app/21b8e85b3e611787 * * * * * ### 3\. Updated 
Production-Ready Specification 4.26 Amenities Master Table (Version 1.5) 
----------------------------------------- This document details the structure, 
purpose, and considerations for the `amenities_master` table. Version 1.5 
updates the RLS policies to align with the platform-wide security and 
authentication strategy using the `public.has_role()` helper function. ### 1\. 
Purpose & Primary Use-Cases The `amenities_master` table defines a standardized 
list of all possible amenities that accommodations (and potentially other types 
of waypoints) can offer (e.g., "Wi-Fi Internet," "Guest Kitchen Access," "Pets 
Permitted," "Secure Bicycle Storage"). Its purpose is to ensure data 
consistency, support robust filtering by amenities, allow for multilingual 
display of amenity names, and associate icons with each amenity for a richer 
user interface. Key user-story touchpoints: - Pilgrim (Anna): Filtering 
accommodations by available amenities (e.g., finding places with a kitchen or 
laundry facilities). (Story A3) - Pilgrim (Anna): Quickly seeing available 
amenities (with icons) on an accommodation's listing. - Accommodation Host 
(Marco): Selecting the amenities their B&amp;B offers from a predefined list. 
(Story B1) - Admin/Content Manager: Managing the global list of recognized 
amenities, including their names, icons, categories, and active status. - 
System/UI: Populating filter options for amenities and displaying them clearly 
in accommodation details using active amenities. ### 2\. Schema (Markdown 
Table) *(No change to column structure from Version 1.4)* | column | data_type 
| constraints | description | | id | `integer` | Primary Key (Generated as 
identity always) | Unique identifier for the amenity. | | amenity_code | `text` 
| Unique, Not Null, CHECK (length(amenity_code) > 0 AND length(amenity_code) 
&lt;= 50 AND amenity_code ~ '^[A-Z0-9_]+$') | Short, stable, machine-readable 
code (e.g., "WIFI_INTERNET", "KITCHEN_ACCESS"). Uppercase snake_case. | | name 
| `text` | Not Null, CHECK (length(name) > 0 AND length(name) &lt;= 100) | 
Human-readable name in the primary reference language (English). Translatable 
via the `translations` table. | | description | `text` | Nullable | Optional 
further description of the amenity in the primary reference language (English). 
Translatable via the `translations` table. | | icon_identifier | `text` | 
Nullable, CHECK (icon_identifier IS NULL OR length(icon_identifier) &lt;= 100) 
| Name, class, or path for a UI icon associated with this amenity. | | 
amenity_category | `text` | Nullable, CHECK (amenity_category IS NULL OR 
length(amenity_category) &lt;= 50) | Broad category for grouping amenities in 
the primary reference language (English) (e.g., "General", "Room Feature"). 
Translatable. | | is_common_pilgrim_need | `boolean` | Not Null, Default false 
| Flags amenities particularly sought after by pilgrims, can be used for 
highlighting or default filter suggestions. | | sort_order | `integer` | Not 
Null, Default 0 | Determines the display order of amenities in UI lists or 
selection interfaces. | | is_active | `boolean` | Not Null, Default true | True 
if the amenity is active and available for use; false if retired/archived. 
Important for RLS and FK integrity checks. | | created_at | `timestamp with 
time zone` | Not Null, Default `now()` | Timestamp of record creation. | | 
updated_at | `timestamp with time zone` | Not Null, Default `now()` | Timestamp 
of last update (auto-updated by trigger). | | created_by_profile_id | `uuid` | 
Nullable, Foreign Key to `public.profiles(id)` ON DELETE SET NULL | Profile ID 
of the user/admin who created this amenity record. | | updated_by_profile_id | 
`uuid` | Nullable, Foreign Key to `public.profiles(id)` ON DELETE SET NULL | 
Profile ID of the user/admin who last updated this amenity record. | ### 3\. 
PostgreSQL DDL *(DDL for table structure, comments, triggers, and indexes 
remain the same as Version 1.4. Only the version in the table comment 
changes.)* SQL ``` -- Assumes public.profiles table exists -- Assumes 
public.set_current_timestamp_updated_at() function exists -- Assumes 
public.cleanup_related_translations(TEXT, TEXT) function and specific per-table 
wrapper exist CREATE TABLE public.amenities_master ( id INTEGER GENERATED 
ALWAYS AS IDENTITY PRIMARY KEY, amenity_code TEXT UNIQUE NOT NULL CHECK 
(length(amenity_code) > 0 AND length(amenity_code) <= 50 AND amenity_code ~ 
'^[A-Z0-9_]+$'), name TEXT NOT NULL CHECK (length(name) > 0 AND length(name) <= 
100), description TEXT NULL, icon_identifier TEXT NULL CHECK (icon_identifier 
IS NULL OR length(icon_identifier) <= 100), amenity_category TEXT NULL CHECK 
(amenity_category IS NULL OR length(amenity_category) <= 50), 
is_common_pilgrim_need BOOLEAN NOT NULL DEFAULT FALSE, sort_order INTEGER NOT 
NULL DEFAULT 0, is_active BOOLEAN NOT NULL DEFAULT true, created_at TIMESTAMPTZ 
NOT NULL DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), 
created_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE SET 
NULL, updated_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE 
SET NULL ); COMMENT ON TABLE public.amenities_master IS 'Master list of all 
possible amenities with standardized names, codes, and icon references. Version 
1.5'; -- Column comments from Version 1.4 remain unchanged. E.g.: COMMENT ON 
COLUMN public.amenities_master.name IS 'Human-readable name in the primary 
reference language (English). Translatable via the ''translations'' table. Max 
100 chars.'; COMMENT ON COLUMN public.amenities_master.amenity_category IS 
'Broad category for grouping amenities in the primary reference language 
(English) (e.g., "General", "Room Feature"). Translatable via the 
''translations'' table. Max 50 chars.'; COMMENT ON COLUMN 
public.amenities_master.is_active IS 'True if the amenity is active and 
available for use; false if retired. Important for RLS and FK integrity 
checks.'; COMMENT ON COLUMN public.amenities_master.created_by_profile_id IS 
'Profile ID of the user/admin who created this record.'; COMMENT ON COLUMN 
public.amenities_master.updated_by_profile_id IS 'Profile ID of the user/admin 
who last updated this record.'; -- Indexes (including idx_am_name from previous 
update) CREATE INDEX IF NOT EXISTS idx_am_is_active ON 
public.amenities_master(is_active); CREATE INDEX IF NOT EXISTS 
idx_am_sort_order ON public.amenities_master(sort_order); CREATE INDEX IF NOT 
EXISTS idx_am_amenity_category ON public.amenities_master(amenity_category) 
WHERE amenity_category IS NOT NULL; CREATE INDEX IF NOT EXISTS 
idx_am_is_common_pilgrim_need ON 
public.amenities_master(is_common_pilgrim_need); CREATE INDEX IF NOT EXISTS 
idx_am_name ON public.amenities_master(name); CREATE INDEX IF NOT EXISTS 
idx_am_created_by_profile_id ON public.amenities_master(created_by_profile_id) 
WHERE created_by_profile_id IS NOT NULL; CREATE INDEX IF NOT EXISTS 
idx_am_updated_by_profile_id ON public.amenities_master(updated_by_profile_id) 
WHERE updated_by_profile_id IS NOT NULL; -- Trigger for updated_at CREATE 
TRIGGER trigger_amenities_master_set_updated_at BEFORE UPDATE ON 
public.amenities_master FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); COMMENT ON TRIGGER 
trigger_amenities_master_set_updated_at ON public.amenities_master IS 'Trigger 
to automatically update updated_at timestamp on row modification.'; -- Trigger 
for orphan translation cleanup CREATE OR REPLACE FUNCTION 
public.cleanup_amenities_master_translations() RETURNS TRIGGER AS $$ BEGIN IF 
TG_OP = 'DELETE' THEN DELETE FROM public.translations WHERE table_identifier = 
'amenities_master' AND row_foreign_key = OLD.id::TEXT; END IF; RETURN OLD; END; 
$$ LANGUAGE plpgsql SECURITY DEFINER; CREATE TRIGGER 
trigger_cleanup_amenities_master_translations AFTER DELETE ON 
public.amenities_master FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_amenities_master_translations(); COMMENT ON TRIGGER 
trigger_cleanup_amenities_master_translations ON public.amenities_master IS 
'Cleans up orphaned translations from public.translations when an 
amenities_master record is deleted.'; -- Initial Data Example (ensure 
created_by_profile_id and updated_by_profile_id are set appropriately for seed 
data) INSERT INTO public.amenities_master (amenity_code, name, icon_identifier, 
amenity_category, is_common_pilgrim_need, sort_order, description, is_active, 
created_by_profile_id, updated_by_profile_id) VALUES ('WIFI_INTERNET', 'Wi-Fi 
Internet', 'wifi', 'Connectivity', true, 10, 'Access to wireless internet.', 
true, NULL, NULL), ('KITCHEN_ACCESS', 'Guest Kitchen Access', 'kitchen', 'Food 
& Drink', true, 20, 'Guests can use kitchen facilities to prepare their own 
meals.', true, NULL, NULL), -- ... other seed data from V1.4 ... 
('PARKING_ONSITE', 'On-site Parking', 'local_parking', 'Services', false, 140, 
'Parking available at the accommodation premises.', true, NULL, NULL); ``` ### 
4\. JSON Schema Mirror *(No change from Version 1.4)* JSON ``` { "title": 
"amenity_master", "description": "Master list of all possible amenities with 
standardized names, codes, and icon references. Version 1.5", "type": "object", 
"properties": { "id": { /* ... */ }, "amenity_code": { /* ... */ }, "name": { 
/* ... */ }, "description": { /* ... */ }, "icon_identifier": { /* ... */ }, 
"amenity_category": { /* ... */ }, "is_common_pilgrim_need": { /* ... */ }, 
"sort_order": { /* ... */ }, "is_active": { /* ... */ }, "created_at": { /* ... 
*/ }, "updated_at": { /* ... */ }, "created_by_profile_id": { /* ... */ }, 
"updated_by_profile_id": { /* ... */ } }, "required": [ /* ... */ ] } ``` ### 
5\. Relationships & Integrity *(No change from Version 1.4)* - Primary Key: 
`id` (INTEGER) - Unique Constraint: `amenity_code` must be unique. - Foreign 
Key References FROM other tables: - `accommodation_amenities.amenity_id` 
REFERENCES `public.amenities_master(id)` (ON DELETE RESTRICT recommended on 
junction). - Foreign Key References TO other tables: - `created_by_profile_id` 
REFERENCES `public.profiles(id)` ON DELETE SET NULL. - `updated_by_profile_id` 
REFERENCES `public.profiles(id)` ON DELETE SET NULL. - Data Integrity Notes: 
Retiring an amenity by `is_active = false`. ### 6\. Multilingual Strategy *(No 
change from Version 1.4)* - Translatable Fields: `name`, `description`, 
`amenity_category`. - Translation Management: Via `public.translations` table 
and orphan cleanup trigger. ### 7\. Role-Based Workflow & RLS Notes *(This 
section is updated to reflect the new auth strategy)* - Content Management: 
This table is typically managed by users with the `admin_platform` role. 
`regional_content_manager` might also be granted rights if amenities are 
considered part of regional content characteristics. - Lifecycle: Amenities are 
made inactive by setting `is_active = false`. Physical deletion is restricted 
by FK from `accommodation_amenities` if an amenity is in use. - RLS Policies 
(Assumes `public.has_role(TEXT)` helper function exists): - Public Users 
(Read-Only on active amenities): SQL ``` -- Name: Allow public read access to 
active amenities master list -- Target: amenities_master -- Operation: SELECT 
-- Role(s): anon, authenticated CREATE POLICY "Allow public read access to 
active amenities master list" ON public.amenities_master FOR SELECT USING 
(is_active = true); ``` - Platform Administrators / Content Managers (Full 
Control): SQL ``` -- Name: Allow platform content administrators to manage 
amenities master list -- Target: amenities_master -- Operation: ALL -- Role(s): 
admin_platform, regional_content_manager CREATE POLICY "Allow platform content 
administrators to manage amenities master list" ON public.amenities_master FOR 
ALL USING ( auth.role() = 'authenticated' AND 
(public.has_role('admin_platform') OR 
public.has_role('regional_content_manager')) ) WITH CHECK ( auth.role() = 
'authenticated' AND (public.has_role('admin_platform') OR 
public.has_role('regional_content_manager')) ); ``` - Enable RLS: SQL ``` ALTER 
TABLE public.amenities_master ENABLE ROW LEVEL SECURITY; ``` - Notes: RLS must 
filter by `is_active = true` for general read access. ### 8\. ENUM vs Lookup 
Discussion *(No change from Version 1.4)* - ðŸŸ¢ Decision: Correctly a lookup 
table. - Reasoning: Metadata richness, auditability, lifecycle. ### 9\. UI/UX 
Enablement *(No change from Version 1.4)* - `name` (translated): For display in 
lists and filters. - `icon_identifier`: For icons. - `is_common_pilgrim_need`: 
To highlight options. - `amenity_category` (translated): For grouping. - 
`sort_order`: For consistent display. - `is_active`: UI should only use active 
amenities. ### 10\. Key Considerations & Definitions *(No change from Version 
1.4)* - `amenity_code`: Unique, stable (UPPER_SNAKE_CASE). - Icon Management: 
Frontend library needed. - Categorization (`amenity_category`): Define useful 
categories; consider promotion to master in V2+. ### 11\. Scalability & 
Future-Proofing *(No change from Version 1.4)* - Lookup Table Structure: Highly 
scalable. - Flexibility: Easy to add new attributes. - Audit Fields & 
`is_active` flag: Robust. ### 12\. Next-Action Checklist *(No DDL changes 
required for this specific update beyond what was in V1.4, the main change is 
to the RLS policy definition in this document)* - ðŸ”´ Verify/Implement RLS 
Helper: Ensure the `public.has_role(TEXT)` helper function is correctly 
implemented and available. - ðŸ”´ Apply RLS Policies: Implement and thoroughly 
test the updated RLS policies. - ðŸ”´ Initial Population/Seed Data: Ensure 
`created_by_profile_id`/`updated_by_profile_id` are correctly set for seed 
data. - ðŸŸ¢ Icon Set Development: Coordinate with UI/UX team. - ðŸŸ¢ Translation 
Entries: Prepare/verify English entries for `name`, `description`, and 
`amenity_category` in `public.translations`. 
