# 4.29 accommodation_room_configurations

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/34bd37922031b95a 
https://gemini.google.com/u/1/app/21b8e85b3e611787 * * * * * ### 3\. Updated 
Production-Ready Specification 4.29 Accommodation Room Configurations Table 
(Version 1.5) ---------------------------------------------------------- This 
document details the structure, purpose, and considerations for the 
`accommodation_room_configurations` table. This table is crucial for detailing 
the specific room offerings of an accommodation, including quantities and 
pricing. Version 1.5 updates the RLS policies to align with the platform-wide 
security and authentication strategy using the `public.has_role()` helper 
function and checks for active master data. ### 1\. Purpose & Primary Use-Cases 
The `accommodation_room_configurations` table links an accommodation to the 
specific types of rooms it offers (from `room_types_master`), specifying the 
quantity of each room type available and their pricing details. This allows for 
a detailed inventory of an accommodation's capacity and supports precise 
information for pilgrims looking for particular room setups. Key user-story 
touchpoints: - Pilgrim (Anna): Seeing the exact types of rooms available at an 
accommodation (e.g., "2 x Private Twin Ensuite," "4 x Dorm Beds"), their 
prices, and any specific notes for those rooms (Story A3). - Pilgrim (Anna): 
Filtering based on the availability of specific room types and understanding 
per-person vs. per-room pricing (Story A3). - Accommodation Host (Marco): 
Managing their detailed room inventory, including the number of each room type, 
pricing, and notes specific to those configurations (e.g., "ground floor, 
accessible," "bunk beds") (Story B1). - System/UI: Calculating total capacity 
accurately (for the `accommodations_capacity_summary_view`), displaying 
available room configurations with prices, and enabling precise filtering based 
on room availability. ### 2\. Schema (Markdown Table) *(No change to column 
structure from Version 1.4)* | column | data_type | constraints | description | 
| id | `bigint` | Primary Key (Generated as identity always) | Unique 
identifier for this specific room configuration entry. | | 
accommodation_waypoint_id | `bigint` | Not Null, Foreign Key to 
`accommodations(waypoint_id)` ON DELETE CASCADE, Part of UNIQUE constraint 
`uq_accommodation_room_type` | Links to the specific accommodation this room 
configuration belongs to. | | room_type_id | `integer` | Not Null, Foreign Key 
to `room_types_master(id)` ON DELETE RESTRICT, Part of UNIQUE constraint 
`uq_accommodation_room_type` | Links to the type of room being configured 
(e.g., "Private Double Ensuite"). RESTRICT prevents deleting a master room type 
if in use. | | count_of_this_room_type | `smallint` | Not Null, CHECK 
(`count_of_this_room_type` > 0 AND `count_of_this_room_type` &lt; 1000) | How 
many rooms of this specific type are available (e.g., "2" of 
"PRIVATE_DOUBLE_ENSUITE"). | | price_amount | `numeric(10, 2)` | Nullable, 
CHECK (`price_amount` IS NULL OR `price_amount` >= 0) | Price for one unit of 
this room type at this accommodation. Numeric for precision. | | 
price_currency_code | `char(3)` | Not Null, Default 'EUR', CHECK 
(length(`price_currency_code`) = 3 AND `price_currency_code` = 
upper(`price_currency_code`)) | ISO 4217 currency code for `price_amount` 
(e.g., "EUR"). V1 defaults to EUR. | | price_is_per_person | `boolean` | Not 
Null, Default false | Indicates if `price_amount` is per person (e.g., for dorm 
beds) or per room/unit. | | price_notes | `text` | Nullable | Specific pricing 
notes for this room type (e.g., "Weekend surcharge applies," "Breakfast 
optional for â‚¬X extra"). Primary reference language (English) text. 
Translatable. | | room_specific_notes | `text` | Nullable | Other notes 
specific to this room configuration at this accommodation (e.g., "Ground floor, 
accessible," "Max 2 adults + 1 child"). Primary reference language (English) 
text. Translatable. | | created_at | `timestamp with time zone` | Not Null, 
Default `now()` | Timestamp of record creation. | | created_by_profile_id | 
`uuid` | Nullable, Foreign Key to `public.profiles(id)` ON DELETE SET NULL | 
Profile ID of the user who created this room configuration. | | updated_at | 
`timestamp with time zone` | Not Null, Default `now()` | Timestamp of last 
update (auto-updated by trigger). | | updated_by_profile_id | `uuid` | 
Nullable, Foreign Key to `public.profiles(id)` ON DELETE SET NULL | Profile ID 
of the user who last updated this room configuration. | ### 3\. PostgreSQL DDL 
*(DDL for table structure, comments, triggers, and existing indexes remain the 
same as Version 1.4. Only the version in the table comment changes.)* SQL ``` 
-- Assumes public.accommodations, public.room_types_master, public.profiles 
tables exist -- Assumes public.set_current_timestamp_updated_at() function 
exists -- Assumes public.cleanup_related_translations(TEXT, TEXT) function and 
specific per-table wrapper exist CREATE TABLE 
public.accommodation_room_configurations ( id BIGINT GENERATED ALWAYS AS 
IDENTITY PRIMARY KEY, accommodation_waypoint_id BIGINT NOT NULL, room_type_id 
INTEGER NOT NULL, count_of_this_room_type SMALLINT NOT NULL CHECK 
(count_of_this_room_type > 0 AND count_of_this_room_type < 1000), price_amount 
NUMERIC(10, 2) NULL CHECK (price_amount IS NULL OR price_amount >= 0), 
price_currency_code CHAR(3) NOT NULL DEFAULT 'EUR' CHECK 
(length(price_currency_code) = 3 AND price_currency_code = 
upper(price_currency_code)), price_is_per_person BOOLEAN NOT NULL DEFAULT 
FALSE, price_notes TEXT NULL, room_specific_notes TEXT NULL, created_at 
TIMESTAMPTZ NOT NULL DEFAULT now(), created_by_profile_id UUID NULL, updated_at 
TIMESTAMPTZ NOT NULL DEFAULT now(), updated_by_profile_id UUID NULL, CONSTRAINT 
fk_accommodation_waypoint FOREIGN KEY(accommodation_waypoint_id) REFERENCES 
public.accommodations(waypoint_id) ON DELETE CASCADE, CONSTRAINT fk_room_type 
FOREIGN KEY(room_type_id) REFERENCES public.room_types_master(id) ON DELETE 
RESTRICT, CONSTRAINT fk_created_by_profile FOREIGN KEY(created_by_profile_id) 
REFERENCES public.profiles(id) ON DELETE SET NULL, CONSTRAINT 
fk_updated_by_profile FOREIGN KEY(updated_by_profile_id) REFERENCES 
public.profiles(id) ON DELETE SET NULL, CONSTRAINT uq_accommodation_room_type 
UNIQUE (accommodation_waypoint_id, room_type_id) ); COMMENT ON TABLE 
public.accommodation_room_configurations IS 'Details the specific room types, 
quantities, and pricing available at a particular accommodation. Version 1.5'; 
-- Column comments from Version 1.4 remain unchanged. E.g.: COMMENT ON COLUMN 
public.accommodation_room_configurations.price_notes IS 'Specific pricing notes 
for this room type (e.g., "Weekend surcharge"). Primary reference language 
(English) text. Translatable via ''translations'' table using this record''s 
`id` as row_foreign_key.'; COMMENT ON COLUMN 
public.accommodation_room_configurations.room_specific_notes IS 'Other notes 
specific to this room configuration (e.g., "Ground floor, accessible"). Primary 
reference language (English) text. Translatable via ''translations'' table 
using this record''s `id` as row_foreign_key.'; COMMENT ON COLUMN 
public.accommodation_room_configurations.created_by_profile_id IS 'Profile ID 
of the user who created this configuration.'; COMMENT ON COLUMN 
public.accommodation_room_configurations.updated_by_profile_id IS 'Profile ID 
of the user who last updated this configuration.'; -- Trigger for updated_at 
CREATE TRIGGER trigger_accommodation_room_configurations_set_updated_at BEFORE 
UPDATE ON public.accommodation_room_configurations FOR EACH ROW EXECUTE 
FUNCTION public.set_current_timestamp_updated_at(); COMMENT ON TRIGGER 
trigger_accommodation_room_configurations_set_updated_at ON 
public.accommodation_room_configurations IS 'Trigger to automatically update 
updated_at timestamp on row modification.'; -- Trigger for orphan translation 
cleanup CREATE OR REPLACE FUNCTION 
public.cleanup_accommodation_room_configurations_translations() RETURNS TRIGGER 
AS $$ BEGIN IF TG_OP = 'DELETE' THEN DELETE FROM public.translations WHERE 
table_identifier = 'accommodation_room_configurations' AND row_foreign_key = 
OLD.id::TEXT; END IF; RETURN OLD; END; $$ LANGUAGE plpgsql SECURITY DEFINER; 
CREATE TRIGGER trigger_cleanup_accommodation_room_configurations_translations 
AFTER DELETE ON public.accommodation_room_configurations FOR EACH ROW EXECUTE 
FUNCTION public.cleanup_accommodation_room_configurations_translations(); 
COMMENT ON TRIGGER 
trigger_cleanup_accommodation_room_configurations_translations ON 
public.accommodation_room_configurations IS 'Cleans up orphaned translations 
from public.translations when an accommodation_room_configurations record is 
deleted.'; -- Indexes (including audit FK indexes from previous update) CREATE 
INDEX idx_arc_accommodation_waypoint_id ON 
public.accommodation_room_configurations(accommodation_waypoint_id); CREATE 
INDEX idx_arc_room_type_id ON 
public.accommodation_room_configurations(room_type_id); CREATE INDEX IF NOT 
EXISTS idx_arc_created_by_profile_id ON 
public.accommodation_room_configurations(created_by_profile_id) WHERE 
created_by_profile_id IS NOT NULL; CREATE INDEX IF NOT EXISTS 
idx_arc_updated_by_profile_id ON 
public.accommodation_room_configurations(updated_by_profile_id) WHERE 
updated_by_profile_id IS NOT NULL; ``` ### 4\. JSON Schema Mirror *(No change 
from Version 1.4)* JSON ``` { "title": "accommodation_room_configuration", 
"description": "Details the specific room types, quantities, and pricing 
available at a particular accommodation. Version 1.5", "type": "object", 
"properties": { /* ... all properties as in Version 1.4 ... */ }, "required": [ 
/* ... as in Version 1.4 ... */ ], "primary_key": ["id"], "uniqueKeys": [ /* 
... as in Version 1.4 ... */ ] } ``` ### 5\. Relationships & Integrity *(No 
change from Version 1.4)* - Primary Key: `id` (BIGINT, surrogate key). - Unique 
Constraint: `uq_accommodation_room_type` on (`accommodation_waypoint_id`, 
`room_type_id`). - Foreign Keys: As defined in Version 1.4. - Mermaid ER 
Snippet: (As provided in Version 1.4 documentation). ### 6\. Multilingual 
Strategy *(No change from Version 1.4)* - `price_notes` and 
`room_specific_notes` are translatable. - Translation Management: Via 
`public.translations` table (using `id` as `row_foreign_key`) and orphan 
cleanup trigger. ### 7\. Role-Based Workflow & RLS Notes *(This section is 
updated to reflect the new auth strategy)* - Key Fields for Workflow: 
`count_of_this_room_type`, `price_amount`, `price_notes`, `room_specific_notes` 
are managed by hosts or platform content team roles. Audit fields track 
changes. - RLS Policies (Assumes `public.has_role(TEXT)` helper function 
exists): - Public Users (Read-Only for configurations of published 
accommodations): SQL ``` -- Name: Allow public read access to room 
configurations of published accommodations -- Target: 
accommodation_room_configurations -- Operation: SELECT -- Role(s): anon, 
authenticated CREATE POLICY "Allow public read access to room configurations of 
published accommodations" ON public.accommodation_room_configurations FOR 
SELECT USING ( EXISTS ( SELECT 1 FROM public.accommodations acc JOIN 
public.waypoints w ON acc.waypoint_id = w.id WHERE acc.waypoint_id = 
accommodation_room_configurations.accommodation_waypoint_id AND w.deleted_at IS 
NULL AND w.content_visibility_status_id = (SELECT cs.id FROM 
public.content_statuses_master cs WHERE cs.code = 'published' LIMIT 1) AND ( 
SELECT rtm.is_active FROM public.room_types_master rtm WHERE rtm.id = 
accommodation_room_configurations.room_type_id ) = true -- Ensure linked room 
type is active ) ); ``` - Accommodation Hosts (Manage configurations for their 
own accommodations): SQL ``` -- Name: Hosts can manage room configurations for 
their own accommodations -- Target: accommodation_room_configurations -- 
Operation: ALL -- Role(s): authenticated (checked via host_profile_id on parent 
accommodation) CREATE POLICY "Hosts can manage room configurations for their 
own accommodations" ON public.accommodation_room_configurations FOR ALL USING ( 
auth.role() = 'authenticated' AND EXISTS ( SELECT 1 FROM public.accommodations 
acc WHERE acc.waypoint_id = 
accommodation_room_configurations.accommodation_waypoint_id AND 
acc.host_profile_id = auth.uid() ) ) WITH CHECK ( auth.role() = 'authenticated' 
AND EXISTS ( SELECT 1 FROM public.accommodations acc WHERE acc.waypoint_id = 
accommodation_room_configurations.accommodation_waypoint_id AND 
acc.host_profile_id = auth.uid() ) AND (TG_OP = 'DELETE' OR 
accommodation_waypoint_id = NEW.accommodation_waypoint_id) -- Prevent 
reparenting AND (TG_OP = 'DELETE' OR TG_OP = 'UPDATE' OR ( -- For INSERT, check 
the linked room type is active SELECT rtm.is_active FROM 
public.room_types_master rtm WHERE rtm.id = NEW.room_type_id ) = true) ); ``` - 
Platform Content Team (Admins/Managers - Full control over links): SQL ``` -- 
Name: Platform content team can manage all accommodation room configurations -- 
Target: accommodation_room_configurations -- Operation: ALL -- Role(s): 
regional_content_manager, admin_platform CREATE POLICY "Platform content team 
can manage all accommodation room configurations" ON 
public.accommodation_room_configurations FOR ALL USING ( auth.role() = 
'authenticated' AND (public.has_role('regional_content_manager') OR 
public.has_role('admin_platform')) ) WITH CHECK ( auth.role() = 'authenticated' 
AND (public.has_role('regional_content_manager') OR 
public.has_role('admin_platform')) AND (TG_OP = 'DELETE' OR TG_OP = 'UPDATE' OR 
( -- For INSERT, check the linked room type is active SELECT rtm.is_active FROM 
public.room_types_master rtm WHERE rtm.id = NEW.room_type_id ) = true) ); ``` - 
Enable RLS: SQL ``` ALTER TABLE public.accommodation_room_configurations ENABLE 
ROW LEVEL SECURITY; ``` - Notes: - Public read policy now also checks if the 
linked `room_types_master.is_active = true`. - `INSERT` and `UPDATE` policies 
for hosts and admins now include a `WITH CHECK` condition to ensure links are 
only made to `active` room types. ### 8\. ENUM vs Lookup Discussion *(No change 
from Version 1.4)* - Not applicable directly. Links to `room_types_master` (a 
lookup table). ### 9\. UI/UX Enablement *(No change from Version 1.4)* - 
Detailed Room Breakdown: Fundamental for showing room types, quantities, 
prices. - Accurate Capacity Calculation: Drives 
`accommodations_capacity_summary_view`. - Pricing Clarity: `price_amount`, 
`price_currency_code`, `price_is_per_person`. - `room_specific_notes` 
(translated): For important details. ### 10\. Key Considerations & Definitions 
*(No change from Version 1.4)* - Currency Handling: `price_currency_code` is 
`NOT NULL DEFAULT 'EUR'`. - Total Capacity Calculation: Definitive source for 
`accommodations_capacity_summary_view`. - Unique Constraint: Enforces one 
configuration per room type per accommodation. ### 11\. Scalability & 
Future-Proofing *(No change from Version 1.4, existing "Future Consideration" 
point remains relevant)* - Normalized Structure: Scalable. - Pricing 
Flexibility: Separate fields allow for future multi-currency. - Parent Table 
Timestamp Updates (V2+): Consider if CUD operations here should also trigger an 
update to `accommodations.updated_at`. ### 12\. Next-Action Checklist *(No DDL 
changes required for this specific update beyond what was in V1.4, the main 
change is to the RLS policy definition in this document)* - ðŸ”´ Verify/Implement 
RLS Helper: Ensure the `public.has_role(TEXT)` helper function is correctly 
implemented and available. - ðŸ”´ Apply RLS Policies: Implement and thoroughly 
test the updated RLS policies, including the checks against 
`room_types_master.is_active`. - ðŸŸ¢ Verify Total Capacity Logic: Ensure 
`accommodations_capacity_summary_view` correctly uses this table. - ðŸŸ¢ Verify 
Currency Implementation: Confirm `price_currency_code` default and constraint. 
- ðŸŸ¢ Translation Entries: Prepare/verify English entries for `price_notes` and 
`room_specific_notes` in `public.translations`. 
