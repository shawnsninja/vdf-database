# 4a.0.1.7 - v_amenities_localized

  New View Spec: v_amenities_localized 1. View Name public.v_amenities_localized 
2. Purpose & Primary Use-Cases Purpose : To provide a consolidated and 
denormalized view of amenities_master records, including all their available 
translations for name , description , and amenity_category fields in a 
structured JSONB format, alongside all other master table attributes. Primary 
Use-Cases : Simplify API development by providing a single source for an 
amenity and all its translations. Support API endpoints that list amenities or 
display details for a specific amenity where multilingual representation is 
required (e.g., for filtering accommodations or displaying available 
amenities). Facilitate easier data fetching for frontend components that need 
to display localized amenity information. 3. View Schema (Columns) Column Data 
Type Description id integer Inherited from amenities_master . Unique identifier 
for the amenity. amenity_code text Inherited from amenities_master . Short, 
stable, machine-readable code (e.g., 'WIFI_INTERNET'). name text Inherited from 
amenities_master . Primary reference language (English) name for the amenity. 
description text Inherited from amenities_master . Optional primary reference 
language (English) description of the amenity. icon_identifier text Inherited 
from amenities_master . Name, class, or path for a UI icon. amenity_category 
text Inherited from amenities_master . Broad category for grouping amenities in 
the primary reference language (English) (e.g., "Connectivity", "Services"). 
is_common_pilgrim_need boolean Inherited from amenities_master . Flags 
amenities particularly sought after by pilgrims. sort_order integer Inherited 
from amenities_master . Determines display order in UI lists. is_active boolean 
Inherited from amenities_master . True if the amenity is active and available 
for use. created_at timestamp with time zone Inherited from amenities_master . 
Timestamp of record creation. updated_at timestamp with time zone Inherited 
from amenities_master . Timestamp of last update. created_by_profile_id uuid 
Inherited from amenities_master . Profile ID of the user/admin who created this 
record. updated_by_profile_id uuid Inherited from amenities_master . Profile ID 
of the user/admin who last updated this record. all_translations jsonb A JSONB 
object containing all available translations for name , description , and 
amenity_category , keyed by language code. Example: {"en": {"name": "...", 
"description": "...", "amenity_category": "..."}, "it": {"name": "...", 
"description": "...", "amenity_category": "..."}} . 4. Underlying SQL 
Definition SQL CREATE OR REPLACE VIEW public.v_amenities_localized AS SELECT 
am.id, am.amenity_code, am.name, -- Primary English name am.description, -- 
Primary English description am.icon_identifier, am.amenity_category, -- Primary 
English amenity_category am.is_common_pilgrim_need, am.sort_order, 
am.is_active, am.created_at, am.updated_at, am.created_by_profile_id, 
am.updated_by_profile_id, ( SELECT jsonb_object_agg( tr.language_code, 
jsonb_build_object( 'name' , MAX ( CASE WHEN tr.column_identifier = 'name' THEN 
tr.translated_text ELSE NULL END ), 'description' , MAX ( CASE WHEN 
tr.column_identifier = 'description' THEN tr.translated_text ELSE NULL END ), 
'amenity_category' , MAX ( CASE WHEN tr.column_identifier = 'amenity_category' 
THEN tr.translated_text ELSE NULL END ) ) ) FROM public.translations tr WHERE 
tr.table_identifier = 'amenities_master' AND tr.row_foreign_key = am.id::TEXT 
GROUP BY tr.row_foreign_key ) AS all_translations FROM public.amenities_master 
am; COMMENT ON VIEW public.v_amenities_localized IS 'Provides amenities with 
their base English fields and a JSONB column "all_translations" containing all 
available name, description, and amenity_category translations keyed by 
language code. Version 1.0' ; COMMENT ON COLUMN 
public.v_amenities_localized.name IS 'Primary reference language (English) name 
from amenities_master.' ; COMMENT ON COLUMN 
public.v_amenities_localized.description IS 'Primary reference language 
(English) description from amenities_master.' ; COMMENT ON COLUMN 
public.v_amenities_localized.amenity_category IS 'Primary reference language 
(English) amenity_category from amenities_master.' ; COMMENT ON COLUMN 
public.v_amenities_localized.all_translations IS 'JSONB object with all 
translations for name, description, and amenity_category, keyed by language 
code. E.g., {"en": {"name": "...", "description": "...", "amenity_category": 
"..."}, "it": {"name": "...", "description": "...", "amenity_category": 
"..."}}. Base English text from master table should be merged by 
application/API layer if not also present in translations table with code 
''en''.' ; 5. Key Dependencies public.amenities_master (Version 1.4 or later, 
which includes is_active and audit columns) public.translations (Version 2.1 or 
later) 6. Performance Considerations The subquery using jsonb_object_agg can be 
resource-intensive without proper indexing on public.translations . Required 
Index on public.translations : A composite index on ( table_identifier , 
row_foreign_key , language_code , column_identifier ) is crucial. (Assumed to 
be idx_translations_lookup_multi_col ). Queries on this view filtering by 
is_active will benefit from the idx_am_is_active index on amenities_master . 
For very high-read scenarios, a materialized view could be a V2+ optimization. 
7. RLS & Security Notes RLS policies from public.amenities_master (e.g., 
filtering by is_active = true ) will be inherited by this view. Access to 
public.translations is assumed if a user can see the master record. Define with 
SECURITY INVOKER (default for views). 8. API Endpoints Supported (Conceptual) 
GET /meta/amenities?lang=it : List all active amenities with translations. GET 
/meta/amenities/{amenity_code} : Get a specific amenity with translations. Used 
by accommodation-related endpoints to list available amenities with localized 
details. 9. Rationale for Creation Decouples API data retrieval from complex 
translation join/aggregation logic for multiple fields. Provides a consistent, 
denormalized structure for accessing localized amenity content. Improves query 
readability and maintainability for developers. 10. Key Considerations & 
Definitions Primary Language Fallback : The API/application layer needs to 
handle fallback to primary English fields if a translation for a requested 
language is not available in all_translations . Data Freshness : As a standard 
view, it reflects the current state. 11. Scalability & Future-Proofing 
Performance depends on translations table indexing. Adding new translatable 
fields to amenities_master would require updating this view definition. 12. 
Next-Action Checklist ðŸ”´ Create View : Execute the DDL to create 
public.v_amenities_localized . ðŸ”´ Verify Index on translations : Ensure the 
recommended composite index on public.translations exists. ðŸŸ  API Layer 
Integration : Plan API consumption of this view. ðŸŸ¢ Testing : Test view 
performance. ðŸŸ¢ Documentation : Document this view. 
