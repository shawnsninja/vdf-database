# 4a.0.1.8 - v_room_types_localized

  https://gemini.google.com/u/1/app/21b8e85b3e611787 New View Spec: 
v_room_types_localized 1. View Name public.v_room_types_localized 2. Purpose & 
Primary Use-Cases Purpose : To provide a consolidated and denormalized view of 
room_types_master records, including all their available translations for name 
and description fields in a structured JSONB format, alongside all other master 
table attributes. Primary Use-Cases : Simplify API development by providing a 
single source for a room type and all its translations. Support API endpoints 
that list room types or display details for a specific room type where 
multilingual representation is required (e.g., for filtering accommodations or 
displaying room details). Facilitate easier data fetching for frontend 
components that need to display localized room type information. 3. View Schema 
(Columns) Column Data Type Description id integer Inherited from 
room_types_master . Unique identifier for the room type. room_type_code text 
Inherited from room_types_master . Short, stable, machine-readable code (e.g., 
'PRIVATE_DOUBLE_ENSUITE'). name text Inherited from room_types_master . Primary 
reference language (English) name for the room type. description text Inherited 
from room_types_master . Optional primary reference language (English) 
description of the room type. typical_capacity_persons smallint Inherited from 
room_types_master . Typical number of people this room type accommodates. 
is_dorm_style boolean Inherited from room_types_master . True if this typically 
involves a bed in a shared dormitory-style room. is_private_occupancy boolean 
Inherited from room_types_master . True if this room type implies private 
occupancy for the booking party. has_private_bathroom_option boolean Inherited 
from room_types_master . Indicates if this room type can come with a private 
(ensuite) bathroom. is_entire_unit_rental boolean Inherited from 
room_types_master . True if this represents renting an entire self-contained 
unit like an apartment. sort_order integer Inherited from room_types_master . 
Determines display order in UI lists. is_active boolean Inherited from 
room_types_master . True if the room type is active and available for use. 
created_at timestamp with time zone Inherited from room_types_master . 
Timestamp of record creation. updated_at timestamp with time zone Inherited 
from room_types_master . Timestamp of last update. created_by_profile_id uuid 
Inherited from room_types_master . Profile ID of the user/admin who created 
this record. updated_by_profile_id uuid Inherited from room_types_master . 
Profile ID of the user/admin who last updated this record. all_translations 
jsonb A JSONB object containing all available translations for name and 
description , keyed by language code. Example: {"en": {"name": "...", 
"description": "..."}, "it": {"name": "...", "description": "..."}} . 4. 
Underlying SQL Definition SQL CREATE OR REPLACE VIEW 
public.v_room_types_localized AS SELECT rtm.id, rtm.room_type_code, rtm.name, 
-- Primary English name rtm.description, -- Primary English description 
rtm.typical_capacity_persons, rtm.is_dorm_style, rtm.is_private_occupancy, 
rtm.has_private_bathroom_option, rtm.is_entire_unit_rental, rtm.sort_order, 
rtm.is_active, rtm.created_at, rtm.updated_at, rtm.created_by_profile_id, 
rtm.updated_by_profile_id, ( SELECT jsonb_object_agg( tr.language_code, 
jsonb_build_object( 'name' , MAX ( CASE WHEN tr.column_identifier = 'name' THEN 
tr.translated_text ELSE NULL END ), 'description' , MAX ( CASE WHEN 
tr.column_identifier = 'description' THEN tr.translated_text ELSE NULL END ) ) 
) FROM public.translations tr WHERE tr.table_identifier = 'room_types_master' 
AND tr.row_foreign_key = rtm.id::TEXT GROUP BY tr.row_foreign_key ) AS 
all_translations FROM public.room_types_master rtm; COMMENT ON VIEW 
public.v_room_types_localized IS 'Provides room types with their base English 
fields and a JSONB column "all_translations" containing all available name and 
description translations keyed by language code. Version 1.0' ; COMMENT ON 
COLUMN public.v_room_types_localized.name IS 'Primary reference language 
(English) name from room_types_master.' ; COMMENT ON COLUMN 
public.v_room_types_localized.description IS 'Primary reference language 
(English) description from room_types_master.' ; COMMENT ON COLUMN 
public.v_room_types_localized.all_translations IS 'JSONB object with all 
translations for name and description, keyed by language code. E.g., {"en": 
{"name": "...", "description": "..."}, "it": {"name": "...", "description": 
"..."}}. Base English text from master table should be merged by 
application/API layer if not also present in translations table with code 
''en''.' ; 5. Key Dependencies public.room_types_master (Version 1.4 or later, 
which includes is_active and audit columns) public.translations (Version 2.1 or 
later) 6. Performance Considerations The subquery using jsonb_object_agg can be 
resource-intensive without proper indexing on public.translations . Required 
Index on public.translations : A composite index on ( table_identifier , 
row_foreign_key , language_code , column_identifier ) is crucial. (Assumed to 
be idx_translations_lookup_multi_col ). Queries on this view filtering by 
is_active will benefit from the idx_rtm_is_active index on room_types_master . 
For very high-read scenarios, a materialized view could be a V2+ optimization. 
7. RLS & Security Notes RLS policies from public.room_types_master (e.g., 
filtering by is_active = true ) will be inherited by this view. Access to 
public.translations is assumed if a user can see the master record. Define with 
SECURITY INVOKER (default for views). 8. API Endpoints Supported (Conceptual) 
GET /meta/room-types?lang=it : List all active room types with translations. 
GET /meta/room-types/{room_type_code} : Get a specific room type with 
translations. Used by accommodation-related endpoints to list available room 
types with localized details when showing room configurations. 9. Rationale for 
Creation Decouples API data retrieval from complex translation join/aggregation 
logic. Provides a consistent, denormalized structure for accessing localized 
room type content. Improves query readability and maintainability for 
developers. 10. Key Considerations & Definitions Primary Language Fallback : 
The API/application layer needs to handle fallback to primary English fields if 
a translation for a requested language is not available in all_translations . 
Data Freshness : As a standard view, it reflects the current state. 11. 
Scalability & Future-Proofing Performance depends on translations table 
indexing. Adding new translatable fields to room_types_master would require 
updating this view definition. 12. Next-Action Checklist ðŸ”´ Create View : 
Execute the DDL to create public.v_room_types_localized . ðŸ”´ Verify Index on 
translations : Ensure the recommended composite index on public.translations 
exists. ðŸŸ  API Layer Integration : Plan API consumption of this view. ðŸŸ¢ 
Testing : Test view performance. ðŸŸ¢ Documentation : Document this view. 
