# 4.27 accommodation_amenities

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/34bd37922031b95a 
https://gemini.google.com/u/1/app/21b8e85b3e611787 * * * * * ### 3\. Updated 
Production-Ready Specification 4.27 Accommodation Amenities Table (Version 1.4) 
------------------------------------------------ This document details the 
structure, purpose, and considerations for the `accommodation_amenities` table, 
which links accommodations to the amenities they offer. Version 1.4 updates the 
RLS policies to align with the platform-wide security and authentication 
strategy using the `public.has_role()` helper function. ### 1\. Purpose & 
Primary Use-Cases The `accommodation_amenities` table serves as a junction (or 
linking) table that creates a many-to-many relationship between accommodations 
and the amenities they offer. It allows each accommodation to be associated 
with multiple amenities from the `amenities_master` table, and for each amenity 
to be offered by multiple accommodations. It can also store context-specific 
notes about an amenity at a particular accommodation. Key user-story 
touchpoints: - Pilgrim (Anna): Viewing the specific list of amenities available 
at a chosen accommodation, along with any relevant notes (e.g., "Wi-Fi (charges 
apply)"). (Story A3) - Pilgrim (Anna): Filtering accommodations based on the 
presence of one or more specific amenities. - Accommodation Host (Marco): 
Selecting and managing the list of amenities their B&amp;B offers, and adding 
specific notes for some of them. (Story B1) - System/UI: Querying this table to 
dynamically construct the list of amenities for display on an accommodation's 
detail page. ### 2\. Schema (Markdown Table) *(No change to column structure 
from Version 1.3)* | column | data_type | constraints | description | | id | 
`uuid` | Primary Key (Default: `gen_random_uuid()`) | Unique identifier for 
this specific accommodation-amenity link. | | accommodation_waypoint_id | 
`bigint` | Not Null, Foreign Key to `accommodations(waypoint_id)` ON DELETE 
CASCADE, Part of UNIQUE constraint `uq_accommodation_amenity` | Links to the 
specific accommodation. | | amenity_id | `integer` | Not Null, Foreign Key to 
`amenities_master(id)` ON DELETE RESTRICT, Part of UNIQUE constraint 
`uq_accommodation_amenity` | Links to the specific amenity from the master 
list. RESTRICT prevents deleting a master amenity if in use. | | 
notes_on_amenity | `text` | Nullable | Specific notes about this amenity at 
this particular accommodation (e.g., "WiFi only in common areas, â‚¬2/day"). 
Primary reference language (English) text. Translatable. | | created_at | 
`timestamp with time zone` | Not Null, Default `now()` | Timestamp of when this 
specific amenity was linked to the accommodation. | | updated_at | `timestamp 
with time zone` | Not Null, Default `now()` | Timestamp of when 
`notes_on_amenity` was last updated (auto-updated by trigger). | | 
created_by_profile_id | `uuid` | Nullable, Foreign Key to `profiles(id)` ON 
DELETE SET NULL | Profile ID of the user who linked this amenity. | | 
updated_by_profile_id | `uuid` | Nullable, Foreign Key to `profiles(id)` ON 
DELETE SET NULL | Profile ID of the user who last updated the notes for this 
linked amenity. | ### 3\. PostgreSQL DDL *(DDL for table structure, comments, 
triggers, and existing indexes remain the same as Version 1.3. Only the version 
in the table comment changes.)* SQL ``` -- Assumes public.accommodations, 
public.amenities_master, public.profiles tables exist -- Assumes 
public.set_current_timestamp_updated_at() function exists -- Assumes 
public.cleanup_related_translations(TEXT, TEXT) function and specific per-table 
wrapper exist CREATE TABLE public.accommodation_amenities ( id UUID PRIMARY KEY 
DEFAULT gen_random_uuid(), accommodation_waypoint_id BIGINT NOT NULL, 
amenity_id INTEGER NOT NULL, notes_on_amenity TEXT NULL, created_at TIMESTAMPTZ 
NOT NULL DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), 
created_by_profile_id UUID NULL, updated_by_profile_id UUID NULL, CONSTRAINT 
uq_accommodation_amenity UNIQUE (accommodation_waypoint_id, amenity_id), 
CONSTRAINT fk_accommodation_waypoint FOREIGN KEY(accommodation_waypoint_id) 
REFERENCES public.accommodations(waypoint_id) ON DELETE CASCADE, CONSTRAINT 
fk_amenity FOREIGN KEY(amenity_id) REFERENCES public.amenities_master(id) ON 
DELETE RESTRICT, CONSTRAINT fk_created_by_profile FOREIGN 
KEY(created_by_profile_id) REFERENCES public.profiles(id) ON DELETE SET NULL, 
CONSTRAINT fk_updated_by_profile FOREIGN KEY(updated_by_profile_id) REFERENCES 
public.profiles(id) ON DELETE SET NULL ); COMMENT ON TABLE 
public.accommodation_amenities IS 'Junction table linking accommodations to the 
amenities they offer, with optional context-specific notes. Version 1.4'; -- 
Column comments from Version 1.3 remain unchanged. E.g.: COMMENT ON COLUMN 
public.accommodation_amenities.notes_on_amenity IS 'Specific notes about this 
amenity at this accommodation (e.g., "WiFi only in common areas, â‚¬2/day"). 
Primary reference language (English) text. Translatable via the 
''translations'' table using this record''s `id` as row_foreign_key.'; COMMENT 
ON COLUMN public.accommodation_amenities.created_by_profile_id IS 'Profile ID 
of the user who linked this amenity to the accommodation.'; COMMENT ON COLUMN 
public.accommodation_amenities.updated_by_profile_id IS 'Profile ID of the user 
who last updated the notes for this linked amenity.'; -- Trigger for updated_at 
CREATE TRIGGER trigger_accommodation_amenities_set_updated_at BEFORE UPDATE ON 
public.accommodation_amenities FOR EACH ROW WHEN (OLD.notes_on_amenity IS 
DISTINCT FROM NEW.notes_on_amenity) EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); COMMENT ON TRIGGER 
trigger_accommodation_amenities_set_updated_at ON 
public.accommodation_amenities IS 'Trigger to automatically update updated_at 
timestamp when notes_on_amenity is modified.'; -- Trigger for orphan 
translation cleanup CREATE OR REPLACE FUNCTION 
public.cleanup_accommodation_amenities_translations() RETURNS TRIGGER AS $$ 
BEGIN IF TG_OP = 'DELETE' THEN DELETE FROM public.translations WHERE 
table_identifier = 'accommodation_amenities' AND row_foreign_key = 
OLD.id::TEXT; END IF; RETURN OLD; END; $$ LANGUAGE plpgsql SECURITY DEFINER; 
CREATE TRIGGER trigger_cleanup_accommodation_amenities_translations AFTER 
DELETE ON public.accommodation_amenities FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_accommodation_amenities_translations(); COMMENT ON TRIGGER 
trigger_cleanup_accommodation_amenities_translations ON 
public.accommodation_amenities IS 'Cleans up orphaned translations from 
public.translations when an accommodation_amenities record is deleted.'; -- 
Indexes (including audit FK indexes from previous update) CREATE INDEX 
idx_accommodation_amenities_amenity_id ON 
public.accommodation_amenities(amenity_id); COMMENT ON INDEX 
public.idx_accommodation_amenities_amenity_id IS 'Index to efficiently find all 
accommodations offering a specific amenity.'; CREATE INDEX IF NOT EXISTS 
idx_aa_created_by_profile_id ON 
public.accommodation_amenities(created_by_profile_id) WHERE 
created_by_profile_id IS NOT NULL; CREATE INDEX IF NOT EXISTS 
idx_aa_updated_by_profile_id ON 
public.accommodation_amenities(updated_by_profile_id) WHERE 
updated_by_profile_id IS NOT NULL; ``` ### 4\. JSON Schema Mirror *(No change 
from Version 1.3)* JSON ``` { "title": "accommodation_amenity_link", 
"description": "Links an accommodation to a specific amenity and allows for 
context-specific notes. Version 1.4", "type": "object", "properties": { /* ... 
all properties as in Version 1.3 ... */ }, "required": [ /* ... as in Version 
1.3 ... */ ], "primary_key": ["id"], "uniqueKeys": [ /* ... as in Version 1.3 
... */ ] } ``` ### 5\. Relationships & Integrity *(No change from Version 1.3)* 
- Primary Key: `id` (UUID, surrogate key). - Unique Constraint: 
`uq_accommodation_amenity` on (`accommodation_waypoint_id`, `amenity_id`). - 
Foreign Keys: As defined in Version 1.3. - Mermaid ER Snippet: (As provided in 
Version 1.3 documentation). ### 6\. Multilingual Strategy *(No change from 
Version 1.3)* - `notes_on_amenity`: Translatable. - Translation Management: Via 
`public.translations` table (using `id` as `row_foreign_key`) and orphan 
cleanup trigger. ### 7\. Role-Based Workflow & RLS Notes *(This section is 
updated to reflect the new auth strategy)* - Key Fields for Workflow: 
`notes_on_amenity` can be updated by hosts or by platform content team roles 
who have rights to the parent accommodation. Audit fields track changes to 
these specific links. - RLS Policies (Assumes `public.has_role(TEXT)` helper 
function exists): - Public Users (Read-Only for amenities of published 
accommodations): SQL ``` -- Name: Allow public read access to amenities of 
published accommodations -- Target: accommodation_amenities -- Operation: 
SELECT -- Role(s): anon, authenticated CREATE POLICY "Allow public read access 
to amenities of published accommodations" ON public.accommodation_amenities FOR 
SELECT USING ( EXISTS ( SELECT 1 FROM public.accommodations acc JOIN 
public.waypoints w ON acc.waypoint_id = w.id WHERE acc.waypoint_id = 
accommodation_amenities.accommodation_waypoint_id AND w.deleted_at IS NULL AND 
w.content_visibility_status_id = (SELECT cs.id FROM 
public.content_statuses_master cs WHERE cs.code = 'published' LIMIT 1) AND ( 
SELECT am.is_active FROM public.amenities_master am WHERE am.id = 
accommodation_amenities.amenity_id ) = true -- Ensure linked amenity is active 
) ); ``` - Accommodation Hosts (Manage amenities for their own accommodations): 
SQL ``` -- Name: Hosts can manage amenities for their own accommodations -- 
Target: accommodation_amenities -- Operation: ALL -- Role(s): authenticated 
(checked via host_profile_id on parent accommodation) CREATE POLICY "Hosts can 
manage amenities for their own accommodations" ON 
public.accommodation_amenities FOR ALL USING ( auth.role() = 'authenticated' 
AND EXISTS ( SELECT 1 FROM public.accommodations acc WHERE acc.waypoint_id = 
accommodation_amenities.accommodation_waypoint_id AND acc.host_profile_id = 
auth.uid() ) ) WITH CHECK ( auth.role() = 'authenticated' AND EXISTS ( SELECT 1 
FROM public.accommodations acc WHERE acc.waypoint_id = 
accommodation_amenities.accommodation_waypoint_id AND acc.host_profile_id = 
auth.uid() ) AND (TG_OP = 'DELETE' OR accommodation_waypoint_id = 
NEW.accommodation_waypoint_id) -- Prevent reparenting on update/insert AND 
(TG_OP = 'DELETE' OR TG_OP = 'UPDATE' OR ( -- For INSERT, check the linked 
amenity is active SELECT am.is_active FROM public.amenities_master am WHERE 
am.id = NEW.amenity_id ) = true) ); ``` - Platform Content Team 
(Admins/Managers - Full control over links): SQL ``` -- Name: Platform content 
team can manage all accommodation amenities -- Target: accommodation_amenities 
-- Operation: ALL -- Role(s): regional_content_manager, admin_platform CREATE 
POLICY "Platform content team can manage all accommodation amenities" ON 
public.accommodation_amenities FOR ALL USING ( auth.role() = 'authenticated' 
AND (public.has_role('regional_content_manager') OR 
public.has_role('admin_platform')) ) WITH CHECK ( auth.role() = 'authenticated' 
AND (public.has_role('regional_content_manager') OR 
public.has_role('admin_platform')) AND (TG_OP = 'DELETE' OR TG_OP = 'UPDATE' OR 
( -- For INSERT, check the linked amenity is active SELECT am.is_active FROM 
public.amenities_master am WHERE am.id = NEW.amenity_id ) = true) ); ``` - 
Enable RLS: SQL ``` ALTER TABLE public.accommodation_amenities ENABLE ROW LEVEL 
SECURITY; ``` - Notes: - The public read policy now also checks if the linked 
`amenities_master.is_active = true`. - The `INSERT` and `UPDATE` policies for 
hosts and admins now include a `WITH CHECK` condition to ensure that only links 
to `active` amenities can be created or maintained (unless it's a DELETE 
operation). ### 8\. ENUM vs Lookup Discussion *(No change from Version 1.3)* - 
Not applicable directly to this table. Links to `amenities_master` (a lookup 
table). ### 9\. UI/UX Enablement *(No change from Version 1.3)* - Enables UI to 
list amenities with context-specific notes. - `amenity_id` allows joining to 
`amenities_master` for rich display. ### 10\. Key Considerations & Definitions 
*(No change from Version 1.3)* - Unique Constraint: 
`(accommodation_waypoint_id, amenity_id)` is unique. - `ON DELETE` Behavior: 
`CASCADE` from `accommodations`, `RESTRICT` to `amenities_master`. - 
`notes_on_amenity` Mutability: `updated_at` trigger is conditional. ### 11\. 
Scalability & Future-Proofing *(No change from Version 1.3, existing "Future 
Consideration" point remains relevant)* - Junction Table Standard: Scalable M-M 
pattern. - Performance: Indexes support common queries. Audit FK indexes added. 
- Parent Table Timestamp Updates (V2+): Consider if significant changes here 
should also trigger an update to `accommodations.updated_at`. ### 12\. 
Next-Action Checklist *(No DDL changes required for this specific update beyond 
what was in V1.3, the main change is to the RLS policy definition in this 
document)* - ðŸ”´ Verify/Implement RLS Helper: Ensure the `public.has_role(TEXT)` 
helper function is correctly implemented and available. - ðŸ”´ Apply RLS 
Policies: Implement and thoroughly test the updated RLS policies, including the 
checks against `amenities_master.is_active`. - ðŸŸ¢ Verify Other Aspects: Confirm 
all other aspects from Version 1.3 (triggers, translation strategy) are 
correctly implemented and tested. 
