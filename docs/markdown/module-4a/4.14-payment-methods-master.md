# 4.14 payment_methods_master

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/34bd37922031b95a 
https://gemini.google.com/u/1/app/21b8e85b3e611787 * * * * * ### 3\. Updated 
Production-Ready Specification 4.14 Payment Methods Master Table (Version 1.4) 
----------------------------------------------- This document details the 
structure, purpose, and considerations for the `payment_methods_master` table, 
which is used by both the accommodations module and is planned for use by 
`food_water_sources_details`. Version 1.4 updates the RLS policies to align 
with the platform-wide security and authentication strategy using the 
`public.has_role()` helper function. ### 1\. Purpose & Primary Use-Cases The 
`payment_methods_master` table provides a standardized list of accepted payment 
methods (e.g., "Cash (EUR)," "Visa," "Mastercard," "PayPal," "Satispay"). Its 
purpose is to allow accommodations and other commercial waypoints (like 
restaurants or shops) to clearly indicate which payment options they support, 
enabling pilgrims to plan accordingly and ensuring consistent, translatable 
terminology and associated icons. Key user-story touchpoints: - Pilgrim: 
Knowing in advance which payment methods are accepted at an accommodation or 
restaurant, especially in areas where cash might be preferred or card 
acceptance is limited. (Story A3, A4) - Pilgrim: Filtering or quickly 
identifying establishments that accept their preferred payment methods. - 
Accommodation Host/Establishment Owner: Specifying the payment methods they 
accept for their listing. (Story B1) - Admin/Content Manager: Managing the 
global list of recognized payment methods, including their active state. - 
System/UI: Displaying payment method icons and information consistently, and 
enabling related filtering using active methods. ### 2\. Schema (Markdown 
Table) *(No change to column structure from Version 1.3)* | column | data_type 
| constraints | description | | id | `integer` | Primary Key (Generated as 
identity always) | Unique identifier for the payment method. | | code | `text` 
| Unique, Not Null, CHECK (length(code) > 0 AND length(code) &lt;= 50 AND code 
~ '^[A-Z0-9_]+$') | Short, stable, machine-readable code (e.g., "CASH_EUR", 
"VISA"). Uppercase snake_case. | | label | `text` | Not Null, CHECK 
(length(label) > 0 AND length(label) &lt;= 100) | Human-readable name in the 
primary reference language (English) for UI display and as a base for 
translation. Translatable. | | description | `text` | Nullable | Optional 
description in the primary reference language (English) providing more context 
about the payment method. Translatable. | | icon_identifier | `text` | 
Nullable, CHECK (icon_identifier IS NULL OR length(icon_identifier) &lt;= 100) 
| Name, class, or path for a UI icon associated with this payment method. | | 
category | `text` | Nullable, CHECK (category IS NULL OR length(category) &lt;= 
50) | Broad category for grouping in the primary reference language (English) 
(e.g., "Cash", "Card", "Digital Wallet"). Translatable. | | sort_order | 
`integer` | Not Null, Default 0 | Determines the display order in UI lists or 
filters. | | is_active | `boolean` | Not Null, Default true | True if the 
method is active and available for use; false if retired/archived. Important 
for array FK validation. | | created_at | `timestamp with time zone` | Not 
Null, Default `now()` | Timestamp of record creation. | | updated_at | 
`timestamp with time zone` | Not Null, Default `now()` | Timestamp of last 
update (auto-updated by trigger). | | created_by_profile_id | `uuid` | 
Nullable, Foreign Key to `public.profiles(id)` ON DELETE SET NULL | Profile ID 
of the user/admin who created this payment method record. | | 
updated_by_profile_id | `uuid` | Nullable, Foreign Key to `public.profiles(id)` 
ON DELETE SET NULL | Profile ID of the user/admin who last updated this payment 
method record. | ### 3\. PostgreSQL DDL *(DDL for table structure, comments, 
triggers, and indexes remain the same as Version 1.3. Only the version in the 
table comment changes.)* SQL ``` -- Assumes public.profiles table exists -- 
Assumes public.set_current_timestamp_updated_at() function exists -- Assumes 
public.cleanup_related_translations(TEXT, TEXT) function and specific per-table 
wrapper exist CREATE TABLE public.payment_methods_master ( id INTEGER GENERATED 
ALWAYS AS IDENTITY PRIMARY KEY, code TEXT UNIQUE NOT NULL CHECK (length(code) > 
0 AND length(code) <= 50 AND code ~ '^[A-Z0-9_]+$'), label TEXT NOT NULL CHECK 
(length(label) > 0 AND length(label) <= 100), description TEXT NULL, 
icon_identifier TEXT NULL CHECK (icon_identifier IS NULL OR 
length(icon_identifier) <= 100), category TEXT NULL CHECK (category IS NULL OR 
length(category) <= 50), sort_order INTEGER NOT NULL DEFAULT 0, is_active 
BOOLEAN NOT NULL DEFAULT true, created_at TIMESTAMPTZ NOT NULL DEFAULT now(), 
updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), created_by_profile_id UUID NULL 
REFERENCES public.profiles(id) ON DELETE SET NULL, updated_by_profile_id UUID 
NULL REFERENCES public.profiles(id) ON DELETE SET NULL ); COMMENT ON TABLE 
public.payment_methods_master IS 'Master list of accepted payment methods 
(e.g., Cash, Visa, PayPal). Version 1.4'; -- Column comments from Version 1.3 
remain unchanged. E.g.: COMMENT ON COLUMN public.payment_methods_master.label 
IS 'Human-readable name in the primary reference language (English) for UI and 
as a base for translation. Translatable via the ''translations'' table. Max 100 
chars.'; COMMENT ON COLUMN public.payment_methods_master.category IS 'Broad 
category for grouping in the primary reference language (English) (e.g., 
"Card", "Digital Wallet"). Translatable via the ''translations'' table. Max 50 
chars.'; COMMENT ON COLUMN public.payment_methods_master.is_active IS 'True if 
the method is active and available for use; false if retired. Important for 
array FK validation.'; COMMENT ON COLUMN 
public.payment_methods_master.created_by_profile_id IS 'Profile ID of the 
user/admin who created this record.'; COMMENT ON COLUMN 
public.payment_methods_master.updated_by_profile_id IS 'Profile ID of the 
user/admin who last updated this record.'; -- Indexes (including idx_pmm_label 
from previous update) CREATE INDEX IF NOT EXISTS idx_pmm_is_active ON 
public.payment_methods_master(is_active); CREATE INDEX IF NOT EXISTS 
idx_pmm_sort_order ON public.payment_methods_master(sort_order); CREATE INDEX 
IF NOT EXISTS idx_pmm_category ON public.payment_methods_master(category) WHERE 
category IS NOT NULL; CREATE INDEX IF NOT EXISTS idx_pmm_label ON 
public.payment_methods_master(label); CREATE INDEX IF NOT EXISTS 
idx_pmm_created_by_profile_id ON 
public.payment_methods_master(created_by_profile_id) WHERE 
created_by_profile_id IS NOT NULL; CREATE INDEX IF NOT EXISTS 
idx_pmm_updated_by_profile_id ON 
public.payment_methods_master(updated_by_profile_id) WHERE 
updated_by_profile_id IS NOT NULL; -- Trigger for updated_at CREATE TRIGGER 
trigger_payment_methods_master_set_updated_at BEFORE UPDATE ON 
public.payment_methods_master FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); COMMENT ON TRIGGER 
trigger_payment_methods_master_set_updated_at ON public.payment_methods_master 
IS 'Trigger to automatically update updated_at timestamp on row modification.'; 
-- Trigger for orphan translation cleanup CREATE OR REPLACE FUNCTION 
public.cleanup_payment_methods_master_translations() RETURNS TRIGGER AS $$ 
BEGIN IF TG_OP = 'DELETE' THEN DELETE FROM public.translations WHERE 
table_identifier = 'payment_methods_master' AND row_foreign_key = OLD.id::TEXT; 
END IF; RETURN OLD; END; $$ LANGUAGE plpgsql SECURITY DEFINER; CREATE TRIGGER 
trigger_cleanup_payment_methods_master_translations AFTER DELETE ON 
public.payment_methods_master FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_payment_methods_master_translations(); COMMENT ON TRIGGER 
trigger_cleanup_payment_methods_master_translations ON 
public.payment_methods_master IS 'Cleans up orphaned translations from 
public.translations when a payment_methods_master record is deleted.'; -- 
Initial Data Example (ensure created_by_profile_id and updated_by_profile_id 
are set appropriately for seed data) INSERT INTO public.payment_methods_master 
(code, label, icon_identifier, category, sort_order, description, is_active, 
created_by_profile_id, updated_by_profile_id) VALUES ('CASH_EUR', 'Cash (EUR)', 
'icon-cash-eur', 'Cash', 10, 'Payment in Euro currency notes and coins.', true, 
NULL, NULL), ('VISA', 'Visa', 'icon-visa', 'Card', 20, 'Visa credit or debit 
cards accepted.', true, NULL, NULL), -- ... other seed data from V1.3 ... 
('OTHER_DIGITAL', 'Other Digital Payment', 'icon-other-digital', 'Digital 
Wallet', 120, 'Accepts other types of digital or mobile payments.', true, NULL, 
NULL); ``` ### 4\. JSON Schema Mirror *(No change from Version 1.3)* JSON ``` { 
"title": "payment_method_master", "description": "Master list of accepted 
payment methods. Version 1.4", "type": "object", "properties": { "id": { /* ... 
*/ }, "code": { /* ... */ }, "label": { /* ... */ }, "description": { /* ... */ 
}, "icon_identifier": { /* ... */ }, "category": { /* ... */ }, "sort_order": { 
/* ... */ }, "is_active": { /* ... */ }, "created_at": { /* ... */ }, 
"updated_at": { /* ... */ }, "created_by_profile_id": { /* ... */ }, 
"updated_by_profile_id": { /* ... */ } }, "required": [ /* ... */ ] } ``` ### 
5\. Relationships & Integrity *(No change from Version 1.3)* - Primary Key: 
`id` (INTEGER) - Unique Constraint: `code` must be unique. - Foreign Key 
References FROM other tables: - 
`accommodation_payment_methods.payment_method_id` REFERENCES 
`public.payment_methods_master(id)` (ON DELETE RESTRICT). - 
`food_water_sources_details.payment_method_tag_ids` (an `INTEGER[]` column) 
will contain IDs that reference `payment_methods_master.id`. - Foreign Key 
References TO other tables: - `created_by_profile_id` REFERENCES 
`public.profiles(id)` ON DELETE SET NULL. - `updated_by_profile_id` REFERENCES 
`public.profiles(id)` ON DELETE SET NULL. - Data Integrity Notes: - 🔴 
CRITICAL: Array FK validation triggers on referencing tables (like 
`food_water_sources_details`) must check `payment_methods_master.is_active = 
true`. - Retiring a payment method should be done by setting `is_active = 
false`. ### 6\. Multilingual Strategy *(No change from Version 1.3)* - 
Translatable Fields: `label`, `description`, `category`. - Translation 
Management: Via `public.translations` table and orphan cleanup trigger. ### 7\. 
Role-Based Workflow & RLS Notes *(This section is updated to reflect the new 
auth strategy)* - Content Management: This table is typically managed by users 
with the `admin_platform` role. - Lifecycle: Payment methods are made inactive 
by setting `is_active = false`. Physical deletion should be rare and is 
restricted if in use by `accommodation_payment_methods`. - RLS Policies 
(Assumes `public.has_role(TEXT)` helper function exists): - Public Users 
(Read-Only on active methods): SQL ``` -- Name: Allow public read access to 
active payment methods -- Target: payment_methods_master -- Operation: SELECT 
-- Role(s): anon, authenticated CREATE POLICY "Allow public read access to 
active payment methods" ON public.payment_methods_master FOR SELECT USING 
(is_active = true); ``` - Platform Administrators (Full Control): SQL ``` -- 
Name: Allow platform administrators to manage payment methods -- Target: 
payment_methods_master -- Operation: ALL -- Role(s): admin_platform CREATE 
POLICY "Allow platform administrators to manage payment methods" ON 
public.payment_methods_master FOR ALL USING ( auth.role() = 'authenticated' AND 
public.has_role('admin_platform') ) WITH CHECK ( auth.role() = 'authenticated' 
AND public.has_role('admin_platform') ); ``` - Enable RLS: SQL ``` ALTER TABLE 
public.payment_methods_master ENABLE ROW LEVEL SECURITY; ``` - Notes: RLS must 
filter by `is_active = true` for general read access. Array FK validation on 
other tables must also check `is_active = true`. ### 8\. ENUM vs Lookup 
Discussion *(No change from Version 1.3)* - 🟢 Decision: Correctly a lookup 
table. - Reasoning: Translatable fields, icon association, categorization, 
auditability, lifecycle. ### 9\. UI/UX Enablement *(No change from Version 
1.3)* - `label` (translated): For displaying accepted payment methods. - 
`icon_identifier`: To show logos/icons. - `category` (translated): For 
grouping. - `sort_order`: To list common methods first. - `is_active`: UI 
should only use active methods. ### 10\. Key Considerations & Definitions *(No 
change from Version 1.3)* - Global vs. Regional Methods: Include common 
international and relevant regional ones. - Icon Sourcing: Needed for 
`icon_identifier`. - Specificity: E.g., `CASH_EUR`. - Array FK Integrity: 
Referencing table's trigger logic must check `is_active = true`. ### 11\. 
Scalability & Future-Proofing *(No change from Version 1.3)* - Manageable List: 
Number of common payment methods is manageable. - Flexibility: Easy to add new 
payment methods. `category` aids grouping. - Audit Fields & `is_active` flag: 
Robust. ### 12\. Next-Action Checklist *(No DDL changes required for this 
specific update beyond what was in V1.3, the main change is to the RLS policy 
definition in this document)* - 🔴 Verify/Implement RLS Helper: Ensure the 
`public.has_role(TEXT)` helper function is correctly implemented and available. 
- 🔴 Apply RLS Policies: Implement and thoroughly test the updated RLS 
policies. - 🔴 Initial Population/Seed Data: Ensure 
`created_by_profile_id`/`updated_by_profile_id` are correctly set for seed 
data. - 🟠 Array FK Integrity: Ensure validation trigger on 
`food_water_sources_details` (for `payment_method_tag_ids`) checks `is_active = 
true` in this table. - 🟢 Icon Set Development: Coordinate with UI/UX team. - 
🟢 Translation Entries: Prepare/verify English entries for `label`, 
`description`, and `category` in `public.translations`. 
