# 4.30 accommodation_payment_methods

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/34bd37922031b95a 
https://gemini.google.com/u/1/app/21b8e85b3e611787 * * * * * ### 3\. Updated 
Production-Ready Specification 4.30 Accommodation Payment Methods Table 
(Version 1.4) ------------------------------------------------------ This 
document details the structure, purpose, and considerations for the 
`accommodation_payment_methods` table, which links accommodations to the 
payment methods they accept. Version 1.4 updates the RLS policies to align with 
the platform-wide security and authentication strategy using the 
`public.has_role()` helper function and checks for active master data. ### 1\. 
Purpose & Primary Use-Cases The `accommodation_payment_methods` table serves as 
a junction (linking) table to establish a many-to-many relationship between 
accommodations and the payment methods they accept (defined in 
`payment_methods_master`). It allows each accommodation to list multiple 
accepted payment methods and provides a space for specific notes regarding a 
payment method at that particular location. Key user-story touchpoints: - 
Pilgrim (Anna): Seeing a clear list of accepted payment methods (e.g., "Cash," 
"Visa," "PayPal") for an accommodation, potentially with icons and specific 
notes like "Visa accepted for amounts over â‚¬20." (Story A3) - Pilgrim (Anna): 
Filtering accommodations based on whether they accept specific payment types 
(e.g., credit cards). - Accommodation Host (Marco): Selecting which payment 
methods their establishment accepts and adding any relevant conditions or notes 
for each. (Story B1) - System/UI: Dynamically querying and displaying the 
accepted payment methods for each accommodation. ### 2\. Schema (Markdown 
Table) *(No change to column structure from Version 1.3)* | column | data_type 
| constraints | description | | id | `uuid` | Primary Key (Default: 
`gen_random_uuid()`) | Unique identifier for this specific 
accommodation-payment method link. | | accommodation_waypoint_id | `bigint` | 
Not Null, Foreign Key to `accommodations(waypoint_id)` ON DELETE CASCADE, Part 
of UNIQUE constraint `uq_accommodation_payment_method` | Links to the specific 
accommodation. | | payment_method_id | `integer` | Not Null, Foreign Key to 
`payment_methods_master(id)` ON DELETE RESTRICT, Part of UNIQUE constraint 
`uq_accommodation_payment_method` | Links to the specific payment method from 
the master list. RESTRICT prevents deleting a master method if in use. | | 
notes_on_method | `text` | Nullable | Specific notes for this payment method at 
this particular accommodation. Primary reference language (English) text. 
Translatable. | | created_at | `timestamp with time zone` | Not Null, Default 
`now()` | Timestamp of when this payment method was linked to the 
accommodation. | | updated_at | `timestamp with time zone` | Not Null, Default 
`now()` | Timestamp of when `notes_on_method` was last updated (auto-updated by 
trigger). | | created_by_profile_id | `uuid` | Nullable, Foreign Key to 
`profiles(id)` ON DELETE SET NULL | Profile ID of the user who linked this 
payment method. | | updated_by_profile_id | `uuid` | Nullable, Foreign Key to 
`profiles(id)` ON DELETE SET NULL | Profile ID of the user who last updated the 
notes for this linked payment method. | ### 3\. PostgreSQL DDL *(DDL for table 
structure, comments, triggers, and existing indexes remain the same as Version 
1.3. Only the version in the table comment changes.)* SQL ``` -- Assumes 
public.accommodations, public.payment_methods_master, public.profiles tables 
exist -- Assumes public.set_current_timestamp_updated_at() function exists -- 
Assumes public.cleanup_related_translations(TEXT, TEXT) function and specific 
per-table wrapper exist CREATE TABLE public.accommodation_payment_methods ( id 
UUID PRIMARY KEY DEFAULT gen_random_uuid(), accommodation_waypoint_id BIGINT 
NOT NULL, payment_method_id INTEGER NOT NULL, notes_on_method TEXT NULL, 
created_at TIMESTAMPTZ NOT NULL DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL 
DEFAULT now(), created_by_profile_id UUID NULL, updated_by_profile_id UUID 
NULL, CONSTRAINT uq_accommodation_payment_method UNIQUE 
(accommodation_waypoint_id, payment_method_id), CONSTRAINT 
fk_accommodation_waypoint FOREIGN KEY(accommodation_waypoint_id) REFERENCES 
public.accommodations(waypoint_id) ON DELETE CASCADE, CONSTRAINT 
fk_payment_method FOREIGN KEY(payment_method_id) REFERENCES 
public.payment_methods_master(id) ON DELETE RESTRICT, CONSTRAINT 
fk_created_by_profile FOREIGN KEY(created_by_profile_id) REFERENCES 
public.profiles(id) ON DELETE SET NULL, CONSTRAINT fk_updated_by_profile 
FOREIGN KEY(updated_by_profile_id) REFERENCES public.profiles(id) ON DELETE SET 
NULL ); COMMENT ON TABLE public.accommodation_payment_methods IS 'Junction 
table linking accommodations to the payment methods they accept, with optional 
context-specific notes. Version 1.4'; -- Column comments from Version 1.3 
remain unchanged. E.g.: COMMENT ON COLUMN 
public.accommodation_payment_methods.notes_on_method IS 'Specific notes for 
this payment method at this accommodation. Primary reference language (English) 
text. Translatable via the ''translations'' table using this record''s `id` as 
row_foreign_key.'; COMMENT ON COLUMN 
public.accommodation_payment_methods.created_by_profile_id IS 'Profile ID of 
the user who linked this payment method.'; COMMENT ON COLUMN 
public.accommodation_payment_methods.updated_by_profile_id IS 'Profile ID of 
the user who last updated notes for this link.'; -- Trigger for updated_at 
CREATE TRIGGER trigger_accommodation_payment_methods_set_updated_at BEFORE 
UPDATE ON public.accommodation_payment_methods FOR EACH ROW WHEN 
(OLD.notes_on_method IS DISTINCT FROM NEW.notes_on_method) EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); COMMENT ON TRIGGER 
trigger_accommodation_payment_methods_set_updated_at ON 
public.accommodation_payment_methods IS 'Trigger to automatically update 
updated_at timestamp when notes_on_method is modified.'; -- Trigger for orphan 
translation cleanup CREATE OR REPLACE FUNCTION 
public.cleanup_accommodation_payment_methods_translations() RETURNS TRIGGER AS 
$$ BEGIN IF TG_OP = 'DELETE' THEN DELETE FROM public.translations WHERE 
table_identifier = 'accommodation_payment_methods' AND row_foreign_key = 
OLD.id::TEXT; END IF; RETURN OLD; END; $$ LANGUAGE plpgsql SECURITY DEFINER; 
CREATE TRIGGER trigger_cleanup_accommodation_payment_methods_translations AFTER 
DELETE ON public.accommodation_payment_methods FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_accommodation_payment_methods_translations(); COMMENT ON TRIGGER 
trigger_cleanup_accommodation_payment_methods_translations ON 
public.accommodation_payment_methods IS 'Cleans up orphaned translations from 
public.translations when an accommodation_payment_methods record is deleted.'; 
-- Indexes (including audit FK indexes from previous update) CREATE INDEX 
idx_acc_payment_methods_payment_method_id ON 
public.accommodation_payment_methods(payment_method_id); COMMENT ON INDEX 
public.idx_acc_payment_methods_payment_method_id IS 'Index to efficiently find 
all accommodations accepting a specific payment method.'; CREATE INDEX IF NOT 
EXISTS idx_apm_created_by_profile_id ON 
public.accommodation_payment_methods(created_by_profile_id) WHERE 
created_by_profile_id IS NOT NULL; CREATE INDEX IF NOT EXISTS 
idx_apm_updated_by_profile_id ON 
public.accommodation_payment_methods(updated_by_profile_id) WHERE 
updated_by_profile_id IS NOT NULL; ``` ### 4\. JSON Schema Mirror *(No change 
from Version 1.3)* JSON ``` { "title": "accommodation_payment_method_link", 
"description": "Links an accommodation to a specific payment method they accept 
and allows for context-specific notes. Version 1.4", "type": "object", 
"properties": { /* ... all properties as in Version 1.3 ... */ }, "required": [ 
/* ... as in Version 1.3 ... */ ], "primary_key": ["id"], "uniqueKeys": [ /* 
... as in Version 1.3 ... */ ] } ``` ### 5\. Relationships & Integrity *(No 
change from Version 1.3)* - Primary Key: `id` (UUID, surrogate key). - Unique 
Constraint: `uq_accommodation_payment_method` on (`accommodation_waypoint_id`, 
`payment_method_id`). - Foreign Keys: As defined in Version 1.3. - Mermaid ER 
Snippet: (As provided in Version 1.3 documentation). ### 6\. Multilingual 
Strategy *(No change from Version 1.3)* - `notes_on_method`: Translatable. - 
Translation Management: Via `public.translations` table (using `id` as 
`row_foreign_key`) and orphan cleanup trigger. ### 7\. Role-Based Workflow & 
RLS Notes *(This section is updated to reflect the new auth strategy)* - Key 
Fields for Workflow: `notes_on_method` can be updated by hosts or by platform 
content team roles who have rights to the parent accommodation. Audit fields 
track these specific link changes. - RLS Policies (Assumes 
`public.has_role(TEXT)` helper function exists): - Public Users (Read-Only for 
payment methods of published accommodations): SQL ``` -- Name: Allow public 
read access to payment methods of published accommodations -- Target: 
accommodation_payment_methods -- Operation: SELECT -- Role(s): anon, 
authenticated CREATE POLICY "Allow public read access to payment methods of 
published accommodations" ON public.accommodation_payment_methods FOR SELECT 
USING ( EXISTS ( SELECT 1 FROM public.accommodations acc JOIN public.waypoints 
w ON acc.waypoint_id = w.id WHERE acc.waypoint_id = 
accommodation_payment_methods.accommodation_waypoint_id AND w.deleted_at IS 
NULL AND w.content_visibility_status_id = (SELECT cs.id FROM 
public.content_statuses_master cs WHERE cs.code = 'published' LIMIT 1) AND ( 
SELECT pmm.is_active FROM public.payment_methods_master pmm WHERE pmm.id = 
accommodation_payment_methods.payment_method_id ) = true -- Ensure linked 
payment method is active ) ); ``` - Accommodation Hosts (Manage payment methods 
for their own accommodations): SQL ``` -- Name: Hosts can manage payment 
methods for their own accommodations -- Target: accommodation_payment_methods 
-- Operation: ALL -- Role(s): authenticated (checked via host_profile_id on 
parent accommodation) CREATE POLICY "Hosts can manage payment methods for their 
own accommodations" ON public.accommodation_payment_methods FOR ALL USING ( 
auth.role() = 'authenticated' AND EXISTS ( SELECT 1 FROM public.accommodations 
acc WHERE acc.waypoint_id = 
accommodation_payment_methods.accommodation_waypoint_id AND acc.host_profile_id 
= auth.uid() ) ) WITH CHECK ( auth.role() = 'authenticated' AND EXISTS ( SELECT 
1 FROM public.accommodations acc WHERE acc.waypoint_id = 
accommodation_payment_methods.accommodation_waypoint_id AND acc.host_profile_id 
= auth.uid() ) AND (TG_OP = 'DELETE' OR accommodation_waypoint_id = 
NEW.accommodation_waypoint_id) -- Prevent reparenting AND (TG_OP = 'DELETE' OR 
TG_OP = 'UPDATE' OR ( -- For INSERT, check the linked payment method is active 
SELECT pmm.is_active FROM public.payment_methods_master pmm WHERE pmm.id = 
NEW.payment_method_id ) = true) ); ``` - Platform Content Team (Admins/Managers 
- Full control over links): SQL ``` -- Name: Platform content team can manage 
all accommodation payment methods -- Target: accommodation_payment_methods -- 
Operation: ALL -- Role(s): regional_content_manager, admin_platform CREATE 
POLICY "Platform content team can manage all accommodation payment methods" ON 
public.accommodation_payment_methods FOR ALL USING ( auth.role() = 
'authenticated' AND (public.has_role('regional_content_manager') OR 
public.has_role('admin_platform')) ) WITH CHECK ( auth.role() = 'authenticated' 
AND (public.has_role('regional_content_manager') OR 
public.has_role('admin_platform')) AND (TG_OP = 'DELETE' OR TG_OP = 'UPDATE' OR 
( -- For INSERT, check the linked payment method is active SELECT pmm.is_active 
FROM public.payment_methods_master pmm WHERE pmm.id = NEW.payment_method_id ) = 
true) ); ``` - Enable RLS: SQL ``` ALTER TABLE 
public.accommodation_payment_methods ENABLE ROW LEVEL SECURITY; ``` - Notes: - 
Public read policy now also checks if the linked 
`payment_methods_master.is_active = true`. - `INSERT` and `UPDATE` policies for 
hosts and admins now include a `WITH CHECK` condition to ensure links are only 
made to `active` payment methods. ### 8\. ENUM vs Lookup Discussion *(No change 
from Version 1.3)* - Not applicable directly to this linking table. Links to 
`payment_methods_master` (a lookup table). ### 9\. UI/UX Enablement *(No change 
from Version 1.3)* - Enables UI to list accepted payment methods with 
context-specific notes. ### 10\. Key Considerations & Definitions *(No change 
from Version 1.3)* - `ON DELETE RESTRICT` for `payment_method_id`: Important. - 
Translation of `notes_on_method`: Using surrogate `id` for `row_foreign_key`. 
### 11\. Scalability & Future-Proofing *(No change from Version 1.3, existing 
"Future Consideration" point remains relevant)* - Standard Junction Table: 
Scalable M-M pattern. - Flexibility: `notes_on_method` covers most V1 cases. - 
Parent Table Timestamp Updates (V2+): Consider if CUD operations here should 
also trigger an update to `accommodations.updated_at`. ### 12\. Next-Action 
Checklist *(No DDL changes required for this specific update beyond what was in 
V1.3, the main change is to the RLS policy definition in this document)* - ðŸ”´ 
Verify/Implement RLS Helper: Ensure the `public.has_role(TEXT)` helper function 
is correctly implemented and available. - ðŸ”´ Apply RLS Policies: Implement and 
thoroughly test the updated RLS policies, including the checks against 
`payment_methods_master.is_active`. - ðŸŸ¢ Verify Other Aspects: Confirm all 
other aspects from Version 1.3 (triggers, host RLS, translation strategy) are 
correctly implemented and tested. 
