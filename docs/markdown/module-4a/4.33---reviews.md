# 4.33 - reviews

  https://gemini.google.com/u/1/app/21b8e85b3e611787 New Table: 
public.accommodation_reviews (Version 1.0) (Module 6: User Interaction; closely 
related to Module 4a: Accommodations) 1. Purpose & Primary Use-Cases The 
public.accommodation_reviews table stores user-submitted reviews specifically 
for accommodations. It allows pilgrims to share their experiences, including 
textual feedback, an optional overall vote, and the date of their stay. The 
table supports multilingual content, moderation workflows, and audit trails. 
Key user-story touchpoints: Pilgrim (Anna): Reading reviews for an 
accommodation to help make lodging choices. Pilgrim (Anna): Submitting a review 
of an accommodation where they stayed. Accommodation Host (Marco): 
(Potentially, V2+) Viewing reviews for their establishment. Platform 
Administrator/Moderator (Sofia): Reviewing and approving/rejecting submitted 
reviews. System/UI: Displaying approved reviews on accommodation detail pages. 
2. Schema (Markdown Table) column data_type constraints description id bigint 
Primary Key, Generated always as identity Unique identifier for the review. 
accommodation_waypoint_id bigint Not Null, Foreign Key to 
public.accommodations(waypoint_id) ON DELETE CASCADE Links to the specific 
accommodation being reviewed. profile_id uuid Not Null, Foreign Key to 
public.profiles(id) ON DELETE CASCADE Author of the review (implicitly the 
creator of the content). review_title text Nullable, CHECK 
(char_length(review_title) &lt;= 255) Optional title for the review. 
(Translatable via public.translations ) review_body text Not Null, CHECK 
(char_length(review_body) > 0 AND char_length(review_body) &lt;= 2000) The main 
content of the review. (Translatable via public.translations ) language_code 
text Not Null, Foreign Key to public.languages_master(language_code) ON DELETE 
RESTRICT Language the review was originally written in. stay_date date Nullable 
Optional: Date when the pilgrim stayed at the accommodation. overall_vote 
public.vote_type_enum Nullable Optional: A simple overall vote (e.g., 'up', 
'down') for the stay. (Assumes vote_type_enum exists from Module 6). 
moderation_status public.content_moderation_status_enum Not Null, Default 
'pending_approval' Moderation status of the review (e.g., 'pending_approval', 
'approved_visible', 'rejected'). (Assumes content_moderation_status_enum exists 
from Module 6). is_publicly_visible boolean Not Null, Generated always as ( 
moderation_status = 'approved_visible' AND deleted_at IS NULL) STORED 
Auto-calculated flag indicating if the review should be visible to the public. 
(Requires PostgreSQL 12+) moderated_by_profile_id uuid Nullable, Foreign Key to 
public.profiles(id) ON DELETE SET NULL Profile ID of the admin/moderator who 
actioned this review. moderation_timestamp timestamp with time zone Nullable 
Timestamp of when the moderation action was taken. moderation_notes_internal 
text Nullable Internal notes for moderation team regarding this review. 
created_at timestamp with time zone Not Null, Default now() Timestamp of when 
this review record was created. updated_at timestamp with time zone Not Null, 
Default now() Timestamp of when this review record was last updated 
(auto-updated by trigger). updated_by_profile_id uuid Nullable, Foreign Key to 
public.profiles(id) ON DELETE SET NULL Profile ID of the user/admin who last 
updated this review row (e.g., user editing their own review if allowed, or 
admin edit). deleted_at timestamp with time zone Nullable Timestamp for soft 
deletion by user or admin. Reviews with deleted_at set are not publicly 
visible. (Assumes public.vote_type_enum and 
public.content_moderation_status_enum are globally defined or defined within 
Module 6 as per 4.x todos.docx ) 3. PostgreSQL DDL SQL -- Assumes ENUM types 
public.vote_type_enum and public.content_moderation_status_enum exist. -- 
Assumes public.accommodations, public.profiles, public.languages_master tables 
exist. -- Assumes public.set_current_timestamp_updated_at() function exists. -- 
Assumes public.cleanup_related_translations(TEXT, TEXT) function exists for the 
AFTER DELETE trigger. CREATE TABLE public.accommodation_reviews ( id BIGINT 
GENERATED ALWAYS AS IDENTITY PRIMARY KEY, accommodation_waypoint_id BIGINT NOT 
NULL REFERENCES public.accommodations(waypoint_id) ON DELETE CASCADE, 
profile_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE, 
review_title TEXT NULL CHECK ( char_length (review_title) <= 255 ), review_body 
TEXT NOT NULL CHECK ( char_length (review_body) > 0 AND char_length 
(review_body) <= 2000 ), language_code TEXT NOT NULL REFERENCES 
public.languages_master(language_code) ON DELETE RESTRICT, stay_date DATE NULL 
, overall_vote public.vote_type_enum NULL , moderation_status 
public.content_moderation_status_enum NOT NULL DEFAULT 'pending_approval' , 
is_publicly_visible BOOLEAN NOT NULL GENERATED ALWAYS AS (moderation_status = 
'approved_visible' AND deleted_at IS NULL ) STORED, moderated_by_profile_id 
UUID NULL REFERENCES public.profiles(id) ON DELETE SET NULL , 
moderation_timestamp TIMESTAMPTZ NULL , moderation_notes_internal TEXT NULL , 
created_at TIMESTAMPTZ NOT NULL DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL 
DEFAULT now(), updated_by_profile_id UUID NULL REFERENCES public.profiles(id) 
ON DELETE SET NULL , deleted_at TIMESTAMPTZ NULL ); COMMENT ON TABLE 
public.accommodation_reviews IS 'Stores user-submitted reviews for 
accommodations, including text, ratings, and moderation status. Version 1.0' ; 
COMMENT ON COLUMN public.accommodation_reviews.id IS 'Unique identifier for the 
review.' ; COMMENT ON COLUMN 
public.accommodation_reviews.accommodation_waypoint_id IS 'FK to 
accommodations.waypoint_id. Links to the specific accommodation being 
reviewed.' ; COMMENT ON COLUMN public.accommodation_reviews.profile_id IS 'FK 
to profiles.id. Author of the review (implicitly the creator of the content).' 
; COMMENT ON COLUMN public.accommodation_reviews.review_title IS 'Optional 
title for the review. (Translatable via public.translations)' ; COMMENT ON 
COLUMN public.accommodation_reviews.review_body IS 'The main content of the 
review. (Translatable via public.translations)' ; COMMENT ON COLUMN 
public.accommodation_reviews.language_code IS 'FK to 
languages_master.language_code. Language the review was originally written in.' 
; COMMENT ON COLUMN public.accommodation_reviews.stay_date IS 'Optional: Date 
when the pilgrim stayed at the accommodation.' ; COMMENT ON COLUMN 
public.accommodation_reviews.overall_vote IS 'Optional: A simple overall vote 
(e.g., ''up'', ''down'') for the stay. Uses public.vote_type_enum.' ; COMMENT 
ON COLUMN public.accommodation_reviews.moderation_status IS 'Moderation status 
of the review. Uses public.content_moderation_status_enum.' ; COMMENT ON COLUMN 
public.accommodation_reviews.is_publicly_visible IS 'Auto-calculated flag: TRUE 
if moderation_status is ''approved_visible'' AND deleted_at IS NULL.' ; COMMENT 
ON COLUMN public.accommodation_reviews.moderated_by_profile_id IS 'FK to 
profiles.id. Admin/moderator who actioned this review.' ; COMMENT ON COLUMN 
public.accommodation_reviews.moderation_timestamp IS 'Timestamp of when the 
moderation action was taken.' ; COMMENT ON COLUMN 
public.accommodation_reviews.moderation_notes_internal IS 'Internal notes for 
moderation team regarding this review.' ; COMMENT ON COLUMN 
public.accommodation_reviews.created_at IS 'Timestamp of when this review 
record was created.' ; COMMENT ON COLUMN 
public.accommodation_reviews.updated_at IS 'Timestamp of when this review 
record was last updated (auto-updated by trigger).' ; COMMENT ON COLUMN 
public.accommodation_reviews.updated_by_profile_id IS 'FK to profiles.id. 
User/admin who last updated this review row.' ; COMMENT ON COLUMN 
public.accommodation_reviews.deleted_at IS 'Timestamp for soft deletion. 
Reviews with deleted_at set are not publicly visible.' ; -- Indexes CREATE 
INDEX idx_accommodation_reviews_accommodation_waypoint_id ON 
public.accommodation_reviews(accommodation_waypoint_id); CREATE INDEX 
idx_accommodation_reviews_profile_id ON 
public.accommodation_reviews(profile_id); CREATE INDEX 
idx_accommodation_reviews_language_code ON 
public.accommodation_reviews(language_code); CREATE INDEX 
idx_accommodation_reviews_moderation_status ON 
public.accommodation_reviews(moderation_status); CREATE INDEX 
idx_accommodation_reviews_is_publicly_visible ON 
public.accommodation_reviews(is_publicly_visible) WHERE is_publicly_visible = 
true ; CREATE INDEX idx_accommodation_reviews_stay_date ON 
public.accommodation_reviews(stay_date) WHERE stay_date IS NOT NULL ; CREATE 
INDEX idx_accommodation_reviews_moderated_by_profile_id ON 
public.accommodation_reviews(moderated_by_profile_id) WHERE 
moderated_by_profile_id IS NOT NULL ; CREATE INDEX 
idx_accommodation_reviews_updated_by_profile_id ON 
public.accommodation_reviews(updated_by_profile_id) WHERE updated_by_profile_id 
IS NOT NULL ; CREATE INDEX idx_accommodation_reviews_deleted_at ON 
public.accommodation_reviews(deleted_at) WHERE deleted_at IS NOT NULL ; -- 
Trigger for updated_at CREATE TRIGGER 
trigger_accommodation_reviews_set_updated_at BEFORE UPDATE ON 
public.accommodation_reviews FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); -- Or extensions.moddatetime COMMENT 
ON TRIGGER trigger_accommodation_reviews_set_updated_at ON 
public.accommodation_reviews IS 'Trigger to automatically update updated_at 
timestamp on row modification.' ; -- Trigger for orphan translation cleanup 
CREATE OR REPLACE FUNCTION public.cleanup_accommodation_reviews_translations() 
RETURNS TRIGGER AS $$ BEGIN IF TG_OP = 'DELETE' THEN DELETE FROM 
public.translations WHERE table_identifier = 'accommodation_reviews' AND 
row_foreign_key = OLD.id::TEXT; -- Using BIGINT PK for translation key END IF; 
RETURN OLD ; END ; $$ LANGUAGE plpgsql SECURITY DEFINER; CREATE TRIGGER 
trigger_cleanup_accommodation_reviews_translations AFTER DELETE ON 
public.accommodation_reviews FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_accommodation_reviews_translations(); COMMENT ON TRIGGER 
trigger_cleanup_accommodation_reviews_translations ON 
public.accommodation_reviews IS 'Cleans up orphaned translations from 
public.translations when an accommodation_reviews record is deleted.' ; 4. JSON 
Schema Mirror JSON { "title" : "accommodation_review" , "description" : "Stores 
user-submitted reviews for accommodations. Version 1.0" , "type" : "object" , 
"properties" : { "id" : { "type" : "integer" , "format" : "int64" , 
"description" : "Unique identifier for the review. PK." , "readOnly" : true }, 
"accommodation_waypoint_id" : { "type" : "integer" , "format" : "int64" , 
"description" : "FK to accommodations.waypoint_id." }, "profile_id" : { "type" 
: "string" , "format" : "uuid" , "description" : "FK to profiles.id. Author of 
the review." }, "review_title" : { "type" : [ "string" , "null" ], "maxLength" 
: 255 , "description" : "Optional title for the review. (Translatable)" }, 
"review_body" : { "type" : "string" , "minLength" : 1 , "maxLength" : 2000 , 
"description" : "The main content of the review. (Translatable)" }, 
"language_code" : { "type" : "string" , "description" : "FK to 
languages_master.language_code. Language review was written in." }, "stay_date" 
: { "type" : [ "string" , "null" ], "format" : "date" , "description" : 
"Optional: Date of stay." }, "overall_vote" : { "type" : [ "string" , "null" ], 
"description" : "Optional: Overall vote. Uses public.vote_type_enum (e.g., 
'up', 'down')." }, "moderation_status" : { "type" : "string" , "default" : 
"pending_approval" , "description" : "Moderation status. Uses 
public.content_moderation_status_enum." }, "is_publicly_visible" : { "type" : 
"boolean" , "description" : "Auto-calculated: TRUE if moderation_status is 
'approved_visible' AND deleted_at IS NULL." , "readOnly" : true }, 
"moderated_by_profile_id" : { "type" : [ "string" , "null" ], "format" : "uuid" 
, "description" : "FK to profiles.id. Admin/moderator who actioned this 
review." }, "moderation_timestamp" : { "type" : [ "string" , "null" ], "format" 
: "date-time" , "description" : "Timestamp of moderation action." }, 
"moderation_notes_internal" : { "type" : [ "string" , "null" ], "description" : 
"Internal notes for moderation." }, "created_at" : { "type" : "string" , 
"format" : "date-time" , "readOnly" : true }, "updated_at" : { "type" : 
"string" , "format" : "date-time" , "readOnly" : true }, 
"updated_by_profile_id" : { "type" : [ "string" , "null" ], "format" : "uuid" , 
"description" : "Profile ID of the user/admin who last updated this review 
row." }, "deleted_at" : { "type" : [ "string" , "null" ], "format" : 
"date-time" , "description" : "Timestamp for soft deletion." } }, "required" : 
[ "accommodation_waypoint_id" , "profile_id" , "review_body" , "language_code" 
, "moderation_status" , "is_publicly_visible" ] } 5. Relationships & Integrity 
Primary Key: id (BIGINT). Foreign Keys: accommodation_waypoint_id REFERENCES 
public.accommodations(waypoint_id) ON DELETE CASCADE. profile_id REFERENCES 
public.profiles(id) ON DELETE CASCADE (if a user's profile is deleted, their 
reviews are also deleted). language_code REFERENCES 
public.languages_master(language_code) ON DELETE RESTRICT. 
moderated_by_profile_id REFERENCES public.profiles(id) ON DELETE SET NULL. 
updated_by_profile_id REFERENCES public.profiles(id) ON DELETE SET NULL. 
Generated Column: is_publicly_visible depends on moderation_status and 
deleted_at . ENUMs: Relies on public.vote_type_enum and 
public.content_moderation_status_enum (assumed to be defined globally or in 
Module 6). 6. Multilingual Strategy review_title and review_body are 
translatable. The original language is stored in language_code . Translations 
are managed in the public.translations table. table_identifier : 
'accommodation_reviews' column_identifier : 'review_title' or 'review_body' 
row_foreign_key : The id (BIGINT) of the accommodation_reviews record. An AFTER 
DELETE trigger ( trigger_cleanup_accommodation_reviews_translations ) is 
implemented. 7. Role-Based Workflow & RLS Notes Public Users 
(Anonymous/Authenticated without specific roles): Can SELECT reviews where 
is_publicly_visible = true . Authenticated Users (Pilgrim Role): Can INSERT new 
reviews (defaulting to moderation_status = 'pending_approval' , profile_id = 
auth.uid() ). Can UPDATE their own reviews if moderation_status is 
'pending_approval' OR if an edit window is allowed post-approval (requires 
careful WITH CHECK and potentially versioning/re-moderation logic - for V1, 
keep simpler: edit only if pending). updated_by_profile_id would be auth.uid() 
. Can UPDATE their own reviews to set deleted_at (soft delete). 
updated_by_profile_id would be auth.uid() . Moderator/Admin Roles: Can SELECT 
all reviews, regardless of is_publicly_visible . Can UPDATE any review's 
moderation_status , moderated_by_profile_id , moderation_timestamp , 
moderation_notes_internal , deleted_at . updated_by_profile_id would be 
auth.uid() . Can DELETE records (hard delete, if necessary, though soft delete 
via deleted_at is preferred). RLS Policies Example Snippets: SQL -- Public Read 
CREATE POLICY "Public can read approved and visible reviews" ON 
public.accommodation_reviews FOR SELECT USING (is_publicly_visible = true ); -- 
Authenticated users can insert their own reviews CREATE POLICY "Authenticated 
users can insert their own reviews" ON public.accommodation_reviews FOR INSERT 
WITH CHECK (profile_id = auth.uid()); -- Users can update their own pending 
reviews or soft delete them CREATE POLICY "Users can update their own reviews 
if pending or soft delete" ON public.accommodation_reviews FOR UPDATE USING 
(profile_id = auth.uid()) WITH CHECK ( profile_id = auth.uid() AND ( 
(OLD.moderation_status = 'pending_approval' AND OLD.deleted_at IS NULL ) OR -- 
Can edit most fields if pending (NEW.deleted_at IS NOT NULL AND OLD.deleted_at 
IS NULL ) -- Can soft delete -- Add more complex logic here if edits after 
approval are allowed ) ); -- Moderators/Admins can manage all reviews CREATE 
POLICY "Moderators can manage all reviews" ON public.accommodation_reviews FOR 
ALL USING (public.has_role_on_profile(auth.uid(), 'moderator' ) OR 
public.has_role_on_profile(auth.uid(), 'admin_platform' )) -- Example role 
check WITH CHECK (public.has_role_on_profile(auth.uid(), 'moderator' ) OR 
public.has_role_on_profile(auth.uid(), 'admin_platform' )); Enable RLS on the 
table after policies are defined. 8. ENUM vs Lookup Discussion Relies on 
vote_type_enum and content_moderation_status_enum . These are ENUMs as per 
existing patterns for similar concepts in the project. 9. UI/UX Enablement 
Display of reviews (title, body, author, stay date, overall vote) on 
accommodation pages. Form for submitting reviews. Moderation interface for 
admins/moderators. Potentially, filtering or sorting reviews by stay date or 
overall vote. 10. Key Considerations & Definitions ENUM Definitions : 
vote_type_enum (e.g., 'up', 'down', or perhaps a 1-5 star rating if changed 
from proposal) and content_moderation_status_enum (e.g., 'pending_approval', 
'approved_visible', 'rejected_hidden') must be created and managed. The 
proposal used 'pending_approval', 'approved_visible'. Edit Policy : The RLS 
example allows editing only for 'pending_approval' status. If reviews can be 
edited after approval, this needs careful consideration regarding re-moderation 
workflows. overall_vote Integration : For V1, this field is a simple attribute 
of the review. It does not automatically update aggregated votes on the 
waypoints table or link to user_waypoint_votes . Such integration is a V2+ 
consideration. Anonymity : The current design links directly to profile_id . If 
anonymous reviews (or reviews displayed with less identifiable user info) are 
needed, this requires further design. For V1, linking to profile_id is assumed. 
11. Scalability & Future-Proofing The table can grow large. Proper indexing is 
crucial. Partitioning by accommodation_waypoint_id or created_at (e.g., yearly) 
could be a V2+ consideration if volume becomes extremely high. Adding features 
like "Was this review helpful?" votes, or host replies, would be future 
extensions. 12. Next-Action Checklist ðŸ”´ Define/Verify ENUM Types : Ensure 
public.vote_type_enum and public.content_moderation_status_enum are defined 
according to project standards. ðŸ”´ Create Table : Execute the DDL for 
public.accommodation_reviews (Version 1.0). ðŸ”´ Apply Triggers : Ensure 
set_current_timestamp_updated_at and 
trigger_cleanup_accommodation_reviews_translations are created and applied. ðŸ”´ 
Create Indexes : Implement all necessary indexes as defined in the DDL. ðŸŸ  RLS 
Policies : Implement and thoroughly test the RLS policies, including helper 
functions like has_role_on_profile . ðŸŸ  Review Edit Workflow : Confirm the 
business rules for when a user can edit their review and adjust RLS UPDATE 
policy if needed. ðŸŸ¢ Translation Entries : Plan for how original review text 
will be flagged for translation if automated translation is a feature, or how 
user-submitted translations would be handled (V2+). For V1, language_code 
captures the submission language. ðŸŸ¢ Moderation Interface : Plan the UI/UX for 
the review moderation workflow. 
