# 4a.0.1 - api specs

  https://gemini.google.com/u/1/app/21b8e85b3e611787 Okay, I will now create a 
formal API Specification document for Module 4a: Waypoint - Accommodations , 
building upon the conceptual endpoints and database analysis we've discussed. 
This document will detail the endpoints for listing accommodations and 
retrieving accommodation details. API Specification: Module 4a - Waypoint 
Accommodations (Version 1.0) 1. Introduction This document specifies the API 
endpoints for accessing and managing accommodation-related data within the Via 
di Francesco Pilgrimage Platform. These endpoints are designed to support 
frontend applications and external services in providing comprehensive 
information about lodging options to pilgrims and enabling management by hosts 
and administrators. The API relies on the underlying database schema, including 
the accommodations table, its related master tables (e.g., 
accommodation_types_master , amenities_master ), junction tables (e.g., 
accommodation_amenities , accommodation_room_configurations ), and views (e.g., 
accommodations_capacity_summary_view and the newly specified localized views 
like v_accommodation_types_localized ). 2. General Considerations Base URL : 
(Placeholder) /api/v1 Authentication : All endpoints, unless specified as 
public, will require authentication via Supabase Auth (JWT Bearer token in the 
Authorization header). Error Handling : Standard HTTP status codes will be 
used: 200 OK : Request successful. 201 Created : Resource successfully created 
(for POST/PUT). 204 No Content : Request successful, no response body. 400 Bad 
Request : Invalid request parameters or body. 401 Unauthorized : Authentication 
failed or not provided. 403 Forbidden : Authenticated user does not have 
permission. 404 Not Found : Resource not found. 500 Internal Server Error : 
Server-side error. Error responses should include a JSON body with a message 
field. Rate Limiting : Appropriate rate limiting will be applied to prevent 
abuse (details TBD). Localization : Endpoints supporting localization will 
accept a lang={language_code} query parameter (e.g., lang=it ). If lang is 
provided and a translation exists, translatable fields will be returned in the 
requested language. If lang is not provided, or if a translation for the 
requested language is not available, the content will default to the primary 
reference language (English). The detailed accommodation endpoint will leverage 
the v_<master_table_name>_localized views to provide an all_translations JSONB 
object for master data labels and descriptions. For direct translatable fields 
on entities like accommodations or accommodation_reviews , the API will perform 
the necessary join to public.translations based on the lang parameter. 
Pagination : List endpoints will use page (default: 1) and limit (default: 20, 
max: 100) query parameters for pagination. Responses for paginated lists will 
include pagination metadata (e.g., total_items , total_pages , current_page , 
per_page ). 3. Endpoint Specifications 3.1. List Accommodations Method & Path : 
GET /accommodations Description : Retrieves a paginated list of accommodations. 
Supports filtering based on various criteria such as location, type, amenities, 
capacity, and opening months. Results are based on published and non-deleted 
waypoints. Permissions : Public. Request : Query Parameters : 
near_waypoint_id={waypoint_id} : (Optional) integer . Waypoint ID to search 
near. Relies on waypoints.geom . radius_km={integer} : (Optional, requires 
near_waypoint_id ) integer . Search radius in kilometers. town_id={integer} : 
(Optional) integer . Filter by waypoints.town_id . 
accommodation_type_codes={code1},{code2} : (Optional) string . Comma-separated 
list of accommodation_types_master.code values. amenity_codes={code1},{code2} : 
(Optional) string . Comma-separated list of amenities_master.amenity_code 
values (logical AND). min_beds={integer} : (Optional) integer . Minimum total 
beds, derived from accommodations_capacity_summary_view.calculated_total_beds . 
opening_month={integer} : (Optional, 1-12) integer . Filters accommodations 
open in the specified month based on accommodations.opening_months . 
lang={language_code} : (Optional) string . Two-letter ISO 639-1 language code 
(e.g., it , en ). sort_by=name|distance|relevance : (Optional) string . 
Default: relevance . distance requires near_waypoint_id . order=asc|desc : 
(Optional) string . Default: asc for name , asc for distance , desc for 
relevance . page={integer} : (Optional) integer . Default: 1 . limit={integer} 
: (Optional) integer . Default: 20 , Max: 100 . Response : Success Status Code 
: 200 OK Response Body : A JSON object containing a list of accommodation 
summaries and pagination details. JSON { "pagination" : { "total_items" : 150 , 
"total_pages" : 8 , "current_page" : 1 , "per_page" : 20 }, "accommodations" : 
[ { "waypoint_id" : 101 , "waypoint_name" : "Rifugio Cuor Contento" , // 
Translated if lang specified "waypoint_slug" : "rifugio-cuor-contento" , 
"latitude" : 43.567 , "longitude" : 12.345 , "elevation_meters" : 789 , 
"town_name" : "Villaggio Montano" , // Translated, from joined towns table 
"primary_image_thumbnail_url" : "path/to/thumb_s.webp" , // Derived from 
waypoints.primary_thumbnail_media_id "accommodation_type" : { "code" : 
"rifugio_mountain_hut" , "label" : "Rifugio Alpino" // Translated }, 
"booking_availability_status" : { // Simplified for list view "code" : 
"open_bookings_available" , "label" : "Aperto - Prenotazioni Disponibili" , // 
Translated "is_positive_status" : true }, "capacity_summary" : { 
"calculated_total_beds" : 25 }, "brief_description" : "Accogliente rifugio 
alpino con vista mozzafiato..." , // From 
waypoints.short_narrative_for_dynamic_lists, translated 
"highlight_amenity_icons" : [ "wifi" , "local_laundry_service" ] // Example: 
Top 2-3 relevant amenity icon_identifiers } // ... other accommodation 
summaries ] } 3.2. Get Accommodation Details Method & Path : GET 
/accommodations/{waypoint_id} Description : Retrieves comprehensive details for 
a single accommodation, identified by its waypoint_id . Includes linked 
entities like amenities, room configurations, payment methods, meal services, 
and recent reviews. Permissions : Public (for published and non-deleted 
waypoints). Request : Path Parameters : waypoint_id : integer (BIGINT in DB). 
The ID of the waypoint that is an accommodation. Required . Query Parameters : 
lang={language_code} : (Optional) string . Two-letter ISO 639-1 language code. 
reviews_limit={integer} : (Optional) integer . Number of recent reviews to 
return. Default: 3 . Response : Success Status Code : 200 OK Response Body : A 
JSON object containing the detailed accommodation information. (Refer to the 
detailed example provided in the previous "PHASE-2 PROMPT" response, which 
remains largely applicable here, but ensure field names match the finalized 
database schema, especially for master data labels which should be consistently 
named e.g., label and not name where appropriate). Key Sections in Response : 
waypoint_id , waypoint_name (translated), waypoint_slug , geom (GeoJSON), 
primary_image (with alt_text , caption translated, and image_variants_json ). 
accommodation_details : Object containing fields from the accommodations table. 
Translatable fields (e.g., host_name_or_organization , booking_notes ) should 
be in the requested language. Linked master data (e.g., accommodation_type , 
booking_availability_status ) should provide their code and translated label 
(potentially using the all_translations field from the new localized views 
e.g., v_accommodation_types_localized.all_translations ). capacity_summary : 
From accommodations_capacity_summary_view . amenities : Array of objects, each 
from accommodation_amenities joined with amenities_master (or its localized 
view v_amenities_localized ). Includes amenity_code , translated name , 
icon_identifier , and translated notes_on_amenity . room_configurations : Array 
of objects, each from accommodation_room_configurations joined with 
room_types_master (or v_room_types_localized ). Includes room_type (with code , 
translated name ), count_of_this_room_type , pricing details, and translated 
price_notes / room_specific_notes . payment_methods : Array of objects, each 
from accommodation_payment_methods joined with payment_methods_master (or 
v_payment_methods_localized ). Includes code , translated label , 
icon_identifier , and translated notes_on_method . meal_services : Array of 
objects, each from accommodation_meal_services joined with meal_services_master 
(or v_meal_services_localized ). Includes service code , translated name , 
pricing, and translated availability_and_timing_notes . reviews : Array of 
recent accommodation_reviews (respecting is_publicly_visible ), with translated 
review_title and review_body . Includes pilgrim_display_name (derived from 
profile_id ), stay_date , overall_vote , created_at . 4. Data Models / DTOs 
(Conceptual Examples) AccommodationSummaryObject : waypoint_id , waypoint_name 
, waypoint_slug , latitude , longitude , elevation_meters , town_name , 
primary_image_thumbnail_url , accommodation_type (object with code , label ), 
booking_availability_status (object with code , label , is_positive_status ), 
capacity_summary (object with calculated_total_beds ), brief_description , 
highlight_amenity_icons (array of strings). AccommodationDetailObject : 
Includes all fields from AccommodationSummaryObject plus: geom (GeoJSON). 
primary_image (full media object). accommodation_details (full object from 
accommodations table with master data expanded and translatable fields in 
requested language). amenities (array of full AmenityLinkObject ). 
room_configurations (array of full RoomConfigurationObject ). payment_methods 
(array of full PaymentMethodLinkObject ). meal_services (array of full 
MealServiceLinkObject ). reviews (array of ReviewObject ). 
translations_available (array of language codes). LocalizedMasterDataObject 
(Generic structure for master data within details) : code label (translated 
based on lang param) description (translated, optional) icon_identifier 
(optional) all_translations (JSONB object, if fetching directly from localized 
views and exposing all translations) AmenityLinkObject, 
RoomConfigurationObject, PaymentMethodLinkObject, MealServiceLinkObject, 
ReviewObject : Structures based on the example JSON response for the details 
endpoint, with translatable text fields provided in the requested language. 5. 
Database Support & Optimization Notes Localized Views : The newly specified 
views (e.g., v_accommodation_types_localized , v_amenities_localized , etc.) 
are crucial for efficiently providing translated labels and descriptions for 
master data within the /accommodations/{waypoint_id} detail endpoint. The API 
backend should query these views. Database Functions : For the 
/accommodations/{waypoint_id} endpoint, which involves extensive joins and data 
aggregation (including amenities, room configurations, payment methods, meal 
services, reviews, and translations for multiple fields), creating a PostgreSQL 
function (e.g., get_public_accommodation_details(p_waypoint_id BIGINT, p_lang 
TEXT) RETURNS JSONB ) is highly recommended. This function would: Encapsulate 
the complex query logic. Perform necessary joins to waypoints , accommodations 
, all relevant junction and master tables (or their localized views). Handle 
translation lookups based on p_lang . Aggregate related collections (amenities, 
rooms, etc.) into JSON arrays. Structure the final JSONB output to match the 
API response, reducing processing load on the API application layer. This 
function can be optimized within the database and can also more easily respect 
RLS policies if defined with appropriate security contexts (e.g., SECURITY 
DEFINER with caution, or ensuring RLS is applied to all underlying tables 
accessed by a SECURITY INVOKER function). Indexes : The GIN index on 
accommodations.opening_months ( idx_accommodations_opening_months ) is 
essential for the opening_month filter on the list endpoint. Indexes on label / 
name columns of all master tables (e.g., idx_atm_label on 
accommodation_types_master ) support server-side sorting for list endpoints. 
All Foreign Keys involved in joins should be indexed on the referencing table. 
The accommodations_capacity_summary_view performance depends on indexes on 
accommodation_room_configurations (accommodation_waypoint_id, room_type_id) and 
room_types_master (id) . Filtering Logic : Filtering by multiple amenity_codes 
(e.g., must have Wi-Fi AND kitchen) will require careful SQL construction, 
potentially using array operations or multiple EXISTS subqueries if implemented 
directly, or handled within the aforementioned database function. RLS : All 
queries executed by the API (whether direct or via database functions) will be 
subject to Row-Level Security policies, ensuring data is only exposed according 
to user roles and permissions (e.g., only published waypoints, hosts see only 
their own data for management endpoints not specified here). This formal API 
specification should provide a solid foundation for developing the 
accommodation-related features. 
