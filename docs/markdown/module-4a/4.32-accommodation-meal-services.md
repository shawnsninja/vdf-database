# 4.32 accommodation_meal_services

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/34bd37922031b95a 
https://gemini.google.com/u/1/app/21b8e85b3e611787 4.32 Accommodation Meal 
Services Table (Version 1.4) 
---------------------------------------------------- This document details the 
structure, purpose, and considerations for the `accommodation_meal_services` 
table, which links accommodations to the specific meal services they provide, 
including pricing and timing details. Version 1.4 adds a point to "Future 
Considerations" regarding parent table timestamp updates. ### 1\. Purpose & 
Primary Use-Cases The `accommodation_meal_services` table is a junction 
(linking) table that connects accommodations to the specific meal services they 
provide (defined in `meal_services_master`). It allows each accommodation to 
list multiple meal services and, crucially, to provide context-specific details 
such as pricing, timing, and other notes for each service offered. Key 
user-story touchpoints: - Pilgrim (Anna): Seeing detailed meal information for 
an accommodation, including what meals are offered (e.g., "Breakfast," "Pilgrim 
Dinner"), their prices, and any specific notes like "Dinner must be booked by 
noon." (Story A3) - Pilgrim (Anna): Filtering or making choices based on meal 
availability and cost. - Accommodation Host (Marco): Specifying which meals 
their B&amp;B offers, setting prices for them, and adding important details 
about availability or what's included. (Story B1) - System/UI: Dynamically 
constructing the list of offered meal services with their specific details for 
display on an accommodation's page. ### 2\. Schema (Markdown Table) *(No change 
to column structure from Version 1.3)* | column | data_type | constraints | 
description | | id | `uuid` | Primary Key (Default: `gen_random_uuid()`) | 
Unique identifier for this specific accommodation-meal service link. | | 
accommodation_waypoint_id | `bigint` | Not Null, Foreign Key to 
`accommodations(waypoint_id)` ON DELETE CASCADE, Part of UNIQUE constraint 
`uq_accommodation_meal_service` | Links to the specific accommodation. | | 
meal_service_id | `integer` | Not Null, Foreign Key to 
`meal_services_master(id)` ON DELETE RESTRICT, Part of UNIQUE constraint 
`uq_accommodation_meal_service` | Links to the specific meal service from the 
master list. RESTRICT prevents deleting a master service if in use. | | 
price_amount | `numeric(10, 2)` | Nullable, CHECK (`price_amount` IS NULL OR 
`price_amount` >= 0) | Price for this meal service at this accommodation. 
Numeric for precision. | | price_currency_code | `char(3)` | Not Null, Default 
'EUR', CHECK (length(`price_currency_code`) = 3 AND `price_currency_code` = 
upper(`price_currency_code`)) | ISO 4217 currency code for `price_amount` 
(e.g., "EUR"). V1 defaults to and requires EUR. | | price_is_per_person | 
`boolean` | Not Null, Default true | Indicates if `price_amount` is per person 
(common for meals). Set to false if the price is, for example, for a 
family-style shared dish not priced individually. | | 
availability_and_timing_notes | `text` | Nullable | Details like specific times 
available, what's included (e.g., "Breakfast 07:00-09:30, continental"), 
booking requirements. Primary reference language (English) text. Translatable. 
| | created_at | `timestamp with time zone` | Not Null, Default `now()` | 
Timestamp of when this meal service was linked to the accommodation. | | 
created_by_profile_id | `uuid` | Nullable, Foreign Key to `profiles(id)` ON 
DELETE SET NULL | Profile ID of the user who linked this meal service. | | 
updated_at | `timestamp with time zone` | Not Null, Default `now()` | Timestamp 
of when details like price or notes were last updated (auto-updated by 
trigger). | | updated_by_profile_id | `uuid` | Nullable, Foreign Key to 
`profiles(id)` ON DELETE SET NULL | Profile ID of the user who last updated 
details for this linked meal service. | ### 3\. PostgreSQL DDL *(DDL for table 
structure, comments, main trigger, and existing indexes remain the same as 
Version 1.3. Only the version in the table comment changes.)* SQL ``` -- 
Assumes public.accommodations, public.meal_services_master, public.profiles 
tables exist -- Assumes public.set_current_timestamp_updated_at() function 
exists -- Assumes public.cleanup_related_translations(TEXT, TEXT) function 
exists for the AFTER DELETE trigger CREATE TABLE 
public.accommodation_meal_services ( id UUID PRIMARY KEY DEFAULT 
gen_random_uuid(), accommodation_waypoint_id BIGINT NOT NULL, meal_service_id 
INTEGER NOT NULL, price_amount NUMERIC(10, 2) NULL CHECK (price_amount IS NULL 
OR price_amount >= 0), price_currency_code CHAR(3) NOT NULL DEFAULT 'EUR' CHECK 
(length(price_currency_code) = 3 AND price_currency_code = 
upper(price_currency_code)), price_is_per_person BOOLEAN NOT NULL DEFAULT TRUE, 
availability_and_timing_notes TEXT NULL, created_at TIMESTAMPTZ NOT NULL 
DEFAULT now(), created_by_profile_id UUID NULL, updated_at TIMESTAMPTZ NOT NULL 
DEFAULT now(), updated_by_profile_id UUID NULL, CONSTRAINT 
uq_accommodation_meal_service UNIQUE (accommodation_waypoint_id, 
meal_service_id), CONSTRAINT fk_accommodation_waypoint FOREIGN 
KEY(accommodation_waypoint_id) REFERENCES public.accommodations(waypoint_id) ON 
DELETE CASCADE, CONSTRAINT fk_meal_service FOREIGN KEY(meal_service_id) 
REFERENCES public.meal_services_master(id) ON DELETE RESTRICT, CONSTRAINT 
fk_created_by_profile FOREIGN KEY(created_by_profile_id) REFERENCES 
public.profiles(id) ON DELETE SET NULL, CONSTRAINT fk_updated_by_profile 
FOREIGN KEY(updated_by_profile_id) REFERENCES public.profiles(id) ON DELETE SET 
NULL ); COMMENT ON TABLE public.accommodation_meal_services IS 'Junction table 
linking accommodations to meal services they offer, with pricing and 
availability details. Version 1.4'; COMMENT ON COLUMN 
public.accommodation_meal_services.id IS 'Unique identifier for the 
accommodation-meal service link.'; COMMENT ON COLUMN 
public.accommodation_meal_services.accommodation_waypoint_id IS 'FK to 
accommodations(waypoint_id). Part of a unique constraint 
uq_accommodation_meal_service.'; COMMENT ON COLUMN 
public.accommodation_meal_services.meal_service_id IS 'FK to 
meal_services_master(id). Part of a unique constraint 
uq_accommodation_meal_service.'; COMMENT ON COLUMN 
public.accommodation_meal_services.price_amount IS 'Price for this meal service 
at this accommodation. Numeric(10,2).'; COMMENT ON COLUMN 
public.accommodation_meal_services.price_currency_code IS 'ISO 4217 currency 
code for price_amount. V1 defaults to and requires "EUR".'; COMMENT ON COLUMN 
public.accommodation_meal_services.price_is_per_person IS 'Indicates if 
price_amount is per person (true) or for the service unit (false).'; COMMENT ON 
COLUMN public.accommodation_meal_services.availability_and_timing_notes IS 
'Details like times available, what''s included, booking requirements. Primary 
reference language (English) text. Translatable via ''translations'' table 
using this record''s `id` as row_foreign_key.'; COMMENT ON COLUMN 
public.accommodation_meal_services.created_at IS 'Timestamp of when this meal 
service was linked to the accommodation.'; COMMENT ON COLUMN 
public.accommodation_meal_services.created_by_profile_id IS 'Profile ID of the 
user who linked this meal service.'; COMMENT ON COLUMN 
public.accommodation_meal_services.updated_at IS 'Timestamp of when details 
like price or notes were last updated.'; COMMENT ON COLUMN 
public.accommodation_meal_services.updated_by_profile_id IS 'Profile ID of the 
user who last updated details for this link.'; -- Trigger for updated_at CREATE 
TRIGGER trigger_accommodation_meal_services_set_updated_at BEFORE UPDATE ON 
public.accommodation_meal_services FOR EACH ROW WHEN ( OLD.price_amount IS 
DISTINCT FROM NEW.price_amount OR OLD.price_currency_code IS DISTINCT FROM 
NEW.price_currency_code OR OLD.price_is_per_person IS DISTINCT FROM 
NEW.price_is_per_person OR OLD.availability_and_timing_notes IS DISTINCT FROM 
NEW.availability_and_timing_notes ) EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); COMMENT ON TRIGGER 
trigger_accommodation_meal_services_set_updated_at ON 
public.accommodation_meal_services IS 'Trigger to automatically update 
updated_at timestamp when relevant details are modified.'; -- Trigger for 
orphan translation cleanup CREATE OR REPLACE FUNCTION 
public.cleanup_accommodation_meal_services_translations() RETURNS TRIGGER AS $$ 
BEGIN IF TG_OP = 'DELETE' THEN DELETE FROM public.translations WHERE 
table_identifier = 'accommodation_meal_services' AND row_foreign_key = 
OLD.id::TEXT; END IF; RETURN OLD; END; $$ LANGUAGE plpgsql SECURITY DEFINER; 
CREATE TRIGGER trigger_cleanup_accommodation_meal_services_translations AFTER 
DELETE ON public.accommodation_meal_services FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_accommodation_meal_services_translations(); COMMENT ON TRIGGER 
trigger_cleanup_accommodation_meal_services_translations ON 
public.accommodation_meal_services IS 'Cleans up orphaned translations from 
public.translations when an accommodation_meal_services record is deleted.'; -- 
Indexes CREATE INDEX idx_acc_meal_services_meal_service_id ON 
public.accommodation_meal_services(meal_service_id); COMMENT ON INDEX 
public.idx_acc_meal_services_meal_service_id IS 'Index to efficiently find all 
accommodations offering a specific meal service.'; CREATE INDEX IF NOT EXISTS 
idx_ams_created_by_profile_id ON 
public.accommodation_meal_services(created_by_profile_id) WHERE 
created_by_profile_id IS NOT NULL; CREATE INDEX IF NOT EXISTS 
idx_ams_updated_by_profile_id ON 
public.accommodation_meal_services(updated_by_profile_id) WHERE 
updated_by_profile_id IS NOT NULL; ``` ### 4\. JSON Schema Mirror *(No change 
from Version 1.3, as column structure is the same)* JSON ``` { "title": 
"accommodation_meal_service_link", "description": "Links an accommodation to a 
specific meal service offered, with pricing and availability details. Version 
1.4", "type": "object", "properties": { "id": { "type": "string", "format": 
"uuid", "description": "Unique identifier for this link. Primary Key.", 
"readOnly": true }, "accommodation_waypoint_id": { "type": "integer", "format": 
"int64", "description": "FK to accommodations(waypoint_id). Part of a unique 
constraint with meal_service_id." }, "meal_service_id": { "type": "integer", 
"description": "FK to meal_services_master(id). Part of a unique constraint 
with accommodation_waypoint_id." }, "price_amount": { "type": ["number", 
"null"], "format": "float", "description": "Price for this meal service at this 
accommodation.", "minimum": 0 }, "price_currency_code": { "type": "string", 
"minLength": 3, "maxLength": 3, "pattern": "^[A-Z]{3}$", "default": "EUR", 
"description": "ISO 4217 currency code for price_amount. V1 defaults to and 
requires EUR." }, "price_is_per_person": { "type": "boolean", "default": true, 
"description": "Indicates if price_amount is per person." }, 
"availability_and_timing_notes": { "type": ["string", "null"], "description": 
"Details like times available, what's included, booking requirements. Primary 
reference language (English) text. Translatable." }, "created_at": { "type": 
"string", "format": "date-time", "readOnly": true }, "created_by_profile_id": { 
"type": ["string", "null"], "format": "uuid", "description": "Profile ID of the 
user who linked this meal service." }, "updated_at": { "type": "string", 
"format": "date-time", "readOnly": true }, "updated_by_profile_id": { "type": 
["string", "null"], "format": "uuid", "description": "Profile ID of the user 
who last updated details for this link." } }, "required": [ 
"accommodation_waypoint_id", "meal_service_id", "price_currency_code", 
"price_is_per_person" ], "primary_key": ["id"], "uniqueKeys": [ {"name": 
"uq_accommodation_meal_service", "columns": ["accommodation_waypoint_id", 
"meal_service_id"]} ] } ``` ### 5\. Relationships & Integrity *(No change from 
Version 1.3)* - Primary Key: `id` (UUID, surrogate key). - Unique Constraint: 
`uq_accommodation_meal_service` on (`accommodation_waypoint_id`, 
`meal_service_id`). - Foreign Keys: As defined in Version 1.3. - Mermaid ER 
Snippet: (As provided in Version 1.3 documentation). ### 6\. Multilingual 
Strategy *(No change from Version 1.3)* - `availability_and_timing_notes`: 
Translatable. - Translation Management: Via `public.translations` table (using 
`id` as `row_foreign_key`) and orphan cleanup trigger. ### 7\. Role-Based 
Workflow & RLS Notes *(No change from Version 1.3)* - Key Fields for Workflow: 
`price_amount`, `availability_and_timing_notes` managed by hosts or 
admins/managers. Audit fields track links. - RLS Policies: Public read for 
published accommodations; hosts manage their own. ### 8\. ENUM vs Lookup 
Discussion *(No change from Version 1.3)* - Not applicable directly. Links to 
`meal_services_master` (a lookup table). ### 9\. UI/UX Enablement *(No change 
from Version 1.3)* - Enables UI to list specific meal services, prices, and 
notes. ### 10\. Key Considerations & Definitions *(No change from Version 1.3)* 
- `ON DELETE RESTRICT` for `meal_service_id`: Important. - Currency Handling: 
`price_currency_code` is `NOT NULL DEFAULT 'EUR'`. - `price_is_per_person` 
default: `true` is common for pilgrim meals. ### 11\. Scalability & 
Future-Proofing *(Section updated to include the new consideration)* - Standard 
Junction Table: A scalable pattern. - Pricing Flexibility: Separate 
`price_amount` and `price_currency_code` allow for future multi-currency 
support. - Parent Table Timestamp Updates (V2+): Consider if adding or removing 
meal services (INSERT/DELETE operations on this table), or significant updates 
beyond those covered by the current conditional `updated_at` trigger (e.g., if 
other fields were added that signify a major change), should also trigger an 
update to the `updated_at` timestamp of the parent `public.accommodations` 
record. This could be relevant for data synchronization or cache invalidation 
strategies for the parent accommodation. Implementing this would require 
additional trigger logic or modifying the existing `updated_at` trigger's 
`WHEN` condition. ### 12\. Next-Action Checklist *(No DDL changes required for 
this specific update, only documentation.)* - 🟢 Documentation: Ensure this 
"Future Consideration" regarding parent table timestamp updates is noted in 
this version of the specification document. - 🟢 Verify Other Aspects: Confirm 
all other aspects from Version 1.3 (triggers, RLS policies, translation 
strategy using `id` as `row_foreign_key`) are correctly implemented and tested. 
