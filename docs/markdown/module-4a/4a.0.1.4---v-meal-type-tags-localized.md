# 4a.0.1.4 - v_meal_type_tags_localized

  https://gemini.google.com/u/1/app/21b8e85b3e611787 New View Spec: 
v_meal_type_tags_localized 1. View Name public.v_meal_type_tags_localized 2. 
Purpose & Primary Use-Cases Purpose : To provide a consolidated and 
denormalized view of meal_type_tags_master records, including all their 
available translations for label and description fields in a structured JSONB 
format, alongside all other master table attributes. Primary Use-Cases : 
Simplify API development by providing a single source for a meal type tag and 
all its translations. Support API endpoints that list meal type tags or display 
details for a specific meal type tag where multilingual representation is 
required (e.g., for filtering food establishments or displaying meal services). 
Facilitate easier data fetching for frontend components that need to display 
localized meal type tag information. 3. View Schema (Columns) Column Data Type 
Description id integer Inherited from meal_type_tags_master . Unique identifier 
for the meal type tag. code text Inherited from meal_type_tags_master . Short, 
stable, machine-readable code (e.g., 'breakfast_colazione'). label text 
Inherited from meal_type_tags_master . Primary reference language (English) 
label for the meal type tag. description text Inherited from 
meal_type_tags_master . Optional primary reference language (English) 
description of the meal type tag. icon_identifier text Inherited from 
meal_type_tags_master . Name, class, or path for a UI icon. sort_order integer 
Inherited from meal_type_tags_master . Determines display order in UI lists. 
is_active boolean Inherited from meal_type_tags_master . True if the meal type 
tag is active and available for use. created_at timestamp with time zone 
Inherited from meal_type_tags_master . Timestamp of record creation. updated_at 
timestamp with time zone Inherited from meal_type_tags_master . Timestamp of 
last update. created_by_profile_id uuid Inherited from meal_type_tags_master . 
Profile ID of the user/admin who created this record. updated_by_profile_id 
uuid Inherited from meal_type_tags_master . Profile ID of the user/admin who 
last updated this record. all_translations jsonb A JSONB object containing all 
available translations for label and description , keyed by language code. 
Example: {"en": {"label": "...", "description": "..."}, "it": {"label": "...", 
"description": "..."}} . Includes primary English text if present in 
translations table. 4. Underlying SQL Definition SQL CREATE OR REPLACE VIEW 
public.v_meal_type_tags_localized AS SELECT mttm.id, mttm.code, mttm.label, -- 
Primary English label mttm.description, -- Primary English description 
mttm.icon_identifier, mttm.sort_order, mttm.is_active, mttm.created_at, 
mttm.updated_at, mttm.created_by_profile_id, mttm.updated_by_profile_id, ( 
SELECT jsonb_object_agg( tr.language_code, jsonb_build_object( 'label' , MAX ( 
CASE WHEN tr.column_identifier = 'label' THEN tr.translated_text ELSE NULL END 
), 'description' , MAX ( CASE WHEN tr.column_identifier = 'description' THEN 
tr.translated_text ELSE NULL END ) ) ) FROM public.translations tr WHERE 
tr.table_identifier = 'meal_type_tags_master' AND tr.row_foreign_key = 
mttm.id::TEXT GROUP BY tr.row_foreign_key ) AS all_translations FROM 
public.meal_type_tags_master mttm; COMMENT ON VIEW 
public.v_meal_type_tags_localized IS 'Provides meal type tags with their base 
English fields and a JSONB column "all_translations" containing all available 
label and description translations keyed by language code. Version 1.0' ; 
COMMENT ON COLUMN public.v_meal_type_tags_localized.label IS 'Primary reference 
language (English) label from meal_type_tags_master.' ; COMMENT ON COLUMN 
public.v_meal_type_tags_localized.description IS 'Primary reference language 
(English) description from meal_type_tags_master.' ; COMMENT ON COLUMN 
public.v_meal_type_tags_localized.all_translations IS 'JSONB object with all 
translations for label and description, keyed by language code. E.g., {"en": 
{"label": "...", "description": "..."}, "it": {"label": "...", "description": 
"..."}}. Base English text from master table should be merged by 
application/API layer if not also present in translations table with code 
''en''.' ; 5. Key Dependencies public.meal_type_tags_master (Version 1.3 or 
later, which includes is_active and audit columns) public.translations (Version 
2.1 or later) 6. Performance Considerations The subquery using jsonb_object_agg 
can be resource-intensive without proper indexing on public.translations . 
Required Index on public.translations : A composite index on ( table_identifier 
, row_foreign_key , language_code , column_identifier ) is crucial. (Assumed to 
be idx_translations_lookup_multi_col ). Queries on this view filtering by 
is_active will benefit from the idx_mttm_is_active index on 
meal_type_tags_master . For very high-read scenarios, a materialized view could 
be a V2+ optimization. 7. RLS & Security Notes RLS policies from 
public.meal_type_tags_master (e.g., filtering by is_active = true ) will be 
inherited by this view. Access to public.translations is assumed if a user can 
see the master record. Define with SECURITY INVOKER (default for views). 8. API 
Endpoints Supported (Conceptual) GET /meta/meal-type-tags?lang=it : List all 
active meal type tags with translations. GET /meta/meal-type-tags/{tag_code} : 
Get a specific meal type tag with translations. Useful for UIs that allow 
filtering food establishments or listing services by meal types. 9. Rationale 
for Creation Decouples API data retrieval from complex translation 
join/aggregation logic. Provides a consistent, denormalized structure for 
accessing localized meal type tag content. Improves query readability and 
maintainability for developers. 10. Key Considerations & Definitions Primary 
Language Fallback : The API/application layer needs to handle fallback to 
primary English fields if a translation for a requested language is not 
available in all_translations . Data Freshness : As a standard view, it 
reflects the current state. 11. Scalability & Future-Proofing Performance 
depends on translations table indexing. Adding new translatable fields to 
meal_type_tags_master would require updating this view definition. 12. 
Next-Action Checklist ðŸ”´ Create View : Execute the DDL to create 
public.v_meal_type_tags_localized . ðŸ”´ Verify Index on translations : Ensure 
the recommended composite index on public.translations exists. ðŸŸ  API Layer 
Integration : Plan API consumption of this view. ðŸŸ¢ Testing : Test view 
performance. ðŸŸ¢ Documentation : Document this view. 
