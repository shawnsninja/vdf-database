# 4.4 booking_statuses_master

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/34bd37922031b95a 
https://gemini.google.com/u/1/app/21b8e85b3e611787 ### 3\. Updated 
Production-Ready Specification 4.4 Booking Statuses Master Table (Version 1.4) 
----------------------------------------------- This document details the 
structure, purpose, and considerations for the `booking_statuses_master` table. 
Version 1.4 updates the RLS policies to align with the platform-wide security 
and authentication strategy using the `public.has_role()` helper function. ### 
1\. Purpose & Primary Use-Cases The `booking_statuses_master` table provides a 
centralized, standard list of possible booking availability statuses for 
accommodations (e.g., "Open - Bookings Available," "Likely Full," "Closed 
Seasonally"). Its purpose is to ensure consistent terminology for booking 
statuses, support clear communication of availability to pilgrims, and enable 
multilingual display of these statuses. Key user-story touchpoints: - Pilgrim: 
Quickly understanding the likely booking availability of an accommodation. 
(Story A3, B2) - Accommodation Host: Updating their current booking 
availability status for pilgrims to see. (Story B2) - Admin/Content Manager: 
Managing the set of official booking statuses, including their active state. - 
System/UI: Displaying availability statuses with appropriate labels (and 
potentially colors/icons) in accommodation listings or summaries, based on 
active statuses. ### 2\. Schema (Markdown Table) *(No change to column 
structure from Version 1.3)* | column | data_type | constraints | description | 
| id | `integer` | Primary Key (Generated as identity always) | Unique 
identifier for the booking status. | | code | `text` | Unique, Not Null, CHECK 
(length(code) > 0 AND length(code) &lt;= 50 AND code ~ '^[a-z0-9_]+$') | Short, 
stable, machine-readable code (e.g., 'open_bookings_available', 'full'). 
Snake_case. | | label | `text` | Not Null, CHECK (length(label) > 0 AND 
length(label) &lt;= 100) | Human-readable name in the primary reference 
language (English) for UI display and as a base for translation. Translatable. 
| | description | `text` | Nullable | Optional description of the booking 
status in the primary reference language (English). Translatable. | | 
is_positive_status | `boolean` | Not Null, Default true | Indicates if the 
status generally represents positive availability (e.g., 'open' is true, 'full' 
is false). For UI styling. | | sort_order | `integer` | Not Null, Default 0 | 
Determines the display order in UI lists or selection options. | | is_active | 
`boolean` | Not Null, Default true | True if the status is active and available 
for use; false if retired/archived. | | created_at | `timestamp with time zone` 
| Not Null, Default `now()` | Timestamp of record creation. | | updated_at | 
`timestamp with time zone` | Not Null, Default `now()` | Timestamp of last 
update (auto-updated by trigger). | | created_by_profile_id | `uuid` | 
Nullable, Foreign Key to `public.profiles(id)` ON DELETE SET NULL | Profile ID 
of the user/admin who created this booking status record. | | 
updated_by_profile_id | `uuid` | Nullable, Foreign Key to `public.profiles(id)` 
ON DELETE SET NULL | Profile ID of the user/admin who last updated this booking 
status record. | ### 3\. PostgreSQL DDL *(DDL for table structure, comments, 
triggers, and indexes remain the same as Version 1.3. Only the version in the 
table comment changes.)* SQL ``` -- Assumes public.profiles table exists -- 
Assumes public.set_current_timestamp_updated_at() function exists -- Assumes 
public.cleanup_related_translations(TEXT, TEXT) function and specific per-table 
wrapper exist CREATE TABLE public.booking_statuses_master ( id INTEGER 
GENERATED ALWAYS AS IDENTITY PRIMARY KEY, code TEXT UNIQUE NOT NULL CHECK 
(length(code) > 0 AND length(code) <= 50 AND code ~ '^[a-z0-9_]+$'), label TEXT 
NOT NULL CHECK (length(label) > 0 AND length(label) <= 100), description TEXT 
NULL, is_positive_status BOOLEAN NOT NULL DEFAULT TRUE, sort_order INTEGER NOT 
NULL DEFAULT 0, is_active BOOLEAN NOT NULL DEFAULT true, created_at TIMESTAMPTZ 
NOT NULL DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), 
created_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE SET 
NULL, updated_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE 
SET NULL ); COMMENT ON TABLE public.booking_statuses_master IS 'Master list of 
booking availability statuses for accommodations. Replaces booking_status_enum. 
Version 1.4'; -- Column comments from Version 1.3 remain unchanged. E.g.: 
COMMENT ON COLUMN public.booking_statuses_master.label IS 'Human-readable name 
in the primary reference language (English) for UI display and as a base for 
translation. Translatable via the ''translations'' table. Max 100 chars.'; 
COMMENT ON COLUMN public.booking_statuses_master.is_active IS 'True if the 
status is active and available for use; false if retired/archived. Defaults to 
true.'; COMMENT ON COLUMN public.booking_statuses_master.created_by_profile_id 
IS 'Profile ID of the user/admin who created this record.'; COMMENT ON COLUMN 
public.booking_statuses_master.updated_by_profile_id IS 'Profile ID of the 
user/admin who last updated this record.'; -- Indexes (including idx_bsm_label 
from previous update) CREATE INDEX IF NOT EXISTS idx_bsm_is_active ON 
public.booking_statuses_master(is_active); CREATE INDEX IF NOT EXISTS 
idx_bsm_sort_order ON public.booking_statuses_master(sort_order); CREATE INDEX 
IF NOT EXISTS idx_bsm_label ON public.booking_statuses_master(label); CREATE 
INDEX IF NOT EXISTS idx_bsm_created_by_profile_id ON 
public.booking_statuses_master(created_by_profile_id) WHERE 
created_by_profile_id IS NOT NULL; CREATE INDEX IF NOT EXISTS 
idx_bsm_updated_by_profile_id ON 
public.booking_statuses_master(updated_by_profile_id) WHERE 
updated_by_profile_id IS NOT NULL; -- Trigger for updated_at CREATE TRIGGER 
trigger_booking_statuses_master_set_updated_at BEFORE UPDATE ON 
public.booking_statuses_master FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); COMMENT ON TRIGGER 
trigger_booking_statuses_master_set_updated_at ON 
public.booking_statuses_master IS 'Trigger to automatically update updated_at 
timestamp on row modification.'; -- Trigger for orphan translation cleanup 
CREATE OR REPLACE FUNCTION 
public.cleanup_booking_statuses_master_translations() RETURNS TRIGGER AS $$ 
BEGIN IF TG_OP = 'DELETE' THEN DELETE FROM public.translations WHERE 
table_identifier = 'booking_statuses_master' AND row_foreign_key = 
OLD.id::TEXT; END IF; RETURN OLD; END; $$ LANGUAGE plpgsql SECURITY DEFINER; 
CREATE TRIGGER trigger_cleanup_booking_statuses_master_translations AFTER 
DELETE ON public.booking_statuses_master FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_booking_statuses_master_translations(); COMMENT ON TRIGGER 
trigger_cleanup_booking_statuses_master_translations ON 
public.booking_statuses_master IS 'Cleans up orphaned translations from 
public.translations when a booking_statuses_master record is deleted.'; -- 
Initial Data Example (ensure created_by_profile_id and updated_by_profile_id 
are set appropriately for seed data) INSERT INTO public.booking_statuses_master 
(code, label, description, is_positive_status, sort_order, is_active, 
created_by_profile_id, updated_by_profile_id) VALUES ('unknown', 'Unknown', 
'Availability has not been specified or recently updated.', false, 0, true, 
NULL, NULL), ('open_bookings_available', 'Open - Bookings Available', 'Likely 
has space and is accepting bookings.', true, 10, true, NULL, NULL), -- ... 
other seed data from V1.3 ... ('closed_seasonally', 'Closed Seasonally', 
'Closed for the season (e.g., winter closure).', false, 80, true, NULL, NULL); 
``` ### 4\. JSON Schema Mirror *(No change from Version 1.3)* JSON ``` { 
"title": "booking_status_master", "description": "Master list of booking 
availability statuses for accommodations. Version 1.4", "type": "object", 
"properties": { "id": { /* ... */ }, "code": { /* ... */ }, "label": { /* ... 
*/ }, "description": { /* ... */ }, "is_positive_status": { /* ... */ }, 
"sort_order": { /* ... */ }, "is_active": { /* ... */ }, "created_at": { /* ... 
*/ }, "updated_at": { /* ... */ }, "created_by_profile_id": { /* ... */ }, 
"updated_by_profile_id": { /* ... */ } }, "required": [ /* ... */ ] } ``` ### 
5\. Relationships & Integrity *(No change from Version 1.3)* - Primary Key: 
`id` (INTEGER) - Unique Constraint: `code` must be unique. - Foreign Key 
References FROM other tables: - `accommodations.booking_availability_status_id` 
REFERENCES `public.booking_statuses_master(id)` (ON DELETE SET NULL, with a 
`DEFAULT` in `accommodations`). - Foreign Key References TO other tables: - 
`created_by_profile_id` REFERENCES `public.profiles(id)` ON DELETE SET NULL. - 
`updated_by_profile_id` REFERENCES `public.profiles(id)` ON DELETE SET NULL. - 
Data Integrity Notes: Retiring a status by `is_active = false`. ### 6\. 
Multilingual Strategy *(No change from Version 1.3)* - Translatable Fields: 
`label`, `description`. - Translation Management: Via `public.translations` 
table and orphan cleanup trigger. ### 7\. Role-Based Workflow & RLS Notes 
*(This section is updated to reflect the new auth strategy)* - Content 
Management: This table is typically managed by users with the `admin_platform` 
role. - Lifecycle: Booking statuses are made inactive by setting `is_active = 
false`. Physical deletion is generally not recommended if a status has been 
used, to preserve historical meaning, but `ON DELETE SET NULL` (with a default 
to 'unknown') on the referencing `accommodations` table handles cases where 
deletion might occur. - RLS Policies (Assumes `public.has_role(TEXT)` helper 
function exists): - Public Users (Read-Only on active statuses): SQL ``` -- 
Name: Allow public read access to active booking statuses -- Target: 
booking_statuses_master -- Operation: SELECT -- Role(s): anon, authenticated 
CREATE POLICY "Allow public read access to active booking statuses" ON 
public.booking_statuses_master FOR SELECT USING (is_active = true); ``` - 
Accommodation Hosts (Read-Only on active statuses, for selection in their UIs): 
The public policy above suffices. - Platform Administrators (Full Control): SQL 
``` -- Name: Allow platform administrators to manage booking statuses -- 
Target: booking_statuses_master -- Operation: ALL -- Role(s): admin_platform 
CREATE POLICY "Allow platform administrators to manage booking statuses" ON 
public.booking_statuses_master FOR ALL USING ( auth.role() = 'authenticated' 
AND public.has_role('admin_platform') ) WITH CHECK ( auth.role() = 
'authenticated' AND public.has_role('admin_platform') ); ``` - Enable RLS: SQL 
``` ALTER TABLE public.booking_statuses_master ENABLE ROW LEVEL SECURITY; ``` - 
Notes: RLS must filter by `is_active = true` for general read access. The 
`DEFAULT` value for `accommodations.booking_availability_status_id` ensures 
that if a status is hard-deleted (despite `ON DELETE SET NULL`), new records in 
`accommodations` don't fail, though retiring via `is_active = false` is 
preferred. ### 8\. ENUM vs Lookup Discussion *(No change from Version 1.3)* - 
ðŸŸ¢ Decision: Correctly a lookup table. - Reasoning: Translatable fields, 
metadata (`is_positive_status`, `sort_order`), maintainability, auditability, 
lifecycle. ### 9\. UI/UX Enablement *(No change from Version 1.3)* - `label` 
(translated): For filter labels and display names. - `description` 
(translated): For tooltips. - `is_positive_status`: For UI visual cues. - 
`sort_order`: For logical presentation. - `is_active`: UI should only use 
active statuses. ### 10\. Key Considerations & Definitions *(No change from 
Version 1.3)* - `code`: Must be unique, stable, especially for the `DEFAULT` 
value in `accommodations`. - Default Status: 'unknown' status crucial for 
`accommodations` default. - Host Workflow: Hosts select these statuses. ### 
11\. Scalability & Future-Proofing *(No change from Version 1.3)* - Lookup 
Table Structure: Scalable. - Adding Attributes: Easy. ### 12\. Next-Action 
Checklist *(No DDL changes required for this specific update beyond what was in 
V1.3, the main change is to the RLS policy definition in this document)* - ðŸ”´ 
Verify/Implement RLS Helper: Ensure the `public.has_role(TEXT)` helper function 
is correctly implemented and available. - ðŸ”´ Apply RLS Policies: Implement and 
thoroughly test the updated RLS policies. - ðŸ”´ Initial Population/Seed Data: 
Ensure `created_by_profile_id`/`updated_by_profile_id` are correctly set for 
seed data. - ðŸŸ¢ Default Value in `accommodations`: Verify default correctly 
references the 'unknown' status ID. - ðŸŸ¢ Translation Entries: Prepare/verify 
English entries for `label` and `description` in `public.translations`. 
