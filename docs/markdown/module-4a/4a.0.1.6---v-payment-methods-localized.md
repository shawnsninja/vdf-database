# 4a.0.1.6 - v_payment_methods_localized

  https://gemini.google.com/u/1/app/21b8e85b3e611787 1. View Name 
public.v_payment_methods_localized 2. Purpose & Primary Use-Cases Purpose : To 
provide a consolidated and denormalized view of payment_methods_master records, 
including all their available translations for label , description , and 
category fields in a structured JSONB format, alongside all other master table 
attributes. Primary Use-Cases : Simplify API development by providing a single 
source for a payment method and all its translations. Support API endpoints 
that list payment methods or display details for a specific payment method 
where multilingual representation is required (e.g., for showing accepted 
payment methods for accommodations or other services). Facilitate easier data 
fetching for frontend components that need to display localized payment method 
information. 3. View Schema (Columns) Column Data Type Description id integer 
Inherited from payment_methods_master . Unique identifier for the payment 
method. code text Inherited from payment_methods_master . Short, stable, 
machine-readable code (e.g., 'CASH_EUR'). label text Inherited from 
payment_methods_master . Primary reference language (English) label for the 
payment method. description text Inherited from payment_methods_master . 
Optional primary reference language (English) description of the payment 
method. icon_identifier text Inherited from payment_methods_master . Name, 
class, or path for a UI icon. category text Inherited from 
payment_methods_master . Broad category for grouping in the primary reference 
language (English) (e.g., "Card", "Digital Wallet"). sort_order integer 
Inherited from payment_methods_master . Determines display order in UI lists. 
is_active boolean Inherited from payment_methods_master . True if the payment 
method is active and available for use. created_at timestamp with time zone 
Inherited from payment_methods_master . Timestamp of record creation. 
updated_at timestamp with time zone Inherited from payment_methods_master . 
Timestamp of last update. created_by_profile_id uuid Inherited from 
payment_methods_master . Profile ID of the user/admin who created this record. 
updated_by_profile_id uuid Inherited from payment_methods_master . Profile ID 
of the user/admin who last updated this record. all_translations jsonb A JSONB 
object containing all available translations for label , description , and 
category , keyed by language code. Example: {"en": {"label": "...", 
"description": "...", "category": "..."}, "it": {"label": "...", "description": 
"...", "category": "..."}} . 4. Underlying SQL Definition SQL CREATE OR REPLACE 
VIEW public.v_payment_methods_localized AS SELECT pmm.id, pmm.code, pmm.label, 
-- Primary English label pmm.description, -- Primary English description 
pmm.icon_identifier, pmm.category, -- Primary English category pmm.sort_order, 
pmm.is_active, pmm.created_at, pmm.updated_at, pmm.created_by_profile_id, 
pmm.updated_by_profile_id, ( SELECT jsonb_object_agg( tr.language_code, 
jsonb_build_object( 'label' , MAX ( CASE WHEN tr.column_identifier = 'label' 
THEN tr.translated_text ELSE NULL END ), 'description' , MAX ( CASE WHEN 
tr.column_identifier = 'description' THEN tr.translated_text ELSE NULL END ), 
'category' , MAX ( CASE WHEN tr.column_identifier = 'category' THEN 
tr.translated_text ELSE NULL END ) ) ) FROM public.translations tr WHERE 
tr.table_identifier = 'payment_methods_master' AND tr.row_foreign_key = 
pmm.id::TEXT GROUP BY tr.row_foreign_key ) AS all_translations FROM 
public.payment_methods_master pmm; COMMENT ON VIEW 
public.v_payment_methods_localized IS 'Provides payment methods with their base 
English fields and a JSONB column "all_translations" containing all available 
label, description, and category translations keyed by language code. Version 
1.0' ; COMMENT ON COLUMN public.v_payment_methods_localized.label IS 'Primary 
reference language (English) label from payment_methods_master.' ; COMMENT ON 
COLUMN public.v_payment_methods_localized.description IS 'Primary reference 
language (English) description from payment_methods_master.' ; COMMENT ON 
COLUMN public.v_payment_methods_localized.category IS 'Primary reference 
language (English) category from payment_methods_master.' ; COMMENT ON COLUMN 
public.v_payment_methods_localized.all_translations IS 'JSONB object with all 
translations for label, description, and category, keyed by language code. 
E.g., {"en": {"label": "...", "description": "...", "category": "..."}, "it": 
{"label": "...", "description": "...", "category": "..."}}. Base English text 
from master table should be merged by application/API layer if not also present 
in translations table with code ''en''.' ; 5. Key Dependencies 
public.payment_methods_master (Version 1.3 or later, which includes is_active 
and audit columns) public.translations (Version 2.1 or later) 6. Performance 
Considerations The subquery using jsonb_object_agg can be resource-intensive 
without proper indexing on public.translations . Required Index on 
public.translations : A composite index on ( table_identifier , row_foreign_key 
, language_code , column_identifier ) is crucial. (Assumed to be 
idx_translations_lookup_multi_col ). Queries on this view filtering by 
is_active will benefit from the idx_pmm_is_active index on 
payment_methods_master . For very high-read scenarios, a materialized view 
could be a V2+ optimization. 7. RLS & Security Notes RLS policies from 
public.payment_methods_master (e.g., filtering by is_active = true ) will be 
inherited by this view. Access to public.translations is assumed if a user can 
see the master record. Define with SECURITY INVOKER (default for views). 8. API 
Endpoints Supported (Conceptual) GET /meta/payment-methods?lang=it : List all 
active payment methods with translations. GET 
/meta/payment-methods/{method_code} : Get a specific payment method with 
translations. Useful for UIs that display accepted payment options for various 
services. 9. Rationale for Creation Decouples API data retrieval from complex 
translation join/aggregation logic for multiple fields. Provides a consistent, 
denormalized structure for accessing localized payment method content. Improves 
query readability and maintainability for developers. 10. Key Considerations & 
Definitions Primary Language Fallback : The API/application layer needs to 
handle fallback to primary English fields if a translation for a requested 
language is not available in all_translations . Data Freshness : As a standard 
view, it reflects the current state. 11. Scalability & Future-Proofing 
Performance depends on translations table indexing. Adding new translatable 
fields to payment_methods_master would require updating this view definition. 
12. Next-Action Checklist ðŸ”´ Create View : Execute the DDL to create 
public.v_payment_methods_localized . ðŸ”´ Verify Index on translations : Ensure 
the recommended composite index on public.translations exists. ðŸŸ  API Layer 
Integration : Plan API consumption of this view. ðŸŸ¢ Testing : Test view 
performance. ðŸŸ¢ Documentation : Document this view. 
