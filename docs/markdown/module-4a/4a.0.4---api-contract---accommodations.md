# 4a.0.4 - API Contract - Accommodations

  https://gemini.google.com/u/1/app/3332d7c5163a3dae * * * * * ### OpenAPI 3.1 
Spec (for Module 4a - Accommodations) YAML ``` openapi: 3.1.0 info: title: Via 
di Francesco - Module 4a: Accommodations API version: v1.0 description: API 
endpoints for managing and retrieving accommodation-specific data, including 
types, amenities, room configurations, payment methods, meal services, and 
reviews. contact: name: Platform Engineering Team url: 
https://viafrancesco.example.com email: api-dev@viafrancesco.example.com 
servers: - url: https://<YOUR_PROJECT_REF>.supabase.co/rest/v1 # Replace 
<YOUR_PROJECT_REF> description: Supabase Production API tags: - name: 
Accommodations description: Operations related to accommodation listings and 
their detailed attributes. - name: AccommodationReviews description: Operations 
related to user reviews for accommodations. - name: AccommodationMeta 
description: Read-only endpoints for accommodation-related master data (types, 
amenities, etc.). components: securitySchemes: bearerAuth: # As defined in Auth 
& Security Blueprint type: http scheme: bearer bearerFormat: JWT description: 
Supabase JWT token for authenticated users. apiKey: # As defined in Auth & 
Security Blueprint type: apiKey in: header name: apikey description: Supabase 
anonymous or service key. schemas: Error: # As defined in Auth & Security 
Blueprint [cite: 45] type: object required: - code - message properties: code: 
type: string description: Error code (PostgREST or application-specific). 
example: "PGRST116" message: type: string description: User-friendly error 
message. example: "The requested resource was not found." details: type: string 
nullable: true description: Specific technical details or validation errors. 
example: "No rows found for Waypoint ID 99999." hint: type: string nullable: 
true description: Suggestion on how to fix the error. example: "Check the 
Waypoint ID and try again." Pagination: # Global design standard [cite: 332] 
type: object properties: total_items: type: integer example: 150 total_pages: 
type: integer example: 8 current_page: type: integer example: 1 per_page: type: 
integer example: 20 description: Pagination metadata for list responses. # 
Localized Master Data Schemas (reflecting structure from v_..._localized views) 
AccommodationTypeLocalized: # Based on v_accommodation_types_localized [cite: 
451] type: object description: Defines a type of accommodation, including all 
translations. properties: id: type: integer readOnly: true code: type: string 
description: Unique, machine-readable code. label: # Primary English label from 
base table [cite: 451] type: string description: Primary reference language 
(English) label. description: # Primary English description from base table 
[cite: 451] type: string nullable: true description: Primary reference language 
(English) description. icon_identifier: type: string nullable: true sort_order: 
type: integer is_active: type: boolean # Audit columns from master table could 
be included if needed by API client # created_at, updated_at, 
created_by_profile_id, updated_by_profile_id all_translations: # JSONB object 
from the view [cite: 451] type: object additionalProperties: type: object 
properties: label: { type: string } description: { type: string, nullable: true 
} description: "All available translations for label and description, keyed by 
language code." BookingStatusLocalized: # Based on v_booking_statuses_localized 
[cite: 496] type: object description: Defines a booking availability status, 
including all translations. properties: id: type: integer readOnly: true code: 
type: string label: # Primary English label type: string description: # Primary 
English description type: string nullable: true is_positive_status: type: 
boolean sort_order: type: integer is_active: type: boolean all_translations: # 
JSONB object from the view type: object additionalProperties: type: object 
properties: label: { type: string } description: { type: string, nullable: true 
} description: "All available translations for label and description." 
AmenityLocalized: # Based on v_amenities_localized [cite: 656] type: object 
description: Defines an amenity that can be offered, including all 
translations. properties: id: type: integer readOnly: true amenity_code: type: 
string name: # Primary English name from base table [cite: 656] type: string 
description: # Primary English description from base table [cite: 656] type: 
string nullable: true icon_identifier: type: string nullable: true 
amenity_category: # Primary English category from base table [cite: 656] type: 
string nullable: true is_common_pilgrim_need: type: boolean sort_order: type: 
integer is_active: type: boolean all_translations: # JSONB object from the view 
[cite: 656] type: object additionalProperties: type: object properties: name: { 
type: string } description: { type: string, nullable: true } amenity_category: 
{ type: string, nullable: true } description: "All available translations for 
name, description, and amenity_category." RoomTypeLocalized: # Based on 
v_room_types_localized [cite: 689] type: object description: Defines a type of 
room in an accommodation, including all translations. properties: id: type: 
integer readOnly: true room_type_code: type: string name: # Primary English 
name type: string description: # Primary English description type: string 
nullable: true typical_capacity_persons: type: integer is_dorm_style: type: 
boolean is_private_occupancy: type: boolean has_private_bathroom_option: type: 
boolean is_entire_unit_rental: type: boolean sort_order: type: integer 
is_active: type: boolean all_translations: # JSONB object from the view type: 
object additionalProperties: type: object properties: name: { type: string } 
description: { type: string, nullable: true } description: "All available 
translations for name and description." PaymentMethodLocalized: # Based on 
v_payment_methods_localized [cite: 623] type: object description: Defines an 
accepted payment method, including all translations. properties: id: type: 
integer readOnly: true code: type: string label: # Primary English label type: 
string description: # Primary English description type: string nullable: true 
icon_identifier: type: string nullable: true category: # Primary English 
category type: string nullable: true sort_order: type: integer is_active: type: 
boolean all_translations: # JSONB object from the view type: object 
additionalProperties: type: object properties: label: { type: string } 
description: { type: string, nullable: true } category: { type: string, 
nullable: true } description: "All available translations for label, 
description, and category." MealServiceLocalized: # Based on 
v_meal_services_localized [cite: 720] type: object description: Defines a meal 
service offered, including all translations. properties: id: type: integer 
readOnly: true code: type: string name: # Primary English name type: string 
description: # Primary English description type: string nullable: true 
icon_identifier: type: string nullable: true sort_order: type: integer 
is_active: type: boolean all_translations: # JSONB object from the view type: 
object additionalProperties: type: object properties: name: { type: string } 
description: { type: string, nullable: true } description: "All available 
translations for name and description." # Schemas for Accommodation Endpoints 
AccommodationListSummary: # For GET /accommodations list view [cite: 409] type: 
object properties: waypoint_id: type: integer format: int64 waypoint_name: 
type: string description: Waypoint name, translated based on 'lang' query 
parameter. waypoint_slug: type: string latitude: type: number format: double 
longitude: type: number format: double elevation_meters: type: integer 
nullable: true town_name: type: string nullable: true description: Town name, 
translated based on 'lang' query parameter. primary_image_thumbnail_url: type: 
string format: url nullable: true accommodation_type: # Embedded simplified 
master data type: object properties: code: type: string label: type: string 
description: Accommodation type label, translated. booking_availability_status: 
type: object properties: code: type: string label: type: string description: 
Booking status label, translated. is_positive_status: type: boolean 
capacity_summary: # From accommodations_capacity_summary_view type: object 
properties: calculated_total_beds: type: integer brief_description: type: 
string nullable: true description: Brief description from waypoint, translated. 
highlight_amenity_icons: type: array items: type: string description: Example 
list of key amenity icon identifiers. AccommodationDetail: # For GET 
/accommodations/{waypoint_id} [cite: 418] type: object properties: waypoint_id: 
type: integer format: int64 waypoint_name: type: string description: Waypoint 
name, translated. waypoint_slug: type: string # ... other waypoint fields 
(geom, primary_image full object etc.) from API Spec [cite: 419] description: # 
From waypoint table type: string nullable: true description: Waypoint 
description, translated. accommodation_type: # From 
v_accommodation_types_localized $ref: 
'#/components/schemas/AccommodationTypeLocalized' booking_status: # From 
v_booking_statuses_localized $ref: 
'#/components/schemas/BookingStatusLocalized' # Direct fields from 
'accommodations' table, translated host_name_or_organization: type: string 
nullable: true description: Translated. [cite: 354] contact_person: type: 
string nullable: true description: Translated. phone_number: type: string 
nullable: true email_address: type: string format: email nullable: true 
website_url: type: string format: url nullable: true booking_url_primary: type: 
string format: url nullable: true booking_notes: type: string nullable: true 
description: Translated. [cite: 354] check_in_time_start: type: string format: 
time nullable: true check_out_time_latest: type: string format: time nullable: 
true # ... other accommodations table fields (opening_months etc.) # Linked 
entities amenities: # Array of linked amenities with their details [cite: 356] 
type: array items: type: object properties: amenity_details: # from 
v_amenities_localized $ref: '#/components/schemas/AmenityLocalized' 
notes_on_amenity: # from accommodation_amenities, translated type: string 
nullable: true room_configurations: # Array [cite: 357] type: array items: 
type: object properties: room_type_details: # from v_room_types_localized $ref: 
'#/components/schemas/RoomTypeLocalized' count_of_this_room_type: type: integer 
price_amount: type: number format: float nullable: true price_currency_code: 
type: string price_is_per_person: type: boolean price_notes: # translated type: 
string nullable: true room_specific_notes: # translated type: string nullable: 
true payment_methods: # Array [cite: 359] type: array items: type: object 
properties: payment_method_details: # from v_payment_methods_localized $ref: 
'#/components/schemas/PaymentMethodLocalized' notes_on_method: # translated 
type: string nullable: true meal_services: # Array [cite: 360] type: array 
items: type: object properties: meal_service_details: # from 
v_meal_services_localized $ref: '#/components/schemas/MealServiceLocalized' 
price_amount: type: number format: float nullable: true price_currency_code: 
type: string price_is_per_person: type: boolean availability_and_timing_notes: 
# translated type: string nullable: true reviews: # Array [cite: 361] type: 
array items: $ref: '#/components/schemas/AccommodationReviewResponse' 
capacity_summary: # From view [cite: 355] type: object properties: 
calculated_total_beds: type: integer calculated_total_rooms: type: integer 
AccommodationReviewResponse: # For GET .../reviews array [cite: 362, 1477] 
type: object properties: id: type: integer format: int64 review_title: # 
Translated type: string nullable: true review_body: # Translated type: string 
language_code: # Original language of review type: string stay_date: type: 
string format: date nullable: true overall_vote: type: string # from 
vote_type_enum nullable: true created_at: type: string format: date-time 
author: # Simplified public author info type: object properties: # profile_id: 
{ type: string, format: uuid } # May not be public display_name: type: string 
nullable: true # From profiles.public_display_name avatar_url: type: string 
format: url nullable: true # From profiles.public_avatar_media_id 
AccommodationReviewSubmission: # For POST /reviews [cite: 1477] type: object 
required: - accommodation_waypoint_id - review_body - language_code properties: 
accommodation_waypoint_id: type: integer format: int64 review_title: type: 
string maxLength: 255 nullable: true review_body: type: string minLength: 1 
maxLength: 2000 language_code: # Explicitly set by client for the submitted 
text type: string example: "en" stay_date: type: string format: date nullable: 
true overall_vote: type: string # vote_type_enum (e.g., "up", "down") nullable: 
true AccommodationReviewUpdate: # For user PUT /reviews/{id} [cite: 1529] type: 
object properties: review_title: type: string maxLength: 255 nullable: true 
review_body: type: string minLength: 1 maxLength: 2000 language_code: # If user 
can correct submission language type: string stay_date: type: string format: 
date nullable: true overall_vote: type: string # vote_type_enum nullable: true 
ReviewModerationUpdate: # For PATCH /admin/reviews/{id}/status [cite: 1477] 
type: object required: - moderation_status properties: moderation_status: type: 
string # content_moderation_status_enum (e.g. "approved_visible") 
moderation_notes_internal: type: string nullable: true security: # Global 
security definition - bearerAuth: [] - apiKey: [] paths: /accommodations: get: 
tags: - Accommodations summary: List accommodations description: Retrieves a 
paginated list of published accommodations, with filtering options. 
operationId: listAccommodations security: - apiKey: [] # Public access, only 
API key needed parameters: - name: lang in: query required: false schema: { 
type: string, example: "it" } description: Language code for localized content. 
[cite: 326] - name: page in: query required: false schema: { type: integer, 
default: 1, minimum: 1 } description: Page number for pagination. [cite: 331] - 
name: per_page in: query required: false schema: { type: integer, default: 20, 
minimum: 1, maximum: 100 } description: Number of items per page. [cite: 331] - 
name: accommodation_type_codes in: query required: false schema: { type: string 
} description: Comma-separated list of accommodation_types_master.code values. 
[cite: 337] - name: amenity_codes in: query required: false schema: { type: 
string } description: Comma-separated list of amenities_master.amenity_code 
values (logical AND). [cite: 338] - name: min_beds in: query required: false 
schema: { type: integer, minimum: 1 } description: Minimum total beds required. 
# relies on accommodations_capacity_summary_view [cite: 338] responses: '200': 
description: A paginated list of accommodation summaries. content: 
application/json: schema: type: object properties: data: type: array items: 
$ref: '#/components/schemas/AccommodationListSummary' pagination: $ref: 
'#/components/schemas/Pagination' default: description: Unexpected error. 
content: application/json: schema: $ref: '#/components/schemas/Error' 
/accommodations/{waypoint_id}: get: tags: - Accommodations summary: Get 
accommodation details description: Retrieves comprehensive details for a single 
accommodation by its waypoint_id. operationId: getAccommodationByWaypointId 
security: - apiKey: [] # Public access parameters: - name: waypoint_id in: path 
required: true schema: { type: integer, format: int64 } description: The 
waypoint ID of the accommodation. [cite: 415] - name: lang in: query required: 
false schema: { type: string, example: "it" } description: Language code for 
localized content. [cite: 349] - name: reviews_limit in: query required: false 
schema: { type: integer, default: 3, minimum: 0 } description: Number of recent 
reviews to include. [cite: 350] responses: '200': description: Detailed 
information about the accommodation. content: application/json: schema: $ref: 
'#/components/schemas/AccommodationDetail' # This response is complex, 
leveraging a DB function (e.g. get_public_accommodation_details) and localized 
views is key. [cite: 368, 434] '404': # [cite: 323] description: Accommodation 
not found. content: application/json: schema: $ref: 
'#/components/schemas/Error' default: description: Unexpected error. content: 
application/json: schema: $ref: '#/components/schemas/Error' /reviews: # For 
accommodation_reviews post: tags: - AccommodationReviews summary: Submit a new 
review for an accommodation description: Allows an authenticated pilgrim to 
submit a review for an accommodation. [cite: 1474] operationId: 
submitAccommodationReview security: - bearerAuth: [] # Requires pilgrim role 
[cite: 1528] - apiKey: [] requestBody: required: true content: 
application/json: schema: $ref: 
'#/components/schemas/AccommodationReviewSubmission' responses: '201': # [cite: 
320] description: Review successfully submitted and pending moderation. 
content: application/json: schema: $ref: 
'#/components/schemas/AccommodationReviewResponse' # Returns the created 
review, with moderation_status set '400': { $ref: 
'#/components/responses/BadRequest' } # [cite: 321] '401': { $ref: 
'#/components/responses/Unauthorized' } # [cite: 322] '403': { $ref: 
'#/components/responses/Forbidden' } # [cite: 322] default: { $ref: 
'#/components/responses/DefaultError' } /reviews/{review_id}: put: # Exemplar 
WRITE endpoint for user self-management tags: - AccommodationReviews summary: 
Update an existing review by its author description: Allows an authenticated 
user to update their own review, typically if it is still pending approval. 
[cite: 1529] operationId: updateMyAccommodationReview security: - bearerAuth: 
[] # Requires ownership & specific RLS conditions - apiKey: [] parameters: - 
name: review_id in: path required: true schema: { type: integer, format: int64 
} description: The ID of the review to update. requestBody: required: true 
content: application/json: schema: $ref: 
'#/components/schemas/AccommodationReviewUpdate' responses: '200': description: 
Review successfully updated. content: application/json: schema: $ref: 
'#/components/schemas/AccommodationReviewResponse' '403': { $ref: 
'#/components/responses/Forbidden' } '404': { $ref: 
'#/components/responses/NotFound' } default: { $ref: 
'#/components/responses/DefaultError' } # Meta endpoints for master data (using 
localized views) /meta/accommodation-types: get: tags: - AccommodationMeta 
summary: List accommodation types description: Retrieves all active 
accommodation types with localized information. operationId: 
listMetaAccommodationTypes security: - apiKey: [] # Public parameters: - name: 
lang in: query required: false schema: { type: string, example: "it" } 
description: Preferred language. The 'all_translations' object will always be 
provided by the view. responses: '200': description: A list of accommodation 
types. content: application/json: schema: type: array items: $ref: 
'#/components/schemas/AccommodationTypeLocalized' # Based on 
v_accommodation_types_localized # This endpoint should query 
public.v_accommodation_types_localized view [cite: 448] default: { $ref: 
'#/components/responses/DefaultError' } /meta/booking-statuses: get: tags: - 
AccommodationMeta summary: List booking statuses operationId: 
listMetaBookingStatuses security: { apiKey: [] } parameters: [{ name: lang, in: 
query, required: false, schema: { type: string } }] responses: '200': 
description: A list of booking statuses. content: { application/json: { schema: 
{ type: array, items: { $ref: '#/components/schemas/BookingStatusLocalized' } } 
} } # Queries public.v_booking_statuses_localized view [cite: 494] default: { 
$ref: '#/components/responses/DefaultError' } /meta/amenities: get: tags: - 
AccommodationMeta summary: List amenities operationId: listMetaAmenities 
security: { apiKey: [] } parameters: [{ name: lang, in: query, required: false, 
schema: { type: string } }] responses: '200': description: A list of amenities. 
content: { application/json: { schema: { type: array, items: { $ref: 
'#/components/schemas/AmenityLocalized' } } } } # Queries 
public.v_amenities_localized view [cite: 654] default: { $ref: 
'#/components/responses/DefaultError' } /meta/room-types: get: tags: - 
AccommodationMeta summary: List room types operationId: listMetaRoomTypes 
security: { apiKey: [] } parameters: [{ name: lang, in: query, required: false, 
schema: { type: string } }] responses: '200': description: A list of room 
types. content: { application/json: { schema: { type: array, items: { $ref: 
'#/components/schemas/RoomTypeLocalized' } } } } # Queries 
public.v_room_types_localized view [cite: 687] default: { $ref: 
'#/components/responses/DefaultError' } /meta/payment-methods: get: tags: - 
AccommodationMeta summary: List payment methods operationId: 
listMetaPaymentMethods security: { apiKey: [] } parameters: [{ name: lang, in: 
query, required: false, schema: { type: string } }] responses: '200': 
description: A list of payment methods. content: { application/json: { schema: 
{ type: array, items: { $ref: '#/components/schemas/PaymentMethodLocalized' } } 
} } # Queries public.v_payment_methods_localized view [cite: 621] default: { 
$ref: '#/components/responses/DefaultError' } /meta/meal-services: get: tags: - 
AccommodationMeta summary: List meal services operationId: listMetaMealServices 
security: { apiKey: [] } parameters: [{ name: lang, in: query, required: false, 
schema: { type: string } }] responses: '200': description: A list of meal 
services. content: { application/json: { schema: { type: array, items: { $ref: 
'#/components/schemas/MealServiceLocalized' } } } } # Queries 
public.v_meal_services_localized view [cite: 718] default: { $ref: 
'#/components/responses/DefaultError' } components: # Re-declaring to ensure 
it's at the root, as per strict OpenAPI structure responses: NotFound: 
description: The specified resource was not found. content: application/json: 
schema: $ref: '#/components/schemas/Error' Unauthorized: description: 
Authentication information is missing or invalid. content: application/json: 
schema: $ref: '#/components/schemas/Error' Forbidden: description: 
Authenticated user does not have permission for this action. content: 
application/json: schema: $ref: '#/components/schemas/Error' BadRequest: 
description: The request was malformed or contained invalid parameters. 
content: application/json: schema: $ref: '#/components/schemas/Error' 
DefaultError: # For unhandled or generic errors description: Unexpected error. 
content: application/json: schema: $ref: '#/components/schemas/Error' ``` * * * 
* * ### Quick-Start Examples 1\. List Accommodations with Filters (Public) Bash 
``` curl -X GET\ 
"https://<YOUR_PROJECT_REF>.supabase.co/rest/v1/accommodations?lang=it&per_page=
1&accommodation_type_codes=b_and_b&amenity_codes=WIFI_INTERNET"\ -H "apikey: 
<SUPABASE_ANON_KEY>"\ -H "Content-Type: application/json" ``` Sample JSON 
Response: JSON ``` { "data": [ { "waypoint_id": 123, "waypoint_name": "B&B 
Sogni D'oro", // Italian, due to lang=it "waypoint_slug": 
"b-and-b-sogni-d-oro", "accommodation_type": { "code": "b_and_b", "label": "Bed 
& Breakfast" // Italian }, "booking_availability_status": { "code": 
"open_bookings_available", "label": "Aperto - Prenotazioni Disponibili", // 
Italian "is_positive_status": true } // ... other simplified fields ... } ], 
"pagination": { "total_items": 1, "total_pages": 1, "current_page": 1, 
"per_page": 1 } } ``` 2\. Get Accommodation Details with Localized Master Data 
(Public) Bash ``` curl -X GET\ 
"https://<YOUR_PROJECT_REF>.supabase.co/rest/v1/accommodations/123?lang=en&revie
ws_limit=1"\ -H "apikey: <SUPABASE_ANON_KEY>"\ -H "Content-Type: 
application/json" ``` Sample JSON Response (Snippet): JSON ``` { "waypoint_id": 
123, "waypoint_name": "B&B Sweet Dreams", // English (lang=en) 
"accommodation_details": { "host_name_or_organization": "Mario Rossi", // 
English "booking_notes": "Call for seasonal discounts.", // English 
"accommodation_type": { // Data from v_accommodation_types_localized or DB 
function "id": 1, // Example ID "code": "b_and_b", "label": "Bed & Breakfast", 
// English label from view's base field "description": "Accommodation in a 
private home offering breakfast.", // English description "icon_identifier": 
"icon-b-and-b", "sort_order": 20, "is_active": true, "all_translations": { // 
The full translation object from the view "en": {"label": "Bed & Breakfast", 
"description": "Accommodation in a private home offering breakfast."}, "it": 
{"label": "Bed & Breakfast", "description": "Alloggio in casa privata che offre 
la colazione."} } } // ... other details ... }, "amenities": [ { 
"amenity_details": { // From v_amenities_localized "id": 5, // Example ID 
"amenity_code": "WIFI_INTERNET", "name": "Wi-Fi Internet", // English name from 
view's base field "description": "Access to wireless internet.", 
"icon_identifier": "wifi", "amenity_category": "Connectivity", 
"is_common_pilgrim_need": true, "sort_order": 10, "is_active": true, 
"all_translations": { "en": {"name": "Wi-Fi Internet", "description": "Access 
to wireless internet.", "amenity_category": "Connectivity"}, "it": {"name": 
"Internet Wi-Fi", "description": "Accesso a internet wireless.", 
"amenity_category": "ConnettivitÃ "} } }, "notes_on_amenity": "Available in 
common areas." // English, from accommodation_amenities } ] // ... other 
sections like room_configurations, reviews ... } ``` 3\. Submit an 
Accommodation Review (Authenticated Pilgrim) Bash ``` curl -X POST\ 
"https://<YOUR_PROJECT_REF>.supabase.co/rest/v1/reviews"\ -H "apikey: 
<SUPABASE_ANON_KEY>"\ -H "Authorization: Bearer <PILGRIM_JWT_ACCESS_TOKEN>"\ -H 
"Content-Type: application/json"\ -H "Prefer: return=representation"\ -d '{ 
"accommodation_waypoint_id": 123, "review_title": "A wonderful refuge", 
"review_body": "The hosts were incredibly kind and the food was amazing. A true 
pilgrim spirit here!", "language_code": "en", "stay_date": "2025-04-10", 
"overall_vote": "up" }' ``` Sample JSON Response (201 Created): JSON ``` { 
"id": 11, "accommodation_waypoint_id": 123, "profile_id": 
"<pilgrim_user_uuid_from_token>", "review_title": "A wonderful refuge", // 
English, as submitted with language_code "en" "review_body": "The hosts were 
incredibly kind and the food was amazing. A true pilgrim spirit here!", 
"language_code": "en", "stay_date": "2025-04-10", "overall_vote": "up", 
"moderation_status": "pending_approval", "is_publicly_visible": false, 
"created_at": "2025-05-18T20:30:00Z" // ... other fields from 
AccommodationReviewResponse schema } ``` * * * * * ### Implementation Notes - 
SQL Views/Indexes for Performance: - The localized views (e.g., 
`v_accommodation_types_localized`, `v_amenities_localized` ) are fundamental 
for the `/meta/*` endpoints and for populating linked master data within the 
`GET /accommodations/{waypoint_id}` response. Their performance relies on a 
robust composite index on `public.translations (table_identifier, 
row_foreign_key, language_code, column_identifier)`. - The 
`public.accommodations_capacity_summary_view` is essential for the `min_beds` 
filter and displaying capacity. - A GIN index on 
`accommodations.opening_months` is necessary for the `opening_month` filter. - 
All foreign keys involved in joins must be indexed. - Endpoints Needing Special 
Attention: - `GET /accommodations/{waypoint_id}`: This endpoint aggregates 
significant data. A PostgreSQL function (e.g., 
`get_public_accommodation_details(p_waypoint_id BIGINT, p_lang TEXT) RETURNS 
JSONB`) is strongly recommended to encapsulate join logic, handle translations 
(utilizing the localized views or direct joins), and structure the JSON output 
efficiently. This will simplify the API layer and allow database-level 
optimizations. Caching for this endpoint is advisable. - `GET /accommodations`: 
Requires pagination. Caching common filter sets would improve user experience. 
- All `/meta/*` endpoints: Good candidates for application-level or CDN caching 
as master data changes infrequently. If the underlying localized views face 
performance issues with very large translation sets, converting them to 
materialized views could be considered in a future iteration. - Schema 
Assessment: - ðŸŸ¢ Schema OK. The database schema for Module 4a, including the 
master tables with direct English storage and linked translations, junction 
tables, `accommodations`, and `accommodation_reviews`, effectively supports the 
API design. The RLS policies defined in individual table specs provide the 
necessary security controls. - Localization Strategy: The API will accept a 
`lang` parameter. - For direct translatable fields on entities (e.g., 
`accommodations.booking_notes`, `accommodation_reviews.review_body`), the API 
backend (preferably via a DB function) will fetch the translation from 
`public.translations` if `lang` is provided and a translation exists, otherwise 
defaulting to the English text from the base column. The OpenAPI schema shows a 
single field (e.g., `booking_notes`) which would contain the resolved text. - 
For linked master data in detailed responses (e.g., the `accommodation_type` 
object within `AccommodationDetail`), the API can leverage the corresponding 
localized view (e.g., `v_accommodation_types_localized`). The response can 
include the `label` (already resolved to the requested `lang` or English by the 
view/function logic if the view is queried with a language filter) and the full 
`all_translations` JSONB object, giving the client flexibility. - Security 
Implementation: RLS policies in the database, using helper functions like 
`public.has_role_on_profile(auth.uid(), 'role_code')` (as per Auth & Security 
Blueprint ), will enforce access control. The API endpoints will rely on 
Supabase Auth for JWT validation and role information. 
