# 4.x todos

  Summary of Proposed Plan: Step 1 : Update the 9 master table specification 
documents in Module 4a to add the recommended label (or name ) index. Step 2 : 
Update the 4.2 Accommodations.docx to add the GIN index on opening_months and 
update its "Future Considerations". Step 3 : Update the relevant junction table 
specifications' "Future Considerations" sections. Step 4 : Create the 9 new, 
individual specification documents for the localized views (e.g., 4.3.v - 
v_accommodation_types_localized.docx , etc.). Does this sequence sound good to 
you? If so, we can start with updating the first master table specification 
document to add its label index. 
https://gemini.google.com/u/1/app/fc0ce8702c9586a4 reviews Table (especially 
for Accommodations): Logical Placement: This fits best as an extension of 
Module 6.0 - User Interaction , as it's primarily user-generated content 
related to waypoints. Alternatively, if reviews become very specific to 
accommodations with unique fields beyond general user feedback, it could be a 
new sub-table within Module 4a.0 - Waypoint - Accommodations , directly linking 
to accommodations.waypoint_id . Recommendation: Start by conceptualizing it 
within Module 6.0 , as it shares characteristics with user_waypoint_short_tips 
(user authorship, moderation, linkage to waypoints and profiles). If it becomes 
highly specialized for accommodations, it could then be more tightly coupled 
with Module 4a.0. 2.1. Dedicated reviews Table (especially for Accommodations): 
Action: Since you'd like this, we need to add a new table specification to your 
documentation set. Proposed Schema for public.accommodation_reviews : | Column 
Name | Data Type | Constraints | Description | | :--------------------------- | 
:--------------------- | 
:-------------------------------------------------------------------------------
- | 
:-------------------------------------------------------------------------------
-------------------------------------------------------- | | id | BIGINT | 
PRIMARY KEY, GENERATED ALWAYS AS IDENTITY | Unique review identifier. | | 
accommodation_waypoint_id | BIGINT | NOT NULL, REFERENCES 
public.accommodations(waypoint_id) ON DELETE CASCADE | Links to the specific 
accommodation being reviewed. | | profile_id | UUID | NOT NULL, REFERENCES 
public.profiles(id) ON DELETE CASCADE | Author of the review. | | review_title 
| TEXT | NULLABLE, CHECK (char_length(review_title) <= 255) | Optional title 
for the review. Translatable. | | review_body | TEXT | NOT NULL, CHECK 
(char_length(review_body) > 0 AND char_length(review_body) <= 2000) | The main 
content of the review. Translatable. (Limit increased from "short tips"). | | 
language_code | TEXT | NOT NULL, REFERENCES 
public.languages_master(language_code) ON DELETE RESTRICT | Language the review 
was originally written in. | | stay_date | DATE | NULLABLE | Optional: when the 
pilgrim stayed at the accommodation. | | overall_vote | vote_type_enum | 
NULLABLE | Optional: a simple thumbs up/down if you want to retain that 
alongside the text review. Could link to user_waypoint_votes or be standalone. 
| | moderation_status | content_moderation_status_enum | NOT NULL, DEFAULT 
'pending_approval' | Moderation status (reuse enum from Module 6.0). | | 
is_publicly_visible | BOOLEAN | NOT NULL, GENERATED ALWAYS AS 
(moderation_status = 'approved_visible' AND deleted_at IS NULL) STORED | 
Auto-calculated visibility (requires PG12+). | | moderated_by_profile_id | UUID 
| NULLABLE, REFERENCES public.profiles(id) ON DELETE SET NULL | Admin/moderator 
who actioned this review. | | moderation_timestamp | TIMESTAMPTZ | NULLABLE | 
When the moderation action was taken. | | moderation_notes_internal | TEXT | 
NULLABLE | Internal notes for moderation. | | created_at | TIMESTAMPTZ | NOT 
NULL, DEFAULT now() | | | updated_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | 
| | deleted_at | TIMESTAMPTZ | NULLABLE | For soft deletion by user or admin. | 
Triggers: Standard updated_at trigger. Consider if inserting a review should 
also create/update a user_waypoint_votes record for consistency if overall_vote 
is included. RLS: Similar to user_waypoint_short_tips (user manages own, mods 
manage all, public reads approved). Translations: review_title , review_body 
link to public.translations . Relevant Modules: New table, closely related to 
Module 4a.0 (Accommodations) and Module 6.0 (User Interaction). 3.1. Array 
Foreign Key Integrity (Reiteration from Phase 1 - focus on implementation now): 
Action: For each table identified in Phase 1.1, write the specific DDL for its 
validation trigger function (similar to public.check_event_theme_tags_exist() 
from Module 4d.0) and CREATE TRIGGER statement. Document this in the 
"Triggers/Functions" section of that table's spec. Relevant Modules: 4.0, 4b.0, 
4c.0, 4d.0. 3.2. Deletion Strategy for Master Records Referenced in Arrays: 
Action: For master tables like tags_master , transport_stop_facilities_master , 
visitor_amenities_master , etc.: Add is_active BOOLEAN NOT NULL DEFAULT true if 
not present. Update the Array FK validation triggers (from step 3.1) on 
referencing tables to check is_active = true in the master table for each ID in 
the array. Document that "retiring" a master entry is done by setting is_active 
= false . Relevant Modules: 4.0, 4b.0, 4c.0, 4d.0. 
