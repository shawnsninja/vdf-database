# 4.13 dietary_option_tags_master

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/34bd37922031b95a 
https://gemini.google.com/u/1/app/21b8e85b3e611787 ### 3\. Updated 
Production-Ready Specification 4.13 Dietary Option Tags Master Table (Version 
1.4) --------------------------------------------------- This document details 
the structure, purpose, and considerations for the `dietary_option_tags_master` 
table. This table is crucial for pilgrims with specific dietary needs. Version 
1.4 updates the RLS policies to align with the platform-wide security and 
authentication strategy using the `public.has_role()` helper function. ### 1\. 
Purpose & Primary Use-Cases The `dietary_option_tags_master` table provides a 
standardized list of dietary options that food establishments might cater to 
(e.g., "Vegetarian Friendly," "Gluten-Free Options," "Vegan Options 
Available"). Its purpose is to enable accurate tagging of establishments, 
allowing pilgrims to easily filter and identify places that meet their dietary 
requirements, and to ensure multilingual consistency for these important 
attributes. Key user-story touchpoints: - Pilgrim: Filtering food 
establishments by specific dietary needs (e.g., finding vegetarian or 
gluten-free meals). (Story A4) - Pilgrim: Quickly identifying if an 
establishment is likely to accommodate their dietary restrictions. - 
Admin/Content Manager: Tagging food establishments with relevant dietary 
options from a managed list, and managing the lifecycle of these tags 
(active/inactive). - System/UI: Populating filter options for dietary needs and 
displaying these options clearly on establishment listings, potentially with 
icons, using active tags. ### 2\. Schema (Markdown Table) *(No change to column 
structure from Version 1.3)* | column | data_type | constraints | description | 
| id | `integer` | Primary Key (Generated as identity always) | Unique 
identifier for the dietary option tag. | | code | `text` | Unique, Not Null, 
CHECK (length(code) > 0 AND length(code) &lt;= 50 AND code ~ '^[a-z0-9_]+$') | 
Short, stable, machine-readable code (e.g., 'vegetarian_friendly', 
'gluten_free'). Snake_case. | | label | `text` | Not Null, CHECK (length(label) 
> 0 AND length(label) &lt;= 100) | Human-readable name in the primary reference 
language (English) for UI display and as a base for translation. Translatable. 
| | description | `text` | Nullable | Optional description in the primary 
reference language (English) clarifying the scope of the dietary option. 
Translatable. | | icon_identifier | `text` | Nullable, CHECK (icon_identifier 
IS NULL OR length(icon_identifier) &lt;= 100) | Name, class, or path for a UI 
icon associated with this dietary option. | | sort_order | `integer` | Not 
Null, Default 0 | Determines the display order in UI lists or filters. | | 
is_active | `boolean` | Not Null, Default true | True if the tag is active and 
available for use; false if retired/archived. Important for array FK 
validation. | | created_at | `timestamp with time zone` | Not Null, Default 
`now()` | Timestamp of record creation. | | updated_at | `timestamp with time 
zone` | Not Null, Default `now()` | Timestamp of last update (auto-updated by 
trigger). | | created_by_profile_id | `uuid` | Nullable, Foreign Key to 
`public.profiles(id)` ON DELETE SET NULL | Profile ID of the user/admin who 
created this dietary option tag record. | | updated_by_profile_id | `uuid` | 
Nullable, Foreign Key to `public.profiles(id)` ON DELETE SET NULL | Profile ID 
of the user/admin who last updated this dietary option tag record. | ### 3\. 
PostgreSQL DDL *(DDL for table structure, comments, triggers, and indexes 
remain the same as Version 1.3. Only the version in the table comment 
changes.)* SQL ``` -- Assumes public.profiles table exists -- Assumes 
public.set_current_timestamp_updated_at() function exists -- Assumes 
public.cleanup_related_translations(TEXT, TEXT) function and specific per-table 
wrapper exist CREATE TABLE public.dietary_option_tags_master ( id INTEGER 
GENERATED ALWAYS AS IDENTITY PRIMARY KEY, code TEXT UNIQUE NOT NULL CHECK 
(length(code) > 0 AND length(code) <= 50 AND code ~ '^[a-z0-9_]+$'), label TEXT 
NOT NULL CHECK (length(label) > 0 AND length(label) <= 100), description TEXT 
NULL, icon_identifier TEXT NULL CHECK (icon_identifier IS NULL OR 
length(icon_identifier) <= 100), sort_order INTEGER NOT NULL DEFAULT 0, 
is_active BOOLEAN NOT NULL DEFAULT true, created_at TIMESTAMPTZ NOT NULL 
DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), 
created_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE SET 
NULL, updated_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE 
SET NULL ); COMMENT ON TABLE public.dietary_option_tags_master IS 'Master list 
of dietary option tags (e.g., vegetarian, gluten-free). Replaces 
dietary_option_tag_enum. Version 1.4'; -- Column comments from Version 1.3 
remain unchanged. E.g.: COMMENT ON COLUMN 
public.dietary_option_tags_master.label IS 'Human-readable name in the primary 
reference language (English) for UI and as a base for translation. Translatable 
via the ''translations'' table. Max 100 chars.'; COMMENT ON COLUMN 
public.dietary_option_tags_master.is_active IS 'True if the tag is active and 
available for use; false if retired. Important for array FK validation.'; 
COMMENT ON COLUMN public.dietary_option_tags_master.created_by_profile_id IS 
'Profile ID of the user/admin who created this record.'; COMMENT ON COLUMN 
public.dietary_option_tags_master.updated_by_profile_id IS 'Profile ID of the 
user/admin who last updated this record.'; -- Indexes (including idx_dotm_label 
from previous update) CREATE INDEX IF NOT EXISTS idx_dotm_is_active ON 
public.dietary_option_tags_master(is_active); CREATE INDEX IF NOT EXISTS 
idx_dotm_sort_order ON public.dietary_option_tags_master(sort_order); CREATE 
INDEX IF NOT EXISTS idx_dotm_label ON public.dietary_option_tags_master(label); 
CREATE INDEX IF NOT EXISTS idx_dotm_created_by_profile_id ON 
public.dietary_option_tags_master(created_by_profile_id) WHERE 
created_by_profile_id IS NOT NULL; CREATE INDEX IF NOT EXISTS 
idx_dotm_updated_by_profile_id ON 
public.dietary_option_tags_master(updated_by_profile_id) WHERE 
updated_by_profile_id IS NOT NULL; -- Trigger for updated_at CREATE TRIGGER 
trigger_dietary_option_tags_master_set_updated_at BEFORE UPDATE ON 
public.dietary_option_tags_master FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); COMMENT ON TRIGGER 
trigger_dietary_option_tags_master_set_updated_at ON 
public.dietary_option_tags_master IS 'Trigger to automatically update 
updated_at timestamp on row modification.'; -- Trigger for orphan translation 
cleanup CREATE OR REPLACE FUNCTION 
public.cleanup_dietary_option_tags_master_translations() RETURNS TRIGGER AS $$ 
BEGIN IF TG_OP = 'DELETE' THEN DELETE FROM public.translations WHERE 
table_identifier = 'dietary_option_tags_master' AND row_foreign_key = 
OLD.id::TEXT; END IF; RETURN OLD; END; $$ LANGUAGE plpgsql SECURITY DEFINER; 
CREATE TRIGGER trigger_cleanup_dietary_option_tags_master_translations AFTER 
DELETE ON public.dietary_option_tags_master FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_dietary_option_tags_master_translations(); COMMENT ON TRIGGER 
trigger_cleanup_dietary_option_tags_master_translations ON 
public.dietary_option_tags_master IS 'Cleans up orphaned translations from 
public.translations when a dietary_option_tags_master record is deleted.'; -- 
Initial Data Example (ensure created_by_profile_id and updated_by_profile_id 
are set appropriately for seed data) INSERT INTO 
public.dietary_option_tags_master (code, label, icon_identifier, sort_order, 
description, is_active, created_by_profile_id, updated_by_profile_id) VALUES 
('vegetarian_friendly', 'Vegetarian Friendly', 'icon-vegetarian', 10, 'Offers 
dishes suitable for vegetarians (no meat, poultry, or fish). May include dairy 
or eggs.', true, NULL, NULL), ('vegan_options_available', 'Vegan Options 
Available', 'icon-vegan', 20, 'Offers dishes suitable for vegans (no animal 
products, including dairy, eggs, and honey).', true, NULL, NULL), -- ... other 
seed data from V1.3 ... ('organic_options', 'Organic Options', 'icon-organic', 
110, 'Offers dishes prepared with certified organic ingredients.', true, NULL, 
NULL); ``` ### 4\. JSON Schema Mirror *(No change from Version 1.3)* JSON ``` { 
"title": "dietary_option_tag_master", "description": "Master list of dietary 
option tags (e.g., vegetarian, gluten-free). Version 1.4", "type": "object", 
"properties": { "id": { /* ... */ }, "code": { /* ... */ }, "label": { /* ... 
*/ }, "description": { /* ... */ }, "icon_identifier": { /* ... */ }, 
"sort_order": { /* ... */ }, "is_active": { /* ... */ }, "created_at": { /* ... 
*/ }, "updated_at": { /* ... */ }, "created_by_profile_id": { /* ... */ }, 
"updated_by_profile_id": { /* ... */ } }, "required": [ /* ... */ ] } ``` ### 
5\. Relationships & Integrity *(No change from Version 1.3)* - Primary Key: 
`id` (INTEGER) - Unique Constraint: `code` must be unique. - Foreign Key 
References FROM other tables: - 
`food_water_sources_details.dietary_option_tag_ids` (an `INTEGER[]` column) 
will contain IDs that reference `dietary_option_tags_master.id`. - Foreign Key 
References TO other tables: - `created_by_profile_id` REFERENCES 
`public.profiles(id)` ON DELETE SET NULL. - `updated_by_profile_id` REFERENCES 
`public.profiles(id)` ON DELETE SET NULL. - Data Integrity Notes: - ðŸ”´ 
CRITICAL: Database triggers on referencing tables (e.g., 
`food_water_sources_details`) *must* be implemented to ensure all IDs in their 
`dietary_option_tag_ids` array correspond to valid `id` entries in 
`dietary_option_tags_master` AND that `dietary_option_tags_master.is_active = 
true`. - Retiring a dietary option tag should be done by setting `is_active = 
false`. ### 6\. Multilingual Strategy *(No change from Version 1.3)* - 
Translatable Fields: `label`, `description`. - Translation Management: Via 
`public.translations` table and orphan cleanup trigger. ### 7\. Role-Based 
Workflow & RLS Notes *(This section is updated to reflect the new auth 
strategy)* - Content Management: This table is typically managed by users with 
the `admin_platform` role. `regional_content_manager` might also manage these 
if dietary options are considered part of regional content characteristics 
relevant to food sources. - Lifecycle: Dietary option tags are made inactive by 
setting `is_active = false`. Physical deletion should be rare. - RLS Policies 
(Assumes `public.has_role(TEXT)` helper function exists): - Public Users 
(Read-Only on active tags): SQL ``` -- Name: Allow public read access to active 
dietary option tags -- Target: dietary_option_tags_master -- Operation: SELECT 
-- Role(s): anon, authenticated CREATE POLICY "Allow public read access to 
active dietary option tags" ON public.dietary_option_tags_master FOR SELECT 
USING (is_active = true); ``` - Platform Administrators / Content Managers 
(Full Control): SQL ``` -- Name: Allow platform content administrators to 
manage dietary option tags -- Target: dietary_option_tags_master -- Operation: 
ALL -- Role(s): admin_platform, regional_content_manager CREATE POLICY "Allow 
platform content administrators to manage dietary option tags" ON 
public.dietary_option_tags_master FOR ALL USING ( auth.role() = 'authenticated' 
AND (public.has_role('admin_platform') OR 
public.has_role('regional_content_manager')) ) WITH CHECK ( auth.role() = 
'authenticated' AND (public.has_role('admin_platform') OR 
public.has_role('regional_content_manager')) ); ``` - Enable RLS: SQL ``` ALTER 
TABLE public.dietary_option_tags_master ENABLE ROW LEVEL SECURITY; ``` - Notes: 
RLS must filter by `is_active = true` for general read access. Array FK 
validation triggers on referencing tables must also check `is_active = true`. 
### 8\. ENUM vs Lookup Discussion *(No change from Version 1.3)* - ðŸŸ¢ Decision: 
Correctly a lookup table. - Reasoning: Crucial user filters, translatable 
names/descriptions, icons, consistency, auditability, lifecycle. ### 9\. UI/UX 
Enablement *(No change from Version 1.3)* - `label` (translated): For filter 
labels, display tags. - `icon_identifier`: To show icons. - `description` 
(translated): For tooltips. - `sort_order`: To list common options first. - 
`is_active`: UI should only use active tags. ### 10\. Key Considerations & 
Definitions *(No change from Version 1.3)* - Clarity is Key: Names/descriptions 
must be unambiguous. - Scope: `description` can clarify "dedicated prep" vs. 
"options available." - "Warning" type tags: UI needs to communicate clearly. - 
Array FK Integrity: Referencing table's trigger logic must check `is_active = 
true`. ### 11\. Scalability & Future-Proofing *(No change from Version 1.3)* - 
Manageable List: Number of common dietary options is manageable. - Flexibility: 
Easy to add new preferences. - Audit Fields & `is_active` flag: Robust. ### 
12\. Next-Action Checklist *(No DDL changes required for this specific update 
beyond what was in V1.3, the main change is to the RLS policy definition in 
this document)* - ðŸ”´ Verify/Implement RLS Helper: Ensure the 
`public.has_role(TEXT)` helper function is correctly implemented and available. 
- ðŸ”´ Apply RLS Policies: Implement and thoroughly test the updated RLS 
policies. - ðŸ”´ Initial Population/Seed Data: Ensure 
`created_by_profile_id`/`updated_by_profile_id` are correctly set for seed 
data. - ðŸŸ  Array FK Integrity: Ensure validation trigger on 
`food_water_sources_details` (for `dietary_option_tag_ids`) checks `is_active = 
true` in this table. - ðŸŸ¢ Icon Set Development: Coordinate with UI/UX team. - 
ðŸŸ¢ Translation Entries: Prepare/verify English entries for `label` and 
`description` in `public.translations`. 
