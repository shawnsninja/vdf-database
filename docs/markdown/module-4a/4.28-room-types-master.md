# 4.28 room_types_master

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/34bd37922031b95a 
https://gemini.google.com/u/1/app/21b8e85b3e611787 * * * * * ### 3\. Updated 
Production-Ready Specification 4.28 Room Types Master Table (Version 1.5) 
------------------------------------------ This document details the structure, 
purpose, and considerations for the `room_types_master` table. This table is 
essential for classifying the different types of rooms accommodations can 
offer. Version 1.5 updates the RLS policies to align with the platform-wide 
security and authentication strategy using the `public.has_role()` helper 
function. ### 1\. Purpose & Primary Use-Cases The `room_types_master` table 
defines a standardized list of room types available in accommodations (e.g., 
"Private Double Room with Ensuite," "4-Bed Mixed Dormitory," "Apartment Unit"). 
Its purpose is to ensure data consistency for room classifications, support 
detailed filtering by room type, allow for multilingual display of room type 
names, and provide essential characteristics of each room type (like typical 
capacity and style) for both pilgrim information and host data entry. Key 
user-story touchpoints: - Pilgrim (Anna): Filtering accommodations based on 
desired room types (e.g., private room vs. dormitory bed). (Story A3) - Pilgrim 
(Anna): Understanding the specifics of room types offered by an accommodation. 
- Accommodation Host (Marco): Specifying the types and quantities of rooms 
their B&amp;B offers, linking to these standard definitions. (Story B1) - 
Admin/Content Manager: Managing the global list of recognized room types, 
including their active status, to ensure clarity and comprehensiveness. - 
System/UI: Populating filter options for room types and displaying room type 
information in a structured way on accommodation listings using active room 
types. ### 2\. Schema (Markdown Table) *(No change to column structure from 
Version 1.4)* | column | data_type | constraints | description | | id | 
`integer` | Primary Key (Generated as identity always) | Unique identifier for 
the room type. | | room_type_code | `text` | Unique, Not Null, CHECK 
(length(room_type_code) > 0 AND length(room_type_code) &lt;= 50 AND 
room_type_code ~ '^[A-Z0-9_]+$') | Short, stable, machine-readable code (e.g., 
"PRIVATE_DOUBLE_ENSUITE"). Uppercase snake_case. | | name | `text` | Not Null, 
CHECK (length(name) > 0 AND length(name) &lt;= 150) | Human-readable name in 
the primary reference language (English). Translatable via the `translations` 
table. | | description | `text` | Nullable | Optional further description of 
the room type in the primary reference language (English). Translatable via the 
`translations` table. | | typical_capacity_persons | `smallint` | Not Null, 
CHECK (typical_capacity_persons > 0 AND typical_capacity_persons &lt; 100) | 
Typical number of people this room type accommodates. | | is_dorm_style | 
`boolean` | Not Null, Default false | True if this typically involves a bed in 
a shared dormitory-style room. | | is_private_occupancy | `boolean` | Not Null, 
Default true | True if this room type implies private occupancy for the booking 
party (not typically shared with strangers if booked as such). False for 
individual dorm beds. | | has_private_bathroom_option | `boolean` | Not Null, 
Default false | Indicates if this room type *can* come with a private (ensuite) 
bathroom. Actual presence confirmed at `accommodation_room_configurations`. | | 
is_entire_unit_rental | `boolean` | Not Null, Default false | True if this 
represents renting an entire self-contained unit like an apartment. | | 
sort_order | `integer` | Not Null, Default 0 | Determines the display order of 
room types in UI lists or selection interfaces. | | is_active | `boolean` | Not 
Null, Default true | True if the room type is active and available for use; 
false if retired/archived. | | created_at | `timestamp with time zone` | Not 
Null, Default `now()` | Timestamp of record creation. | | updated_at | 
`timestamp with time zone` | Not Null, Default `now()` | Timestamp of last 
update (auto-updated by trigger). | | created_by_profile_id | `uuid` | 
Nullable, Foreign Key to `public.profiles(id)` ON DELETE SET NULL | Profile ID 
of the user/admin who created this room type record. | | updated_by_profile_id 
| `uuid` | Nullable, Foreign Key to `public.profiles(id)` ON DELETE SET NULL | 
Profile ID of the user/admin who last updated this room type record. | ### 3\. 
PostgreSQL DDL *(DDL for table structure, comments, triggers, and indexes 
remain the same as Version 1.4. Only the version in the table comment 
changes.)* SQL ``` -- Assumes public.profiles table exists -- Assumes 
public.set_current_timestamp_updated_at() function exists -- Assumes 
public.cleanup_related_translations(TEXT, TEXT) function and specific per-table 
wrapper exist CREATE TABLE public.room_types_master ( id INTEGER GENERATED 
ALWAYS AS IDENTITY PRIMARY KEY, room_type_code TEXT UNIQUE NOT NULL CHECK 
(length(room_type_code) > 0 AND length(room_type_code) <= 50 AND room_type_code 
~ '^[A-Z0-9_]+$'), name TEXT NOT NULL CHECK (length(name) > 0 AND length(name) 
<= 150), description TEXT NULL, typical_capacity_persons SMALLINT NOT NULL 
CHECK (typical_capacity_persons > 0 AND typical_capacity_persons < 100), 
is_dorm_style BOOLEAN NOT NULL DEFAULT FALSE, is_private_occupancy BOOLEAN NOT 
NULL DEFAULT TRUE, has_private_bathroom_option BOOLEAN NOT NULL DEFAULT FALSE, 
is_entire_unit_rental BOOLEAN NOT NULL DEFAULT FALSE, sort_order INTEGER NOT 
NULL DEFAULT 0, is_active BOOLEAN NOT NULL DEFAULT true, created_at TIMESTAMPTZ 
NOT NULL DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), 
created_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE SET 
NULL, updated_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE 
SET NULL ); COMMENT ON TABLE public.room_types_master IS 'Master list defining 
standard types of rooms available in accommodations. Version 1.5'; -- Column 
comments from Version 1.4 remain unchanged. E.g.: COMMENT ON COLUMN 
public.room_types_master.name IS 'Human-readable name in the primary reference 
language (English). Translatable via the ''translations'' table. Max 150 
chars.'; COMMENT ON COLUMN public.room_types_master.is_active IS 'True if the 
room type is active and available for use; false if retired. Defaults to 
true.'; COMMENT ON COLUMN public.room_types_master.created_by_profile_id IS 
'Profile ID of the user/admin who created this record.'; COMMENT ON COLUMN 
public.room_types_master.updated_by_profile_id IS 'Profile ID of the user/admin 
who last updated this record.'; -- Indexes (including idx_rtm_name from 
previous update) CREATE INDEX IF NOT EXISTS idx_rtm_is_active ON 
public.room_types_master(is_active); CREATE INDEX IF NOT EXISTS 
idx_rtm_sort_order ON public.room_types_master(sort_order); CREATE INDEX IF NOT 
EXISTS idx_rtm_name ON public.room_types_master(name); CREATE INDEX IF NOT 
EXISTS idx_rtm_created_by_profile_id ON 
public.room_types_master(created_by_profile_id) WHERE created_by_profile_id IS 
NOT NULL; CREATE INDEX IF NOT EXISTS idx_rtm_updated_by_profile_id ON 
public.room_types_master(updated_by_profile_id) WHERE updated_by_profile_id IS 
NOT NULL; -- Trigger for updated_at CREATE TRIGGER 
trigger_room_types_master_set_updated_at BEFORE UPDATE ON 
public.room_types_master FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); COMMENT ON TRIGGER 
trigger_room_types_master_set_updated_at ON public.room_types_master IS 
'Trigger to automatically update updated_at timestamp on row modification.'; -- 
Trigger for orphan translation cleanup CREATE OR REPLACE FUNCTION 
public.cleanup_room_types_master_translations() RETURNS TRIGGER AS $$ BEGIN IF 
TG_OP = 'DELETE' THEN DELETE FROM public.translations WHERE table_identifier = 
'room_types_master' AND row_foreign_key = OLD.id::TEXT; END IF; RETURN OLD; 
END; $$ LANGUAGE plpgsql SECURITY DEFINER; CREATE TRIGGER 
trigger_cleanup_room_types_master_translations AFTER DELETE ON 
public.room_types_master FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_room_types_master_translations(); COMMENT ON TRIGGER 
trigger_cleanup_room_types_master_translations ON public.room_types_master IS 
'Cleans up orphaned translations from public.translations when a 
room_types_master record is deleted.'; -- Initial Data Example (ensure 
created_by_profile_id and updated_by_profile_id are set appropriately for seed 
data) INSERT INTO public.room_types_master (room_type_code, name, 
typical_capacity_persons, is_dorm_style, is_private_occupancy, 
has_private_bathroom_option, is_entire_unit_rental, sort_order, description, 
is_active, created_by_profile_id, updated_by_profile_id) VALUES 
('DORM_BED_MIXED', 'Bed in Mixed Dormitory', 1, true, false, false, false, 10, 
'A single bed in a dormitory room shared with other guests of any gender. 
Bathroom facilities are typically shared.', true, NULL, NULL), -- ... other 
seed data from V1.4 ... ('OTHER_ROOM_TYPE', 'Other Room Type', 1, false, true, 
false, false, 900, 'A type of room not covered by other standard 
classifications.', true, NULL, NULL); ``` ### 4\. JSON Schema Mirror *(No 
change from Version 1.4)* JSON ``` { "title": "room_type_master", 
"description": "Master list defining standard types of rooms available in 
accommodations. Version 1.5", "type": "object", "properties": { "id": { /* ... 
*/ }, "room_type_code": { /* ... */ }, "name": { /* ... */ }, "description": { 
/* ... */ }, "typical_capacity_persons": { /* ... */ }, "is_dorm_style": { /* 
... */ }, "is_private_occupancy": { /* ... */ }, "has_private_bathroom_option": 
{ /* ... */ }, "is_entire_unit_rental": { /* ... */ }, "sort_order": { /* ... 
*/ }, "is_active": { /* ... */ }, "created_at": { /* ... */ }, "updated_at": { 
/* ... */ }, "created_by_profile_id": { /* ... */ }, "updated_by_profile_id": { 
/* ... */ } }, "required": [ /* ... */ ] } ``` ### 5\. Relationships & 
Integrity *(No change from Version 1.4)* - Primary Key: `id` (INTEGER) - Unique 
Constraint: `room_type_code` must be unique. - Foreign Key References FROM 
other tables: - `accommodation_room_configurations.room_type_id` REFERENCES 
`public.room_types_master(id)` (ON DELETE RESTRICT recommended on junction). - 
Foreign Key References TO other tables: - `created_by_profile_id` REFERENCES 
`public.profiles(id)` ON DELETE SET NULL. - `updated_by_profile_id` REFERENCES 
`public.profiles(id)` ON DELETE SET NULL. - Data Integrity Notes: Retiring a 
room type by `is_active = false`. ### 6\. Multilingual Strategy *(No change 
from Version 1.4)* - Translatable Fields: `name`, `description`. - Translation 
Management: Via `public.translations` table and orphan cleanup trigger. ### 7\. 
Role-Based Workflow & RLS Notes *(This section is updated to reflect the new 
auth strategy)* - Content Management: This table is typically managed by users 
with the `admin_platform` role. - Lifecycle: Room types are made inactive by 
setting `is_active = false`. Physical deletion is restricted by FK from 
`accommodation_room_configurations` if a room type is in use. - RLS Policies 
(Assumes `public.has_role(TEXT)` helper function exists): - Public Users 
(Read-Only on active types): SQL ``` -- Name: Allow public read access to 
active room types master list -- Target: room_types_master -- Operation: SELECT 
-- Role(s): anon, authenticated CREATE POLICY "Allow public read access to 
active room types master list" ON public.room_types_master FOR SELECT USING 
(is_active = true); ``` - Platform Administrators (Full Control): SQL ``` -- 
Name: Allow platform administrators to manage room types master list -- Target: 
room_types_master -- Operation: ALL -- Role(s): admin_platform CREATE POLICY 
"Allow platform administrators to manage room types master list" ON 
public.room_types_master FOR ALL USING ( auth.role() = 'authenticated' AND 
public.has_role('admin_platform') ) WITH CHECK ( auth.role() = 'authenticated' 
AND public.has_role('admin_platform') ); ``` - Enable RLS: SQL ``` ALTER TABLE 
public.room_types_master ENABLE ROW LEVEL SECURITY; ``` - Notes: RLS must 
filter by `is_active = true` for general read access. ### 8\. ENUM vs Lookup 
Discussion *(No change from Version 1.4)* - 🟢 Decision: Correctly a lookup 
table. - Reasoning: Room types have several defining characteristics. Lookup 
table allows central management, translatable names/descriptions, auditability, 
lifecycle. ### 9\. UI/UX Enablement *(No change from Version 1.4)* - `name` 
(translated): For display in filters, listings. - `description` (translated): 
For tooltips. - Boolean flags: For quick characteristic display. - 
`typical_capacity_persons`: Informs users and aids capacity calculation. - 
`sort_order`: Ensures logical listing. - `is_active`: UI should only use active 
room types. ### 10\. Key Considerations & Definitions *(No change from Version 
1.4)* - `room_type_code`: Stable, unique (UPPER_SNAKE_CASE). - Clarity of 
Definitions: Boolean flags and descriptions must be clear. - 
`has_private_bathroom_option`: Indicates possibility; actual configuration in 
`accommodation_room_configurations`. ### 11\. Scalability & Future-Proofing 
*(No change from Version 1.4)* - Manageable List: Number of distinct room types 
will be moderate. - Flexibility: Easy to add new room types or refine 
attributes. - Audit Fields & `is_active` flag: Robust. ### 12\. Next-Action 
Checklist *(No DDL changes required for this specific update beyond what was in 
V1.4, the main change is to the RLS policy definition in this document)* - 🔴 
Verify/Implement RLS Helper: Ensure the `public.has_role(TEXT)` helper function 
is correctly implemented and available. - 🔴 Apply RLS Policies: Implement and 
thoroughly test the updated RLS policies. - 🔴 Initial Population/Seed Data: 
Ensure `created_by_profile_id`/`updated_by_profile_id` are correctly set for 
seed data. - 🟢 Review Definitions: Ensure boolean flags and descriptions 
clearly define each room type. - 🟢 Translation Entries: Prepare/verify English 
entries for `name` and `description` in `public.translations`. 
