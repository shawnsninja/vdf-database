# 4b.0.2 - Views for Module 4b  - attractions

  https://gemini.google.com/u/1/app/d423d51e9f40da78 View Specification: 
`public.v_waypoint_attraction_details_localized` * * * * * 1\. View Name 
`public.v_waypoint_attraction_details_localized` * * * * * 2\. Purpose & 
Primary Use-Cases - Purpose: To provide a comprehensive, denormalized, and 
localized representation of an attraction's details, including its type, 
amenities, descriptive notes, associated media, and religious service 
schedules. - Primary Use-Cases: - Power the API endpoint 
`/waypoints/{waypoint_id}/attraction_details` by simplifying backend query 
logic. - Provide all necessary data for displaying a complete attraction detail 
page in a web or mobile application, with support for internationalization. - 
Facilitate easier data consumption by frontend applications by pre-joining and 
structuring related information. * * * * * 3\. View Schema (Columns) *(This 
view will select from `attractions_details` and join various other tables. The 
`all_translations` column will contain translations for fields directly on 
`attractions_details`. Referenced master data like attraction type, amenities, 
service types, etc., will have their English labels directly included and their 
full translation sets also available within nested JSON structures.)* | Column 
Name | Data Type | Description | | `waypoint_id` | `BIGINT` | Inherited from 
`attractions_details`. Links to `public.waypoints(id)`. PK of the attraction 
detail. | | `attraction_type_id` | `INTEGER` | Inherited from 
`attractions_details`. FK to `public.attraction_types_master(id)`. | | 
`attraction_type_code` | `TEXT` | From `attraction_types_master.code`. | | 
`attraction_type_label` | `TEXT` | Primary reference language (English) label 
from `attraction_types_master.label`. | | `attraction_type_icon_identifier` | 
`TEXT` | From `attraction_types_master.icon_identifier`. | | 
`attraction_type_all_translations` | `JSONB` | All translations for the `label` 
and `description` of the referenced `attraction_types_master` record, keyed by 
language code. | | `detailed_description` | `TEXT` | Primary reference language 
(English) text from `attractions_details.detailed_description`. | | 
`historical_significance_notes` | `TEXT` | Primary reference language (English) 
text from `attractions_details.historical_significance_notes`. | | 
`cultural_significance_notes` | `TEXT` | Primary reference language (English) 
text from `attractions_details.cultural_significance_notes`. | | 
`spiritual_significance_notes` | `TEXT` | Primary reference language (English) 
text from `attractions_details.spiritual_significance_notes`. | | 
`associated_historical_figures_text` | `TEXT[]` | Inherited from 
`attractions_details`. Elements are primary reference language (English). 
(Individual elements translatable via `public.translations` if keyed 
appropriately). | | `key_historical_events_notes` | `TEXT` | Primary reference 
language (English) text from `attractions_details.key_historical_events_notes`. 
| | `opening_hours_structured` | `JSONB` | Inherited from 
`attractions_details.opening_hours_structured`. | | `opening_hours_text_notes` 
| `TEXT` | Primary reference language (English) text from 
`attractions_details.opening_hours_text_notes`. | | 
`opening_hours_last_verified_at` | `TIMESTAMPTZ` | Inherited from 
`attractions_details.opening_hours_last_verified_at`. | | `entry_fee_details` | 
`TEXT` | Primary reference language (English) text from 
`attractions_details.entry_fee_details`. | | `guided_tours_info` | `TEXT` | 
Primary reference language (English) text from 
`attractions_details.guided_tours_info`. | | `audio_guides_info` | `TEXT` | 
Primary reference language (English) text from 
`attractions_details.audio_guides_info`. | | `photography_allowed_notes` | 
`TEXT` | Primary reference language (English) text from 
`attractions_details.photography_allowed_notes`. | | 
`accessibility_details_specific` | `TEXT` | Primary reference language 
(English) text from `attractions_details.accessibility_details_specific`. | | 
`all_translations` | `JSONB` | All translations for translatable fields 
directly on `attractions_details` (e.g., `detailed_description`, 
`historical_significance_notes`, etc.), keyed by language code and then field 
name. | | `visitor_amenities` | `JSONB` | Array of JSON objects, each 
representing a visitor amenity. Includes `id`, `code`, `label` (English), 
`icon_identifier`, and `all_translations` for the amenity's label/description. 
| | `media_gallery` | `JSONB` | Array of JSON objects, each representing a 
media item. Includes `media_id`, `media_role_code`, `alt_text` (English), 
`caption` (English), `image_variants_json`, and `all_translations` for 
alt/caption. | | `religious_services` | `JSONB` | Array of JSON objects, each 
representing a religious service schedule. Includes all fields from 
`religious_service_schedules` with nested translated types and languages. | | 
`data_last_verified_at` | `TIMESTAMPTZ` | Inherited from 
`attractions_details.data_last_verified_at`. | | `created_at` | `TIMESTAMPTZ` | 
Inherited from `attractions_details.created_at`. | | `created_by_full_name` | 
`TEXT` | Full name of the profile that created the attraction detail (joined 
from `public.profiles`). | | `updated_at` | `TIMESTAMPTZ` | Inherited from 
`attractions_details.updated_at`. | | `updated_by_full_name` | `TEXT` | Full 
name of the profile that last updated the attraction detail (joined from 
`public.profiles`). | | `parent_waypoint_name` | `TEXT` | The `name` of the 
parent waypoint from `public.waypoints` (primary language). | | 
`parent_waypoint_slug` | `TEXT` | The `slug` of the parent waypoint from 
`public.waypoints`. | * * * * * 4\. Underlying SQL Definition SQL ``` CREATE OR 
REPLACE VIEW public.v_waypoint_attraction_details_localized AS WITH 
attraction_details_translations AS ( SELECT tr.row_foreign_key AS 
waypoint_id_text, jsonb_object_agg( tr.language_code, 
jsonb_strip_nulls(jsonb_build_object( 'detailed_description', MAX(CASE WHEN 
tr.column_identifier = 'detailed_description' THEN tr.translated_text ELSE NULL 
END), 'historical_significance_notes', MAX(CASE WHEN tr.column_identifier = 
'historical_significance_notes' THEN tr.translated_text ELSE NULL END), 
'cultural_significance_notes', MAX(CASE WHEN tr.column_identifier = 
'cultural_significance_notes' THEN tr.translated_text ELSE NULL END), 
'spiritual_significance_notes', MAX(CASE WHEN tr.column_identifier = 
'spiritual_significance_notes' THEN tr.translated_text ELSE NULL END), 
'key_historical_events_notes', MAX(CASE WHEN tr.column_identifier = 
'key_historical_events_notes' THEN tr.translated_text ELSE NULL END), 
'opening_hours_text_notes', MAX(CASE WHEN tr.column_identifier = 
'opening_hours_text_notes' THEN tr.translated_text ELSE NULL END), 
'entry_fee_details', MAX(CASE WHEN tr.column_identifier = 'entry_fee_details' 
THEN tr.translated_text ELSE NULL END), 'guided_tours_info', MAX(CASE WHEN 
tr.column_identifier = 'guided_tours_info' THEN tr.translated_text ELSE NULL 
END), 'audio_guides_info', MAX(CASE WHEN tr.column_identifier = 
'audio_guides_info' THEN tr.translated_text ELSE NULL END), 
'photography_allowed_notes', MAX(CASE WHEN tr.column_identifier = 
'photography_allowed_notes' THEN tr.translated_text ELSE NULL END), 
'accessibility_details_specific', MAX(CASE WHEN tr.column_identifier = 
'accessibility_details_specific' THEN tr.translated_text ELSE NULL END) -- 
Note: translations for 'associated_historical_figures_text' (TEXT[]) elements 
are complex here and often handled at application layer or by transforming the 
array into related rows for translation. )) ) AS all_translations FROM 
public.translations tr WHERE tr.table_identifier = 'attractions_details' GROUP 
BY tr.row_foreign_key ), attraction_type_translations AS ( SELECT 
tr.row_foreign_key AS type_id_text, jsonb_object_agg( tr.language_code, 
jsonb_strip_nulls(jsonb_build_object( 'label', MAX(CASE WHEN 
tr.column_identifier = 'label' THEN tr.translated_text ELSE NULL END), 
'description', MAX(CASE WHEN tr.column_identifier = 'description' THEN 
tr.translated_text ELSE NULL END) )) ) AS all_translations FROM 
public.translations tr WHERE tr.table_identifier = 'attraction_types_master' 
GROUP BY tr.row_foreign_key ), visitor_amenity_translations AS ( SELECT 
tr.row_foreign_key AS amenity_id_text, jsonb_object_agg( tr.language_code, 
jsonb_strip_nulls(jsonb_build_object( 'label', MAX(CASE WHEN 
tr.column_identifier = 'label' THEN tr.translated_text ELSE NULL END), 
'description', MAX(CASE WHEN tr.column_identifier = 'description' THEN 
tr.translated_text ELSE NULL END) )) ) AS all_translations FROM 
public.translations tr WHERE tr.table_identifier = 'visitor_amenities_master' 
GROUP BY tr.row_foreign_key ), religious_service_type_translations AS ( SELECT 
tr.row_foreign_key AS type_id_text, jsonb_object_agg( tr.language_code, 
jsonb_strip_nulls(jsonb_build_object( 'label', MAX(CASE WHEN 
tr.column_identifier = 'label' THEN tr.translated_text ELSE NULL END), 
'description', MAX(CASE WHEN tr.column_identifier = 'description' THEN 
tr.translated_text ELSE NULL END) )) ) AS all_translations FROM 
public.translations tr WHERE tr.table_identifier = 
'religious_service_types_master' GROUP BY tr.row_foreign_key ), 
religious_service_schedule_translations AS ( SELECT tr.row_foreign_key as 
schedule_id_text, jsonb_object_agg( tr.language_code, 
jsonb_strip_nulls(jsonb_build_object( 'schedule_description_text', MAX(CASE 
WHEN tr.column_identifier = 'schedule_description_text' THEN tr.translated_text 
ELSE NULL END), 'language_notes', MAX(CASE WHEN tr.column_identifier = 
'language_notes' THEN tr.translated_text ELSE NULL END), 
'location_within_site_notes', MAX(CASE WHEN tr.column_identifier = 
'location_within_site_notes' THEN tr.translated_text ELSE NULL END), 
'seasonal_validity_notes', MAX(CASE WHEN tr.column_identifier = 
'seasonal_validity_notes' THEN tr.translated_text ELSE NULL END), 
'service_notes', MAX(CASE WHEN tr.column_identifier = 'service_notes' THEN 
tr.translated_text ELSE NULL END) )) ) AS all_translations FROM 
public.translations tr WHERE tr.table_identifier = 
'religious_service_schedules' GROUP BY tr.row_foreign_key ), 
attraction_media_translations AS ( SELECT tr.row_foreign_key AS 
media_link_id_text, jsonb_object_agg( tr.language_code, 
jsonb_strip_nulls(jsonb_build_object( 'caption_override', MAX(CASE WHEN 
tr.column_identifier = 'caption_override' THEN tr.translated_text ELSE NULL 
END), 'alt_text_override', MAX(CASE WHEN tr.column_identifier = 
'alt_text_override' THEN tr.translated_text ELSE NULL END) )) ) AS 
all_translations FROM public.translations tr WHERE tr.table_identifier = 
'attraction_details_media' GROUP BY tr.row_foreign_key ) SELECT ad.waypoint_id, 
ad.attraction_type_id, atm.code AS attraction_type_code, atm.label AS 
attraction_type_label, -- English label atm.icon_identifier AS 
attraction_type_icon_identifier, COALESCE(att_type_tr.all_translations, 
'{}'::jsonb) AS attraction_type_all_translations, ad.detailed_description, 
ad.historical_significance_notes, ad.cultural_significance_notes, 
ad.spiritual_significance_notes, ad.associated_historical_figures_text, 
ad.key_historical_events_notes, ad.opening_hours_structured, 
ad.opening_hours_text_notes, ad.opening_hours_last_verified_at, 
ad.entry_fee_details, ad.guided_tours_info, ad.audio_guides_info, 
ad.photography_allowed_notes, ad.accessibility_details_specific, 
COALESCE(ad_tr.all_translations, '{}'::jsonb) AS all_translations, ( SELECT 
jsonb_agg( jsonb_build_object( 'id', vam.id, 'code', vam.code, 'label', 
vam.label, -- English label 'icon_identifier', vam.icon_identifier, 
'all_translations', COALESCE(vam_tr.all_translations, '{}'::jsonb) ) ORDER BY 
vam.label -- Or some sort_order if available ) FROM 
unnest(ad.visitor_amenity_ids) amenity_id JOIN public.visitor_amenities_master 
vam ON vam.id = amenity_id LEFT JOIN visitor_amenity_translations vam_tr ON 
vam_tr.amenity_id_text = vam.id::TEXT WHERE ad.visitor_amenity_ids IS NOT NULL 
) AS visitor_amenities, ( SELECT jsonb_agg( jsonb_build_object( 'media_id', 
adm_link.media_id, 'media_role_code', adm_link.media_role_code, 
'display_order', adm_link.display_order, 'caption_override', 
adm_link.caption_override, -- English 'alt_text_override', 
adm_link.alt_text_override, -- English 'all_translations', 
COALESCE(adm_tr.all_translations, '{}'::jsonb), 'image_variants_json', 
med.image_variants_json, 'original_file_name', med.file_name_original, 
'original_mime_type', med.file_mime_type ) ORDER BY adm_link.display_order ) 
FROM public.attraction_details_media adm_link JOIN public.media med ON med.id = 
adm_link.media_id LEFT JOIN attraction_media_translations adm_tr ON 
adm_tr.media_link_id_text = adm_link.id::TEXT WHERE 
adm_link.attraction_waypoint_id = ad.waypoint_id ) AS media_gallery, ( SELECT 
jsonb_agg( jsonb_build_object( 'id', rs.id, 'service_type_id', 
rs.service_type_id, 'service_type_code', rstm.code, 'service_type_label', 
rstm.label, -- English 'service_type_icon_identifier', rstm.icon_identifier, 
'service_type_all_translations', COALESCE(rst_tr.all_translations, 
'{}'::jsonb), 'schedule_description_text', rs.schedule_description_text, -- 
English 'days_of_week', rs.days_of_week, 'time_of_day', rs.time_of_day, 
'language_code', rs.language_code, 'language_name_en', lm.display_name_en, -- 
Assumes languages_master has display_name_en 'language_all_translations', 
jsonb_build_object(lm.language_code, jsonb_build_object('name', 
lm.display_name_native)), -- Simplified, needs full lang translations 
'language_notes', rs.language_notes, -- English 'location_within_site_notes', 
rs.location_within_site_notes, -- English 'seasonal_validity_notes', 
rs.seasonal_validity_notes, -- English 'is_pilgrim_specific_service', 
rs.is_pilgrim_specific_service, 'service_notes', rs.service_notes, -- English 
'all_translations', COALESCE(rs_tr.all_translations, '{}'::jsonb), 
'data_last_verified_at', rs.data_last_verified_at ) ORDER BY rstm.sort_order, 
rs.time_of_day NULLS FIRST ) FROM public.religious_service_schedules rs JOIN 
public.religious_service_types_master rstm ON rstm.id = rs.service_type_id LEFT 
JOIN public.languages_master lm ON lm.language_code = rs.language_code LEFT 
JOIN religious_service_type_translations rst_tr ON rst_tr.type_id_text = 
rstm.id::TEXT LEFT JOIN religious_service_schedule_translations rs_tr ON 
rs_tr.schedule_id_text = rs.id::TEXT WHERE rs.attraction_waypoint_id = 
ad.waypoint_id ) AS religious_services, ad.data_last_verified_at, 
ad.created_at, creator_profile.full_name AS created_by_full_name, 
ad.updated_at, updater_profile.full_name AS updated_by_full_name, wp.name AS 
parent_waypoint_name, -- English name from waypoints wp.slug AS 
parent_waypoint_slug FROM public.attractions_details ad JOIN public.waypoints 
wp ON ad.waypoint_id = wp.id -- For parent waypoint info & RLS context JOIN 
public.attraction_types_master atm ON ad.attraction_type_id = atm.id LEFT JOIN 
attraction_details_translations ad_tr ON ad_tr.waypoint_id_text = 
ad.waypoint_id::TEXT LEFT JOIN attraction_type_translations att_type_tr ON 
att_type_tr.type_id_text = atm.id::TEXT LEFT JOIN public.profiles 
creator_profile ON ad.created_by_profile_id = creator_profile.id LEFT JOIN 
public.profiles updater_profile ON ad.updated_by_profile_id = 
updater_profile.id; COMMENT ON VIEW 
public.v_waypoint_attraction_details_localized IS 'Provides a denormalized and 
localized view of attraction details, including types, amenities, media, and 
religious service schedules. Version 1.0'; ``` * * * * * 5\. Key Dependencies - 
`public.attractions_details` (V1.3) - `public.waypoints` (V1.3+ assumed for 
fields like `name`, `slug`, `content_visibility_status_id`, `deleted_at`) - 
`public.attraction_types_master` (V1.1) - `public.visitor_amenities_master` 
(V1.1) - `public.religious_service_schedules` (V1.3) - 
`public.religious_service_types_master` (V1.1) - `public.languages_master` 
(V2.1) - `public.media` (V2.2) - `public.attraction_details_media` (V1.0) - 
`public.media_roles_master` - `public.translations` (V2.1) - `public.profiles` 
(for `created_by`/`updated_by` names) - `public.content_statuses_master` (for 
RLS via `waypoints`) * * * * * 6\. Performance Considerations - Complex Joins: 
The view involves numerous joins and subqueries, especially for aggregating 
translations and nested JSON arrays (amenities, media, services). This can be 
resource-intensive. - Translation Aggregation: The CTEs for `*_translations` 
use `jsonb_object_agg` and `GROUP BY`, which can be costly on a large 
`translations` table. Ensure `translations.table_identifier`, 
`translations.column_identifier`, and `translations.row_foreign_key` are 
well-indexed. The existing `idx_translations_lookup` is good. - Array 
Expansion: Unnesting `visitor_amenity_ids` and then joining to 
`visitor_amenities_master` and its translations for each attraction can be 
intensive if there are many amenities per attraction or many attractions 
queried at once. - JSONB Aggregation: Using `jsonb_agg` for 
`visitor_amenities`, `media_gallery`, and `religious_services` adds overhead. - 
Indexes on Base Tables: - All foreign key columns used in joins in the base 
tables must be indexed (e.g., `attractions_details.attraction_type_id`, 
`religious_service_schedules.service_type_id`, etc.). - The `row_foreign_key` 
in `public.translations` should be indexed. - `waypoints.id` (PK), 
`attractions_details.waypoint_id` (PK). - Materialized View: If read 
performance for this aggregated data becomes critical and the underlying data 
doesn't change with extremely high frequency, converting this view to a 
MATERIALIZED VIEW (refreshed periodically) would significantly improve query 
speed for the API. The refresh strategy (e.g., on commit, nightly) would need 
careful consideration. - Filtering: If this view is queried with `WHERE` 
clauses on fields from `attractions_details` or `waypoints`, ensure those base 
table columns are indexed. * * * * * 7\. RLS & Security Notes - The view itself 
does not have RLS policies applied directly. Access to data through this view 
is governed by the RLS policies on the underlying base tables, primarily 
`public.attractions_details` and `public.waypoints`. - A user querying this 
view will only see rows for attractions they are permitted to see based on the 
`SELECT` policies on `attractions_details`. The `attractions_details` RLS 
policy, in turn, checks the publication status and soft-deletion status of the 
parent `waypoints` record. - The `SECURITY DEFINER` option might be necessary 
for the translation CTE functions if direct access to `public.translations` is 
restricted for the querying role but the view needs to aggregate this data. 
However, it's generally safer for views to operate with `SECURITY INVOKER` 
(default) if RLS on base tables allows sufficient access. The CTEs in the 
provided SQL are part of the main view query and will run with the view 
invoker's permissions. * * * * * 8\. API Endpoints Supported - Primarily 
supports: `/waypoints/{waypoint_id}/attraction_details` (GET). - The API 
backend would query this view using `WHERE waypoint_id = {input_id}`. - The 
`lang` query parameter would be handled by the API backend to select the 
appropriate translated text from the `all_translations` JSONB objects within 
the view's results or by using the primary language fields. * * * * * 9\. 
Rationale for Creation - Simplification: Drastically simplifies query logic in 
the API backend by providing a pre-joined, structured, and localized dataset 
for attractions. - Consistency: Ensures a consistent data structure is 
available for attraction details across different parts of the application. - 
Maintainability: Centralizes the complex data aggregation and localization 
logic in the database layer, making the application code cleaner. - Performance 
(Potential): While complex, a well-indexed view (or materialized view) can be 
more performant than having the application execute multiple discrete queries 
and assemble the data itself. ------ View Specification: 
`public.v_waypoint_food_water_source_details_localized` * * * * * 1\. View Name 
`public.v_waypoint_food_water_source_details_localized` * * * * * 2\. Purpose & 
Primary Use-Cases - Purpose: To provide a comprehensive, denormalized, and 
localized representation of a food or water source's details, including its 
type, potability, reliability, operational notes, associated media, and any 
commercial aspects like price range or meal types. - Primary Use-Cases: - Power 
the API endpoint `/waypoints/{waypoint_id}/food_water_source_details` by 
simplifying backend query logic. - Provide all necessary data for displaying a 
complete food/water source detail page in a web or mobile application, with 
support for internationalization. - Enable users to easily understand the 
nature, reliability, and specifics of a food or water point. * * * * * 3\. View 
Schema (Columns) *(This view will select from `food_water_sources_details` and 
join various other tables. Referenced master data will have English labels 
directly included and their full translation sets also available within nested 
JSON structures.)* | Column Name | Data Type | Description | | `waypoint_id` | 
`BIGINT` | Inherited from `food_water_sources_details`. Links to 
`public.waypoints(id)`. PK of the detail record. | | `source_type_id` | 
`INTEGER` | Inherited from `food_water_sources_details`. FK to 
`public.food_water_source_types_master(id)`. | | `source_type_code` | `TEXT` | 
From `food_water_source_types_master.code`. | | `source_type_label` | `TEXT` | 
Primary reference language (English) label from 
`food_water_source_types_master.label`. | | `source_type_is_commercial` | 
`BOOLEAN` | From `food_water_source_types_master.is_commercial`. | | 
`source_type_icon_identifier` | `TEXT` | From 
`food_water_source_types_master.icon_identifier`. | | 
`source_type_all_translations` | `JSONB` | All translations for the `label` and 
`description` of the referenced `food_water_source_types_master` record. | | 
`is_potable_water_source` | `BOOLEAN` | Inherited from 
`food_water_sources_details.is_potable_water_source`. | | 
`water_reliability_id` | `INTEGER` | Inherited from 
`food_water_sources_details`. FK to 
`public.water_reliability_types_master(id)`. | | `water_reliability_code` | 
`TEXT` | From `water_reliability_types_master.code`. | | 
`water_reliability_label` | `TEXT` | Primary reference language (English) label 
from `water_reliability_types_master.label`. | | 
`water_reliability_icon_identifier` | `TEXT` | From 
`water_reliability_types_master.icon_identifier`. | | 
`water_reliability_advisory_level` | `SMALLINT` | From 
`water_reliability_types_master.advisory_level`. | | 
`water_reliability_all_translations` | `JSONB` | All translations for the 
`label` and `description` of the referenced `water_reliability_types_master` 
record. | | `water_source_access_notes` | `TEXT` | Primary reference language 
(English) text from `food_water_sources_details.water_source_access_notes`. | | 
`establishment_price_range_id` | `INTEGER` | Inherited from 
`food_water_sources_details`. FK to 
`public.establishment_price_ranges_master(id)`. | | 
`establishment_price_range_code` | `TEXT` | From 
`establishment_price_ranges_master.code`. | | `establishment_price_range_label` 
| `TEXT` | Primary reference language (English) label from 
`establishment_price_ranges_master.label`. | | 
`establishment_price_range_symbol` | `TEXT` | From 
`establishment_price_ranges_master.symbol`. | | 
`establishment_price_range_all_translations` | `JSONB` | All translations for 
the `label` and `description` of the referenced 
`establishment_price_ranges_master` record. | | 
`highlighted_dishes_local_specialties` | `TEXT[]` | Inherited from 
`food_water_sources_details`. Elements are primary reference language 
(English). (Individual elements translatable via `public.translations` if keyed 
appropriately). | | `opening_hours_structured` | `JSONB` | Inherited from 
`food_water_sources_details.opening_hours_structured`. | | 
`opening_hours_text_notes` | `TEXT` | Primary reference language (English) text 
from `food_water_sources_details.opening_hours_text_notes`. | | 
`opening_hours_last_verified_at` | `TIMESTAMPTZ` | Inherited from 
`food_water_sources_details.opening_hours_last_verified_at`. | | 
`outdoor_seating_available` | `BOOLEAN` | Inherited from 
`food_water_sources_details.outdoor_seating_available`. | | 
`specific_notes_for_pilgrims` | `TEXT` | Primary reference language (English) 
text from `food_water_sources_details.specific_notes_for_pilgrims`. | | 
`all_translations` | `JSONB` | All translations for translatable fields 
directly on `food_water_sources_details` (e.g., `water_source_access_notes`, 
etc.), keyed by language code and then field name. | | `serves_meal_types` | 
`JSONB` | Array of JSON objects, each representing a meal type. Includes `id`, 
`code`, `label` (English), `icon_identifier`, and `all_translations` for the 
meal type's label. | | `dietary_options` | `JSONB` | Array of JSON objects, 
each representing a dietary option. Includes `id`, `code`, `label` (English), 
`icon_identifier`, and `all_translations` for the option's label/description. | 
| `payment_methods` | `JSONB` | Array of JSON objects, each representing a 
payment method. Includes `id`, `code`, `label` (English), `icon_identifier`, 
and `all_translations` for the method's label/description. | | `media_gallery` 
| `JSONB` | Array of JSON objects, each representing a media item. Includes 
`media_id`, `media_role_code`, `alt_text` (English), `caption` (English), 
`image_variants_json`, and `all_translations` for alt/caption. | | 
`data_last_verified_at` | `TIMESTAMPTZ` | Inherited from 
`food_water_sources_details.data_last_verified_at`. | | `created_at` | 
`TIMESTAMPTZ` | Inherited from `food_water_sources_details.created_at`. | | 
`created_by_full_name` | `TEXT` | Full name of the profile that created the 
record (joined from `public.profiles`). | | `updated_at` | `TIMESTAMPTZ` | 
Inherited from `food_water_sources_details.updated_at`. | | 
`updated_by_full_name` | `TEXT` | Full name of the profile that last updated 
the record (joined from `public.profiles`). | | `parent_waypoint_name` | `TEXT` 
| The `name` of the parent waypoint from `public.waypoints` (primary language). 
| | `parent_waypoint_slug` | `TEXT` | The `slug` of the parent waypoint from 
`public.waypoints`. | * * * * * 4\. Underlying SQL Definition SQL ``` CREATE OR 
REPLACE VIEW public.v_waypoint_food_water_source_details_localized AS WITH 
direct_translations AS ( SELECT tr.row_foreign_key AS waypoint_id_text, 
jsonb_object_agg( tr.language_code, jsonb_strip_nulls(jsonb_build_object( 
'water_source_access_notes', MAX(CASE WHEN tr.column_identifier = 
'water_source_access_notes' THEN tr.translated_text ELSE NULL END), 
'opening_hours_text_notes', MAX(CASE WHEN tr.column_identifier = 
'opening_hours_text_notes' THEN tr.translated_text ELSE NULL END), 
'specific_notes_for_pilgrims', MAX(CASE WHEN tr.column_identifier = 
'specific_notes_for_pilgrims' THEN tr.translated_text ELSE NULL END) -- 
highlighted_dishes_local_specialties TEXT[] elements are translated 
individually if needed, complex for this CTE. )) ) AS all_translations FROM 
public.translations tr WHERE tr.table_identifier = 'food_water_sources_details' 
GROUP BY tr.row_foreign_key ), source_type_translations AS ( SELECT 
tr.row_foreign_key AS master_id_text, jsonb_object_agg(tr.language_code, 
jsonb_strip_nulls(jsonb_build_object('label', MAX(CASE WHEN 
tr.column_identifier = 'label' THEN tr.translated_text ELSE NULL 
END),'description', MAX(CASE WHEN tr.column_identifier = 'description' THEN 
tr.translated_text ELSE NULL END)))) AS all_translations FROM 
public.translations tr WHERE tr.table_identifier = 
'food_water_source_types_master' GROUP BY tr.row_foreign_key ), 
reliability_translations AS ( SELECT tr.row_foreign_key AS master_id_text, 
jsonb_object_agg(tr.language_code, 
jsonb_strip_nulls(jsonb_build_object('label', MAX(CASE WHEN 
tr.column_identifier = 'label' THEN tr.translated_text ELSE NULL 
END),'description', MAX(CASE WHEN tr.column_identifier = 'description' THEN 
tr.translated_text ELSE NULL END)))) AS all_translations FROM 
public.translations tr WHERE tr.table_identifier = 
'water_reliability_types_master' GROUP BY tr.row_foreign_key ), 
price_range_translations AS ( SELECT tr.row_foreign_key AS master_id_text, 
jsonb_object_agg(tr.language_code, 
jsonb_strip_nulls(jsonb_build_object('label', MAX(CASE WHEN 
tr.column_identifier = 'label' THEN tr.translated_text ELSE NULL 
END),'description', MAX(CASE WHEN tr.column_identifier = 'description' THEN 
tr.translated_text ELSE NULL END)))) AS all_translations FROM 
public.translations tr WHERE tr.table_identifier = 
'establishment_price_ranges_master' GROUP BY tr.row_foreign_key ), 
meal_type_translations AS ( SELECT tr.row_foreign_key AS master_id_text, 
jsonb_object_agg(tr.language_code, 
jsonb_strip_nulls(jsonb_build_object('label', MAX(CASE WHEN 
tr.column_identifier = 'label' THEN tr.translated_text ELSE NULL END)))) AS 
all_translations FROM public.translations tr WHERE tr.table_identifier = 
'meal_type_tags_master' GROUP BY tr.row_foreign_key ), 
dietary_option_translations AS ( SELECT tr.row_foreign_key AS master_id_text, 
jsonb_object_agg(tr.language_code, 
jsonb_strip_nulls(jsonb_build_object('label', MAX(CASE WHEN 
tr.column_identifier = 'label' THEN tr.translated_text ELSE NULL END)))) AS 
all_translations FROM public.translations tr WHERE tr.table_identifier = 
'dietary_option_tags_master' GROUP BY tr.row_foreign_key ), 
payment_method_translations AS ( SELECT tr.row_foreign_key AS master_id_text, 
jsonb_object_agg(tr.language_code, 
jsonb_strip_nulls(jsonb_build_object('label', MAX(CASE WHEN 
tr.column_identifier = 'label' THEN tr.translated_text ELSE NULL END)))) AS 
all_translations FROM public.translations tr WHERE tr.table_identifier = 
'payment_methods_master' GROUP BY tr.row_foreign_key ), fw_media_translations 
AS ( SELECT tr.row_foreign_key AS media_link_id_text, 
jsonb_object_agg(tr.language_code, 
jsonb_strip_nulls(jsonb_build_object('caption_override', MAX(CASE WHEN 
tr.column_identifier = 'caption_override' THEN tr.translated_text ELSE NULL 
END), 'alt_text_override', MAX(CASE WHEN tr.column_identifier = 
'alt_text_override' THEN tr.translated_text ELSE NULL END)))) AS 
all_translations FROM public.translations tr WHERE tr.table_identifier = 
'food_water_source_media' GROUP BY tr.row_foreign_key ) SELECT 
fwsd.waypoint_id, fwsd.source_type_id, fstm.code AS source_type_code, 
fstm.label AS source_type_label, -- English fstm.is_commercial AS 
source_type_is_commercial, fstm.icon_identifier AS source_type_icon_identifier, 
COALESCE(st_tr.all_translations, '{}'::jsonb) AS source_type_all_translations, 
fwsd.is_potable_water_source, fwsd.water_reliability_id, wrtm.code AS 
water_reliability_code, wrtm.label AS water_reliability_label, -- English 
wrtm.icon_identifier AS water_reliability_icon_identifier, wrtm.advisory_level 
AS water_reliability_advisory_level, COALESCE(wr_tr.all_translations, 
'{}'::jsonb) AS water_reliability_all_translations, 
fwsd.water_source_access_notes, -- English fwsd.establishment_price_range_id, 
eprm.code AS establishment_price_range_code, eprm.label AS 
establishment_price_range_label, -- English eprm.symbol AS 
establishment_price_range_symbol, COALESCE(epr_tr.all_translations, 
'{}'::jsonb) AS establishment_price_range_all_translations, 
fwsd.highlighted_dishes_local_specialties, -- English array 
fwsd.opening_hours_structured, fwsd.opening_hours_text_notes, -- English 
fwsd.opening_hours_last_verified_at, fwsd.outdoor_seating_available, 
fwsd.specific_notes_for_pilgrims, -- English COALESCE(fwsd_tr.all_translations, 
'{}'::jsonb) AS all_translations, (SELECT jsonb_agg(jsonb_build_object('id', 
mttm.id, 'code', mttm.code, 'label', mttm.label, 'icon_identifier', 
mttm.icon_identifier, 'all_translations', COALESCE(mt_tr.all_translations, 
'{}'::jsonb))) FROM unnest(fwsd.serves_meal_type_tag_ids) tag_id JOIN 
public.meal_type_tags_master mttm ON mttm.id = tag_id LEFT JOIN 
meal_type_translations mt_tr ON mt_tr.master_id_text = mttm.id::TEXT WHERE 
fwsd.serves_meal_type_tag_ids IS NOT NULL) AS serves_meal_types, (SELECT 
jsonb_agg(jsonb_build_object('id', dotm.id, 'code', dotm.code, 'label', 
dotm.label, 'icon_identifier', dotm.icon_identifier, 'all_translations', 
COALESCE(do_tr.all_translations, '{}'::jsonb))) FROM 
unnest(fwsd.dietary_option_tag_ids) tag_id JOIN 
public.dietary_option_tags_master dotm ON dotm.id = tag_id LEFT JOIN 
dietary_option_translations do_tr ON do_tr.master_id_text = dotm.id::TEXT WHERE 
fwsd.dietary_option_tag_ids IS NOT NULL) AS dietary_options, (SELECT 
jsonb_agg(jsonb_build_object('id', pmm.id, 'code', pmm.code, 'label', 
pmm.label, 'icon_identifier', pmm.icon_identifier, 'all_translations', 
COALESCE(pm_tr.all_translations, '{}'::jsonb))) FROM 
unnest(fwsd.payment_method_tag_ids) tag_id JOIN public.payment_methods_master 
pmm ON pmm.id = tag_id LEFT JOIN payment_method_translations pm_tr ON 
pm_tr.master_id_text = pmm.id::TEXT WHERE fwsd.payment_method_tag_ids IS NOT 
NULL) AS payment_methods, (SELECT jsonb_agg(jsonb_build_object('media_id', 
fwm_link.media_id, 'media_role_code', fwm_link.media_role_code, 
'display_order', fwm_link.display_order, 'caption_override', 
fwm_link.caption_override, 'alt_text_override', fwm_link.alt_text_override, 
'all_translations', COALESCE(fwm_tr.all_translations, 
'{}'::jsonb),'image_variants_json', med.image_variants_json, 
'original_file_name', med.file_name_original, 'original_mime_type', 
med.file_mime_type) ORDER BY fwm_link.display_order) FROM 
public.food_water_source_media fwm_link JOIN public.media med ON med.id = 
fwm_link.media_id LEFT JOIN fw_media_translations fwm_tr ON 
fwm_tr.media_link_id_text = fwm_link.id::TEXT WHERE 
fwm_link.food_water_source_waypoint_id = fwsd.waypoint_id) AS media_gallery, 
fwsd.data_last_verified_at, fwsd.created_at, creator_profile.full_name AS 
created_by_full_name, fwsd.updated_at, updater_profile.full_name AS 
updated_by_full_name, wp.name AS parent_waypoint_name, -- English name from 
waypoints wp.slug AS parent_waypoint_slug FROM 
public.food_water_sources_details fwsd JOIN public.waypoints wp ON 
fwsd.waypoint_id = wp.id JOIN public.food_water_source_types_master fstm ON 
fwsd.source_type_id = fstm.id LEFT JOIN public.water_reliability_types_master 
wrtm ON fwsd.water_reliability_id = wrtm.id LEFT JOIN 
public.establishment_price_ranges_master eprm ON 
fwsd.establishment_price_range_id = eprm.id LEFT JOIN direct_translations 
fwsd_tr ON fwsd_tr.waypoint_id_text = fwsd.waypoint_id::TEXT LEFT JOIN 
source_type_translations st_tr ON st_tr.master_id_text = fstm.id::TEXT LEFT 
JOIN reliability_translations wr_tr ON wr_tr.master_id_text = wrtm.id::TEXT 
LEFT JOIN price_range_translations epr_tr ON epr_tr.master_id_text = 
eprm.id::TEXT LEFT JOIN public.profiles creator_profile ON 
fwsd.created_by_profile_id = creator_profile.id LEFT JOIN public.profiles 
updater_profile ON fwsd.updated_by_profile_id = updater_profile.id; COMMENT ON 
VIEW public.v_waypoint_food_water_source_details_localized IS 'Provides a 
denormalized and localized view of food and water source details, including 
types, reliability, commercial aspects, and media. Version 1.0'; ``` * * * * * 
5\. Key Dependencies - `public.food_water_sources_details` (V1.3) - 
`public.waypoints` (V1.3+ assumed) - `public.food_water_source_types_master` 
(V1.2) - `public.water_reliability_types_master` (V1.2) - 
`public.establishment_price_ranges_master` (V1.1) - 
`public.meal_type_tags_master` (V1.1) - `public.dietary_option_tags_master` 
(V1.1) - `public.payment_methods_master` (V1.1) - `public.media` (V2.2) - 
`public.food_water_source_media` (V1.0) - `public.media_roles_master` - 
`public.translations` (V2.1) - `public.profiles` - 
`public.content_statuses_master` * * * * * 6\. Performance Considerations - 
Highly Complex: This view is very complex due to numerous joins, multiple CTEs 
for translations of various entities, and multiple `jsonb_agg` subqueries for 
array FKs and linked media. Performance will be a significant concern if 
queried frequently without optimization or on very large datasets. - 
Translation Aggregation: Multiple CTEs aggregate translations. The 
`translations` table must have excellent indexing on `(table_identifier, 
row_foreign_key, language_code, column_identifier)`. - Array FK Expansion: 
Unnesting `serves_meal_type_tag_ids`, `dietary_option_tag_ids`, and 
`payment_method_tag_ids`, then joining to their respective master tables and 
translation CTEs for each food/water source, is resource-intensive. - Indexes 
on Base Tables: All foreign keys in the base tables 
(`food_water_sources_details`, master tables) involved in joins must be 
indexed. Primary keys are inherently indexed. GIN indexes on array columns in 
`food_water_sources_details` help if filtering by tags, but here we are 
expanding them. - Materialized View Recommendation: Given the complexity, if 
this view is frequently accessed by the API for read operations and can 
tolerate some data latency, converting it to a MATERIALIZED VIEW is highly 
recommended. A refresh strategy (e.g., nightly, or on demand after significant 
data changes) would be necessary. - Querying the View: When querying this view, 
filtering by `waypoint_id` will be efficient as it's the PK of the main detail 
table. * * * * * 7\. RLS & Security Notes - The view operates under the 
permissions of the querying user (`SECURITY INVOKER` by default). - Data 
visibility is primarily controlled by RLS policies on the underlying 
`public.food_water_sources_details` and `public.waypoints` tables. The view 
will only return rows that the user is permitted to see based on these policies 
(e.g., details for published and non-deleted waypoints). - CTEs accessing 
`public.translations` will also respect any RLS on that table, though typically 
translations are readable if the parent record is readable. * * * * * 8\. API 
Endpoints Supported - Primarily supports: 
`/waypoints/{waypoint_id}/food_water_source_details` (GET). - The API backend 
would query this view: `SELECT * FROM 
public.v_waypoint_food_water_source_details_localized WHERE waypoint_id = 
{input_id};`. - The `lang` query parameter from the API request would be used 
by the API backend to extract the relevant language versions from the 
`all_translations` JSONB objects or use the direct primary language fields 
(e.g., `source_type_label`). * * * * * 9\. Rationale for Creation - API Query 
Simplification: Abstract away the numerous joins and complex data aggregation 
(especially for translations and array-based relationships) required to 
construct a full food/water source detail object. - Data Consistency for API: 
Provides a single, consistent source of truth for the API to fetch 
comprehensive food/water source details. - Improved Maintainability: 
Centralizes data shaping logic in the database layer, making the API backend 
code cleaner and easier to maintain. Changes to underlying table structures or 
join logic can often be handled within the view without altering the API's 
query to the view. ----- View Specification: 
`public.v_waypoint_shop_service_details_localized` * * * * * 1\. View Name 
`public.v_waypoint_shop_service_details_localized` * * * * * 2\. Purpose & 
Primary Use-Cases - Purpose: To provide a comprehensive, denormalized, and 
localized representation of a shop or practical service's details, including 
its type, operational specifics like opening hours, contact information, 
languages spoken, payment methods, associated media, and any pilgrim-relevant 
notes. - Primary Use-Cases: - Power the API endpoint 
`/waypoints/{waypoint_id}/shop_service_details` by simplifying backend query 
logic. - Furnish all necessary data for displaying a complete shop/service 
detail page in a web or mobile application, with robust internationalization 
support. - Enable users to easily find and understand the specifics of 
essential services available to them. * * * * * 3\. View Schema (Columns) 
*(This view will select from `shops_and_services_details` and join various 
other tables. Referenced master data will have English labels directly 
included, and their full translation sets will also be available within nested 
JSON structures.)* | Column Name | Data Type | Description | | `waypoint_id` | 
`BIGINT` | Inherited from `shops_and_services_details`. Links to 
`public.waypoints(id)`. PK of the detail record. | | `service_type_id` | 
`INTEGER` | Inherited from `shops_and_services_details`. FK to 
`public.shop_service_types_master(id)`. | | `service_type_code` | `TEXT` | From 
`shop_service_types_master.code`. | | `service_type_label` | `TEXT` | Primary 
reference language (English) label from `shop_service_types_master.label`. | | 
`service_type_category` | `TEXT` | From `shop_service_types_master.category`. | 
| `service_type_icon_identifier` | `TEXT` | From 
`shop_service_types_master.icon_identifier`. | | 
`service_type_all_translations` | `JSONB` | All translations for the `label` 
and `description` of the referenced `shop_service_types_master` record. | | 
`operator_or_brand_name` | `TEXT` | Primary reference language (English) text 
from `shops_and_services_details.operator_or_brand_name`. | | 
`products_or_services_summary` | `TEXT` | Primary reference language (English) 
text from `shops_and_services_details.products_or_services_summary`. | | 
`is_open_24_hours` | `BOOLEAN` | Inherited from 
`shops_and_services_details.is_open_24_hours`. | | `opening_hours_structured` | 
`JSONB` | Inherited from `shops_and_services_details.opening_hours_structured`. 
| | `opening_hours_text_notes` | `TEXT` | Primary reference language (English) 
text from `shops_and_services_details.opening_hours_text_notes`. | | 
`opening_hours_last_verified_at` | `TIMESTAMPTZ` | Inherited from 
`shops_and_services_details.opening_hours_last_verified_at`. | | 
`emergency_service_details` | `TEXT` | Primary reference language (English) 
text from `shops_and_services_details.emergency_service_details`. | | 
`contact_phone_service` | `TEXT` | Inherited from 
`shops_and_services_details.contact_phone_service`. | | `contact_email_service` 
| `TEXT` | Inherited from `shops_and_services_details.contact_email_service`. | 
| `website_url_service` | `TEXT` | Inherited from 
`shops_and_services_details.website_url_service`. | | `general_price_range_id` 
| `INTEGER` | Inherited from `shops_and_services_details`. FK to 
`public.establishment_price_ranges_master(id)`. | | `general_price_range_code` 
| `TEXT` | From `establishment_price_ranges_master.code`. | | 
`general_price_range_label` | `TEXT` | Primary reference language (English) 
label from `establishment_price_ranges_master.label`. | | 
`general_price_range_symbol` | `TEXT` | From 
`establishment_price_ranges_master.symbol`. | | 
`general_price_range_all_translations` | `JSONB` | All translations for the 
`label` and `description` of the referenced `establishment_price_ranges_master` 
record. | | `accessibility_notes_service` | `TEXT` | Primary reference language 
(English) text from `shops_and_services_details.accessibility_notes_service`. | 
| `service_specific_details_notes` | `TEXT` | Primary reference language 
(English) text from 
`shops_and_services_details.service_specific_details_notes`. | | 
`all_translations` | `JSONB` | All translations for translatable fields 
directly on `shops_and_services_details` (e.g., `operator_or_brand_name`, 
etc.), keyed by language code and then field name. | | `languages_spoken` | 
`JSONB` | Array of JSON objects, each representing a language spoken. Includes 
`language_code`, `name_en` (English name from `languages_master`), 
`name_native`, and `all_translations` for the language names. | | 
`payment_methods` | `JSONB` | Array of JSON objects, each representing an 
accepted payment method. Includes `id`, `code`, `label` (English), 
`icon_identifier`, and `all_translations` for the method's label/description. | 
| `media_gallery` | `JSONB` | Array of JSON objects, each representing a media 
item. Includes `media_id`, `media_role_code`, `alt_text` (English), `caption` 
(English), `image_variants_json`, and `all_translations` for alt/caption. | | 
`data_last_verified_at` | `TIMESTAMPTZ` | Inherited from 
`shops_and_services_details.data_last_verified_at`. | | `deleted_at` | 
`TIMESTAMPTZ` | Inherited from `shops_and_services_details.deleted_at`. Soft 
deletion timestamp for this specific service detail. | | `created_at` | 
`TIMESTAMPTZ` | Inherited from `shops_and_services_details.created_at`. | | 
`created_by_full_name` | `TEXT` | Full name of the profile that created the 
record (joined from `public.profiles`). | | `updated_at` | `TIMESTAMPTZ` | 
Inherited from `shops_and_services_details.updated_at`. | | 
`updated_by_full_name` | `TEXT` | Full name of the profile that last updated 
the record (joined from `public.profiles`). | | `parent_waypoint_name` | `TEXT` 
| The `name` of the parent waypoint from `public.waypoints` (primary language). 
| | `parent_waypoint_slug` | `TEXT` | The `slug` of the parent waypoint from 
`public.waypoints`. | * * * * * 4\. Underlying SQL Definition SQL ``` CREATE OR 
REPLACE VIEW public.v_waypoint_shop_service_details_localized AS WITH 
direct_translations AS ( SELECT tr.row_foreign_key AS waypoint_id_text, 
jsonb_object_agg( tr.language_code, jsonb_strip_nulls(jsonb_build_object( 
'operator_or_brand_name', MAX(CASE WHEN tr.column_identifier = 
'operator_or_brand_name' THEN tr.translated_text ELSE NULL END), 
'products_or_services_summary', MAX(CASE WHEN tr.column_identifier = 
'products_or_services_summary' THEN tr.translated_text ELSE NULL END), 
'opening_hours_text_notes', MAX(CASE WHEN tr.column_identifier = 
'opening_hours_text_notes' THEN tr.translated_text ELSE NULL END), 
'emergency_service_details', MAX(CASE WHEN tr.column_identifier = 
'emergency_service_details' THEN tr.translated_text ELSE NULL END), 
'accessibility_notes_service', MAX(CASE WHEN tr.column_identifier = 
'accessibility_notes_service' THEN tr.translated_text ELSE NULL END), 
'service_specific_details_notes', MAX(CASE WHEN tr.column_identifier = 
'service_specific_details_notes' THEN tr.translated_text ELSE NULL END) )) ) AS 
all_translations FROM public.translations tr WHERE tr.table_identifier = 
'shops_and_services_details' GROUP BY tr.row_foreign_key ), 
service_type_translations AS ( SELECT tr.row_foreign_key AS master_id_text, 
jsonb_object_agg(tr.language_code, 
jsonb_strip_nulls(jsonb_build_object('label', MAX(CASE WHEN 
tr.column_identifier = 'label' THEN tr.translated_text ELSE NULL 
END),'description', MAX(CASE WHEN tr.column_identifier = 'description' THEN 
tr.translated_text ELSE NULL END)))) AS all_translations FROM 
public.translations tr WHERE tr.table_identifier = 'shop_service_types_master' 
GROUP BY tr.row_foreign_key ), price_range_translations AS ( SELECT 
tr.row_foreign_key AS master_id_text, jsonb_object_agg(tr.language_code, 
jsonb_strip_nulls(jsonb_build_object('label', MAX(CASE WHEN 
tr.column_identifier = 'label' THEN tr.translated_text ELSE NULL 
END),'description', MAX(CASE WHEN tr.column_identifier = 'description' THEN 
tr.translated_text ELSE NULL END)))) AS all_translations FROM 
public.translations tr WHERE tr.table_identifier = 
'establishment_price_ranges_master' GROUP BY tr.row_foreign_key ), 
language_master_translations AS ( -- For translating language names themselves 
SELECT tr.row_foreign_key AS lang_code_text, jsonb_object_agg(tr.language_code, 
jsonb_strip_nulls(jsonb_build_object('display_name', MAX(CASE WHEN 
tr.column_identifier = 'display_name_native' THEN tr.translated_text ELSE NULL 
END)))) AS all_translations -- Example, could be display_name_en if that's what 
gets translated FROM public.translations tr WHERE tr.table_identifier = 
'languages_master' GROUP BY tr.row_foreign_key ), payment_method_translations 
AS ( SELECT tr.row_foreign_key AS master_id_text, 
jsonb_object_agg(tr.language_code, 
jsonb_strip_nulls(jsonb_build_object('label', MAX(CASE WHEN 
tr.column_identifier = 'label' THEN tr.translated_text ELSE NULL END)))) AS 
all_translations FROM public.translations tr WHERE tr.table_identifier = 
'payment_methods_master' GROUP BY tr.row_foreign_key ), ss_media_translations 
AS ( SELECT tr.row_foreign_key AS media_link_id_text, 
jsonb_object_agg(tr.language_code, 
jsonb_strip_nulls(jsonb_build_object('caption_override', MAX(CASE WHEN 
tr.column_identifier = 'caption_override' THEN tr.translated_text ELSE NULL 
END), 'alt_text_override', MAX(CASE WHEN tr.column_identifier = 
'alt_text_override' THEN tr.translated_text ELSE NULL END)))) AS 
all_translations FROM public.translations tr WHERE tr.table_identifier = 
'shop_service_media' GROUP BY tr.row_foreign_key ) SELECT sssd.waypoint_id, 
sssd.service_type_id, sstm.code AS service_type_code, sstm.label AS 
service_type_label, -- English sstm.category AS service_type_category, 
sstm.icon_identifier AS service_type_icon_identifier, 
COALESCE(st_tr.all_translations, '{}'::jsonb) AS service_type_all_translations, 
sssd.operator_or_brand_name, -- English sssd.products_or_services_summary, -- 
English sssd.is_open_24_hours, sssd.opening_hours_structured, 
sssd.opening_hours_text_notes, -- English sssd.opening_hours_last_verified_at, 
sssd.emergency_service_details, -- English sssd.contact_phone_service, 
sssd.contact_email_service, sssd.website_url_service, 
sssd.general_price_range_id, eprm.code AS general_price_range_code, eprm.label 
AS general_price_range_label, -- English eprm.symbol AS 
general_price_range_symbol, COALESCE(epr_tr.all_translations, '{}'::jsonb) AS 
general_price_range_all_translations, sssd.accessibility_notes_service, -- 
English sssd.service_specific_details_notes, -- English 
COALESCE(sssd_tr.all_translations, '{}'::jsonb) AS all_translations, (SELECT 
jsonb_agg(jsonb_build_object('code', lm.language_code, 'name_en', 
lm.display_name_en, 'name_native', lm.display_name_native, 'icon_identifier', 
lm.icon_identifier, 'all_translations', COALESCE(lang_m_tr.all_translations, 
'{}'::jsonb))) FROM unnest(sssd.languages_spoken_codes) lang_c JOIN 
public.languages_master lm ON lm.language_code = lang_c LEFT JOIN 
language_master_translations lang_m_tr ON lang_m_tr.lang_code_text = 
lm.language_code WHERE sssd.languages_spoken_codes IS NOT NULL) AS 
languages_spoken, (SELECT jsonb_agg(jsonb_build_object('id', pmm.id, 'code', 
pmm.code, 'label', pmm.label, 'icon_identifier', pmm.icon_identifier, 
'all_translations', COALESCE(pm_tr.all_translations, '{}'::jsonb))) FROM 
unnest(sssd.payment_method_ids) p_id JOIN public.payment_methods_master pmm ON 
pmm.id = p_id LEFT JOIN payment_method_translations pm_tr ON 
pm_tr.master_id_text = pmm.id::TEXT WHERE sssd.payment_method_ids IS NOT NULL) 
AS payment_methods, (SELECT jsonb_agg(jsonb_build_object('media_id', 
ssm_link.media_id, 'media_role_code', ssm_link.media_role_code, 
'display_order', ssm_link.display_order, 'caption_override', 
ssm_link.caption_override, 'alt_text_override', ssm_link.alt_text_override, 
'all_translations', COALESCE(ssm_tr.all_translations, 
'{}'::jsonb),'image_variants_json', med.image_variants_json, 
'original_file_name', med.file_name_original, 'original_mime_type', 
med.file_mime_type) ORDER BY ssm_link.display_order) FROM 
public.shop_service_media ssm_link JOIN public.media med ON med.id = 
ssm_link.media_id LEFT JOIN ss_media_translations ssm_tr ON 
ssm_tr.media_link_id_text = ssm_link.id::TEXT WHERE 
ssm_link.shop_service_waypoint_id = sssd.waypoint_id) AS media_gallery, 
sssd.data_last_verified_at, sssd.deleted_at, sssd.created_at, 
creator_profile.full_name AS created_by_full_name, sssd.updated_at, 
updater_profile.full_name AS updated_by_full_name, wp.name AS 
parent_waypoint_name, -- English name from waypoints wp.slug AS 
parent_waypoint_slug FROM public.shops_and_services_details sssd JOIN 
public.waypoints wp ON sssd.waypoint_id = wp.id JOIN 
public.shop_service_types_master sstm ON sssd.service_type_id = sstm.id LEFT 
JOIN public.establishment_price_ranges_master eprm ON 
sssd.general_price_range_id = eprm.id LEFT JOIN direct_translations sssd_tr ON 
sssd_tr.waypoint_id_text = sssd.waypoint_id::TEXT LEFT JOIN 
service_type_translations st_tr ON st_tr.master_id_text = sstm.id::TEXT LEFT 
JOIN price_range_translations epr_tr ON epr_tr.master_id_text = eprm.id::TEXT 
LEFT JOIN public.profiles creator_profile ON sssd.created_by_profile_id = 
creator_profile.id LEFT JOIN public.profiles updater_profile ON 
sssd.updated_by_profile_id = updater_profile.id; COMMENT ON VIEW 
public.v_waypoint_shop_service_details_localized IS 'Provides a denormalized 
and localized view of shop and service details, including types, operational 
info, media, and contact details. Version 1.0'; ``` * * * * * 5\. Key 
Dependencies - `public.shops_and_services_details` (V1.3) - `public.waypoints` 
(V1.3+ assumed) - `public.shop_service_types_master` (V1.2) - 
`public.establishment_price_ranges_master` (V1.1) - `public.languages_master` 
(V2.1) - `public.payment_methods_master` (V1.1) - `public.media` (V2.2) - 
`public.shop_service_media` (V1.0) - `public.media_roles_master` - 
`public.translations` (V2.1) - `public.profiles` - 
`public.content_statuses_master` * * * * * 6\. Performance Considerations - 
Highly Complex: Similar to other detail views, this view involves many joins 
and aggregations, especially for translations and expanding array FKs 
(`languages_spoken_codes`, `payment_method_ids`). - Translation and Array 
Expansion CTEs: These contribute significantly to complexity. Efficient 
indexing on `public.translations` and all master tables (PKs, `is_active` 
flags) is paramount. - GIN Indexes: GIN indexes on array columns in 
`shops_and_services_details` help if filtering by those tags directly on the 
base table, but here we are expanding them for display. - Materialized View 
Potential: Given the complexity, if API read performance for this data becomes 
an issue and data can tolerate some latency, converting this to a MATERIALIZED 
VIEW (refreshed periodically) would be a strong consideration. - Filtering in 
View Query: The primary filter `WHERE waypoint_id = {input_id}` on the main 
`shops_and_services_details` alias `sssd` will be efficient due to the PK. * * 
* * * 7\. RLS & Security Notes - The view operates with `SECURITY INVOKER` 
(default) permissions. - Data visibility is controlled by RLS policies on the 
underlying `public.shops_and_services_details` and `public.waypoints` tables. 
The RLS on `shops_and_services_details` includes a check for its own 
`deleted_at IS NULL` field, in addition to the parent waypoint's publication 
status and `deleted_at` status. - Users will only see shop/service details they 
are permitted to access based on these combined RLS policies. * * * * * 8\. API 
Endpoints Supported - Primarily supports: 
`/waypoints/{waypoint_id}/shop_service_details` (GET). - The API backend would 
query: `SELECT * FROM public.v_waypoint_shop_service_details_localized WHERE 
waypoint_id = {input_id};`. - The `lang` API query parameter would be used by 
the backend to select the appropriate language from the `all_translations` 
JSONB objects or use the direct primary language fields from the view. * * * * 
* 9\. Rationale for Creation - Decoupling & Simplification: Abstracts the 
complex multi-table join, array unnesting, and localization logic from the API 
backend, providing a clean and denormalized data source. - Consistency: Ensures 
a uniform data structure for shop and service details for API consumers. - 
Maintainability: Centralizes data shaping logic within the database, making 
application code simpler and database schema changes easier to manage with 
respect to API contracts (by updating the view definition). 
