# 4.5 attraction_details

  https://gemini.google.com/u/1/app/1d4834db0819faf2 
https://gemini.google.com/u/1/app/d423d51e9f40da78 ### 3\. Updated 
Production-Ready Specification (`attractions_details`) This document details 
the structure, purpose, and considerations for the `attractions_details` table, 
Version 1.3.1 (reflecting RLS role name alignment). This version incorporates 
full V2 enhancements including robust audit fields, refined i18n strategy, 
array foreign key integrity with active status checks, media linking, and an 
`is_active` check for its foreign key to `attraction_types_master`. It does 
*not* include denormalized English labels from master tables. 1\. Purpose & 
Primary Use-Cases The `attractions_details` table stores specific, rich 
information for waypoints that are attractions, cultural sites, historical 
landmarks, religious sites, or significant natural features. It extends the 
generic `waypoints` entry to include detailed descriptions, 
historical/cultural/spiritual significance, operational details like opening 
hours and entry fees, and available visitor amenities. Key user-story 
touchpoints: - Pilgrim: Discovering detailed information about an attraction 
(history, significance, what to see/do). - Pilgrim: Finding practical details 
like opening hours, entry fees, tour availability, and accessibility. - 
Pilgrim: Understanding the types of visitor amenities available on-site (e.g., 
toilets, cafe). - Content Manager/Admin: Adding and curating comprehensive 
information about attractions, ensuring accuracy and depth. - System/UI: 
Powering dedicated attraction pages with structured information, and enabling 
filtering by attraction type or features. 2\. Schema | column | data_type | 
constraints | description | | `waypoint_id` | `BIGINT` | Primary Key, Foreign 
Key to `public.waypoints(id)` ON DELETE CASCADE | Links to the generic 
`waypoints` table. This is the PK. Matches `waypoints.id` type. | | 
`attraction_type_id` | `INTEGER` | Not Null, Foreign Key to 
`public.attraction_types_master(id)` ON DELETE RESTRICT | Specific type of 
attraction, linking to an *active* master table record. | | 
`detailed_description` | `TEXT` | Nullable | In-depth description, history, 
architecture, etc. Primary reference language (English) text. (Translatable via 
`public.translations`) | | `historical_significance_notes` | `TEXT` | Nullable 
| Notes on historical importance. Primary reference language (English) text. 
(Translatable via `public.translations`) | | `cultural_significance_notes` | 
`TEXT` | Nullable | Notes on cultural/artistic importance. Primary reference 
language (English) text. (Translatable via `public.translations`) | | 
`spiritual_significance_notes` | `TEXT` | Nullable | Notes on spiritual or 
religious importance, especially for pilgrims. Primary reference language 
(English) text. (Translatable via `public.translations`) | | 
`associated_historical_figures_text` | `TEXT[]` | Nullable | Array of key 
historical/religious figures (free text). Elements are primary reference 
language (English) text. (Translatable via `public.translations` for each 
element) | | `key_historical_events_notes` | `TEXT` | Nullable | Notes on 
significant historical events that occurred here. Primary reference language 
(English) text. (Translatable via `public.translations`) | | 
`opening_hours_structured` | `JSONB` | Nullable, CHECK 
(`opening_hours_structured` IS NULL OR 
jsonb_type_of(`opening_hours_structured`) = 'object') | Structured opening 
hours (e.g., based on schema.org OpeningHoursSpecification). Adheres to the 
centrally defined project schema. | | `opening_hours_text_notes` | `TEXT` | 
Nullable | Human-readable summary or additional notes about opening hours. 
Primary reference language (English) text. (Translatable via 
`public.translations`) | | `opening_hours_last_verified_at` | `TIMESTAMPTZ` | 
Nullable | When the opening hours were last checked/verified. | | 
`entry_fee_details` | `TEXT` | Nullable | Information on entry fees, donations, 
pilgrim discounts. Primary reference language (English) text. (Translatable via 
`public.translations`) | | `guided_tours_info` | `TEXT` | Nullable | 
Information on availability, language, cost, and schedule of guided tours. 
Primary reference language (English) text. (Translatable via 
`public.translations`) | | `audio_guides_info` | `TEXT` | Nullable | 
Information on availability, language, and cost of audio guides. Primary 
reference language (English) text. (Translatable via `public.translations`) | | 
`photography_allowed_notes` | `TEXT` | Nullable | Policy on 
photography/videography. Primary reference language (English) text. 
(Translatable via `public.translations`) | | `accessibility_details_specific` | 
`TEXT` | Nullable | Specific notes on accessibility for this attraction, 
supplementing `waypoints.waypoint_accessibility_notes`. Primary reference 
language (English) text. (Translatable via `public.translations`) | | 
`visitor_amenity_ids` | `INTEGER[]` | Nullable | Array of Foreign Keys to 
`public.visitor_amenities_master(id)` for on-site amenities. Integrity 
(existence and active status) enforced by DB trigger. | | 
`data_last_verified_at` | `TIMESTAMPTZ` | Nullable | When the overall details 
for this attraction were last verified by an editor or reliable source. | | 
`created_at` | `TIMESTAMPTZ` | Not Null, Default `now()` | Timestamp of record 
creation. | | `created_by_profile_id` | `UUID` | Nullable, Foreign Key to 
`public.profiles(id)` ON DELETE SET NULL | Profile ID of the user who created 
this attraction record. | | `updated_at` | `TIMESTAMPTZ` | Not Null, Default 
`now()` | Timestamp of last update (auto-updated by trigger). | | 
`updated_by_profile_id` | `UUID` | Nullable, Foreign Key to 
`public.profiles(id)` ON DELETE SET NULL | Profile ID of the user who last 
updated this attraction record. | 3\. PostgreSQL DDL SQL ``` -- Ensure 
prerequisite master tables are V2 compliant and created first: -- 
public.waypoints (BIGINT id PK, content_visibility_status_id INTEGER, 
deleted_at TIMESTAMPTZ) -- public.profiles (UUID id PK, roles TEXT[]) -- 
public.media (UUID id PK) -- public.media_roles_master (TEXT code PK) -- 
public.translations (for i18n) -- public.languages_master (for i18n) -- 
public.content_statuses_master (INTEGER id PK, is_publicly_visible BOOLEAN) -- 
Master table for Attraction Types (Version 1.1 - Assumed V2 Compliant) CREATE 
TABLE IF NOT EXISTS public.attraction_types_master ( id INTEGER GENERATED 
ALWAYS AS IDENTITY PRIMARY KEY, code TEXT UNIQUE NOT NULL CHECK (length(code) > 
0 AND length(code) <= 50 AND code ~ '^[a-z0-9_]+$'), label TEXT NOT NULL CHECK 
(length(label) > 0 AND length(label) <= 100), -- Primary reference language 
(English). Translatable. description TEXT NULL, -- Primary reference language 
(English). Translatable. icon_identifier TEXT NULL CHECK (icon_identifier IS 
NULL OR length(icon_identifier) <= 100), sort_order INTEGER NOT NULL DEFAULT 0, 
is_active BOOLEAN NOT NULL DEFAULT true, created_at TIMESTAMPTZ NOT NULL 
DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), 
created_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE SET 
NULL, updated_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE 
SET NULL ); COMMENT ON TABLE public.attraction_types_master IS 'Master list of 
attraction types (e.g., church, museum). `label` and `description` are 
translatable. Version 1.1'; CREATE INDEX IF NOT EXISTS 
idx_attraction_types_master_is_active ON 
public.attraction_types_master(is_active); CREATE TRIGGER 
trigger_attraction_types_master_set_updated_at BEFORE UPDATE ON 
public.attraction_types_master FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); CREATE OR REPLACE FUNCTION 
public.cleanup_attraction_types_master_translations() RETURNS TRIGGER AS $$ 
BEGIN DELETE FROM public.translations WHERE table_identifier = 
'attraction_types_master' AND row_foreign_key = OLD.id::TEXT; RETURN OLD; END; 
$$ LANGUAGE plpgsql SECURITY DEFINER; CREATE TRIGGER 
trigger_cleanup_attraction_types_master_translations AFTER DELETE ON 
public.attraction_types_master FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_attraction_types_master_translations(); -- Master table for 
Visitor Amenities (Version 1.1 - Assumed V2 Compliant) CREATE TABLE IF NOT 
EXISTS public.visitor_amenities_master ( id INTEGER GENERATED ALWAYS AS 
IDENTITY PRIMARY KEY, code TEXT UNIQUE NOT NULL CHECK (length(code) > 0 AND 
length(code) <= 50 AND code ~ '^[a-z0-9_]+$'), label TEXT NOT NULL CHECK 
(length(label) > 0 AND length(label) <= 100), -- Primary reference language 
(English). Translatable. description TEXT NULL, -- Primary reference language 
(English). Translatable. icon_identifier TEXT NULL CHECK (icon_identifier IS 
NULL OR length(icon_identifier) <= 100), is_active BOOLEAN NOT NULL DEFAULT 
true, created_at TIMESTAMPTZ NOT NULL DEFAULT now(), updated_at TIMESTAMPTZ NOT 
NULL DEFAULT now(), created_by_profile_id UUID NULL REFERENCES 
public.profiles(id) ON DELETE SET NULL, updated_by_profile_id UUID NULL 
REFERENCES public.profiles(id) ON DELETE SET NULL ); COMMENT ON TABLE 
public.visitor_amenities_master IS 'Master list of on-site amenities for 
visitors at attractions (e.g., toilets, gift_shop). `label` and `description` 
are translatable. Version 1.1'; CREATE INDEX IF NOT EXISTS 
idx_visitor_amenities_master_is_active ON 
public.visitor_amenities_master(is_active); CREATE TRIGGER 
trigger_visitor_amenities_master_set_updated_at BEFORE UPDATE ON 
public.visitor_amenities_master FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); CREATE OR REPLACE FUNCTION 
public.cleanup_visitor_amenities_master_translations() RETURNS TRIGGER AS $$ 
BEGIN DELETE FROM public.translations WHERE table_identifier = 
'visitor_amenities_master' AND row_foreign_key = OLD.id::TEXT; RETURN OLD; END; 
$$ LANGUAGE plpgsql SECURITY DEFINER; CREATE TRIGGER 
trigger_cleanup_visitor_amenities_master_translations AFTER DELETE ON 
public.visitor_amenities_master FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_visitor_amenities_master_translations(); -- Main Attractions 
Details Table (Version 1.3.1) CREATE TABLE public.attractions_details ( 
waypoint_id BIGINT PRIMARY KEY, attraction_type_id INTEGER NOT NULL, -- No 
attraction_type_label_en column detailed_description TEXT NULL, 
historical_significance_notes TEXT NULL, cultural_significance_notes TEXT NULL, 
spiritual_significance_notes TEXT NULL, associated_historical_figures_text 
TEXT[] NULL, key_historical_events_notes TEXT NULL, opening_hours_structured 
JSONB NULL CHECK (opening_hours_structured IS NULL OR 
jsonb_type_of(opening_hours_structured) = 'object'), opening_hours_text_notes 
TEXT NULL, opening_hours_last_verified_at TIMESTAMPTZ NULL, entry_fee_details 
TEXT NULL, guided_tours_info TEXT NULL, audio_guides_info TEXT NULL, 
photography_allowed_notes TEXT NULL, accessibility_details_specific TEXT NULL, 
visitor_amenity_ids INTEGER[] NULL, data_last_verified_at TIMESTAMPTZ NULL, 
created_at TIMESTAMPTZ NOT NULL DEFAULT now(), created_by_profile_id UUID NULL, 
updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), updated_by_profile_id UUID NULL, 
CONSTRAINT fk_waypoint FOREIGN KEY(waypoint_id) REFERENCES public.waypoints(id) 
ON DELETE CASCADE, CONSTRAINT fk_attraction_type FOREIGN 
KEY(attraction_type_id) REFERENCES public.attraction_types_master(id) ON DELETE 
RESTRICT, CONSTRAINT fk_created_by_profile FOREIGN KEY(created_by_profile_id) 
REFERENCES public.profiles(id) ON DELETE SET NULL, CONSTRAINT 
fk_updated_by_profile FOREIGN KEY(updated_by_profile_id) REFERENCES 
public.profiles(id) ON DELETE SET NULL ); COMMENT ON TABLE 
public.attractions_details IS 'Specific details for attractions, cultural 
sites, historical landmarks, etc., extending the waypoints table. Version 
1.3.1'; COMMENT ON COLUMN public.attractions_details.waypoint_id IS 'Links to 
the generic waypoints table. This is the PK.'; COMMENT ON COLUMN 
public.attractions_details.attraction_type_id IS 'FK to 
attraction_types_master. Specific type of attraction. Referenced master record 
must be is_active=true.'; COMMENT ON COLUMN 
public.attractions_details.detailed_description IS 'In-depth description, 
history, architecture. Primary reference language (English) text. (Translatable 
via public.translations)'; COMMENT ON COLUMN 
public.attractions_details.visitor_amenity_ids IS 'Array of FKs to 
visitor_amenities_master. On-site amenities. Integrity (existence and active 
status) of array elements MUST be enforced by a dedicated database trigger.'; 
-- (Other column comments remain as previously specified for V1.3) -- Linking 
table for Attraction Media (public.attraction_details_media - Version 1.0) 
CREATE TABLE IF NOT EXISTS public.attraction_details_media ( id BIGINT 
GENERATED ALWAYS AS IDENTITY PRIMARY KEY, attraction_waypoint_id BIGINT NOT 
NULL REFERENCES public.attractions_details(waypoint_id) ON DELETE CASCADE, 
media_id UUID NOT NULL REFERENCES public.media(id) ON DELETE RESTRICT, 
media_role_code TEXT NOT NULL REFERENCES public.media_roles_master(code) ON 
DELETE RESTRICT, display_order SMALLINT NOT NULL DEFAULT 0, caption_override 
TEXT NULL, -- Primary reference language (English). Translatable. 
alt_text_override TEXT NULL, -- Primary reference language (English). 
Translatable. created_at TIMESTAMPTZ NOT NULL DEFAULT now(), updated_at 
TIMESTAMPTZ NOT NULL DEFAULT now(), created_by_profile_id UUID NULL REFERENCES 
public.profiles(id) ON DELETE SET NULL, updated_by_profile_id UUID NULL 
REFERENCES public.profiles(id) ON DELETE SET NULL, CONSTRAINT 
uq_attraction_media_role_order UNIQUE (attraction_waypoint_id, media_id, 
media_role_code) ); COMMENT ON TABLE public.attraction_details_media IS 'Links 
attractions to media items for galleries or specific semantic roles. Version 
1.0'; CREATE TRIGGER trigger_attraction_details_media_set_updated_at BEFORE 
UPDATE ON public.attraction_details_media FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); CREATE OR REPLACE FUNCTION 
public.cleanup_attraction_details_media_translations() RETURNS TRIGGER AS $$ 
BEGIN DELETE FROM public.translations WHERE table_identifier = 
'attraction_details_media' AND row_foreign_key = OLD.id::TEXT; RETURN OLD; END; 
$$ LANGUAGE plpgsql SECURITY DEFINER; CREATE TRIGGER 
trigger_cleanup_attraction_details_media_translations AFTER DELETE ON 
public.attraction_details_media FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_attraction_details_media_translations(); -- Triggers & Functions 
for attractions_details CREATE TRIGGER 
trigger_attractions_details_set_updated_at BEFORE UPDATE ON 
public.attractions_details FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); COMMENT ON TRIGGER 
trigger_attractions_details_set_updated_at ON public.attractions_details IS 
'Trigger to automatically update updated_at timestamp on row modification.'; 
CREATE OR REPLACE FUNCTION public.check_attraction_visitor_amenities() RETURNS 
TRIGGER AS $$ DECLARE amenity_id INTEGER; is_valid BOOLEAN; amenity_is_active 
BOOLEAN; BEGIN IF NEW.visitor_amenity_ids IS NOT NULL AND 
array_length(NEW.visitor_amenity_ids, 1) > 0 THEN FOREACH amenity_id IN ARRAY 
NEW.visitor_amenity_ids LOOP SELECT EXISTS (SELECT 1 FROM 
public.visitor_amenities_master WHERE id = amenity_id), v.is_active INTO 
is_valid, amenity_is_active FROM public.visitor_amenities_master v WHERE v.id = 
amenity_id; IF NOT is_valid THEN RAISE EXCEPTION 'Invalid visitor_amenity_id: % 
does not exist in public.visitor_amenities_master.', amenity_id; END IF; IF NOT 
amenity_is_active THEN RAISE EXCEPTION 'Inactive visitor_amenity_id: % is not 
active in public.visitor_amenities_master.', amenity_id; END IF; END LOOP; END 
IF; RETURN NEW; END; $$ LANGUAGE plpgsql; CREATE TRIGGER 
trigger_check_attraction_visitor_amenities BEFORE INSERT OR UPDATE OF 
visitor_amenity_ids ON public.attractions_details FOR EACH ROW EXECUTE FUNCTION 
public.check_attraction_visitor_amenities(); COMMENT ON TRIGGER 
trigger_check_attraction_visitor_amenities ON public.attractions_details IS 
'Ensures all visitor_amenity_ids exist in visitor_amenities_master and are 
active.'; CREATE OR REPLACE FUNCTION 
public.cleanup_attraction_details_translations() RETURNS TRIGGER AS $$ BEGIN 
DELETE FROM public.translations WHERE table_identifier = 'attractions_details' 
AND row_foreign_key = OLD.waypoint_id::TEXT; DELETE FROM public.translations 
WHERE table_identifier = 'attraction_details_media' AND row_foreign_key IN 
(SELECT adm.id::TEXT FROM public.attraction_details_media adm WHERE 
adm.attraction_waypoint_id = OLD.waypoint_id); RETURN OLD; END; $$ LANGUAGE 
plpgsql SECURITY DEFINER; CREATE TRIGGER 
trigger_cleanup_attraction_details_translations AFTER DELETE ON 
public.attractions_details FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_attraction_details_translations(); COMMENT ON TRIGGER 
trigger_cleanup_attraction_details_translations ON public.attractions_details 
IS 'Cleans up orphaned translations from public.translations when an 
attraction_details record (and its media links) are deleted.'; CREATE OR 
REPLACE FUNCTION public.check_attraction_type_active() RETURNS TRIGGER AS $$ 
DECLARE is_type_active BOOLEAN; BEGIN IF NEW.attraction_type_id IS NOT NULL 
THEN SELECT atm.is_active INTO is_type_active FROM 
public.attraction_types_master atm WHERE atm.id = NEW.attraction_type_id; IF 
NOT is_type_active THEN RAISE EXCEPTION 'Cannot link attraction detail to 
inactive attraction_type_id: %. Corresponding attraction_types_master record 
must be active.', NEW.attraction_type_id; END IF; END IF; RETURN NEW; END; $$ 
LANGUAGE plpgsql; CREATE TRIGGER trigger_check_attraction_type_active BEFORE 
INSERT OR UPDATE OF attraction_type_id ON public.attractions_details FOR EACH 
ROW EXECUTE FUNCTION public.check_attraction_type_active(); COMMENT ON TRIGGER 
trigger_check_attraction_type_active ON public.attractions_details IS 'Ensures 
the referenced attraction_type_id in attraction_types_master is active.'; -- 
Indexes CREATE INDEX idx_attractions_details_attraction_type_id ON 
public.attractions_details(attraction_type_id); CREATE INDEX 
idx_attractions_details_visitor_amenity_ids ON public.attractions_details USING 
GIN (visitor_amenity_ids) WHERE visitor_amenity_ids IS NOT NULL; CREATE INDEX 
IF NOT EXISTS idx_attractions_details_opening_hours_structured ON 
public.attractions_details USING GIN (opening_hours_structured) WHERE 
opening_hours_structured IS NOT NULL; CREATE INDEX 
idx_adm_created_by_profile_id ON 
public.attractions_details(created_by_profile_id) WHERE created_by_profile_id 
IS NOT NULL; CREATE INDEX idx_adm_updated_by_profile_id ON 
public.attractions_details(updated_by_profile_id) WHERE updated_by_profile_id 
IS NOT NULL; CREATE INDEX idx_attraction_details_media_attraction_id ON 
public.attraction_details_media(attraction_waypoint_id); CREATE INDEX 
idx_attraction_details_media_media_id ON 
public.attraction_details_media(media_id); CREATE INDEX 
idx_attraction_details_media_role_code ON 
public.attraction_details_media(media_role_code); -- RLS Policies ALTER TABLE 
public.attractions_details ENABLE ROW LEVEL SECURITY; CREATE POLICY 
"public_read_attractions_details" ON public.attractions_details FOR SELECT 
USING ( EXISTS ( SELECT 1 FROM public.waypoints w JOIN 
public.content_statuses_master csm ON w.content_visibility_status_id = csm.id 
WHERE w.id = attractions_details.waypoint_id AND csm.is_publicly_visible = TRUE 
AND w.deleted_at IS NULL ) ); CREATE POLICY 
"manage_attractions_details_for_privileged_users" ON public.attractions_details 
FOR ALL USING ( (SELECT public.has_role_on_profile(auth.uid(), 
'platform_admin')) OR -- Updated role name (SELECT 
public.has_role_on_profile(auth.uid(), 'regional_content_manager')) -- Updated 
role name ) WITH CHECK ( (SELECT public.has_role_on_profile(auth.uid(), 
'platform_admin')) OR (SELECT public.has_role_on_profile(auth.uid(), 
'regional_content_manager')) AND (TG_OP = 'INSERT' OR (TG_OP = 'UPDATE' AND 
OLD.waypoint_id = NEW.waypoint_id OR (SELECT 
public.has_role_on_profile(auth.uid(), 'platform_admin')))) ); ALTER TABLE 
public.attraction_details_media ENABLE ROW LEVEL SECURITY; CREATE POLICY 
"public_read_attraction_media" ON public.attraction_details_media FOR SELECT 
USING ( EXISTS ( SELECT 1 FROM public.attractions_details ad JOIN 
public.waypoints w ON ad.waypoint_id = w.id JOIN public.content_statuses_master 
csm ON w.content_visibility_status_id = csm.id WHERE ad.waypoint_id = 
attraction_details_media.attraction_waypoint_id AND csm.is_publicly_visible = 
TRUE AND w.deleted_at IS NULL ) ); CREATE POLICY 
"manage_attraction_media_for_privileged_users" ON 
public.attraction_details_media FOR ALL USING ( (SELECT 
public.has_role_on_profile(auth.uid(), 'platform_admin')) OR -- Updated role 
name (SELECT public.has_role_on_profile(auth.uid(), 
'regional_content_manager')) -- Updated role name ) WITH CHECK ( (SELECT 
public.has_role_on_profile(auth.uid(), 'platform_admin')) OR (SELECT 
public.has_role_on_profile(auth.uid(), 'regional_content_manager')) ); ``` 4\. 
JSON Schema Mirror (Reflects the schema table in Section 2; does not include 
attraction_type_label_en) JSON ``` { "title": "attraction_detail", 
"description": "Specific details for attractions, cultural sites, historical 
landmarks, etc., extending the waypoints table. Version 1.3.1", "type": 
"object", "properties": { "waypoint_id": { "type": "integer", "format": 
"int64", "description": "Links to the generic waypoints table. This is the PK." 
}, "attraction_type_id": { "type": "integer", "description": "FK to 
attraction_types_master. Specific type of attraction. Referenced master record 
must be is_active=true." }, "detailed_description": { "type": ["string", 
"null"], "description": "In-depth description, history, architecture. Primary 
reference language (English) text. (Translatable via public.translations)" }, 
"historical_significance_notes": { "type": ["string", "null"], "description": 
"Notes on historical importance. Primary reference language (English) text. 
(Translatable via public.translations)" }, "cultural_significance_notes": { 
"type": ["string", "null"], "description": "Notes on cultural/artistic 
importance. Primary reference language (English) text. (Translatable via 
public.translations)" }, "spiritual_significance_notes": { "type": ["string", 
"null"], "description": "Notes on spiritual or religious importance for 
pilgrims. Primary reference language (English) text. (Translatable via 
public.translations)" }, "associated_historical_figures_text": { "type": 
["array", "null"], "items": { "type": "string" }, "description": "Array of key 
historical/religious figures (free text). Elements are primary reference 
language (English) text. (Translatable via public.translations for each 
element)" }, "key_historical_events_notes": { "type": ["string", "null"], 
"description": "Notes on significant historical events. Primary reference 
language (English) text. (Translatable via public.translations)" }, 
"opening_hours_structured": { "type": ["object", "null"], "description": 
"Structured opening hours in JSONB format. Adheres to the centrally defined 
schema (e.g., based on schema.org/OpeningHoursSpecification).", 
"additionalProperties": true }, "opening_hours_text_notes": { "type": 
["string", "null"], "description": "Human-readable summary or notes about 
opening hours. Primary reference language (English) text. (Translatable via 
public.translations)" }, "opening_hours_last_verified_at": { "type": ["string", 
"null"], "format": "date-time", "description": "When the opening hours were 
last checked/verified." }, "entry_fee_details": { "type": ["string", "null"], 
"description": "Information on entry fees, donations, pilgrim discounts. 
Primary reference language (English) text. (Translatable via 
public.translations)" }, "guided_tours_info": { "type": ["string", "null"], 
"description": "Information on guided tours. Primary reference language 
(English) text. (Translatable via public.translations)" }, "audio_guides_info": 
{ "type": ["string", "null"], "description": "Information on audio guides. 
Primary reference language (English) text. (Translatable via 
public.translations)" }, "photography_allowed_notes": { "type": ["string", 
"null"], "description": "Policy on photography/videography. Primary reference 
language (English) text. (Translatable via public.translations)" }, 
"accessibility_details_specific": { "type": ["string", "null"], "description": 
"Specific accessibility notes for this attraction. Primary reference language 
(English) text. (Translatable via public.translations)" }, 
"visitor_amenity_ids": { "type": ["array", "null"], "items": { "type": 
"integer" }, "description": "Array of FKs to visitor_amenities_master. On-site 
amenities. Integrity (existence and active status) enforced by DB trigger." }, 
"data_last_verified_at": { "type": ["string", "null"], "format": "date-time", 
"description": "When the overall details for this attraction were last 
verified." }, "created_at": { "type": "string", "format": "date-time", 
"description": "Timestamp of record creation.", "readOnly": true }, 
"created_by_profile_id": { "type": ["string", "null"], "format": "uuid", 
"description": "Profile ID of the user who created this attraction record." }, 
"updated_at": { "type": "string", "format": "date-time", "description": 
"Timestamp of last update.", "readOnly": true }, "updated_by_profile_id": { 
"type": ["string", "null"], "format": "uuid", "description": "Profile ID of the 
user who last updated this attraction record." } }, "required": [ 
"waypoint_id", "attraction_type_id", "created_at", "updated_at" ] } ``` 5\. 
Relationships & Integrity - Primary Key: `waypoint_id` (`BIGINT`) - Foreign 
Keys: - `waypoint_id` REFERENCES `public.waypoints(id)` ON DELETE CASCADE - 
`attraction_type_id` REFERENCES `public.attraction_types_master(id)` ON DELETE 
RESTRICT - Integrity constraint: Referenced `attraction_types_master` record 
must have `is_active = true` (enforced by 
`trigger_check_attraction_type_active`). - `created_by_profile_id` REFERENCES 
`public.profiles(id)` ON DELETE SET NULL - `updated_by_profile_id` REFERENCES 
`public.profiles(id)` ON DELETE SET NULL - Array Foreign Key: 
`visitor_amenity_ids` (elements are `INTEGER`) conceptually references 
`public.visitor_amenities_master(id)`. - Integrity constraint: Each ID must 
exist in `visitor_amenities_master` and the referenced record must have 
`is_active = true` (enforced by `trigger_check_attraction_visitor_amenities`). 
- Linking Tables: - `public.attraction_details_media` (Version 1.0) links this 
table to `public.media` for galleries or specific media roles. Its own DDL 
includes audit columns, `updated_at` trigger, and orphan translation cleanup 
for its translatable fields. - Child Table: This table is the parent for 
`public.religious_service_schedules` (which links via 
`attractions_details.waypoint_id`). 6\. Multilingual Strategy - Directly 
Translatable Fields (Primary reference language: English, translated via 
`public.translations`): - `detailed_description`, 
`historical_significance_notes`, `cultural_significance_notes`, 
`spiritual_significance_notes`, elements within 
`associated_historical_figures_text`, `key_historical_events_notes`, 
`opening_hours_text_notes`, `entry_fee_details`, `guided_tours_info`, 
`audio_guides_info`, `photography_allowed_notes`, 
`accessibility_details_specific`. - Translatable fields from 
`attraction_details_media`: `caption_override`, `alt_text_override`. - 
Indirectly Translatable Fields (via `label` fields in master tables, fetched by 
views/application logic): - `attraction_type_id` (links to 
`attraction_types_master.label`) - `visitor_amenity_ids` (elements link to 
`visitor_amenities_master.label`) - Orphan Cleanup: 
`trigger_cleanup_attraction_details_translations` `AFTER DELETE` on 
`attractions_details` removes related entries from `public.translations` for 
`attractions_details` fields and for fields from linked 
`attraction_details_media` records. Master tables (`attraction_types_master`, 
`visitor_amenities_master`) and `attraction_details_media` itself have their 
own triggers for cleaning their respective translations. 7\. Role-Based 
Workflow & RLS Notes - Key Fields for Workflow: `data_last_verified_at`, 
`opening_hours_last_verified_at` for content freshness. Audit columns for 
tracking. Publication status is driven by the parent `waypoints` record. - RLS 
Policies: - Row-Level Security is enabled on `attractions_details` and 
`attraction_details_media`. - Public users: `SELECT` access to details of 
published and non-deleted attractions (based on parent `waypoints` status and 
`content_statuses_master.is_publicly_visible`). - Privileged users (e.g., 
`platform_admin`, `regional_content_manager` via `public.has_role_on_profile`): 
`ALL` operations, with checks to prevent `waypoint_id` reparenting by 
non-`platform_admin` roles. 8\. ENUM vs Lookup Discussion - 
`attraction_types_master`: Promoted from an ENUM. Allows richer attributes 
(translatable labels/descriptions, icons, sort order, `is_active` flag, audit). 
- `visitor_amenities_master`: `visitor_amenity_ids` links to this master table, 
enabling standardized, translatable amenities with icons and `is_active` flags. 
9\. UI/UX Enablement - Filters, Icons, Lists: Driven by `attraction_type_id` 
(via `attraction_types_master`) and `visitor_amenity_ids` (via 
`visitor_amenities_master`). - Dynamic Content: `opening_hours_structured` for 
"Open Now?" indicators. - Rich Information: `entry_fee_details`, 
`detailed_description`, etc., for attraction pages. - Media Display: 
`attraction_details_media` table supports image galleries. - Performance: Key 
indexes on FKs, GIN indexes on array/JSONB fields. 10\. Key Considerations & 
Definitions - Data Integrity: - `attractions_details` requires a parent 
`waypoints` record. - FKs to master tables (`attraction_types_master`, 
`visitor_amenities_master`) are further protected by triggers ensuring master 
records are `is_active = true`. - `opening_hours_structured` (JSONB): Adherence 
to a central JSON schema is crucial. - `associated_historical_figures_text` 
(TEXT[]): Elements are translatable free text. Future versions might use a 
dedicated master table. - Data Freshness: `data_last_verified_at` and 
`opening_hours_last_verified_at` are important. 11\. Scalability & 
Future-Proofing - Lookup tables, `JSONB`, audit columns, and media linking 
provide good scalability. Partitioning would follow `waypoints`. 12\. 
Next-Action Checklist - 🔴 Verify Prerequisite Master Tables: Confirm 
`public.attraction_types_master` (V1.1) and `public.visitor_amenities_master` 
(V1.1) are implemented with `is_active`, `label`, full audit, and relevant 
triggers. Seed data populated. - 🔴 Verify Global Prerequisites: 
`public.waypoints`, `public.profiles`, `public.media`, 
`public.media_roles_master`, `public.translations`, `public.languages_master`, 
`public.content_statuses_master` are V2 compliant. - 🔴 Implement/Verify 
`attractions_details` Table: Execute DDL for Version 1.3.1 (ensuring no `_en` 
denormalized columns). - 🔴 Implement/Verify Triggers on `attractions_details`: 
- `trigger_attractions_details_set_updated_at`. - 
`trigger_check_attraction_visitor_amenities` (checks existence and 
`is_active`). - `trigger_cleanup_attraction_details_translations` (handles main 
table and linked media). - `trigger_check_attraction_type_active`. - 🔴 
Implement/Verify `attraction_details_media` Table: DDL (Version 1.0), triggers 
(`updated_at`, orphan translation for its fields), indexes, RLS are correct. - 
🟠 JSON Schema for `opening_hours_structured`: Formalize and document. - 🟠 RLS 
Helper Functions: Ensure `public.has_role_on_profile(UUID, TEXT)` is robustly 
defined and tested. - 🟢 RLS Policies: Thoroughly test all implemented RLS 
policies. - 🟢 Translation Entries: Prepare for all translatable fields. - 🟢 
Data Migration: If prior data exists, ensure schema compatibility. 
