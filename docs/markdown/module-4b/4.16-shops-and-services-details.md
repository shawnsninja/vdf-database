# 4.16 shops_and_services_details

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/1d4834db0819faf2 
https://gemini.google.com/u/1/app/d423d51e9f40da78 ### 3\. Updated 
Production-Ready Specification (`shops_and_services_details`) This document 
details the structure, purpose, and considerations for the 
`shops_and_services_details` table, Version 1.3.1 (reflecting RLS role name 
alignment and removal of denormalized labels). This version incorporates full 
V2 enhancements including robust audit fields, refined i18n strategy, array 
foreign key integrity with active status checks, media linking, `is_active` 
checks for its single foreign keys to master tables, and refined constraints. 
1\. Purpose & Primary Use-Cases The `shops_and_services_details` table stores 
specific information for waypoints that function as shops or provide practical 
services essential for pilgrims (e.g., pharmacies, ATMs, grocery stores, post 
offices, tourist information). This table extends the generic `waypoints` entry 
to include operational details such as the specific service type, opening hours 
(both structured and textual notes), contact information, languages spoken, 
payment methods accepted, general price range, and any service-specific notes 
or accessibility information relevant to pilgrims. This data enables pilgrims 
to easily find, assess, and utilize essential services along their journey. Key 
user-story touchpoints: - Pilgrim: Finding essential services like ATMs, 
pharmacies, or laundromats in a town or along the route. - Pilgrim: Checking 
opening hours, contact details, and payment options for these services. - 
Pilgrim: Getting specific advice, like emergency pharmacy procedures or what a 
particular Tabacchi shop sells that might be useful. - Admin/Content Manager: 
Adding, updating, and curating detailed information for various shops and 
services to ensure accuracy and usefulness for pilgrims. - System/UI: Powering 
map displays with service-specific icons, enabling filtered searches for 
practical needs, and providing comprehensive detail pages for each service 
point. 2\. Schema (`shops_and_services_details`) | column | data_type | 
constraints | description | | `waypoint_id` | `BIGINT` | Primary Key, Foreign 
Key to `public.waypoints(id)` ON DELETE CASCADE | Links to the generic 
`waypoints` table. This is the PK. | | `service_type_id` | `INTEGER` | Not 
Null, Foreign Key to `public.shop_service_types_master(id)` ON DELETE RESTRICT 
| The primary type of shop or service offered, linking to an *active* 
`shop_service_types_master` record. | | `operator_or_brand_name` | `TEXT` | 
Nullable, CHECK (`operator_or_brand_name` IS NULL OR 
length(`operator_or_brand_name`) &lt;= 150) | Name of the specific operator or 
brand (e.g., "Poste Italiane," "Farmacia Dr. Rossi"). Primary reference 
language (English) text. (Translatable via `public.translations`) | | 
`products_or_services_summary` | `TEXT` | Nullable | Brief summary of key 
products/services offered. Primary reference language (English) text. 
(Translatable via `public.translations`) | | `is_open_24_hours` | `BOOLEAN` | 
Not Null, Default `false` | Indicates if the service is available 24/7 (e.g., 
some ATMs). | | `opening_hours_structured` | `JSONB` | Nullable, CHECK 
(`opening_hours_structured` IS NULL OR 
jsonb_type_of(`opening_hours_structured`) IN ('object', 'array')) | Structured 
opening hours (e.g., schema.org format) for machine readability. Adheres to the 
centrally defined project schema. | | `opening_hours_text_notes` | `TEXT` | 
Nullable | Human-readable summary, exceptions, or general notes about opening 
hours. Primary reference language (English) text. (Translatable via 
`public.translations`) | | `opening_hours_last_verified_at` | `TIMESTAMPTZ` | 
Nullable | When the opening hours were last checked/verified by an editor or 
reliable source. | | `emergency_service_details` | `TEXT` | Nullable | For 
services like pharmacies, details on emergency/after-hours availability or 
contact. Primary reference language (English) text. (Translatable via 
`public.translations`) | | `contact_phone_service` | `TEXT` | Nullable, CHECK 
(`contact_phone_service` IS NULL OR length(`contact_phone_service`) &lt;= 50) | 
Specific contact phone number for this service/shop. | | 
`contact_email_service` | `TEXT` | Nullable, CHECK (`contact_email_service` IS 
NULL OR (length(`contact_email_service`) &lt;= 254 AND `contact_email_service` 
~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+.[A-Za-z]{2,}$')) | Specific contact email 
for this service/shop. Validated format. | | `website_url_service` | `TEXT` | 
Nullable, CHECK (`website_url_service` IS NULL OR 
(length(`website_url_service`) &lt;= 2048 AND `website_url_service` ~* 
'^https?://.+')) | Specific website URL for this service/shop. Validated 
format. | | `languages_spoken_codes` | `CHAR(2)[]` | Nullable | Array of ISO 
639-1 language codes spoken by staff. Integrity (existence in 
`languages_master` and language `is_active_for_platform`) enforced by DB 
trigger. | | `payment_method_ids` | `INTEGER[]` | Nullable | Array of FKs to 
`payment_methods_master(id)`. Indicates accepted payment methods. Integrity 
(existence and `is_active` status) enforced by DB trigger. | | 
`general_price_range_id` | `INTEGER` | Nullable, Foreign Key to 
`public.establishment_price_ranges_master(id)` ON DELETE SET NULL | General 
price level if applicable (e.g., for a gear shop), linking to an *active* 
`establishment_price_ranges_master` record. | | `accessibility_notes_service` | 
`TEXT` | Nullable | Specific notes regarding accessibility for this 
shop/service, supplementing `waypoints.waypoint_accessibility_notes`. Primary 
reference language (English) text. (Translatable via `public.translations`) | | 
`service_specific_details_notes` | `TEXT` | Nullable | Other relevant details 
unique to this service (e.g., ATM withdrawal limits, Post Office services 
available). Primary reference language (English) text. (Translatable via 
`public.translations`) | | `data_last_verified_at` | `TIMESTAMPTZ` | Nullable | 
Timestamp when overall details for this shop/service were last verified by an 
editor or reliable source. | | `created_at` | `TIMESTAMPTZ` | Not Null, Default 
`now()` | Timestamp of record creation. | | `created_by_profile_id` | `UUID` | 
Nullable, Foreign Key to `public.profiles(id)` ON DELETE SET NULL | Profile ID 
of the user who created this record. | | `updated_at` | `TIMESTAMPTZ` | Not 
Null, Default `now()` | Timestamp of last update (auto-updated by trigger). | | 
`updated_by_profile_id` | `UUID` | Nullable, Foreign Key to 
`public.profiles(id)` ON DELETE SET NULL | Profile ID of the user who last 
updated this record. | | `deleted_at` | `TIMESTAMPTZ` | Nullable | Timestamp 
for soft deletion. Allows independent lifecycle for this detail record if a 
specific service closes. | 3\. PostgreSQL DDL SQL ``` -- Ensure prerequisite 
tables are V2 compliant and created first: -- public.waypoints (BIGINT id PK, 
content_visibility_status_id INTEGER, deleted_at TIMESTAMPTZ) -- 
public.profiles (UUID id PK, roles TEXT[]) -- public.media (UUID id PK) -- 
public.media_roles_master (TEXT code PK) -- public.translations (for i18n) -- 
public.content_statuses_master (INTEGER id PK, is_publicly_visible BOOLEAN) -- 
public.shop_service_types_master (Version 1.2.1 - with label, is_active, audit, 
triggers, RLS) -- public.payment_methods_master (Version 1.1 - with label, 
is_active, audit, triggers, RLS) -- public.establishment_price_ranges_master 
(Version 1.1 - with label, is_active, audit, triggers, RLS) -- 
public.languages_master (Version 2.1 - language_code CHAR(2) PK, 
display_name_en TEXT, is_active_for_platform BOOLEAN) -- Shops & Services 
Details Table (Version 1.3.1) CREATE TABLE public.shops_and_services_details ( 
waypoint_id BIGINT PRIMARY KEY, service_type_id INTEGER NOT NULL, 
operator_or_brand_name TEXT NULL CHECK (operator_or_brand_name IS NULL OR 
length(operator_or_brand_name) <= 150), products_or_services_summary TEXT NULL, 
is_open_24_hours BOOLEAN NOT NULL DEFAULT FALSE, opening_hours_structured JSONB 
NULL CHECK (opening_hours_structured IS NULL OR 
jsonb_type_of(opening_hours_structured) IN ('object', 'array')), 
opening_hours_text_notes TEXT NULL, opening_hours_last_verified_at TIMESTAMPTZ 
NULL, emergency_service_details TEXT NULL, contact_phone_service TEXT NULL 
CHECK (contact_phone_service IS NULL OR length(contact_phone_service) <= 50), 
contact_email_service TEXT NULL CHECK (contact_email_service IS NULL OR 
(length(contact_email_service) <= 254 AND contact_email_service ~* 
'^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')), website_url_service TEXT 
NULL CHECK (website_url_service IS NULL OR (length(website_url_service) <= 2048 
AND website_url_service ~* '^https?://.+')), languages_spoken_codes CHAR(2)[] 
NULL, payment_method_ids INTEGER[] NULL, general_price_range_id INTEGER NULL, 
accessibility_notes_service TEXT NULL, service_specific_details_notes TEXT 
NULL, data_last_verified_at TIMESTAMPTZ NULL, created_at TIMESTAMPTZ NOT NULL 
DEFAULT now(), created_by_profile_id UUID NULL, updated_at TIMESTAMPTZ NOT NULL 
DEFAULT now(), updated_by_profile_id UUID NULL, deleted_at TIMESTAMPTZ NULL, 
CONSTRAINT fk_waypoint FOREIGN KEY(waypoint_id) REFERENCES public.waypoints(id) 
ON DELETE CASCADE, CONSTRAINT fk_service_type FOREIGN KEY(service_type_id) 
REFERENCES public.shop_service_types_master(id) ON DELETE RESTRICT, CONSTRAINT 
fk_general_price_range FOREIGN KEY(general_price_range_id) REFERENCES 
public.establishment_price_ranges_master(id) ON DELETE SET NULL, CONSTRAINT 
fk_created_by_profile FOREIGN KEY(created_by_profile_id) REFERENCES 
public.profiles(id) ON DELETE SET NULL, CONSTRAINT fk_updated_by_profile 
FOREIGN KEY(updated_by_profile_id) REFERENCES public.profiles(id) ON DELETE SET 
NULL ); COMMENT ON TABLE public.shops_and_services_details IS 'Specific details 
for shops and practical services, extending the waypoints table. Includes soft 
delete. Version 1.3.1'; COMMENT ON COLUMN 
public.shops_and_services_details.waypoint_id IS 'Links to the generic 
waypoints table. This is the PK.'; COMMENT ON COLUMN 
public.shops_and_services_details.service_type_id IS 'FK to 
shop_service_types_master. The primary type of shop or service. Referenced 
master record must be is_active=true.'; COMMENT ON COLUMN 
public.shops_and_services_details.operator_or_brand_name IS 'Name of the 
specific operator or brand. Primary reference language (English) text. 
(Translatable via public.translations). Max 150 chars.'; COMMENT ON COLUMN 
public.shops_and_services_details.products_or_services_summary IS 'Brief 
summary of key products/services offered. Primary reference language (English) 
text. (Translatable via public.translations).'; COMMENT ON COLUMN 
public.shops_and_services_details.is_open_24_hours IS 'Indicates if the service 
is available 24/7 (e.g., some ATMs).'; COMMENT ON COLUMN 
public.shops_and_services_details.opening_hours_structured IS 'Structured 
opening hours (e.g., schema.org format) in JSONB. Adheres to the centrally 
defined schema.'; COMMENT ON COLUMN 
public.shops_and_services_details.opening_hours_text_notes IS 'Human-readable 
summary, exceptions, or general notes about opening hours. Primary reference 
language (English) text. (Translatable via public.translations).'; COMMENT ON 
COLUMN public.shops_and_services_details.opening_hours_last_verified_at IS 
'When the opening hours were last checked/verified.'; COMMENT ON COLUMN 
public.shops_and_services_details.emergency_service_details IS 'For services 
like pharmacies, details on emergency/after-hours availability or contact. 
Primary reference language (English) text. (Translatable via 
public.translations).'; COMMENT ON COLUMN 
public.shops_and_services_details.contact_phone_service IS 'Specific contact 
phone number for this service/shop. Max 50 chars.'; COMMENT ON COLUMN 
public.shops_and_services_details.contact_email_service IS 'Specific contact 
email for this service/shop. Validated format. Max 254 chars.'; COMMENT ON 
COLUMN public.shops_and_services_details.website_url_service IS 'Specific 
website URL for this service/shop. Validated format. Max 2048 chars.'; COMMENT 
ON COLUMN public.shops_and_services_details.languages_spoken_codes IS 'Array of 
ISO 639-1 language codes spoken by staff (e.g., {''it'', ''en''}). Integrity 
(existence in languages_master and language is_active_for_platform) enforced by 
DB trigger.'; COMMENT ON COLUMN 
public.shops_and_services_details.payment_method_ids IS 'Array of FKs to 
payment_methods_master. Accepted payment methods. Integrity (existence and 
is_active status) enforced by DB trigger.'; COMMENT ON COLUMN 
public.shops_and_services_details.general_price_range_id IS 'FK to 
establishment_price_ranges_master. General price level if applicable (e.g., for 
a gear shop). Referenced master record must be is_active=true.'; COMMENT ON 
COLUMN public.shops_and_services_details.accessibility_notes_service IS 
'Specific notes regarding accessibility for this shop/service. Primary 
reference language (English) text. (Translatable via public.translations).'; 
COMMENT ON COLUMN 
public.shops_and_services_details.service_specific_details_notes IS 'Other 
relevant details unique to this service. Primary reference language (English) 
text. (Translatable via public.translations).'; COMMENT ON COLUMN 
public.shops_and_services_details.data_last_verified_at IS 'Timestamp when 
overall details for this shop/service were last verified.'; COMMENT ON COLUMN 
public.shops_and_services_details.created_at IS 'Timestamp of record 
creation.'; COMMENT ON COLUMN 
public.shops_and_services_details.created_by_profile_id IS 'Profile ID of the 
user who created this record.'; COMMENT ON COLUMN 
public.shops_and_services_details.updated_at IS 'Timestamp of last update 
(auto-updated by trigger).'; COMMENT ON COLUMN 
public.shops_and_services_details.updated_by_profile_id IS 'Profile ID of the 
user who last updated this record.'; COMMENT ON COLUMN 
public.shops_and_services_details.deleted_at IS 'Timestamp for soft deletion. 
If NULL, record is active. Allows independent lifecycle for this detail record 
if a specific service closes.'; -- Linking table for Shop/Service Media 
(public.shop_service_media - Version 1.0) CREATE TABLE IF NOT EXISTS 
public.shop_service_media ( id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY, 
shop_service_waypoint_id BIGINT NOT NULL REFERENCES 
public.shops_and_services_details(waypoint_id) ON DELETE CASCADE, media_id UUID 
NOT NULL REFERENCES public.media(id) ON DELETE RESTRICT, media_role_code TEXT 
NOT NULL REFERENCES public.media_roles_master(code) ON DELETE RESTRICT, 
display_order SMALLINT NOT NULL DEFAULT 0, caption_override TEXT NULL, -- 
Primary reference language (English). Translatable. alt_text_override TEXT 
NULL, -- Primary reference language (English). Translatable. created_at 
TIMESTAMPTZ NOT NULL DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL DEFAULT 
now(), created_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE 
SET NULL, updated_by_profile_id UUID NULL REFERENCES public.profiles(id) ON 
DELETE SET NULL, CONSTRAINT uq_shop_service_media_role_order UNIQUE 
(shop_service_waypoint_id, media_id, media_role_code) ); COMMENT ON TABLE 
public.shop_service_media IS 'Links shops/services to media items for galleries 
or specific semantic roles. Version 1.0'; CREATE TRIGGER 
trigger_shop_service_media_set_updated_at BEFORE UPDATE ON 
public.shop_service_media FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); CREATE OR REPLACE FUNCTION 
public.cleanup_shop_service_media_translations() RETURNS TRIGGER AS $$ BEGIN 
DELETE FROM public.translations WHERE table_identifier = 'shop_service_media' 
AND row_foreign_key = OLD.id::TEXT; RETURN OLD; END; $$ LANGUAGE plpgsql 
SECURITY DEFINER; CREATE TRIGGER 
trigger_cleanup_shop_service_media_translations AFTER DELETE ON 
public.shop_service_media FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_shop_service_media_translations(); COMMENT ON TRIGGER 
trigger_cleanup_shop_service_media_translations ON public.shop_service_media IS 
'Cleans up orphaned translations for shop_service_media translatable fields.'; 
-- Triggers & Functions for shops_and_services_details CREATE TRIGGER 
trigger_shops_services_details_set_updated_at BEFORE UPDATE ON 
public.shops_and_services_details FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); COMMENT ON TRIGGER 
trigger_shops_services_details_set_updated_at ON 
public.shops_and_services_details IS 'Trigger to automatically update 
updated_at timestamp on row modification.'; CREATE OR REPLACE FUNCTION 
public.cleanup_shops_services_details_translations() RETURNS TRIGGER AS $$ 
BEGIN DELETE FROM public.translations WHERE table_identifier = 
'shops_and_services_details' AND row_foreign_key = OLD.waypoint_id::TEXT; 
DELETE FROM public.translations WHERE table_identifier = 'shop_service_media' 
AND row_foreign_key IN (SELECT id::TEXT FROM public.shop_service_media WHERE 
shop_service_waypoint_id = OLD.waypoint_id); RETURN OLD; END; $$ LANGUAGE 
plpgsql SECURITY DEFINER; CREATE TRIGGER 
trigger_cleanup_shops_services_details_translations AFTER DELETE ON 
public.shops_and_services_details FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_shops_services_details_translations(); COMMENT ON TRIGGER 
trigger_cleanup_shops_services_details_translations ON 
public.shops_and_services_details IS 'Cleans up orphaned translations for 
shops_and_services_details and its linked media.'; CREATE OR REPLACE FUNCTION 
public.check_shop_service_type_active() RETURNS TRIGGER AS $$ DECLARE 
is_type_active BOOLEAN; BEGIN IF NEW.service_type_id IS NOT NULL THEN SELECT 
sstm.is_active INTO is_type_active FROM public.shop_service_types_master sstm 
WHERE sstm.id = NEW.service_type_id; IF NOT is_type_active THEN RAISE EXCEPTION 
'Referenced shop_service_type_id: % must be active.', NEW.service_type_id; END 
IF; END IF; RETURN NEW; END; $$ LANGUAGE plpgsql; CREATE TRIGGER 
trigger_check_shop_service_type_active BEFORE INSERT OR UPDATE OF 
service_type_id ON public.shops_and_services_details FOR EACH ROW EXECUTE 
FUNCTION public.check_shop_service_type_active(); COMMENT ON TRIGGER 
trigger_check_shop_service_type_active ON public.shops_and_services_details IS 
'Ensures the referenced service_type_id in shop_service_types_master is 
active.'; CREATE OR REPLACE FUNCTION public.check_shop_price_range_active() 
RETURNS TRIGGER AS $$ DECLARE is_range_active BOOLEAN; BEGIN IF 
NEW.general_price_range_id IS NOT NULL THEN SELECT eprm.is_active INTO 
is_range_active FROM public.establishment_price_ranges_master eprm WHERE 
eprm.id = NEW.general_price_range_id; IF NOT is_range_active THEN RAISE 
EXCEPTION 'Referenced general_price_range_id: % must be active.', 
NEW.general_price_range_id; END IF; END IF; RETURN NEW; END; $$ LANGUAGE 
plpgsql; CREATE TRIGGER trigger_check_shop_price_range_active BEFORE INSERT OR 
UPDATE OF general_price_range_id ON public.shops_and_services_details FOR EACH 
ROW EXECUTE FUNCTION public.check_shop_price_range_active(); COMMENT ON TRIGGER 
trigger_check_shop_price_range_active ON public.shops_and_services_details IS 
'Ensures the referenced general_price_range_id in 
establishment_price_ranges_master is active.'; CREATE OR REPLACE FUNCTION 
public.check_shop_languages_spoken_active() RETURNS TRIGGER AS $$ DECLARE 
lang_code CHAR(2); is_valid BOOLEAN; lang_is_active BOOLEAN; BEGIN IF 
NEW.languages_spoken_codes IS NOT NULL AND 
array_length(NEW.languages_spoken_codes, 1) > 0 THEN FOREACH lang_code IN ARRAY 
NEW.languages_spoken_codes LOOP SELECT EXISTS (SELECT 1 FROM 
public.languages_master WHERE language_code = lang_code), 
lm.is_active_for_platform INTO is_valid, lang_is_active FROM 
public.languages_master lm WHERE lm.language_code = lang_code; IF 
lm.language_code IS NULL OR NOT is_valid THEN RAISE EXCEPTION 'Invalid 
languages_spoken_codes element: % - does not exist in languages_master.', 
lang_code; END IF; IF NOT lang_is_active THEN RAISE EXCEPTION 'Inactive 
languages_spoken_codes element: % (language not active_for_platform).', 
lang_code; END IF; END LOOP; END IF; RETURN NEW; END; $$ LANGUAGE plpgsql; 
CREATE TRIGGER trigger_check_shop_languages_spoken_active BEFORE INSERT OR 
UPDATE OF languages_spoken_codes ON public.shops_and_services_details FOR EACH 
ROW EXECUTE FUNCTION public.check_shop_languages_spoken_active(); COMMENT ON 
TRIGGER trigger_check_shop_languages_spoken_active ON 
public.shops_and_services_details IS 'Ensures all languages_spoken_codes exist 
in languages_master and are active_for_platform.'; CREATE OR REPLACE FUNCTION 
public.check_shop_payment_methods_active() RETURNS TRIGGER AS $$ DECLARE 
method_id INTEGER; is_valid BOOLEAN; method_is_active BOOLEAN; BEGIN IF 
NEW.payment_method_ids IS NOT NULL AND array_length(NEW.payment_method_ids, 1) 
> 0 THEN FOREACH method_id IN ARRAY NEW.payment_method_ids LOOP SELECT EXISTS 
(SELECT 1 FROM public.payment_methods_master WHERE id = method_id), 
pmm.is_active INTO is_valid, method_is_active FROM 
public.payment_methods_master pmm WHERE pmm.id = method_id; IF NOT is_valid 
THEN RAISE EXCEPTION 'Invalid payment_method_id: % - does not exist in 
payment_methods_master.', method_id; END IF; IF NOT method_is_active THEN RAISE 
EXCEPTION 'Inactive payment_method_id: %', method_id; END IF; END LOOP; END IF; 
RETURN NEW; END; $$ LANGUAGE plpgsql; CREATE TRIGGER 
trigger_check_shop_payment_methods_active BEFORE INSERT OR UPDATE OF 
payment_method_ids ON public.shops_and_services_details FOR EACH ROW EXECUTE 
FUNCTION public.check_shop_payment_methods_active(); COMMENT ON TRIGGER 
trigger_check_shop_payment_methods_active ON public.shops_and_services_details 
IS 'Ensures all payment_method_ids exist in payment_methods_master and are 
active.'; -- Indexes CREATE INDEX idx_shops_srv_service_type_id ON 
public.shops_and_services_details(service_type_id); CREATE INDEX 
idx_shops_srv_price_range_id ON 
public.shops_and_services_details(general_price_range_id) WHERE 
general_price_range_id IS NOT NULL; CREATE INDEX 
idx_shops_srv_payment_method_ids ON public.shops_and_services_details USING GIN 
(payment_method_ids) WHERE payment_method_ids IS NOT NULL; CREATE INDEX 
idx_shops_srv_lang_spoken_codes ON public.shops_and_services_details USING GIN 
(languages_spoken_codes) WHERE languages_spoken_codes IS NOT NULL; CREATE INDEX 
idx_shops_srv_deleted_at ON public.shops_and_services_details(deleted_at) WHERE 
deleted_at IS NOT NULL; CREATE INDEX IF NOT EXISTS 
idx_shops_srv_opening_hours_structured ON public.shops_and_services_details 
USING GIN (opening_hours_structured) WHERE opening_hours_structured IS NOT 
NULL; CREATE INDEX idx_sssd_created_by_profile_id ON 
public.shops_and_services_details(created_by_profile_id) WHERE 
created_by_profile_id IS NOT NULL; CREATE INDEX idx_sssd_updated_by_profile_id 
ON public.shops_and_services_details(updated_by_profile_id) WHERE 
updated_by_profile_id IS NOT NULL; CREATE INDEX 
idx_shop_service_media_ss_waypoint_id ON 
public.shop_service_media(shop_service_waypoint_id); -- RLS Policies ALTER 
TABLE public.shops_and_services_details ENABLE ROW LEVEL SECURITY; CREATE 
POLICY "public_read_shops_services_details" ON 
public.shops_and_services_details FOR SELECT USING ( 
shops_and_services_details.deleted_at IS NULL AND EXISTS ( SELECT 1 FROM 
public.waypoints w JOIN public.content_statuses_master csm ON 
w.content_visibility_status_id = csm.id WHERE w.id = 
shops_and_services_details.waypoint_id AND csm.is_publicly_visible = TRUE AND 
w.deleted_at IS NULL ) ); CREATE POLICY 
"manage_shops_services_details_for_privileged_users" ON 
public.shops_and_services_details FOR ALL USING ( (SELECT 
public.has_role_on_profile(auth.uid(), 'platform_admin')) OR (SELECT 
public.has_role_on_profile(auth.uid(), 'regional_content_manager')) -- 
Consistent role names ) WITH CHECK ( (SELECT 
public.has_role_on_profile(auth.uid(), 'platform_admin')) OR (SELECT 
public.has_role_on_profile(auth.uid(), 'regional_content_manager')) AND (TG_OP 
= 'INSERT' OR (TG_OP = 'UPDATE' AND OLD.waypoint_id = NEW.waypoint_id OR 
(SELECT public.has_role_on_profile(auth.uid(), 'platform_admin')))) ); -- (RLS 
for shop_service_media similar to other media linking tables, using consistent 
role names) ``` 4\. JSON Schema Mirror (shops_and_services_details) (Reflects 
the schema table in Section 2; does not include denormalized *_label_en 
columns) JSON ``` { "title": "shop_service_detail", "description": "Stores 
specific details for waypoints that are shops or provide practical services to 
pilgrims. Includes soft delete. Version 1.3.1", "type": "object", "properties": 
{ "waypoint_id": { "type": "integer", "format": "int64", "description": "PK, FK 
to waypoints.id." }, "service_type_id": { "type": "integer", "description": "FK 
to shop_service_types_master. The primary type of shop or service. Referenced 
master must be active." }, "operator_or_brand_name": { "type": ["string", 
"null"], "maxLength": 150, "description": "Name of the specific operator or 
brand. Primary reference language (English) text. (Translatable via 
public.translations)" }, "products_or_services_summary": { "type": ["string", 
"null"], "description": "Brief summary of key products/services. Primary 
reference language (English) text. (Translatable via public.translations)" }, 
"is_open_24_hours": { "type": "boolean", "default": false, "description": 
"Indicates if the service is available 24/7." }, "opening_hours_structured": { 
"type": ["object", "array", "null"], "description": "Structured opening hours 
(e.g., schema.org format) in JSONB. Can be object or array of objects." }, 
"opening_hours_text_notes": { "type": ["string", "null"], "description": 
"Human-readable summary about opening hours. Primary reference language 
(English) text. (Translatable via public.translations)" }, 
"opening_hours_last_verified_at": { "type": ["string", "null"], "format": 
"date-time", "description": "When the opening hours were last 
checked/verified." }, "emergency_service_details": { "type": ["string", 
"null"], "description": "Details on emergency/after-hours availability. Primary 
reference language (English) text. (Translatable via public.translations)" }, 
"contact_phone_service": { "type": ["string", "null"], "maxLength": 50, 
"description": "Specific contact phone number for this service/shop." }, 
"contact_email_service": { "type": ["string", "null"], "format": "email", 
"maxLength": 254, "description": "Specific contact email for this 
service/shop." }, "website_url_service": { "type": ["string", "null"], 
"format": "url", "pattern": "^https?://.+", "maxLength": 2048, "description": 
"Specific website URL for this service/shop." }, "languages_spoken_codes": { 
"type": ["array", "null"], "items": { "type": "string", "minLength": 2, 
"maxLength": 2 }, "description": "Array of ISO 639-1 language codes spoken by 
staff. Integrity (existence in languages_master and language 
is_active_for_platform) enforced by DB trigger." }, "payment_method_ids": { 
"type": ["array", "null"], "items": { "type": "integer" }, "description": 
"Array of FKs to payment_methods_master. Accepted payment methods. Integrity 
(existence and is_active status) enforced by DB trigger." }, 
"general_price_range_id": { "type": ["integer", "null"], "description": "FK to 
establishment_price_ranges_master. General price level if applicable. 
Referenced master must be active." }, "accessibility_notes_service": { "type": 
["string", "null"], "description": "Specific notes regarding accessibility. 
Primary reference language (English) text. (Translatable via 
public.translations)" }, "service_specific_details_notes": { "type": ["string", 
"null"], "description": "Other relevant details unique to this service. Primary 
reference language (English) text. (Translatable via public.translations)" }, 
"data_last_verified_at": { "type": ["string", "null"], "format": "date-time", 
"description": "Timestamp when overall details were last verified." }, 
"created_at": { "type": "string", "format": "date-time", "description": 
"Timestamp of record creation.", "readOnly": true }, "created_by_profile_id": { 
"type": ["string", "null"], "format": "uuid", "description": "Profile ID of the 
creator." }, "updated_at": { "type": "string", "format": "date-time", 
"description": "Timestamp of last update.", "readOnly": true }, 
"updated_by_profile_id": { "type": ["string", "null"], "format": "uuid", 
"description": "Profile ID of the last updater." }, "deleted_at": { "type": 
["string", "null"], "format": "date-time", "description": "Timestamp for soft 
deletion. Allows independent lifecycle for this detail record.", "readOnly": 
true } }, "required": ["waypoint_id", "service_type_id", "is_open_24_hours", 
"created_at", "updated_at"] } ``` 5\. Relationships & Integrity - Primary Key: 
`waypoint_id` (`BIGINT`). - Foreign Keys: - `service_type_id` REFERENCES 
`public.shop_service_types_master(id)` ON DELETE RESTRICT. (Integrity: 
Referenced master record must have `is_active = true`, enforced by 
`trigger_check_shop_service_type_active`). - `general_price_range_id` 
REFERENCES `public.establishment_price_ranges_master(id)` ON DELETE SET NULL. 
(Integrity: Referenced master record must have `is_active = true`, enforced by 
`trigger_check_shop_price_range_active`). - Audit FKs (`created_by_profile_id`, 
`updated_by_profile_id`) to `public.profiles(id)` ON DELETE SET NULL. - Array 
Foreign Keys: - `languages_spoken_codes` (elements `CHAR(2)`) to 
`languages_master(language_code)`. (Integrity: Each code must exist and the 
language record must have `is_active_for_platform = true`, enforced by 
`trigger_check_shop_languages_spoken_active`). - `payment_method_ids` (elements 
`INTEGER`) to `payment_methods_master(id)`. (Integrity: Each ID must exist and 
the master record must have `is_active = true`, enforced by 
`trigger_check_shop_payment_methods_active`). - Linking Tables: 
`public.shop_service_media` (Version 1.0) links this table to `public.media` 
for managing galleries or specific media roles associated with a shop/service. 
Its own DDL includes audit columns, `updated_at` trigger, and orphan 
translation cleanup for its translatable fields. 6\. Multilingual Strategy - 
Directly Translatable Fields (Primary reference language: English, translated 
via `public.translations`): - `operator_or_brand_name` - 
`products_or_services_summary` - `opening_hours_text_notes` - 
`emergency_service_details` - `accessibility_notes_service` - 
`service_specific_details_notes` - `shop_service_media.caption_override` (for 
linked media) - `shop_service_media.alt_text_override` (for linked media) - 
Indirectly Translatable Fields (via `label` or `name` fields in referenced 
master tables, fetched by views/application logic): - `service_type_id` (links 
to `shop_service_types_master.label`) - `payment_method_ids` (elements link to 
`payment_methods_master.label`) - `general_price_range_id` (links to 
`establishment_price_ranges_master.label`) - `languages_spoken_codes` (elements 
link to `languages_master.display_name_en` or `display_name_native`) - Orphan 
Cleanup: The `trigger_cleanup_shops_services_details_translations` (`AFTER 
DELETE` on `shops_and_services_details`) removes related entries from 
`public.translations` for this table and its media linking table 
(`shop_service_media`). Referenced master tables handle their own translation 
cleanup. 7\. Role-Based Workflow & RLS Notes - Key Fields for Workflow: 
`data_last_verified_at` and `opening_hours_last_verified_at` for content 
freshness. Audit columns for tracking. The `deleted_at` field allows for 
independent soft deletion of service details. Overall visibility is also 
influenced by the parent `waypoints` record's status. - RLS Policies: - 
Row-Level Security is enabled on `shops_and_services_details` and its media 
linking table. - Public Users (`SELECT`): Can read details of shops/services if 
`shops_and_services_details.deleted_at IS NULL` AND the parent waypoint is 
published (based on `waypoints.content_visibility_status_id` linking to 
`content_statuses_master.is_publicly_visible = TRUE`) and not soft-deleted 
(`waypoints.deleted_at IS NULL`). - Privileged Users (e.g., `platform_admin`, 
`regional_content_manager` roles, identified via `public.has_role_on_profile` 
helper): Have `ALL` permissions (CRUD). - `WITH CHECK` conditions prevent 
non-`platform_admin` users from re-parenting `waypoint_id` on `UPDATE`. - RLS 
policies on master tables ensure only active master records are generally 
readable by public roles, while `platform_admin` users have full control. 8\. 
ENUM vs Lookup Discussion - All relevant former ENUM concepts for this table's 
context (`shop_service_type_enum`, `establishment_price_range_enum`, 
`payment_methods_enum`, `languages_enum`) are correctly handled by linking to 
their respective full V2-compliant master lookup tables 
(`shop_service_types_master` (V1.2.1), `establishment_price_ranges_master` 
(V1.1), `payment_methods_master` (V1.1), `languages_master` (V2.1)). This 
approach provides superior structure, translatability, lifecycle management 
(`is_active`), auditability, and flexibility for adding descriptive attributes 
like icons and categories. 9\. UI/UX Enablement - Filtering and Identification: 
`service_type_id`, `payment_method_ids`, `general_price_range_id`, and 
`languages_spoken_codes` (all linking to master tables with `icon_identifier` 
and translatable `label`/`name` fields) are key for UI filters, map icons, and 
clear display names. - Operational Status: `is_open_24_hours` and 
`opening_hours_structured` (for "Open Now?" indicators and detailed schedules) 
are critical for pilgrim planning. - Contact and Specifics: 
`contact_phone_service`, `contact_email_service`, `website_url_service`, 
`emergency_service_details`, `products_or_services_summary`, and 
`service_specific_details_notes` provide rich, actionable information. - 
Language Support: `languages_spoken_codes` allows display of languages spoken 
at the service location, enhancing accessibility for international pilgrims. - 
Media: The `shop_service_media` table allows for visual representation (e.g., 
shopfront photos, pictures of specific services offered). 10\. Key 
Considerations & Definitions - `opening_hours_structured` (JSONB): Strict 
adherence to the centrally defined JSON schema is vital for consistency in data 
entry and reliable parsing by frontend applications. - Array FK Validation: The 
database triggers for `languages_spoken_codes` (against 
`languages_master.language_code` and `languages_master.is_active_for_platform`) 
and `payment_method_ids` (against `payment_methods_master.id` and 
`payment_methods_master.is_active`) are critical for maintaining data 
integrity. - `deleted_at` Field: This field allows a specific shop/service 
detail record to be soft-deleted (e.g., if a particular pharmacy at a waypoint 
closes down, but other services or the waypoint itself remain relevant). RLS 
policies for public reads must correctly filter for 
`shops_and_services_details.deleted_at IS NULL`, in addition to checking the 
status of the parent `waypoints` record. This provides more granular lifecycle 
management at the detail level compared to solely relying on the parent 
waypoint's status. - URL Validation: The `website_url_service` field includes a 
regex (`~* '^https?://.+'`) for basic URL format validation, ensuring data 
quality. 11\. Scalability & Future-Proofing - The use of linked master tables 
for classifications and `JSONB` for flexible data structures like opening hours 
supports scalability and future additions of new service types or attributes 
without major schema alterations. - Comprehensive audit columns and the 
`deleted_at` field for soft deletion provide good data governance and allow for 
historical tracking or potential restoration of service details. - The 1:1 
relationship with `waypoints` means that any partitioning strategy implemented 
for `waypoints` could be extended to `shops_and_services_details` if necessary. 
12\. Next-Action Checklist - 🔴 Verify Prerequisite Master Tables are V2 
Compliant: - Confirm `public.shop_service_types_master` (Version 1.2.1). - 
Confirm `public.payment_methods_master` (Version 1.1). - Confirm 
`public.establishment_price_ranges_master` (Version 1.1). - Confirm 
`public.languages_master` (Version 2.1). - Ensure these tables are populated 
with seed data and all their triggers/RLS are active. - Verify 
`public.media_roles_master` is populated for use by `shop_service_media`. - 🔴 
Implement/Update `shops_and_services_details` Table: Execute the DDL for 
Version 1.3.1 (including updated `website_url_service` CHECK constraint). - 🔴 
Implement/Verify Triggers on `shops_and_services_details`: - 
`trigger_shops_services_details_set_updated_at` (for `updated_at`). - 
`trigger_cleanup_shops_services_details_translations` (for orphan translation 
cleanup, including linked media). - Active check triggers for single FKs: 
`trigger_check_shop_service_type_active`, 
`trigger_check_shop_price_range_active`. - Array FK integrity triggers 
(checking existence and `is_active`): 
`trigger_check_shop_languages_spoken_active`, 
`trigger_check_shop_payment_methods_active`. - 🔴 Implement/Verify 
`shop_service_media` Table: Ensure its DDL (Version 1.0), triggers 
(`updated_at`, orphan translation for its translatable fields: 
`caption_override`, `alt_text_override`), indexes, and RLS policies are 
correctly implemented. - 🟠 JSON Schema for `opening_hours_structured`: Ensure 
this schema is formally defined, documented, and consistently used. - 🟠 RLS 
Helper Functions: Ensure `public.has_role_on_profile(UUID, TEXT)` (or 
equivalent) is defined, secure, and functions as expected within RLS policies. 
- 🟢 RLS Policies: Thoroughly test all implemented RLS policies for 
`shops_and_services_details`, its media table, and related master tables. - 🟢 
Translation Entries & Seed Data: Prepare initial English entries in 
`public.translations` for all translatable fields. - 🟢 Data Migration (if 
applicable): If `shops_and_services_details` already contains data, ensure 
schema changes (like the refined URL check) are compatible or plan data 
cleansing. 
