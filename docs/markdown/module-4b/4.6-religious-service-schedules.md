# 4.6 religious_service_schedules

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/1d4834db0819faf2 
https://gemini.google.com/u/1/app/d423d51e9f40da78 ### 3\. Updated 
Production-Ready Specification (`religious_service_schedules`) This document 
details the structure, purpose, and considerations for the 
`religious_service_schedules` table, Version 1.3.1 (reflecting RLS role name 
alignment and no `_en` denormalized labels). This version incorporates full V2 
enhancements including robust audit fields, refined i18n strategy, and 
`is_active` checks for its foreign keys to `religious_service_types_master` and 
`languages_master`. It remains a child table of `attractions_details`. 1\. 
Purpose & Primary Use-Cases The `religious_service_schedules` table stores 
specific, repeatable schedules for religious services (e.g., Mass, Vespers, 
Adoration) offered at attractions that are religious sites (like churches, 
monasteries, basilicas). It allows for structured entry of service types, 
timings, languages, and other relevant notes for pilgrims. This information is 
critical for pilgrims wishing to participate in religious observances during 
their journey, aiding in their spiritual and logistical planning. Key 
user-story touchpoints: - Pilgrim: Finding Mass times or other service 
schedules for a specific church or religious site along their route (Story A4). 
- Pilgrim: Knowing the language of a service and any specific notes (e.g., 
"pilgrim mass," "usually crowded"). - Content Manager/Admin: Accurately 
inputting and maintaining service schedules for religious attractions. - 
System/UI: Displaying a clear, filterable list of services for a religious 
site, potentially allowing users to filter by service type or day. 2\. Schema | 
column | data_type | constraints | description | | `id` | `BIGINT` | Primary 
Key (Generated as identity always) | Unique identifier for this specific 
service schedule entry. | | `attraction_waypoint_id` | `BIGINT` | Not Null, 
Foreign Key to `public.attractions_details(waypoint_id)` ON DELETE CASCADE | 
Links to the parent attraction/religious site in `attractions_details` (which 
is also a `waypoints.id`). | | `service_type_id` | `INTEGER` | Not Null, 
Foreign Key to `public.religious_service_types_master(id)` ON DELETE RESTRICT | 
Type of service (e.g., 'mass', 'vespers'), linking to an *active* 
`religious_service_types_master` record. | | `schedule_description_text` | 
`TEXT` | Not Null, CHECK (length(`schedule_description_text`) > 0) | 
Human-readable description of when it occurs (e.g., "Weekdays at 18:00", 
"Sundays & Holydays at 09:00 and 11:00"). Primary reference language (English) 
text. (Translatable via `public.translations`). | | `days_of_week` | 
`weekday_enum[]` | Nullable | If applicable, specific days of the week this 
service occurs. Uses `public.weekday_enum`. Helps with filtering. | | 
`time_of_day` | `TIME WITHOUT TIME ZONE` | Nullable | Specific start time if 
it's a regular daily/weekly occurrence. | | `language_code` | `CHAR(2)` | 
Nullable, Foreign Key to `public.languages_master(language_code)` ON DELETE SET 
NULL ON UPDATE CASCADE | Primary language code of the service (e.g., "it", 
"en", "la"). Links to an *active* `languages_master` record (i.e., 
`is_active_for_platform = true`). | | `language_notes` | `TEXT` | Nullable | 
Additional notes about language use in the service if `language_code` is not 
sufficient (e.g., "Sermon in English, liturgy in Latin"). Primary reference 
language (English) text. (Translatable via `public.translations`). | | 
`location_within_site_notes` | `TEXT` | Nullable | Specific location if the 
site has multiple chapels/altars (e.g., "Main Altar," "Side Chapel of St. 
Clare"). Primary reference language (English) text. (Translatable via 
`public.translations`). | | `seasonal_validity_notes` | `TEXT` | Nullable | 
Notes on seasonal variations in the schedule (e.g., "Summer schedule 
(June-Aug): 19:00"). Primary reference language (English) text. (Translatable 
via `public.translations`). | | `is_pilgrim_specific_service` | `BOOLEAN` | Not 
Null, Default `false` | Flags if this service is specifically aimed at or 
tailored for pilgrims. | | `service_notes` | `TEXT` | Nullable | Other 
important notes for pilgrims (e.g., "Usually very crowded, arrive early," 
"Pilgrim blessing included"). Primary reference language (English) text. 
(Translatable via `public.translations`). | | `data_last_verified_at` | 
`TIMESTAMPTZ` | Nullable | When this specific service schedule was last 
verified by an editor or reliable source. | | `created_at` | `TIMESTAMPTZ` | 
Not Null, Default `now()` | Timestamp of record creation. | | 
`created_by_profile_id` | `UUID` | Nullable, Foreign Key to 
`public.profiles(id)` ON DELETE SET NULL | Profile ID of the user who created 
this service schedule. | | `updated_at` | `TIMESTAMPTZ` | Not Null, Default 
`now()` | Timestamp of last update (auto-updated by trigger). | | 
`updated_by_profile_id` | `UUID` | Nullable, Foreign Key to 
`public.profiles(id)` ON DELETE SET NULL | Profile ID of the user who last 
updated this service schedule. | 3\. PostgreSQL DDL SQL ``` -- Ensure 
prerequisite tables are V2 compliant and created first: -- 
public.attractions_details (BIGINT waypoint_id PK) (Version 1.3.1 or higher) -- 
public.profiles (UUID id PK, roles TEXT[]) -- public.languages_master (CHAR(2) 
language_code PK, display_name_en TEXT, is_active_for_platform BOOLEAN) 
(Version 2.1) -- public.religious_service_types_master (INTEGER id PK, label 
TEXT, is_active BOOLEAN) (Version 1.1) -- public.translations (for i18n) -- 
public.content_statuses_master (INTEGER id PK, is_publicly_visible BOOLEAN) -- 
Used by RLS via parent waypoints -- public.waypoints (BIGINT id PK, 
content_visibility_status_id INTEGER, deleted_at TIMESTAMPTZ) -- Used by RLS 
via parent -- ENUM Type for days_of_week (ensure it exists globally or create 
if not) DO $$ BEGIN IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 
'weekday_enum') THEN CREATE TYPE public.weekday_enum AS ENUM ('monday', 
'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'); END IF; 
END$$; COMMENT ON TYPE public.weekday_enum IS 'Standard weekdays for scheduling 
purposes. Version 1.0'; [cite: 318] -- Master table for Religious Service Types 
(Version 1.1 - Assumed V2 Compliant) CREATE TABLE IF NOT EXISTS 
public.religious_service_types_master ( id INTEGER GENERATED ALWAYS AS IDENTITY 
PRIMARY KEY, code TEXT UNIQUE NOT NULL CHECK (length(code) > 0 AND length(code) 
<= 50 AND code ~ '^[a-z0-9_]+$'), label TEXT NOT NULL CHECK (length(label) > 0 
AND length(label) <= 100), -- Primary reference language (English). 
Translatable. [cite: 314] description TEXT NULL, -- Primary reference language 
(English). Translatable. [cite: 314] icon_identifier TEXT NULL CHECK 
(icon_identifier IS NULL OR length(icon_identifier) <= 100), -- [cite: 314] 
sort_order INTEGER NOT NULL DEFAULT 0, -- [cite: 314] is_active BOOLEAN NOT 
NULL DEFAULT true, created_at TIMESTAMPTZ NOT NULL DEFAULT now(), -- [cite: 
314] updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), -- [cite: 314] 
created_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE SET 
NULL, updated_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE 
SET NULL ); COMMENT ON TABLE public.religious_service_types_master IS 'Master 
list of religious service types (e.g., Mass, Vespers). `label` and 
`description` are translatable. Version 1.1'; [cite: 315] COMMENT ON COLUMN 
public.religious_service_types_master.label IS 'Primary reference language 
(English) label. (Translatable via public.translations)'; [cite: 316] COMMENT 
ON COLUMN public.religious_service_types_master.description IS 'Optional 
primary reference language (English) description. (Translatable via 
public.translations)'; [cite: 317] COMMENT ON COLUMN 
public.religious_service_types_master.is_active IS 'True if the service type is 
active and available for use.'; CREATE INDEX IF NOT EXISTS 
idx_religious_service_types_master_is_active ON 
public.religious_service_types_master(is_active); CREATE TRIGGER 
trigger_religious_service_types_master_set_updated_at BEFORE UPDATE ON 
public.religious_service_types_master FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); CREATE OR REPLACE FUNCTION 
public.cleanup_religious_service_type_translations() RETURNS TRIGGER AS $$ 
BEGIN DELETE FROM public.translations WHERE table_identifier = 
'religious_service_types_master' AND row_foreign_key = OLD.id::TEXT; RETURN 
OLD; END; $$ LANGUAGE plpgsql SECURITY DEFINER; CREATE TRIGGER 
trigger_cleanup_religious_service_type_translations AFTER DELETE ON 
public.religious_service_types_master FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_religious_service_type_translations(); COMMENT ON TRIGGER 
trigger_cleanup_religious_service_type_translations ON 
public.religious_service_types_master IS 'Cleans up orphaned translations for 
religious_service_types_master.'; -- Religious Service Schedules Table (Version 
1.3.1) CREATE TABLE public.religious_service_schedules ( id BIGINT GENERATED 
ALWAYS AS IDENTITY PRIMARY KEY, -- [cite: 313] attraction_waypoint_id BIGINT 
NOT NULL, -- [cite: 313] service_type_id INTEGER NOT NULL, -- [cite: 313] 
schedule_description_text TEXT NOT NULL CHECK 
(length(schedule_description_text) > 0), -- [cite: 313] days_of_week 
weekday_enum[] NULL, -- [cite: 313] time_of_day TIME WITHOUT TIME ZONE NULL, -- 
[cite: 313] language_code CHAR(2) NULL, -- [cite: 313] language_notes TEXT 
NULL, -- [cite: 313] location_within_site_notes TEXT NULL, -- [cite: 313] 
seasonal_validity_notes TEXT NULL, -- [cite: 313] is_pilgrim_specific_service 
BOOLEAN NOT NULL DEFAULT FALSE, -- [cite: 313] service_notes TEXT NULL, -- 
[cite: 313] data_last_verified_at TIMESTAMPTZ NULL, -- [cite: 313, 324] 
created_at TIMESTAMPTZ NOT NULL DEFAULT now(), -- [cite: 313] 
created_by_profile_id UUID NULL, -- [cite: 313] updated_at TIMESTAMPTZ NOT NULL 
DEFAULT now(), -- [cite: 313] updated_by_profile_id UUID NULL, -- [cite: 313] 
CONSTRAINT fk_attraction_waypoint FOREIGN KEY(attraction_waypoint_id) 
REFERENCES public.attractions_details(waypoint_id) ON DELETE CASCADE, -- [cite: 
324] CONSTRAINT fk_service_type FOREIGN KEY(service_type_id) REFERENCES 
public.religious_service_types_master(id) ON DELETE RESTRICT, -- [cite: 325] 
CONSTRAINT fk_language_code FOREIGN KEY(language_code) REFERENCES 
public.languages_master(language_code) ON DELETE SET NULL ON UPDATE CASCADE, -- 
[cite: 325] CONSTRAINT fk_created_by_profile FOREIGN KEY(created_by_profile_id) 
REFERENCES public.profiles(id) ON DELETE SET NULL, -- [cite: 325] CONSTRAINT 
fk_updated_by_profile FOREIGN KEY(updated_by_profile_id) REFERENCES 
public.profiles(id) ON DELETE SET NULL -- [cite: 326] ); COMMENT ON TABLE 
public.religious_service_schedules IS 'Stores specific schedules for religious 
services at attractions. Child of attractions_details. Version 1.3.1'; -- 
[cite: 327] COMMENT ON COLUMN public.religious_service_schedules.id IS 'Unique 
identifier for this specific service schedule entry.'; COMMENT ON COLUMN 
public.religious_service_schedules.attraction_waypoint_id IS 'FK to 
attractions_details.waypoint_id, linking to the parent religious site.'; [cite: 
328] COMMENT ON COLUMN public.religious_service_schedules.service_type_id IS 
'FK to religious_service_types_master. Type of service (e.g., Mass, Vespers). 
Referenced master record must be is_active=true.'; [cite: 329] COMMENT ON 
COLUMN public.religious_service_schedules.schedule_description_text IS 
'Human-readable description of when the service occurs. Primary reference 
language (English) text. (Translatable via public.translations)'; [cite: 330] 
COMMENT ON COLUMN public.religious_service_schedules.days_of_week IS 'Array of 
specific days of the week this service occurs, using weekday_enum.'; [cite: 
331] COMMENT ON COLUMN public.religious_service_schedules.time_of_day IS 
'Specific start time if regular daily/weekly occurrence.'; [cite: 332] COMMENT 
ON COLUMN public.religious_service_schedules.language_code IS 'FK to 
languages_master.language_code. Primary language code (ISO 639-1) of the 
service. Referenced master record must be is_active_for_platform=true.'; [cite: 
333] COMMENT ON COLUMN public.religious_service_schedules.language_notes IS 
'Additional notes about language use in the service. Primary reference language 
(English) text. (Translatable via public.translations)'; [cite: 334] COMMENT ON 
COLUMN public.religious_service_schedules.location_within_site_notes IS 
'Specific location if the site has multiple chapels/altars. Primary reference 
language (English) text. (Translatable via public.translations)'; [cite: 336] 
COMMENT ON COLUMN public.religious_service_schedules.seasonal_validity_notes IS 
'Notes on seasonal variations in the schedule. Primary reference language 
(English) text. (Translatable via public.translations)'; [cite: 337] COMMENT ON 
COLUMN public.religious_service_schedules.is_pilgrim_specific_service IS 'Flags 
if this service is specifically aimed at or tailored for pilgrims.'; [cite: 
338] COMMENT ON COLUMN public.religious_service_schedules.service_notes IS 
'Other important notes for pilgrims. Primary reference language (English) text. 
(Translatable via public.translations)'; [cite: 339] COMMENT ON COLUMN 
public.religious_service_schedules.data_last_verified_at IS 'When this specific 
service schedule was last verified.'; [cite: 341] COMMENT ON COLUMN 
public.religious_service_schedules.created_at IS 'Timestamp of record 
creation.'; COMMENT ON COLUMN 
public.religious_service_schedules.created_by_profile_id IS 'Profile ID of the 
user who created this record.'; [cite: 342] COMMENT ON COLUMN 
public.religious_service_schedules.updated_at IS 'Timestamp of last update 
(auto-updated by trigger).'; COMMENT ON COLUMN 
public.religious_service_schedules.updated_by_profile_id IS 'Profile ID of the 
user who last updated this record.'; [cite: 343] -- Triggers & Functions for 
religious_service_schedules CREATE TRIGGER 
trigger_religious_service_schedules_set_updated_at BEFORE UPDATE ON 
public.religious_service_schedules FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); -- [cite: 343] COMMENT ON TRIGGER 
trigger_religious_service_schedules_set_updated_at ON 
public.religious_service_schedules IS 'Trigger to automatically update 
updated_at timestamp on row modification.'; [cite: 344] CREATE OR REPLACE 
FUNCTION public.cleanup_religious_service_schedules_translations() RETURNS 
TRIGGER AS $$ BEGIN DELETE FROM public.translations WHERE table_identifier = 
'religious_service_schedules' AND row_foreign_key = OLD.id::TEXT; RETURN OLD; 
END; $$ LANGUAGE plpgsql SECURITY DEFINER; CREATE TRIGGER 
trigger_cleanup_religious_service_schedules_translations AFTER DELETE ON 
public.religious_service_schedules FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_religious_service_schedules_translations(); COMMENT ON TRIGGER 
trigger_cleanup_religious_service_schedules_translations ON 
public.religious_service_schedules IS 'Cleans up orphaned translations from 
public.translations when a religious_service_schedules record is deleted.'; 
CREATE OR REPLACE FUNCTION public.check_religious_service_type_active() RETURNS 
TRIGGER AS $$ DECLARE is_type_active BOOLEAN; BEGIN IF NEW.service_type_id IS 
NOT NULL THEN SELECT rstm.is_active INTO is_type_active FROM 
public.religious_service_types_master rstm WHERE rstm.id = NEW.service_type_id; 
IF NOT is_type_active THEN RAISE EXCEPTION 'Cannot link religious service 
schedule to inactive service_type_id: %. Corresponding 
religious_service_types_master record must be active.', NEW.service_type_id; 
END IF; END IF; RETURN NEW; END; $$ LANGUAGE plpgsql; CREATE TRIGGER 
trigger_check_religious_service_type_active BEFORE INSERT OR UPDATE OF 
service_type_id ON public.religious_service_schedules FOR EACH ROW EXECUTE 
FUNCTION public.check_religious_service_type_active(); COMMENT ON TRIGGER 
trigger_check_religious_service_type_active ON 
public.religious_service_schedules IS 'Ensures the referenced service_type_id 
in religious_service_types_master is active.'; CREATE OR REPLACE FUNCTION 
public.check_religious_service_language_active() RETURNS TRIGGER AS $$ DECLARE 
is_lang_active BOOLEAN; BEGIN IF NEW.language_code IS NOT NULL THEN SELECT 
lm.is_active_for_platform INTO is_lang_active FROM public.languages_master lm 
WHERE lm.language_code = NEW.language_code; IF lm.language_code IS NULL OR NOT 
is_lang_active THEN RAISE EXCEPTION 'Cannot link religious service schedule to 
non-existent or inactive language_code: %. Corresponding languages_master 
record must exist and be active_for_platform.', NEW.language_code; END IF; END 
IF; RETURN NEW; END; $$ LANGUAGE plpgsql; CREATE TRIGGER 
trigger_check_religious_service_language_active BEFORE INSERT OR UPDATE OF 
language_code ON public.religious_service_schedules FOR EACH ROW EXECUTE 
FUNCTION public.check_religious_service_language_active(); COMMENT ON TRIGGER 
trigger_check_religious_service_language_active ON 
public.religious_service_schedules IS 'Ensures the referenced language_code in 
languages_master exists and is active_for_platform.'; -- Indexes CREATE INDEX 
idx_religious_service_schedules_attraction_waypoint_id ON 
public.religious_service_schedules(attraction_waypoint_id); -- [cite: 345] 
CREATE INDEX idx_religious_service_schedules_service_type_id ON 
public.religious_service_schedules(service_type_id); -- [cite: 345] CREATE 
INDEX idx_religious_service_schedules_days_of_week ON 
public.religious_service_schedules USING GIN (days_of_week) WHERE days_of_week 
IS NOT NULL; -- [cite: 346] CREATE INDEX 
idx_religious_service_schedules_language_code ON 
public.religious_service_schedules(language_code) WHERE language_code IS NOT 
NULL; CREATE INDEX idx_rss_created_by_profile_id ON 
public.religious_service_schedules(created_by_profile_id) WHERE 
created_by_profile_id IS NOT NULL; CREATE INDEX idx_rss_updated_by_profile_id 
ON public.religious_service_schedules(updated_by_profile_id) WHERE 
updated_by_profile_id IS NOT NULL; -- RLS Policies for 
religious_service_types_master ALTER TABLE 
public.religious_service_types_master ENABLE ROW LEVEL SECURITY; CREATE POLICY 
"public_read_religious_service_types" ON public.religious_service_types_master 
FOR SELECT USING (is_active = true); CREATE POLICY 
"manage_religious_service_types_for_admins" ON 
public.religious_service_types_master FOR ALL USING ((SELECT 
public.has_role_on_profile(auth.uid(), 'platform_admin'))) WITH CHECK ((SELECT 
public.has_role_on_profile(auth.uid(), 'platform_admin'))); -- RLS Policies for 
religious_service_schedules ALTER TABLE public.religious_service_schedules 
ENABLE ROW LEVEL SECURITY; CREATE POLICY 
"public_read_religious_service_schedules" ON public.religious_service_schedules 
FOR SELECT USING ( EXISTS ( SELECT 1 FROM public.attractions_details ad JOIN 
public.waypoints w ON ad.waypoint_id = w.id JOIN public.content_statuses_master 
csm ON w.content_visibility_status_id = csm.id WHERE ad.waypoint_id = 
religious_service_schedules.attraction_waypoint_id AND csm.is_publicly_visible 
= TRUE AND w.deleted_at IS NULL ) ); CREATE POLICY 
"manage_religious_service_schedules_for_privileged_users" ON 
public.religious_service_schedules FOR ALL USING ( ((SELECT 
public.has_role_on_profile(auth.uid(), 'platform_admin')) OR (SELECT 
public.has_role_on_profile(auth.uid(), 'regional_content_manager'))) -- Updated 
role names AND EXISTS (SELECT 1 FROM public.attractions_details ad WHERE 
ad.waypoint_id = religious_service_schedules.attraction_waypoint_id) ) WITH 
CHECK ( ((SELECT public.has_role_on_profile(auth.uid(), 'platform_admin')) OR 
(SELECT public.has_role_on_profile(auth.uid(), 'regional_content_manager'))) -- 
Updated role names AND EXISTS (SELECT 1 FROM public.attractions_details ad 
WHERE ad.waypoint_id = religious_service_schedules.attraction_waypoint_id) AND 
(TG_OP = 'INSERT' OR (TG_OP = 'UPDATE' AND OLD.attraction_waypoint_id = 
NEW.attraction_waypoint_id OR (SELECT public.has_role_on_profile(auth.uid(), 
'platform_admin')))) ); ``` 4\. JSON Schema Mirror (Reflects the schema table 
in Section 2; does not include denormalized *_label_en or *_name_en columns) 
JSON ``` { "title": "religious_service_schedule", "description": "Stores 
specific schedules for religious services at attractions. Child of 
attractions_details. Version 1.3.1", "type": "object", "properties": { "id": { 
"type": "integer", "format": "int64", "description": "Unique identifier for 
this specific service schedule entry.", "readOnly": true }, 
"attraction_waypoint_id": { "type": "integer", "format": "int64", 
"description": "FK to attractions_details.waypoint_id, linking to the parent 
religious site." }, "service_type_id": { "type": "integer", "description": "FK 
to religious_service_types_master. Type of service. Referenced master record 
must be is_active=true." }, "schedule_description_text": { "type": "string", 
"description": "Human-readable description of when the service occurs. Primary 
reference language (English) text. (Translatable via public.translations)" }, 
"days_of_week": { "type": ["array", "null"], "items": { "type": "string", 
"enum": ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", 
"sunday"] }, "description": "Array of specific days of the week this service 
occurs, using weekday_enum." }, "time_of_day": { "type": ["string", "null"], 
"format": "time", "description": "Specific start time if regular daily/weekly 
occurrence." }, "language_code": { "type": ["string", "null"], "minLength": 2, 
"maxLength": 2, "description": "FK to languages_master.language_code. Primary 
language code (ISO 639-1) of the service. Referenced master record must be 
is_active_for_platform=true." }, "language_notes": { "type": ["string", 
"null"], "description": "Additional notes about language use in the service. 
Primary reference language (English) text. (Translatable via 
public.translations)" }, "location_within_site_notes": { "type": ["string", 
"null"], "description": "Specific location if the site has multiple 
chapels/altars. Primary reference language (English) text. (Translatable via 
public.translations)" }, "seasonal_validity_notes": { "type": ["string", 
"null"], "description": "Notes on seasonal variations in the schedule. Primary 
reference language (English) text. (Translatable via public.translations)" }, 
"is_pilgrim_specific_service": { "type": "boolean", "default": false, 
"description": "Flags if this service is specifically aimed at or tailored for 
pilgrims." }, "service_notes": { "type": ["string", "null"], "description": 
"Other important notes for pilgrims. Primary reference language (English) text. 
(Translatable via public.translations)" }, "data_last_verified_at": { "type": 
["string", "null"], "format": "date-time", "description": "When this specific 
service schedule was last verified." }, "created_at": { "type": "string", 
"format": "date-time", "description": "Timestamp of record creation.", 
"readOnly": true }, "created_by_profile_id": { "type": ["string", "null"], 
"format": "uuid", "description": "Profile ID of the user who created this 
record." }, "updated_at": { "type": "string", "format": "date-time", 
"description": "Timestamp of last update.", "readOnly": true }, 
"updated_by_profile_id": { "type": ["string", "null"], "format": "uuid", 
"description": "Profile ID of the user who last updated this record." } }, 
"required": [ "attraction_waypoint_id", "service_type_id", 
"schedule_description_text", "is_pilgrim_specific_service", "created_at", 
"updated_at" ] } ``` 5\. Relationships & Integrity - Primary Key: `id` 
(`BIGINT`) - Foreign Keys: - `attraction_waypoint_id` REFERENCES 
`public.attractions_details(waypoint_id)` ON DELETE CASCADE. - 
`service_type_id` REFERENCES `public.religious_service_types_master(id)` ON 
DELETE RESTRICT. - Integrity constraint: Referenced 
`religious_service_types_master` record must have `is_active = true` (enforced 
by `trigger_check_religious_service_type_active`). - `language_code` REFERENCES 
`public.languages_master(language_code)` ON DELETE SET NULL ON UPDATE CASCADE. 
- Integrity constraint: Referenced `languages_master` record must have 
`is_active_for_platform = true` (enforced by 
`trigger_check_religious_service_language_active`). - `created_by_profile_id` 
REFERENCES `public.profiles(id)` ON DELETE SET NULL. - `updated_by_profile_id` 
REFERENCES `public.profiles(id)` ON DELETE SET NULL. - ENUM Type: 
`public.weekday_enum` is used for the `days_of_week` array column, providing 
efficient storage and validation for weekday values. - Master Table: 
`public.religious_service_types_master` (Version 1.1) defines the types of 
services and includes an `is_active` flag. `public.languages_master` (Version 
2.1) defines supported languages and their active status. 6\. Multilingual 
Strategy - Directly Translatable Fields (Primary reference language: English, 
translated via `public.translations`): - `schedule_description_text` - 
`language_notes` - `location_within_site_notes` - `seasonal_validity_notes` - 
`service_notes` - Indirectly Translatable Fields (via `label`/`name` fields in 
master tables, fetched by views/application logic): - `service_type_id` (links 
to `religious_service_types_master.label`) - `language_code` (links to 
`languages_master.display_name_en` or `languages_master.display_name_native` 
for its full name) - Orphan Cleanup: The 
`trigger_cleanup_religious_service_schedules_translations` (`AFTER DELETE` on 
`religious_service_schedules`) removes related entries from 
`public.translations`. Referenced master tables 
(`religious_service_types_master`, `languages_master`) have their own orphan 
cleanup mechanisms. 7\. Role-Based Workflow & RLS Notes - Key Fields for 
Workflow: `data_last_verified_at` helps content managers track the freshness of 
schedule information. Audit columns (`created_by_profile_id`, 
`updated_by_profile_id`) provide a history of record modifications. - RLS 
Policies: - Row-Level Security is enabled on `religious_service_schedules` and 
its master table `religious_service_types_master`. - Public users have `SELECT` 
access to service schedules only if the parent `attractions_details` record 
(and subsequently its parent `waypoints` record) is published and not deleted 
(checked via `waypoints.content_visibility_status_id` and 
`waypoints.deleted_at`). - Privileged users (e.g., `platform_admin`, 
`regional_content_manager`) have `ALL` permissions (CRUD) on schedules linked 
to attractions they are permitted to manage. Role checks use the 
`public.has_role_on_profile` helper function. - A `WITH CHECK` condition 
prevents non-`platform_admin` users from re-parenting `attraction_waypoint_id` 
on `UPDATE`. 8\. ENUM vs Lookup Discussion - `religious_service_types_master`: 
This table (Version 1.1) correctly promotes an original 
`religious_service_type_enum` concept to a full lookup table. This allows for 
richer data including translatable labels, descriptions, optional icons, 
logical sorting, an `is_active` flag, and audit columns, offering more 
flexibility and maintainability. - `weekday_enum`: This is retained as a 
PostgreSQL ENUM type for the `days_of_week` array column. Weekdays represent a 
universally understood, small, and stable set of values where direct ENUM use 
is efficient. Translations of weekday names (e.g., "Monday" to "Lunedì") are 
typically handled by client-side internationalization libraries. 9\. UI/UX 
Enablement - Service Type Display: `service_type_id` (via 
`religious_service_types_master`) allows the UI to display the service type 
using its translatable `label` and potentially an `icon_identifier` from the 
master table. - Schedule Information: `schedule_description_text` serves as the 
primary display field for detailed schedule information. The structured 
`days_of_week` and `time_of_day` fields allow for more organized display and 
can be used for filtering (e.g., "Show services on Sunday"). - Language 
Indication: `language_code` (via `languages_master`) enables the UI to display 
the language of the service, using the translated name of the language (e.g., 
"Italiano", "English") and potentially a flag icon from 
`languages_master.icon_identifier`. `language_notes` provides additional 
context if needed. - Pilgrim-Specific Services: The 
`is_pilgrim_specific_service` flag can be used by the UI to highlight or filter 
services that are particularly relevant or tailored for pilgrims. - Contextual 
Notes: `location_within_site_notes`, `seasonal_validity_notes`, and 
`service_notes` provide valuable additional information to pilgrims, enhancing 
their planning capabilities. 10\. Key Considerations & Definitions - Data 
Granularity: Each row in `religious_service_schedules` represents one specific 
scheduled service or a distinct recurring pattern. For services occurring at 
multiple distinct times on the same day(s) that require individual filtering or 
display, multiple entries may be preferable over a single descriptive entry. - 
Clarity of `schedule_description_text`: This field remains crucial for 
conveying complex or irregular schedules that don't fit neatly into the 
structured `days_of_week` and `time_of_day` fields alone (e.g., "Every 1st 
Friday of the month at 5 PM," "Special holiday schedule: see noticeboard"). - 
Verification of Schedules: The `data_last_verified_at` field is important as 
service times can change frequently. A regular review process by content 
managers is recommended to maintain the accuracy of the information for 
pilgrims. 11\. Scalability & Future-Proofing - Child Table Scalability: The 
scalability of this table is primarily linked to the number of religious 
attractions offering services and the average number of distinct service 
schedules per attraction. Performance is maintained through proper indexing on 
foreign keys (`attraction_waypoint_id`, `service_type_id`, `language_code`) and 
commonly filtered fields like `days_of_week`. - Flexibility of Service Types: 
The use of `religious_service_types_master` allows for easy addition or 
modification of service classifications in the future without altering this 
table's schema. - Auditability: Standard audit columns (`created_at`, 
`created_by_profile_id`, `updated_at`, `updated_by_profile_id`) provide a clear 
history of changes to individual service schedule entries. 12\. Next-Action 
Checklist - 🔴 Verify Prerequisite Master Table Specs are V2 Compliant: - 
Confirm `public.religious_service_types_master` (Version 1.1) is implemented 
with `is_active`, `label`, full audit columns, and relevant triggers 
(updated_at, orphan translation cleanup). Seed data should be populated. - 
Confirm `public.languages_master` (Version 2.1 from global spec) is implemented 
with `is_active_for_platform` (or equivalent active flag) and 
`display_name_en`. - Confirm `public.attractions_details` (Version 1.3.1) is 
implemented. - 🔴 Implement/Update `religious_service_schedules` Table: Execute 
the DDL for Version 1.3.1 (ensuring no `_en` denormalized columns). - 🔴 
Implement/Verify Triggers on `religious_service_schedules`: - 
`trigger_religious_service_schedules_set_updated_at` (for `updated_at`). - 
`trigger_cleanup_religious_service_schedules_translations` (for orphan 
translation cleanup). - `trigger_check_religious_service_type_active` (for 
`service_type_id`, ensuring referenced master is active). - 
`trigger_check_religious_service_language_active` (for `language_code`, 
ensuring referenced master is active). - 🟠 Data Entry Strategy for Schedules: 
Define clear guidelines for content managers on how to best utilize 
`schedule_description_text` alongside `days_of_week` and `time_of_day` for 
clarity and filterability, especially for complex or irregular schedules. - 🟠 
RLS Helper Functions: Ensure `public.has_role_on_profile(UUID, TEXT)` or 
equivalent helper functions used in RLS policies are correctly defined, secure, 
and tested. - 🟢 RLS Policies: Thoroughly test all implemented RLS policies for 
`religious_service_schedules` and `religious_service_types_master`. - 🟢 
Initial Population & Translation Entries: Plan for data entry for known 
religious sites' service schedules into `religious_service_schedules`. Prepare 
initial English entries for all translatable fields in `public.translations`. - 
🟢 Seed Data for `religious_service_types_master`: Ensure seed data like 
('mass', 'Mass'), ('vespers', 'Vespers') etc. is populated, including 
`created_by_profile_id`. - 🟢 Data Migration (if applicable): If 
`religious_service_schedules` already contains data from a previous version, 
ensure schema changes are compatible or a migration script is prepared. 
