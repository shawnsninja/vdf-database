# 4.9 water_reliability_types_master

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/1d4834db0819faf2 
https://gemini.google.com/u/1/app/d423d51e9f40da78 ### 3\. Updated 
Production-Ready Specification (`water_reliability_types_master`) This document 
details the structure, purpose, and considerations for the 
`water_reliability_types_master` table, Version 1.2.1 (reflecting RLS role name 
alignment). This version incorporates full V2 audit columns, an `is_active` 
flag for lifecycle management, and refined indexing and translation handling. 
1\. Purpose & Primary Use-Cases The `water_reliability_types_master` table 
defines the different levels of reliability for natural or public water sources 
(e.g., "Year-round Reliable," "Seasonal - Check Locally," "Can Be 
Dry/Unreliable"). Its primary purpose is to provide standardized, translatable, 
and descriptive terms so pilgrims can make informed decisions about water 
planning, which is critical for their safety and comfort on the journey. Key 
user-story touchpoints include pilgrims assessing water source trustworthiness, 
understanding seasonal variations, administrators accurately classifying water 
source reliability, and the UI displaying clear reliability indicators. 2\. 
Schema | column | data_type | constraints | description | | `id` | `INTEGER` | 
Primary Key (Generated as identity always) | Unique identifier for the water 
reliability type. | | `code` | `TEXT` | Unique, Not Null, CHECK (length(`code`) 
> 0 AND length(`code`) &lt;= 50 AND `code` ~ '^[a-z0-9_]+$') | Short, stable, 
machine-readable code (e.g., 'year_round_reliable', 'seasonal_check_locally'). 
Snake_case. | | `label` | `TEXT` | Not Null, CHECK (length(`label`) > 0 AND 
length(`label`) &lt;= 100) | Human-readable label for UI display (e.g., 
"Year-round Reliable"). Primary reference language (English) text. 
(Translatable via `public.translations`). | | `description` | `TEXT` | Nullable 
| Optional description providing more detail or advice for this reliability 
level. Primary reference language (English) text. (Translatable via 
`public.translations`). | | `icon_identifier` | `TEXT` | Nullable, CHECK 
(`icon_identifier` IS NULL OR length(`icon_identifier`) &lt;= 100) | Name, 
class, or path for a UI icon (e.g., a green check for reliable, a yellow 
warning for seasonal). | | `advisory_level` | `SMALLINT` | Not Null, Default 
`0`, CHECK (`advisory_level` >= 0 AND `advisory_level` &lt;= 2) | Numeric level 
indicating caution: 0=Good/Reliable, 1=Caution/Check Locally, 
2=Unreliable/Warning. For UI styling or sorting. | | `sort_order` | `INTEGER` | 
Not Null, Default `0` | Determines the display order in UI lists or filters 
(e.g., most reliable first). | | `is_active` | `BOOLEAN` | Not Null, Default 
`true` | True if the type is active and available for use; false if retired. | 
| `created_at` | `TIMESTAMPTZ` | Not Null, Default `now()` | Timestamp of 
record creation. | | `updated_at` | `TIMESTAMPTZ` | Not Null, Default `now()` | 
Timestamp of last update (auto-updated by trigger). | | `created_by_profile_id` 
| `UUID` | Nullable, Foreign Key to `public.profiles(id)` ON DELETE SET NULL | 
Profile ID of the user who created the record. | | `updated_by_profile_id` | 
`UUID` | Nullable, Foreign Key to `public.profiles(id)` ON DELETE SET NULL | 
Profile ID of the user who last updated the record. | 3\. PostgreSQL DDL SQL 
``` -- Ensure prerequisite tables are created first: -- public.profiles (UUID 
id PK, roles TEXT[]) -- public.translations (for i18n) CREATE TABLE 
public.water_reliability_types_master ( id INTEGER GENERATED ALWAYS AS IDENTITY 
PRIMARY KEY, code TEXT UNIQUE NOT NULL CHECK (length(code) > 0 AND length(code) 
<= 50 AND code ~ '^[a-z0-9_]+$'), label TEXT NOT NULL CHECK (length(label) > 0 
AND length(label) <= 100), description TEXT NULL, icon_identifier TEXT NULL 
CHECK (icon_identifier IS NULL OR length(icon_identifier) <= 100), 
advisory_level SMALLINT NOT NULL DEFAULT 0 CHECK (advisory_level >= 0 AND 
advisory_level <= 2), -- 0=Good, 1=Caution, 2=Warning [cite: 550, 551] 
sort_order INTEGER NOT NULL DEFAULT 0, is_active BOOLEAN NOT NULL DEFAULT true, 
created_at TIMESTAMPTZ NOT NULL DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL 
DEFAULT now(), created_by_profile_id UUID NULL REFERENCES public.profiles(id) 
ON DELETE SET NULL, updated_by_profile_id UUID NULL REFERENCES 
public.profiles(id) ON DELETE SET NULL ); COMMENT ON TABLE 
public.water_reliability_types_master IS 'Master list of reliability levels for 
natural/public water sources. `label` and `description` are translatable. 
Version 1.2.1'; COMMENT ON COLUMN public.water_reliability_types_master.id IS 
'Unique identifier for the water reliability type.'; COMMENT ON COLUMN 
public.water_reliability_types_master.code IS 'Short, stable, machine-readable 
code (snake_case). Max 50 chars. E.g., ''year_round_reliable''.'; COMMENT ON 
COLUMN public.water_reliability_types_master.label IS 'Human-readable label for 
UI display. Primary reference language (English) text. (Translatable via 
public.translations). Max 100 chars.'; COMMENT ON COLUMN 
public.water_reliability_types_master.description IS 'Optional 
description/advice for this reliability level. Primary reference language 
(English) text. (Translatable via public.translations).'; COMMENT ON COLUMN 
public.water_reliability_types_master.icon_identifier IS 'Name, class, or path 
for a UI icon. Max 100 chars.'; COMMENT ON COLUMN 
public.water_reliability_types_master.advisory_level IS 'Numeric level 
indicating caution: 0=Good/Reliable, 1=Caution/Check Locally, 
2=Unreliable/Warning. For UI styling/sorting.'; COMMENT ON COLUMN 
public.water_reliability_types_master.sort_order IS 'Determines the display 
order in UI lists or filters.'; COMMENT ON COLUMN 
public.water_reliability_types_master.is_active IS 'True if the type is active 
and available for use; false if retired. Defaults to true.'; COMMENT ON COLUMN 
public.water_reliability_types_master.created_at IS 'Timestamp of record 
creation.'; COMMENT ON COLUMN public.water_reliability_types_master.updated_at 
IS 'Timestamp of last update (auto-updated by trigger).'; COMMENT ON COLUMN 
public.water_reliability_types_master.created_by_profile_id IS 'Profile ID of 
the user who created the record. FK to profiles.id.'; COMMENT ON COLUMN 
public.water_reliability_types_master.updated_by_profile_id IS 'Profile ID of 
the user who last updated the record. FK to profiles.id.'; -- Triggers & 
Functions CREATE TRIGGER trigger_water_reliability_types_master_set_updated_at 
BEFORE UPDATE ON public.water_reliability_types_master FOR EACH ROW EXECUTE 
FUNCTION public.set_current_timestamp_updated_at(); COMMENT ON TRIGGER 
trigger_water_reliability_types_master_set_updated_at ON 
public.water_reliability_types_master IS 'Trigger to automatically update 
updated_at timestamp on row modification.'; CREATE OR REPLACE FUNCTION 
public.cleanup_water_reliability_type_translations() RETURNS TRIGGER AS $$ 
BEGIN DELETE FROM public.translations WHERE table_identifier = 
'water_reliability_types_master' AND row_foreign_key = OLD.id::TEXT; RETURN 
OLD; END; $$ LANGUAGE plpgsql SECURITY DEFINER; CREATE TRIGGER 
trigger_cleanup_water_reliability_type_translations AFTER DELETE ON 
public.water_reliability_types_master FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_water_reliability_type_translations(); COMMENT ON TRIGGER 
trigger_cleanup_water_reliability_type_translations ON 
public.water_reliability_types_master IS 'Cleans up orphaned translations from 
public.translations when a water_reliability_types_master record is deleted.'; 
-- Indexes CREATE INDEX IF NOT EXISTS idx_wrtm_is_active ON 
public.water_reliability_types_master(is_active); CREATE INDEX IF NOT EXISTS 
idx_wrtm_sort_order ON public.water_reliability_types_master(sort_order); 
CREATE INDEX IF NOT EXISTS idx_wrtm_advisory_level ON 
public.water_reliability_types_master(advisory_level); CREATE INDEX IF NOT 
EXISTS idx_wrtm_created_by ON 
public.water_reliability_types_master(created_by_profile_id) WHERE 
created_by_profile_id IS NOT NULL; CREATE INDEX IF NOT EXISTS 
idx_wrtm_updated_by ON 
public.water_reliability_types_master(updated_by_profile_id) WHERE 
updated_by_profile_id IS NOT NULL; -- RLS Policies ALTER TABLE 
public.water_reliability_types_master ENABLE ROW LEVEL SECURITY; CREATE POLICY 
"Allow public read access to active water reliability types" ON 
public.water_reliability_types_master FOR SELECT USING (is_active = true); 
CREATE POLICY "Allow platform_admins to manage water reliability types" ON 
public.water_reliability_types_master FOR ALL USING ( (SELECT 
public.has_role_on_profile(auth.uid(), 'platform_admin')) ) WITH CHECK ( 
(SELECT public.has_role_on_profile(auth.uid(), 'platform_admin')) ); ``` 4\. 
JSON Schema Mirror (Reflects the schema table in Section 2) JSON ``` { "title": 
"water_reliability_type_master", "description": "Master list of reliability 
levels for natural/public water sources. `label` and `description` are 
translatable. Version 1.2.1", "type": "object", "properties": { "id": { "type": 
"integer", "description": "Unique identifier for the water reliability type. 
Primary Key.", "readOnly": true }, "code": { "type": "string", "description": 
"Short, stable, machine-readable code (snake_case). Max 50 chars. E.g., 
'year_round_reliable'.", "pattern": "^[a-z0-9_]+$", "maxLength": 50 }, "label": 
{ "type": "string", "description": "Human-readable label for UI display. 
Primary reference language (English) text. (Translatable via 
public.translations). Max 100 chars.", "maxLength": 100 }, "description": { 
"type": ["string", "null"], "description": "Optional description/advice for 
this reliability level. Primary reference language (English) text. 
(Translatable via public.translations)." }, "icon_identifier": { "type": 
["string", "null"], "maxLength": 100, "description": "Name, class, or path for 
a UI icon (e.g., a green check for reliable)." }, "advisory_level": { "type": 
"integer", "format": "int16", "default": 0, "minimum": 0, "maximum": 2, 
"description": "Numeric level indicating caution: 0=Good/Reliable, 
1=Caution/Check Locally, 2=Unreliable/Warning. For UI styling or sorting." }, 
"sort_order": { "type": "integer", "default": 0, "description": "Determines the 
display order in UI lists or filters (e.g., most reliable first)." }, 
"is_active": { "type": "boolean", "default": true, "description": "True if the 
type is active and available for use; false if retired." }, "created_at": { 
"type": "string", "format": "date-time", "description": "Timestamp of record 
creation.", "readOnly": true }, "updated_at": { "type": "string", "format": 
"date-time", "description": "Timestamp of last update (auto-updated by 
trigger).", "readOnly": true }, "created_by_profile_id": { "type": ["string", 
"null"], "format": "uuid", "description": "Profile ID of the user who created 
the record." }, "updated_by_profile_id": { "type": ["string", "null"], 
"format": "uuid", "description": "Profile ID of the user who last updated the 
record." } }, "required": [ "code", "label", "advisory_level", "sort_order", 
"is_active", "created_at", "updated_at" ] } ``` 5\. Relationships & Integrity - 
Primary Key: `id` (`INTEGER`). - Unique Constraint: `code` must be unique and 
follow the defined pattern. - Foreign Key References FROM other tables: 
`food_water_sources_details.water_reliability_id` references 
`water_reliability_types_master.id` (ON DELETE SET NULL). The 
`food_water_sources_details` table includes a trigger to ensure the referenced 
`water_reliability_types_master` record has `is_active = true`. - Foreign Key 
References TO other tables: - `created_by_profile_id` REFERENCES 
`public.profiles(id)` ON DELETE SET NULL. - `updated_by_profile_id` REFERENCES 
`public.profiles(id)` ON DELETE SET NULL. 6\. Multilingual Strategy - 
Translatable Fields: `label` and `description`. These columns store their 
content in the primary reference language (English). They are designated as 
translatable via the central `public.translations` table, where translations 
into other languages are stored. - Non-Translatable Fields: `code` is a stable 
system identifier and is not translated. `advisory_level`, `sort_order`, and 
`is_active` are structural/flag fields and not translatable text. 
`icon_identifier` is a system value. - Orphan Cleanup: An `AFTER DELETE` 
trigger (`trigger_cleanup_water_reliability_type_translations`) is implemented. 
It calls `public.cleanup_water_reliability_type_translations` to remove any 
orphaned entries from `public.translations` when a 
`water_reliability_types_master` record is deleted, ensuring data consistency. 
7\. Role-Based Workflow & RLS Notes - Content Management: This master table is 
typically managed by `platform_admin` users who define and maintain the 
canonical list of water reliability classifications for the entire platform. - 
Lifecycle: Reliability types are "retired" by setting their `is_active` flag to 
`false`. Physical deletion of a record will set the foreign key in 
`food_water_sources_details.water_reliability_id` to `NULL` if any food/water 
source detail entry is actively using that type. The "active check" trigger on 
`food_water_sources_details` also prevents linking to inactive types. - RLS 
Policies: - Row-Level Security is enabled. - Public Users (`SELECT`): Can read 
all `water_reliability_types_master` records where `is_active = true`. - 
Authenticated Users (`platform_admin` role via `public.has_role_on_profile` 
helper): Have `ALL` permissions (INSERT, SELECT, UPDATE, DELETE) to manage 
these types. 8\. ENUM vs Lookup Discussion - Decision: This 
`water_reliability_types_master` table correctly promotes an original 
`water_reliability_enum` concept into a full V2-compliant lookup table. - 
Reasoning: This classification is critical for pilgrim safety. A lookup table 
allows for richer, translatable `label` and `description` fields (important for 
conveying nuances like "check locally"), association of distinct 
`icon_identifier` values, an `advisory_level` for programmatic UI styling 
(e.g., color-coding reliability), an `is_active` flag for lifecycle management, 
`sort_order` for consistent presentation, and standard audit columns. This 
provides significantly more flexibility and control than a hardcoded ENUM. 9\. 
UI/UX Enablement - `label` (translated): Used for clearly displaying the 
reliability status of a water source to users. - `description` (translated): 
Can be used for tooltips or expanded information sections in the UI to help 
pilgrims understand the implications and any necessary precautions for a given 
reliability status (e.g., advice to boil or filter water if status is "seasonal 
- check locally"). - `icon_identifier`: Drives the display of map icons or list 
icons to visually communicate water reliability at a glance (e.g., a green 
check for reliable, a yellow warning icon for seasonal, a red cross for not 
potable). - `advisory_level`: Allows the UI to programmatically apply styling, 
such as color-coding (e.g., green, yellow, red based on levels 0, 1, 2) or 
other visual cues to rank or emphasize reliability levels. - `sort_order`: 
Ensures that reliability types are presented in a logical and consistent order 
in UI elements like filter dropdowns or legends, typically from most reliable 
to least reliable. - `is_active`: The UI should primarily present and allow 
filtering/selection based on active reliability types. 10\. Key Considerations 
& Definitions - Actionable Advice: The `label` and `description` fields (and 
their translations) should aim to provide clear, unambiguous, and actionable 
advice to pilgrims regarding water safety and planning (e.g., "Boil or filter 
if 'check locally'"). - Iconography: Consistent and intuitive icons for each 
`icon_identifier` are key for quick visual assessment by pilgrims on maps or 
lists. The meaning of each icon should be clear and possibly explained in a 
legend. - `unknown_reliability` Type: The inclusion of a type like 
'unknown_reliability' in the seed data is important as a default or fallback if 
the reliability information for a specific water source is missing or has not 
yet been verified. This helps manage data completeness and user expectations. - 
Seed Data Accuracy: The initial seed data must accurately reflect the intended 
meaning and advisory level for each reliability code. These definitions 
directly impact pilgrim safety. 11\. Scalability & Future-Proofing - Manageable 
List: The number of distinct water reliability types will be small and 
relatively stable, ensuring the table remains easy to manage and queries 
against it are performant. - Flexibility: The lookup table structure makes it 
easy to add more descriptive fields, refine advice, or even add new reliability 
categories in the future if needed, without requiring schema changes to other 
dependent tables like `food_water_sources_details`. - Audit Fields & Lifecycle: 
Full audit columns and the `is_active` flag provide a robust mechanism for 
tracking changes and managing the lifecycle of these reliability 
classifications. 12\. Next-Action Checklist - ðŸ”´ Verify Prerequisite Tables: 
Confirm `public.profiles` and `public.translations` tables are V2 compliant and 
exist. - ðŸ”´ Implement `water_reliability_types_master` Table: Execute the DDL 
for Version 1.2.1 as specified, ensuring RLS policies use the correct role 
names (e.g., `platform_admin`). - ðŸ”´ Apply Triggers: Ensure the 
`set_current_timestamp_updated_at` trigger (using a standard helper function) 
and the `trigger_cleanup_water_reliability_type_translations` are created and 
correctly applied to the table. - ðŸ”´ Initial Population / Seed Data: Insert the 
defined reliability types using the provided seed data examples. For each seed 
record, ensure `is_active` is set to `true` and `created_by_profile_id` is 
populated with a designated system administrator's profile ID. - ðŸŸ  RLS Helper 
Functions: Ensure that helper functions like 
`public.has_role_on_profile(auth.uid(), 'role_name')` are defined, secure, and 
used consistently in RLS policies. - ðŸŸ  RLS Policies: Implement and thoroughly 
test the RLS policies defined for this table. - ðŸŸ¢ Icon Design and 
Coordination: Develop or source appropriate icons for each `icon_identifier` 
defined in the seed data and coordinate these with the UI/UX team for 
consistent implementation and understanding. - ðŸŸ¢ Translation Entries: Prepare 
initial English entries for all translatable fields (`label`, `description`) in 
the `public.translations` table, ensuring they are correctly linked by 
`table_identifier` ('water_reliability_types_master'), `column_identifier` 
('label' or 'description'), and `row_foreign_key` (the `id` of the master 
record). 
