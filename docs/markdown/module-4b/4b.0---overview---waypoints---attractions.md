# 4b.0 - overview - waypoints - attractions

  https://gemini.google.com/u/1/app/ae9db5f1ec568e1b 
https://gemini.google.com/u/1/app/d423d51e9f40da78 
https://gemini.google.com/u/1/app/3ccfcacc8925c6f9 Okay, here is the updated 
overview document for "Module 4b: Waypoint Details (Attractions, Food/Water, 
Shops/Services)," reflecting the finalized specifications and discussions. * * 
* * * Updated Module Overview: 4b. Waypoint Details (Attractions, Food/Water, 
Shops/Services) Version: 1.1 (Reflecting finalized V2 table/view 
specifications, trigger strategies, and RLS alignment) Date: May 18, 2025 ### 
1\. Executive Summary This database module, "Waypoint Details (4b)," 
significantly enriches core `public.waypoints` data by providing detailed, 
structured information for various points of interest crucial to pilgrims. It 
allows for the storage and retrieval of specific, translatable attributes for 
attractions (including religious services through 
`public.religious_service_schedules`), food and water sources 
(`public.food_water_sources_details`), and general shops/services 
(`public.shops_and_services_details`). Key V2 enhancements include standardized 
master tables (e.g., `public.attraction_types_master`, 
`public.food_water_source_types_master`) with lifecycle management (`is_active` 
flag), robust audit trails, comprehensive "active check" triggers for foreign 
key integrity to master tables, dedicated `*_media` linking tables for 
galleries, and newly defined localized views 
(`public.v_waypoint_attraction_details_localized`, 
`public.v_waypoint_food_water_source_details_localized`, 
`public.v_waypoint_shop_service_details_localized`) to support efficient API 
data retrieval. The primary business goals unlocked are enhanced POI discovery, 
better logistical planning for pilgrims, and efficient, consistent content 
management for administrators. ### 2\. Group-Level Snapshot | Group | Key 
Tables & Views | Primary Purpose | Top Inter-Group Links | | 4b. Waypoint 
Details (Attractions, Food/Water, Shops/Services) | Detail Tables: 
`public.attractions_details` (V1.3.1), `public.religious_service_schedules` 
(V1.3.1), `public.food_water_sources_details` (V1.3.1), 
`public.shops_and_services_details` (V1.3.1).&lt;br>Master Tables: Numerous 
`*_master` tables (e.g., `public.attraction_types_master` (V1.1), 
`public.visitor_amenities_master` (V1.1), 
`public.religious_service_types_master` (V1.1), 
`public.food_water_source_types_master` (V1.2.1), 
`public.water_reliability_types_master` (V1.2.1), 
`public.shop_service_types_master` (V1.2), `public.payment_methods_master` 
(V1.1), `public.establishment_price_ranges_master` (V1.1), 
`public.meal_type_tags_master` (V1.1), `public.dietary_option_tags_master` 
(V1.1) ).&lt;br>Media Linking Tables: `public.attraction_details_media` (V1.0), 
`public.food_water_source_media` (V1.0), `public.shop_service_media` 
(V1.0).&lt;br>Localized Views: `public.v_waypoint_attraction_details_localized` 
(V1.0), `public.v_waypoint_food_water_source_details_localized` (V1.0), 
`public.v_waypoint_shop_service_details_localized` (V1.0). | To store detailed, 
translatable, and queryable information specific to waypoints that are 
attractions, religious sites, food/water sources, or practical shops/services. 
The localized views provide denormalized, localized, and aggregated data for 
efficient API consumption. | Directly extends `public.waypoints` (1:1 via 
`waypoint_id`). Links to `public.profiles` for audit columns. Relies on 
`public.translations` and `public.languages_master` for internationalization. 
Links to `public.media` via specific `*_media` tables and 
`public.media_roles_master`. Deletion of a `waypoints` record cascades to the 
corresponding detail record (except `shops_and_services_details` which has its 
own soft delete). | ### 3\. Narrative Walkthrough This group adds layers of 
specific, rich information to generic waypoints, transforming them into 
detailed entities such as cultural attractions with opening hours and media 
galleries, churches with specific service times, reliable water fountains with 
access notes, or local pharmacies with contact details. - Core Concept: Each 
primary detail table (`public.attractions_details`, 
`public.food_water_sources_details`, `public.shops_and_services_details`) acts 
as a 1:1 extension of a record in the `public.waypoints` table, identified by 
`waypoint_id` (which is both PK and FK). Deletion of a `public.waypoints` 
record generally cascades to delete the corresponding detail record, though 
`public.shops_and_services_details` also features its own `deleted_at` field 
for independent soft deletion. The `public.religious_service_schedules` table 
is a child of `public.attractions_details` (1:M relationship), linking via 
`attraction_waypoint_id`. - Master Tables: Numerous `*_master` tables define 
controlled vocabularies for types, amenities, and other classifications. These 
tables consistently include a `code` (machine-readable identifier), `label` 
(primary reference language: English, translatable), an optional `description` 
(primary reference language: English, translatable), `icon_identifier`, 
`sort_order`, an `is_active` flag for lifecycle management, and full V2 audit 
columns (`created_at`, `updated_at`, `created_by_profile_id`, 
`updated_by_profile_id`). They also feature standard `updated_at` and orphan 
translation cleanup triggers. - Detail Table Roles: - 
`public.attractions_details` (V1.3.1): Stores rich information for attractions. 
It uses `attraction_type_id` (FK to `public.attraction_types_master`) and 
`visitor_amenity_ids` (array of FKs to `public.visitor_amenities_master`). 
Includes fields like `detailed_description` (primary language: English, 
translatable) and `opening_hours_structured` (JSONB). - 
`public.religious_service_schedules` (V1.3.1): Stores schedules for services at 
religious sites, linked to `public.attractions_details`. Uses `service_type_id` 
(FK to `public.religious_service_types_master`) and `language_code` (FK to 
`public.languages_master`). Translatable fields like 
`schedule_description_text` store English as the primary reference. - 
`public.food_water_sources_details` (V1.3.1): Stores details for food 
establishments or water sources. Uses various FKs to specific master tables 
like `public.food_water_source_types_master`, 
`public.water_reliability_types_master`, 
`public.establishment_price_ranges_master`, and array FKs to 
`public.meal_type_tags_master`, `public.dietary_option_tags_master`, 
`public.payment_methods_master`. - `public.shops_and_services_details` 
(V1.3.1): Stores operational details for shops and services. Uses 
`service_type_id` (FK to `public.shop_service_types_master`), array FKs to 
`public.payment_methods_master` and `public.languages_master` (for 
`languages_spoken_codes`), and an FK to 
`public.establishment_price_ranges_master`. It includes a `deleted_at` field 
for independent soft deletion. - Media Linking: Each main detail table 
(`attractions_details`, `food_water_sources_details`, 
`shops_and_services_details`) has a corresponding `*_media` linking table 
(e.g., `public.attraction_details_media`, `public.food_water_source_media`, 
`public.shop_service_media`). These tables associate multiple media items (from 
`public.media`) with specific semantic roles (via 
`public.media_roles_master.code`). They include `display_order`, translatable 
`caption_override` and `alt_text_override` fields (storing primary English 
reference text directly), and full audit columns. - Localized Views: New views 
(`public.v_waypoint_attraction_details_localized`, 
`public.v_waypoint_food_water_source_details_localized`, 
`public.v_waypoint_shop_service_details_localized`) have been specified. These 
views provide pre-joined, denormalized, and structured data, including primary 
language fields and aggregated `all_translations` JSONB objects from related 
tables, to efficiently support API data retrieval and simplify backend logic. 
### 4\. Cross-Cutting Concerns - Users & Roles: - Full audit columns 
(`created_at`, `updated_at`, `created_by_profile_id`, `updated_by_profile_id`) 
are standard in all detail, master, and media linking tables in this module, 
referencing `public.profiles(id)`. `ON DELETE SET NULL` is used for these audit 
FKs. - Content visibility is primarily controlled by the parent 
`public.waypoints.content_visibility_status_id` and 
`public.waypoints.deleted_at` status, which RLS policies on these detail tables 
reference. `public.shops_and_services_details` also has its own `deleted_at` 
field for finer-grained lifecycle control. - Translations / i18n: - A central 
`public.translations` table (Version 2.1 spec) is used. - All designated text 
fields in detail tables (e.g., `attractions_details.detailed_description`), 
master tables (`label`, `description`), and media linking tables 
(`caption_override`, `alt_text_override`) store their primary reference 
language (English) content directly in the column (no `_en` suffix). These 
fields are then translated via `public.translations`. - Orphaned translation 
cleanup triggers (`AFTER DELETE`) are implemented on all tables with 
translatable content to maintain data integrity in `public.translations`. - The 
API layer will use the primary language fields and the aggregated translation 
data (prepared by the localized views) to serve localized responses, typically 
with a main field in the requested/primary language and a `translations` object 
for other languages. - ENUM & Taxonomy Registry: - `public.weekday_enum` is 
used for `religious_service_schedules.days_of_week`. - All other previous ENUM 
concepts pertinent to this module (e.g., `attraction_type_enum`) have been 
promoted to full V2-compliant `*_master` lookup tables. These master tables 
feature `is_active` flags, audit columns, translatable labels/descriptions, 
icons, and sort order. - Media & Files: - Media files are referenced via 
`public.media(id)`. The new `*_media` linking tables connect detail records to 
`public.media` and use `public.media_roles_master(code)` to define semantic 
roles. These linking tables include `display_order` and translatable overrides 
for captions/alt text. - `icon_identifier` fields in master tables store text 
hints for UI icons. - Audit / Soft-Delete / Versioning: - Audit: All tables in 
this module group now include the four standard audit columns. `updated_at` is 
auto-managed. - Data Verification Timestamps: Fields like 
`opening_hours_last_verified_at` and `data_last_verified_at` are retained in 
detail tables for tracking content freshness. - Soft Deletion: 
`public.shops_and_services_details` has its own `deleted_at` field. Other 
detail tables in this group (`attractions_details`, 
`food_water_sources_details`, and by extension `religious_service_schedules`) 
rely on the parent `public.waypoints.deleted_at` status, with `ON DELETE 
CASCADE` on their `waypoint_id` FK. All master tables use an `is_active BOOLEAN 
NOT NULL DEFAULT true` flag for lifecycle management. - Versioning: Table 
specifications are versioned. Full content versioning is a post-V2 
consideration. - Triggers for Data Integrity: - Standard `updated_at` triggers 
are applied. - Orphaned translation cleanup triggers (`AFTER DELETE`) exist on 
all tables with translatable fields. - Crucially, `BEFORE INSERT OR UPDATE` 
triggers are implemented on all Foreign Keys (both single and array elements) 
from detail tables to their respective master tables. These triggers ensure 
that the referenced master record exists and its `is_active` flag (or 
equivalent, like `languages_master.is_active_for_platform`) is `true`. This is 
vital for preventing links to retired master data. - Array Foreign Keys (e.g., 
`visitor_amenity_ids`, `serves_meal_type_tag_ids`) have dedicated database 
triggers to enforce referential integrity and the `is_active` status of each 
element against their master tables. ### 5\. Security & Access Control üîê - RLS 
Overview: Row-Level Security (RLS) is enabled on all detail tables, their media 
linking tables, and all master tables within this module. - Master Tables RLS: 
Public users generally have `SELECT` access only to records where `is_active = 
true`. `platform_admin` users have full `ALL` permissions, typically enforced 
via a helper function like `public.has_role_on_profile(auth.uid(), 
'platform_admin')`. - Detail Tables & Media Linking Tables RLS: Public user 
`SELECT` access is contingent on: 1. The parent `public.waypoints` record being 
published (checked via `waypoints.content_visibility_status_id` joining to 
`public.content_statuses_master.is_publicly_visible = TRUE`). 2. The parent 
`public.waypoints` record not being soft-deleted (`waypoints.deleted_at IS 
NULL`). 3. For `public.shops_and_services_details`, its own 
`shops_and_services_details.deleted_at IS NULL` is also checked. - Privileged 
Access: Roles such as `platform_admin` and `regional_content_manager` have 
broader access (`ALL` permissions for CRUD operations), identified using 
`public.has_role_on_profile(auth.uid(), 'role_name')`. `WITH CHECK` conditions 
often prevent non-`platform_admin` users from re-parenting `waypoint_id` during 
updates. - RLS Helper Functions: The security model relies on centrally defined 
RLS helper functions (expected in Module 1, e.g., 
`public.has_role_on_profile(UUID, TEXT)`) which query `public.profiles.roles` 
using `auth.uid()`. ### 6\. Prerequisite Objects & Build Order ‚öôÔ∏è - Assumed 
Pre-existing Core Objects (from other Modules/Global): - `public.waypoints` (V2 
compliant, with `name`, `slug`, `content_visibility_status_id`, `deleted_at`). 
- `public.profiles` (V2.3 compliant, with `roles TEXT[]`, `full_name`). - 
`public.languages_master` (V2.1 compliant, with `is_active_for_platform`). - 
`public.translations` (V2.1 compliant). - `public.media` (V2.2 compliant). - 
`public.media_roles_master`. - `public.content_statuses_master` (with 
`is_publicly_visible`). - Standard shared SQL functions: 
`public.set_current_timestamp_updated_at()`, 
`public.cleanup_related_translations()` (and specific wrappers like 
`public.cleanup_attraction_types_master_translations()`), RLS helpers like 
`public.has_role_on_profile()`. - `public.weekday_enum`. - Execution Order 
within Module 4b: 1. Master Tables: All `*_master` tables for this module 
(e.g., `public.attraction_types_master` V1.1, `public.visitor_amenities_master` 
V1.1, `public.religious_service_types_master` V1.1, 
`public.food_water_source_types_master` V1.2.1, 
`public.water_reliability_types_master` V1.2.1, 
`public.shop_service_types_master` V1.2, `public.payment_methods_master` V1.1, 
`public.establishment_price_ranges_master` V1.1, `public.meal_type_tags_master` 
V1.1, `public.dietary_option_tags_master` V1.1). Apply their individual 
triggers for `updated_at` and translation cleanup. 2. Detail Tables: 
`public.attractions_details` (V1.3.1), `public.food_water_sources_details` 
(V1.3.1), `public.shops_and_services_details` (V1.3.1). Apply their 
`updated_at` and translation cleanup triggers, and all FK "active check" and 
array FK integrity triggers. 3. Child Detail Table: 
`public.religious_service_schedules` (V1.3.1) (after `attractions_details`). 
Apply its triggers. 4. Media Linking Tables: `public.attraction_details_media` 
(V1.0), `public.food_water_source_media` (V1.0), `public.shop_service_media` 
(V1.0) (after their respective parent detail tables). Apply their triggers. 5. 
Localized Views: `public.v_waypoint_attraction_details_localized` (V1.0), 
`public.v_waypoint_food_water_source_details_localized` (V1.0), 
`public.v_waypoint_shop_service_details_localized` (V1.0) (after all underlying 
tables and their triggers are in place). 6. RLS Policies: Apply all RLS 
policies to all tables once triggers and views are stable. ### 7\. Performance 
& Optimization Extras - Key Indexes: - All Primary Keys are automatically 
indexed. - All Foreign Keys in detail and linking tables are indexed. - GIN 
indexes are used for JSONB fields (e.g., `opening_hours_structured`) and array 
foreign key columns (`visitor_amenity_ids`, `serves_meal_type_tag_ids`, etc.) 
in detail tables. - Master tables have indexes on `code` (unique), `is_active`, 
and `sort_order`. - `public.translations` needs efficient indexing on 
`(table_identifier, row_foreign_key, language_code, column_identifier)` (e.g., 
`idx_translations_lookup`). - Localized Views for API Performance: The defined 
localized views (`v_waypoint_*_localized`) are critical for API performance for 
read operations by pre-joining data and aggregating translations. These views 
encapsulate much of the data-shaping complexity. - Materialized Views 
Consideration: If read performance of the localized views becomes a bottleneck, 
they are strong candidates for conversion to Materialized Views. This would 
require defining an appropriate refresh strategy (e.g., nightly, or on commit 
if feasible for specific triggers). - No Denormalized Labels in Detail Tables: 
The design decision to avoid denormalizing primary language labels (e.g., no 
`attraction_type_label_en` in `attractions_details`) means views are essential 
for retrieving these labels efficiently alongside detail data. ### 8\. Visuals 
An ERD for Module 4b would show: - `public.waypoints` as the central parent. - 
`public.attractions_details`, `public.food_water_sources_details`, 
`public.shops_and_services_details` as 1:1 extensions. - 
`public.religious_service_schedules` as a child of 
`public.attractions_details`. - Each detail table linking to multiple 
`*_master` tables. - Each detail table linking to its `*_media` table, which in 
turn links to `public.media` and `public.media_roles_master`. - All tables 
linking to `public.profiles` for audit columns and `public.translations` for 
translatable content. *(A new visual ERD is not generated here but can be 
inferred from the detailed table specifications and relationships described).* 
### 9\. Data & Workflow Flowchart - Data Creation/Update (Admin/Content 
Manager): 1. Admin/Manager identifies a waypoint needing specific details. 2. A 
new record is created in the relevant detail table (e.g., 
`attractions_details`) linking to `waypoint_id`. The `created_by_profile_id` is 
set. 3. Input data is validated by `NOT NULL`, length checks, data type checks, 
and `CHECK` constraints. 4. Foreign Keys to master tables are selected (e.g., 
`attraction_type_id`). 5. Triggers Fire: - "Active check" triggers ensure 
referenced master records are `is_active = true`. - Array FK integrity triggers 
validate each element in tag ID arrays (existence and `is_active` status in 
master table). - `updated_at` timestamp is automatically set/updated. 6. 
Translatable text (e.g., `detailed_description`) is entered in the primary 
reference language (English) directly into the field. Other language versions 
are managed via `public.translations`. 7. Media is linked via the respective 
`*_media` tables, including roles and optional caption/alt-text overrides (in 
English). - Publishing: Visibility of these details is primarily controlled by 
the parent `public.waypoints.content_visibility_status_id` and 
`public.waypoints.deleted_at` fields. `public.shops_and_services_details` also 
considers its own `deleted_at` field. - End-User Consumption (Pilgrim via API & 
Views): 1. Frontend UI queries an API endpoint (e.g., 
`/waypoints/{id}/attraction_details?lang=it`). 2. The API backend queries the 
corresponding localized view (e.g., `SELECT * FROM 
public.v_waypoint_attraction_details_localized WHERE waypoint_id = {id};`). 3. 
The view returns a comprehensive JSON-like structure with all necessary 
details: - Fields from the detail table (primary language text). - Joined data 
from master tables (codes, icons, primary language labels). - An 
`all_translations` JSONB object for each translatable scope (main detail, 
related master items, media captions/alt-texts). 4. The API backend then 
constructs the final JSON response. It uses the primary language field from the 
view for the main API field (e.g., `detailed_description`). It populates the 
corresponding `translations` object in the API response from the view's 
`all_translations` object. If a `lang` parameter is provided in the API 
request, the backend *may* choose to place the requested language text directly 
into the main API field if that translation is available, still providing other 
translations in the `translations` object. 5. RLS on the view (inherited from 
base tables) ensures only data permissible to the user is returned. ### 10\. 
Critical Gaps & Risks (Post-V2 Updates for Module 4b) - üî¥ Implementation of 
Core Module 1 Components: The RLS policies and audit trails in Module 4b 
critically depend on a fully V2-compliant `public.profiles` table (with `roles 
TEXT[]`) and securely implemented RLS helper functions (e.g., 
`public.has_role_on_profile()`). The `public.handle_new_user()` trigger must 
correctly populate `public.profiles.roles`. - *Risk*: If these Module 1 
components are incorrectly implemented, RLS for Module 4b will be insecure or 
non-functional. - üî¥ Thorough Testing of All Triggers: The various "active 
check" triggers for FKs and the array FK integrity triggers are vital for 
maintaining data integrity. These need extensive testing across different 
scenarios (insert, update, valid/invalid FKs, active/inactive master records). 
- *Risk*: Incorrect trigger logic could lead to data corruption, prevent valid 
data entry, or allow inconsistent states. - üü† Performance of Localized Views: 
The defined localized views are inherently complex due to multiple joins and 
aggregations. Their performance under load, especially with a large 
`public.translations` table, needs to be benchmarked. - *Risk*: Slow API 
response times if views are inefficient. Conversion to Materialized Views might 
be necessary. - üü† JSON Schema for `opening_hours_structured`: Consistent data 
entry by content managers and reliable parsing by the application for display 
depend on a well-defined, formally documented, and strictly adhered-to JSON 
schema for this field. - *Risk*: Inconsistent or invalid JSON data in 
`opening_hours_structured` will break parsing and UI display features (e.g., 
"Open Now?" indicators). - üü¢ Seed Data for All Master Tables: Comprehensive, 
accurate, and appropriately translated (for primary language 
labels/descriptions) initial seed data for all `*_master` tables within Module 
4b is crucial for system usability at launch. This includes codes, labels, 
icons, sort orders, and correct `is_active` and audit column population. - 
*Risk*: Missing, incorrect, or untranslated master data will limit 
functionality, lead to poor user experience, and hinder content creation. ### 
11\. Scalability & Future-Proof Notes - Standardization & V2 Compliance: The 
consistent use of V2 patterns (master tables with `is_active` and full audit, 
specific integrity triggers, dedicated media linking tables, centralized 
translation, and comprehensive localized views) provides a robust, scalable, 
and maintainable foundation for Module 4b. - Flexibility: Lookup tables allow 
for easy addition or modification of new types, tags, and classifications 
without major schema changes to the detail tables. JSONB fields like 
`opening_hours_structured` offer flexibility for semi-structured data. - 
Maintainability of APIs: The localized views help decouple the API's data 
consumption from the raw underlying table structures, improving the 
maintainability of both the database and the API backend. Changes to join logic 
or minor data restructuring can often be handled within the views. ### 12\. 
Next Steps (for Module 4b) 1. Implementation: Execute all finalized DDL for 
tables (detail, master, media linking), all triggers (updated_at, translation 
cleanup, FK active checks, array FK integrity), and the localized views as 
specified in their respective documents (`4.5*.docx`, `4.6*.docx`, `4.7*.docx`, 
`4.8*.docx`, `4.9*.docx`, `4.15*.docx`, `4.16*.docx`, `4b.0.2*.docx`). 2. Seed 
Data Population: Populate all `*_master` tables with comprehensive and accurate 
initial data, including correct `is_active` status and audit columns. 3. 
Testing: - Unit test all database triggers with various valid and invalid 
scenarios. - Thoroughly test RLS policies with different user roles and 
expected data access patterns. - Benchmark the performance of the localized 
views under realistic load conditions and test data accuracy. - Test API 
endpoints that consume these views to ensure correct data shaping, translation 
handling, and error responses. 4. Documentation: - Formally document the JSON 
schema for `opening_hours_structured` and ensure it's accessible to content 
managers and developers. - Ensure Module 1 specifications for `public.profiles` 
(especially `roles` column) and RLS helper functions 
(`public.has_role_on_profile`) are finalized and implemented as Module 4b 
relies heavily on them. 5. Translation Content: Prepare and load initial 
English entries into `public.translations` for all translatable fields within 
Module 4b tables (labels, descriptions, notes, etc.). * * * * * 
