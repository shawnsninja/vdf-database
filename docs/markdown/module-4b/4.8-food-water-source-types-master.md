# 4.8 food_water_source_types_master

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/1d4834db0819faf2 
https://gemini.google.com/u/1/app/d423d51e9f40da78 ### 3\. Updated 
Production-Ready Specification (`food_water_source_types_master`) This document 
details the structure, purpose, and considerations for the 
`food_water_source_types_master` table, Version 1.2.1 (reflecting RLS role name 
alignment). This version incorporates full V2 audit columns, an `is_active` 
flag for lifecycle management, and refined indexing and translation handling. 
1\. Purpose & Primary Use-Cases The `food_water_source_types_master` table 
defines the specific types of food establishments or water sources available 
(e.g., "Public Fountain - Potable," "Restaurant," "Grocery Store"). Its purpose 
is to provide a standardized, translatable classification that drives UI 
elements (like map icons, filter options), helps users distinguish between 
commercial services and free resources, and ensures data consistency. Key uses 
include pilgrim POI identification and filtering, admin content categorization 
for food/water waypoints, and system UI display of icons and filter controls. 
2\. Schema | column | data_type | constraints | description | | `id` | 
`INTEGER` | Primary Key (Generated as identity always) | Unique identifier for 
the food/water source type. | | `code` | `TEXT` | Unique, Not Null, CHECK 
(length(`code`) > 0 AND length(`code`) &lt;= 50 AND `code` ~ '^[a-z0-9_]+$') | 
Short, stable, machine-readable code (e.g., 'public_fountain_potable', 
'restaurant'). Snake_case. | | `label` | `TEXT` | Not Null, CHECK 
(length(`label`) > 0 AND length(`label`) &lt;= 100) | Human-readable label for 
UI display. Primary reference language (English) text. (Translatable via 
`public.translations`). | | `description` | `TEXT` | Nullable | Optional 
description of the source type, providing more context. Primary reference 
language (English) text. (Translatable via `public.translations`). | | 
`icon_identifier` | `TEXT` | Nullable, CHECK (`icon_identifier` IS NULL OR 
length(`icon_identifier`) &lt;= 100) | Name, class, or path for a UI icon 
associated with this source type. | | `is_commercial` | `BOOLEAN` | Not Null, 
Default `false` | Flag to distinguish commercial establishments (e.g., 
restaurant, shop) from non-commercial ones (e.g., public fountain, natural 
spring). | | `sort_order` | `INTEGER` | Not Null, Default `0` | Determines the 
display order in UI lists or filters. Lower numbers appear first. | | 
`is_active` | `BOOLEAN` | Not Null, Default `true` | True if the type is active 
and available for use; false if retired. | | `created_at` | `TIMESTAMPTZ` | Not 
Null, Default `now()` | Timestamp of record creation. | | `updated_at` | 
`TIMESTAMPTZ` | Not Null, Default `now()` | Timestamp of last update 
(auto-updated by trigger). | | `created_by_profile_id` | `UUID` | Nullable, 
Foreign Key to `public.profiles(id)` ON DELETE SET NULL | Profile ID of the 
user who created the record. | | `updated_by_profile_id` | `UUID` | Nullable, 
Foreign Key to `public.profiles(id)` ON DELETE SET NULL | Profile ID of the 
user who last updated the record. | 3\. PostgreSQL DDL SQL ``` -- Ensure 
prerequisite tables are created first: -- public.profiles (UUID id PK, roles 
TEXT[]) -- public.translations (for i18n) CREATE TABLE 
public.food_water_source_types_master ( id INTEGER GENERATED ALWAYS AS IDENTITY 
PRIMARY KEY, code TEXT UNIQUE NOT NULL CHECK (length(code) > 0 AND length(code) 
<= 50 AND code ~ '^[a-z0-9_]+$'), label TEXT NOT NULL CHECK (length(label) > 0 
AND length(label) <= 100), description TEXT NULL, icon_identifier TEXT NULL 
CHECK (icon_identifier IS NULL OR length(icon_identifier) <= 100), 
is_commercial BOOLEAN NOT NULL DEFAULT FALSE, sort_order INTEGER NOT NULL 
DEFAULT 0, is_active BOOLEAN NOT NULL DEFAULT true, created_at TIMESTAMPTZ NOT 
NULL DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), 
created_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE SET 
NULL, updated_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE 
SET NULL ); COMMENT ON TABLE public.food_water_source_types_master IS 'Master 
list of food and water source types (e.g., public fountain, restaurant). 
`label` and `description` are translatable. Version 1.2.1'; COMMENT ON COLUMN 
public.food_water_source_types_master.id IS 'Unique identifier for the 
food/water source type.'; COMMENT ON COLUMN 
public.food_water_source_types_master.code IS 'Short, stable, machine-readable 
code (snake_case). Max 50 chars. E.g., ''public_fountain_potable''.'; COMMENT 
ON COLUMN public.food_water_source_types_master.label IS 'Human-readable label 
for UI display. Primary reference language (English) text. (Translatable via 
public.translations). Max 100 chars.'; COMMENT ON COLUMN 
public.food_water_source_types_master.description IS 'Optional description of 
the source type. Primary reference language (English) text. (Translatable via 
public.translations).'; COMMENT ON COLUMN 
public.food_water_source_types_master.icon_identifier IS 'Name, class, or path 
for a UI icon. Max 100 chars.'; COMMENT ON COLUMN 
public.food_water_source_types_master.is_commercial IS 'True for commercial 
establishments (restaurant, shop), False for public/natural sources.'; COMMENT 
ON COLUMN public.food_water_source_types_master.sort_order IS 'Determines the 
display order in UI lists or filters.'; COMMENT ON COLUMN 
public.food_water_source_types_master.is_active IS 'True if the type is active 
and available for use; false if retired. Defaults to true.'; COMMENT ON COLUMN 
public.food_water_source_types_master.created_at IS 'Timestamp of record 
creation.'; COMMENT ON COLUMN public.food_water_source_types_master.updated_at 
IS 'Timestamp of last update (auto-updated by trigger).'; COMMENT ON COLUMN 
public.food_water_source_types_master.created_by_profile_id IS 'Profile ID of 
the user who created the record. FK to profiles.id.'; COMMENT ON COLUMN 
public.food_water_source_types_master.updated_by_profile_id IS 'Profile ID of 
the user who last updated the record. FK to profiles.id.'; -- Triggers & 
Functions CREATE TRIGGER trigger_food_water_source_types_master_set_updated_at 
BEFORE UPDATE ON public.food_water_source_types_master FOR EACH ROW EXECUTE 
FUNCTION public.set_current_timestamp_updated_at(); COMMENT ON TRIGGER 
trigger_food_water_source_types_master_set_updated_at ON 
public.food_water_source_types_master IS 'Trigger to automatically update 
updated_at timestamp on row modification.'; CREATE OR REPLACE FUNCTION 
public.cleanup_food_water_source_type_translations() RETURNS TRIGGER AS $$ 
BEGIN DELETE FROM public.translations WHERE table_identifier = 
'food_water_source_types_master' AND row_foreign_key = OLD.id::TEXT; RETURN 
OLD; END; $$ LANGUAGE plpgsql SECURITY DEFINER; CREATE TRIGGER 
trigger_cleanup_food_water_source_type_translations AFTER DELETE ON 
public.food_water_source_types_master FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_food_water_source_type_translations(); COMMENT ON TRIGGER 
trigger_cleanup_food_water_source_type_translations ON 
public.food_water_source_types_master IS 'Cleans up orphaned translations from 
public.translations when a food_water_source_types_master record is deleted.'; 
-- Indexes CREATE INDEX IF NOT EXISTS idx_fwstm_is_active ON 
public.food_water_source_types_master(is_active); CREATE INDEX IF NOT EXISTS 
idx_fwstm_sort_order ON public.food_water_source_types_master(sort_order); 
CREATE INDEX IF NOT EXISTS idx_fwstm_is_commercial ON 
public.food_water_source_types_master(is_commercial); CREATE INDEX IF NOT 
EXISTS idx_fwstm_created_by ON 
public.food_water_source_types_master(created_by_profile_id) WHERE 
created_by_profile_id IS NOT NULL; CREATE INDEX IF NOT EXISTS 
idx_fwstm_updated_by ON 
public.food_water_source_types_master(updated_by_profile_id) WHERE 
updated_by_profile_id IS NOT NULL; -- RLS Policies ALTER TABLE 
public.food_water_source_types_master ENABLE ROW LEVEL SECURITY; CREATE POLICY 
"Allow public read access to active food/water source types" ON 
public.food_water_source_types_master FOR SELECT USING (is_active = true); 
CREATE POLICY "Allow platform_admins to manage food/water source types" ON 
public.food_water_source_types_master FOR ALL USING ( (SELECT 
public.has_role_on_profile(auth.uid(), 'platform_admin')) ) WITH CHECK ( 
(SELECT public.has_role_on_profile(auth.uid(), 'platform_admin')) ); ``` 4\. 
JSON Schema Mirror (Reflects the schema table in Section 2) JSON ``` { "title": 
"food_water_source_type_master", "description": "Master list of food and water 
source types (e.g., public fountain, restaurant). `label` and `description` are 
translatable. Version 1.2.1", "type": "object", "properties": { "id": { "type": 
"integer", "description": "Unique identifier for the food/water source type. 
Primary Key.", "readOnly": true }, "code": { "type": "string", "description": 
"Short, stable, machine-readable code (snake_case). Max 50 chars. E.g., 
'public_fountain_potable'.", "pattern": "^[a-z0-9_]+$", "maxLength": 50 }, 
"label": { "type": "string", "description": "Human-readable label for UI 
display. Primary reference language (English) text. (Translatable via 
public.translations). Max 100 chars.", "maxLength": 100 }, "description": { 
"type": ["string", "null"], "description": "Optional description of the source 
type. Primary reference language (English) text. (Translatable via 
public.translations)." }, "icon_identifier": { "type": ["string", "null"], 
"maxLength": 100, "description": "Name, class, or path for a UI icon associated 
with this source type." }, "is_commercial": { "type": "boolean", "default": 
false, "description": "Flag to distinguish commercial establishments from 
non-commercial ones." }, "sort_order": { "type": "integer", "default": 0, 
"description": "Determines the display order in UI lists or filters. Lower 
numbers appear first." }, "is_active": { "type": "boolean", "default": true, 
"description": "True if the type is active and available for use; false if 
retired." }, "created_at": { "type": "string", "format": "date-time", 
"description": "Timestamp of record creation.", "readOnly": true }, 
"updated_at": { "type": "string", "format": "date-time", "description": 
"Timestamp of last update (auto-updated by trigger).", "readOnly": true }, 
"created_by_profile_id": { "type": ["string", "null"], "format": "uuid", 
"description": "Profile ID of the user who created the record." }, 
"updated_by_profile_id": { "type": ["string", "null"], "format": "uuid", 
"description": "Profile ID of the user who last updated the record." } }, 
"required": [ "code", "label", "is_commercial", "sort_order", "is_active", 
"created_at", "updated_at" ] } ``` 5\. Relationships & Integrity - Primary Key: 
`id` (`INTEGER`). - Unique Constraint: `code` must be unique and follow the 
defined pattern. - Foreign Key References FROM other tables: 
`food_water_sources_details.source_type_id` references 
`food_water_source_types_master.id` (ON DELETE RESTRICT). The 
`food_water_sources_details` table includes a trigger to ensure the referenced 
`food_water_source_types_master` record has `is_active = true`. - Foreign Key 
References TO other tables: - `created_by_profile_id` REFERENCES 
`public.profiles(id)` ON DELETE SET NULL. - `updated_by_profile_id` REFERENCES 
`public.profiles(id)` ON DELETE SET NULL. 6\. Multilingual Strategy - 
Translatable Fields: `label` and `description`. These columns store their 
content in the primary reference language (English). They are designated as 
translatable via the central `public.translations` table, where translations 
into other languages are stored. - Non-Translatable Fields: `code` is a stable 
system identifier. `is_commercial`, `sort_order`, and `is_active` are 
structural/flag fields and are not translatable text. `icon_identifier` is a 
system value. - Orphan Cleanup: An `AFTER DELETE` trigger 
(`trigger_cleanup_food_water_source_type_translations`) is implemented. It 
calls `public.cleanup_food_water_source_type_translations` (which internally 
would use a generic like `public.cleanup_related_translations`) to remove any 
orphaned entries from `public.translations` when a 
`food_water_source_types_master` record is deleted. 7\. Role-Based Workflow & 
RLS Notes - Content Management: This master table is typically managed by 
`platform_admin` users who define and maintain the canonical list of food and 
water source types for the entire platform. - Lifecycle: Types are made 
inactive or "retired" by setting their `is_active` flag to `false`. Physical 
deletion of a record is restricted by the Foreign Key constraint from the 
`food_water_sources_details` table if any food/water source detail entry is 
actively using that type. The "active check" trigger on 
`food_water_sources_details` also prevents linking to inactive types. - RLS 
Policies: - Row-Level Security is enabled. - Public Users (`SELECT`): Can read 
all `food_water_source_types_master` records where `is_active = true`. - 
Authenticated Users (`platform_admin` role via `public.has_role_on_profile` 
helper): Have `ALL` permissions (INSERT, SELECT, UPDATE, DELETE) to manage 
these types. 8\. ENUM vs Lookup Discussion - Decision: This 
`food_water_source_types_master` table is a V2-compliant lookup table, 
correctly promoting an original `food_water_source_type_enum` concept. - 
Reasoning: Using a lookup table is essential for this classification due to its 
direct impact on user safety (e.g., distinguishing potable water sources) and 
logistical planning (e.g., identifying commercial vs. non-commercial sources). 
This approach allows for richer attributes such as translatable `label` and 
`description` fields, a dedicated `icon_identifier` for UI consistency, the 
critical `is_commercial` boolean flag (which can drive UI logic in dependent 
tables), an `is_active` flag for proper lifecycle management, `sort_order` for 
controlled presentation, and standard audit columns for traceability. This 
offers significantly more flexibility, maintainability, and data integrity than 
a hardcoded ENUM. 9\. UI/UX Enablement - `label` (translated): Used for clear 
and understandable display names in filters, map legends, and within the detail 
views of individual food/water sources. - `icon_identifier`: Drives the display 
of distinct map icons and list icons, helping users quickly identify the nature 
of a food or water source (e.g., a fountain icon, a restaurant icon, a grocery 
store icon). - `is_commercial`: This flag is crucial for the UI. It can be used 
to visually differentiate commercial points from public/free resources (e.g., 
different color map pins, or by determining whether to display price range 
information from the `food_water_sources_details` table). - `sort_order`: 
Ensures a logical and consistent presentation order of these source types in UI 
filter dropdowns, selection lists, or legends. - `is_active`: The UI should 
primarily present and allow filtering or selection based on active source types 
for general users and when content managers are creating new food/water source 
entries. 10\. Key Considerations & Definitions - Clarity and Distinction: The 
`code` and `label` for each type must be intuitive and clearly distinct to 
avoid any ambiguity for data managers entering information and for pilgrims 
interpreting it on the frontend. The distinction between various types of 
potable and non-potable water sources, as well as different kinds of food 
establishments, is particularly important. - Icon Set: A comprehensive and 
easily understandable set of icons corresponding to each `icon_identifier` 
needs to be available and consistently applied in the frontend application to 
ensure effective visual communication. - `is_commercial` Flag Impact: This 
boolean flag is a key differentiator. UI logic for displaying details from the 
`food_water_sources_details` table should adapt based on this flag; for 
example, fields related to pricing or payment methods are generally only 
relevant if `is_commercial = true`. - Seed Data Comprehensiveness: The initial 
seed data provided for this table must be reviewed to ensure it covers all 
expected types of food and water sources relevant to the pilgrimage routes and 
user needs from the outset. 11\. Scalability & Future-Proofing - Lookup Table 
Structure: The design is highly scalable. New source types can be easily added, 
or attributes of existing ones (like icons or descriptions) modified, without 
requiring schema changes to the `food_water_sources_details` table or other 
parts of the system that might reference these types. - Manageable Number of 
Types: The total number of distinct food and water source types is expected to 
be manageable, ensuring that the table remains performant for queries and easy 
to administer. - Audit and Lifecycle Management: The inclusion of full audit 
columns and the `is_active` flag provides a robust framework for tracking 
changes and managing the lifecycle of these source types, allowing types to be 
retired gracefully without losing historical data context. 12\. Next-Action 
Checklist - ðŸ”´ Verify Prerequisite Tables: Confirm `public.profiles` and 
`public.translations` tables are V2 compliant and exist. - ðŸ”´ Implement 
`food_water_source_types_master` Table: Execute the DDL for Version 1.2.1 as 
specified, ensuring role names in RLS policies are correct. - ðŸ”´ Apply 
Triggers: Ensure the `set_current_timestamp_updated_at` trigger and the 
`trigger_cleanup_food_water_source_type_translations` are created and correctly 
applied. - ðŸ”´ Initial Population / Seed Data: Insert the initial set of 
food/water source types using the seed data examples provided in the original 
`4.8 food_water_source_types_master.docx` (adjusting for `label` and 
`description` columns), and ensure `is_active` is set to `true` and 
`created_by_profile_id` is populated for these initial records. - ðŸŸ  RLS Helper 
Functions: Ensure that helper functions like 
`public.has_role_on_profile(auth.uid(), 'role_name')` are defined, secure, and 
used consistently in RLS policies. - ðŸŸ  RLS Policies: Implement and thoroughly 
test the RLS policies defined for this table. - ðŸŸ¢ Iconography Coordination: 
Ensure the `icon_identifier` list used in seed data is coordinated with the 
UI/UX team for the preparation of corresponding visual assets. - ðŸŸ¢ Translation 
Entries: Prepare initial English entries for all translatable fields (`label`, 
`description`) in the `public.translations` table, ensuring they are correctly 
linked. 
