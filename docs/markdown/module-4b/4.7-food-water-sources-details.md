# 4.7 food_water_sources_details

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/1d4834db0819faf2 
https://gemini.google.com/u/1/app/d423d51e9f40da78 ### 3\. Updated 
Production-Ready Specification (`food_water_sources_details`) This document 
details the structure, purpose, and considerations for the 
`food_water_sources_details` table, Version 1.3.1 (reflecting RLS role name 
alignment). This version incorporates full V2 enhancements including robust 
audit fields, refined i18n strategy, array foreign key integrity with active 
status checks, and media linking. It does *not* include denormalized English 
labels from master tables. 1\. Purpose & Primary Use-Cases The 
`food_water_sources_details` table stores specific attributes for waypoints 
that are food establishments (restaurants, cafes, grocery stores) or water 
sources (fountains, springs). It extends the generic `waypoints` entry to 
include crucial details such as the type of source, potability and reliability 
of water, price range for commercial establishments, types of meals served, 
dietary options, payment methods, and opening hours. This information is vital 
for pilgrims for logistical planning, ensuring they can find sustenance and 
safe drinking water along their route. Key user-story touchpoints: - Pilgrim: 
Finding places to eat or resupply groceries along the trail. - Pilgrim: 
Locating reliable sources of potable water. - Pilgrim: Filtering food options 
by type (restaurant, cafe), price range, or dietary accommodations (vegetarian, 
gluten-free). - Pilgrim: Checking opening hours for food establishments or 
availability notes for water sources. - Content Manager/Admin: Adding and 
maintaining detailed, accurate information about food and water points. 2\. 
Schema (`food_water_sources_details`) | column | data_type | constraints | 
description | | `waypoint_id` | `BIGINT` | Primary Key, Foreign Key to 
`public.waypoints(id)` ON DELETE CASCADE | Links to the generic `waypoints` 
table. This is the PK. | | `source_type_id` | `INTEGER` | Not Null, Foreign Key 
to `public.food_water_source_types_master(id)` ON DELETE RESTRICT | Type of 
food or water source, linking to an *active* `food_water_source_types_master` 
record. | | `is_potable_water_source` | `BOOLEAN` | Not Null, Default `false` | 
Explicitly true if this is a source of drinkable water. Defaults to false (not 
potable) unless explicitly stated. Primarily for non-commercial types. | | 
`water_reliability_id` | `INTEGER` | Nullable, Foreign Key to 
`public.water_reliability_types_master(id)` ON DELETE SET NULL | Reliability if 
it's a natural/public water source, linking to an *active* 
`water_reliability_types_master` record. | | `water_source_access_notes` | 
`TEXT` | Nullable | Specific notes on finding or accessing a public water 
source (e.g., "behind the church," "tap is on a timer"). Primary reference 
language (English) text. (Translatable via `public.translations`) | | 
`establishment_price_range_id` | `INTEGER` | Nullable, Foreign Key to 
`public.establishment_price_ranges_master(id)` ON DELETE SET NULL | General 
price range if it's a commercial establishment, linking to an *active* 
`establishment_price_ranges_master` record. | | `serves_meal_type_tag_ids` | 
`INTEGER[]` | Nullable | Array of FKs to `meal_type_tags_master(id)`. Types of 
meals served if commercial (e.g., breakfast, lunch, dinner). Integrity 
(existence and active status) enforced by DB trigger. | | 
`highlighted_dishes_local_specialties` | `TEXT[]` | Nullable | Array of 1-3 key 
dishes or local specialties offered (free text). Elements are primary reference 
language (English) text. (Translatable via `public.translations` for each 
element) | | `dietary_option_tag_ids` | `INTEGER[]` | Nullable | Array of FKs 
to `dietary_option_tags_master(id)`. Available dietary options (e.g., 
vegetarian, gluten-free). Integrity (existence and active status) enforced by 
DB trigger. | | `opening_hours_structured` | `JSONB` | Nullable, CHECK 
(`opening_hours_structured` IS NULL OR 
jsonb_type_of(`opening_hours_structured`) IN ('object', 'array')) | Structured 
opening hours for commercial establishments (e.g., based on schema.org 
OpeningHoursSpecification). Adheres to the centrally defined project schema. | 
| `opening_hours_text_notes` | `TEXT` | Nullable | Human-readable summary or 
additional notes about opening hours/availability (e.g., "Closed on Tuesdays," 
"Siesta 13:00-16:00"). Primary reference language (English) text. (Translatable 
via `public.translations`) | | `opening_hours_last_verified_at` | `TIMESTAMPTZ` 
| Nullable | When the opening hours were last checked/verified by an editor or 
reliable source. | | `outdoor_seating_available` | `BOOLEAN` | Nullable | Does 
the commercial establishment offer outdoor seating? Nullable allows for 
"unknown" or not applicable. | | `payment_method_tag_ids` | `INTEGER[]` | 
Nullable | Array of FKs to `payment_methods_master(id)`. Indicates accepted 
payment methods if commercial. Integrity (existence and active status) enforced 
by DB trigger. | | `specific_notes_for_pilgrims` | `TEXT` | Nullable | Any 
notes specifically for pilgrims (e.g., "Pilgrim menu available," "Offers 
discount with credential"). Primary reference language (English) text. 
(Translatable via `public.translations`) | | `data_last_verified_at` | 
`TIMESTAMPTZ` | Nullable | When the overall details for this source were last 
verified by an editor or reliable source. | | `created_at` | `TIMESTAMPTZ` | 
Not Null, Default `now()` | Timestamp of record creation. | | 
`created_by_profile_id` | `UUID` | Nullable, Foreign Key to 
`public.profiles(id)` ON DELETE SET NULL | Profile ID of the user who created 
this record. | | `updated_at` | `TIMESTAMPTZ` | Not Null, Default `now()` | 
Timestamp of last update (auto-updated by trigger). | | `updated_by_profile_id` 
| `UUID` | Nullable, Foreign Key to `public.profiles(id)` ON DELETE SET NULL | 
Profile ID of the user who last updated this record. | 3\. PostgreSQL DDL SQL 
``` -- Ensure prerequisite tables are V2 compliant and created first: -- 
public.waypoints (BIGINT id PK, content_visibility_status_id INTEGER, 
deleted_at TIMESTAMPTZ) -- public.profiles (UUID id PK, roles TEXT[]) -- 
public.media (UUID id PK) -- public.media_roles_master (TEXT code PK) -- 
public.translations (for i18n) -- public.languages_master (for i18n) -- 
public.content_statuses_master (INTEGER id PK, is_publicly_visible BOOLEAN) -- 
Prerequisite Master Tables (ensure these match their full V1.1/V1.2 specs 
previously defined) -- public.food_water_source_types_master (Version 1.2.1 - 
with label, is_active, audit, triggers, RLS) -- 
public.water_reliability_types_master (Version 1.2.1 - with label, is_active, 
audit, triggers, RLS) -- public.establishment_price_ranges_master (Version 1.1 
- with label, is_active, audit, triggers, RLS) -- public.meal_type_tags_master 
(Version 1.1 - with label, is_active, audit, triggers, RLS) -- 
public.dietary_option_tags_master (Version 1.1 - with label, is_active, audit, 
triggers, RLS) -- public.payment_methods_master (Version 1.1 - with label, 
is_active, audit, triggers, RLS) -- (Full DDL for master tables should be 
referenced from their respective finalized specification documents) -- Food & 
Water Sources Details Table (Version 1.3.1) CREATE TABLE 
public.food_water_sources_details ( waypoint_id BIGINT PRIMARY KEY, 
source_type_id INTEGER NOT NULL, is_potable_water_source BOOLEAN NOT NULL 
DEFAULT FALSE, water_reliability_id INTEGER NULL, water_source_access_notes 
TEXT NULL, establishment_price_range_id INTEGER NULL, serves_meal_type_tag_ids 
INTEGER[] NULL, highlighted_dishes_local_specialties TEXT[] NULL, 
dietary_option_tag_ids INTEGER[] NULL, opening_hours_structured JSONB NULL 
CHECK (opening_hours_structured IS NULL OR 
jsonb_type_of(opening_hours_structured) IN ('object', 'array')), 
opening_hours_text_notes TEXT NULL, opening_hours_last_verified_at TIMESTAMPTZ 
NULL, outdoor_seating_available BOOLEAN NULL, payment_method_tag_ids INTEGER[] 
NULL, specific_notes_for_pilgrims TEXT NULL, data_last_verified_at TIMESTAMPTZ 
NULL, created_at TIMESTAMPTZ NOT NULL DEFAULT now(), created_by_profile_id UUID 
NULL, updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), updated_by_profile_id UUID 
NULL, CONSTRAINT fk_waypoint FOREIGN KEY(waypoint_id) REFERENCES 
public.waypoints(id) ON DELETE CASCADE, CONSTRAINT fk_source_type FOREIGN 
KEY(source_type_id) REFERENCES public.food_water_source_types_master(id) ON 
DELETE RESTRICT, CONSTRAINT fk_water_reliability FOREIGN 
KEY(water_reliability_id) REFERENCES public.water_reliability_types_master(id) 
ON DELETE SET NULL, CONSTRAINT fk_establishment_price_range FOREIGN 
KEY(establishment_price_range_id) REFERENCES 
public.establishment_price_ranges_master(id) ON DELETE SET NULL, CONSTRAINT 
fk_created_by_profile FOREIGN KEY(created_by_profile_id) REFERENCES 
public.profiles(id) ON DELETE SET NULL, CONSTRAINT fk_updated_by_profile 
FOREIGN KEY(updated_by_profile_id) REFERENCES public.profiles(id) ON DELETE SET 
NULL ); COMMENT ON TABLE public.food_water_sources_details IS 'Specific details 
for food establishments and water sources, extending the waypoints table. 
Version 1.3.1'; [cite: 421] COMMENT ON COLUMN 
public.food_water_sources_details.waypoint_id IS 'Links to the generic 
waypoints table. This is the PK.'; [cite: 422] COMMENT ON COLUMN 
public.food_water_sources_details.source_type_id IS 'FK to 
food_water_source_types_master. Type of food or water source. Referenced master 
record must be is_active=true.'; COMMENT ON COLUMN 
public.food_water_sources_details.is_potable_water_source IS 'True if a source 
of drinkable water (especially for non-commercial types). Defaults to FALSE 
(not potable unless explicitly stated).'; [cite: 424, 425] COMMENT ON COLUMN 
public.food_water_sources_details.water_reliability_id IS 'FK to 
water_reliability_types_master. Reliability if a natural/public water source. 
Referenced master record must be is_active=true.'; COMMENT ON COLUMN 
public.food_water_sources_details.water_source_access_notes IS 'Specific notes 
on finding or accessing a public water source. Primary reference language 
(English) text. (Translatable via public.translations)'; [cite: 427] COMMENT ON 
COLUMN public.food_water_sources_details.establishment_price_range_id IS 'FK to 
establishment_price_ranges_master. General price range if commercial. 
Referenced master record must be is_active=true.'; COMMENT ON COLUMN 
public.food_water_sources_details.serves_meal_type_tag_ids IS 'Array of FKs to 
meal_type_tags_master. Types of meals served if commercial. Integrity 
(existence and active status) of array elements MUST be enforced by a dedicated 
database trigger.'; [cite: 429] COMMENT ON COLUMN 
public.food_water_sources_details.highlighted_dishes_local_specialties IS 
'Array of key dishes or local specialties offered (free text). Elements are 
primary reference language (English) text. (Translatable via 
public.translations for each element).'; [cite: 431] COMMENT ON COLUMN 
public.food_water_sources_details.dietary_option_tag_ids IS 'Array of FKs to 
dietary_option_tags_master. Available dietary options. Integrity (existence and 
active status) of array elements MUST be enforced by a dedicated database 
trigger.'; [cite: 433] COMMENT ON COLUMN 
public.food_water_sources_details.opening_hours_structured IS 'Structured 
opening hours for commercial establishments in JSONB format. Adheres to the 
centrally defined schema.'; [cite: 434] COMMENT ON COLUMN 
public.food_water_sources_details.opening_hours_text_notes IS 'Human-readable 
summary or notes about opening hours/availability. Primary reference language 
(English) text. (Translatable via public.translations)'; [cite: 436] COMMENT ON 
COLUMN public.food_water_sources_details.opening_hours_last_verified_at IS 
'When the opening hours were last checked/verified.'; [cite: 437] COMMENT ON 
COLUMN public.food_water_sources_details.outdoor_seating_available IS 'Does the 
commercial establishment offer outdoor seating? Nullable for "unknown".'; 
[cite: 438] COMMENT ON COLUMN 
public.food_water_sources_details.payment_method_tag_ids IS 'Array of FKs to 
payment_methods_master. Accepted payment methods if commercial. Integrity 
(existence and active status) of array elements MUST be enforced by a dedicated 
database trigger.'; [cite: 439] COMMENT ON COLUMN 
public.food_water_sources_details.specific_notes_for_pilgrims IS 'Any notes 
specifically for pilgrims. Primary reference language (English) text. 
(Translatable via public.translations)'; [cite: 440] COMMENT ON COLUMN 
public.food_water_sources_details.data_last_verified_at IS 'When the overall 
details for this source were last verified by an editor or reliable source.'; 
[cite: 441] COMMENT ON COLUMN public.food_water_sources_details.created_at IS 
'Timestamp of record creation.'; COMMENT ON COLUMN 
public.food_water_sources_details.created_by_profile_id IS 'Profile ID of the 
user who created this record.'; [cite: 442] COMMENT ON COLUMN 
public.food_water_sources_details.updated_at IS 'Timestamp of last update 
(auto-updated by trigger).'; COMMENT ON COLUMN 
public.food_water_sources_details.updated_by_profile_id IS 'Profile ID of the 
user who last updated this record.'; [cite: 443] -- Linking table for 
Food/Water Source Media (public.food_water_source_media - Version 1.0) CREATE 
TABLE IF NOT EXISTS public.food_water_source_media ( id BIGINT GENERATED ALWAYS 
AS IDENTITY PRIMARY KEY, food_water_source_waypoint_id BIGINT NOT NULL 
REFERENCES public.food_water_sources_details(waypoint_id) ON DELETE CASCADE, 
media_id UUID NOT NULL REFERENCES public.media(id) ON DELETE RESTRICT, 
media_role_code TEXT NOT NULL REFERENCES public.media_roles_master(code) ON 
DELETE RESTRICT, display_order SMALLINT NOT NULL DEFAULT 0, caption_override 
TEXT NULL, -- Primary reference language (English). Translatable. 
alt_text_override TEXT NULL, -- Primary reference language (English). 
Translatable. created_at TIMESTAMPTZ NOT NULL DEFAULT now(), updated_at 
TIMESTAMPTZ NOT NULL DEFAULT now(), created_by_profile_id UUID NULL REFERENCES 
public.profiles(id) ON DELETE SET NULL, updated_by_profile_id UUID NULL 
REFERENCES public.profiles(id) ON DELETE SET NULL, CONSTRAINT 
uq_food_water_source_media_role_order UNIQUE (food_water_source_waypoint_id, 
media_id, media_role_code) ); COMMENT ON TABLE public.food_water_source_media 
IS 'Links food/water sources to media items for galleries or specific semantic 
roles. Version 1.0'; CREATE TRIGGER 
trigger_food_water_source_media_set_updated_at BEFORE UPDATE ON 
public.food_water_source_media FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); CREATE OR REPLACE FUNCTION 
public.cleanup_food_water_source_media_translations() RETURNS TRIGGER AS $$ 
BEGIN DELETE FROM public.translations WHERE table_identifier = 
'food_water_source_media' AND row_foreign_key = OLD.id::TEXT; RETURN OLD; END; 
$$ LANGUAGE plpgsql SECURITY DEFINER; CREATE TRIGGER 
trigger_cleanup_food_water_source_media_translations AFTER DELETE ON 
public.food_water_source_media FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_food_water_source_media_translations(); COMMENT ON TRIGGER 
trigger_cleanup_food_water_source_media_translations ON 
public.food_water_source_media IS 'Cleans up orphaned translations for 
food_water_source_media translatable fields.'; -- Triggers & Functions for 
food_water_sources_details CREATE TRIGGER 
trigger_food_water_sources_details_set_updated_at BEFORE UPDATE ON 
public.food_water_sources_details FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); COMMENT ON TRIGGER 
trigger_food_water_sources_details_set_updated_at ON 
public.food_water_sources_details IS 'Trigger to automatically update 
updated_at timestamp on row modification.'; [cite: 445] CREATE OR REPLACE 
FUNCTION public.cleanup_food_water_sources_details_translations() RETURNS 
TRIGGER AS $$ BEGIN DELETE FROM public.translations WHERE table_identifier = 
'food_water_sources_details' AND row_foreign_key = OLD.waypoint_id::TEXT; 
DELETE FROM public.translations WHERE table_identifier = 
'food_water_source_media' AND row_foreign_key IN (SELECT id::TEXT FROM 
public.food_water_source_media WHERE food_water_source_waypoint_id = 
OLD.waypoint_id); RETURN OLD; END; $$ LANGUAGE plpgsql SECURITY DEFINER; CREATE 
TRIGGER trigger_cleanup_food_water_sources_details_translations AFTER DELETE ON 
public.food_water_sources_details FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_food_water_sources_details_translations(); COMMENT ON TRIGGER 
trigger_cleanup_food_water_sources_details_translations ON 
public.food_water_sources_details IS 'Cleans up orphaned translations for 
food_water_sources_details and its linked media.'; -- Active Check Triggers for 
Single FKs CREATE OR REPLACE FUNCTION public.check_fwsrc_source_type_active() 
RETURNS TRIGGER AS $$ DECLARE is_active BOOLEAN; BEGIN IF NEW.source_type_id IS 
NOT NULL THEN SELECT fstm.is_active INTO is_active FROM 
public.food_water_source_types_master fstm WHERE fstm.id = NEW.source_type_id; 
IF NOT is_active THEN RAISE EXCEPTION 'Referenced 
food_water_source_types_master record (id: %) must be active.', 
NEW.source_type_id; END IF; END IF; RETURN NEW; END; $$ LANGUAGE plpgsql; 
CREATE TRIGGER trigger_check_fwsrc_source_type_active BEFORE INSERT OR UPDATE 
OF source_type_id ON public.food_water_sources_details FOR EACH ROW EXECUTE 
FUNCTION public.check_fwsrc_source_type_active(); CREATE OR REPLACE FUNCTION 
public.check_fwsrc_water_reliability_active() RETURNS TRIGGER AS $$ DECLARE 
is_active BOOLEAN; BEGIN IF NEW.water_reliability_id IS NOT NULL THEN SELECT 
wrtm.is_active INTO is_active FROM public.water_reliability_types_master wrtm 
WHERE wrtm.id = NEW.water_reliability_id; IF NOT is_active THEN RAISE EXCEPTION 
'Referenced water_reliability_types_master record (id: %) must be active.', 
NEW.water_reliability_id; END IF; END IF; RETURN NEW; END; $$ LANGUAGE plpgsql; 
CREATE TRIGGER trigger_check_fwsrc_water_reliability_active BEFORE INSERT OR 
UPDATE OF water_reliability_id ON public.food_water_sources_details FOR EACH 
ROW EXECUTE FUNCTION public.check_fwsrc_water_reliability_active(); CREATE OR 
REPLACE FUNCTION public.check_fwsrc_price_range_active() RETURNS TRIGGER AS $$ 
DECLARE is_active BOOLEAN; BEGIN IF NEW.establishment_price_range_id IS NOT 
NULL THEN SELECT eprm.is_active INTO is_active FROM 
public.establishment_price_ranges_master eprm WHERE eprm.id = 
NEW.establishment_price_range_id; IF NOT is_active THEN RAISE EXCEPTION 
'Referenced establishment_price_ranges_master record (id: %) must be active.', 
NEW.establishment_price_range_id; END IF; END IF; RETURN NEW; END; $$ LANGUAGE 
plpgsql; CREATE TRIGGER trigger_check_fwsrc_price_range_active BEFORE INSERT OR 
UPDATE OF establishment_price_range_id ON public.food_water_sources_details FOR 
EACH ROW EXECUTE FUNCTION public.check_fwsrc_price_range_active(); -- Array FK 
Integrity Triggers (checking existence and is_active) CREATE OR REPLACE 
FUNCTION public.check_fwsrc_serves_meal_types() RETURNS TRIGGER AS $$ DECLARE 
tag_id INTEGER; is_valid BOOLEAN; tag_is_active BOOLEAN; BEGIN IF 
NEW.serves_meal_type_tag_ids IS NOT NULL AND 
array_length(NEW.serves_meal_type_tag_ids, 1) > 0 THEN FOREACH tag_id IN ARRAY 
NEW.serves_meal_type_tag_ids LOOP SELECT EXISTS (SELECT 1 FROM 
public.meal_type_tags_master WHERE id = tag_id), mttm.is_active INTO is_valid, 
tag_is_active FROM public.meal_type_tags_master mttm WHERE mttm.id = tag_id; IF 
NOT is_valid THEN RAISE EXCEPTION 'Invalid meal_type_tag_id: %', tag_id; END 
IF; IF NOT tag_is_active THEN RAISE EXCEPTION 'Inactive meal_type_tag_id: %', 
tag_id; END IF; END LOOP; END IF; RETURN NEW; END; $$ LANGUAGE plpgsql; CREATE 
TRIGGER trigger_check_fwsrc_serves_meal_types BEFORE INSERT OR UPDATE OF 
serves_meal_type_tag_ids ON public.food_water_sources_details FOR EACH ROW 
EXECUTE FUNCTION public.check_fwsrc_serves_meal_types(); CREATE OR REPLACE 
FUNCTION public.check_fwsrc_dietary_options() RETURNS TRIGGER AS $$ DECLARE 
tag_id INTEGER; is_valid BOOLEAN; tag_is_active BOOLEAN; BEGIN IF 
NEW.dietary_option_tag_ids IS NOT NULL AND 
array_length(NEW.dietary_option_tag_ids, 1) > 0 THEN FOREACH tag_id IN ARRAY 
NEW.dietary_option_tag_ids LOOP SELECT EXISTS (SELECT 1 FROM 
public.dietary_option_tags_master WHERE id = tag_id), dotm.is_active INTO 
is_valid, tag_is_active FROM public.dietary_option_tags_master dotm WHERE 
dotm.id = tag_id; IF NOT is_valid THEN RAISE EXCEPTION 'Invalid 
dietary_option_tag_id: %', tag_id; END IF; IF NOT tag_is_active THEN RAISE 
EXCEPTION 'Inactive dietary_option_tag_id: %', tag_id; END IF; END LOOP; END 
IF; RETURN NEW; END; $$ LANGUAGE plpgsql; CREATE TRIGGER 
trigger_check_fwsrc_dietary_options BEFORE INSERT OR UPDATE OF 
dietary_option_tag_ids ON public.food_water_sources_details FOR EACH ROW 
EXECUTE FUNCTION public.check_fwsrc_dietary_options(); CREATE OR REPLACE 
FUNCTION public.check_fwsrc_payment_methods() RETURNS TRIGGER AS $$ DECLARE 
tag_id INTEGER; is_valid BOOLEAN; tag_is_active BOOLEAN; BEGIN IF 
NEW.payment_method_tag_ids IS NOT NULL AND 
array_length(NEW.payment_method_tag_ids, 1) > 0 THEN FOREACH tag_id IN ARRAY 
NEW.payment_method_tag_ids LOOP SELECT EXISTS (SELECT 1 FROM 
public.payment_methods_master WHERE id = tag_id), pmm.is_active INTO is_valid, 
tag_is_active FROM public.payment_methods_master pmm WHERE pmm.id = tag_id; IF 
NOT is_valid THEN RAISE EXCEPTION 'Invalid payment_method_tag_id: %', tag_id; 
END IF; IF NOT tag_is_active THEN RAISE EXCEPTION 'Inactive 
payment_method_tag_id: %', tag_id; END IF; END LOOP; END IF; RETURN NEW; END; 
$$ LANGUAGE plpgsql; CREATE TRIGGER trigger_check_fwsrc_payment_methods BEFORE 
INSERT OR UPDATE OF payment_method_tag_ids ON public.food_water_sources_details 
FOR EACH ROW EXECUTE FUNCTION public.check_fwsrc_payment_methods(); -- Indexes 
CREATE INDEX idx_fwsrc_source_type_id ON 
public.food_water_sources_details(source_type_id); [cite: 446] CREATE INDEX 
idx_fwsrc_water_reliability_id ON 
public.food_water_sources_details(water_reliability_id) WHERE 
water_reliability_id IS NOT NULL; [cite: 447] CREATE INDEX 
idx_fwsrc_price_range_id ON 
public.food_water_sources_details(establishment_price_range_id) WHERE 
establishment_price_range_id IS NOT NULL; [cite: 448] CREATE INDEX 
idx_fwsrc_serves_meal_ids ON public.food_water_sources_details USING GIN 
(serves_meal_type_tag_ids) WHERE serves_meal_type_tag_ids IS NOT NULL; [cite: 
449] CREATE INDEX idx_fwsrc_dietary_option_ids ON 
public.food_water_sources_details USING GIN (dietary_option_tag_ids) WHERE 
dietary_option_tag_ids IS NOT NULL; [cite: 450] CREATE INDEX 
idx_fwsrc_payment_method_ids ON public.food_water_sources_details USING GIN 
(payment_method_tag_ids) WHERE payment_method_tag_ids IS NOT NULL; [cite: 451] 
CREATE INDEX IF NOT EXISTS idx_fwsrc_opening_hours_structured ON 
public.food_water_sources_details USING GIN (opening_hours_structured) WHERE 
opening_hours_structured IS NOT NULL; CREATE INDEX 
idx_fwsrc_created_by_profile_id ON 
public.food_water_sources_details(created_by_profile_id) WHERE 
created_by_profile_id IS NOT NULL; CREATE INDEX idx_fwsrc_updated_by_profile_id 
ON public.food_water_sources_details(updated_by_profile_id) WHERE 
updated_by_profile_id IS NOT NULL; CREATE INDEX 
idx_food_water_source_media_fw_waypoint_id ON 
public.food_water_source_media(food_water_source_waypoint_id); -- RLS Policies 
for food_water_sources_details ALTER TABLE public.food_water_sources_details 
ENABLE ROW LEVEL SECURITY; CREATE POLICY 
"public_read_food_water_sources_details" ON public.food_water_sources_details 
FOR SELECT USING ( EXISTS ( SELECT 1 FROM public.waypoints w JOIN 
public.content_statuses_master csm ON w.content_visibility_status_id = csm.id 
WHERE w.id = food_water_sources_details.waypoint_id AND csm.is_publicly_visible 
= TRUE AND w.deleted_at IS NULL ) ); CREATE POLICY 
"manage_food_water_sources_details_for_privileged_users" ON 
public.food_water_sources_details FOR ALL USING ( ((SELECT 
public.has_role_on_profile(auth.uid(), 'platform_admin')) OR (SELECT 
public.has_role_on_profile(auth.uid(), 'regional_content_manager'))) -- Using 
consistent role names ) WITH CHECK ( ((SELECT 
public.has_role_on_profile(auth.uid(), 'platform_admin')) OR (SELECT 
public.has_role_on_profile(auth.uid(), 'regional_content_manager'))) AND (TG_OP 
= 'INSERT' OR (TG_OP = 'UPDATE' AND OLD.waypoint_id = NEW.waypoint_id OR 
(SELECT public.has_role_on_profile(auth.uid(), 'platform_admin')))) ); -- (RLS 
for food_water_source_media similar to other media linking tables, using 
consistent role names) ``` 4\. JSON Schema Mirror (food_water_sources_details) 
(Reflects the schema table in Section 2; does not include denormalized 
*_label_en columns) JSON ``` { "title": "food_water_source_detail", 
"description": "Specific details for food establishments and water sources, 
extending the waypoints table. Version 1.3.1", "type": "object", "properties": 
{ "waypoint_id": { "type": "integer", "format": "int64", "description": "Links 
to the generic waypoints table. PK." }, "source_type_id": { "type": "integer", 
"description": "FK to food_water_source_types_master. Type of food or water 
source. Referenced master must be active." }, "is_potable_water_source": { 
"type": "boolean", "default": false, "description": "True if this is a source 
of drinkable water." }, "water_reliability_id": { "type": ["integer", "null"], 
"description": "FK to water_reliability_types_master. Reliability if a 
natural/public water source. Referenced master must be active." }, 
"water_source_access_notes": { "type": ["string", "null"], "description": 
"Specific notes on accessing a public water source. Primary reference language 
(English) text. (Translatable via public.translations)" }, 
"establishment_price_range_id": { "type": ["integer", "null"], "description": 
"FK to establishment_price_ranges_master. General price range if commercial. 
Referenced master must be active." }, "serves_meal_type_tag_ids": { "type": 
["array", "null"], "items": { "type": "integer" }, "description": "Array of FKs 
to meal_type_tags_master. Types of meals served. Integrity & active status of 
tags enforced by DB trigger." }, "highlighted_dishes_local_specialties": { 
"type": ["array", "null"], "items": { "type": "string" }, "description": "Array 
of key dishes/specialties (free text). Elements are primary reference language 
(English) text. (Translatable via public.translations for each element)" }, 
"dietary_option_tag_ids": { "type": ["array", "null"], "items": { "type": 
"integer" }, "description": "Array of FKs to dietary_option_tags_master. 
Dietary options. Integrity & active status of tags enforced by DB trigger." }, 
"opening_hours_structured": { "type": ["object", "array", "null"], 
"description": "Structured opening hours (e.g., schema.org). Can be object or 
array of objects." }, "opening_hours_text_notes": { "type": ["string", "null"], 
"description": "Human-readable notes on opening hours. Primary reference 
language (English) text. (Translatable via public.translations)" }, 
"opening_hours_last_verified_at": { "type": ["string", "null"], "format": 
"date-time", "description": "When opening hours were last verified." }, 
"outdoor_seating_available": { "type": ["boolean", "null"], "description": 
"Does the commercial establishment offer outdoor seating? Null for 'unknown'." 
}, "payment_method_tag_ids": { "type": ["array", "null"], "items": { "type": 
"integer" }, "description": "Array of FKs to payment_methods_master. Accepted 
payment methods. Integrity & active status of tags enforced by DB trigger." }, 
"specific_notes_for_pilgrims": { "type": ["string", "null"], "description": 
"Notes specifically for pilgrims. Primary reference language (English) text. 
(Translatable via public.translations)" }, "data_last_verified_at": { "type": 
["string", "null"], "format": "date-time", "description": "When overall details 
were last verified." }, "created_at": { "type": "string", "format": 
"date-time", "description": "Timestamp of record creation.", "readOnly": true 
}, "created_by_profile_id": { "type": ["string", "null"], "format": "uuid", 
"description": "Profile ID of the creator." }, "updated_at": { "type": 
"string", "format": "date-time", "description": "Timestamp of last update.", 
"readOnly": true }, "updated_by_profile_id": { "type": ["string", "null"], 
"format": "uuid", "description": "Profile ID of the last updater." } }, 
"required": [ "waypoint_id", "source_type_id", "is_potable_water_source", 
"created_at", "updated_at" ] } ``` 5\. Relationships & Integrity - Primary Key: 
`waypoint_id` (`BIGINT`). - Foreign Keys: - `source_type_id` REFERENCES 
`public.food_water_source_types_master(id)` ON DELETE RESTRICT. (Integrity: 
Referenced master record must have `is_active = true`, enforced by 
`trigger_check_fwsrc_source_type_active`). - `water_reliability_id` REFERENCES 
`public.water_reliability_types_master(id)` ON DELETE SET NULL. (Integrity: 
Referenced master record must have `is_active = true`, enforced by 
`trigger_check_fwsrc_water_reliability_active`). - 
`establishment_price_range_id` REFERENCES 
`public.establishment_price_ranges_master(id)` ON DELETE SET NULL. (Integrity: 
Referenced master record must have `is_active = true`, enforced by 
`trigger_check_fwsrc_price_range_active`). - Audit FKs 
(`created_by_profile_id`, `updated_by_profile_id`) to `public.profiles(id)` ON 
DELETE SET NULL. - Array Foreign Keys: - `serves_meal_type_tag_ids` (elements 
`INTEGER`) to `meal_type_tags_master(id)`. - `dietary_option_tag_ids` (elements 
`INTEGER`) to `dietary_option_tags_master(id)`. - `payment_method_tag_ids` 
(elements `INTEGER`) to `payment_methods_master(id)`. - Integrity for all array 
FKs (ensuring each referenced ID exists in its master table and that the master 
record has `is_active = true`) is enforced by dedicated database triggers 
(`trigger_check_fwsrc_serves_meal_types`, 
`trigger_check_fwsrc_dietary_options`, `trigger_check_fwsrc_payment_methods`). 
- Linking Tables: `public.food_water_source_media` (Version 1.0) links this 
table to `public.media` for managing galleries or specific media roles 
associated with a food/water source. Its own DDL includes audit columns, 
`updated_at` trigger, and orphan translation cleanup for its translatable 
fields. 6\. Multilingual Strategy - Directly Translatable Fields (Primary 
reference language: English, translated via `public.translations`): - 
`water_source_access_notes` - Elements within 
`highlighted_dishes_local_specialties` (each string in the array is 
individually translatable) - `opening_hours_text_notes` - 
`specific_notes_for_pilgrims` - `food_water_source_media.caption_override` (for 
linked media) - `food_water_source_media.alt_text_override` (for linked media) 
- Indirectly Translatable Fields (via `label` fields in referenced master 
tables, which are fetched by views or application logic): - `source_type_id` 
(links to `food_water_source_types_master.label`) - `water_reliability_id` 
(links to `water_reliability_types_master.label`) - 
`establishment_price_range_id` (links to 
`establishment_price_ranges_master.label`) - `serves_meal_type_tag_ids` 
(elements link to `meal_type_tags_master.label`) - `dietary_option_tag_ids` 
(elements link to `dietary_option_tags_master.label`) - 
`payment_method_tag_ids` (elements link to `payment_methods_master.label`) - 
Orphan Cleanup: The `trigger_cleanup_food_water_sources_details_translations` 
(`AFTER DELETE` on `food_water_sources_details`) removes related entries from 
`public.translations` for this table and its media linking table 
(`food_water_source_media`). Referenced master tables are responsible for their 
own translation cleanup via their respective triggers. 7\. Role-Based Workflow 
& RLS Notes - Key Fields for Workflow: `data_last_verified_at` and 
`opening_hours_last_verified_at` are crucial for content managers to track and 
indicate the freshness of the information. Audit columns provide traceability 
of changes. The overall visibility is controlled by the parent `waypoints` 
record's status. - RLS Policies: - Row-Level Security is enabled on 
`food_water_sources_details` and its media linking table. - Public Users 
(`SELECT`): Can read details of food/water sources associated with waypoints 
that are published (via `waypoints.content_visibility_status_id` joining to 
`content_statuses_master.is_publicly_visible = TRUE`) and not soft-deleted 
(`waypoints.deleted_at IS NULL`). - Privileged Users (e.g., `platform_admin`, 
`regional_content_manager` roles, identified via `public.has_role_on_profile` 
helper): Have `ALL` permissions (CRUD). - `WITH CHECK` conditions prevent 
non-`platform_admin` users from re-parenting `waypoint_id` on `UPDATE`. - RLS 
policies for all prerequisite master tables ensure public read access only to 
`is_active = true` records, while `platform_admin` users have full control. 8\. 
ENUM vs Lookup Discussion - All relevant former ENUM concepts for this table's 
context (`food_water_source_type_enum`, `water_reliability_enum`, price range 
ENUM, meal types ENUM, dietary options ENUM, payment methods ENUM) have been 
successfully promoted to full V2-compliant master lookup tables 
(`food_water_source_types_master` (V1.2.1), `water_reliability_types_master` 
(V1.2.1), `establishment_price_ranges_master` (V1.1), `meal_type_tags_master` 
(V1.1), `dietary_option_tags_master` (V1.1), `payment_methods_master` (V1.1)). 
This is a robust and flexible approach, providing better data integrity, 
translatability, lifecycle management (`is_active`), auditability, and the 
ability to add descriptive attributes like icons. 9\. UI/UX Enablement - 
Filtering and Identification: All `*_id` and `*_tag_ids` fields, by linking to 
master tables that store `icon_identifier` and translatable `label` fields, 
will power UI filters and provide clear visual cues (icons, names) for users to 
identify and select different types of food sources, water reliability, price 
ranges, meal types, dietary options, and payment methods. - Critical 
Information Display: `is_potable_water_source` is a key boolean flag that must 
be prominently and clearly displayed for water sources. 
`opening_hours_structured` can be parsed to show "Open Now?" indicators or 
detailed daily schedules. - Rich Details: Fields like 
`highlighted_dishes_local_specialties`, `water_source_access_notes`, and 
`specific_notes_for_pilgrims` provide valuable, context-specific information 
directly displayable on detail pages. - Media: The `food_water_source_media` 
table allows for a gallery, enhancing visual appeal and information. 10\. Key 
Considerations & Definitions - UI Adaptation Based on `source_type_id`: The 
user interface should dynamically adapt based on the 
`food_water_source_types_master.is_commercial` flag associated with the linked 
`source_type_id`. For example, fields like `establishment_price_range_id`, 
`serves_meal_type_tag_ids`, and `payment_method_tag_ids` are typically relevant 
only for commercial types and might be hidden or disabled for non-commercial 
sources like public fountains. - Clarity on `is_potable_water_source`: This 
field is `NOT NULL DEFAULT FALSE`. The UI must clearly differentiate for the 
user between sources explicitly marked as "potable" (`TRUE`), those explicitly 
"not potable" (`FALSE` unless other indicators like a "non-potable" 
`source_type_id` apply), and potentially "unknown/unverified" status (which 
might be inferred if `source_type_id` is a water type but 
`is_potable_water_source` is `FALSE` and `water_reliability_id` indicates 
unknown reliability). Data entry workflows must enforce explicit confirmation 
for setting this to `TRUE`. - Array FK Validation: The database triggers for 
`serves_meal_type_tag_ids`, `dietary_option_tag_ids`, and 
`payment_method_tag_ids` are critical for ensuring data integrity and that only 
active master records are referenced. - `opening_hours_structured` (JSONB): 
Adherence to the centrally defined JSON schema for this field is critical for 
consistent data entry by content managers and reliable parsing by the 
application for display. - Data Verification: Workflows for content managers to 
regularly update `opening_hours_last_verified_at` and `data_last_verified_at` 
are important for maintaining user trust in the accuracy of the information. 
11\. Scalability & Future-Proofing - The use of structured data via linked 
master tables for classifications and `JSONB` for flexible data like opening 
hours provides excellent scalability and makes the system adaptable to future 
enhancements without requiring significant schema alterations to this detail 
table. - Comprehensive audit columns and `is_active` flags on master tables 
support robust data governance and lifecycle management. - The 1:1 relationship 
with `waypoints` means that any partitioning strategy implemented for 
`waypoints` would naturally apply to `food_water_sources_details` as well. 12\. 
Next-Action Checklist - ðŸ”´ Verify Prerequisite Master Tables are V2 Compliant: 
- Confirm `public.food_water_source_types_master` (Version 1.2.1) and 
`public.water_reliability_types_master` (Version 1.2.1) are implemented as 
specified. - Confirm `public.establishment_price_ranges_master` (Version 1.1), 
`public.meal_type_tags_master` (Version 1.1), 
`public.dietary_option_tags_master` (Version 1.1), and 
`public.payment_methods_master` (Version 1.1) DDLs (including `is_active`, 
`label`, full audit, all triggers, indexes, RLS) are complete and implemented. 
Ensure they are populated with seed data. - Verify `public.media_roles_master` 
is populated for use by `food_water_source_media`. - ðŸ”´ Implement/Update 
`food_water_sources_details` Table: Execute the DDL for Version 1.3.1. - ðŸ”´ 
Implement/Verify Triggers on `food_water_sources_details`: - 
`trigger_food_water_sources_details_set_updated_at`. - 
`trigger_cleanup_food_water_sources_details_translations` (including linked 
media). - Active check triggers for single FKs: 
`trigger_check_fwsrc_source_type_active`, 
`trigger_check_fwsrc_water_reliability_active`, 
`trigger_check_fwsrc_price_range_active`. - Array FK integrity triggers 
(checking existence and `is_active`): `trigger_check_fwsrc_serves_meal_types`, 
`trigger_check_fwsrc_dietary_options`, `trigger_check_fwsrc_payment_methods`. - 
ðŸ”´ Implement/Verify `food_water_source_media` Table: Ensure its DDL (Version 
1.0), triggers (`updated_at`, orphan translation for its translatable fields), 
indexes, and RLS policies are correctly implemented. - ðŸŸ  JSON Schema for 
`opening_hours_structured`: Ensure this schema is formally defined, documented, 
and consistently used. - ðŸŸ  RLS Helper Functions: Verify 
`public.has_role_on_profile(UUID, TEXT)` (or equivalent) is defined and secure 
for use in RLS policies. - ðŸŸ¢ RLS Policies: Thoroughly test all implemented RLS 
policies for `food_water_sources_details`, its media table, and all related 
master tables. - ðŸŸ¢ Translation Entries & Seed Data: Prepare initial English 
entries in `public.translations` for all translatable fields. - ðŸŸ¢ Data 
Migration (if applicable): If `food_water_sources_details` already contains 
data, ensure schema changes are compatible. 
