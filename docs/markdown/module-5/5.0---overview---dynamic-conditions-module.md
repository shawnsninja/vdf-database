# 5.0 - overview - Dynamic Conditions Module

  https://gemini.google.com/u/1/app/820a299da1bfbd39 
https://gemini.google.com/u/1/app/951c86a3d09aaadb Okay, I will now generate 
the updated and comprehensive overview document for the Dynamic Conditions 
Module (Module 5), reflecting all the specifications, enhancements, and 
decisions we'sve made. * * * * * Dynamic Conditions Module Overview Version: 
2.1 (Based on Checklist REV 05-18-25-A and interactive C2C refinement) Date: 
May 18, 2025 This document provides a master recap and architecture overview 
for the Dynamic Conditions Module of the pilgrimage-platform database. It 
details how tables, translation mechanisms, security policies, API 
considerations, and other database objects interlock, along with a recommended 
build order for successful deployment. 1\. Executive Summary 
--------------------- This database module, the "Dynamic Conditions Module," is 
designed to manage and disseminate timely, verifiable information about 
warnings, hazards, closures, and advisories for trail segments. It aims to 
enhance pilgrim safety by providing clear, actionable information and to 
streamline content management for regional managers and platform 
administrators. The module features robust lookup tables for warning 
categorization (types, severities, sources) and workflow management, all 
supporting internationalization and including comprehensive audit trails and 
lifecycle management flags. A dedicated view is proposed to simplify public 
access to active warnings. 2\. Module-Level Snapshot ------------------------- 
| Module | Key Tables | Primary Purpose | Top Inter-Module Links | | 5\. 
Dynamic Conditions Module | `segment_warnings`, `warning_types_master`, 
`warning_severities_master`, `warning_source_types_master`, 
`workflow_statuses_master` | Stores and categorizes trail warnings, managing 
their lifecycle from creation to publication and resolution, ensuring data 
integrity and clarity. | `segments(id)` (Core Trail Hierarchy), `media(id)` 
(User & Content Infrastructure), `auth.users(id)` (Supabase Auth), 
`profiles(id)` (User & Content Infrastructure for audit in master tables), 
`translations` (User & Content Infrastructure). | 3\. Narrative Walkthrough 
------------------------- This module centralizes the management of 
trail-related advisories through a main transactional table and several lookup 
(master) tables: - `warning_types_master` (v2.1): - Defines categories of 
warnings (e.g., 'Trail Damage', 'Natural Hazard'). - Stores `id` (PK), `code` 
(UNIQUE), `display_name` (translatable), `description` (translatable, 
nullable), `icon_identifier` (nullable), `sort_order`, `is_active` (for 
lifecycle), `notes` (nullable), and standard audit columns (`created_at`, 
`updated_at`, `created_by_profile_id`, `updated_by_profile_id`). - Ensures 
consistent warning categorization and supports UI elements like icons and 
sorted dropdowns. - `warning_severities_master` (v2.1): - Defines the 
seriousness of warnings (e.g., 'Low Caution', 'Critical Closure'). - Includes 
`id` (PK), `code` (UNIQUE), `display_name` (translatable), `description` 
(translatable, nullable), `ui_color_hex` (for UI styling), `sort_order`, 
`is_active` (for lifecycle), `notes` (nullable), and standard audit columns 
(`created_at`, `updated_at`, `created_by_profile_id`, `updated_by_profile_id`). 
- Allows for visual distinction and prioritization of warnings. - 
`warning_source_types_master` (v2.1): - Catalogues the originators of warning 
information (e.g., 'Official Authority', 'User Report'). - Contains `id` (PK), 
`code` (UNIQUE), `display_name` (translatable), `description` (translatable, 
nullable), `default_trust_level` (nullable integer 1-5), `sort_order`, 
`is_active` (for lifecycle), `notes` (nullable), and standard audit columns 
(`created_at`, `updated_at`, `created_by_profile_id`, `updated_by_profile_id`). 
- Aids in assessing the credibility of warnings. - `workflow_statuses_master` 
(v2.1): - Lists defined statuses for content lifecycle (e.g., 'draft', 
'pending_review', 'published'). - Features `code` (PK, text), `display_name` 
(translatable), `description` (translatable, nullable), `sort_order`, 
`is_active` (for lifecycle), and standard audit columns (`created_at`, 
`updated_at`, `created_by_profile_id`, `updated_by_profile_id`). - Manages the 
progression of warnings from creation to public visibility or archival. - 
`segment_warnings` (v2.1): - The core table storing individual warning 
instances. - Links to `segments(id)` via `segment_id` (FK, `ON DELETE 
RESTRICT`). - References `warning_types_master(id)` via `warning_type_id` (FK, 
`ON DELETE RESTRICT`). - References `warning_severities_master(id)` via 
`warning_severity_id` (FK, `ON DELETE RESTRICT`). - Optionally links to 
`warning_source_types_master(id)` via `warning_source_type_id` (FK, `ON DELETE 
RESTRICT`, nullable). - Includes translatable textual fields: `title`, 
`description_message`, `location_on_segment_description`, 
`detour_description_notes`. - Supports an optional PostGIS point geometry 
(`location_on_segment_geom`). - A critical field is `is_currently_active`, a 
boolean generated column based on effective, expected resolution, and actual 
resolution dates. - Links to `auth.users(id)` via `created_by_user_id` (NOT 
NULL, `ON DELETE SET NULL`) and `updated_by_user_id` (nullable, `ON DELETE SET 
NULL`) for user action audit. - Links to an optional primary image via 
`primary_image_media_id` (UUID, FK to `media(id)`, `ON DELETE SET NULL`). - 
Includes a `workflow_status_code` (FK to `workflow_statuses_master(code)`, `ON 
DELETE SET NULL`) to manage its content lifecycle state. - Standard row audit 
timestamps `created_at` and `updated_at` (auto-updated by trigger) are present. 
- `public_active_segment_warnings_view` (v1.0) (Proposed View): - A read-only 
view designed to simplify querying active and published warnings. - Joins 
`segment_warnings` with `warning_types_master`, `warning_severities_master`, 
and `warning_source_types_master` to provide denormalized information like type 
name, severity name, color, icon, etc. - Filters records where 
`segment_warnings.is_currently_active = true` and 
`segment_warnings.workflow_status_code = 'published'` (or equivalent public 
status code), and where related lookup entries are also `is_active = true`. 4\. 
Cross-Cutting Concerns -------------------------- - Users & Roles: - 
`segment_warnings` tracks `created_by_user_id` and `updated_by_user_id` linking 
to `auth.users(id)`. - All `*_master` tables now include 
`created_by_profile_id` and `updated_by_profile_id` linking to `profiles(id)` 
for administrative audit. - RLS policies differentiate access based on user 
roles (e.g., Pilgrim, Regional Content Manager, Platform Administrator). - 
Translations / i18n: - Generic column names (e.g., `title`, `display_name`, 
`description`) are used in all tables for text content intended for 
translation. These columns store the primary reference language text (English). 
- Translations into other languages are managed in the central 
`public.translations` table. - Translatable Fields: - `segment_warnings`: 
`title`, `description_message`, `location_on_segment_description`, 
`detour_description_notes`. - `warning_types_master`: `display_name`, 
`description`. - `warning_severities_master`: `display_name`, `description`. - 
`warning_source_types_master`: `display_name`, `description`. - 
`workflow_statuses_master`: `display_name`, `description`. - Orphaned 
Translation Cleanup: `AFTER DELETE` triggers must be implemented on all parent 
tables with translatable fields (`segment_warnings` and all `*_master` tables 
in this module) to remove corresponding entries from `public.translations`. - 
ENUM & Taxonomy Registry: - All original ENUM types related to warnings 
(`segment_warning_type_enum`, `segment_warning_severity_enum`, 
`segment_warning_source_type_enum`) have been promoted to their respective 
`*_master` lookup tables. This change enhances extensibility, i18n, data 
management, and allows for additional attributes like icons, sort order, and 
active status. - No new database-level `ENUM` types are introduced by this 
module. - Media & Files: - `segment_warnings.primary_image_media_id` (UUID) 
allows linking a warning to a primary image stored in the `public.media` table. 
The relationship is `ON DELETE SET NULL`. - Audit / Soft-Delete / Versioning: - 
Standard Audit Columns: All tables in this module now include `created_at` and 
`updated_at` (with `extensions.moddatetime` or equivalent trigger). - 
`segment_warnings` includes `created_by_user_id` (references `auth.users.id`) 
and `updated_by_user_id` (references `auth.users.id`). - All `*_master` tables 
include `created_by_profile_id` (references `profiles.id`) and 
`updated_by_profile_id` (references `profiles.id`). - Soft Deletes / Lifecycle 
Management: - All `*_master` tables (`warning_types_master`, 
`warning_severities_master`, `warning_source_types_master`, 
`workflow_statuses_master`) now use an `is_active BOOLEAN NOT NULL DEFAULT 
true` column. Retiring an entry involves setting `is_active = false`. - 
`segment_warnings` are deactivated based on its date fields (which drive the 
`is_currently_active` generated column) or can be moved to a terminal 
`workflow_status_code` like 'archived' or 'rejected'. Hard deletion is 
restricted by `segment_id`'s `ON DELETE RESTRICT`. - Versioning: No explicit 
field-level versioning or history tables are included for V2.1. `updated_at` 
provides row-level last modification time. 5\. Security & Access Control üîê 
-------------------------------- - RLS Overview: Row-Level Security policies 
are defined for all tables to control access based on user roles and data 
attributes. - `segment_warnings`: Public/anonymous users can read active and 
published warnings (typically via the proposed view). Regional Content Managers 
have CRUD access for segments they manage, respecting workflow rules. 
Administrators have full access. - `*_master` tables: Authenticated users can 
generally read active entries. Administrators have full CRUD control. - Key 
Helper Functions for RLS (Assumed to exist, defined globally): - 
`public.has_role_on_profile(UUID, TEXT)` or `public.is_admin()`: Checks if the 
current user has specific administrative roles. - 
`public.user_manages_segment(segment_id_to_check BIGINT)`: Checks if the 
current user (likely a Regional Content Manager) is authorized to manage 
warnings for the given segment. - These functions may need to be `SECURITY 
DEFINER` with appropriate hardening if they query tables the calling user 
doesn't directly have grants on. 6\. API Endpoints Summary (Conceptual) 
-------------------------------------- This module provides foundational data 
for pilgrim safety and information. Key conceptual API endpoints derived from 
this module include: - `GET /segments/{segment_id}/warnings`: Retrieves active, 
published warnings for a specific segment. - `POST 
/segments/{segment_id}/warnings`: Allows authorized users to create a new 
warning for a segment. - `GET /warnings/search/geo?bbox={coords}`: Fetches 
active, published warnings within a geographical bounding box. - `GET 
/warnings/{warning_id}`: Retrieves detailed information for a specific warning 
(potentially showing more states for authorized users). - `PATCH 
/warnings/{warning_id}`: Allows authorized users to update an existing warning. 
- `GET /warnings/types`, `GET /warnings/severities`, etc.: List active entries 
from the respective master tables. These endpoints would leverage the 
`public_active_segment_warnings_view` for public read operations to simplify 
queries and ensure consistent data presentation. Translation support via a 
`lang` parameter is expected. 7\. Prerequisite Objects & Build Order ‚öôÔ∏è 
----------------------------------------- Order assumes `auth.users`, 
`public.profiles`, `public.media`, `public.segments`, and `public.translations` 
tables, and global helper functions (`set_current_timestamp_updated_at`, RLS 
helpers, `cleanup_related_translations`) exist. PostGIS extension is required. 
1. Extensions: - `CREATE EXTENSION IF NOT EXISTS postgis;` 2. Master/Lookup 
Tables (Order among these may vary slightly, ensure no circular FK dependencies 
at creation without deferral, or add audit FKs via `ALTER TABLE` after 
`profiles` exists): - `public.warning_types_master` (v2.1) - 
`public.warning_severities_master` (v2.1) - 
`public.warning_source_types_master` (v2.1) - `public.workflow_statuses_master` 
(v2.1) *(DDL for these includes `id` PK, `code`, `display_name`, `description`, 
`sort_order`, `is_active`, `notes`, and audit columns `created_at`, 
`updated_at`, `created_by_profile_id`, `updated_by_profile_id` referencing 
`profiles.id`).* 3. Main Table: - `public.segment_warnings` (v2.1) *(DDL 
includes FKs to all above master tables, `segments`, `media`, `auth.users`).* 
4. Triggers: - Apply `updated_at` triggers to all tables. - Apply `AFTER 
DELETE` orphan translation cleanup triggers (using 
`public.cleanup_related_translations`) to all tables with translatable fields 
(`segment_warnings`, and all `*_master` tables). 5. View: - 
`public.public_active_segment_warnings_view` (v1.0) 6. Indexes: - Apply all 
defined indexes on tables and FKs. 7. RLS Policies: - Enable RLS and apply all 
defined policies to tables and the view. 8. Seed Data: - Populate all 
`*_master` tables with initial agreed-upon values, including new audit columns. 
8\. Performance & Optimization Extras ------------------------------------- - 
Key Indexes: - `segment_warnings`: Composite index on `(is_currently_active, 
workflow_status_code)` for public queries. GIST index on 
`location_on_segment_geom` for spatial queries. Indexes on all FKs. - 
`*_master` tables: Indexes on `(is_active, sort_order)` for UI list population. 
PK (`id` or `code`) and `code` (UNIQUE) are indexed. Audit FKs are indexed. - 
Generated Column: `segment_warnings.is_currently_active` is `STORED`, improving 
read performance for this critical filter. - View for Read Operations: The 
`public_active_segment_warnings_view` is designed to optimize and simplify 
common read queries for active, published warnings. - Partitioning: 
`segment_warnings` is a candidate for future partitioning by date range (e.g., 
on `date_warning_reported`) if volume becomes extremely large, though not a 
V2.1 requirement. 9\. Visuals (Conceptual ERD - Key Tables & Links for this 
Module) ----------------------------------------------------------------- Code 
snippet ``` erDiagram auth_users { uuid id PK } profiles { uuid id PK } 
segments { bigint id PK } media { uuid id PK } translations { bigint id PK text 
table_identifier text column_identifier text row_foreign_key text language_code 
FK } warning_types_master { integer id PK text code UK text display_name 
"Translatable" text description "Translatable, Nullable" text icon_identifier 
"Nullable" integer sort_order boolean is_active "Default true" uuid 
created_by_profile_id FK uuid updated_by_profile_id FK } 
warning_severities_master { integer id PK text code UK text display_name 
"Translatable" text description "Translatable, Nullable" text ui_color_hex 
"Nullable" integer sort_order boolean is_active "Default true" uuid 
created_by_profile_id FK uuid updated_by_profile_id FK } 
warning_source_types_master { integer id PK text code UK text display_name 
"Translatable" text description "Translatable, Nullable" integer 
default_trust_level "Nullable" integer sort_order boolean is_active "Default 
true" uuid created_by_profile_id FK uuid updated_by_profile_id FK } 
workflow_statuses_master { text code PK text display_name "Translatable" text 
description "Translatable, Nullable" integer sort_order boolean is_active 
"Default true" uuid created_by_profile_id FK uuid updated_by_profile_id FK } 
segment_warnings { bigint id PK bigint segment_id FK integer warning_type_id FK 
integer warning_severity_id FK text title "Translatable" text 
description_message "Translatable" text location_on_segment_description 
"Translatable, Nullable" geometry location_on_segment_geom "Nullable" text 
detour_description_notes "Translatable, Nullable" integer 
warning_source_type_id FK "Nullable" timestamptz date_warning_reported boolean 
is_currently_active "Generated" uuid primary_image_media_id FK "Nullable (to 
media.id)" uuid created_by_user_id FK "(to auth_users.id)" uuid 
updated_by_user_id FK "(to auth_users.id), Nullable" text workflow_status_code 
FK "Nullable (to workflow_statuses_master.code)" } segments ||--o{ 
segment_warnings : "warns_about_segment (RESTRICT)" warning_types_master ||--o{ 
segment_warnings : "classifies_as_type (RESTRICT)" warning_severities_master 
||--o{ segment_warnings : "has_severity (RESTRICT)" warning_source_types_master 
||--o{ segment_warnings : "reported_by_source (RESTRICT)" 
workflow_statuses_master ||--o{ segment_warnings : "has_status (SET NULL)" 
media ||--o{ segment_warnings : "primary_image (SET NULL)" auth_users ||--o{ 
segment_warnings : "created_by (SET NULL)" auth_users ||--o{ segment_warnings : 
"updated_by (SET NULL)" warning_types_master }o--o| profiles : 
"audit_created_by" warning_types_master }o--o| profiles : "audit_updated_by" 
warning_types_master ..> translations : "translatable_fields" 
warning_severities_master }o--o| profiles : "audit_created_by" 
warning_severities_master }o--o| profiles : "audit_updated_by" 
warning_severities_master ..> translations : "translatable_fields" 
warning_source_types_master }o--o| profiles : "audit_created_by" 
warning_source_types_master }o--o| profiles : "audit_updated_by" 
warning_source_types_master ..> translations : "translatable_fields" 
workflow_statuses_master }o--o| profiles : "audit_created_by" 
workflow_statuses_master }o--o| profiles : "audit_updated_by" 
workflow_statuses_master ..> translations : "translatable_fields" 
segment_warnings ..> translations : "translatable_fields" ``` 10\. Critical 
Gaps & Risks (Post-V2.1 Refinement) 
------------------------------------------------- - üü† Helper Function 
Implementation: The RLS policies depend heavily on SQL helper functions 
`public.has_role_on_profile(UUID, TEXT)` (or equivalent like `is_admin()`) and 
`public.user_manages_segment(segment_id)`. Their correct, secure, and 
performant implementation is paramount and a prerequisite for effective RLS. 
These need to be `SECURITY DEFINER` with careful `search_path` hardening if 
they query restricted tables. - üü† Orphaned Translation Cleanup Triggers: 
Ensuring `AFTER DELETE` triggers are correctly implemented on *all* 
translatable tables (`segment_warnings` and all `*_master` tables in this 
module) to call `public.cleanup_related_translations()` is critical for data 
integrity. The `cleanup_related_translations()` function itself needs to be 
robust, especially if handling parent tables with non-integer or non-'id' PKs 
(e.g., `workflow_statuses_master.code`). - üü¢ Population Logic for Audit Fields 
(`*_by_profile_id`): For the `*_master` tables, the application layer or 
administrative interfaces must correctly populate `created_by_profile_id` and 
`updated_by_profile_id`. For `segment_warnings`, `created_by_user_id` and 
`updated_by_user_id` will be populated by application logic using `auth.uid()`. 
- üü¢ Default `workflow_status_code`: Consider setting a `DEFAULT` value (e.g., 
'draft') for `segment_warnings.workflow_status_code` to streamline new warning 
creation if most new entries follow a common initial state. - üü¢ Initial Data 
Population Strategy: A clear plan and agreed-upon initial values are needed for 
all lookup tables (`warning_types_master`, `warning_severities_master`, 
`warning_source_types_master`, `workflow_statuses_master`) before deployment. 
This includes assigning appropriate `sort_order` values. 11\. Scalability & 
Future-Proof Notes ------------------------------------- - Lookup Table 
Extensibility: Using dedicated master tables (now with `is_active`, 
`sort_order`, and audit columns) for types, severities, sources, and statuses 
significantly enhances future-proofing and manageability over ENUMs. - Audit 
Trails: Comprehensive audit columns (`created_at`, `updated_at`, 
`created_by/updated_by` user/profile IDs) across all tables provide essential 
traceability. - Lifecycle Management: The `is_active` flag in all master tables 
and the `is_currently_active` / `workflow_status_code` fields in 
`segment_warnings` provide robust lifecycle control. - Internationalization: 
The design supports robust i18n via the central `public.translations` table. - 
Partitioning: `segment_warnings` remains a candidate for partitioning by date 
range if future data volumes become exceptionally large. 12\. Next Steps 
(Module Implementation Focus) --------------------------------------------- - 
P1 üî¥ Implement Helper Functions: Develop, test, and deploy 
`public.has_role_on_profile()` (or equivalent `is_admin()`) and 
`public.user_manages_segment()` ensuring security and performance. - P1 üî¥ 
Implement Global `cleanup_related_translations()`: Ensure this function is 
robust, especially for text-based PKs (like `workflow_statuses_master.code`). - 
P1 ‚öôÔ∏è Execute Full DDL & Triggers: Implement all DDL for tables 
(`warning_types_master`, `warning_severities_master`, 
`warning_source_types_master`, `workflow_statuses_master`, `segment_warnings`) 
and the `public_active_segment_warnings_view` in the correct build order. Apply 
all `updated_at` and translation cleanup triggers. - P1 üß™ Test RLS Policies: 
Thoroughly test all RLS policies with various user roles. - P1 üü¢ Seed Initial 
Data: Populate all `*_master` tables with agreed-upon V1 data, including 
`sort_order` and audit column placeholders where appropriate (e.g., an admin 
system UUID for `created_by_profile_id`). - P2 üü† Define Population Logic for 
Audit Fields: Ensure application layers or admin tools correctly populate 
`created_by_profile_id` / `updated_by_profile_id` on master tables and 
`created_by_user_id` / `updated_by_user_id` on `segment_warnings`. - P2 üü† API 
Development & Testing: Develop and test API endpoints based on the 
conceptualized design. - P2 üü† Define `DEFAULT` for `workflow_status_code`: 
Decide and implement a default for `segment_warnings.workflow_status_code` if 
beneficial. * * * * * 
