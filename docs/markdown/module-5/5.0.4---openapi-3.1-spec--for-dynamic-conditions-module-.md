# 5.0.4 - OpenAPI 3.1 Spec (for Dynamic Conditions Module)

  https://gemini.google.com/u/1/app/951c86a3d09aaadb ### OpenAPI 3.1 Spec (for 
Dynamic Conditions Module) YAML ``` openapi: 3.1.0 info: title: Dynamic 
Conditions Module API version: v1.0 description: API for managing and 
retrieving trail segment warnings and related lookup data. servers: - url: 
https://api.pilgrimage-platform.example.com/v1 description: Production Server - 
url: http://localhost:3000/v1 description: Development Server security: - 
bearerAuth: [] # Global security requirement, can be overridden at operation 
level paths: /segments/{segment_id}/warnings: get: summary: List Active 
Warnings for a Segment operationId: listSegmentWarnings tags: - Segment 
Warnings parameters: - name: segment_id in: path required: true description: ID 
of the trail segment. schema: type: integer format: int64 - name: lang in: 
query description: ISO language code for response localization (e.g., 'it', 
'de'). Affects translatable fields. schema: type: string example: "it" - name: 
page in: query description: Page number for pagination. schema: type: integer 
default: 1 minimum: 1 - name: page_size in: query description: Number of items 
per page. schema: type: integer default: 20 minimum: 1 maximum: 100 responses: 
'200': description: A paginated list of active and published warnings for the 
segment. content: application/json: schema: type: object properties: data: 
type: array items: $ref: '#/components/schemas/SegmentWarning_View_Output' 
pagination: $ref: '#/components/schemas/Pagination' # This endpoint likely uses 
the public_active_segment_warnings_view for efficiency. '404': description: 
Segment not found. content: application/json: schema: $ref: 
'#/components/schemas/ErrorResponse' default: description: Unexpected error. 
content: application/json: schema: $ref: '#/components/schemas/ErrorResponse' 
post: summary: Create a New Warning for a Segment operationId: 
createSegmentWarning tags: - Segment Warnings security: - bearerAuth: 
['manage:warnings'] # Example scope parameters: - name: segment_id in: path 
required: true description: ID of the trail segment for which to create the 
warning. schema: type: integer format: int64 requestBody: required: true 
content: application/json: schema: $ref: 
'#/components/schemas/SegmentWarning_Input' responses: '201': description: 
Segment warning created successfully. content: application/json: schema: $ref: 
'#/components/schemas/SegmentWarning_Detail_Output' '400': description: Invalid 
input data. content: application/json: schema: $ref: 
'#/components/schemas/ErrorResponse' '403': description: Forbidden - user 
cannot create warnings for this segment. content: application/json: schema: 
$ref: '#/components/schemas/ErrorResponse' '404': description: Segment not 
found. content: application/json: schema: $ref: 
'#/components/schemas/ErrorResponse' default: description: Unexpected error. 
content: application/json: schema: $ref: '#/components/schemas/ErrorResponse' 
/warnings/search/geo: get: summary: Search Active Warnings by Geographical Area 
operationId: searchGeoWarnings tags: - Segment Warnings parameters: - name: 
bbox in: query required: true description: Bounding box coordinates as 
'minLng,minLat,maxLng,maxLat'. schema: type: string example: 
"12.0,43.0,12.5,43.5" - name: lang in: query description: ISO language code for 
response localization. schema: type: string - name: min_severity_code in: query 
description: Filter by minimum warning severity code (inclusive, based on 
sort_order). schema: type: string example: "caution_advised" - name: page in: 
query description: Page number. schema: type: integer default: 1 - name: 
page_size in: query description: Items per page. schema: type: integer default: 
50 responses: '200': description: A paginated list of active warnings within 
the geographical area. content: application/json: schema: type: object 
properties: data: type: array items: $ref: 
'#/components/schemas/SegmentWarning_View_Output' pagination: $ref: 
'#/components/schemas/Pagination' # This endpoint uses the 
public_active_segment_warnings_view and a GIST index on 
location_on_segment_geom. default: description: Unexpected error. content: 
application/json: schema: $ref: '#/components/schemas/ErrorResponse' 
/warnings/{warning_id}: get: summary: Get Segment Warning Details operationId: 
getSegmentWarningById tags: - Segment Warnings parameters: - name: warning_id 
in: path required: true description: ID of the segment warning. schema: type: 
integer format: int64 - name: lang in: query description: ISO language code for 
response localization. schema: type: string responses: '200': description: 
Detailed information about the segment warning. content: application/json: 
schema: $ref: '#/components/schemas/SegmentWarning_Detail_Output' '404': 
description: Segment warning not found. content: application/json: schema: 
$ref: '#/components/schemas/ErrorResponse' default: description: Unexpected 
error. content: application/json: schema: $ref: 
'#/components/schemas/ErrorResponse' patch: summary: Update a Segment Warning 
operationId: updateSegmentWarning tags: - Segment Warnings security: - 
bearerAuth: ['manage:warnings'] # Example scope parameters: - name: warning_id 
in: path required: true description: ID of the segment warning to update. 
schema: type: integer format: int64 requestBody: required: true content: 
application/json: schema: $ref: 
'#/components/schemas/SegmentWarning_Update_Input' # Similar to Input, but 
fields optional responses: '200': description: Segment warning updated 
successfully. content: application/json: schema: $ref: 
'#/components/schemas/SegmentWarning_Detail_Output' '400': description: Invalid 
input data. '403': description: Forbidden. '404': description: Segment warning 
not found. default: description: Unexpected error. # --- Lookup Table Endpoints 
(Example for Warning Types) --- /warnings/types: get: summary: List Warning 
Types operationId: listWarningTypes tags: - Warning Configuration parameters: - 
name: lang in: query description: ISO language code for response localization. 
schema: type: string - name: page in: query schema: type: integer default: 1 - 
name: page_size in: query schema: type: integer default: 100 # Typically all 
types are returned - name: is_active in: query description: Filter by active 
status. schema: type: boolean default: true responses: '200': description: A 
list of warning types. content: application/json: schema: type: object 
properties: data: type: array items: $ref: 
'#/components/schemas/WarningTypeMaster' pagination: $ref: 
'#/components/schemas/Pagination' # Pagination might be overkill if list is 
always short default: description: Unexpected error. 
/warnings/types/{type_code}: get: summary: Get Warning Type by Code 
operationId: getWarningTypeByCode tags: - Warning Configuration parameters: - 
name: type_code in: path required: true description: Code of the warning type. 
schema: type: string - name: lang in: query description: ISO language code for 
response localization. schema: type: string responses: '200': description: 
Detailed information about the warning type. content: application/json: schema: 
$ref: '#/components/schemas/WarningTypeMaster' '404': description: Warning type 
not found. default: description: Unexpected error. # Similar GET endpoints 
would exist for /warnings/severities and /warnings/sources, 
/warnings/workflow-statuses components: schemas: Pagination: type: object 
properties: page: type: integer description: Current page number. example: 1 
page_size: type: integer description: Number of items per page. example: 20 
total_items: type: integer description: Total number of items available. 
example: 152 total_pages: type: integer description: Total number of pages. 
example: 8 ErrorResponse: type: object properties: code: type: string 
description: Machine-readable error code. example: "resource_not_found" 
message: type: string description: Human-readable error message. example: "The 
requested segment warning was not found." detail: type: string nullable: true 
description: Optional additional details about the error. example: "Warning ID 
12345 does not exist." # --- Schemas for Dynamic Conditions Module Tables --- 
WarningTypeMaster: type: object properties: id: type: integer readOnly: true 
code: type: string example: "trail_damage_general" display_name: # Base 
language text type: string example: "General Trail Damage" description: # Base 
language text type: string nullable: true example: "General damage to the trail 
surface or structures." icon_identifier: type: string nullable: true example: 
"fas fa-tools" sort_order: type: integer default: 0 is_active: type: boolean 
default: true notes: type: string nullable: true created_at: type: string 
format: date-time readOnly: true updated_at: type: string format: date-time 
readOnly: true created_by_profile_id: type: string format: uuid nullable: true 
readOnly: true updated_by_profile_id: type: string format: uuid nullable: true 
readOnly: true translations: # Populated by API backend based on 'lang' query 
param type: object additionalProperties: type: string example: it: "Danno 
Generale al Sentiero" de: "Allgemeiner Wegschaden" WarningSeverityMaster: # 
Similar to WarningTypeMaster, with ui_color_hex type: object properties: id: { 
type: integer, readOnly: true } code: { type: string, example: 
"caution_advised" } display_name: { type: string, example: "Caution Advised" } 
# Base language description: { type: string, nullable: true, example: "Proceed 
with caution." } # Base language ui_color_hex: { type: string, nullable: true, 
example: "#F1C40F" } sort_order: { type: integer, default: 0 } is_active: { 
type: boolean, default: true } notes: { type: string, nullable: true } 
created_at: { type: string, format: date-time, readOnly: true } updated_at: { 
type: string, format: date-time, readOnly: true } created_by_profile_id: { 
type: string, format: uuid, nullable: true, readOnly: true } 
updated_by_profile_id: { type: string, format: uuid, nullable: true, readOnly: 
true } translations: type: object additionalProperties: { type: string } 
WarningSourceTypeMaster: # Similar to WarningTypeMaster, with 
default_trust_level type: object properties: id: { type: integer, readOnly: 
true } code: { type: string, example: "official_authority" } display_name: { 
type: string, example: "Official Authority" } # Base language description: { 
type: string, nullable: true, example: "Warnings from CAI, Park Authorities, 
etc." } # Base language default_trust_level: { type: integer, nullable: true, 
minimum: 1, maximum: 5 } sort_order: { type: integer, default: 0 } is_active: { 
type: boolean, default: true } notes: { type: string, nullable: true } 
created_at: { type: string, format: date-time, readOnly: true } updated_at: { 
type: string, format: date-time, readOnly: true } created_by_profile_id: { 
type: string, format: uuid, nullable: true, readOnly: true } 
updated_by_profile_id: { type: string, format: uuid, nullable: true, readOnly: 
true } translations: type: object additionalProperties: { type: string } 
WorkflowStatusMaster: type: object properties: code: { type: string, example: 
"published" } display_name: { type: string, example: "Published" } # Base 
language description: { type: string, nullable: true, example: "Content is 
live." } # Base language sort_order: { type: integer, default: 0 } is_active: { 
type: boolean, default: true } created_at: { type: string, format: date-time, 
readOnly: true } updated_at: { type: string, format: date-time, readOnly: true 
} created_by_profile_id: { type: string, format: uuid, nullable: true, 
readOnly: true } updated_by_profile_id: { type: string, format: uuid, nullable: 
true, readOnly: true } translations: type: object additionalProperties: { type: 
string } SegmentWarning_Base: # Common fields for input/output type: object 
properties: title: # Base language text type: string maxLength: 255 example: 
"Minor Landslide near Oak Tree" description_message: # Base language text type: 
string example: "A small landslide has occurred on the path approximately 2.5km 
from the start of the segment, near the old oak tree. Path is still passable 
with caution." location_on_segment_description: # Base language text type: 
string nullable: true example: "Around km 2.5, just after the anbandoned shack" 
location_on_segment_km_approx: type: number format: float nullable: true 
minimum: 0 example: 2.5 location_on_segment_geom: # GeoJSON PointZ or similar 
type: object nullable: true properties: type: { type: string, enum: ["Point"] } 
coordinates: { type: array, items: { type: number }, minItems: 2, maxItems: 3 } 
example: { "type": "Point", "coordinates": [12.345, 43.210, 150.0] } 
detour_information_url: type: string format: url nullable: true example: 
"https://example.com/detours/frana-oak-tree" detour_description_notes: # Base 
language text type: string nullable: true example: "Alternative route is marked 
with yellow signs. Adds approximately 30 minutes." warning_type_id: type: 
integer description: FK to warning_types_master.id warning_severity_id: type: 
integer description: FK to warning_severities_master.id warning_source_type_id: 
type: integer nullable: true description: FK to warning_source_types_master.id 
reported_by_source_detail: type: string maxLength: 500 nullable: true example: 
"Reported by local hiker Giovanni Rossi" date_warning_reported: type: string 
format: date-time example: "2025-05-18T14:30:00Z" date_warning_effective_from: 
type: string format: date-time nullable: true date_warning_expected_resolution: 
type: string format: date-time nullable: true date_warning_resolved_or_expired: 
type: string format: date-time nullable: true admin_verification_notes: type: 
string nullable: true primary_image_media_id: type: string format: uuid 
nullable: true workflow_status_code: # Code from workflow_statuses_master type: 
string nullable: true example: "pending_review" required: - title - 
description_message - warning_type_id - warning_severity_id - 
date_warning_reported # created_by_user_id is usually set by system from auth 
context on POST SegmentWarning_Input: allOf: - $ref: 
'#/components/schemas/SegmentWarning_Base' # No additional properties for input 
beyond base, created_by_user_id is system-set SegmentWarning_Update_Input: # 
For PATCH, all fields are optional type: object properties: # Mirror 
SegmentWarning_Base but all nullable/optional title: { type: string, maxLength: 
255, nullable: true } description_message: { type: string, nullable: true } 
location_on_segment_description: { type: string, nullable: true } 
location_on_segment_km_approx: { type: number, format: float, nullable: true, 
minimum: 0 } location_on_segment_geom: { type: object, nullable: true, 
properties: { type: { type: string, enum: ["Point"] }, coordinates: { type: 
array, items: { type: number }, minItems: 2, maxItems: 3 } } } 
detour_information_url: { type: string, format: url, nullable: true } 
detour_description_notes: { type: string, nullable: true } warning_type_id: { 
type: integer, nullable: true } warning_severity_id: { type: integer, nullable: 
true } warning_source_type_id: { type: integer, nullable: true } 
reported_by_source_detail: { type: string, maxLength: 500, nullable: true } 
date_warning_effective_from: { type: string, format: date-time, nullable: true 
} date_warning_expected_resolution: { type: string, format: date-time, 
nullable: true } date_warning_resolved_or_expired: { type: string, format: 
date-time, nullable: true } admin_verification_notes: { type: string, nullable: 
true } primary_image_media_id: { type: string, format: uuid, nullable: true } 
workflow_status_code: { type: string, nullable: true } 
SegmentWarning_View_Output: # Schema for items from 
public_active_segment_warnings_view type: object properties: warning_id: { 
type: integer, format: int64 } segment_id: { type: integer, format: int64 } 
title: { type: string } # Base language description_message: { type: string } # 
Base language location_on_segment_description: { type: string, nullable: true } 
# Base language location_on_segment_km_approx: { type: number, format: float, 
nullable: true } location_on_segment_geom: { type: object, nullable: true } # 
GeoJSON detour_information_url: { type: string, format: url, nullable: true } 
detour_description_notes: { type: string, nullable: true } # Base language 
date_warning_reported: { type: string, format: date-time } 
date_warning_effective_from: { type: string, format: date-time, nullable: true 
} date_warning_expected_resolution: { type: string, format: date-time, 
nullable: true } warning_type: type: object properties: code: { type: string } 
name: { type: string } # Base language icon_identifier: { type: string, 
nullable: true } warning_severity: type: object properties: code: { type: 
string } name: { type: string } # Base language ui_color_hex: { type: string, 
nullable: true } warning_source_type_name: { type: string, nullable: true } # 
Base language primary_image_media_id: { type: string, format: uuid, nullable: 
true } # primary_image_variants: { type: object, nullable: true } # If API 
provides this structure translations: # Populated by API backend based on 
'lang' query param type: object description: "Key-value pairs where key is 
language code (e.g., 'it') and value is translated string for fields like 
title, description_message etc. Specific fields depend on API implementation." 
additionalProperties: type: string # Or object if translating multiple fields 
example: title: # This example implies 'title' is the key for its translations 
it: "Titolo Frana" description_message: it: "Descrizione frana" # Note: The 
translations object structure needs careful API design. # Alternative: 
top-level translated fields if 'lang' param is used to return one language. 
SegmentWarning_Detail_Output: # Schema for GET /warnings/{id} allOf: - $ref: 
'#/components/schemas/SegmentWarning_Base' properties: id: type: integer 
format: int64 readOnly: true is_currently_active: # Read-only, computed by DB 
type: boolean readOnly: true created_at: type: string format: date-time 
readOnly: true updated_at: type: string format: date-time readOnly: true 
created_by_user_id: # Should be profile ID if aligning with other audit type: 
string format: uuid readOnly: true updated_by_user_id: type: string format: 
uuid nullable: true readOnly: true # Expanded details for FKs warning_type: { 
$ref: '#/components/schemas/WarningTypeMaster' } warning_severity: { $ref: 
'#/components/schemas/WarningSeverityMaster' } warning_source_type: { $ref: 
'#/components/schemas/WarningSourceTypeMaster' , nullable: true } 
workflow_status: { $ref: '#/components/schemas/WorkflowStatusMaster', nullable: 
true } # primary_image: { $ref: '#/components/schemas/MediaItem', nullable: 
true } # If embedding media details translations: # Populated by API backend 
based on 'lang' query param type: object additionalProperties: type: string # 
Or specific object per field example: title: it: "Titolo Frana" 
description_message: it: "Descrizione frana" securitySchemes: bearerAuth: # 
Assumed to be defined globally as per prompt type: http scheme: bearer 
bearerFormat: JWT description: "Supabase JWT token" ``` &lt;hr/> ### 
Quick-Start Examples 1. List active warnings for Segment ID 42 (requesting 
Italian translations) Bash ``` curl -X GET 
"https://api.pilgrimage-platform.example.com/v1/segments/42/warnings?lang=it&pag
e_size=5"\ -H "Authorization: Bearer 
<YOUR_SUPABASE_JWT_OR_ANON_KEY_IF_PUBLIC>"\ -H "apikey: 
<YOUR_SUPABASE_ANON_KEY>" ``` Sample Response (conceptual, paginated): JSON ``` 
{ "data": [ { "warning_id": 101, "segment_id": 42, "title": "Frana Minore", 
"description_message": "Piccola frana sul sentiero...", "warning_type": { 
"code": "hazard_natural_landslide", "name": "Pericolo Naturale - Frana", 
"icon_identifier": "fas fa-mountain-city" }, "warning_severity": { "code": 
"caution_advised", "name": "Cautela Consigliata", "ui_color_hex": "#F1C40F" }, 
"translations": { "title": { "it": "Frana Minore" }, "description_message": { 
"it": "Piccola frana sul sentiero..." } } // ... other fields from 
SegmentWarning_View_Output } ], "pagination": { "page": 1, "page_size": 5, 
"total_items": 1, "total_pages": 1 } } ``` 2. Get details for Warning ID 101 
Bash ``` curl -X GET 
"https://api.pilgrimage-platform.example.com/v1/warnings/101?lang=en"\ -H 
"Authorization: Bearer <YOUR_SUPABASE_JWT_OR_ANON_KEY_IF_PUBLIC>"\ -H "apikey: 
<YOUR_SUPABASE_ANON_KEY>" ``` Sample Response: JSON ``` { "id": 101, 
"segment_id": 42, "title": "Minor Landslide", // Base language or English if 
lang=en "description_message": "Small landslide on path...", 
"is_currently_active": true, "workflow_status_code": "published", 
"warning_type": { "id": 1, "code": "hazard_natural_landslide", "display_name": 
"Landslide Hazard", "is_active": true /* ... */ }, "warning_severity": { "id": 
2, "code": "caution_advised", "display_name": "Caution Advised", 
"ui_color_hex": "#F1C40F", "is_active": true /* ... */ }, // ... other fields 
from SegmentWarning_Detail_Output "translations": { "title": { "en": "Minor 
Landslide" }, // Could be redundant if lang=en and title is already English 
"description_message": { "en": "Small landslide on path..." } } } ``` 3. Create 
a new warning for Segment ID 77 (Regional Manager action) Bash ``` curl -X POST 
"https://api.pilgrimage-platform.example.com/v1/segments/77/warnings"\ -H 
"Authorization: Bearer <MANAGER_JWT_TOKEN>"\ -H "apikey: 
<YOUR_SUPABASE_ANON_KEY>"\ -H "Content-Type: application/json"\ -d '{ "title": 
"Unstable Rocks Reported", "description_message": "Hikers reported unstable 
rocks above the path near the waterfall viewpoint. Assess before proceeding.", 
"warning_type_id": 1, # Assuming ID for 'hazard_natural_rockfall' 
"warning_severity_id": 2, # Assuming ID for 'caution_advised' 
"date_warning_reported": "2025-05-19T11:00:00Z", 
"location_on_segment_km_approx": 3.1, "workflow_status_code": "pending_review" 
}' ``` Sample Response (201 Created): JSON ``` { "id": 106, // New warning_id 
"segment_id": 77, "title": "Unstable Rocks Reported", "description_message": 
"Hikers reported unstable rocks...", "created_by_user_id": 
"<manager_user_uuid>", // Set by backend "workflow_status_code": 
"pending_review", // ... other fields from SegmentWarning_Detail_Output 
"warning_type": { /* ... */ }, "warning_severity": { /* ... */ } } ``` &lt;hr/> 
### Implementation Notes - 🟢 Schema OK: The current database schema for the 
"Dynamic Conditions Module," including the tables (`segment_warnings`, 
`warning_types_master`, `warning_severities_master`, 
`warning_source_types_master`, `workflow_statuses_master`) and the proposed 
`public_active_segment_warnings_view`, appears sufficient to support these core 
API endpoints. - Key Database Objects for API Efficiency: - 
`public_active_segment_warnings_view`: This view is critical for the `GET 
/segments/{segment_id}/warnings` and `GET /warnings/search/geo` endpoints. It 
pre-joins and pre-filters data, simplifying API logic and improving readability 
of queries. - *Enhancement to View*: Ensure the view includes 
`warning_severities_master.sort_order AS warning_severity_sort_order` to 
efficiently support filtering by minimum severity on the geo search endpoint. - 
*Enhancement to View (Optional)*: Consider adding `media.image_variants_json` 
directly to the view if frequently requested by clients with warnings. - GIST 
Index on `segment_warnings.location_on_segment_geom`: Essential for the 
performance of `GET /warnings/search/geo`. - Composite Index on 
`segment_warnings(is_currently_active, workflow_status_code)`: 
(`idx_segment_warnings_is_currently_active_published`) Vital for quickly 
finding publicly visible warnings. - Indexes on Foreign Keys: All FKs in 
`segment_warnings` (to `segment_id`, `warning_type_id`, `warning_severity_id`, 
etc.) should be indexed, which was part of their table specs. - Translation 
Handling: - The API backend will be responsible for fetching translations from 
the `public.translations` table based on the `lang` query parameter and the 
primary reference language text from the view or base tables. The OpenAPI 
schema reflects this by showing a base language field (e.g., `title`) and a 
`translations` object. - An efficient index on `public.translations 
(table_identifier, column_identifier, row_foreign_key, language_code)` is 
crucial. - Write Operations (POST, PATCH): - These will operate directly on the 
`public.segment_warnings` table. - RLS policies on `segment_warnings` will 
enforce permissions (e.g., only regional managers for their segments, or 
admins). - The `created_by_user_id` (and `updated_by_user_id`) will be set by 
the backend based on the authenticated user's ID (`auth.uid()`). - Complexity & 
Performance: - Read endpoints leveraging the view should be performant for most 
use cases. - Write endpoints are straightforward inserts/updates to a single 
table. - The main complexity lies in the API backend's logic for assembling 
translations if not handled by a more advanced database function/procedure. No 
🔴 critical schema tweaks are required for this module to support the 
conceptualized API endpoints, assuming the 
`public_active_segment_warnings_view` is implemented and slightly enhanced as 
noted. 
