# 5.1 segment_warnings

  
https://gemini.google.com/u/1/app/f406710aca31cc25?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/951c86a3d09aaadb ### 3\. Updated 
Production-Ready Specification Target Table Name: public.segment_warnings 
Version: 2.1 (Checklist REV 05-18-25-A Applied) Date: May 18, 2025 1. Purpose & 
Primary Use-Cases - Mission Statement: Stores dynamic, timely, and verifiable 
information about warnings, hazards, closures, or important advisories 
applicable to specific trail segments. It enables pilgrims to make safe and 
informed decisions by linking to standardized types, severities, sources, 
workflow statuses, and relevant media, with audit trails for modifications. - 
Key User-Story Touchpoints: - Pilgrim (Anna): Views active, published warnings 
with clear details on maps and segment pages. - Regional Content Manager 
(Sofia): Creates, updates, and manages the lifecycle of warnings for segments 
in her assigned region, attributing actions to her user ID. - Platform 
Administrator (Admin Team): Oversees all warning data, manages review and 
publication workflows, ensuring quality and consistency. 2. Schema | Column | 
Data Type | Constraints | Description | | :---------------------------------- | 
:---------------------- | 
:-------------------------------------------------------------------------------
---------------------------------------------------------------------- | 
:-------------------------------------------------------------------------------
--------------------------------------------------------------------------------
----- | | id | bigint | Primary Key, Generated always as identity | Unique 
identifier for each warning record. | | segment_id | bigint | Foreign Key to 
segments(id) ON DELETE RESTRICT, Not Null | The specific segment this warning 
applies to. | | warning_type_id | integer | Foreign Key to 
warning_types_master(id) ON DELETE RESTRICT, Not Null | Category of the 
warning. Links to warning_types_master. | | warning_severity_id | integer | 
Foreign Key to warning_severities_master(id) ON DELETE RESTRICT, Not Null | 
Seriousness of the warning. Links to warning_severities_master. | | title | 
text | Not Null, CHECK (length(title) <= 255) | Concise headline in the primary 
reference language (English). (Translatable via public.translations). Max 255 
chars. | | description_message | text | Not Null | Detailed description in the 
primary reference language (English). (Translatable via public.translations). | 
| location_on_segment_description | text | Nullable | Textual location 
description (English). (Translatable via public.translations). | | 
location_on_segment_km_approx | real | Nullable, CHECK 
(location_on_segment_km_approx >= 0 OR location_on_segment_km_approx IS NULL) | 
Approximate kilometer marker from segment start. | | location_on_segment_geom | 
geometry(PointZ,4326) | Nullable | Optional PostGIS PointZ pinpointing the 
warning. | | detour_information_url | text | Nullable, CHECK 
(detour_information_url ~* '^https?://' OR detour_information_url IS NULL) | 
URL to official detour map or information. | | detour_description_notes | text 
| Nullable | Detour notes (English). (Translatable via public.translations). | 
| warning_source_type_id | integer | Foreign Key to 
warning_source_types_master(id) ON DELETE RESTRICT, Nullable | The source of 
the warning information. Links to warning_source_types_master. | | 
reported_by_source_detail | text | Nullable, CHECK 
(length(reported_by_source_detail) <= 500) | Specifics of the source (e.g., 
"Comune di Chiusi della Verna"). Max 500 chars. | | date_warning_reported | 
timestamptz | Not Null, Default now() | When the warning was first 
reported/entered. | | date_warning_effective_from | timestamptz | Nullable | 
When the warning condition starts/started. If NULL, assumed from 
date_warning_reported. | | date_warning_expected_resolution | timestamptz | 
Nullable | Estimated date/time of resolution. | | 
date_warning_resolved_or_expired | timestamptz | Nullable | Actual date/time 
warning was resolved/expired. | | is_currently_active | boolean | Not Null, 
Generated Always AS (date_warning_resolved_or_expired IS NULL AND 
(date_warning_effective_from IS NULL OR date_warning_effective_from &lt;= 
NOW()) AND (date_warning_expected_resolution IS NULL OR 
date_warning_expected_resolution >= NOW())) STORED | Computed: Indicates if the 
warning is currently active based on dates. | | admin_verification_notes | text 
| Nullable | Internal notes from administrators/moderators. | | 
primary_image_media_id | uuid | Foreign Key to media(id) ON DELETE SET NULL, 
Nullable | Link to a primary image in media table (UUID). | | 
created_by_user_id | uuid | Foreign Key to auth.users(id) ON DELETE SET NULL, 
Not Null | User (from auth.users table) who created the warning. | | 
updated_by_user_id | uuid | Foreign Key to auth.users(id) ON DELETE SET NULL, 
Nullable | User (from auth.users table) who last updated the warning. | | 
created_at | timestamptz | Not Null, Default now() | Timestamp of record 
creation. | | updated_at | timestamptz | Not Null, Default now() | Timestamp of 
last update (auto-updated by trigger). | | workflow_status_code | text | 
Nullable, Foreign Key to workflow_statuses_master(code) ON DELETE SET NULL | 
Workflow status (e.g., 'draft', 'published'). Links to 
workflow_statuses_master. Consider DEFAULT 'draft'. | 3. PostgreSQL DDL SQL ``` 
-- Ensure PostGIS extension is enabled if not already -- CREATE EXTENSION IF 
NOT EXISTS postgis; -- Ensure master tables (segments, media, auth.users, 
warning_types_master, etc.) exist. -- Ensure 
public.set_current_timestamp_updated_at() function exists. CREATE TABLE 
public.segment_warnings ( id bigint GENERATED ALWAYS AS IDENTITY PRIMARY KEY, 
segment_id bigint NOT NULL REFERENCES public.segments(id) ON DELETE RESTRICT, 
warning_type_id integer NOT NULL REFERENCES public.warning_types_master(id) ON 
DELETE RESTRICT, warning_severity_id integer NOT NULL REFERENCES 
public.warning_severities_master(id) ON DELETE RESTRICT, title text NOT NULL 
CHECK (length(title) <= 255), description_message text NOT NULL, 
location_on_segment_description text NULL, location_on_segment_km_approx real 
NULL CHECK (location_on_segment_km_approx >= 0 OR location_on_segment_km_approx 
IS NULL), location_on_segment_geom public.geometry(PointZ, 4326) NULL, 
detour_information_url text NULL CHECK (detour_information_url ~* '^https?://' 
OR detour_information_url IS NULL), detour_description_notes text NULL, 
warning_source_type_id integer NULL REFERENCES 
public.warning_source_types_master(id) ON DELETE RESTRICT, 
reported_by_source_detail text NULL CHECK (length(reported_by_source_detail) <= 
500), date_warning_reported timestamptz NOT NULL DEFAULT now(), 
date_warning_effective_from timestamptz NULL, date_warning_expected_resolution 
timestamptz NULL, date_warning_resolved_or_expired timestamptz NULL, 
is_currently_active boolean NOT NULL GENERATED ALWAYS AS ( 
date_warning_resolved_or_expired IS NULL AND (date_warning_effective_from IS 
NULL OR date_warning_effective_from <= NOW()) AND 
(date_warning_expected_resolution IS NULL OR date_warning_expected_resolution 
>= NOW()) ) STORED, admin_verification_notes text NULL, primary_image_media_id 
UUID NULL REFERENCES public.media(id) ON DELETE SET NULL, -- Corrected to UUID 
created_by_user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE SET NULL, 
updated_by_user_id uuid NULL REFERENCES auth.users(id) ON DELETE SET NULL, 
created_at timestamptz NOT NULL DEFAULT now(), updated_at timestamptz NOT NULL 
DEFAULT now(), workflow_status_code text NULL REFERENCES 
public.workflow_statuses_master(code) ON DELETE SET NULL -- Consider: 
CONSTRAINT segment_warnings_workflow_status_code_default DEFAULT 'draft' ); 
COMMENT ON TABLE public.segment_warnings IS 'Stores specific warnings, alerts, 
hazards, or advisories applicable to a trail segment, referencing master tables 
for types, severities, sources, and workflow statuses. Version 2.1.'; COMMENT 
ON COLUMN public.segment_warnings.segment_id IS 'The specific segment this 
warning applies to. Deletion of a segment is restricted if warnings exist.'; 
COMMENT ON COLUMN public.segment_warnings.warning_type_id IS 'Category of the 
warning. FK to warning_types_master.id. Deletion of type restricted if in 
use.'; COMMENT ON COLUMN public.segment_warnings.warning_severity_id IS 
'Seriousness of the warning. FK to warning_severities_master.id. Deletion of 
severity restricted if in use.'; COMMENT ON COLUMN 
public.segment_warnings.title IS 'Concise headline in the primary reference 
language (English). (Translatable via public.translations).'; COMMENT ON COLUMN 
public.segment_warnings.description_message IS 'Detailed description in the 
primary reference language (English). (Translatable via public.translations).'; 
COMMENT ON COLUMN public.segment_warnings.location_on_segment_description IS 
'Textual description of location on segment (English). (Translatable via 
public.translations).'; COMMENT ON COLUMN 
public.segment_warnings.detour_description_notes IS 'Textual notes describing 
any known detour (English). (Translatable via public.translations).'; COMMENT 
ON COLUMN public.segment_warnings.warning_source_type_id IS 'The source of the 
warning information. FK to warning_source_types_master.id. Deletion of source 
type restricted if in use.'; COMMENT ON COLUMN 
public.segment_warnings.is_currently_active IS 'Computed (STORED): True if 
warning is considered active based on effective, expected resolution, and 
actual resolution dates.'; COMMENT ON COLUMN 
public.segment_warnings.primary_image_media_id IS 'Link to a primary image in 
the media table (media.id is UUID). Image is not deleted if warning is deleted; 
warning retains image if media entry is deleted (SET NULL).'; COMMENT ON COLUMN 
public.segment_warnings.created_by_user_id IS 'User (from auth.users table) who 
created the warning record. Record retained if user deleted (SET NULL).'; 
COMMENT ON COLUMN public.segment_warnings.updated_by_user_id IS 'User (from 
auth.users table) who last updated the warning record. Record retained if user 
deleted (SET NULL).'; COMMENT ON COLUMN 
public.segment_warnings.workflow_status_code IS 'Workflow status of the warning 
(e.g., draft, pending_review, published). Links to 
workflow_statuses_master.code. Warning retains NULL status if master status is 
deleted.'; -- Indexes CREATE INDEX IF NOT EXISTS 
idx_segment_warnings_segment_id ON public.segment_warnings(segment_id); CREATE 
INDEX IF NOT EXISTS idx_segment_warnings_is_currently_active_published ON 
public.segment_warnings(is_currently_active, workflow_status_code) WHERE 
is_currently_active = true AND workflow_status_code = 'published'; CREATE INDEX 
IF NOT EXISTS idx_segment_warnings_warning_type_id ON 
public.segment_warnings(warning_type_id); CREATE INDEX IF NOT EXISTS 
idx_segment_warnings_warning_severity_id ON 
public.segment_warnings(warning_severity_id); CREATE INDEX IF NOT EXISTS 
idx_segment_warnings_warning_source_type_id ON 
public.segment_warnings(warning_source_type_id); CREATE INDEX IF NOT EXISTS 
idx_segment_warnings_created_by_user_id ON 
public.segment_warnings(created_by_user_id); CREATE INDEX IF NOT EXISTS 
idx_segment_warnings_workflow_status_code ON 
public.segment_warnings(workflow_status_code); CREATE INDEX IF NOT EXISTS 
idx_segment_warnings_location_geom ON public.segment_warnings USING GIST 
(location_on_segment_geom); CREATE INDEX IF NOT EXISTS 
idx_segment_warnings_primary_image_media_id ON 
public.segment_warnings(primary_image_media_id) WHERE primary_image_media_id IS 
NOT NULL; ``` 4. Triggers/Functions - `updated_at` Trigger: SQL ``` CREATE 
TRIGGER set_segment_warnings_updated_at BEFORE UPDATE ON 
public.segment_warnings FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); ``` - Orphaned Translation Cleanup 
Trigger Function (Conceptual definition, to be created globally): SQL ``` -- 
CREATE OR REPLACE FUNCTION public.cleanup_related_translations() ... ``` 
*(Actual attachment in Next-Action Checklist)* 5. JSON Schema Mirror JSON ``` { 
"title": "segment_warning", "description": "Stores warnings for trail segments, 
linking to master tables for types, severities, sources, workflows, and media. 
Version 2.1.", "type": "object", "properties": { "id": { "type": "integer", 
"format": "int64", "description": "PK. Unique identifier.", "readOnly": true }, 
"segment_id": { "type": "integer", "format": "int64", "description": "FK to 
segments.id (ON DELETE RESTRICT)." }, "warning_type_id": { "type": "integer", 
"description": "FK to warning_types_master.id (ON DELETE RESTRICT)." }, 
"warning_severity_id": { "type": "integer", "description": "FK to 
warning_severities_master.id (ON DELETE RESTRICT)." }, "title": { "type": 
"string", "maxLength": 255, "description": "Headline (English). Translatable." 
}, "description_message": { "type": "string", "description": "Detailed 
description (English). Translatable." }, "location_on_segment_description": { 
"type": ["string", "null"], "description": "Textual location description 
(English). Translatable." }, "location_on_segment_km_approx": { "type": 
["number", "null"], "format": "float", "minimum": 0, "description": "Approx. km 
marker." }, "location_on_segment_geom": { "type": ["object", "null"], 
"description": "PostGIS PointZ geometry (SRID 4326)." }, 
"detour_information_url": { "type": ["string", "null"], "format": "url", 
"pattern": "^https?://", "description": "URL for detour info." }, 
"detour_description_notes": { "type": ["string", "null"], "description": 
"Detour notes (English). Translatable." }, "warning_source_type_id": { "type": 
["integer", "null"], "description": "FK to warning_source_types_master.id (ON 
DELETE RESTRICT)." }, "reported_by_source_detail": { "type": ["string", 
"null"], "maxLength": 500, "description": "Specifics of source." }, 
"date_warning_reported": { "type": "string", "format": "date-time", 
"description": "Reported date." }, "date_warning_effective_from": { "type": 
["string", "null"], "format": "date-time", "description": "Effective from 
date." }, "date_warning_expected_resolution": { "type": ["string", "null"], 
"format": "date-time", "description": "Expected resolution date." }, 
"date_warning_resolved_or_expired": { "type": ["string", "null"], "format": 
"date-time", "description": "Actual resolution date." }, "is_currently_active": 
{ "type": "boolean", "description": "Computed: True if currently active.", 
"readOnly": true }, "admin_verification_notes": { "type": ["string", "null"], 
"description": "Internal admin notes." }, "primary_image_media_id": { "type": 
["string", "null"], "format": "uuid", "description": "FK to media.id (UUID) for 
primary image (ON DELETE SET NULL)." }, "created_by_user_id": { "type": 
"string", "format": "uuid", "description": "Creator auth.users.id (ON DELETE 
SET NULL)." }, "updated_by_user_id": { "type": ["string", "null"], "format": 
"uuid", "description": "Last updater auth.users.id (ON DELETE SET NULL)." }, 
"created_at": { "type": "string", "format": "date-time", "description": 
"Creation timestamp.", "readOnly": true }, "updated_at": { "type": "string", 
"format": "date-time", "description": "Last update timestamp.", "readOnly": 
true }, "workflow_status_code": { "type": ["string", "null"], "description": 
"FK to workflow_statuses_master.code (ON DELETE SET NULL)." } }, "required": [ 
"segment_id", "warning_type_id", "warning_severity_id", "title", 
"description_message", "date_warning_reported", "created_by_user_id" ] } ``` 6. 
Relationships & Integrity - Foreign Keys: To `segments`, 
`warning_types_master`, `warning_severities_master`, 
`warning_source_types_master`, `media`, `auth.users`, 
`workflow_statuses_master`. - `ON DELETE RESTRICT` is used for FKs to 
`segments` and lookup masters (`warning_types_master`, 
`warning_severities_master`, `warning_source_types_master`) to maintain 
integrity. - `ON DELETE SET NULL` is used for `media_id`, user IDs, and 
`workflow_status_code` to allow warnings to persist if related optional 
entities are removed or to allow status code changes in the master. 7. 
Multilingual Strategy - Translatable Fields: `title`, `description_message`, 
`location_on_segment_description`, `detour_description_notes`. These store 
primary reference language text (English). - Translation Mechanism: Uses the 
central `public.translations` table. An `AFTER DELETE` trigger on 
`public.segment_warnings` is needed for cleanup. 8. Role-Based Workflow & RLS 
Notes - Creator/Updater IDs: `created_by_user_id`, `updated_by_user_id` 
(referencing `auth.users(id)`). - Visibility/Workflow: `is_currently_active` 
(computed), `workflow_status_code` (FK). - RLS Policies: - 🟢 Public read for 
active & published warnings. - 🟢 Regional Managers: CRUD on warnings in their 
segments, respecting workflow state checks. - 🟢 Administrators: Full access. 
*(Requires helper functions `user_manages_segment()` and 
`is_admin()`/`has_role_on_profile()`)* 9. ENUM vs Lookup Discussion - 🟢 
Successfully uses FKs to master tables instead of ENUMs for types, severities, 
sources, and statuses. 10. UI/UX Enablement - Filters: `is_currently_active`, 
`workflow_status_code`, FKs to master tables. - Visuals: Data from joined 
lookup tables (`icon_identifier`, `ui_color_hex`), `primary_image_media_id`. - 
Performance: `is_currently_active` (STORED), comprehensive indexing. 11. 
Auditing & Lifecycle Management - Audit Columns: `created_at`, `updated_at`, 
`created_by_user_id`, `updated_by_user_id`. - Lifecycle: Managed by 
`is_currently_active` (date-driven) and `workflow_status_code`. 12. Scalability 
& Future-Proofing - Scalability: Uses `bigint` PK. Lookup tables enhance 
maintainability. - Partitioning: Partitioning `segment_warnings` (e.g., by 
`date_warning_reported`) is a potential future optimization if the table grows 
extremely large. - Future-Proofing: Structure is extensible. 13. Seed Data - ⚪ 
N/A - Transactional data. 14. Next-Action Checklist - 🔴 Ensure all 
prerequisite tables and functions (esp. RLS helpers `user_manages_segment`, 
`is_admin`/`has_role_on_profile`, `set_current_timestamp_updated_at`, 
`cleanup_related_translations`) exist. - 🔴 Implement DDL: Execute `CREATE 
TABLE` for `public.segment_warnings`. - 🔴 Apply `updated_at` Trigger. - 🔴 
Create Indexes as defined. - 🔴 Implement Orphaned Translation Cleanup Trigger: 
After `public.translations` table exists, create and apply 
`trigger_cleanup_segment_warnings_translations` using 
`public.cleanup_related_translations()` on this table. - 🟠 Decide and 
implement `DEFAULT` for `workflow_status_code` if desired (e.g., 'draft'). - 🟠 
Thoroughly test RLS policies with various user roles and workflow transitions. 
- 🟢 Plan data migration if existing warning data needs to be imported. 
