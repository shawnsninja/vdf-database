# 5.5 workflow_statuses_master

  https://gemini.google.com/u/1/app/951c86a3d09aaadb ### 3\. Updated 
Production-Ready Specification Target Table Name: 
public.workflow_statuses_master Version: 2.1 (Checklist REV 05-18-25-A Applied) 
Date: May 18, 2025 1. Purpose & Primary Use-Cases - Mission Statement: Defines 
a standardized, lifecycle-managed set of workflow statuses (e.g., 'draft', 
'pending_review', 'published') applicable to content entities like 
`segment_warnings`. It facilitates content moderation, lifecycle tracking, 
controlled visibility, and includes administrative audit trails. - Key 
User-Story Touchpoints (Indirect): - Pilgrim (Anna): Sees content (e.g., 
`segment_warnings`) that has achieved a public-facing status like 'published'. 
- Regional Content Manager (Sofia): Submits content which may transition 
through statuses like 'pending_review'. - Platform Administrator (Admin Team): 
Manages content review pipelines using these statuses. 2. Schema | Column | 
Data Type | Constraints | Description | | :------------------------ | 
:------------ | 
:-------------------------------------------------------------------------------
-------------------------- | 
:-------------------------------------------------------------------------------
--------------------------------------------------------- | | code | text | 
Primary Key, CHECK (length(code) <= 50 AND code ~ '^[a-z0-9_]+$') | Short, 
unique, machine-readable code for the status (e.g., 'draft'). Max 50 chars. | | 
display_name | text | Not Null, CHECK (length(display_name) <= 255) | Default 
display name in the primary reference language (English). (Translatable via 
public.translations). Max 255 chars. | | description | text | Nullable | 
Optional longer description (English). (Translatable via public.translations). 
| | sort_order | integer | Not Null, Default 0 | Defines display/priority order 
in UIs (e.g., for workflow progression). | | is_active | boolean | Not Null, 
Default true | If true, status is active and selectable. Set to false to 
retire. | | created_at | timestamptz | Not Null, Default now() | Timestamp of 
record creation. | | updated_at | timestamptz | Not Null, Default now() | 
Timestamp of last record update (auto-updated). | | created_by_profile_id | 
uuid | Nullable, Foreign Key to public.profiles(id) ON DELETE SET NULL | 
Profile ID of the admin who created the record. | | updated_by_profile_id | 
uuid | Nullable, Foreign Key to public.profiles(id) ON DELETE SET NULL | 
Profile ID of the admin who last updated the record. | 3. PostgreSQL DDL SQL 
``` CREATE TABLE public.workflow_statuses_master ( code text PRIMARY KEY CHECK 
(length(code) <= 50 AND code ~ '^[a-z0-9_]+$'), display_name text NOT NULL 
CHECK (length(display_name) <= 255), description text NULL, sort_order integer 
NOT NULL DEFAULT 0, is_active boolean NOT NULL DEFAULT true, -- Added for 
consistency created_at timestamptz NOT NULL DEFAULT now(), updated_at 
timestamptz NOT NULL DEFAULT now(), created_by_profile_id UUID REFERENCES 
public.profiles(id) ON DELETE SET NULL, updated_by_profile_id UUID REFERENCES 
public.profiles(id) ON DELETE SET NULL ); COMMENT ON TABLE 
public.workflow_statuses_master IS 'Master list of predefined workflow statuses 
for content lifecycle management (e.g., draft, pending_review, published), with 
active flag and audit fields. Version 2.1.'; COMMENT ON COLUMN 
public.workflow_statuses_master.code IS 'Primary Key. Short, unique, 
machine-readable code for the status (e.g., ''pending_review''). Recommended: 
snake_case, lowercase.'; COMMENT ON COLUMN 
public.workflow_statuses_master.display_name IS 'Default display name in the 
primary reference language (English). (Translatable via public.translations).'; 
COMMENT ON COLUMN public.workflow_statuses_master.description IS 'Optional 
longer description in the primary reference language (English), explaining the 
status. (Translatable via public.translations).'; COMMENT ON COLUMN 
public.workflow_statuses_master.sort_order IS 'Defines the order for display or 
logical flow of statuses (e.g., 0 for earliest, 100 for final).'; COMMENT ON 
COLUMN public.workflow_statuses_master.is_active IS 'Indicates if the workflow 
status is active and available for assignment (default true). Set to false to 
retire a status from new assignments.'; COMMENT ON COLUMN 
public.workflow_statuses_master.created_at IS 'Timestamp of when this status 
record was created.'; COMMENT ON COLUMN 
public.workflow_statuses_master.updated_at IS 'Timestamp of when this status 
record was last updated (auto-updated by trigger).'; COMMENT ON COLUMN 
public.workflow_statuses_master.created_by_profile_id IS 'Profile ID of the 
administrator who created this status. FK to public.profiles(id).'; COMMENT ON 
COLUMN public.workflow_statuses_master.updated_by_profile_id IS 'Profile ID of 
the administrator who last updated this status. FK to public.profiles(id).'; -- 
Indexes CREATE INDEX ix_workflow_statuses_master_active_sort_order ON 
public.workflow_statuses_master (is_active, sort_order); CREATE INDEX 
ix_workflow_statuses_master_created_by_profile_id ON 
public.workflow_statuses_master (created_by_profile_id) WHERE 
created_by_profile_id IS NOT NULL; CREATE INDEX 
ix_workflow_statuses_master_updated_by_profile_id ON 
public.workflow_statuses_master (updated_by_profile_id) WHERE 
updated_by_profile_id IS NOT NULL; ``` 4. Triggers/Functions - `updated_at` 
Trigger: SQL ``` -- Assumes public.set_current_timestamp_updated_at() function 
is created globally. CREATE TRIGGER set_workflow_statuses_master_updated_at 
BEFORE UPDATE ON public.workflow_statuses_master FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); ``` - Orphaned Translation Cleanup 
Trigger Function (Conceptual definition, to be created globally): SQL ``` -- 
CREATE OR REPLACE FUNCTION public.cleanup_related_translations() -- RETURNS 
TRIGGER AS $$ -- BEGIN -- DELETE FROM public.translations -- WHERE 
table_identifier = TG_TABLE_NAME::text -- AND row_foreign_key = OLD.code; -- 
Uses OLD.code as PK is 'code' -- RETURN OLD; -- END; -- $$ LANGUAGE plpgsql 
SECURITY DEFINER; ``` *(Actual attachment in Next-Action Checklist. The global 
function might need adjustment or a specific version if it assumes PK is always 
`id`.)* 5. JSON Schema Mirror JSON ``` { "title": "workflow_status_master", 
"description": "Defines a standardized workflow status for content lifecycle, 
with active flag and audit fields. Version 2.1.", "type": "object", 
"properties": { "code": { "type": "string", "description": "PK. Unique 
machine-readable code (snake_case).", "maxLength": 50, "pattern": 
"^[a-z0-9_]+$" }, "display_name": { "type": "string", "description": "Default 
display name (English). Translatable.", "maxLength": 255 }, "description": { 
"type": ["string", "null"], "description": "Optional description (English). 
Translatable." }, "sort_order": { "type": "integer", "description": "UI 
display/flow order.", "default": 0 }, "is_active": { "type": "boolean", 
"description": "True if status is active and assignable.", "default": true }, 
"created_at": { "type": "string", "format": "date-time", "description": 
"Creation timestamp.", "readOnly": true }, "updated_at": { "type": "string", 
"format": "date-time", "description": "Last update timestamp.", "readOnly": 
true }, "created_by_profile_id": { "type": ["string", "null"], "format": 
"uuid", "description": "Profile ID of creator." }, "updated_by_profile_id": { 
"type": ["string", "null"], "format": "uuid", "description": "Profile ID of 
last updater." } }, "required": [ "code", "display_name", "sort_order", 
"is_active" ] } ``` 6. Relationships & Integrity - This is a master data table. 
PK is `code`. - Referenced by `segment_warnings.workflow_status_code` (FK) and 
potentially other content tables. - `ON DELETE RESTRICT` is implicitly 
appropriate for FKs from content tables referencing this table. An active 
status in use should not be deletable. Use `is_active = false` to retire a 
status from being newly assigned. - Foreign keys `created_by_profile_id` and 
`updated_by_profile_id` reference `public.profiles(id) ON DELETE SET NULL`. 7. 
Multilingual Strategy - Translatable Fields: `display_name`, `description`. 
These store primary reference language text (English). - Translation Mechanism: 
Uses `public.translations`. `AFTER DELETE` trigger needed for cleanup. The 
`row_foreign_key` in `translations` will store `workflow_statuses_master.code`. 
8. Role-Based Workflow & RLS Notes - Management: Primarily by Platform 
Administrators. Changes are significant. - RLS Policies: - ðŸŸ¢ Authenticated 
users can read active statuses: SQL ``` CREATE POLICY 
"select_active_workflow_statuses_for_authenticated" ON 
public.workflow_statuses_master FOR SELECT TO authenticated USING (is_active = 
true); ``` - ðŸŸ¢ Platform Administrators have full control: SQL ``` CREATE 
POLICY "admin_all_access_on_workflow_statuses_master" ON 
public.workflow_statuses_master FOR ALL USING 
(public.has_role_on_profile(auth.uid(), 'admin_platform')) -- Example admin 
role WITH CHECK (public.has_role_on_profile(auth.uid(), 'admin_platform')); ``` 
*(Assumes `public.has_role_on_profile(UUID, TEXT)` helper function exists)* 9. 
ENUM vs Lookup Discussion - ðŸŸ¢ Correctly a lookup table. Preferred for 
extensibility, i18n, data management, and dynamic use in application logic. 10. 
UI/UX Enablement - Admin UI: `display_name` (translated) populates dropdowns 
for status assignment, ordered by `sort_order`, filtered by `is_active = true`. 
- Content Systems: Used to filter content queues (e.g., "items pending 
review"). 11. Auditing & Lifecycle Management - Audit Columns: `created_at`, 
`updated_at`, `created_by_profile_id`, `updated_by_profile_id`. - Lifecycle: 
Managed by `is_active` flag. Retiring a status involves setting `is_active = 
false`. 12. Scalability & Future-Proofing - Audit Columns: Implemented. - 
Stability: Workflow statuses are typically stable. - Generic Use: Can be 
referenced by any other table needing content workflow. 13. Seed Data (V1 
Example) SQL ``` INSERT INTO public.workflow_statuses_master (code, 
display_name, description, sort_order, is_active, created_by_profile_id, 
updated_by_profile_id) VALUES ('draft', 'Draft', 'Content is being prepared and 
is not visible publicly or for review.', 10, true, '[ADMIN_PROFILE_UUID]', 
'[ADMIN_PROFILE_UUID]'), ('pending_review', 'Pending Review', 'Content has been 
submitted and is awaiting review by a moderator or administrator.', 20, true, 
'[ADMIN_PROFILE_UUID]', '[ADMIN_PROFILE_UUID]'), ('published', 'Published', 
'Content has been approved and is visible to the relevant audience (e.g., 
public).', 40, true, '[ADMIN_PROFILE_UUID]', '[ADMIN_PROFILE_UUID]'), 
('needs_revision', 'Needs Revision', 'Content has been reviewed and requires 
changes by the author before it can be published.', 30, true, 
'[ADMIN_PROFILE_UUID]', '[ADMIN_PROFILE_UUID]'), ('archived', 'Archived', 
'Content is no longer current or actively displayed but is retained for 
historical purposes.', 50, true, '[ADMIN_PROFILE_UUID]', 
'[ADMIN_PROFILE_UUID]'), ('rejected', 'Rejected', 'Content was reviewed but 
deemed unsuitable for publication.', 60, true, '[ADMIN_PROFILE_UUID]', 
'[ADMIN_PROFILE_UUID]'), ('internal_use_only', 'Internal Use Only', 'Content is 
for internal platform use and not for public display.', 5, false, 
'[ADMIN_PROFILE_UUID]', '[ADMIN_PROFILE_UUID]'); -- Replace 
[ADMIN_PROFILE_UUID] with an actual admin user's profile_id ``` 14. Next-Action 
Checklist - ðŸ”´ Ensure `public.profiles` table exists before running DDL for FK 
constraints. - ðŸ”´ Ensure RLS helper `public.has_role_on_profile(UUID, TEXT)` 
exists and is SECURITY DEFINER hardened if necessary. - ðŸ”´ Ensure 
`public.set_current_timestamp_updated_at()` function exists. - ðŸ”´ Ensure 
`public.cleanup_related_translations()` function is robust enough to handle 
text PKs (like `code` here) or a specific version is made. - ðŸ”´ Implement DDL: 
Execute `CREATE TABLE` for `public.workflow_statuses_master`. - ðŸ”´ Apply 
`updated_at` Trigger. - ðŸ”´ Create Indexes as defined. - ðŸ”´ Implement Orphaned 
Translation Cleanup Trigger: After `public.translations` table exists, create 
`trigger_cleanup_workflow_statuses_translations` using 
`public.cleanup_related_translations()` (adapted for text PK `code`) on this 
table. - ðŸ”´ Populate Initial Seed Data, replacing `[ADMIN_PROFILE_UUID]` with a 
valid `profiles.id`. - ðŸŸ¢ Review initial status definitions (`code`, 
`display_name`, `sort_order`, `is_active`) with stakeholders. - ðŸŸ¢ Plan 
administrative interface for managing these statuses (likely infrequent changes 
after setup). 
