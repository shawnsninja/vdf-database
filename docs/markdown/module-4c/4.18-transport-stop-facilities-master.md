# 4.18 transport_stop_facilities_master

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/980a7af1dc7f079a 
https://gemini.google.com/u/1/app/b90970622259e225 * * * * * ### 3\. Updated 
Production-Ready Specification - `public.transport_stop_facilities_master` 
(V2.1) Version: 2.1 (Based on original V1.1, V2.1 Checklist REV 05-18-25-A 
applied) Date: May 18, 2025 1. Purpose & Primary Use-Cases The 
transport_stop_facilities_master table lists various facilities and amenities 
that might be available at or immediately near a public transportation stop 
(e.g., "Toilets Available," "Ticket Office," "Waiting Room," "Wi-Fi"). Its 
purpose is to allow standardized tagging of stop facilities, enabling pilgrims 
to identify stops with useful amenities, and to support multilingual display 
and icon association for these facilities. Key user-story touchpoints include 
pilgrims checking for essential facilities, filtering for specific amenities, 
administrators tagging stops, and the system/UI displaying icons and facility 
lists. 2. Schema | column | data_type | constraints | description | | 
:---------------------- | :------------------------ | 
:-------------------------------------------------------------------------------
--------------------------------------------------- | 
:-------------------------------------------------------------------------------
--------------------------------------------------------------------- | | id | 
integer | Primary Key (Generated always as identity) | Unique identifier for 
the transport stop facility. | | code | text | Unique, Not Null, CHECK 
(length(code) > 0 AND length(code) &lt;= 50 AND code ~ '^[a-z0-9_]+$') | Short, 
stable, machine-readable code (e.g., 'toilets\_available', 
'ticket\_office\_staffed'). Snake\_case. | | label | text | Not Null, CHECK 
(length(label) \> 0 AND length(label) \<= 100) | Human-readable name in the 
primary reference language (English) for UI display and as a base for 
translation. (Translatable). | | description | text | Nullable | Optional 
description in the primary reference language (English) of the facility, 
providing more context. (Translatable). | | icon\_identifier | text | Nullable, 
CHECK (icon\_identifier IS NULL OR length(icon\_identifier) \<= 100) | Name, 
class, or path for a UI icon associated with this facility. | | category | text 
| Nullable, CHECK (category IS NULL OR (length(category) \> 0 AND 
length(category) \<= 50 AND category \~ '^[a-z0-9\_]+$')) | Optional broad 
category code for grouping facilities (e.g., "basic_needs", "ticketing"). 
Snake_case. | | sort_order | integer | Not Null, Default 0 | Determines the 
display order in UI lists or filters. | | is_active | boolean | Not Null, 
Default true | If true, this facility is active and can be used/displayed. 
Essential for Array FK integrity checks on referencing tables. | | created_at | 
timestamp with time zone | Not Null, Default now() | Timestamp of record 
creation. | | updated_at | timestamp with time zone | Not Null, Default now() | 
Timestamp of last update (auto-updated by trigger). | | created_by_profile_id | 
uuid | Nullable, Foreign Key to profiles(id) ON DELETE SET NULL | Profile ID of 
the user who created the record. | | updated_by_profile_id | uuid | Nullable, 
Foreign Key to profiles(id) ON DELETE SET NULL | Profile ID of the user who 
last updated the record. | 3. PostgreSQL DDL SQL ``` -- Assumes public.profiles 
table exists -- Assumes a suitable updated_at trigger function exists (e.g., 
public.set_current_timestamp_updated_at() or extensions.moddatetime()) -- 
Assumes public.cleanup_related_translations(TEXT, TEXT) function exists -- 
Assumes public.has_role(TEXT) function exists CREATE TABLE 
public.transport_stop_facilities_master ( id INTEGER GENERATED ALWAYS AS 
IDENTITY PRIMARY KEY, code TEXT UNIQUE NOT NULL CHECK (length(code) > 0 AND 
length(code) <= 50 AND code ~ '^[a-z0-9_]+$'), label TEXT NOT NULL CHECK 
(length(label) > 0 AND length(label) <= 100), description TEXT NULL, 
icon_identifier TEXT NULL CHECK (icon_identifier IS NULL OR 
length(icon_identifier) <= 100), category TEXT NULL CHECK (category IS NULL OR 
(length(category) > 0 AND length(category) <= 50 AND category ~ 
'^[a-z0-9_]+$')), sort_order INTEGER NOT NULL DEFAULT 0, is_active BOOLEAN NOT 
NULL DEFAULT true, created_at TIMESTAMPTZ NOT NULL DEFAULT now(), updated_at 
TIMESTAMPTZ NOT NULL DEFAULT now(), created_by_profile_id UUID NULL REFERENCES 
public.profiles(id) ON DELETE SET NULL, updated_by_profile_id UUID NULL 
REFERENCES public.profiles(id) ON DELETE SET NULL ); COMMENT ON TABLE 
public.transport_stop_facilities_master IS 'Master list of facilities available 
at transport stops. `label` and `description` are primary language (English) 
and translatable. Version 2.1'; COMMENT ON COLUMN 
public.transport_stop_facilities_master.id IS 'PK. Unique identifier for the 
transport stop facility. V2.1'; COMMENT ON COLUMN 
public.transport_stop_facilities_master.code IS 'Short, stable, 
machine-readable code (snake_case). Max 50 chars. UNIQUE. V2.1'; COMMENT ON 
COLUMN public.transport_stop_facilities_master.label IS 'Human-readable name in 
primary language (English) for UI and translation base. Max 100 chars. 
(Translatable via public.translations). V2.1'; COMMENT ON COLUMN 
public.transport_stop_facilities_master.description IS 'Optional description in 
primary language (English) of the facility. (Translatable via 
public.translations). V2.1'; COMMENT ON COLUMN 
public.transport_stop_facilities_master.icon_identifier IS 'Name, class, or 
path for a UI icon. Max 100 chars. V2.1'; COMMENT ON COLUMN 
public.transport_stop_facilities_master.category IS 'Optional broad category 
code for grouping facilities (snake_case). Max 50 chars. If category labels are 
needed, they are translatable via public.translations. V2.1'; COMMENT ON COLUMN 
public.transport_stop_facilities_master.sort_order IS 'Determines the display 
order in UI lists or filters. NOT NULL DEFAULT 0. V2.1'; COMMENT ON COLUMN 
public.transport_stop_facilities_master.is_active IS 'If true, this facility is 
active and can be used/displayed. Essential for Array FK integrity checks. NOT 
NULL DEFAULT TRUE. V2.1'; COMMENT ON COLUMN 
public.transport_stop_facilities_master.created_at IS 'Timestamp of record 
creation. NOT NULL DEFAULT now(). V2.1'; COMMENT ON COLUMN 
public.transport_stop_facilities_master.updated_at IS 'Timestamp of last 
update. Auto-updated by trigger. NOT NULL DEFAULT now(). V2.1'; COMMENT ON 
COLUMN public.transport_stop_facilities_master.created_by_profile_id IS 
'Profile ID of the user who created the record. FK to public.profiles(id) ON 
DELETE SET NULL. V2.1'; COMMENT ON COLUMN 
public.transport_stop_facilities_master.updated_by_profile_id IS 'Profile ID of 
the user who last updated the record. FK to public.profiles(id) ON DELETE SET 
NULL. V2.1'; -- Indexes CREATE INDEX 
ix_transport_stop_facilities_master_created_by_profile_id ON 
public.transport_stop_facilities_master (created_by_profile_id) WHERE 
created_by_profile_id IS NOT NULL; CREATE INDEX 
ix_transport_stop_facilities_master_updated_by_profile_id ON 
public.transport_stop_facilities_master (updated_by_profile_id) WHERE 
updated_by_profile_id IS NOT NULL; CREATE INDEX 
ix_transport_stop_facilities_master_active_category_sort ON 
public.transport_stop_facilities_master (is_active, category, sort_order); -- 
Trigger for updated_at CREATE TRIGGER 
trigger_transport_stop_facilities_master_set_updated_at BEFORE UPDATE ON 
public.transport_stop_facilities_master FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); -- Or extensions.moddatetime() 
COMMENT ON TRIGGER trigger_transport_stop_facilities_master_set_updated_at ON 
public.transport_stop_facilities_master IS 'Trigger to automatically update 
updated_at timestamp on row modification. V2.1'; -- Trigger for orphan 
translation cleanup CREATE TRIGGER 
trigger_cleanup_transport_stop_facilities_master_translations AFTER DELETE ON 
public.transport_stop_facilities_master FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_related_translations('transport_stop_facilities_master', 'id'); 
COMMENT ON TRIGGER 
trigger_cleanup_transport_stop_facilities_master_translations ON 
public.transport_stop_facilities_master IS 'After deleting a transport stop 
facility, remove its associated entries from the translations table using its 
ID. V2.1.'; ``` 4. JSON Schema Mirror JSON ``` { "title": 
"transport_stop_facility_master", "description": "Master list of facilities 
available at transport stops. `label` and `description` are primary language 
(English) and translatable. Version 2.1", "type": "object", "properties": { 
"id": { "type": "integer", "description": "PK. Unique identifier for the 
transport stop facility.", "readOnly": true }, "code": { "type": "string", 
"description": "Short, stable, machine-readable code (snake_case). Max 50 
chars. UNIQUE.", "pattern": "^[a-z0-9_]+$", "maxLength": 50 }, "label": { 
"type": "string", "description": "Human-readable name in primary language 
(English) for UI and translation base. Max 100 chars. (Translatable via 
public.translations).", "maxLength": 100 }, "description": { "type": ["string", 
"null"], "description": "Optional description in primary language (English) of 
the facility. (Translatable via public.translations)." }, "icon_identifier": { 
"type": ["string", "null"], "maxLength": 100, "description": "Name, class, or 
path for a UI icon." }, "category": { "type": ["string", "null"], "pattern": 
"^[a-z0-9_]+$", "maxLength": 50, "description": "Optional broad category code 
for grouping facilities (snake_case). If category labels are needed, they are 
translatable." }, "sort_order": { "type": "integer", "default": 0, 
"description": "Determines display order in UI lists or filters. NOT NULL." }, 
"is_active": { "type": "boolean", "default": true, "description": "If true, 
this facility is active and can be used/displayed. Essential for Array FK 
integrity checks. NOT NULL." }, "created_at": { "type": "string", "format": 
"date-time", "description": "Timestamp of record creation. NOT NULL DEFAULT 
now().", "readOnly": true }, "updated_at": { "type": "string", "format": 
"date-time", "description": "Timestamp of last update. Auto-updated by trigger. 
NOT NULL DEFAULT now().", "readOnly": true }, "created_by_profile_id": { 
"type": ["string", "null"], "format": "uuid", "description": "Profile ID of the 
user who created the record. FK to public.profiles(id) ON DELETE SET NULL." }, 
"updated_by_profile_id": { "type": ["string", "null"], "format": "uuid", 
"description": "Profile ID of the user who last updated the record. FK to 
public.profiles(id) ON DELETE SET NULL." } }, "required": [ "code", "label", 
"sort_order", "is_active", "created_at", "updated_at" ], "primary_key": ["id"], 
"unique_constraints": [ {"columns": ["code"], "name": 
"transport_stop_facilities_master_code_key"} ], "foreign_keys": [ {"columns": 
["created_by_profile_id"], "references_table": "public.profiles", 
"references_columns": ["id"], "on_delete": "SET NULL"}, {"columns": 
["updated_by_profile_id"], "references_table": "public.profiles", 
"references_columns": ["id"], "on_delete": "SET NULL"} ] } ``` 5. Relationships 
& Integrity - Primary Key: `id` (INTEGER, Generated always as identity). - 
Unique Constraint: `code` must be unique. - Foreign Key References FROM other 
tables: `transport_stops_details.stop_facility_ids` (an INTEGER[] column) 
contains IDs that reference `transport_stop_facilities_master.id`. The 
integrity of these array elements (checking existence and `is_active = true` 
status in this table) is handled by a database trigger on 
`transport_stops_details`. - Foreign Key References TO other tables: 
`created_by_profile_id` and `updated_by_profile_id` reference 
`public.profiles(id)` ON DELETE SET NULL. 6. Multilingual Strategy - 
Translatable Fields: `label` and `description` store their primary reference 
language (English) text directly. These fields are designated for translation 
via the `public.translations` table. - Stable Identifiers: The `code` and 
`category` fields are stable, machine-readable identifiers and are not directly 
translated. If `category` codes require user-facing translatable labels, these 
would be managed via `public.translations` (e.g., using `table_identifier = 
'facility_categories'` and `row_foreign_key = [category_code]`) or a separate 
master table for categories. - Orphan Cleanup: An `AFTER DELETE` trigger 
(`trigger_cleanup_transport_stop_facilities_master_translations`) ensures 
associated translations are removed. 7. Role-Based Workflow & RLS Notes - 
Content Management: This table is typically managed by Platform Administrators. 
- Lifecycle: The `is_active` flag is critical for managing the availability of 
facilities and for the integrity of Array FKs referencing this table. - RLS 
Policies: - 🟢 Public users can read active facilities. SQL ``` CREATE POLICY 
"select_active_transport_stop_facilities" ON 
public.transport_stop_facilities_master FOR SELECT USING (is_active = true); 
``` - 🟢 Platform Administrators (identified by 
`public.has_role('admin_platform')`) can manage all facilities. SQL ``` CREATE 
POLICY "manage_transport_stop_facilities_for_admins" ON 
public.transport_stop_facilities_master FOR ALL USING 
(public.has_role('admin_platform')) -- Ensure 'admin_platform' is a defined 
role WITH CHECK (public.has_role('admin_platform')); ``` - Deletion of 
facilities actively referenced in `transport_stops_details.stop_facility_ids` 
should be handled carefully. Deactivating (`is_active = false`) is the 
preferred method for retiring facilities to maintain referential integrity for 
historical data if needed, and because the array FK check on 
`transport_stops_details` will check `is_active`. 8. ENUM vs Lookup Discussion 
🟢 Decision: This table (transport_stop_facilities_master) correctly serves as 
a lookup table, having been promoted from an ENUM array concept. Reason: Offers 
richer data (translatable names/descriptions, icons, categories, sort order), 
improved flexibility, maintainability, and auditability compared to a hardcoded 
ENUM array. 9. UI/UX Enablement - Display: `label` (translated) for names/tags, 
`icon_identifier` for icons. - Grouping: `category` can be used to group 
related facilities in the UI. - Ordering: `sort_order` ensures consistent and 
logical presentation. 10. Auditing & Lifecycle Management - Standard Audit 
Columns: `created_at`, `updated_at` (auto-updated), `created_by_profile_id`, 
`updated_by_profile_id`. - Lifecycle: Managed by the `is_active` boolean flag. 
This flag is essential for the trigger on `transport_stops_details` validating 
`stop_facility_ids`. 11. Scalability & Future-Proofing - Lookup Table: The 
structure is inherently scalable for a list of facilities that is expected to 
remain manageable. - Flexibility: Easy to add new facility types or attributes. 
- Audit Fields: Provide a history of changes. 12. Seed Data (V1) - Seed data 
should be inserted with `is_active = true` and `created_by_profile_id` and 
`updated_by_profile_id` set to a valid admin/system user's UUID. <!-- end list 
--> SQL ``` -- Example structure for seed data INSERT statements: INSERT INTO 
public.transport_stop_facilities_master (code, label, icon_identifier, 
category, sort_order, is_active, created_by_profile_id, updated_by_profile_id) 
VALUES ('toilets_available', 'Toilets Available', 'icon-toilets', 
'basic_needs', 10, true, '[ADMIN_UUID_PLACEHOLDER]', 
'[ADMIN_UUID_PLACEHOLDER]'), ('accessible_toilets_available', 'Accessible 
Toilets Available', 'icon-toilets-accessible', 'basic_needs', 20, true, 
'[ADMIN_UUID_PLACEHOLDER]', '[ADMIN_UUID_PLACEHOLDER]'), 
('waiting_room_shelter_available', 'Waiting Room/Shelter', 'icon-waiting-room', 
'comfort', 30, true, '[ADMIN_UUID_PLACEHOLDER]', '[ADMIN_UUID_PLACEHOLDER]'), 
('cafe_bar_kiosk_on_site', 'Cafe/Bar/Kiosk On-site', 'icon-cafe-stop', 
'food_drink', 40, true, '[ADMIN_UUID_PLACEHOLDER]', 
'[ADMIN_UUID_PLACEHOLDER]'), ('shops_on_site_nearby', 'Shops On-site/Nearby', 
'icon-shops-nearby', 'retail', 50, true, '[ADMIN_UUID_PLACEHOLDER]', 
'[ADMIN_UUID_PLACEHOLDER]'), ('luggage_lockers_available', 'Luggage Lockers 
Available', 'icon-luggage-lockers', 'services', 60, true, 
'[ADMIN_UUID_PLACEHOLDER]', '[ADMIN_UUID_PLACEHOLDER]'), 
('left_luggage_office', 'Left Luggage Office', 'icon-left-luggage', 'services', 
70, true, '[ADMIN_UUID_PLACEHOLDER]', '[ADMIN_UUID_PLACEHOLDER]'), 
('ticket_office_staffed', 'Ticket Office (Staffed)', 'icon-ticket-office', 
'ticketing', 80, true, '[ADMIN_UUID_PLACEHOLDER]', '[ADMIN_UUID_PLACEHOLDER]'), 
('ticket_machine_automated', 'Ticket Machine (Automated)', 
'icon-ticket-machine', 'ticketing', 90, true, '[ADMIN_UUID_PLACEHOLDER]', 
'[ADMIN_UUID_PLACEHOLDER]'), ('wifi_at_stop', 'Wi-Fi at Stop', 
'icon-wifi-stop', 'connectivity', 100, true, '[ADMIN_UUID_PLACEHOLDER]', 
'[ADMIN_UUID_PLACEHOLDER]'), ('atm_at_station_nearby', 'ATM at Station/Nearby', 
'icon-atm-nearby', 'financial', 110, true, '[ADMIN_UUID_PLACEHOLDER]', 
'[ADMIN_UUID_PLACEHOLDER]'), ('taxi_rank_at_station_nearby', 'Taxi Rank at 
Station/Nearby', 'icon-taxi-rank', 'transport_links', 120, true, 
'[ADMIN_UUID_PLACEHOLDER]', '[ADMIN_UUID_PLACEHOLDER]'), 
('bicycle_parking_secure', 'Bicycle Parking (Secure)', 
'icon-bicycle-parking-secure', 'transport_links', 130, true, 
'[ADMIN_UUID_PLACEHOLDER]', '[ADMIN_UUID_PLACEHOLDER]'), 
('bicycle_rental_nearby', 'Bicycle Rental Nearby', 'icon-bicycle-rental', 
'transport_links', 140, true, '[ADMIN_UUID_PLACEHOLDER]', 
'[ADMIN_UUID_PLACEHOLDER]'), ('realtime_departure_boards', 'Real-time Departure 
Boards', 'icon-departure-board', 'information', 150, true, 
'[ADMIN_UUID_PLACEHOLDER]', '[ADMIN_UUID_PLACEHOLDER]'), 
('information_desk_staffed', 'Information Desk (Staffed)', 'icon-info-desk', 
'information', 160, true, '[ADMIN_UUID_PLACEHOLDER]', 
'[ADMIN_UUID_PLACEHOLDER]'), ('car_parking_at_station_nearby', 'Car Parking at 
Station/Nearby', 'icon-car-parking', 'transport_links', 170, true, 
'[ADMIN_UUID_PLACEHOLDER]', '[ADMIN_UUID_PLACEHOLDER]'), 
('water_fountain_potable', 'Potable Water Fountain', 
'icon-fountain-potable-stop', 'basic_needs', 180, true, 
'[ADMIN_UUID_PLACEHOLDER]', '[ADMIN_UUID_PLACEHOLDER]'), 
('mobile_charging_station', 'Mobile Charging Station', 'icon-mobile-charge', 
'connectivity', 190, true, '[ADMIN_UUID_PLACEHOLDER]', 
'[ADMIN_UUID_PLACEHOLDER]'); ``` *(Note: `[ADMIN_UUID_PLACEHOLDER]` must be 
replaced with an actual admin user's UUID during seeding).* 13. Next-Action 
Checklist - 🔴 Helper Functions: Ensure 
`public.set_current_timestamp_updated_at()` (or `extensions.moddatetime`), 
`public.cleanup_related_translations(TEXT, TEXT)`, and `public.has_role(TEXT)` 
functions are defined and operational. - 🔴 Create Table: Execute the DDL for 
`public.transport_stop_facilities_master` (Version 2.1), including the 
`is_active` column. - 🔴 Create Indexes: Apply all defined indexes 
(`ix_transport_stop_facilities_master_created_by_profile_id`, 
`ix_transport_stop_facilities_master_updated_by_profile_id`, 
`ix_transport_stop_facilities_master_active_category_sort`). - 🔴 Apply 
Triggers: - `trigger_transport_stop_facilities_master_set_updated_at`. - 
`trigger_cleanup_transport_stop_facilities_master_translations`. - 🔴 RLS 
Policies: Review, adapt (especially role names like `admin_platform`), and 
apply the RLS policies. - 🔴 Initial Population: Insert seed data as defined, 
populating `is_active` and `created_by_profile_id`/`updated_by_profile_id` 
correctly. - 🟠 Array FK Integrity: Confirm that the trigger on 
`transport_stops_details` correctly validates against the `is_active` status of 
facilities in this table. This table now has the necessary `is_active` flag. - 
🟢 Iconography & UI Grouping: Coordinate `icon_identifier` and `category` usage 
with the UI team. - 🟢 Translation Entries: Plan for populating 
`public.translations` for the `label`, `description`, and potentially for 
`category` codes if their labels need translation. * * * * * 
