# 4c.0.2 - views - view_transport_stops_enriched

  https://gemini.google.com/u/1/app/b90970622259e225 * * * * * ### 
Production-Ready Specification: `public.view_transport_stops_enriched` (V2.1) 
Version: 2.1 Date: May 18, 2025 1. Purpose & Primary Use-Cases The 
public.view_transport_stops_enriched view provides a comprehensive, 
denormalized, and read-only representation of public transportation stops. It 
is designed to simplify data retrieval for pilgrim-facing applications, such as 
populating maps, lists of transport options, and detailed stop information 
pages. This view joins transport_stops_details with its parent waypoints table, 
and related master tables (transport_stop_types_master, 
content_statuses_master), and aggregates information from 
transport_stop_facilities_master. All textual information intended for display 
(labels, descriptions, notes) is presented in the primary reference language 
(English), sourced directly from the underlying tables. - Pilgrim Use: Enables 
pilgrims to easily access key details about a transport stop, including its 
official name, geographical location, type (e.g., "Main Train Station"), 
operator information, links to official timetables, and a clear summary of 
available facilities, all through a unified interface. - API Layer Use: Serves 
as an efficient and simplified data source for API endpoints that deliver 
transport stop information to frontend applications or external services, 
reducing the need for complex join logic in the API layer. - Filtering & 
Display: Facilitates the display of transport stops on maps and lists, and 
supports basic filtering based on attributes available in the view. 2. View 
Columns & Derivations This view selects and derives columns from several base 
tables: public.transport_stops_details (aliased as tsd), public.waypoints (w), 
public.transport_stop_types_master (tstm), public.content_statuses_master 
(csm), and public.transport_stop_facilities_master (tsfm in a subquery). | View 
Column | Source Table(s) & Column(s) / Derivation | Data Type | Notes | | 
:----------------------------------- | 
:-------------------------------------------------------------------------------
------------------------ | :---------- | 
:-------------------------------------------------------------------------------
------------------- | | waypoint_id | tsd.waypoint_id | BIGINT | Primary key of 
the transport stop detail and the linked waypoint. | | waypoint_name | w.name | 
TEXT | Name of the waypoint (primary reference language - English). | | 
waypoint_geom | w.geom | GEOMETRY | Geographical location of the waypoint. | | 
waypoint_primary_image_media_id | w.primary_image_media_id | UUID | FK to 
media.id for the waypoint's primary image. | | waypoint_content_status_code | 
csm.code (via w.content_visibility_status_id) | TEXT | The publication status 
code of the waypoint (e.g., 'published_live'). | | stop_type_code | tstm.code | 
TEXT | Machine-readable code for the transport stop type. | | stop_type_label | 
tstm.label | TEXT | Human-readable label for the stop type (primary reference 
language - English). | | stop_type_description | tstm.description | TEXT | 
Description of the stop type (primary reference language - English). | | 
stop_type_icon_identifier | tstm.icon_identifier | TEXT | UI icon identifier 
for the stop type. | | operator_names_text | tsd.operator_names_text | TEXT[] | 
Array of operator names (primary reference language - English). | | 
operator_stop_code_primary | tsd.operator_stop_code_primary | TEXT | Primary 
operator's internal stop code. | | gtfs_stop_id | tsd.gtfs_stop_id | TEXT | 
GTFS stop ID. | | lines_or_routes_served_summary | 
tsd.lines_or_routes_served_summary | TEXT | Summary of lines/routes served 
(primary reference language - English). | | specific_timetable_url | 
tsd.specific_timetable_url | TEXT | URL to a specific timetable. | | 
general_operator_info_url | tsd.general_operator_info_url | TEXT | URL to 
general operator information. | | ticketing_information_notes | 
tsd.ticketing_information_notes | TEXT | Notes on ticketing (primary reference 
language - English). | | stop_facility_ids | tsd.stop_facility_ids | INTEGER[] 
| Array of facility IDs. | | facilities_details | JSONB aggregation from tsfm 
based on tsd.stop_facility_ids | JSONB | JSON array of facility objects (id, 
code, label, description, icon_identifier, category). | | 
platform_track_bay_information_notes | tsd.platform_track_bay_information_notes 
| TEXT | Notes on platforms/tracks (primary reference language - English). | | 
frequency_of_service_general_notes | tsd.frequency_of_service_general_notes | 
TEXT | Notes on service frequency (primary reference language - English). | | 
is_major_interchange_node | tsd.is_major_interchange_node | BOOLEAN | Flag for 
major interchange. | | accessibility_notes_transport_stop | 
tsd.accessibility_notes_transport_stop | TEXT | Accessibility notes (primary 
reference language - English). | | bicycle_transport_on_service_notes | 
tsd.bicycle_transport_on_service_notes | TEXT | Bicycle transport notes 
(primary reference language - English). | | notes_for_pilgrims_at_stop | 
tsd.notes_for_pilgrims_at_stop | TEXT | Notes for pilgrims (primary reference 
language - English). | | data_last_verified_at | tsd.data_last_verified_at | 
TIMESTAMPTZ| Timestamp of last data verification. | | details_created_at | 
tsd.created_at | TIMESTAMPTZ| Creation timestamp of the transport stop details 
record. | | details_updated_at | tsd.updated_at | TIMESTAMPTZ| Last update 
timestamp of the transport stop details record. | | 
details_created_by_profile_id | tsd.created_by_profile_id | UUID | Creator 
profile ID for the details record. | | details_updated_by_profile_id | 
tsd.updated_by_profile_id | UUID | Updater profile ID for the details record. | 
3. View Definition (DDL) SQL ``` CREATE OR REPLACE VIEW 
public.view_transport_stops_enriched AS SELECT tsd.waypoint_id, w.name AS 
waypoint_name, -- Assumes w.name stores primary reference language (English) 
w.geom AS waypoint_geom, w.primary_image_media_id AS 
waypoint_primary_image_media_id, csm.code AS waypoint_content_status_code, 
tstm.code AS stop_type_code, tstm.label AS stop_type_label, -- Primary language 
label from master tstm.description AS stop_type_description, -- Primary 
language description from master tstm.icon_identifier AS 
stop_type_icon_identifier, tsd.operator_names_text, 
tsd.operator_stop_code_primary, tsd.gtfs_stop_id, 
tsd.lines_or_routes_served_summary, -- Primary language from details table 
tsd.specific_timetable_url, tsd.general_operator_info_url, 
tsd.ticketing_information_notes, -- Primary language from details table 
tsd.stop_facility_ids, ( SELECT jsonb_agg( jsonb_build_object( 'id', tsfm.id, 
'code', tsfm.code, 'label', tsfm.label, -- Primary language label from master 
'description', tsfm.description, -- Primary language description from master 
'icon_identifier', tsfm.icon_identifier, 'category', tsfm.category ) ORDER BY 
tsfm.sort_order ASC ) FROM public.transport_stop_facilities_master tsfm WHERE 
tsfm.id = ANY(tsd.stop_facility_ids) AND tsfm.is_active = true ) AS 
facilities_details, tsd.platform_track_bay_information_notes, -- Primary 
language from details table tsd.frequency_of_service_general_notes, -- Primary 
language from details table tsd.is_major_interchange_node, 
tsd.accessibility_notes_transport_stop, -- Primary language from details table 
tsd.bicycle_transport_on_service_notes, -- Primary language from details table 
tsd.notes_for_pilgrims_at_stop, -- Primary language from details table 
tsd.data_last_verified_at, tsd.created_at AS details_created_at, tsd.updated_at 
AS details_updated_at, tsd.created_by_profile_id AS 
details_created_by_profile_id, tsd.updated_by_profile_id AS 
details_updated_by_profile_id FROM public.transport_stops_details tsd JOIN 
public.waypoints w ON tsd.waypoint_id = w.id JOIN 
public.transport_stop_types_master tstm ON tsd.stop_type_id = tstm.id LEFT JOIN 
-- Assuming content_visibility_status_id can be null or to allow stops even if 
status is somehow missing public.content_statuses_master csm ON 
w.content_visibility_status_id = csm.id WHERE w.deleted_at IS NULL AND 
tstm.is_active = true; -- Only join with active stop types COMMENT ON VIEW 
public.view_transport_stops_enriched IS 'Enriched, denormalized view of 
transport stop details, joining with waypoints and master tables for types and 
facilities. Provides data in the primary reference language (English). Intended 
for public read access to published content. Version 2.1'; ``` 4. JSON Output 
Structure Example (for `GET /transport_stops/{waypoint_id}` based on this view) 
JSON ``` { "waypoint_id": 101, "waypoint_name": "Assisi Station", // Primary 
language (English) "waypoint_geom": { "type": "Point", "coordinates": [12.6189, 
43.0592] }, "waypoint_primary_image_media_id": "media-uuid-assisi-station-img", 
"waypoint_content_status_code": "published_live", "stop_type_code": 
"train_station_main", "stop_type_label": "Main Train Station", // Primary 
language (English) "stop_type_description": "Primary railway station with 
comprehensive services.", // Primary language (English) 
"stop_type_icon_identifier": "icon-train-main", "operator_names_text": 
["Trenitalia"], "operator_stop_code_primary": "ASIS", "gtfs_stop_id": 
"IT:S05133:assisi", "lines_or_routes_served_summary": "Lines to Foligno, 
Perugia, Rome, Florence.", // Primary language (English) 
"specific_timetable_url": "https://www.trenitalia.com/stazione/assisi", 
"general_operator_info_url": "https://www.trenitalia.com", 
"ticketing_information_notes": "Ticket office at station and automated 
machines.", // Primary language (English) "stop_facility_ids": [1, 3, 77, 78], 
"facilities_details": [ { "id": 1, "code": "toilets_available", "label": 
"Toilets Available", // Primary language (English) "description": "Publicly 
accessible restrooms.", // Primary language (English) "icon_identifier": 
"icon-toilets", "category": "basic_needs" }, { "id": 77, "code": 
"ticket_office_staffed", "label": "Ticket Office (Staffed)", // Primary 
language (English) "description": "Staffed ticket counter for assistance.", // 
Primary language (English) "icon_identifier": "icon-ticket-office", "category": 
"ticketing" } // ... other facility details ], 
"platform_track_bay_information_notes": "Platform 1 for southbound trains 
(Rome), Platform 2 for northbound trains (Florence).", // Primary language 
(English) "frequency_of_service_general_notes": "Frequent regional trains; 
Intercity services to major destinations.", // Primary language (English) 
"is_major_interchange_node": true, "accessibility_notes_transport_stop": 
"Disabled access assistance available, contact station in advance.", // Primary 
language (English) "bicycle_transport_on_service_notes": "Bicycle transport 
permitted on regional trains with a supplement.", // Primary language (English) 
"notes_for_pilgrims_at_stop": "Exit station and follow signs for town center 
(bus or taxi).", // Primary language (English) "data_last_verified_at": 
"2025-04-10T10:00:00Z", "details_created_at": "2024-11-15T09:30:00Z", 
"details_updated_at": "2025-04-10T10:05:00Z", "details_created_by_profile_id": 
"user-uuid-creator", "details_updated_by_profile_id": "user-uuid-updater" } ``` 
5. Relationships & Dependencies - This view depends on the following base 
tables: - `public.transport_stops_details` - `public.waypoints` - 
`public.transport_stop_types_master` - 
`public.transport_stop_facilities_master` (via subquery for 
`facilities_details`) - `public.content_statuses_master` - Join Conditions: - 
`tsd.waypoint_id = w.id` - `tsd.stop_type_id = tstm.id` - 
`w.content_visibility_status_id = csm.id` - `tsfm.id = 
ANY(tsd.stop_facility_ids)` (within subquery) - Filters in View Definition: - 
`w.deleted_at IS NULL` - `tstm.is_active = true` - `tsfm.is_active = true` 
(within subquery for `facilities_details`) 6. Multilingual Strategy - The view 
provides all textual content (`waypoint_name`, `stop_type_label`, 
`stop_type_description`, details notes, facility labels/descriptions within 
`facilities_details`) in the primary reference language (English). - For 
displaying content in other languages, the application layer should use the 
codes (`stop_type_code`, facility `code` from `facilities_details`), IDs 
(`waypoint_id` combined with field identifiers for notes), or the English text 
as keys to query the `public.translations` table for the equivalent text in the 
user's selected language. 7. Role-Based Workflow & RLS Notes - RLS Application: 
Row-Level Security must be enabled on this view. SQL ``` ALTER VIEW 
public.view_transport_stops_enriched ENABLE ROW LEVEL SECURITY; ``` - Public 
Access Policy: Public users should only see details for waypoints that are 
published. SQL ``` CREATE POLICY "select_published_enriched_transport_stops" ON 
public.view_transport_stops_enriched FOR SELECT USING 
(waypoint_content_status_code = 'published_live'); -- Assumes 'published_live' 
is the code for published & visible ``` - Authenticated User/Admin Access 
Policy: Privileged roles may have broader access, but this is typically managed 
by their permissions on the underlying base tables. If a separate policy is 
needed for the view for these roles: SQL ``` CREATE POLICY 
"select_all_enriched_transport_stops_for_authorized_roles" ON 
public.view_transport_stops_enriched FOR SELECT -- This policy is for SELECT, 
actual management is on base tables USING (public.has_role('admin_platform') OR 
public.has_role('regional_content_manager')); ``` - RLS policies on the view 
interact with RLS policies on the base tables. The most restrictive set of 
permissions will apply. 8. (ENUM vs Lookup Discussion - N/A for Views) 9. UI/UX 
Enablement - Provides a single, comprehensive data source for client 
applications to display detailed transport stop information. - Column names are 
clear and directly usable for mapping to UI components. - The 
`facilities_details` JSONB array allows easy iteration to display available 
amenities with their names and icons. - Supports filtering and sorting at the 
API level based on the view's columns. 10. Auditing & Lifecycle Management - 
This view is read-only. Auditing and lifecycle (`created_at`, `updated_at`, 
`deleted_at`, `is_active`) are managed on the underlying base tables. - Data 
freshness in the view reflects the freshness of the underlying tables. The 
`data_last_verified_at` column from `transport_stops_details` is exposed. 11. 
Performance & Scalability - Performance depends heavily on appropriate indexing 
on all joined base tables, especially on PK/FK columns, `is_active` flags, and 
`waypoints.geom` (spatial index) if location-based queries are made against 
this view. - The subquery for `facilities_details` involves `jsonb_agg` and an 
array lookup (`ANY`). For lists with many items, or very large numbers of 
facilities per stop, this aggregation could become a performance consideration. 
Performance testing under load is recommended. - If performance for complex 
list queries against this view becomes an issue, a Materialized View could be 
considered as a future optimization, with an appropriate refresh strategy. 12. 
Next-Action Checklist - 🔴 Base Table Prerequisites: Ensure all base tables 
(`waypoints`, `transport_stops_details`, `transport_stop_types_master`, 
`transport_stop_facilities_master`, `content_statuses_master`) are created, 
populated, and correctly indexed (including spatial index on `waypoints.geom`). 
- 🔴 Helper Functions: Ensure `public.has_role(TEXT)` is defined and 
operational. - 🔴 Create View: Execute the `CREATE OR REPLACE VIEW 
public.view_transport_stops_enriched` DDL. - 🔴 Apply RLS Policies: Define and 
apply the RLS policies to the view. Ensure RLS is enabled on the view. - 🟠 
Performance Testing: Test query performance against this view, especially for 
common API call patterns (single item lookup, filtered lists, lists with 
facility details). - 🟢 Documentation: Document this view in the overall 
database schema documentation, including its purpose, columns, and how to use 
it for multilingual support. - 🟢 API Layer Integration: Plan how the API layer 
will consume this view and handle translation lookups for non-primary 
languages. This completes the specification for 
`public.view_transport_stops_enriched`. 
