# 4.1 waypoints

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/1d4834db0819faf2 
https://gemini.google.com/u/1/app/34bd37922031b95a Okay, here is the complete 
and updated "4.1 Waypoints Table Module" document, incorporating the 
agreed-upon changes. * * * * * 4.1 Waypoints Table Module (Version 1.3 - 
Enhanced Integrity & Master Table Standardization) 
--------------------------------------------------------------------------------
------------ This document details the structure, purpose, and considerations 
for the `waypoints` table and its immediate master lookup tables. *Updates in 
this version focus on strengthening data integrity for array foreign keys and 
standardizing the DDL for associated master tables.* ### 1\. Purpose & Primary 
Use-Cases This table serves as the definitive, central repository for all 
distinct, geographically located points of interest (POIs), navigational 
markers, or service locations relevant to the pilgrimage trails. It underpins 
map displays, route construction, POI discovery, and provides the common 
attributes before linking to specialized detail tables. Key user-story 
touchpoints: - Pilgrim: Discovering POIs (accommodations, attractions, water, 
etc.) on a map or along a route (Stories A1-A4, A7, A9). - Pilgrim: 
Understanding POI names, basic descriptions, and seeing a primary image. - 
Pilgrim: Accessing accessibility notes for a POI (Story A4, general 
accessibility). - Pilgrim: Seeing curated highlights like "Franciscan sites" 
(Story A4, A7). - System: Defining start/end points for trail segments (Story 
A2). - Content Managers/Admins: Adding, updating, and managing the publication 
status of all POIs (Stories C2, D1). - System/UI: Driving map icons and 
determining links to more detailed information tables based on category. ### 
2\. Updated Schema (Markdown Table) | column | data_type | constraints | 
description | | id | bigint | Primary Key (Generated as identity always) | 
Unique identifier for each waypoint. Switched to bigint for future growth. | | 
name | text | Not Null, CHECK (length(name) > 0 AND length(name) &lt;= 255) | 
Primary human-readable name of the waypoint (e.g., "La Verna Sanctuary"). 
Primary reference language (English) text. Translatable via the 'translations' 
table. | | slug | text | Unique, Nullable, CHECK (slug IS NULL OR (slug ~ 
'^[a-z0-9]+(?:-[a-z0-9]+)*$' AND length(slug) > 0 AND length(slug) &lt;= 100)) 
| URL-friendly identifier. Pattern ensures Kebab-case. Max length added. | | 
alternate_names_primary_lang | text[] | Nullable | Array of other known names 
or synonyms for the waypoint in the primary reference language (English). For 
non-primary language names, use the translations table. | | 
waypoint_primary_category_id | integer | Not Null, Foreign Key to 
waypoint_categories_master(id) ON DELETE RESTRICT | Broad category of the 
waypoint, linking to a master table for i18n, icons, etc. | | 
waypoint_subcategory_tag_ids | integer[] | Nullable | Array of Foreign Keys to 
tags_master(id) for more specific, managed tags. | | description | text | 
Nullable | General, brief description of the waypoint. Primary reference 
language (English) text. Translatable via the 'translations' table. | | geom | 
geography(PointZ, 4326) | Not Null | PostGIS geography point (PointZ, SRID 4326 
WGS84). geography type is often better for global lat/lon distance 
calculations. | | latitude | double precision | Generated Always As 
(ST_Y(ST_Transform(geom::geometry, 4326))) Stored | Latitude coordinate (WGS 84 
decimal degrees). Generated from geom. | | longitude | double precision | 
Generated Always As (ST_X(ST_Transform(geom::geometry, 4326))) Stored | 
Longitude coordinate (WGS 84 decimal degrees). Generated from geom. | | 
elevation_meters | integer | Generated Always As 
(ST_Z(ST_Transform(geom::geometry, 4326))) Stored, Nullable | Elevation (meters 
above sea level). Generated from geom's Z value if present. | | town_id | 
integer | Nullable, Foreign Key to towns(id) ON DELETE SET NULL | If the 
waypoint is within or associated with a town. | | parent_waypoint_id | bigint | 
Nullable, Foreign Key to waypoints(id) ON DELETE SET NULL | For hierarchical 
waypoints (e.g., a specific chapel within La Verna Sanctuary complex). | | 
address_text | text | Nullable | Textual street address, if applicable. Primary 
reference language (English) text. Translatable. | | primary_image_media_id | 
uuid | Nullable, Foreign Key to media(id) ON DELETE SET NULL | Reference to a 
primary representative image in the central media table. | | 
primary_thumbnail_media_id | uuid | Nullable, Foreign Key to media(id) ON 
DELETE SET NULL | Reference to a primary thumbnail in the central media table. 
| | content_visibility_status_id | integer | Not Null, Default (SELECT id FROM 
content_statuses_master WHERE code = 'draft' LIMIT 1), Foreign Key to 
content_statuses_master(id) ON DELETE RESTRICT | Manages publication lifecycle. 
Links to a master table. | | is_seasonal | boolean | Not Null, Default false | 
Indicates if availability, operation, or accessibility is seasonal. | | 
is_trail_access_point | boolean | Not Null, Default false | Flags 
common/convenient trail access points. | | is_significant_trail_junction | 
boolean | Not Null, Default false | Flags major, named, or decision-critical 
trail junctions. | | is_franciscan_highlight_site | boolean | Not Null, Default 
false | Flags key sites directly related to St. Francis or Franciscan history. 
| | is_significant_pilgrim_poi | boolean | Not Null, Default false | Flags POIs 
of general major significance to pilgrims. | | 
short_narrative_for_dynamic_lists | text | Nullable, CHECK 
(short_narrative_for_dynamic_lists IS NULL OR 
length(short_narrative_for_dynamic_lists) &lt;= 250) | Brief descriptive 
snippet for dynamic highlight lists. Primary reference language (English) text. 
Translatable. Max length 250 chars. | | waypoint_accessibility_notes | text | 
Nullable | Specific accessibility notes for individuals with disabilities. 
Primary reference language (English) text. Translatable. | | general_tags_text 
| text[] | Nullable | Array of general, free-text descriptive tags for 
filtering/search if not covered by structured waypoint_subcategory_tag_ids. | | 
primary_data_source_waypoint | text | Nullable | Information on the source of 
this waypoint's data. | | quality_score | smallint | Nullable, CHECK 
(quality_score IS NULL OR (quality_score >= 0 AND quality_score &lt;= 100)) | 
Internal score indicating data confidence/completeness (0-100). | | created_at 
| timestamp with time zone | Not Null, Default now() | Timestamp of record 
creation. | | created_by_profile_id | uuid | Nullable, Foreign Key to 
profiles(id) ON DELETE SET NULL | Profile ID of the user who created the 
record. Assumes profiles table linked to auth.users. | | updated_at | timestamp 
with time zone | Not Null, Default now() | Timestamp of last update 
(auto-updated by trigger). | | updated_by_profile_id | uuid | Nullable, Foreign 
Key to profiles(id) ON DELETE SET NULL | Profile ID of the user who last 
updated the record. | | deleted_at | timestamp with time zone | Nullable | 
Timestamp for soft deletion. Active records have deleted_at IS NULL. | ### 3\. 
PostgreSQL DDL SQL ``` -- Assumed Master Tables (Create these first if they 
don't exist): CREATE TABLE public.waypoint_categories_master ( id SERIAL 
PRIMARY KEY, code TEXT UNIQUE NOT NULL CHECK (length(code) > 0 AND length(code) 
<= 50 AND code ~ '^[a-z0-9_]+$'), -- Standardized constraint label TEXT NOT 
NULL, -- Primary reference language (English) text. Translatable. description 
TEXT NULL, -- Optional. Primary reference language (English) text. 
Translatable. icon_identifier TEXT NULL CHECK (icon_identifier IS NULL OR 
length(icon_identifier) <= 100), -- Added length check created_at TIMESTAMPTZ 
NOT NULL DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), 
created_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE SET 
NULL, -- Added audit field updated_by_profile_id UUID NULL REFERENCES 
public.profiles(id) ON DELETE SET NULL -- Added audit field ); COMMENT ON TABLE 
public.waypoint_categories_master IS 'Master list of broad waypoint categories. 
`label` and `description` are translatable. Codes are snake_case, max 50 
chars.'; COMMENT ON COLUMN public.waypoint_categories_master.code IS 'Short, 
stable, machine-readable code (snake_case). Max 50 chars.'; COMMENT ON COLUMN 
public.waypoint_categories_master.label IS 'Primary reference language 
(English) label. Translatable via the ''translations'' table.'; COMMENT ON 
COLUMN public.waypoint_categories_master.description IS 'Optional primary 
reference language (English) description. Translatable via the ''translations'' 
table.'; COMMENT ON COLUMN 
public.waypoint_categories_master.created_by_profile_id IS 'Profile ID of the 
user who created the record.'; COMMENT ON COLUMN 
public.waypoint_categories_master.updated_by_profile_id IS 'Profile ID of the 
user who last updated the record.'; CREATE TABLE public.tags_master ( id SERIAL 
PRIMARY KEY, tag_code TEXT UNIQUE NOT NULL CHECK (length(tag_code) > 0 AND 
length(tag_code) <= 50 AND tag_code ~ '^[a-z0-9_]+$'), -- Standardized 
constraint & name label TEXT NOT NULL, -- Primary reference language (English) 
text. Translatable. description TEXT NULL, -- Optional. Primary reference 
language (English) text. Translatable. tag_type TEXT NULL CHECK (tag_type IS 
NULL OR length(tag_type) <= 50), -- Added length check created_at TIMESTAMPTZ 
NOT NULL DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), 
created_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE SET 
NULL, -- Added audit field updated_by_profile_id UUID NULL REFERENCES 
public.profiles(id) ON DELETE SET NULL -- Added audit field ); COMMENT ON TABLE 
public.tags_master IS 'Master list of descriptive tags for various entities. 
`label` and `description` are translatable. Codes are snake_case, max 50 
chars.'; COMMENT ON COLUMN public.tags_master.tag_code IS 'Short, stable, 
machine-readable code (snake_case). Max 50 chars.'; COMMENT ON COLUMN 
public.tags_master.label IS 'Primary reference language (English) label. 
Translatable via the ''translations'' table.'; COMMENT ON COLUMN 
public.tags_master.description IS 'Optional primary reference language 
(English) description. Translatable via the ''translations'' table.'; COMMENT 
ON COLUMN public.tags_master.created_by_profile_id IS 'Profile ID of the user 
who created the record.'; COMMENT ON COLUMN 
public.tags_master.updated_by_profile_id IS 'Profile ID of the user who last 
updated the record.'; CREATE TABLE public.content_statuses_master ( id SERIAL 
PRIMARY KEY, code TEXT UNIQUE NOT NULL CHECK (length(code) > 0 AND length(code) 
<= 50 AND code ~ '^[a-z0-9_]+$'), -- Standardized constraint label TEXT NOT 
NULL, -- Primary reference language (English) text. Translatable. description 
TEXT NULL, -- Optional. Primary reference language (English) text. 
Translatable. created_at TIMESTAMPTZ NOT NULL DEFAULT now(), updated_at 
TIMESTAMPTZ NOT NULL DEFAULT now(), created_by_profile_id UUID NULL REFERENCES 
public.profiles(id) ON DELETE SET NULL, -- Added audit field 
updated_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE SET 
NULL -- Added audit field ); COMMENT ON TABLE public.content_statuses_master IS 
'Master list of content publication statuses. `label` and `description` are 
translatable. Codes are snake_case, max 50 chars.'; COMMENT ON COLUMN 
public.content_statuses_master.code IS 'Short, stable, machine-readable code 
(snake_case). Max 50 chars.'; COMMENT ON COLUMN 
public.content_statuses_master.label IS 'Primary reference language (English) 
label. Translatable via the ''translations'' table.'; COMMENT ON COLUMN 
public.content_statuses_master.description IS 'Optional primary reference 
language (English) description. Translatable via the ''translations'' table.'; 
COMMENT ON COLUMN public.content_statuses_master.created_by_profile_id IS 
'Profile ID of the user who created the record.'; COMMENT ON COLUMN 
public.content_statuses_master.updated_by_profile_id IS 'Profile ID of the user 
who last updated the record.'; -- Populate content_statuses_master with initial 
values like 'draft', 'published', etc. -- Ensure these INSERT statements also 
populate created_by_profile_id if necessary (e.g., with a system user ID or 
admin ID). CREATE TABLE public.media ( id UUID PRIMARY KEY DEFAULT 
gen_random_uuid(), -- other media fields like file_path, mime_type, size_bytes, 
owner_profile_id etc. created_at TIMESTAMPTZ NOT NULL DEFAULT now() ); COMMENT 
ON TABLE public.media IS 'Central repository for media assets.'; CREATE TABLE 
public.profiles ( -- Simplified example, assumes you have this for users id 
UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE, full_name TEXT, 
-- other profile fields, including role_name if used by RLS created_at 
TIMESTAMPTZ NOT NULL DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL DEFAULT 
now() ); CREATE TABLE public.towns ( -- Simplified example id SERIAL PRIMARY 
KEY, name TEXT NOT NULL, -- Primary reference language (English) name. 
Translatable. -- other town fields like region_id, province_id, geom, etc. 
created_at TIMESTAMPTZ NOT NULL DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL 
DEFAULT now() ); COMMENT ON TABLE public.towns IS 'Master list of towns and 
cities. `name` is translatable.'; COMMENT ON COLUMN public.towns.name IS 
'Primary reference language (English) name. Translatable via the 
''translations'' table.'; -- Main Waypoints Table CREATE TABLE public.waypoints 
( id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY, name TEXT NOT NULL CHECK 
(length(name) > 0 AND length(name) <= 255), slug TEXT UNIQUE CHECK (slug IS 
NULL OR (slug ~ '^[a-z0-9]+(?:-[a-z0-9]+)*$' AND length(slug) > 0 AND 
length(slug) <= 100)), alternate_names_primary_lang TEXT[] NULL, 
waypoint_primary_category_id INTEGER NOT NULL, waypoint_subcategory_tag_ids 
INTEGER[] NULL, description TEXT NULL, geom GEOGRAPHY(PointZ, 4326) NOT NULL, 
latitude DOUBLE PRECISION GENERATED ALWAYS AS 
(ST_Y(ST_Transform(geom::geometry, 4326))) STORED, longitude DOUBLE PRECISION 
GENERATED ALWAYS AS (ST_X(ST_Transform(geom::geometry, 4326))) STORED, 
elevation_meters INTEGER GENERATED ALWAYS AS ( 
ST_Z(ST_Transform(geom::geometry, 4326)) ) STORED NULL, town_id INTEGER NULL, 
parent_waypoint_id BIGINT NULL, address_text TEXT NULL, primary_image_media_id 
UUID NULL, primary_thumbnail_media_id UUID NULL, content_visibility_status_id 
INTEGER NOT NULL DEFAULT (SELECT id FROM public.content_statuses_master WHERE 
code = 'draft' LIMIT 1), is_seasonal BOOLEAN NOT NULL DEFAULT FALSE, 
is_trail_access_point BOOLEAN NOT NULL DEFAULT FALSE, 
is_significant_trail_junction BOOLEAN NOT NULL DEFAULT FALSE, 
is_franciscan_highlight_site BOOLEAN NOT NULL DEFAULT FALSE, 
is_significant_pilgrim_poi BOOLEAN NOT NULL DEFAULT FALSE, 
short_narrative_for_dynamic_lists TEXT NULL CHECK 
(short_narrative_for_dynamic_lists IS NULL OR 
length(short_narrative_for_dynamic_lists) <= 250), waypoint_accessibility_notes 
TEXT NULL, general_tags_text TEXT[] NULL, primary_data_source_waypoint TEXT 
NULL, quality_score SMALLINT NULL CHECK (quality_score IS NULL OR 
(quality_score >= 0 AND quality_score <= 100)), created_at TIMESTAMPTZ NOT NULL 
DEFAULT now(), created_by_profile_id UUID NULL, updated_at TIMESTAMPTZ NOT NULL 
DEFAULT now(), updated_by_profile_id UUID NULL, deleted_at TIMESTAMPTZ NULL, 
CONSTRAINT fk_waypoint_primary_category FOREIGN 
KEY(waypoint_primary_category_id) REFERENCES 
public.waypoint_categories_master(id) ON DELETE RESTRICT, CONSTRAINT fk_town 
FOREIGN KEY(town_id) REFERENCES public.towns(id) ON DELETE SET NULL, CONSTRAINT 
fk_parent_waypoint FOREIGN KEY(parent_waypoint_id) REFERENCES 
public.waypoints(id) ON DELETE SET NULL, -- Or RESTRICT if children shouldn't 
exist without a parent CONSTRAINT fk_primary_image_media FOREIGN 
KEY(primary_image_media_id) REFERENCES public.media(id) ON DELETE SET NULL, 
CONSTRAINT fk_primary_thumbnail_media FOREIGN KEY(primary_thumbnail_media_id) 
REFERENCES public.media(id) ON DELETE SET NULL, CONSTRAINT 
fk_content_visibility_status FOREIGN KEY(content_visibility_status_id) 
REFERENCES public.content_statuses_master(id) ON DELETE RESTRICT, CONSTRAINT 
fk_created_by_profile FOREIGN KEY(created_by_profile_id) REFERENCES 
public.profiles(id) ON DELETE SET NULL, CONSTRAINT fk_updated_by_profile 
FOREIGN KEY(updated_by_profile_id) REFERENCES public.profiles(id) ON DELETE SET 
NULL ); COMMENT ON TABLE public.waypoints IS 'Central, generic repository for 
all distinct, geographically located points of interest (POIs), navigational 
markers, or service locations relevant to the pilgrimage trails. Version 1.3'; 
COMMENT ON COLUMN public.waypoints.id IS 'Unique identifier for each 
waypoint.'; COMMENT ON COLUMN public.waypoints.name IS 'Primary human-readable 
name. Primary reference language (English) text. Translatable via the 
''translations'' table. Max 255 chars.'; COMMENT ON COLUMN 
public.waypoints.slug IS 'URL-friendly identifier (kebab-case), unique if set. 
Max 100 chars.'; COMMENT ON COLUMN 
public.waypoints.alternate_names_primary_lang IS 'Array of other known names or 
synonyms in the primary reference language (English). For other language names, 
use the ''translations'' table.'; COMMENT ON COLUMN 
public.waypoints.waypoint_primary_category_id IS 'FK to 
waypoint_categories_master. Broad category of the waypoint.'; COMMENT ON COLUMN 
public.waypoints.waypoint_subcategory_tag_ids IS 'Array of FKs to tags_master. 
Specific, managed tags. **Integrity of array elements MUST be enforced by a 
dedicated database trigger.**'; COMMENT ON COLUMN public.waypoints.description 
IS 'General, brief description. Primary reference language (English) text. 
Translatable via the ''translations'' table.'; COMMENT ON COLUMN 
public.waypoints.geom IS 'Authoritative PostGIS geography point (PointZ, SRID 
4326 WGS84), including Z for elevation if available.'; COMMENT ON COLUMN 
public.waypoints.latitude IS 'Latitude (WGS 84 decimal degrees). Generated from 
geom. For non-PostGIS contexts.'; COMMENT ON COLUMN public.waypoints.longitude 
IS 'Longitude (WGS 84 decimal degrees). Generated from geom. For non-PostGIS 
contexts.'; COMMENT ON COLUMN public.waypoints.elevation_meters IS 'Elevation 
(meters above sea level). Generated from geom Z value if present. Nullable.'; 
COMMENT ON COLUMN public.waypoints.town_id IS 'FK to towns table. If the 
waypoint is located within or directly associated with a recognized town.'; 
COMMENT ON COLUMN public.waypoints.parent_waypoint_id IS 'FK to waypoints.id 
for hierarchical waypoints (e.g., specific chapel within La Verna complex).'; 
COMMENT ON COLUMN public.waypoints.address_text IS 'Textual street address, if 
applicable. Primary reference language (English) text. Translatable via the 
''translations'' table.'; COMMENT ON COLUMN 
public.waypoints.primary_image_media_id IS 'FK to media table. Primary 
representative image.'; COMMENT ON COLUMN 
public.waypoints.primary_thumbnail_media_id IS 'FK to media table. Smaller 
thumbnail version of the primary image.'; COMMENT ON COLUMN 
public.waypoints.content_visibility_status_id IS 'FK to 
content_statuses_master. Manages the publication lifecycle.'; COMMENT ON COLUMN 
public.waypoints.is_seasonal IS 'Indicates if the waypoint''s availability, 
operation, or accessibility is seasonal.'; COMMENT ON COLUMN 
public.waypoints.is_trail_access_point IS 'Flags if this waypoint serves as a 
common or convenient access point to a trail.'; COMMENT ON COLUMN 
public.waypoints.is_significant_trail_junction IS 'Flags if this waypoint 
represents a major, named, or decision-critical trail junction.'; COMMENT ON 
COLUMN public.waypoints.is_franciscan_highlight_site IS 'Flags if this is a key 
site directly related to St. Francis, Franciscan history, or Franciscan 
spirituality.'; COMMENT ON COLUMN public.waypoints.is_significant_pilgrim_poi 
IS 'Flags if this is a point of interest of general major significance to 
pilgrims.'; COMMENT ON COLUMN 
public.waypoints.short_narrative_for_dynamic_lists IS 'Brief (1-2 sentence, max 
250 chars) descriptive snippet. Primary reference language (English) text. 
Translatable via the ''translations'' table.'; COMMENT ON COLUMN 
public.waypoints.waypoint_accessibility_notes IS 'Specific notes regarding 
accessibility for individuals with disabilities. Primary reference language 
(English) text. Translatable via the ''translations'' table.'; COMMENT ON 
COLUMN public.waypoints.general_tags_text IS 'Array of general, free-text 
descriptive tags if not covered by structured waypoint_subcategory_tag_ids. Use 
with caution.'; COMMENT ON COLUMN public.waypoints.primary_data_source_waypoint 
IS 'Information on the source of this waypoint''s data (e.g., "Official 
Guidebook VdF 2024").'; COMMENT ON COLUMN public.waypoints.quality_score IS 
'Internal score (0-100) indicating data confidence/completeness. Nullable.'; 
COMMENT ON COLUMN public.waypoints.created_at IS 'Timestamp of record 
creation.'; COMMENT ON COLUMN public.waypoints.created_by_profile_id IS 
'Profile ID of the user who created the record.'; COMMENT ON COLUMN 
public.waypoints.updated_at IS 'Timestamp of last update.'; COMMENT ON COLUMN 
public.waypoints.updated_by_profile_id IS 'Profile ID of the user who last 
updated the record.'; COMMENT ON COLUMN public.waypoints.deleted_at IS 
'Timestamp for soft deletion. Active records have deleted_at IS NULL.'; -- 
Create necessary indexes CREATE INDEX idx_waypoints_geom ON public.waypoints 
USING GIST (geom); CREATE INDEX idx_waypoints_town_id ON 
public.waypoints(town_id) WHERE town_id IS NOT NULL; CREATE INDEX 
idx_waypoints_parent_waypoint_id ON public.waypoints(parent_waypoint_id) WHERE 
parent_waypoint_id IS NOT NULL; CREATE INDEX 
idx_waypoints_content_visibility_status_id ON 
public.waypoints(content_visibility_status_id); CREATE INDEX 
idx_waypoints_waypoint_primary_category_id ON 
public.waypoints(waypoint_primary_category_id); CREATE INDEX 
idx_waypoints_name_trgm ON public.waypoints USING GIN (name gin_trgm_ops); -- 
Requires pg_trgm extension CREATE INDEX idx_waypoints_subcategory_tag_ids ON 
public.waypoints USING GIN (waypoint_subcategory_tag_ids) WHERE 
waypoint_subcategory_tag_ids IS NOT NULL; CREATE INDEX idx_waypoints_deleted_at 
ON public.waypoints(deleted_at) WHERE deleted_at IS NOT NULL; -- Trigger for 
updated_at (assuming function public.set_current_timestamp_updated_at already 
exists or is defined as below) CREATE OR REPLACE FUNCTION 
public.set_current_timestamp_updated_at() RETURNS TRIGGER AS $$ DECLARE BEGIN 
NEW.updated_at = NOW(); RETURN NEW; END; $$ LANGUAGE plpgsql; CREATE TRIGGER 
trigger_waypoints_set_updated_at BEFORE UPDATE ON public.waypoints FOR EACH ROW 
EXECUTE FUNCTION public.set_current_timestamp_updated_at(); COMMENT ON TRIGGER 
trigger_waypoints_set_updated_at ON public.waypoints IS 'Trigger to 
automatically update updated_at timestamp on row modification.'; -- Placeholder 
for Array FK Integrity Trigger for waypoint_subcategory_tag_ids -- CREATE OR 
REPLACE FUNCTION public.check_waypoint_subcategory_tags() ... -- CREATE TRIGGER 
trigger_check_waypoint_subcategory_tags ... ``` ### 4\. JSON Schema Mirror JSON 
``` { "title": "waypoint", "description": "Central, generic repository for all 
distinct, geographically located points of interest (POIs), navigational 
markers, or service locations relevant to the pilgrimage trails. Version 1.3", 
"type": "object", "properties": { "id": { "type": "integer", "format": "int64", 
"description": "Unique identifier for the waypoint. Primary Key.", "readOnly": 
true }, "name": { "type": "string", "description": "Primary human-readable name 
of the waypoint. Primary reference language (English) text. Translatable. Max 
255 chars.", "minLength": 1, "maxLength": 255 }, "slug": { "type": ["string", 
"null"], "description": "URL-friendly identifier (kebab-case), unique if set. 
Max 100 chars.", "pattern": "^[a-z0-9]+(?:-[a-z0-9]+)*$", "maxLength": 100 }, 
"alternate_names_primary_lang": { "type": ["array", "null"], "items": { "type": 
"string" }, "description": "Array of other known names or synonyms in the 
primary reference language (English)." }, "waypoint_primary_category_id": { 
"type": "integer", "description": "FK to waypoint_categories_master. Broad 
category of the waypoint." }, "waypoint_subcategory_tag_ids": { "type": 
["array", "null"], "items": { "type": "integer" }, "description": "Array of FKs 
to tags_master. Specific, managed tags. Integrity enforced by DB trigger." }, 
"description": { "type": ["string", "null"], "description": "General, brief 
description. Primary reference language (English) text. Translatable." }, 
"geom": { "type": "object", "description": "Authoritative PostGIS geography 
point (PointZ, SRID 4326 WGS84). Expected to be GeoJSON Point in API.", 
"properties": { "type": {"type": "string", "enum": ["Point"]}, "coordinates": { 
"type": "array", "items": {"type": "number", "format": "double"}, "minItems": 
2, "maxItems": 3 } } }, "latitude": { "type": "number", "format": "double", 
"description": "Latitude (WGS 84 decimal degrees). Generated from geom.", 
"readOnly": true }, "longitude": { "type": "number", "format": "double", 
"description": "Longitude (WGS 84 decimal degrees). Generated from geom.", 
"readOnly": true }, "elevation_meters": { "type": ["integer", "null"], 
"description": "Elevation (meters above sea level). Generated from geom Z value 
if present.", "readOnly": true }, "town_id": { "type": ["integer", "null"], 
"description": "FK to towns table. If the waypoint is located within or 
directly associated with a recognized town." }, "parent_waypoint_id": { "type": 
["integer", "null"], "format": "int64", "description": "FK to waypoints.id for 
hierarchical waypoints." }, "address_text": { "type": ["string", "null"], 
"description": "Textual street address, if applicable. Primary reference 
language (English) text. Translatable." }, "primary_image_media_id": { "type": 
["string", "null"], "format": "uuid", "description": "FK to media table. 
Primary representative image." }, "primary_thumbnail_media_id": { "type": 
["string", "null"], "format": "uuid", "description": "FK to media table. 
Smaller thumbnail version of the primary image." }, 
"content_visibility_status_id": { "type": "integer", "description": "FK to 
content_statuses_master. Manages the publication lifecycle. Default corresponds 
to 'draft'." }, "is_seasonal": { "type": "boolean", "default": false, 
"description": "Indicates if the waypoint's availability, operation, or 
accessibility is seasonal." }, "is_trail_access_point": { "type": "boolean", 
"default": false, "description": "Flags if this waypoint serves as a common or 
convenient access point to a trail." }, "is_significant_trail_junction": { 
"type": "boolean", "default": false, "description": "Flags if this waypoint 
represents a major, named, or decision-critical trail junction." }, 
"is_franciscan_highlight_site": { "type": "boolean", "default": false, 
"description": "Flags if this is a key site directly related to St. Francis, 
Franciscan history, or Franciscan spirituality." }, 
"is_significant_pilgrim_poi": { "type": "boolean", "default": false, 
"description": "Flags if this is a point of interest of general major 
significance to pilgrims." }, "short_narrative_for_dynamic_lists": { "type": 
["string", "null"], "maxLength": 250, "description": "Brief (1-2 sentence, max 
250 chars) descriptive snippet. Primary reference language (English) text. 
Translatable." }, "waypoint_accessibility_notes": { "type": ["string", "null"], 
"description": "Specific notes regarding accessibility for individuals with 
disabilities. Primary reference language (English) text. Translatable." }, 
"general_tags_text": { "type": ["array", "null"], "items": { "type": "string" 
}, "description": "Array of general, free-text descriptive tags if not covered 
by structured waypoint_subcategory_tag_ids." }, "primary_data_source_waypoint": 
{ "type": ["string", "null"], "description": "Information on the source of this 
waypoint's data (e.g., 'Official Guidebook VdF 2024')." }, "quality_score": { 
"type": ["integer", "null"], "minimum": 0, "maximum": 100, "description": 
"Internal score (0-100) indicating data confidence/completeness." }, 
"created_at": { "type": "string", "format": "date-time", "description": 
"Timestamp of record creation.", "readOnly": true }, "created_by_profile_id": { 
"type": ["string", "null"], "format": "uuid", "description": "Profile ID of the 
user who created the record." }, "updated_at": { "type": "string", "format": 
"date-time", "description": "Timestamp of last update.", "readOnly": true }, 
"updated_by_profile_id": { "type": ["string", "null"], "format": "uuid", 
"description": "Profile ID of the user who last updated the record." }, 
"deleted_at": { "type": ["string", "null"], "format": "date-time", 
"description": "Timestamp for soft deletion.", "readOnly": true } }, 
"required": [ "name", "waypoint_primary_category_id", "geom", 
"content_visibility_status_id", "is_seasonal", "is_trail_access_point", 
"is_significant_trail_junction", "is_franciscan_highlight_site", 
"is_significant_pilgrim_poi" ] } ``` *(Note: JSON Schemas for 
`waypoint_categories_master`, `tags_master`, `content_statuses_master` should 
be created separately if needed, reflecting their updated DDLs including audit 
fields and code constraints.)* ### 5\. Relationships & Integrity - Primary Key: 
`id` (BIGINT) - Foreign Keys: - `waypoint_primary_category_id` REFERENCES 
`public.waypoint_categories_master(id)` ON DELETE RESTRICT - `town_id` 
REFERENCES `public.towns(id)` ON DELETE SET NULL - `parent_waypoint_id` 
REFERENCES `public.waypoints(id)` ON DELETE SET NULL (self-referencing for 
hierarchy) - `primary_image_media_id` REFERENCES `public.media(id)` ON DELETE 
SET NULL - `primary_thumbnail_media_id` REFERENCES `public.media(id)` ON DELETE 
SET NULL - `content_visibility_status_id` REFERENCES 
`public.content_statuses_master(id)` ON DELETE RESTRICT - 
`created_by_profile_id` REFERENCES `public.profiles(id)` ON DELETE SET NULL - 
`updated_by_profile_id` REFERENCES `public.profiles(id)` ON DELETE SET NULL - 
Junction/Lookup Tables Introduced or Modified: - 🟢 
`waypoint_categories_master`: New lookup table (replaces enum). Stores category 
codes (standardized with CHECK constraints), primary language labels 
(translatable), descriptions, icon identifiers, and audit fields. - 🟢 
`tags_master`: New lookup table. `waypoints.waypoint_subcategory_tag_ids` 
(integer array) references `tags_master.id`. Stores tag codes (standardized 
with CHECK constraints), primary language labels (translatable), and audit 
fields. - 🟢 `content_statuses_master`: New lookup table (replaces enum). 
Stores status codes (standardized with CHECK constraints), primary language 
labels (translatable), descriptions, and audit fields. - Integrity Notes for 
Array FKs (`waypoint_subcategory_tag_ids`): - 🔴 PostgreSQL does not natively 
enforce that each element in `waypoint_subcategory_tag_ids` corresponds to a 
valid `id` in `tags_master`. To ensure data integrity, a database trigger WILL 
BE IMPLEMENTED. This trigger will validate that all IDs in the array exist in 
`tags_master.id` during INSERT and UPDATE operations on the `waypoints` table. 
This is a critical part of the database design. - Mermaid ER Snippet: *(Ensure 
`label` is used for translatable names in master tables within the diagram, and 
audit fields are noted if diagram detail allows).* <!-- end list --> Code 
snippet ``` erDiagram waypoints ||--|{ waypoint_categories_master : 
"belongs_to_category" waypoints }o--|| tags_master : "has_tags (via array IDs)" 
waypoints ||--|{ content_statuses_master : "has_status" waypoints }o..o| towns 
: "optionally_in" waypoints }o..o| waypoints : "can_be_child_of 
(parent_waypoint_id)" waypoints }o..o| media : "primary_image" waypoints }o..o| 
media : "primary_thumbnail" waypoints }o..o| profiles : "created_by" waypoints 
}o..o| profiles : "updated_by" waypoints { bigint id PK text name 
"Translatable" text slug UK text[] alternate_names_primary_lang integer 
waypoint_primary_category_id FK integer[] waypoint_subcategory_tag_ids "FKs to 
tags_master (DB Trigger Enforced)" text description "Translatable" 
geography_PointZ_4326 geom double precision latitude "Generated" double 
precision longitude "Generated" integer elevation_meters "Generated" integer 
town_id FK bigint parent_waypoint_id FK uuid primary_image_media_id FK uuid 
primary_thumbnail_media_id FK integer content_visibility_status_id FK boolean 
is_seasonal timestamptz created_at uuid created_by_profile_id FK timestamptz 
updated_at uuid updated_by_profile_id FK timestamptz deleted_at } 
waypoint_categories_master { integer id PK text code "UK, snake_case" text 
label "Translatable" text icon_identifier uuid created_by_profile_id FK "Audit" 
uuid updated_by_profile_id FK "Audit" } tags_master { integer id PK text 
tag_code "UK, snake_case" text label "Translatable" uuid created_by_profile_id 
FK "Audit" uuid updated_by_profile_id FK "Audit" } content_statuses_master { 
integer id PK text code "UK, snake_case" text label "Translatable" uuid 
created_by_profile_id FK "Audit" uuid updated_by_profile_id FK "Audit" } towns 
{ integer id PK text name "Translatable" } media { uuid id PK } profiles { uuid 
id PK } ``` ### 6\. Multilingual Strategy - Fields storing primary reference 
language (English) text directly in `waypoints` (to be translated via central 
`translations` table): - `name` - `description` - `address_text` - 
`short_narrative_for_dynamic_lists` - `waypoint_accessibility_notes` - 
`alternate_names_primary_lang` (elements are in primary language; the concept 
of "alternate name" isn't translated, the names are). - Fields linked to master 
tables whose `label` fields are translated via the `translations` table: - 
`waypoint_primary_category_id` (links to `waypoint_categories_master.label`) - 
`waypoint_subcategory_tag_ids` (elements link to `tags_master.label`) - 
`content_visibility_status_id` (links to `content_statuses_master.label`) - 
Sample `translations` table entry for a waypoint name: *(Remains the same as 
V1.2)* ### 7\. Role-Based Workflow & RLS Notes - Key Fields for Workflow: - 
`content_visibility_status_id`: Central to moderation and publication 
workflows. - `created_by_profile_id`, `updated_by_profile_id`: Track authorship 
and modifications. - `deleted_at`: For soft deletion and archival workflows. - 
Recommended Row-Level Security (RLS) Policies: *(RLS policies from sources 
remain conceptually valid but ensure table and column names match updates).* - 
Public Users: Read-only access to published and non-deleted waypoints. - 
Content Managers: Broader access, potentially regionalized. - Hosts: Limited 
updates to their own accommodation-linked waypoints (if applicable). - Admins: 
Full access (typically via `service_role` or specific admin user role 
policies). *(Ensure profiles table contains a `role_name` or similar column if 
RLS policies depend on it for Content Manager/Admin roles, as shown in example 
policies for other tables).* ### 8\. ENUM vs Lookup Discussion - 🟢 
`waypoint_categories_master`: Successfully promoted from enum. Allows richer 
attributes (icons, standardized codes, audit trails) and i18n for category 
labels. - 🟢 `content_statuses_master`: Successfully promoted from enum. Allows 
translatable labels/descriptions for statuses, standardized codes, and audit 
trails. - 🟢 `tags_master`: `waypoint_subcategory_tag_ids` (integer array) 
links to this new lookup table, replacing a free-text array for primary 
subcategory tags. Provides standardization, i18n for tag labels, consistent 
filtering, standardized codes, and audit trails. `general_tags_text` (text 
array) is retained for ad-hoc, non-managed tags. ### 9\. UI/UX Enablement - 
Filters, Icons, Lists driven by: - `waypoint_primary_category_id` (via 
`waypoint_categories_master.icon_identifier` and its translatable label). - 
`waypoint_subcategory_tag_ids` (via `tags_master`'s translatable label). - 
Boolean flags (`is_seasonal`, etc.) for direct filtering/highlighting. - 
Display Fields: `name`, `description`, `primary_image_media_id`, 
`short_narrative_for_dynamic_lists`. - Map Integration: `geom` for display; 
generated `latitude`, `longitude`, `elevation_meters` for convenience and 
performance. - Indexes: GIST on `geom`, GIN on `name` (trigram) and 
`waypoint_subcategory_tag_ids` are crucial for performance. ### 10\. Key 
Considerations & Definitions - Business Rules & Validation: - `name`: Required, 
max 255 chars. - `slug`: Optional, unique if present, kebab-case, max 100 
chars. System generation with manual override recommended. - 
`parent_waypoint_id`: Manage hierarchy carefully to avoid circular dependencies 
(application logic). - `segment_delimiter` Waypoints: UI forms should adapt for 
waypoints categorized as 'segment_delimiter', as many descriptive fields may be 
irrelevant. - Hierarchical Waypoints (`parent_waypoint_id`): Application layer 
needs to handle querying/display. ON DELETE SET NULL is often preferred to 
avoid accidental data loss of children. ### 11\. Scalability & Future-Proofing 
- Audit columns, soft deletes (`deleted_at`), `BIGINT` for `id`, generated 
coordinate columns, and standardized lookup tables contribute positively. - 
Central media table is scalable. - Partitioning or full content versioning are 
V2+ considerations if needed. ### 12\. Next-Action Checklist 1. 🔴 Implement 
Master Tables: Create and populate `waypoint_categories_master`, `tags_master`, 
and `content_statuses_master` using the updated DDL (with standardized `code` 
constraints and full audit fields). Ensure default values (e.g., for 'draft' 
status) exist and `created_by_profile_id` is appropriately set for initial 
data. 2. 🔴 Create `waypoints` Table: Use the updated DDL. Ensure the 
`set_current_timestamp_updated_at` trigger function is created and applied. 3. 
🟠 Review `parent_waypoint_id` ON DELETE: Confirm `ON DELETE SET NULL` is the 
desired behavior for all use cases. 4. 🔴 Implement Array FK Integrity Trigger 
for `waypoint_subcategory_tag_ids`: Develop, test, and deploy a database 
trigger function to ensure that all integer IDs provided in the 
`waypoint_subcategory_tag_ids` array correspond to valid `id` entries in the 
`tags_master` table. This is mandatory for data integrity. 5. 🟢 Develop RLS 
Policies: Implement and test RLS policies, ensuring they use updated 
table/column names and correctly reference user roles (e.g., from 
`profiles.role_name`). * * * * * 
