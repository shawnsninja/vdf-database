# 4.0.4 - OpenAPI 3.1 Spec (Waypoints)

  https://gemini.google.com/u/1/app/5c36af70115d07fa * * * * * ### OpenAPI 3.1 
Spec (for Module 4 - Waypoints - REVISED) YAML ``` openapi: 3.1.0 info: title: 
Via di Francesco - Module 4 API (Waypoints) version: v1.0.0 description: |- API 
endpoints for managing Waypoints and related master data (Waypoint Categories, 
Tags, Content Statuses) for the Via di Francesco Pilgrimage Platform. This 
module focuses on the `waypoints`, `waypoint_categories_master`, `tags_master`, 
and `content_statuses_master` tables. Translatable fields (e.g., `name`, 
`label`, `description`) will return text in the language specified by the 
`lang` query parameter, or in the primary reference language (English) if 
`lang` is omitted or the specific translation is unavailable. tags: - name: 
Waypoints description: Operations related to waypoints (Points of Interest). - 
name: WaypointCategories description: Operations related to waypoint categories 
master data. - name: TagsMaster description: Operations related to tags master 
data. - name: ContentStatusesMaster description: Operations related to content 
statuses master data. servers: - url: http://localhost:8000/rest/v1 # 
Placeholder for Supabase local PostgREST description: Development Server - url: 
https://api.viadifrancesco.example.com/v1 # Placeholder description: Production 
Server components: schemas: # Shared Schemas (Conceptual - defined here for 
module context) ApiError: type: object description: Standard error object based 
on the Auth & Security Blueprint. properties: code: type: string description: A 
machine-readable error code or PostgREST error code. example: "PGRST116" 
message: type: string description: A human-readable summary of the error. 
example: "Invalid input provided for waypoint creation." details: type: string 
nullable: true description: More specific details about the error. example: 
"Field 'name' cannot be empty." hint: type: string nullable: true description: 
Optional hint on how to resolve the error. example: "Ensure all required fields 
are populated." required: - code - message PaginationEnvelope: type: object 
properties: total_items: type: integer description: Total number of items 
available across all pages. example: 125 total_pages: type: integer 
description: Total number of pages. example: 7 current_page: type: integer 
description: The current page number. example: 1 page_size: type: integer 
description: The number of items per page. example: 20 # Module 4 Schemas 
WaypointCategoryMaster: description: Defines a broad classification for 
waypoints. Text fields are translated based on `lang` param. type: object 
properties: id: type: integer description: Unique identifier for the waypoint 
category. readOnly: true code: type: string description: Short, stable, 
machine-readable code (e.g., 'accommodation_location'). readOnly: true label: 
type: string description: Human-readable name for the category. Translated 
based on `lang` query parameter. example: "Accommodation" # Will be "Alloggio" 
if lang=it description: type: string nullable: true description: Optional 
description of the category. Translated based on `lang` query parameter. 
icon_identifier: type: string nullable: true description: Name, class, or path 
for a UI icon. requires_detail_table: type: string nullable: true description: 
Optional name of the specific detail table this category links to. sort_order: 
type: integer description: Determines the display order in UI lists or filters. 
is_active: type: boolean description: True if the category definition is active 
and available for use. readOnly: true created_at: type: string format: 
date-time description: Timestamp of record creation. readOnly: true updated_at: 
type: string format: date-time description: Timestamp of last update. readOnly: 
true created_by_profile_id: type: string format: uuid nullable: true 
description: Profile ID of the user who created the record. readOnly: true 
updated_by_profile_id: type: string format: uuid nullable: true description: 
Profile ID of the user who last updated the record. readOnly: true required: - 
id - code - label # Now refers to the translated label - sort_order - is_active 
- created_at - updated_at WaypointCategoryMasterCreate: description: Data for 
creating a new waypoint category. Primary language (English) text should be 
provided. type: object properties: code: type: string description: Short, 
stable, machine-readable code (snake_case). Max 50 chars. pattern: 
"^[a-z0-9_]{1,50}$" label: # This will be the English label on creation type: 
string description: Human-readable English label. Max 100 chars. maxLength: 100 
description: # English description on creation type: string nullable: true 
description: Optional English description. icon_identifier: type: string 
nullable: true maxLength: 100 description: Name, class, or path for a UI icon. 
requires_detail_table: type: string nullable: true maxLength: 100 description: 
Optional name of the specific detail table. sort_order: type: integer default: 
0 description: Determines display order. is_active: type: boolean default: true 
required: - code - label TagMaster: description: Defines a curated descriptive 
tag. Text fields are translated based on `lang` param. type: object properties: 
id: type: integer description: Unique identifier for the tag. readOnly: true 
tag_code: type: string description: Short, stable, machine-readable code for 
the tag. readOnly: true label: type: string description: Human-readable name 
for the tag. Translated based on `lang` query parameter. description: type: 
string nullable: true description: Optional description of the tag. Translated 
based on `lang` query parameter. tag_type: type: string nullable: true 
description: Optional type to group tags (e.g., 'amenity', 'poi_feature'). 
icon_identifier: type: string nullable: true description: Optional UI icon 
identifier. sort_order: type: integer description: Determines display order. 
is_active: type: boolean description: True if the tag definition is active. 
readOnly: true created_at: type: string format: date-time readOnly: true 
updated_at: type: string format: date-time readOnly: true 
created_by_profile_id: type: string format: uuid nullable: true readOnly: true 
updated_by_profile_id: type: string format: uuid nullable: true readOnly: true 
required: - id - tag_code - label # Now refers to the translated label - 
sort_order - is_active TagMasterCreate: description: Data for creating a new 
tag. Primary language (English) text should be provided. type: object 
properties: tag_code: type: string description: Short, stable, machine-readable 
code (snake_case). Max 50 chars. pattern: "^[a-z0-9_]{1,50}$" label: # English 
label on creation type: string description: Human-readable English label. Max 
100 chars. maxLength: 100 description: # English description on creation type: 
string nullable: true description: Optional English description. tag_type: 
type: string nullable: true pattern: "^[a-z0-9_]{1,50}$" description: Optional 
type to group tags. icon_identifier: type: string nullable: true maxLength: 100 
description: Optional UI icon identifier. sort_order: type: integer default: 0 
is_active: type: boolean default: true required: - tag_code - label 
ContentStatusMaster: description: Defines a content lifecycle status. Text 
fields are translated based on `lang` param. type: object properties: id: type: 
integer description: Unique identifier for the content status. readOnly: true 
code: type: string description: Short, stable, machine-readable code (e.g., 
'draft', 'published'). readOnly: true label: type: string description: 
Human-readable name for the status. Translated based on `lang` query parameter. 
description: type: string nullable: true description: Optional description of 
the status. Translated based on `lang` query parameter. is_publicly_visible: 
type: boolean description: Indicates if content *with this status* is generally 
visible to public users. sort_order: type: integer description: Determines 
display order. is_active: type: boolean description: True if the status 
definition itself is active. readOnly: true created_at: type: string format: 
date-time readOnly: true updated_at: type: string format: date-time readOnly: 
true created_by_profile_id: type: string format: uuid nullable: true readOnly: 
true updated_by_profile_id: type: string format: uuid nullable: true readOnly: 
true required: - id - code - label # Now refers to the translated label - 
is_publicly_visible - sort_order - is_active ContentStatusMasterCreate: 
description: Data for creating a new content status. Primary language (English) 
text should be provided. type: object properties: code: type: string 
description: Short, stable, machine-readable code (snake_case). Max 50 chars. 
pattern: "^[a-z0-9_]{1,50}$" label: # English label on creation type: string 
description: Human-readable English label. Max 100 chars. maxLength: 100 
description: # English description on creation type: string nullable: true 
is_publicly_visible: type: boolean default: false description: Indicates if 
content *with this status* is generally visible. sort_order: type: integer 
default: 0 is_active: type: boolean default: true required: - code - label - 
is_publicly_visible Waypoint: description: A geographically located point of 
interest (POI). Text fields are translated based on `lang` param. type: object 
properties: id: type: integer format: int64 # DB is bigint description: Unique 
identifier for the waypoint. readOnly: true name: type: string description: 
Primary name of the waypoint. Translated based on `lang` query parameter. slug: 
type: string nullable: true description: URL-friendly identifier. 
alternate_names_primary_lang: # This specific field stores English alternate 
names as per DB spec [cite: 158] type: array items: type: string nullable: true 
description: Array of other known names in the primary reference language 
(English). waypoint_primary_category_id: type: integer description: ID of the 
primary category from `waypoint_categories_master`. 
waypoint_subcategory_tag_ids: # Array of integers referencing tags_master.id 
type: array items: type: integer nullable: true description: Array of tag IDs 
from `tags_master`. description: type: string nullable: true description: 
General, brief description of the waypoint. Translated based on `lang` query 
parameter. geom: type: object description: GeoJSON Point geometry (PointZ, SRID 
4326 WGS84). properties: type: type: string enum: [Point] coordinates: type: 
array items: type: number format: double minItems: 2 maxItems: 3 required: 
[type, coordinates] latitude: type: number format: double description: Latitude 
coordinate (WGS 84). Generated from geom. readOnly: true longitude: type: 
number format: double description: Longitude coordinate (WGS 84). Generated 
from geom. readOnly: true elevation_meters: type: integer nullable: true 
description: Elevation in meters. Generated from geom's Z value. readOnly: true 
town_id: type: integer nullable: true description: ID of the associated town. 
parent_waypoint_id: type: integer format: int64 # DB is bigint nullable: true 
description: ID of the parent waypoint for hierarchical waypoints. 
address_text: type: string nullable: true description: Textual street address, 
if applicable. Translated based on `lang` query parameter. 
primary_image_media_id: type: string format: uuid nullable: true description: 
ID of the primary representative image from `media` table. 
primary_thumbnail_media_id: type: string format: uuid nullable: true 
description: ID of the primary thumbnail image from `media` table. 
content_visibility_status_id: type: integer description: ID of the content 
status from `content_statuses_master`. is_seasonal: type: boolean description: 
Indicates if availability is seasonal. is_trail_access_point: type: boolean 
description: Flags common trail access points. is_significant_trail_junction: 
type: boolean description: Flags major trail junctions. 
is_franciscan_highlight_site: type: boolean description: Flags key Franciscan 
sites. is_significant_pilgrim_poi: type: boolean description: Flags POIs of 
major significance to pilgrims. short_narrative_for_dynamic_lists: type: string 
maxLength: 250 nullable: true description: Brief descriptive snippet for 
dynamic highlight lists. Translated based on `lang` query parameter. 
waypoint_accessibility_notes: type: string nullable: true description: Specific 
accessibility notes. Translated based on `lang` query parameter. 
general_tags_text: # Array of free-text tags type: array items: type: string 
nullable: true description: Array of general, free-text descriptive tags. 
primary_data_source_waypoint: type: string nullable: true description: 
Information on the source of this waypoint's data. quality_score: type: integer 
format: int32 # DB smallint minimum: 0 maximum: 100 nullable: true description: 
Internal score indicating data confidence/completeness (0-100). created_at: 
type: string format: date-time readOnly: true created_by_profile_id: type: 
string format: uuid nullable: true readOnly: true updated_at: type: string 
format: date-time readOnly: true updated_by_profile_id: type: string format: 
uuid nullable: true readOnly: true deleted_at: type: string format: date-time 
nullable: true readOnly: true required: - id - name # Now refers to the 
translated name - waypoint_primary_category_id - geom - 
content_visibility_status_id - is_seasonal - is_trail_access_point - 
is_significant_trail_junction - is_franciscan_highlight_site - 
is_significant_pilgrim_poi WaypointCreate: description: Data for creating a new 
waypoint. Primary language (English) text should be provided for translatable 
fields. type: object properties: name: # English name on creation type: string 
maxLength: 255 description: Primary English name. slug: type: string nullable: 
true pattern: "^[a-z0-9]+(?:-[a-z0-9]+)*$" maxLength: 100 description: 
URL-friendly identifier. alternate_names_primary_lang: type: array items: { 
type: string } nullable: true description: Array of other English names. 
waypoint_primary_category_id: type: integer description: FK to 
waypoint_categories_master. waypoint_subcategory_tag_ids: type: array items: { 
type: integer } nullable: true description: Array of FKs to tags_master. 
description: # English description on creation type: string nullable: true 
description: General, brief English description. geom: $ref: 
'#/components/schemas/Waypoint/properties/geom' # Re-use definition town_id: 
type: integer nullable: true description: FK to towns table. 
parent_waypoint_id: type: integer format: int64 nullable: true description: FK 
to waypoints.id. address_text: # English address on creation type: string 
nullable: true description: Textual English street address. 
primary_image_media_id: type: string format: uuid nullable: true description: 
FK to media table. primary_thumbnail_media_id: type: string format: uuid 
nullable: true description: FK to media table. content_visibility_status_id: 
type: integer description: FK to content_statuses_master. Default usually 
'draft'. is_seasonal: type: boolean default: false is_trail_access_point: type: 
boolean default: false is_significant_trail_junction: type: boolean default: 
false is_franciscan_highlight_site: type: boolean default: false 
is_significant_pilgrim_poi: type: boolean default: false 
short_narrative_for_dynamic_lists: # English on creation type: string 
maxLength: 250 nullable: true description: Brief English snippet. 
waypoint_accessibility_notes: # English on creation type: string nullable: true 
description: English accessibility notes. general_tags_text: type: array items: 
{ type: string } nullable: true description: Array of free-text tags. 
primary_data_source_waypoint: type: string nullable: true quality_score: type: 
integer format: int32 minimum: 0 maximum: 100 nullable: true required: - name - 
waypoint_primary_category_id - geom - content_visibility_status_id parameters: 
Lang: name: lang in: query description: |- The language code for translated 
content (e.g., `it`, `en`). If not provided, or if a translation is not 
available for the requested language, content will be returned in the primary 
reference language (English). required: false schema: type: string example: 
"it" Page: name: page in: query description: Page number for paginated results. 
required: false schema: type: integer minimum: 1 default: 1 PageSize: name: 
page_size in: query description: Number of items per page for paginated 
results. required: false schema: type: integer minimum: 1 maximum: 100 # 
Example maximum default: 20 SortBy: name: sort_by in: query description: Field 
to sort by (e.g., `name`, `created_at`). Specific to endpoint. required: false 
schema: type: string Order: name: order in: query description: Sort order. 
required: false schema: type: string enum: [asc, desc] default: asc 
securitySchemes: bearerAuth: # JWT Authentication based on Auth & Security 
Blueprint type: http scheme: bearer bearerFormat: JWT description: "Supabase 
JWT token. Roles from `public.profiles.roles` are synchronized to 
`auth.users.raw_app_meta_data.roles` and available in JWT claims. RLS policies 
use `auth.uid()` and helper functions like `public.has_role(TEXT)`." security: 
- bearerAuth: [] # Applies JWT bearer auth globally by default. Public 
endpoints override. paths: /waypoint_categories: get: tags: 
[WaypointCategories] summary: List Waypoint Categories description: |- 
Retrieves a list of waypoint categories. Publicly accessible, RLS on 
`waypoint_categories_master` filters for `is_active = true`. The API uses 
`v_waypoint_categories_localized` view or similar logic to efficiently provide 
translations based on the `lang` parameter. # Requires view: 
v_waypoint_categories_localized (or equivalent backend logic) # Requires index: 
idx_wc_master_is_active operationId: listWaypointCategories security: [] # 
Public, RLS enforced parameters: - $ref: '#/components/parameters/Page' - $ref: 
'#/components/parameters/PageSize' - $ref: '#/components/parameters/SortBy' # 
e.g. sort_order, label - $ref: '#/components/parameters/Order' - $ref: 
'#/components/parameters/Lang' responses: '200': description: A paginated list 
of waypoint categories. content: application/json: schema: type: object 
properties: data: type: array items: $ref: 
'#/components/schemas/WaypointCategoryMaster' pagination: $ref: 
'#/components/schemas/PaginationEnvelope' default: description: Unexpected 
error. content: application/json: schema: $ref: '#/components/schemas/ApiError' 
post: tags: [WaypointCategories] summary: Create Waypoint Category description: 
|- Creates a new waypoint category. `label` and `description` are submitted in 
English. Requires `platform_admin` role. operationId: createWaypointCategory 
requestBody: required: true content: application/json: schema: $ref: 
'#/components/schemas/WaypointCategoryMasterCreate' responses: '201': 
description: Waypoint category created successfully. Response `label` and 
`description` will be in English. content: application/json: schema: $ref: 
'#/components/schemas/WaypointCategoryMaster' '400': $ref: 
'#/components/responses/BadRequestError' '401': $ref: 
'#/components/responses/UnauthorizedError' '403': $ref: 
'#/components/responses/ForbiddenError' /waypoint_categories/{category_id}: 
get: tags: [WaypointCategories] summary: Get Waypoint Category by ID 
description: |- Retrieves a specific waypoint category by its ID. Publicly 
accessible if `is_active = true`. # Requires view: 
v_waypoint_categories_localized (or equivalent backend logic) operationId: 
getWaypointCategoryById security: [] # Public, RLS enforced parameters: - name: 
category_id in: path required: true description: ID of the waypoint category. 
schema: type: integer - $ref: '#/components/parameters/Lang' responses: '200': 
description: Waypoint category details. content: application/json: schema: 
$ref: '#/components/schemas/WaypointCategoryMaster' '404': $ref: 
'#/components/responses/NotFoundError' default: $ref: 
'#/components/responses/DefaultError' /tags: get: tags: [TagsMaster] summary: 
List Tags description: |- Retrieves a list of tags. Publicly accessible, RLS on 
`tags_master` filters for `is_active = true`. The API uses `v_tags_localized` 
view or similar logic to efficiently provide translations based on the `lang` 
parameter. # Requires view: v_tags_localized (or equivalent backend logic) # 
Requires index: idx_tags_master_is_active operationId: listTags security: [] # 
Public, RLS enforced parameters: - $ref: '#/components/parameters/Page' - $ref: 
'#/components/parameters/PageSize' - $ref: '#/components/parameters/SortBy' # 
e.g. sort_order, label - $ref: '#/components/parameters/Order' - $ref: 
'#/components/parameters/Lang' - name: tag_type in: query description: Filter 
tags by their specified type code. required: false schema: type: string 
responses: '200': description: A paginated list of tags. content: 
application/json: schema: type: object properties: data: type: array items: 
$ref: '#/components/schemas/TagMaster' pagination: $ref: 
'#/components/schemas/PaginationEnvelope' default: $ref: 
'#/components/responses/DefaultError' post: tags: [TagsMaster] summary: Create 
Tag description: |- Creates a new tag. `label` and `description` are submitted 
in English. Requires `platform_admin` or `admin` role. operationId: createTag 
requestBody: required: true content: application/json: schema: $ref: 
'#/components/schemas/TagMasterCreate' responses: '201': description: Tag 
created successfully. Response `label` and `description` will be in English. 
content: application/json: schema: $ref: '#/components/schemas/TagMaster' 
'400': $ref: '#/components/responses/BadRequestError' '401': $ref: 
'#/components/responses/UnauthorizedError' '403': $ref: 
'#/components/responses/ForbiddenError' /tags/{tag_id}: get: tags: [TagsMaster] 
summary: Get Tag by ID description: |- Retrieves a specific tag by its ID. 
Publicly accessible if `is_active = true`. # Requires view: v_tags_localized 
(or equivalent backend logic) operationId: getTagById security: [] # Public, 
RLS enforced parameters: - name: tag_id in: path required: true description: ID 
of the tag. schema: type: integer - $ref: '#/components/parameters/Lang' 
responses: '200': description: Tag details. content: application/json: schema: 
$ref: '#/components/schemas/TagMaster' '404': $ref: 
'#/components/responses/NotFoundError' default: $ref: 
'#/components/responses/DefaultError' /content_statuses: get: tags: 
[ContentStatusesMaster] summary: List Content Statuses description: |- 
Retrieves a list of content status definitions. Publicly accessible, RLS on 
`content_statuses_master` filters for `is_active = true`. # Requires index: 
idx_cs_master_is_active operationId: listContentStatuses security: [] # Public, 
RLS enforced parameters: - $ref: '#/components/parameters/Page' - $ref: 
'#/components/parameters/PageSize' - $ref: '#/components/parameters/SortBy' # 
e.g. sort_order, label - $ref: '#/components/parameters/Order' - $ref: 
'#/components/parameters/Lang' responses: '200': description: A paginated list 
of content status definitions. content: application/json: schema: type: object 
properties: data: type: array items: $ref: 
'#/components/schemas/ContentStatusMaster' pagination: $ref: 
'#/components/schemas/PaginationEnvelope' default: $ref: 
'#/components/responses/DefaultError' post: tags: [ContentStatusesMaster] 
summary: Create Content Status description: |- Creates a new content status 
definition. `label` and `description` are submitted in English. Requires 
`platform_admin` role. operationId: createContentStatus requestBody: required: 
true content: application/json: schema: $ref: 
'#/components/schemas/ContentStatusMasterCreate' responses: '201': description: 
Content status created successfully. Response `label` and `description` will be 
in English. content: application/json: schema: $ref: 
'#/components/schemas/ContentStatusMaster' '400': $ref: 
'#/components/responses/BadRequestError' '401': $ref: 
'#/components/responses/UnauthorizedError' '403': $ref: 
'#/components/responses/ForbiddenError' /content_statuses/{status_id}: get: 
tags: [ContentStatusesMaster] summary: Get Content Status by ID description: |- 
Retrieves a specific content status definition by its ID. Publicly accessible 
if `is_active = true`. operationId: getContentStatusById security: [] # Public, 
RLS enforced parameters: - name: status_id in: path required: true description: 
ID of the content status. schema: type: integer - $ref: 
'#/components/parameters/Lang' responses: '200': description: Content status 
details. content: application/json: schema: $ref: 
'#/components/schemas/ContentStatusMaster' '404': $ref: 
'#/components/responses/NotFoundError' default: $ref: 
'#/components/responses/DefaultError' /waypoints: get: tags: [Waypoints] 
summary: List Waypoints description: |- Retrieves a list of waypoints with 
filtering and pagination. Publicly accessible for published waypoints (RLS: 
where `content_visibility_status_id` corresponds to a 
`content_statuses_master.code = 'published'` and `waypoints.deleted_at IS 
NULL`). # Requires indexes: idx_waypoints_content_visibility_status_id, 
idx_waypoints_deleted_at, idx_waypoints_geom (for spatial filters), 
idx_waypoints_waypoint_primary_category_id, idx_waypoints_subcategory_tag_ids 
(GIN) operationId: listWaypoints security: [] # Public, RLS enforced 
parameters: - $ref: '#/components/parameters/Page' - $ref: 
'#/components/parameters/PageSize' - $ref: '#/components/parameters/SortBy' # 
e.g. name, created_at - $ref: '#/components/parameters/Order' - $ref: 
'#/components/parameters/Lang' - name: waypoint_primary_category_id in: query 
description: Filter by primary category ID. schema: { type: integer } - name: 
town_id in: query description: Filter by town ID. schema: { type: integer } - 
name: tags_include_any # Example for array field filtering in: query 
description: Comma-separated list of tag IDs (from `tags_master.id`) to filter 
by (waypoint must have at least one). schema: { type: string } - name: bbox # 
Example spatial filter in: query description: Bounding box to filter waypoints 
geographically (e.g., minLng,minLat,maxLng,maxLat). schema: { type: string, 
pattern: "^-?\d+\.?\d*,-?\d+\.?\d*,-?\d+\.?\d*,-?\d+\.?\d*$" } 
responses: '200': description: A paginated list of waypoints. content: 
application/json: schema: type: object properties: data: type: array items: 
$ref: '#/components/schemas/Waypoint' pagination: $ref: 
'#/components/schemas/PaginationEnvelope' '400': $ref: 
'#/components/responses/BadRequestError' # For invalid filter params default: 
$ref: '#/components/responses/DefaultError' post: tags: [Waypoints] summary: 
Create Waypoint description: |- Creates a new waypoint. Translatable fields 
like `name`, `description` are submitted in English. Requires appropriate 
content creation role (e.g., `regional_content_manager`, `admin`). 
`created_by_profile_id` is automatically set to the authenticated user's ID. 
operationId: createWaypoint requestBody: required: true content: 
application/json: schema: $ref: '#/components/schemas/WaypointCreate' 
responses: '201': description: Waypoint created successfully. Response fields 
like `name`, `description` will be in English. content: application/json: 
schema: $ref: '#/components/schemas/Waypoint' '400': $ref: 
'#/components/responses/BadRequestError' '401': $ref: 
'#/components/responses/UnauthorizedError' '403': $ref: 
'#/components/responses/ForbiddenError' /waypoints/{waypoint_id}: get: tags: 
[Waypoints] summary: Get Waypoint by ID description: |- Retrieves a specific 
waypoint by its ID. Publicly accessible if published and not deleted (RLS 
enforced). operationId: getWaypointById security: [] # Public, RLS enforced 
parameters: - name: waypoint_id in: path required: true description: ID of the 
waypoint to retrieve. schema: type: integer format: int64 # DB is bigint - 
$ref: '#/components/parameters/Lang' responses: '200': description: Waypoint 
details. content: application/json: schema: $ref: 
'#/components/schemas/Waypoint' '404': $ref: 
'#/components/responses/NotFoundError' default: $ref: 
'#/components/responses/DefaultError' patch: tags: [Waypoints] summary: Update 
Waypoint (Partial) description: |- Partially updates an existing waypoint. 
Translatable fields like `name`, `description` in the request body should be in 
English if being updated. Requires appropriate content editing role (e.g., 
owner, `regional_content_manager`, `admin`). `updated_by_profile_id` is 
automatically set. operationId: updateWaypointPartial parameters: - name: 
waypoint_id in: path required: true description: ID of the waypoint to update. 
schema: type: integer format: int64 requestBody: required: true content: 
application/json: # Using WaypointCreate as it contains all mutable fields (all 
optional for PATCH) schema: $ref: '#/components/schemas/WaypointCreate' 
responses: '200': description: Waypoint updated successfully. Response `name`, 
`description` will be based on `lang` param if specified, else English. 
content: application/json: schema: $ref: '#/components/schemas/Waypoint' '400': 
$ref: '#/components/responses/BadRequestError' '401': $ref: 
'#/components/responses/UnauthorizedError' '403': $ref: 
'#/components/responses/ForbiddenError' '404': $ref: 
'#/components/responses/NotFoundError' # Conceptual shared responses (defined 
here for module context) responses: BadRequestError: description: Bad Request - 
The server cannot or will not process the request due to an apparent client 
error. content: application/json: schema: $ref: '#/components/schemas/ApiError' 
UnauthorizedError: description: Unauthorized - Authentication is required and 
has failed or has not yet been provided. content: application/json: schema: 
$ref: '#/components/schemas/ApiError' ForbiddenError: description: Forbidden - 
The server understood the request but refuses to authorize it. content: 
application/json: schema: $ref: '#/components/schemas/ApiError' NotFoundError: 
description: Not Found - The requested resource could not be found. content: 
application/json: schema: $ref: '#/components/schemas/ApiError' DefaultError: # 
For non-2xx responses not explicitly defined description: An unexpected error 
occurred. content: application/json: schema: $ref: 
'#/components/schemas/ApiError' ``` * * * * * ### Quick-Start Examples 1. List 
Active Waypoint Categories (in Italian, page 1, 2 items per page) - `curl -X 
GET 
"https://api.viadifrancesco.example.com/v1/waypoint_categories?lang=it&page=1&pa
ge_size=2&sort_by=sort_order" -H "Authorization: Bearer 
<YOUR_ANON_OR_USER_TOKEN>"` - Sample JSON Response: JSON ``` { "data": [ { 
"id": 1, "code": "accommodation_location", "label": "Alloggio", // Translated 
to Italian "description": "Luoghi di soggiorno per pellegrini.", // Translated 
"icon_identifier": "icon-bed", "requires_detail_table": "accommodations", 
"sort_order": 10, "is_active": true, "created_at": "2024-01-10T10:00:00Z", 
"updated_at": "2024-01-10T10:00:00Z", "created_by_profile_id": "system-uuid", 
"updated_by_profile_id": "system-uuid" }, { "id": 3, "code": 
"food_water_source", "label": "Fonte di Cibo e Acqua", // Translated 
"description": "Luoghi dove trovare cibo e acqua potabile.", // Translated 
"icon_identifier": "icon-restaurant", "requires_detail_table": 
"food_water_sources_details", "sort_order": 15, "is_active": true, 
"created_at": "2024-01-10T10:00:00Z", "updated_at": "2024-01-10T10:00:00Z", 
"created_by_profile_id": "system-uuid", "updated_by_profile_id": "system-uuid" 
} ], "pagination": { "total_items": 5, "total_pages": 3, "current_page": 1, 
"page_size": 2 } } ``` 2. Get Waypoint Details (ID 42, default language - 
English) - `curl -X GET 
"https://api.viadifrancesco.example.com/v1/waypoints/42" -H "Authorization: 
Bearer <YOUR_ANON_OR_USER_TOKEN>"` - Sample JSON Response: JSON ``` { "id": 42, 
"name": "La Verna Sanctuary", // English (default) "slug": 
"la-verna-sanctuary", "alternate_names_primary_lang": ["Monte Penna 
Sanctuary"], "waypoint_primary_category_id": 2, "waypoint_subcategory_tag_ids": 
[10, 15], "description": "A major Franciscan sanctuary located on Mount Penna, 
site of St. Francis receiving the stigmata.", // English "geom": { "type": 
"Point", "coordinates": [11.9296, 43.7053, 1128] }, "latitude": 43.7053, 
"longitude": 11.9296, "elevation_meters": 1128, "town_id": 205, 
"parent_waypoint_id": null, "address_text": "Chiusi della Verna, AR, Italy", // 
English "primary_image_media_id": "media-uuid-001", 
"primary_thumbnail_media_id": "media-uuid-002", "content_visibility_status_id": 
2, // e.g. "published" "is_seasonal": false, "is_trail_access_point": true, 
"is_significant_trail_junction": true, "is_franciscan_highlight_site": true, 
"is_significant_pilgrim_poi": true, "created_at": "2024-03-01T12:00:00Z", 
"created_by_profile_id": "admin-profile-uuid", "updated_at": 
"2024-05-01T15:30:00Z", "updated_by_profile_id": "admin-profile-uuid", 
"deleted_at": null } ``` 3. Create a New Waypoint (as a Regional Content 
Manager) - curl -X POST "https://api.viadifrancesco.example.com/v1/waypoints" 
-H "Authorization: Bearer <CONTENT_MANAGER_JWT_TOKEN>" -H "Content-Type: 
application/json" -d '{ "name": "Hermitage Le Celle", 
"waypoint_primary_category_id": 2, "geom": { "type": "Point", "coordinates": 
[12.0385, 43.3175, 500] }, "content_visibility_status_id": 1, "description": "A 
Franciscan hermitage near Cortona, founded by St. Francis himself.", 
"is_franciscan_highlight_site": true, "is_significant_pilgrim_poi": true, 
"town_id": 78 }' (Note: name and description are provided in English, the 
primary reference language, for creation.) - Sample JSON Response (201 Created, 
assuming no `lang` param was sent with the POST, so response defaults to 
English for translatable fields): JSON ``` { "id": 1025, "name": "Hermitage Le 
Celle", // English "slug": "hermitage-le-celle", 
"alternate_names_primary_lang": null, "waypoint_primary_category_id": 2, 
"waypoint_subcategory_tag_ids": null, "description": "A Franciscan hermitage 
near Cortona, founded by St. Francis himself.", // English "geom": { "type": 
"Point", "coordinates": [12.0385, 43.3175, 500] }, "latitude": 43.3175, 
"longitude": 12.0385, "elevation_meters": 500, "town_id": 78, 
"parent_waypoint_id": null, "address_text": null, "primary_image_media_id": 
null, "primary_thumbnail_media_id": null, "content_visibility_status_id": 1, // 
e.g., "draft" "is_seasonal": false, "is_trail_access_point": false, 
"is_significant_trail_junction": false, "is_franciscan_highlight_site": true, 
"is_significant_pilgrim_poi": true, "short_narrative_for_dynamic_lists": null, 
"waypoint_accessibility_notes": null, "general_tags_text": null, 
"primary_data_source_waypoint": null, "quality_score": null, "created_at": 
"2025-05-18T19:30:00Z", "created_by_profile_id": "regional-manager-uuid", 
"updated_at": "2025-05-18T19:30:00Z", "updated_by_profile_id": 
"regional-manager-uuid", "deleted_at": null } ``` * * * * * ### Implementation 
Notes - SQL Views, Indexes, or Materialized Views: - Localized Views: The 
`v_waypoint_categories_localized` and `v_tags_localized` views (from `4.0.2 - 
Views for Module 4.docx`) are key. The API backend should query these, using 
the `lang` parameter to select the appropriate translated text from the 
`all_translations` JSONB object (or the view's primary language 
`label`/`description` column if `lang` is English or the translation is 
missing). - Indexes for Master Tables: - `waypoint_categories_master`: Ensure 
indexes on `is_active`, `sort_order`, `code`. An index on `label` (the English 
primary) can aid default sorting before translation. - `tags_master`: Ensure 
indexes on `is_active`, `tag_type`, `sort_order`, `tag_code`. Index `label` 
(English) similarly. - `content_statuses_master`: Indexes on `is_active`, 
`sort_order`, `code`. Index `label` (English) similarly. - Indexes for 
`waypoints` table: - GIST index on `geom` is essential for spatial queries 
(`bbox`). - Indexes on FKs: `waypoint_primary_category_id`, 
`content_visibility_status_id`, `town_id`. - GIN index on 
`waypoint_subcategory_tag_ids` is crucial for tag filtering. - GIN index on 
`name` (the English name column) using `pg_trgm` (e.g., 
`idx_waypoints_name_trgm`) for fuzzy text search. - Index on `deleted_at` for 
querying non-deleted waypoints. - Index for `translations` table: A composite 
index on `(table_identifier, row_foreign_key, language_code, 
column_identifier)` like `idx_translations_lookup` is vital. - Schema Feedback 
(Module 4): - 🟢 Schema OK. The database specifications for `waypoints` (v1.3), 
`waypoint_categories_master` (v1.2), `tags_master` (v1.3), and 
`content_statuses_master` (v1.2) are comprehensive and support this API model 
well. - The database columns for translatable text (e.g., `waypoints.name`, 
`waypoint_categories_master.label`) correctly store the primary reference 
language (English). The API layer is responsible for using the `lang` parameter 
to fetch and present the appropriate translation from the `public.translations` 
table (potentially via the localized views). - The trigger 
`trigger_check_waypoint_subcategory_tags` on `waypoints` to ensure integrity of 
`waypoint_subcategory_tag_ids` against `tags_master` (including its `is_active` 
status) remains critical. * * * * * 
