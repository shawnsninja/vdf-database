# 4.0.2 - Views for Module 4

  https://gemini.google.com/u/1/app/117b6ecbb3fe7734 Okay, the next document we 
will update is the View Specifications for Localized Master Data . This 
document contains specifications for public.v_waypoint_categories_localized and 
public.v_tags_localized . The main updates will be to their "RLS & Security 
Notes" sections to ensure they align with the RLS changes made to their base 
tables and the overall security architecture. I'll call this updated version 
1.1 of the view specifications. View Specifications for Localized Master Data 
(Version 1.1) This document provides specifications for database views designed 
to support localized data retrieval for master tables in the Via di Francesco 
V2 database. These views primarily aim to simplify API development by 
pre-joining master table data with their corresponding translations. Version 
1.1 updates RLS & Security Notes to align with platform-wide authentication and 
authorization enhancements. 1. View: public.v_waypoint_categories_localized 
1.1. View Name public.v_waypoint_categories_localized 1.2. Purpose & Primary 
Use-Cases Purpose : To provide a consolidated view of waypoint categories along 
with all their available translations for labels and descriptions in a 
structured JSONB format. Primary Use-Cases : Support API endpoints that list 
waypoint categories and need to return names and descriptions in a specific 
user-requested language or show all available translations. Simplify backend 
queries by abstracting the join and aggregation logic required to fetch 
translations. Populate UI elements like filter dropdowns or category lists 
where multilingual display is required. 1.3. View Schema (Columns) Column Name 
Data Type Description id INTEGER Inherited from waypoint_categories_master . 
Unique identifier for the waypoint category. code TEXT Inherited from 
waypoint_categories_master . Short, stable, machine-readable code. label TEXT 
Inherited from waypoint_categories_master . Primary reference language 
(English) label. description TEXT Inherited from waypoint_categories_master . 
Optional primary reference language (English) description. icon_identifier TEXT 
Inherited from waypoint_categories_master . Name, class, or path for a UI icon. 
requires_detail_table TEXT Inherited from waypoint_categories_master . 
Optional: Name of the specific detail table this category typically links to. 
sort_order INTEGER Inherited from waypoint_categories_master . Determines 
display order. is_active BOOLEAN Inherited from waypoint_categories_master . 
True if the category definition is active. created_at TIMESTAMPTZ Inherited 
from waypoint_categories_master . Timestamp of record creation. updated_at 
TIMESTAMPTZ Inherited from waypoint_categories_master . Timestamp of last 
update. created_by_profile_id UUID Inherited from waypoint_categories_master . 
Profile ID of the creator. updated_by_profile_id UUID Inherited from 
waypoint_categories_master . Profile ID of the last updater. all_translations 
JSONB A JSONB object containing all available translations for label and 
description , keyed by language code. Example: {"en": {"label": 
"Accommodation", "description": "Places to stay..."}, "it": {"label": 
"Alloggio", "description": "Luoghi di soggiorno..."}} 1.4. Underlying SQL 
Definition SQL CREATE OR REPLACE VIEW public.v_waypoint_categories_localized AS 
SELECT wcm.id, wcm.code, wcm.label, -- Primary English label wcm.description, 
-- Primary English description wcm.icon_identifier, wcm.requires_detail_table, 
wcm.sort_order, wcm.is_active, wcm.created_at, wcm.updated_at, 
wcm.created_by_profile_id, wcm.updated_by_profile_id, ( SELECT 
jsonb_object_agg( tr.language_code, jsonb_build_object( 'label' , MAX ( CASE 
WHEN tr.column_name = 'label' THEN tr.translated_text ELSE NULL END ), 
'description' , MAX ( CASE WHEN tr.column_name = 'description' THEN 
tr.translated_text ELSE NULL END ) ) ) FROM public.translations tr WHERE 
tr.table_name = 'waypoint_categories_master' AND tr.row_foreign_key = 
wcm.id::TEXT GROUP BY tr.row_foreign_key ) AS all_translations FROM 
public.waypoint_categories_master wcm; COMMENT ON VIEW 
public.v_waypoint_categories_localized IS 'Provides waypoint categories with 
their English base fields and a JSONB column "all_translations" containing all 
available label and description translations keyed by language code. Version 
1.1' ; COMMENT ON COLUMN public.v_waypoint_categories_localized.label IS 
'Primary reference language (English) label from waypoint_categories_master.' ; 
COMMENT ON COLUMN public.v_waypoint_categories_localized.description IS 
'Primary reference language (English) description from 
waypoint_categories_master.' ; COMMENT ON COLUMN 
public.v_waypoint_categories_localized.all_translations IS 'JSONB object with 
all translations for label and description, keyed by language code. E.g., 
{"en": {"label": "...", "description": "..."}, "it": {"label": "...", 
"description": "..."}}. Note: This currently includes only translations present 
in the public.translations table; base English text from the master table 
should be merged by the application/API layer if not also present in 
translations.' ; 1.5. Key Dependencies public.waypoint_categories_master 
(Version 1.2 or later, with updated RLS) public.translations 1.6. Performance 
Considerations The subquery with jsonb_object_agg can be resource-intensive if 
the translations table is very large and not properly indexed. Required Indexes 
on public.translations : A composite index on (table_name, row_foreign_key, 
language_code, column_name) is crucial. CREATE INDEX IF NOT EXISTS 
idx_translations_lookup ON public.translations(table_name, row_foreign_key, 
language_code, column_name); Queries on this view filtering by is_active from 
the base table will benefit from the idx_wc_master_is_active index on 
waypoint_categories_master . 1.7. RLS & Security Notes RLS Inheritance : This 
view inherits Row-Level Security (RLS) policies from its base table, 
public.waypoint_categories_master . Public Access : The RLS policy on 
waypoint_categories_master ("Allow public read access to active waypoint 
categories") allows SELECT operations for all users (anonymous and 
authenticated) USING (is_active = true) . This means this view will only return 
active waypoint categories to general users. Admin Access : Users with the 
platform_admin role (or other roles like admin granted explicit broader SELECT 
permissions on waypoint_categories_master via public.has_role(TEXT) ) may see 
all records (active and inactive) through this view, depending on the specifics 
of their RLS policies on the base table. Translations Table Access : It's 
assumed that if a user has permission to view a waypoint_categories_master 
record, they also have implicit permission to view its corresponding 
translations. The public.translations table itself might have its own RLS 
(e.g., ensuring users can only see translations for records they are allowed to 
see in the parent table), though typically view security on the parent record 
suffices. 1.8. API Endpoints Supported Primarily supports GET 
/waypoint_categories by allowing easy extraction of translated fields based on 
a lang parameter processed at the API level by querying the all_translations 
JSONB. 1.9. Rationale for Creation Decouples the API data retrieval logic from 
complex translation join/aggregation. Provides a consistent way to access 
localized content for waypoint categories. Improves query readability for 
developers using the view. 2. View: public.v_tags_localized 2.1. View Name 
public.v_tags_localized 2.2. Purpose & Primary Use-Cases Purpose : To provide a 
consolidated view of tags along with all their available translations for 
labels and descriptions in a structured JSONB format. Primary Use-Cases : 
Support API endpoints that list tags (e.g., for filtering waypoints or events) 
and need to return names and descriptions in a specific user-requested language 
or show all available translations. Simplify backend queries for fetching 
localized tag information. Populate UI elements such as tag clouds or filter 
options with multilingual capabilities. 2.3. View Schema (Columns) Column Name 
Data Type Description id INTEGER Inherited from tags_master . Unique identifier 
for the tag. tag_code TEXT Inherited from tags_master . Short, stable, 
machine-readable code. label TEXT Inherited from tags_master . Primary 
reference language (English) label. description TEXT Inherited from tags_master 
. Optional primary reference language (English) description. tag_type TEXT 
Inherited from tags_master . Optional: A way to group tags (e.g., 'amenity', 
'event_theme'). icon_identifier TEXT Inherited from tags_master . Optional: 
Name, class, or path for a UI icon. sort_order INTEGER Inherited from 
tags_master . Determines display order. is_active BOOLEAN Inherited from 
tags_master . True if the tag definition is active. created_at TIMESTAMPTZ 
Inherited from tags_master . Timestamp of record creation. updated_at 
TIMESTAMPTZ Inherited from tags_master . Timestamp of last update. 
created_by_profile_id UUID Inherited from tags_master . Profile ID of the 
creator. updated_by_profile_id UUID Inherited from tags_master . Profile ID of 
the last updater. all_translations JSONB A JSONB object containing all 
available translations for label and description , keyed by language code. 
Example: {"en": {"label": "Pilgrim Menu", "description": "Offers special 
menu..."}, "it": {"label": "Menu Pellegrino", "description": "Offre menu 
speciale..."}} 2.4. Underlying SQL Definition SQL CREATE OR REPLACE VIEW 
public.v_tags_localized AS SELECT tm.id, tm.tag_code, tm.label, -- Primary 
English label tm.description, -- Primary English description tm.tag_type, 
tm.icon_identifier, tm.sort_order, tm.is_active, tm.created_at, tm.updated_at, 
tm.created_by_profile_id, tm.updated_by_profile_id, ( SELECT jsonb_object_agg( 
tr.language_code, jsonb_build_object( 'label' , MAX ( CASE WHEN tr.column_name 
= 'label' THEN tr.translated_text ELSE NULL END ), 'description' , MAX ( CASE 
WHEN tr.column_name = 'description' THEN tr.translated_text ELSE NULL END ) ) ) 
FROM public.translations tr WHERE tr.table_name = 'tags_master' AND 
tr.row_foreign_key = tm.id::TEXT GROUP BY tr.row_foreign_key ) AS 
all_translations FROM public.tags_master tm; COMMENT ON VIEW 
public.v_tags_localized IS 'Provides tags with their English base fields and a 
JSONB column "all_translations" containing all available label and description 
translations keyed by language code. Version 1.1' ; COMMENT ON COLUMN 
public.v_tags_localized.label IS 'Primary reference language (English) label 
from tags_master.' ; COMMENT ON COLUMN public.v_tags_localized.description IS 
'Primary reference language (English) description from tags_master.' ; COMMENT 
ON COLUMN public.v_tags_localized.all_translations IS 'JSONB object with all 
translations for label and description, keyed by language code. E.g., {"en": 
{"label": "...", "description": "..."}, "it": {"label": "...", "description": 
"..."}}. Note: This currently includes only translations present in the 
public.translations table; base English text from the master table should be 
merged by the application/API layer if not also present in translations.' ; 
2.5. Key Dependencies public.tags_master (Version 1.3 or later, with updated 
RLS) public.translations 2.6. Performance Considerations Similar to 
v_waypoint_categories_localized , performance hinges on the jsonb_object_agg 
subquery. Required Indexes on public.translations : The composite index 
idx_translations_lookup ON public.translations(table_name, row_foreign_key, 
language_code, column_name) is essential. Queries on this view filtering by 
is_active or tag_type from the base table will benefit from indexes on 
tags_master ( idx_tags_master_is_active , idx_tags_master_tag_type ). 2.7. RLS 
& Security Notes RLS Inheritance : This view inherits RLS policies from its 
base table, public.tags_master . Public Access : The RLS policy on tags_master 
("Allow public read access to active tags") permits SELECT for all users USING 
(is_active = true) . Consequently, this view will only expose active tags to 
the general public. Admin/Manager Access : Users with roles like platform_admin 
, admin , or regional_content_manager (if granted broader SELECT on tags_master 
via public.has_role(TEXT) ) may see all tag records (active and inactive) 
through this view, guided by their respective RLS on the base table. 
Translations Table Access : Access to translations is implicitly granted if the 
user can view the parent tag record. 2.8. API Endpoints Supported Primarily 
supports GET /tags by allowing easy extraction of translated fields based on a 
lang parameter processed at the API level by querying the all_translations 
JSONB. 2.9. Rationale for Creation Simplifies API logic for retrieving 
localized tag data. Offers a consistent interface for accessing translated tag 
content. Reduces query complexity in the application/API layer. 
