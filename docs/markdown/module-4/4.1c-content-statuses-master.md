# 4.1c content_statuses_master

  https://gemini.google.com/u/1/app/980a7af1dc7f079a 
https://gemini.google.com/u/1/app/117b6ecbb3fe7734 * * * * * Updated 
Production-Ready Specification: Content Statuses Master Table (Version 1.2) 
--------------------------------------------------------------------------------
--- This document details the structure, purpose, and considerations for the 
`content_statuses_master` table. This table is fundamental for managing the 
lifecycle and visibility of content across the platform. Version 1.2 updates 
RLS policies for consistency with the platform-wide security architecture. 
Version 1.1 incorporated the `is_active` flag for the lifecycle management of 
status definitions themselves and included standard V2 enhancements. 1\. 
Purpose & Primary Use-Cases The `content_statuses_master` table defines the 
various states content can be in (e.g., "Draft," "Published"). Its purpose is 
to standardize content visibility and workflow progression, allowing separation 
of work-in-progress from public content and supporting moderation. Key uses 
include admin content lifecycle management and system filtering for public 
display. 2\. Updated Schema (Markdown Table) | column | data_type | constraints 
| description | | id | integer | Primary Key (Generated as identity always) | 
Unique identifier for the content status. | | code | text | Unique, Not Null, 
CHECK (length(code) > 0 AND length(code) &lt;= 50 AND code ~ '^[a-z0-9_]+$') | 
Short, stable, machine-readable code (e.g., 'draft', 'published'). Snake_case, 
max 50 chars. | | label | text | Not Null, CHECK (length(label) > 0 AND 
length(label) &lt;= 100) | Human-readable name for the status. (Translatable 
via `public.translations`). Primary reference language (English). Max 100 
chars. | | description | text | Nullable | Optional description of the status. 
(Translatable via `public.translations`). Primary reference language (English). 
| | is_publicly_visible | boolean | Not Null, Default false | Indicates if 
*content with this status* is generally visible to non-authenticated/public 
users (e.g., 'published' would be true). | | sort_order | integer | Not Null, 
Default 0 | Determines the display order of statuses in UI selection lists or 
workflow diagrams. Lower numbers appear first. | | is_active | boolean | Not 
Null, Default true | True if the status definition itself is active and 
available for assignment to content; false if this status definition is 
retired. | | created_at | timestamp with time zone | Not Null, Default now() | 
Timestamp of record creation. | | updated_at | timestamp with time zone | Not 
Null, Default now() | Timestamp of last update (auto-updated by trigger). | | 
created_by_profile_id | uuid | Nullable, Foreign Key to profiles(id) ON DELETE 
SET NULL | Profile ID of the user who created the record (typically an admin 
for initial setup). | | updated_by_profile_id | uuid | Nullable, Foreign Key to 
profiles(id) ON DELETE SET NULL | Profile ID of the user who last updated the 
record. | 3\. PostgreSQL DDL SQL ``` -- Assumes public.profiles table exists 
and has a `roles TEXT[]` column. -- Assumes RLS helper function 
public.has_role(TEXT) RETURNS BOOLEAN exists. -- Assumes 
public.set_current_timestamp_updated_at() function exists. -- Assumes 
public.cleanup_related_translations(TEXT) function exists. CREATE TABLE 
public.content_statuses_master ( id SERIAL PRIMARY KEY, code TEXT UNIQUE NOT 
NULL CHECK (length(code) > 0 AND length(code) <= 50 AND code ~ '^[a-z0-9_]+$'), 
label TEXT NOT NULL CHECK (length(label) > 0 AND length(label) <= 100), 
description TEXT NULL, is_publicly_visible BOOLEAN NOT NULL DEFAULT FALSE, 
sort_order INTEGER NOT NULL DEFAULT 0, is_active BOOLEAN NOT NULL DEFAULT true, 
created_at TIMESTAMPTZ NOT NULL DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL 
DEFAULT now(), created_by_profile_id UUID NULL REFERENCES public.profiles(id) 
ON DELETE SET NULL, updated_by_profile_id UUID NULL REFERENCES 
public.profiles(id) ON DELETE SET NULL ); COMMENT ON TABLE 
public.content_statuses_master IS 'Master list of content publication statuses 
(e.g., draft, published, archived). `label` and `description` are translatable. 
Version 1.2'; COMMENT ON COLUMN public.content_statuses_master.id IS 'Unique 
identifier for the content status.'; COMMENT ON COLUMN 
public.content_statuses_master.code IS 'Short, stable, machine-readable code 
(snake_case). Max 50 chars. E.g., ''draft'', ''published''.'; COMMENT ON COLUMN 
public.content_statuses_master.label IS 'Human-readable English label for UI 
and translation base. Max 100 chars. (Translatable via public.translations).'; 
COMMENT ON COLUMN public.content_statuses_master.description IS 'Optional 
English description of the status. (Translatable via public.translations).'; 
COMMENT ON COLUMN public.content_statuses_master.is_publicly_visible IS 
'Boolean flag indicating if content *assigned* this status is generally visible 
to the public.'; COMMENT ON COLUMN public.content_statuses_master.sort_order IS 
'Determines the display order in UI lists or workflow representations.'; 
COMMENT ON COLUMN public.content_statuses_master.is_active IS 'True if the 
status definition itself is active and available for assignment to content; 
false if this status definition is retired. Defaults to true.'; COMMENT ON 
COLUMN public.content_statuses_master.created_at IS 'Timestamp of record 
creation.'; COMMENT ON COLUMN public.content_statuses_master.updated_at IS 
'Timestamp of last update (auto-updated by trigger).'; COMMENT ON COLUMN 
public.content_statuses_master.created_by_profile_id IS 'Profile ID of the user 
who created the record.'; COMMENT ON COLUMN 
public.content_statuses_master.updated_by_profile_id IS 'Profile ID of the user 
who last updated the record.'; -- Indexes CREATE INDEX IF NOT EXISTS 
idx_cs_master_created_by ON 
public.content_statuses_master(created_by_profile_id); CREATE INDEX IF NOT 
EXISTS idx_cs_master_updated_by ON 
public.content_statuses_master(updated_by_profile_id); CREATE INDEX IF NOT 
EXISTS idx_cs_master_is_publicly_visible ON 
public.content_statuses_master(is_publicly_visible); CREATE INDEX IF NOT EXISTS 
idx_cs_master_sort_order ON public.content_statuses_master(sort_order); CREATE 
INDEX IF NOT EXISTS idx_cs_master_is_active ON 
public.content_statuses_master(is_active); -- Trigger for updated_at CREATE 
TRIGGER trigger_content_statuses_master_set_updated_at BEFORE UPDATE ON 
public.content_statuses_master FOR EACH ROW EXECUTE FUNCTION 
public.set_current_timestamp_updated_at(); COMMENT ON TRIGGER 
trigger_content_statuses_master_set_updated_at ON 
public.content_statuses_master IS 'Trigger to automatically update updated_at 
timestamp on row modification.'; -- Trigger for orphan translation cleanup 
CREATE TRIGGER trigger_cleanup_content_statuses_master_translations AFTER 
DELETE ON public.content_statuses_master FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_related_translations('content_statuses_master'); COMMENT ON 
TRIGGER trigger_cleanup_content_statuses_master_translations ON 
public.content_statuses_master IS 'Cleans up orphaned translations when a 
content status is deleted. The trigger function should pass OLD.id::TEXT as the 
row foreign key.'; ``` 4\. JSON Schema Mirror JSON ``` { "title": 
"content_status_master", "description": "Master list of content publication 
statuses. `label` and `description` are translatable. Version 1.2", "type": 
"object", "properties": { "id": { "type": "integer", "description": "Unique 
identifier for the content status. Primary Key.", "readOnly": true }, "code": { 
"type": "string", "description": "Short, stable, machine-readable code 
(snake_case). Max 50 chars.", "pattern": "^[a-z0-9_]+$", "maxLength": 50 }, 
"label": { "type": "string", "description": "Human-readable English label for 
UI and translation base. Max 100 chars. (Translatable via 
public.translations).", "maxLength": 100 }, "description": { "type": ["string", 
"null"], "description": "Optional English description of the status. 
(Translatable via public.translations)." }, "is_publicly_visible": { "type": 
"boolean", "default": false, "description": "Indicates if content *assigned* 
this status is generally visible to the public." }, "sort_order": { "type": 
"integer", "default": 0, "description": "Determines display order in UI lists 
or workflow representations." }, "is_active": { "type": "boolean", "default": 
true, "description": "True if the status definition itself is active and 
available for assignment to content; false if this status definition is 
retired." }, "created_at": { "type": "string", "format": "date-time", 
"description": "Timestamp of record creation.", "readOnly": true }, 
"updated_at": { "type": "string", "format": "date-time", "description": 
"Timestamp of last update.", "readOnly": true }, "created_by_profile_id": { 
"type": ["string", "null"], "format": "uuid", "description": "Profile ID of the 
user who created the record." }, "updated_by_profile_id": { "type": ["string", 
"null"], "format": "uuid", "description": "Profile ID of the user who last 
updated the record." } }, "required": [ "code", "label", "is_publicly_visible", 
"sort_order", "is_active" ] } ``` 5\. Relationships & Integrity - Primary Key: 
`id` (SERIAL -> INTEGER) - Unique Constraint: `code` must be unique. - Foreign 
Key References FROM other tables: - `waypoints.content_visibility_status_id` 
REFERENCES `public.content_statuses_master(id)` (ON DELETE RESTRICT). - Other 
content tables (e.g., `articles`, `curated_itineraries`) will also use this 
table for status management. - Foreign Key References TO other tables: - 
`created_by_profile_id` REFERENCES `public.profiles(id)` ON DELETE SET NULL. - 
`updated_by_profile_id` REFERENCES `public.profiles(id)` ON DELETE SET NULL. - 
Data Integrity Notes: - Deletion of a status definition will be restricted if 
any content item is actively using it. Retiring a status definition should be 
done by setting `is_active = false`. 6\. Multilingual Strategy - Translatable 
Fields: - `label`: The English name for the status. (Translatable via 
`public.translations`) - `description`: The English description for the status. 
(Translatable via `public.translations`) - Non-Translatable Fields: - `code` is 
a stable identifier and is not translated. - `is_publicly_visible` and 
`is_active` are system flags. - Translation Management: - An `AFTER DELETE` 
trigger (`trigger_cleanup_content_statuses_master_translations`) is implemented 
to call `public.cleanup_related_translations` to remove orphaned translations. 
7\. Role-Based Workflow & RLS Notes - Content Management: This table defines 
the core lifecycle statuses for content. Definitions are managed by users with 
the `platform_admin` role. Other authenticated users (like `admin`, 
`regional_content_manager`) need to be able to read these statuses to assign 
them to content items they manage. - Lifecycle: Status definitions are retired 
by setting `is_active = false`. - RLS Policies: - Enable RLS: SQL ``` ALTER 
TABLE public.content_statuses_master ENABLE ROW LEVEL SECURITY; ``` - Anonymous 
& Authenticated Users (Read-Only for Active Status Definitions): All users who 
might need to understand or assign statuses (including anonymous users if UI 
elements display status labels from here for public content) need to read 
active status definitions. SQL ``` CREATE POLICY "Allow public read access to 
active content status definitions" ON public.content_statuses_master FOR SELECT 
USING (is_active = true); ``` - Platform Administrators (Full Control over 
Status Definitions): SQL ``` CREATE POLICY "Allow platform_admins full access 
to content status definitions" ON public.content_statuses_master FOR ALL USING 
(public.has_role('platform_admin')) WITH CHECK 
(public.has_role('platform_admin')); ``` - Note: Ensure the 
`public.has_role(TEXT)` function is defined and correctly checks the `roles` 
array in the `public.profiles` table for the current `auth.uid()`. This RLS 
implies that only `platform_admin` can create, update, or delete these master 
status definitions. Other roles select from the active ones. 8\. ENUM vs Lookup 
Discussion - 🟢 Decision: This `content_statuses_master` table correctly 
promotes an original ENUM concept for content status management. - Reasoning: A 
master lookup table provides clarity, richness (additional attributes like 
`description`, `is_publicly_visible`, `is_active`, `sort_order`), i18n, 
maintainability, workflow support, and auditability. 9\. UI/UX Enablement - 
`label` (translated): Used for display names in status selectors in content 
management forms, and potentially in workflow diagrams or status indicators. - 
`is_publicly_visible`: Crucial for system logic to determine what content RLS 
policies should expose to the public. - `sort_order`: Ensures a logical 
presentation of statuses in dropdowns or workflow step displays. - `is_active`: 
UI for content management should primarily offer active status definitions for 
assignment. - Default Value: Tables like `waypoints` correctly default their 
status FK to the 'draft' status ID from this table. 10\. Key Considerations & 
Definitions - Core Statuses: The initial set ('draft', 'pending_review', 
'published', 'archived', 'private') covers common content lifecycles. - 
`is_publicly_visible` Flag: This is a key field that drives how RLS policies 
should be constructed for public-facing content. - `is_active` Flag: Key for 
managing the lifecycle of the status definitions themselves. - Workflow 
Implications: Changes to statuses can impact content management workflows. 11\. 
Scalability & Future-Proofing - Lookup Table Structure: Easily supports adding 
new content statuses or modifying attributes of existing ones. - Manageable 
List: The number of distinct content statuses is expected to be small. - Audit 
Fields & `is_active` flag: Provide change history and robust lifecycle 
management. 12\. Next-Action Checklist - 🔴 Define Global RLS Helper Functions: 
Ensure `public.has_role(TEXT)` is implemented securely and available. - 🔴 
Create Table: Execute the DDL for `public.content_statuses_master` (Version 
1.2). - 🔴 Apply Triggers: Ensure `set_current_timestamp_updated_at` and 
`cleanup_related_translations` triggers are created and applied. Confirm 
`cleanup_related_translations` function is correctly set up. - 🔴 Initial 
Population: Insert defined content statuses (e.g., draft, published). Ensure 
`is_active = true`, `is_publicly_visible` is set appropriately, and 
`created_by_profile_id` is set (e.g., to a system admin ID). Crucially, ensure 
the 'draft' status ID exists before tables like `waypoints` are created due to 
its default FK constraint. - 🟠 RLS Policies: Implement and thoroughly test the 
RLS policies defined in section 7. - 🟢 Translation Entries: Prepare initial 
English entries for `label` and `description` in `public.translations`. * * * * 
* 
