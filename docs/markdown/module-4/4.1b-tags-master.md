# 4.1b tags_master

  https://gemini.google.com/u/1/app/980a7af1dc7f079a 
https://gemini.google.com/u/1/app/117b6ecbb3fe7734 * * * * * Updated 
Production-Ready Specification: Tags Master Table (Version 1.3) 
----------------------------------------------------------------------- This 
document details the structure, purpose, and considerations for the 
`tags_master` table. This table provides a controlled vocabulary for granularly 
tagging various entities, primarily waypoints and events. Version 1.3 updates 
RLS policies to align with the platform-wide security architecture. Version 1.2 
incorporated the `is_active` flag and standard V2 audit/indexing enhancements. 
1\. Purpose & Primary Use-Cases The `tags_master` table stores a curated list 
of descriptive tags. For waypoints, these are used via 
`waypoints.waypoint_subcategory_tag_ids` (e.g., "Franciscan Site"). For events, 
tags can define themes via `events_details.event_theme_or_focus_tag_ids` (e.g., 
"Medieval Festival"). It aims to standardize sub-categorization, support 
multilingual display, enable faceted search, and improve data consistency. 2\. 
Updated Schema (Markdown Table) | column | data_type | constraints | 
description | | id | integer | Primary Key (Generated as identity always) | 
Unique identifier for the tag. | | tag_code | text | Unique, Not Null, CHECK 
(length(tag_code) > 0 AND length(tag_code) &lt;= 50 AND tag_code ~ 
'^[a-z0-9_]+$') | Short, stable, machine-readable code for the tag (e.g., 
'franciscan_site'). Snake_case, max 50 chars. | | label | text | Not Null, 
CHECK (length(label) > 0 AND length(label) &lt;= 100) | Human-readable name for 
the tag. (Translatable via `public.translations`). Primary reference language 
(English). Max 100 chars. | | description | text | Nullable | Optional 
description of the tag. (Translatable via `public.translations`). Primary 
reference language (English). | | tag_type | text | Nullable, CHECK (tag_type 
IS NULL OR (length(tag_type) > 0 AND length(tag_type) &lt;= 50 AND tag_type ~ 
'^[a-z0-9_]+$')) | Optional: A way to group tags (e.g., 'amenity', 
'event_theme'). Snake_case, max 50 chars. | | icon_identifier | text | 
Nullable, CHECK (icon_identifier IS NULL OR length(icon_identifier) &lt;= 100) 
| Optional: Name, class, or path for a UI icon associated with this tag. Max 
100 chars. | | sort_order | integer | Not Null, Default 0 | Determines the 
display order of tags in UI lists or filters. Lower numbers appear first. | | 
is_active | boolean | Not Null, Default true | True if the tag is active and 
available for use; false if retired. | | created_at | timestamp with time zone 
| Not Null, Default now() | Timestamp of record creation. | | updated_at | 
timestamp with time zone | Not Null, Default now() | Timestamp of last update 
(auto-updated by trigger). | | created_by_profile_id | uuid | Nullable, Foreign 
Key to profiles(id) ON DELETE SET NULL | Profile ID of the user who created the 
record. | | updated_by_profile_id | uuid | Nullable, Foreign Key to 
profiles(id) ON DELETE SET NULL | Profile ID of the user who last updated the 
record. | 3\. PostgreSQL DDL SQL ``` -- Assumes public.profiles table exists 
and has a `roles TEXT[]` column. -- Assumes RLS helper function 
public.has_role(TEXT) RETURNS BOOLEAN exists. -- Assumes 
public.set_current_timestamp_updated_at() function exists. -- Assumes 
public.cleanup_related_translations(TEXT) function exists. CREATE TABLE 
public.tags_master ( id SERIAL PRIMARY KEY, tag_code TEXT UNIQUE NOT NULL CHECK 
(length(tag_code) > 0 AND length(tag_code) <= 50 AND tag_code ~ 
'^[a-z0-9_]+$'), label TEXT NOT NULL CHECK (length(label) > 0 AND length(label) 
<= 100), description TEXT NULL, tag_type TEXT NULL CHECK (tag_type IS NULL OR 
(length(tag_type) > 0 AND length(tag_type) <= 50 AND tag_type ~ 
'^[a-z0-9_]+$')), icon_identifier TEXT NULL CHECK (icon_identifier IS NULL OR 
length(icon_identifier) <= 100), sort_order INTEGER NOT NULL DEFAULT 0, 
is_active BOOLEAN NOT NULL DEFAULT true, created_at TIMESTAMPTZ NOT NULL 
DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), 
created_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE SET 
NULL, updated_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE 
SET NULL ); COMMENT ON TABLE public.tags_master IS 'Master list of descriptive 
tags for various entities (e.g., waypoints, events). `label` and `description` 
are translatable. Version 1.3'; COMMENT ON COLUMN public.tags_master.id IS 
'Unique identifier for the tag.'; COMMENT ON COLUMN public.tags_master.tag_code 
IS 'Short, stable, machine-readable code for the tag (snake_case). Max 50 
chars. E.g., ''franciscan_site'', ''medieval_theme''.'; COMMENT ON COLUMN 
public.tags_master.label IS 'Human-readable English label for UI and 
translation base. Max 100 chars. (Translatable via public.translations).'; 
COMMENT ON COLUMN public.tags_master.description IS 'Optional English 
description of the tag. (Translatable via public.translations).'; COMMENT ON 
COLUMN public.tags_master.tag_type IS 'Optional: Type to group tags (e.g., 
''amenity'', ''poi_feature'', ''event_theme''). Snake_case, max 50 chars. The 
label for the tag_type itself can be translated if needed by referencing its 
code in the translations table.'; COMMENT ON COLUMN 
public.tags_master.icon_identifier IS 'Optional: Name, class, or path for a UI 
icon associated with this tag. Max 100 chars.'; COMMENT ON COLUMN 
public.tags_master.sort_order IS 'Determines display order in UI lists/filters, 
potentially within a tag_type.'; COMMENT ON COLUMN public.tags_master.is_active 
IS 'True if the tag is active and available for use; false if retired. Defaults 
to true.'; COMMENT ON COLUMN public.tags_master.created_at IS 'Timestamp of 
record creation.'; COMMENT ON COLUMN public.tags_master.updated_at IS 
'Timestamp of last update (auto-updated by trigger).'; COMMENT ON COLUMN 
public.tags_master.created_by_profile_id IS 'Profile ID of the user who created 
the record.'; COMMENT ON COLUMN public.tags_master.updated_by_profile_id IS 
'Profile ID of the user who last updated the record.'; -- Indexes CREATE INDEX 
IF NOT EXISTS idx_tags_master_created_by ON 
public.tags_master(created_by_profile_id); CREATE INDEX IF NOT EXISTS 
idx_tags_master_updated_by ON public.tags_master(updated_by_profile_id); CREATE 
INDEX IF NOT EXISTS idx_tags_master_tag_type ON public.tags_master(tag_type) 
WHERE tag_type IS NOT NULL; CREATE INDEX IF NOT EXISTS 
idx_tags_master_sort_order ON public.tags_master(sort_order); CREATE INDEX IF 
NOT EXISTS idx_tags_master_is_active ON public.tags_master(is_active); CREATE 
INDEX IF NOT EXISTS idx_tags_master_label ON public.tags_master(label); -- For 
sorting by label -- Trigger for updated_at CREATE TRIGGER 
trigger_tags_master_set_updated_at BEFORE UPDATE ON public.tags_master FOR EACH 
ROW EXECUTE FUNCTION public.set_current_timestamp_updated_at(); COMMENT ON 
TRIGGER trigger_tags_master_set_updated_at ON public.tags_master IS 'Trigger to 
automatically update updated_at timestamp on row modification.'; -- Trigger for 
orphan translation cleanup CREATE TRIGGER 
trigger_cleanup_tags_master_translations AFTER DELETE ON public.tags_master FOR 
EACH ROW EXECUTE FUNCTION public.cleanup_related_translations('tags_master'); 
COMMENT ON TRIGGER trigger_cleanup_tags_master_translations ON 
public.tags_master IS 'Cleans up orphaned translations when a tag is deleted. 
The trigger function should pass OLD.id::TEXT as the row foreign key.'; ``` 4\. 
JSON Schema Mirror JSON ``` { "title": "tag_master", "description": "Master 
list of descriptive tags for various entities. `label` and `description` are 
translatable. Version 1.3", "type": "object", "properties": { "id": { "type": 
"integer", "description": "Unique identifier for the tag. Primary Key.", 
"readOnly": true }, "tag_code": { "type": "string", "description": "Short, 
stable, machine-readable code for the tag (snake_case). Max 50 chars.", 
"pattern": "^[a-z0-9_]+$", "maxLength": 50 }, "label": { "type": "string", 
"description": "Human-readable English label for UI and translation base. Max 
100 chars. (Translatable via public.translations).", "maxLength": 100 }, 
"description": { "type": ["string", "null"], "description": "Optional English 
description of the tag. (Translatable via public.translations)." }, "tag_type": 
{ "type": ["string", "null"], "description": "Optional: Type to group tags 
(e.g., 'amenity', 'poi_feature', 'event_theme'). Snake_case, max 50 chars.", 
"pattern": "^[a-z0-9_]+$", "maxLength": 50 }, "icon_identifier": { "type": 
["string", "null"], "maxLength": 100, "description": "Optional: Name, class, or 
path for a UI icon associated with this tag." }, "sort_order": { "type": 
"integer", "default": 0, "description": "Determines display order in UI 
lists/filters." }, "is_active": { "type": "boolean", "default": true, 
"description": "True if the tag is active and available for use; false if 
retired." }, "created_at": { "type": "string", "format": "date-time", 
"description": "Timestamp of record creation.", "readOnly": true }, 
"updated_at": { "type": "string", "format": "date-time", "description": 
"Timestamp of last update.", "readOnly": true }, "created_by_profile_id": { 
"type": ["string", "null"], "format": "uuid", "description": "Profile ID of the 
user who created the record." }, "updated_by_profile_id": { "type": ["string", 
"null"], "format": "uuid", "description": "Profile ID of the user who last 
updated the record." } }, "required": [ "tag_code", "label", "sort_order", 
"is_active" ] } ``` 5\. Relationships & Integrity - Primary Key: `id` (SERIAL 
-> INTEGER) - Unique Constraint: `tag_code` must be unique. - Foreign Key 
References FROM other tables: - `waypoints.waypoint_subcategory_tag_ids` (an 
`INTEGER[]` column) will contain IDs that reference `tags_master.id`. - 
`events_details.event_theme_or_focus_tag_ids` (an `INTEGER[]` column) will 
contain IDs that reference `tags_master.id`. - 🔴 Integrity Note: PostgreSQL 
does not natively enforce referential integrity for individual elements within 
an `INTEGER[]` array. Database triggers *must* be implemented on referencing 
tables (e.g., `waypoints`, `events_details`) to ensure all IDs in their tag 
arrays correspond to valid, `is_active = true` `id` entries in `tags_master`. - 
Foreign Key References TO other tables: - `created_by_profile_id` REFERENCES 
`public.profiles(id)` ON DELETE SET NULL. - `updated_by_profile_id` REFERENCES 
`public.profiles(id)` ON DELETE SET NULL. 6\. Multilingual Strategy - 
Translatable Fields: - `label`: The English name for the tag. (Translatable via 
`public.translations`) - `description`: The English description for the tag. 
(Translatable via `public.translations`) - Non-Translatable Fields: - 
`tag_code` is a stable identifier and is not translated. - `tag_type` codes are 
stable; their user-facing labels can be translated by adding entries to 
`public.translations` keyed by the `tag_type` code if needed. - Translation 
Management: - An `AFTER DELETE` trigger 
(`trigger_cleanup_tags_master_translations`) is implemented to call 
`public.cleanup_related_translations` to remove orphaned translations. 7\. 
Role-Based Workflow & RLS Notes - Content Management: `tags_master` provides a 
controlled vocabulary. Users with `platform_admin` or `admin` roles typically 
manage the definitions of these tags. Other roles like 
`regional_content_manager` or `accommodation_host` would *use* these tags when 
creating or updating content they manage. - Lifecycle: Tags are made inactive 
for new assignments by setting `is_active = false`. This is the preferred 
method over deletion, especially if a tag has been used, to maintain historical 
data integrity. - RLS Policies: - Enable RLS: SQL ``` ALTER TABLE 
public.tags_master ENABLE ROW LEVEL SECURITY; ``` - Anonymous & Authenticated 
Users (Read-Only for Active Tags): SQL ``` CREATE POLICY "Allow public read 
access to active tags" ON public.tags_master FOR SELECT USING (is_active = 
true); ``` - Platform Administrators & Administrators (Full Control): SQL ``` 
CREATE POLICY "Allow platform_admins and admins full access to tags" ON 
public.tags_master FOR ALL USING (public.has_role('platform_admin') OR 
public.has_role('admin')) WITH CHECK (public.has_role('platform_admin') OR 
public.has_role('admin')); ``` - Content Managers (Read-Only for All Tags - 
Example): Content managers need to see all available tags (even inactive ones, 
perhaps, to understand historical data or if they have a role in suggesting new 
tags). For assigning tags, they would typically only see active ones via UI 
filtering. SQL ``` CREATE POLICY "Allow content_roles read access to all tags" 
ON public.tags_master FOR SELECT USING 
(public.has_role('regional_content_manager') OR public.has_role('admin') OR 
public.has_role('platform_admin')); -- Adjust roles as needed ``` - Note: 
Ensure the `public.has_role(TEXT)` function correctly checks the `roles` array 
in the `public.profiles` table for the current `auth.uid()`. The RLS strategy 
implies that only `platform_admin` or `admin` can create/update/delete these 
master tags. 8\. ENUM vs Lookup Discussion - 🟢 Decision: This `tags_master` 
table correctly promotes a free-text array or simpler ENUM array concept for 
sub-categorization and theming. - Reasoning: A master lookup table provides 
standardization, richness (attributes like `tag_type`, `icon_identifier`, 
`is_active`), i18n, maintainability, data integrity, and auditability. 9\. 
UI/UX Enablement - `label` (translated): Used for display names in filter 
checkboxes, tag clouds, and on detail pages. - `icon_identifier` (optional): 
Can be used to display small icons next to tags. - `tag_type`: Can be used by 
the UI to group related tags in filter sections (e.g., "Filter by Amenity," 
"Filter by Event Theme"). - `sort_order`: Ensures a logical and consistent 
presentation of tags. - `is_active`: UI should primarily display/allow 
selection of active tags for new/updated entities. 10\. Key Considerations & 
Definitions - Granularity & Scope: `tag_type` helps scope tags (e.g., some for 
POIs, some for events). - `tag_type` Usage: Clearly define `tag_type` values. 
'event_theme' explicitly supports event tagging. - Deletion Strategy: Retiring 
tags by setting `is_active = false` is the primary strategy. Physical deletion 
should be rare and managed by an admin, considering existing references. The 
array FK validation triggers on referencing tables must check 
`tags_master.is_active = true`. 11\. Scalability & Future-Proofing - Lookup 
Table Structure: Scales well. Performance for referencing tables depends on GIN 
indexes on their array FK columns. - Audit Fields & `is_active` flag: Provide 
change history and robust lifecycle management. 12\. Next-Action Checklist - 🔴 
Define Global RLS Helper Functions: Ensure `public.has_role(TEXT)` is 
implemented securely and available. - 🔴 Create Table: Execute the DDL for 
`public.tags_master` (Version 1.3). - 🔴 Apply Triggers: Ensure 
`set_current_timestamp_updated_at` and `cleanup_related_translations` triggers 
are created and applied. - 🔴 Database Triggers for Referencing Tables: 
Critically ensure array FK validation triggers are implemented on `waypoints` 
(for `waypoint_subcategory_tag_ids`) and `events_details` (for 
`event_theme_or_focus_tag_ids`) to validate against `tags_master.id` AND 
`tags_master.is_active = true`. - 🔴 Initial Population: Insert an initial set 
of agreed-upon tags, including examples for different `tag_type` values. Ensure 
`is_active = true` and `created_by_profile_id` are set. - 🟠 RLS Policies: 
Implement and thoroughly test the RLS policies defined in section 7. - 🟢 
Iconography & UI Grouping: Coordinate with UI team based on `icon_identifier` 
and `tag_type`. - 🟢 Translation Entries: Prepare initial English entries for 
`label` and `description` in `public.translations`. * * * * * 
