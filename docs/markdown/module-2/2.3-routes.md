# 2.3 routes

  
https://gemini.google.com/u/1/app/9ed6b32c76b55d3a?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/8d62cfd96b565ac8 
https://gemini.google.com/u/1/app/2d30425fc8a5984a * * * * * Updated 
Production-Ready Specification -------------------------------------- Table 
Name: `public.routes` 1\. Purpose & Primary Use-Cases This table defines 
specific, named paths or major variations within an overarching trail (e.g., 
"Northern Route: La Verna to Assisi"). Routes are the primary navigational 
choices for pilgrims, composed of an ordered sequence of segments. Key 
statistics like total distance and elevation gain are automatically aggregated 
from these segments. Key User-Story Touchpoints: - Pilgrim (Anna) - Story A1 
(Route Exploration & Selection): Allows viewing different routes within a 
trail, understanding their characteristics (name, description, distance, 
duration, difficulty), and selection. - Pilgrim (Anna) - Story A2 (Daily Stage 
Understanding): Routes form the basis for constructing and displaying suggested 
daily "stages". - Pilgrim (Anna) - Story A5 (Checking Trail Conditions): 
`operational_status` provides route-specific operational status. - Pilgrim 
(Anna) - Story A7 (Using Pre-defined Itineraries): Routes can be components of 
curated itineraries. - Platform Administrator (Admin Team) - Story D1 & D2: 
Admins manage route definitions and can feature specific routes. * * * * * 2\. 
Schema | Column Name | Data Type | Constraints | Description (Translatable 
fields marked) | | `id` | `bigint` | PRIMARY KEY, GENERATED ALWAYS AS IDENTITY 
| Unique identifier for each route. | | `trail_id` | `bigint` | NOT NULL, 
REFERENCES `public.trails(id)` ON DELETE CASCADE | The ID of the parent trail 
this route belongs to. | | `name` | `text` | NOT NULL, UNIQUE (`trail_id`, 
`name`), CHECK (char_length(`name`) &lt;= 255) | Specific name of this route in 
English (e.g., "Northern Route: La Verna to Assisi"). (Translatable via 
`public.translations`) | | `slug` | `text` | NOT NULL, UNIQUE, CHECK (`slug` ~ 
'^[a-z0-9]+(?:-[a-z0-9]+)*$' AND char_length(`slug`) &lt;= 255) | URL-friendly 
identifier for the route. | | `route_code` | `text` | UNIQUE, CHECK 
(`route_code` IS NULL OR (`route_code` ~ '^[A-Z0-9_-]+$' AND 
char_length(`route_code`) &lt;= 50)) | Optional short code for this route 
(e.g., "VDF-N-LVA"). | | `route_alternate_name` | `text` | | Common alternate 
name or subtitle for this route in English. (Translatable via 
`public.translations`) | | `short_description` | `text` | CHECK 
(`short_description` IS NULL OR char_length(`short_description`) &lt;= 250) | 
Brief summary of this route in English (approx. 160-250 chars). (Translatable 
via `public.translations`) | | `full_description` | `text` | | Detailed 
description of this route in English. (Translatable via `public.translations`) 
| | `route_theme_or_focus` | `text` | | Specific theme or focus of this route 
in English. (Translatable via `public.translations`) | | 
`route_curation_source` | `text` | | Origin or curator of this route 
definition. (V1: Translatable via `public.translations`; V2+ consider lookup) | 
| `start_point_description` | `text` | | Textual description of the route's 
conceptual starting point in English. (Translatable via `public.translations`) 
| | `end_point_description` | `text` | | Textual description of the route's 
conceptual ending point in English. (Translatable via `public.translations`) | 
| `start_town_id` | `bigint` | REFERENCES `public.towns(id)` ON DELETE SET NULL 
| Optional FK to `towns` table for the primary starting town. | | `end_town_id` 
| `bigint` | REFERENCES `public.towns(id)` ON DELETE SET NULL | Optional FK to 
`towns` table for the primary ending town. | | `total_distance_km` | `real` | | 
ðŸ”´ Auto-calculated total distance (km). Derived from constituent `segments` via 
`route_segments` trigger. | | `estimated_duration_days` | `text` | | Estimated 
range for typical completion duration (e.g., "7-9 days"). | | 
`estimated_total_elevation_gain_meters` | `integer` | | ðŸ”´ Auto-calculated 
total elevation gain (m). Derived from constituent `segments` via 
`route_segments` trigger. | | `route_difficulty` | 
`public.trail_difficulty_enum` | | Subjective difficulty level specific to this 
route. | | `terrain_summary_for_route` | `text` | | Narrative summary of 
typical terrain in English. (Translatable via `public.translations`) | | 
`waymarking_and_navigation_details` | `text` | | Specific waymarking/navigation 
details in English. (Translatable via `public.translations`) | | 
`operational_status` | `public.trail_operational_status_enum` | NOT NULL 
DEFAULT 'information_unavailable' | Operational status specific to this route. 
| | `content_visibility_status` | `public.content_visibility_status_enum` | NOT 
NULL DEFAULT 'draft' | Editorial status for public view. | | 
`best_seasons_for_route` | `text[]` | | Recommended seasons/months. (Each 
element Translatable via `public.translations`) | | 
`is_primary_route_for_trail` | `boolean` | NOT NULL DEFAULT `false` | Flags if 
this is a main/default route for the parent trail. | | `route_category` | 
`public.route_category_enum` | | Categorizes the route's role or type (e.g., 
'main_section', 'official_variant'). | | `alternative_to_route_id` | `bigint` | 
REFERENCES `public.routes(id)` ON DELETE SET NULL | If an official alternative, 
links to the ID of the other route. | | `overall_gpx_media_id` | `bigint` | 
REFERENCES `public.media(id)` ON DELETE SET NULL | Optional FK to 
`public.media` for a downloadable GPX file (media_asset_type='gpx_file'). 
Replaces `overall_gpx_track_url`. | | `map_overview_media_id` | `bigint` | 
REFERENCES `public.media(id)` ON DELETE SET NULL | FK to `media` for an 
overview map image. | | `banner_media_id` | `bigint` | REFERENCES 
`public.media(id)` ON DELETE SET NULL | FK to `media` for a route-specific 
banner image. | | `public_transit_at_start_end` | `text` | | Public transport 
access info in English. (Translatable via `public.translations`) | | 
`accessibility_notes` | `text` | | Accessibility notes in English. 
(Translatable via `public.translations`) | | `general_notes_for_route` | `text` 
| | Specific notes/advice for this route in English. (Translatable via 
`public.translations`) | | `meta_description_seo` | `text` | CHECK 
(`meta_description_seo` IS NULL OR char_length(`meta_description_seo`) &lt;= 
160) | Optimized SEO meta description in English. (Translatable via 
`public.translations`) | | `wordpress_excerpt` | `text` | | Short summary for 
WordPress excerpts in English. (Translatable via `public.translations`) | | 
`is_featured_route` | `boolean` | NOT NULL DEFAULT `false` | Flag to indicate 
if this route should be prominently featured. | | `created_at` | `timestamptz` 
| NOT NULL DEFAULT `now()` | Timestamp of record creation. | | 
`created_by_profile_id` | `uuid` | REFERENCES `public.profiles(id)` ON DELETE 
SET NULL | Profile ID of the user who created this route. | | `updated_at` | 
`timestamptz` | NOT NULL DEFAULT `now()` | Timestamp of last update 
(auto-updated by trigger). | | `updated_by_profile_id` | `uuid` | REFERENCES 
`public.profiles(id)` ON DELETE SET NULL | Profile ID of the user who last 
updated this route. | | `deleted_at` | `timestamptz` | | Timestamp for soft 
deletion. | * * * * * 3\. PostgreSQL DDL SQL ``` -- ENUM Types -- Assuming 
'public.trail_difficulty_enum', 'public.trail_operational_status_enum', -- and 
'public.content_visibility_status_enum' are already created. DO $$ BEGIN IF NOT 
EXISTS (SELECT 1 FROM pg_type WHERE typname = 'route_category_enum') THEN 
CREATE TYPE public.route_category_enum AS ENUM ( 'main_section', 
'official_variant', 'unofficial_variant', 'connector_spur', 'extension', 
'loop_option', 'access_route' ); -- [cite: 1802, 1803] END IF; END$$; -- 
Assuming 'public.trails', 'public.towns', 'public.media', 'public.profiles' 
tables exist. CREATE TABLE public.routes ( id BIGINT GENERATED ALWAYS AS 
IDENTITY PRIMARY KEY, trail_id BIGINT NOT NULL REFERENCES public.trails(id) ON 
DELETE CASCADE, name TEXT NOT NULL CHECK (char_length(name) <= 255), slug TEXT 
NOT NULL UNIQUE CHECK (slug ~ '^[a-z0-9]+(?:-[a-z0-9]+)*$' AND 
char_length(slug) <= 255), route_code TEXT UNIQUE CHECK (route_code IS NULL OR 
(route_code ~ '^[A-Z0-9_-]+$' AND char_length(route_code) <= 50)), 
route_alternate_name TEXT, short_description TEXT CHECK (short_description IS 
NULL OR char_length(short_description) <= 250), full_description TEXT, 
route_theme_or_focus TEXT, route_curation_source TEXT, start_point_description 
TEXT, end_point_description TEXT, start_town_id BIGINT REFERENCES 
public.towns(id) ON DELETE SET NULL, end_town_id BIGINT REFERENCES 
public.towns(id) ON DELETE SET NULL, total_distance_km REAL, -- ðŸ”´ 
Auto-calculated by trigger on route_segments estimated_duration_days TEXT, 
estimated_total_elevation_gain_meters INTEGER, -- ðŸ”´ Auto-calculated by trigger 
on route_segments route_difficulty public.trail_difficulty_enum, 
terrain_summary_for_route TEXT, waymarking_and_navigation_details TEXT, 
operational_status public.trail_operational_status_enum NOT NULL DEFAULT 
'information_unavailable', content_visibility_status 
public.content_visibility_status_enum NOT NULL DEFAULT 'draft', 
best_seasons_for_route TEXT[], is_primary_route_for_trail BOOLEAN NOT NULL 
DEFAULT FALSE, route_category public.route_category_enum, 
alternative_to_route_id BIGINT REFERENCES public.routes(id) ON DELETE SET NULL, 
overall_gpx_media_id BIGINT REFERENCES public.media(id) ON DELETE SET NULL, -- 
V2 Update: Changed from URL to media_id map_overview_media_id BIGINT REFERENCES 
public.media(id) ON DELETE SET NULL, banner_media_id BIGINT REFERENCES 
public.media(id) ON DELETE SET NULL, public_transit_at_start_end TEXT, 
accessibility_notes TEXT, general_notes_for_route TEXT, meta_description_seo 
TEXT CHECK (meta_description_seo IS NULL OR char_length(meta_description_seo) 
<= 160), wordpress_excerpt TEXT, is_featured_route BOOLEAN NOT NULL DEFAULT 
FALSE, created_at TIMESTAMPTZ NOT NULL DEFAULT now(), created_by_profile_id 
UUID REFERENCES public.profiles(id) ON DELETE SET NULL, updated_at TIMESTAMPTZ 
NOT NULL DEFAULT now(), updated_by_profile_id UUID REFERENCES 
public.profiles(id) ON DELETE SET NULL, deleted_at TIMESTAMPTZ, UNIQUE 
(trail_id, name) ); -- [cite: 1805, 1806, 1807] -- Indexes CREATE INDEX IF NOT 
EXISTS idx_routes_trail_id ON public.routes(trail_id); -- [cite: 1808] CREATE 
INDEX IF NOT EXISTS idx_routes_slug ON public.routes(slug); -- [cite: 1808] 
CREATE INDEX IF NOT EXISTS idx_routes_route_code ON public.routes(route_code); 
-- [cite: 1809] CREATE INDEX IF NOT EXISTS idx_routes_operational_status ON 
public.routes(operational_status); -- [cite: 1809] CREATE INDEX IF NOT EXISTS 
idx_routes_content_visibility_status ON 
public.routes(content_visibility_status); -- [cite: 1810] CREATE INDEX IF NOT 
EXISTS idx_routes_route_category ON public.routes(route_category); -- [cite: 
1810] CREATE INDEX IF NOT EXISTS idx_routes_alternative_to_route_id ON 
public.routes(alternative_to_route_id); -- [cite: 1811] CREATE INDEX IF NOT 
EXISTS idx_routes_overall_gpx_media_id ON public.routes(overall_gpx_media_id); 
-- Index for new GPX media FK CREATE INDEX IF NOT EXISTS 
idx_routes_is_featured_route ON public.routes(is_featured_route); -- [cite: 
1811] CREATE INDEX IF NOT EXISTS idx_routes_deleted_at ON 
public.routes(deleted_at) WHERE deleted_at IS NULL; -- [cite: 1812] CREATE 
INDEX IF NOT EXISTS idx_routes_start_town_id ON public.routes(start_town_id); 
-- [cite: 1812] CREATE INDEX IF NOT EXISTS idx_routes_end_town_id ON 
public.routes(end_town_id); -- [cite: 1813] -- Trigger for standard audit 
fields (created_by, updated_by, updated_at) CREATE OR REPLACE FUNCTION 
public.set_route_modification_meta() RETURNS TRIGGER AS $$ BEGIN NEW.updated_at 
= NOW(); -- [cite: 1814] IF (TG_OP = 'INSERT') THEN NEW.created_by_profile_id = 
auth.uid(); -- [cite: 1814] NEW.updated_by_profile_id = auth.uid(); -- [cite: 
1814] ELSIF (TG_OP = 'UPDATE') THEN NEW.updated_by_profile_id = auth.uid(); -- 
[cite: 1816] NEW.created_at = OLD.created_at; -- [cite: 1816] 
NEW.created_by_profile_id = OLD.created_by_profile_id; -- [cite: 1816] END IF; 
RETURN NEW; -- [cite: 1816] END; $$ LANGUAGE plpgsql SECURITY DEFINER; -- 
[cite: 1817] CREATE TRIGGER trigger_routes_modification_meta BEFORE INSERT OR 
UPDATE ON public.routes FOR EACH ROW EXECUTE FUNCTION 
public.set_route_modification_meta(); -- [cite: 1817] -- Comments COMMENT ON 
TABLE public.routes IS 'Defines specific, named paths or major variations 
within an overarching trail, forming primary navigational choices. Composed of 
an ordered sequence of segments. Version: V2.'; -- [cite: 1818, 1819] COMMENT 
ON COLUMN public.routes.name IS 'Specific name of this route in English (e.g., 
"Northern Route: La Verna to Assisi"). Max 255 chars. Must be unique within its 
parent trail. (Translatable via public.translations). Version: V2.'; -- [cite: 
1820] COMMENT ON COLUMN public.routes.total_distance_km IS 'ðŸ”´ Auto-calculated 
total distance (km) of the route. This value is derived from the sum of 
distance_km of its constituent segments, managed by a trigger on the 
public.route_segments table. Version: V2.'; -- [cite: 1821, 1822] COMMENT ON 
COLUMN public.routes.estimated_total_elevation_gain_meters IS 'ðŸ”´ 
Auto-calculated total elevation gain (m) of the route. This value is derived 
from the sum of elevation_gain_meters of its constituent segments, managed by a 
trigger on the public.route_segments table. Version: V2.'; -- [cite: 1823, 
1824] COMMENT ON COLUMN public.routes.overall_gpx_media_id IS 'Optional FK to 
public.media table for a downloadable GPX file for the entire route 
(media_asset_type=''gpx_file''). Replaces overall_gpx_track_url. Version: V2.'; 
COMMENT ON COLUMN public.routes.deleted_at IS 'Timestamp for soft deletion. If 
NOT NULL, the route is considered inactive and should be filtered from public 
views. Version: V2.'; -- [cite: 1827] -- (Add comments for other translatable 
fields and key columns) ``` * * * * * 4\. JSON Schema Mirror JSON ``` { 
"title": "route", "description": "Defines a specific, named path or major 
variation within an overarching trail, composed of an ordered sequence of 
segments. Key statistics are auto-calculated from these segments. Version: 
V2.", "type": "object", "properties": { "id": { "type": "integer", "format": 
"int64", "description": "Unique identifier for the route. Read-only.", 
"readOnly": true }, "trail_id": { "type": "integer", "format": "int64", 
"description": "Foreign key to the parent public.trails this route belongs to." 
[cite: 1829] }, "name": { "type": "string", "maxLength": 255, "description": 
"Specific name of this route in English. (Translatable via 
public.translations)" [cite: 1830] }, "slug": { "type": "string", "maxLength": 
255, "pattern": "^[a-z0-9]+(?:-[a-z0-9]+)*$", "description": "URL-friendly 
identifier for the route. Must be unique." [cite: 1831] }, "route_code": { 
"type": ["string", "null"], "maxLength": 50, "pattern": "^[A-Z0-9_-]+$", 
"description": "Optional short code for the route (e.g., VDF-N-LVA). Must be 
unique if provided." [cite: 1832] }, "route_alternate_name": { "type": 
["string", "null"], "description": "Common alternate name or subtitle for this 
route in English. (Translatable via public.translations)" [cite: 1833] }, 
"short_description": { "type": ["string", "null"], "maxLength": 250, 
"description": "Brief summary of this route in English (approx. 160-250 
characters). (Translatable via public.translations)" [cite: 1834] }, 
"full_description": { "type": ["string", "null"], "description": "Detailed 
description of this route in English. (Translatable via public.translations)" 
[cite: 1835] }, "route_theme_or_focus": { "type": ["string", "null"], 
"description": "Specific theme or focus of this route in English. (Translatable 
via public.translations)" [cite: 1836] }, "route_curation_source": { "type": 
["string", "null"], "description": "Origin or curator of this route definition 
(e.g., 'Official VdF Committee'). (V1: Translatable; V2+ consider lookup 
table)" [cite: 1837] }, "start_point_description": { "type": ["string", 
"null"], "description": "Textual description of the route's conceptual starting 
point in English. (Translatable via public.translations)" [cite: 1838] }, 
"end_point_description": { "type": ["string", "null"], "description": "Textual 
description of the route's conceptual ending point in English. (Translatable 
via public.translations)" [cite: 1839] }, "start_town_id": { "type": 
["integer", "null"], "format": "int64", "description": "Optional foreign key to 
the public.towns table for the primary starting town." [cite: 1840] }, 
"end_town_id": { "type": ["integer", "null"], "format": "int64", "description": 
"Optional foreign key to the public.towns table for the primary ending town." 
[cite: 1841] }, "total_distance_km": { "type": ["number", "null"], "format": 
"float", "description": "ðŸ”´ Auto-calculated total distance (km) of the route, 
derived from its segments. Read-only.", "readOnly": true }, 
"estimated_duration_days": { "type": ["string", "null"], "description": 
"Estimated range for typical completion duration (e.g., '7-9 days', 'Approx. 2 
weeks')." [cite: 1842] }, "estimated_total_elevation_gain_meters": { "type": 
["integer", "null"], "description": "ðŸ”´ Auto-calculated total elevation gain 
(m) of the route, derived from its segments. Read-only.", "readOnly": true }, 
"route_difficulty": { "type": ["string", "null"], "enum": ["easy", "moderate", 
"challenging", "strenuous", "variable", null], "description": "Subjective 
difficulty level specific to this route." [cite: 1843] }, 
"terrain_summary_for_route": { "type": ["string", "null"], "description": "A 
narrative summary of the typical terrain encountered on this route in English. 
(Translatable via public.translations)" [cite: 1844] }, 
"waymarking_and_navigation_details": { "type": ["string", "null"], 
"description": "Specific waymarking or navigation details pertinent to this 
route in English. (Translatable via public.translations)" [cite: 1845] }, 
"operational_status": { "type": "string", "enum": ["fully_operational", 
"partially_closed_detours_in_place", "seasonal_access_only", 
"under_development", "closed", "information_unavailable"], "default": 
"information_unavailable", "description": "Operational status specific to this 
route." [cite: 1846] }, "content_visibility_status": { "type": "string", 
"enum": ["draft", "pending_review", "published", "archived"], "default": 
"draft", "description": "Editorial status indicating if the route content is 
ready for public view." [cite: 1847] }, "best_seasons_for_route": { "type": 
["array", "null"], "items": { "type": "string" }, "description": "Recommended 
seasons/months for undertaking this route. (Each element Translatable via 
public.translations)" [cite: 1848] }, "is_primary_route_for_trail": { "type": 
"boolean", "default": false, "description": "Flags if this is considered a main 
or default route for the parent trail." [cite: 1849] }, "route_category": { 
"type": ["string", "null"], "enum": ["main_section", "official_variant", 
"unofficial_variant", "connector_spur", "extension", "loop_option", 
"access_route", null], "description": "Categorizes the route's role or type." 
[cite: 1850] }, "alternative_to_route_id": { "type": ["integer", "null"], 
"format": "int64", "description": "If this route is an official alternative to 
another route, this links to the ID of that other route (public.routes.id)." 
[cite: 1851] }, "overall_gpx_media_id": { "type": ["integer", "null"], 
"format": "int64", "description": "Optional FK to public.media for a 
downloadable GPX file for the entire route (media_asset_type='gpx_file')." }, 
"map_overview_media_id": { "type": ["integer", "null"], "format": "int64", 
"description": "Foreign key to the public.media table for an overview map image 
of this route." [cite: 1853] }, "banner_media_id": { "type": ["integer", 
"null"], "format": "int64", "description": "Foreign key to the public.media 
table for a banner image specific to this route." [cite: 1854] }, 
"public_transit_at_start_end": { "type": ["string", "null"], "description": 
"Information on public transport access at the start and end points of the 
route in English. (Translatable via public.translations)" [cite: 1855] }, 
"accessibility_notes": { "type": ["string", "null"], "description": "Notes 
regarding accessibility for users with mobility challenges for this route in 
English. (Translatable via public.translations)" [cite: 1856] }, 
"general_notes_for_route": { "type": ["string", "null"], "description": 
"Specific notes or advice for pilgrims undertaking this route in English. 
(Translatable via public.translations)" [cite: 1857] }, "meta_description_seo": 
{ "type": ["string", "null"], "maxLength": 160, "description": "Optimized SEO 
meta description for this route in English. (Translatable via 
public.translations)" [cite: 1858] }, "wordpress_excerpt": { "type": ["string", 
"null"], "description": "Short summary suitable for WordPress excerpts for this 
route in English. (Translatable via public.translations)" [cite: 1859] }, 
"is_featured_route": { "type": "boolean", "default": false, "description": 
"Flag to indicate if this route should be prominently featured on the 
platform." [cite: 1860] }, "created_at": { "type": "string", "format": 
"date-time", "description": "Timestamp of record creation. Read-only.", 
"readOnly": true }, "created_by_profile_id": { "type": ["string", "null"], 
"format": "uuid", "description": "Profile ID (public.profiles.id) of the user 
who created this route record. Read-only.", "readOnly": true }, "updated_at": { 
"type": "string", "format": "date-time", "description": "Timestamp of the last 
update to this route record. Read-only.", "readOnly": true }, 
"updated_by_profile_id": { "type": ["string", "null"], "format": "uuid", 
"description": "Profile ID (public.profiles.id) of the user who last updated 
this route record. Read-only.", "readOnly": true }, "deleted_at": { "type": 
["string", "null"], "format": "date-time", "description": "Timestamp for soft 
deletion. If present, the route is considered inactive. Read-only.", 
"readOnly": true } [cite: 1861] }, "required": [ "trail_id", "name", "slug", 
"operational_status", "content_visibility_status", 
"is_primary_route_for_trail", "is_featured_route", "created_at", "updated_at" 
], "primary_key": ["id"], "unique_constraints": [ {"columns": ["slug"], "name": 
"routes_slug_key"}, {"columns": ["route_code"], "name": 
"routes_route_code_key"}, {"columns": ["trail_id", "name"], "name": 
"routes_trail_id_name_key"} ] } ``` * * * * * 5\. Relationships & Integrity - 
Foreign Key Targets & `ON DELETE` Actions: - `trail_id` references 
`public.trails(id)`: `ON DELETE CASCADE`. - `start_town_id` references 
`public.towns(id)`: `ON DELETE SET NULL`. - `end_town_id` references 
`public.towns(id)`: `ON DELETE SET NULL`. - `alternative_to_route_id` 
references `public.routes(id)` (self-reference): `ON DELETE SET NULL`. - 
`overall_gpx_media_id`, `map_overview_media_id`, `banner_media_id` reference 
`public.media(id)`: `ON DELETE SET NULL`. - Audit FKs to `public.profiles(id)`: 
`ON DELETE SET NULL`. - Constituent Segments: Defined in 
`public.route_segments`. - Unique Constraints: `slug` (global), `route_code` 
(global, if provided), `(trail_id, name)`. - Mermaid ER Diagram Snippet: Code 
snippet ``` erDiagram trails { bigint id PK } routes { bigint id PK bigint 
trail_id FK text name text slug UK bigint overall_gpx_media_id FK -- ... other 
columns } towns { bigint id PK } media { bigint id PK } profiles { uuid id PK } 
route_segments { bigint route_id FK } trails ||--o{ routes : "has_route 
(CASCADE)" routes }o--o| towns : "starts_near_town (SET NULL)" routes }o--o| 
towns : "ends_near_town (SET NULL)" routes }o--o| routes : "is_alternative_to 
(SET NULL)" routes ||--o| media : "has_gpx_track (SET NULL)" routes ||--o| 
media : "has_map_image (SET NULL)" routes ||--o| media : "has_banner_image (SET 
NULL)" routes ||--o| profiles : "created_by (SET NULL)" routes ||--o| profiles 
: "updated_by (SET NULL)" routes ||--|{ route_segments : "is_composed_of" ``` * 
* * * * 6\. Multilingual Strategy - Translatable Fields: `name`, 
`route_alternate_name`, `short_description`, `full_description`, 
`route_theme_or_focus`, `route_curation_source` (V1), 
`start_point_description`, `end_point_description`, 
`terrain_summary_for_route`, `waymarking_and_navigation_details`, 
`public_transit_at_start_end`, `accessibility_notes`, 
`general_notes_for_route`, `meta_description_seo`, `wordpress_excerpt`. English 
base text stored directly. Translations via `public.translations`. - Array 
Field: `best_seasons_for_route` (`TEXT[]`): Each element is translatable. * * * 
* * 7\. Role-Based Workflow & RLS Notes - Workflow Fields: 
`content_visibility_status` manages editorial lifecycle. Standard audit and 
soft-delete fields are included. - Note: The RLS policies outlined above rely 
on the existence and correct implementation of global RLS helper functions 
(e.g., public.has_role(TEXT) , public.is_platform_admin() , specific 
regional/trail management checks) that authenticate users and verify their 
roles stored in the public.profiles table." This reinforces that the 
table-specific RLS is part of a larger auth system. - RLS Policy Stubs 
(Conceptual): Public read for published routes of published trails. Admin full 
access. Regional manager access based on parent trail. (Refer to DDL section 
for example policies). - Audit trigger `set_route_modification_meta` is 
`SECURITY DEFINER`. * * * * * 8\. ENUM vs. Lookup Discussion - 
`public.route_category_enum`: New ENUM; appropriate for fixed route categories. 
- Reused ENUMs (`trail_difficulty_enum`, etc.) are consistent. - 
`route_curation_source` (`TEXT`): V2+ may promote to lookup. - 
`best_seasons_for_route` (`TEXT[]`): Retained as `TEXT[]` for V1. * * * * * 9\. 
UI/UX Enablement - Filters: `route_difficulty`, `operational_status`, 
`route_category`, etc. - Icons: Driven by `route_difficulty`, 
`operational_status`. - ðŸ”´ Calculated Fields: `total_distance_km`, 
`estimated_total_elevation_gain_meters` are crucial and auto-calculated. - API 
Support: The `public.routes_summary_view` (defined in the Database Views 
Specification) can support efficient API responses for route listings. - Media 
Display: `map_overview_media_id` and `banner_media_id` for images. - 
Hierarchical Display: `is_primary_route_for_trail`, `alternative_to_route_id` 
structure route presentation. * * * * * 10\. Key Considerations & Definitions - 
ðŸ”´ Auto-Calculated Statistics: Accuracy is paramount, updated by trigger on 
`public.route_segments`. - GPX Management: Changed from `overall_gpx_track_url` 
(original spec) to `overall_gpx_media_id` for V2, aligning with centralized 
media strategy and project overview (section 4.2). - Route Hierarchy: 
`is_primary_route_for_trail`, `alternative_to_route_id` define main 
routes/variants. * * * * * 11\. Scalability & Future-Proofing - `BIGINT` 
PKs/FKs allow for growth. - Soft deletes and audit columns are standard good 
practice. - Automated statistics ensure data integrity. - Future Enhancement: 
Full-Text Search (FTS) on descriptive fields is a Post-V2 consideration. * * * 
* * 12\. Next-Action Checklist 1. ðŸ”´ Implement DDL: Create 
`public.route_category_enum`. Create/Update `public.routes` table, replacing 
`overall_gpx_track_url` with `overall_gpx_media_id BIGINT REFERENCES 
public.media(id) ON DELETE SET NULL`. Add index 
`idx_routes_overall_gpx_media_id`. Ensure all constraints, other indexes, and 
`set_route_modification_meta` trigger are correct. 2. ðŸ”´ Verify and Test 
`route_segments` Trigger: Confirm that the 
`update_route_aggregates_from_segments` trigger (defined with 
`public.route_segments`) correctly and reliably updates 
`routes.total_distance_km` and `routes.estimated_total_elevation_gain_meters` 
upon any DML operation on `public.route_segments`. This is critical for data 
accuracy. 3. ðŸ”´ Implement Orphaned Translation Cleanup Trigger: Add an `AFTER 
DELETE` trigger on `public.routes` that calls 
`public.cleanup_related_translations('routes', OLD.id)`. 4. ðŸŸ  Confirm 
Referenced Table Data Types: Verify `public.towns.id` and `public.media.id` are 
`BIGINT`. 5. ðŸŸ  Implement RLS Policies & Helper Functions: Define, implement, 
and thoroughly test RLS policies for `public.routes`, including helper 
functions like `public.is_platform_admin()` and 
`public.is_regional_manager_for_trail(BIGINT)`. 6. ðŸŸ¢ Data Migration (if 
applicable): Plan migration for `overall_gpx_track_url` to 
`overall_gpx_media_id` (requires populating `public.media` first). Populate new 
fields and audit columns for existing data. 7. ðŸŸ¢ Review API Usage: Ensure API 
endpoints utilize the new `overall_gpx_media_id` and can efficiently query 
route data, potentially using `public.routes_summary_view`. 
