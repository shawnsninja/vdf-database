# 2.7 trail_terrain_types

  
https://gemini.google.com/u/1/app/9ed6b32c76b55d3a?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/8d62cfd96b565ac8 
https://gemini.google.com/u/1/app/2d30425fc8a5984a * * * * * ### Updated 
Production-Ready Specification Table Name: `public.trail_terrain_types` 1\. 
Purpose & Primary Use-Cases This table establishes a many-to-many relationship 
between specific trails and the general, predominant, or characteristic 
terrain_types_master found on them. It allows a single trail to be described by 
multiple terrain features for overview purposes, user filtering, and 
administrative tracking, replacing the old trails.predominant_terrain_types 
text array. Key User-Story Touchpoints: - Pilgrim (Anna) - Story A1 (Route 
Exploration): Enables Anna to see a summary list of key terrain types (e.g., 
"Forest Path," "Mountain Trail" - with translated names and icons via 
`terrain_types_master`) for an entire trail when deciding if it suits her 
preferences. - Application Logic/Filtering: Allows the application to fetch all 
characteristic terrain types for a trail and enables users to filter or search 
for trails that include certain types of terrain. - Data Management 
(Admin/Content Manager): Provides the means for authorized users to associate 
multiple predefined terrain types with a trail entity and track when these 
associations were made and by whom. 2\. Schema | Column Name | Data Type | 
Constraints | Description | | `trail_id` | `bigint` | PRIMARY KEY (Component), 
NOT NULL, REFERENCES `public.trails(id)` ON DELETE CASCADE | The ID of the 
trail being described. | | `terrain_type_id` | `integer` | PRIMARY KEY 
(Component), NOT NULL, REFERENCES `public.terrain_types_master(id)` ON DELETE 
RESTRICT | The ID of the terrain type (from `terrain_types_master`) associated 
with the trail. | | `created_at` | `timestamptz` | NOT NULL DEFAULT `now()` | 
Timestamp indicating when this specific trail-terrain link was created. | | 
`created_by_profile_id` | `uuid` | REFERENCES `public.profiles(id)` ON DELETE 
SET NULL | Profile ID of the user who created this link. | | `updated_at` | 
`timestamptz` | NOT NULL DEFAULT `now()` | Timestamp indicating when this link 
record was last updated (auto-updated by trigger). | | `updated_by_profile_id` 
| `uuid` | REFERENCES `public.profiles(id)` ON DELETE SET NULL | Profile ID of 
the user who last updated this link. | 3\. PostgreSQL DDL SQL ``` -- This DDL 
assumes that 'public.trails' (with a BIGINT PK 'id'), -- 
'public.terrain_types_master' (with an INTEGER PK 'id' and an 'is_active' 
boolean column), -- and 'public.profiles' (with a UUID PK 'id') tables already 
exist. [cite: 815] CREATE TABLE public.trail_terrain_types ( trail_id BIGINT 
NOT NULL REFERENCES public.trails(id) ON DELETE CASCADE, -- [cite: 816] 
terrain_type_id INTEGER NOT NULL REFERENCES public.terrain_types_master(id) ON 
DELETE RESTRICT, -- [cite: 816] created_at TIMESTAMPTZ NOT NULL DEFAULT now(), 
-- [cite: 816] created_by_profile_id UUID REFERENCES public.profiles(id) ON 
DELETE SET NULL, -- [cite: 816] updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), 
-- [cite: 816] updated_by_profile_id UUID REFERENCES public.profiles(id) ON 
DELETE SET NULL, -- [cite: 816] PRIMARY KEY (trail_id, terrain_type_id) -- 
[cite: 816] ); -- Indexes: -- The composite primary key will automatically 
create a unique index on (trail_id, terrain_type_id). [cite: 817] -- Additional 
individual indexes can be useful depending on query patterns: CREATE INDEX IF 
NOT EXISTS idx_trail_terrain_types_trail_id ON 
public.trail_terrain_types(trail_id); -- [cite: 818] CREATE INDEX IF NOT EXISTS 
idx_trail_terrain_types_terrain_type_id ON 
public.trail_terrain_types(terrain_type_id); -- [cite: 819] -- Trigger for 
created_by_profile_id, updated_at, and updated_by_profile_id CREATE OR REPLACE 
FUNCTION public.set_trail_terrain_type_modification_meta() RETURNS TRIGGER AS 
$$ BEGIN IF (TG_OP = 'INSERT') THEN NEW.created_by_profile_id = auth.uid(); -- 
[cite: 820] NEW.updated_at = NOW(); -- Ensures updated_at is set on insert 
[cite: 820] NEW.updated_by_profile_id = auth.uid(); -- Ensures 
updated_by_profile_id is set on insert [cite: 821] ELSIF (TG_OP = 'UPDATE') 
THEN NEW.updated_at = NOW(); -- [cite: 822] NEW.updated_by_profile_id = 
auth.uid(); -- [cite: 822] -- Keep OLD.created_at and OLD.created_by_profile_id 
NEW.created_at = OLD.created_at; -- [cite: 822] NEW.created_by_profile_id = 
OLD.created_by_profile_id; -- [cite: 822] END IF; RETURN NEW; -- [cite: 823] 
END; $$ LANGUAGE plpgsql SECURITY DEFINER; -- [cite: 823] CREATE TRIGGER 
trigger_trail_terrain_types_modification_meta BEFORE INSERT OR UPDATE ON 
public.trail_terrain_types FOR EACH ROW EXECUTE FUNCTION 
public.set_trail_terrain_type_modification_meta(); -- [cite: 823] -- Comments: 
COMMENT ON TABLE public.trail_terrain_types IS 'Junction table linking trails 
to their general characteristic terrain types (many-to-many). Replaces the old 
trails.predominant_terrain_types text array. Version: V2.'; -- [cite: 824, 825] 
COMMENT ON COLUMN public.trail_terrain_types.trail_id IS 'Foreign key to the 
public.trails table. Version: V2.'; -- [cite: 826] COMMENT ON COLUMN 
public.trail_terrain_types.terrain_type_id IS 'Foreign key to the 
public.terrain_types_master table. Deletion of a master terrain type is 
restricted if in use. Version: V2.'; -- [cite: 827] COMMENT ON COLUMN 
public.trail_terrain_types.created_at IS 'Timestamp when the trail-terrain 
association was made. Version: V2.'; -- [cite: 828] COMMENT ON COLUMN 
public.trail_terrain_types.created_by_profile_id IS 'Profile ID 
(public.profiles.id) of the user who initially created this trail-terrain 
association. Version: V2.'; -- [cite: 829] COMMENT ON COLUMN 
public.trail_terrain_types.updated_at IS 'Timestamp when the trail-terrain 
association was last updated. Auto-updated by trigger. Version: V2.'; -- [cite: 
830] COMMENT ON COLUMN public.trail_terrain_types.updated_by_profile_id IS 
'Profile ID (public.profiles.id) of the user who last updated this 
trail-terrain association. Version: V2.'; -- [cite: 831] ``` 4\. JSON Schema 
Mirror JSON ``` { "title": "trail_terrain_type_link", "description": "Links 
trails to their general characteristic terrain types (many-to-many). This 
replaces the old text array for predominant terrain types on a trail. Version: 
V2.", "type": "object", "properties": { "trail_id": { "type": "integer", 
"format": "int64", "description": "Foreign key referencing the ID of the trail 
(public.trails.id)." -- [cite: 833] }, "terrain_type_id": { "type": "integer", 
"format": "int32", "description": "Foreign key referencing the ID of the 
terrain type from public.terrain_types_master." -- [cite: 834] }, "created_at": 
{ "type": "string", "format": "date-time", "description": "Timestamp of when 
this link record was created. Read-only.", -- [cite: 835] "readOnly": true }, 
"created_by_profile_id": { "type": ["string", "null"], "format": "uuid", 
"description": "Profile ID (public.profiles.id) of the user who created this 
link. Read-only.", -- [cite: 835] "readOnly": true }, "updated_at": { "type": 
"string", "format": "date-time", "description": "Timestamp of when this link 
record was last updated. Read-only.", -- [cite: 835] "readOnly": true }, 
"updated_by_profile_id": { "type": ["string", "null"], "format": "uuid", 
"description": "Profile ID (public.profiles.id) of the user who last updated 
this link. Read-only.", -- [cite: 835] "readOnly": true } }, "required": [ 
"trail_id", "terrain_type_id", "created_at", "updated_at" ], "primary_key": 
["trail_id", "terrain_type_id"] -- [cite: 836] } ``` 5\. Relationships & 
Integrity - Junction Table: This is a pure junction table establishing the 
many-to-many relationship between `public.trails` and 
`public.terrain_types_master`. - Foreign Keys & `ON DELETE` Actions: - 
`trail_id` references `public.trails(id)`: `ON DELETE CASCADE`. If a trail is 
deleted, its associated terrain type links are automatically removed. - 
`terrain_type_id` references `public.terrain_types_master(id)`: `ON DELETE 
RESTRICT`. This protects master data integrity by preventing deletion of a 
terrain type if it's linked to any trail. - `created_by_profile_id` references 
`public.profiles(id)`: `ON DELETE SET NULL`. - `updated_by_profile_id` 
references `public.profiles(id)`: `ON DELETE SET NULL`. - Primary Key: 
Composite `(trail_id, terrain_type_id)` ensures a trail cannot be linked to the 
same terrain type multiple times. - Mermaid ER Diagram Snippet: Code snippet 
``` erDiagram trails { bigint id PK text name } terrain_types_master { integer 
id PK text code UK boolean is_active -- V2 addition to master } profiles { uuid 
id PK } trail_terrain_types { bigint trail_id PK FK integer terrain_type_id PK 
FK timestamptz created_at uuid created_by_profile_id FK timestamptz updated_at 
uuid updated_by_profile_id FK } trails ||--|{ trail_terrain_types : 
"has_terrain_type (CASCADE)" -- terrain_types_master ||--|{ trail_terrain_types 
: "applies_to_trail (RESTRICT)" -- trail_terrain_types }o--|| profiles : 
"created_by (SET NULL)" -- trail_terrain_types }o--|| profiles : "updated_by 
(SET NULL)" -- ``` 6\. Multilingual Strategy This table itself contains no 
directly translatable text. It relies on public.terrain_types_master for the 
definition of terrain types. User-facing names and descriptions associated with 
terrain_types_master.id are translated via the central public.translations 
table. 7\. Role-Based Workflow & RLS Notes - Workflow Fields: `created_at`, 
`created_by_profile_id`, `updated_at`, `updated_by_profile_id` provide a 
complete audit trail for link creation and modification. - Content Management: 
Links are typically managed by Platform Administrators or Regional Content 
Managers. - Note: The RLS policies outlined above rely on the existence and 
correct implementation of global RLS helper functions (e.g., 
public.has_role(TEXT) , public.is_platform_admin() , specific regional/trail 
management checks) that authenticate users and verify their roles stored in the 
public.profiles table." This reinforces that the table-specific RLS is part of 
a larger auth system. - RLS Policy Stubs (Conceptual): - Public Read Access: 
Readable if the associated trail is public. SQL ``` CREATE POLICY "Allow public 
read access to trail_terrain_types" ON public.trail_terrain_types FOR SELECT 
USING ( EXISTS ( SELECT 1 FROM public.trails t WHERE t.id = 
trail_terrain_types.trail_id AND t.content_visibility_status = 'published' -- 
Assuming 'published' status AND t.deleted_at IS NULL ) AND EXISTS ( -- Ensure 
linked terrain type is active SELECT 1 FROM public.terrain_types_master ttm 
WHERE ttm.id = trail_terrain_types.terrain_type_id AND ttm.is_active = true ) 
); -- [cite: 851] ``` - Admin/Manager Write Access: Users authorized to edit a 
trail should be able to manage its terrain type associations. SQL ``` CREATE 
POLICY "Allow authorized users to manage trail_terrain_types" ON 
public.trail_terrain_types FOR ALL -- Covers INSERT, UPDATE, DELETE USING ( 
public.check_user_can_edit_trail(trail_terrain_types.trail_id) -- Placeholder ) 
WITH CHECK ( public.check_user_can_edit_trail(trail_terrain_types.trail_id) -- 
Placeholder AND EXISTS ( -- Ensure associating with an active terrain type 
SELECT 1 FROM public.terrain_types_master ttm WHERE ttm.id = 
trail_terrain_types.terrain_type_id AND ttm.is_active = true ) ); -- [cite: 
852] ``` - Audit trigger `set_trail_terrain_type_modification_meta` is 
`SECURITY DEFINER`. 8\. ENUM vs. Lookup Discussion This junction table supports 
the use of public.terrain_types_master (a lookup table), which is appropriate 
for managing terrain types. 9\. UI/UX Enablement - Displays & Information: 
Allows UI to display characteristic terrain types for a trail by joining 
`trails` → `trail_terrain_types` → `terrain_types_master`. Icons are driven by 
`terrain_types_master.icon_identifier`, and names/descriptions via 
`public.translations`. - Filtering: Enables backend filtering for trails with 
specific terrain types. - Audit Trails (Admin UI): Audit columns provide 
visibility into changes. 10\. Key Considerations & Definitions - Purpose: 
Defines general or predominant terrain types for a trail overview, distinct 
from granular segment-level data. - Data Integrity: - Composite PK `(trail_id, 
terrain_type_id)` prevents duplicate links. - `ON DELETE RESTRICT` on 
`terrain_type_id` FK is crucial for protecting `terrain_types_master` data. - 
Auditability: Full audit trail for link creation/modification supported. - 
Application Logic: When creating new links, the application should ideally only 
allow selection of `terrain_types_master` records where `is_active = true`. 
11\. Scalability & Future-Proofing - Standard junction table design scales 
well. - Audit columns improve maintainability. - Could be expanded with 
attributes specific to the trail-terrain link if needed (e.g., `relevance_score 
INTEGER`). 12\. Next-Action Checklist 1. 🔴 Implement DDL: Create the 
`public.trail_terrain_types` table using the updated DDL, ensuring all 
constraints (PK, FKs with correct `ON DELETE` actions), indexes, and the 
`set_trail_terrain_type_modification_meta` trigger are correctly defined and 
attached. 2. 🟠 Verify Referenced Table PK Data Types: Confirm 
`public.trails.id` is `BIGINT` and `public.terrain_types_master.id` is 
`INTEGER`. 3. 🟠 Implement RLS Policies & Helper Functions: Define, implement, 
and thoroughly test RLS policies, including the 
`public.check_user_can_edit_trail(BIGINT)` helper function and checks for 
`terrain_types_master.is_active` in write policies. 4. 🟠 Data Migration (if 
applicable): If migrating from an old `trails.predominant_terrain_types 
TEXT[]`, plan and execute migration. Populate audit columns for migrated 
records. 5. 🟢 Review Application Logic: Update application code to query via 
this junction table. Ensure logic for creating new links presents only active 
terrain types for selection. * * * * * 
