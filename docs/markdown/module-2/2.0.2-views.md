# 2.0.2 Views

  https://gemini.google.com/u/1/app/2d30425fc8a5984a Database Views 
Specification (V2) 1. Introduction This document outlines the specifications 
for database views created to support the Via di Francesco Pilgrimage Platform 
V2. Views are virtual tables whose contents are defined by a query. They are 
used to simplify complex queries, encapsulate logic, improve read performance 
for common data aggregations, and provide a stable interface for applications 
and APIs, even if underlying table structures change. Each view specification 
will include: View Name: The fully qualified name of the view. Purpose: A brief 
description of why the view is needed and its primary use case. DDL: The CREATE 
VIEW statement. Key Columns: A description of important columns exposed by the 
view. Usage Notes: Any specific considerations for using the view, such as 
indexing on underlying tables or potential performance implications. 2. Module 
2: Core Trail Hierarchy Views These views are designed to support common API 
queries related to trails, routes, and segments. 2.1. View: 
public.routes_summary_view Purpose: To provide a summarized, easily queriable 
list of routes, including their essential identifying information, key 
statistics, and status. This view is primarily intended for use when listing 
routes associated with a specific trail or for general route browsing with 
minimal detail. DDL: CREATE VIEW public.routes_summary_view AS SELECT r.id AS 
route_id, r.trail_id, r.name AS route_name_en, -- Assumes routes.name stores 
the English name r.slug AS route_slug, r.short_description AS 
route_short_description_en, -- Assumes routes.short_description is English 
r.total_distance_km, r.estimated_duration_days, r.route_difficulty, 
r.operational_status AS route_operational_status, r.content_visibility_status 
AS route_content_visibility_status, r.is_primary_route_for_trail, 
r.is_featured_route, r.map_overview_media_id, -- For a quick map thumbnail 
r.deleted_at AS route_deleted_at, t.name AS trail_name_en, -- Parent trail's 
English name for context t.slug AS trail_slug FROM public.routes r JOIN 
public.trails t ON r.trail_id = t.id; COMMENT ON VIEW 
public.routes_summary_view IS 'Provides a summarized view of routes with key 
identifying information, statistics, and parent trail context. Intended for API 
listings and route browsing. Version: V2.'; COMMENT ON COLUMN 
public.routes_summary_view.route_name_en IS 'The English name of the route.'; 
COMMENT ON COLUMN public.routes_summary_view.route_short_description_en IS 'The 
English short description of the route.'; COMMENT ON COLUMN 
public.routes_summary_view.total_distance_km IS 'Auto-calculated total distance 
of the route in kilometers.'; COMMENT ON COLUMN 
public.routes_summary_view.trail_name_en IS 'The English name of the parent 
trail.'; Key Columns: route_id : Primary identifier for the route. trail_id : 
Identifier of the parent trail. route_name_en : English name of the route. 
route_slug : URL-friendly slug for the route. total_distance_km : 
Pre-calculated total distance. route_difficulty : Difficulty rating of the 
route. route_operational_status : Current operational status of the route. 
route_content_visibility_status : Current editorial visibility of the route. 
trail_name_en : English name of the parent trail, for context. Usage Notes: 
This view assumes routes.name and routes.short_description store the English 
(base language) versions. The API layer would be responsible for fetching 
translations if a different language is requested, using route_id to query the 
public.translations table. Performance relies on good indexing on public.routes 
(id, trail_id, content_visibility_status, deleted_at) and public.trails (id) . 
RLS policies applied to public.routes and public.trails will also apply to 
queries against this view. 2.2. View: public.segments_summary_view Purpose: To 
offer a condensed list of segments for a given route, including their order, 
identifying information, and key statistics. This is useful for API endpoints 
that list segments belonging to a route without needing full geometric or all 
descriptive details. DDL: CREATE VIEW public.segments_summary_view AS SELECT 
rs.route_id, s.id AS segment_id, rs.order_in_route, s.name AS segment_name_en, 
-- Assumes segments.name stores the English name s.slug AS segment_slug, 
s.short_description AS segment_short_description_en, -- Assumes 
segments.short_description is English s.distance_km, 
s.estimated_walking_time_minutes, s.elevation_gain_meters, 
s.elevation_loss_meters, s.segment_difficulty, s.operational_status AS 
segment_operational_status, s.content_visibility_status AS 
segment_content_visibility_status, s.deleted_at AS segment_deleted_at, 
s.start_waypoint_id, s.end_waypoint_id FROM public.route_segments rs JOIN 
public.segments s ON rs.segment_id = s.id; COMMENT ON VIEW 
public.segments_summary_view IS 'Provides a summarized list of segments for 
routes, including order, name, and key statistics. Intended for API endpoints 
listing segments of a route. Version: V2.'; COMMENT ON COLUMN 
public.segments_summary_view.segment_name_en IS 'The English name of the 
segment.'; COMMENT ON COLUMN 
public.segments_summary_view.segment_short_description_en IS 'The English short 
description of the segment.'; COMMENT ON COLUMN 
public.segments_summary_view.distance_km IS 'Auto-calculated distance of the 
segment in kilometers.'; Key Columns: route_id : Identifier of the parent 
route. segment_id : Primary identifier for the segment. order_in_route : Order 
of the segment within the route. segment_name_en : English name of the segment. 
distance_km : Pre-calculated distance of the segment. segment_difficulty : 
Difficulty rating of the segment. segment_operational_status : Current 
operational status of the segment. segment_content_visibility_status : Current 
editorial visibility of the segment. Usage Notes: This view assumes 
segments.name and segments.short_description store the English (base language) 
versions. The API layer would handle fetching translations using segment_id . 
Performance relies on indexing on public.route_segments (route_id, segment_id, 
order_in_route) and public.segments (id, content_visibility_status, deleted_at) 
. RLS policies applied to public.route_segments and public.segments (and by 
extension, public.routes and public.trails for visibility checks) will apply. 
Specification: public.v_trails_detailed_localized (View) 1. Purpose & Primary 
Use-Cases Purpose: To provide a comprehensive, denormalized, and localized 
representation of a single trail's core attributes, including its translated 
textual content and primary media details (logo, banner). Each row in the view 
represents a trail in a specific language. Primary Use-Cases: Supplying data 
for the GET /trails/{trail_id}?lang={language_code} API endpoint, simplifying 
the backend logic required to fetch detailed trail information. Providing a 
ready-to-use dataset for rendering a trail's main page on a website or mobile 
application in the user's selected language. Facilitating internal reporting or 
data extraction that requires trail details along with their primary 
translations. 2. View Definition (SQL DDL) SQL CREATE OR REPLACE VIEW 
public.v_trails_detailed_localized AS SELECT t.id AS trail_id, t.slug AS 
trail_slug, t.trail_short_code, t.is_featured, t.operational_status AS 
trail_operational_status, t.content_visibility_status AS 
trail_content_visibility_status, t.deleted_at AS trail_deleted_at, 
t.estimated_total_distance_km, t.estimated_total_duration_days, 
t.overall_difficulty, t.official_website_url, t.contact_organization_url, 
t.created_at AS trail_created_at, t.updated_at AS trail_updated_at, cb.email AS 
created_by_email, -- Example: joining profiles for email ub.email AS 
updated_by_email, -- Example: joining profiles for email -- Language of this 
particular localized record for the trail's own fields 
name_trans.language_code, -- Translated Trail Fields (direct attributes of the 
trail) name_trans.translated_text AS name, alt_names_trans.translated_text AS 
alternate_names_concat, -- Note: This would be one string if directly joined. 
Arrays of translations are harder in views without aggregation. 
short_desc_trans.translated_text AS short_description, 
full_desc_trans.translated_text AS full_description, 
hist_sig_trans.translated_text AS historical_significance, 
cult_sig_trans.translated_text AS cultural_significance, 
pilgrim_focus_trans.translated_text AS pilgrimage_focus, 
start_point_trans.translated_text AS primary_start_point_name, 
end_point_trans.translated_text AS primary_end_point_name, 
direction_trans.translated_text AS typical_direction_of_travel, 
waymarking_desc_trans.translated_text AS waymarking_description, 
safety_cons_trans.translated_text AS overall_safety_considerations, 
key_attr_summary_trans.translated_text AS key_attractions_summary, 
pilgrim_cred_info_trans.translated_text AS pilgrim_credential_info, 
contact_org_name_trans.translated_text AS contact_organization_name, 
data_source_credit_trans.translated_text AS primary_data_source_credit, 
data_licence_info_trans.translated_text AS data_licence_info, 
general_notes_trans.translated_text AS general_notes_for_pilgrims, 
meta_desc_seo_trans.translated_text AS meta_description_seo, 
wp_excerpt_trans.translated_text AS wordpress_excerpt, -- Best seasons to walk 
(TEXT[]) is tricky to translate directly per element in a simple view row. -- 
This would typically be handled by the API layer fetching the array and then 
its translations. -- Or the view could explode it, creating many more rows, 
which is usually not desired for a "detail" view. t.best_seasons_to_walk AS 
best_seasons_to_walk_en, -- Base English array -- Logo Media Details logo_m.id 
AS logo_media_id, logo_m.storage_object_path_original AS 
logo_media_original_url, -- Example, adjust to actual media table columns 
logo_m.image_variants_json AS logo_media_variants, logo_m.media_asset_type AS 
logo_media_asset_type, logo_m.media_licence AS logo_media_licence, 
logo_alt_trans.translated_text AS logo_media_alt_text, -- Banner Media Details 
banner_m.id AS banner_media_id, banner_m.storage_object_path_original AS 
banner_media_original_url, -- Example banner_m.image_variants_json AS 
banner_media_variants, banner_m.media_asset_type AS banner_media_asset_type, 
banner_m.media_licence AS banner_media_licence, 
banner_alt_trans.translated_text AS banner_media_alt_text FROM public.trails t 
-- Profile joins for created/updated by (optional, can be fetched by ID if 
preferred) LEFT JOIN public.profiles cb ON t.created_by_profile_id = cb.id LEFT 
JOIN public.profiles ub ON t.updated_by_profile_id = ub.id -- Join for Trail 
Name (drives the language for each view row for trail's own fields) INNER JOIN 
public.translations name_trans ON name_trans.table_identifier = 'trails' AND 
name_trans.row_foreign_key = t.id::TEXT AND name_trans.column_identifier = 
'name' AND name_trans.translation_status = 'published_live' -- Assuming this 
status -- Left Joins for other translatable fields of the trail entity itself 
LEFT JOIN public.translations alt_names_trans ON 
alt_names_trans.table_identifier = 'trails' AND alt_names_trans.row_foreign_key 
= t.id::TEXT AND alt_names_trans.column_identifier = 'alternate_names' AND 
alt_names_trans.language_code = name_trans.language_code AND 
alt_names_trans.translation_status = 'published_live' -- Note: This is a 
simplified approach for text arrays. True per-element translation needs API 
logic. LEFT JOIN public.translations short_desc_trans ON 
short_desc_trans.table_identifier = 'trails' AND 
short_desc_trans.row_foreign_key = t.id::TEXT AND 
short_desc_trans.column_identifier = 'short_description' AND 
short_desc_trans.language_code = name_trans.language_code AND 
short_desc_trans.translation_status = 'published_live' LEFT JOIN 
public.translations full_desc_trans ON full_desc_trans.table_identifier = 
'trails' AND full_desc_trans.row_foreign_key = t.id::TEXT AND 
full_desc_trans.column_identifier = 'full_description' AND 
full_desc_trans.language_code = name_trans.language_code AND 
full_desc_trans.translation_status = 'published_live' LEFT JOIN 
public.translations hist_sig_trans ON hist_sig_trans.table_identifier = 
'trails' AND hist_sig_trans.row_foreign_key = t.id::TEXT AND 
hist_sig_trans.column_identifier = 'historical_significance' AND 
hist_sig_trans.language_code = name_trans.language_code AND 
hist_sig_trans.translation_status = 'published_live' LEFT JOIN 
public.translations cult_sig_trans ON cult_sig_trans.table_identifier = 
'trails' AND cult_sig_trans.row_foreign_key = t.id::TEXT AND 
cult_sig_trans.column_identifier = 'cultural_significance' AND 
cult_sig_trans.language_code = name_trans.language_code AND 
cult_sig_trans.translation_status = 'published_live' LEFT JOIN 
public.translations pilgrim_focus_trans ON pilgrim_focus_trans.table_identifier 
= 'trails' AND pilgrim_focus_trans.row_foreign_key = t.id::TEXT AND 
pilgrim_focus_trans.column_identifier = 'pilgrimage_focus' AND 
pilgrim_focus_trans.language_code = name_trans.language_code AND 
pilgrim_focus_trans.translation_status = 'published_live' LEFT JOIN 
public.translations start_point_trans ON start_point_trans.table_identifier = 
'trails' AND start_point_trans.row_foreign_key = t.id::TEXT AND 
start_point_trans.column_identifier = 'primary_start_point_name' AND 
start_point_trans.language_code = name_trans.language_code AND 
start_point_trans.translation_status = 'published_live' LEFT JOIN 
public.translations end_point_trans ON end_point_trans.table_identifier = 
'trails' AND end_point_trans.row_foreign_key = t.id::TEXT AND 
end_point_trans.column_identifier = 'primary_end_point_name' AND 
end_point_trans.language_code = name_trans.language_code AND 
end_point_trans.translation_status = 'published_live' LEFT JOIN 
public.translations direction_trans ON direction_trans.table_identifier = 
'trails' AND direction_trans.row_foreign_key = t.id::TEXT AND 
direction_trans.column_identifier = 'typical_direction_of_travel' AND 
direction_trans.language_code = name_trans.language_code AND 
direction_trans.translation_status = 'published_live' LEFT JOIN 
public.translations waymarking_desc_trans ON 
waymarking_desc_trans.table_identifier = 'trails' AND 
waymarking_desc_trans.row_foreign_key = t.id::TEXT AND 
waymarking_desc_trans.column_identifier = 'waymarking_description' AND 
waymarking_desc_trans.language_code = name_trans.language_code AND 
waymarking_desc_trans.translation_status = 'published_live' LEFT JOIN 
public.translations safety_cons_trans ON safety_cons_trans.table_identifier = 
'trails' AND safety_cons_trans.row_foreign_key = t.id::TEXT AND 
safety_cons_trans.column_identifier = 'overall_safety_considerations' AND 
safety_cons_trans.language_code = name_trans.language_code AND 
safety_cons_trans.translation_status = 'published_live' LEFT JOIN 
public.translations key_attr_summary_trans ON 
key_attr_summary_trans.table_identifier = 'trails' AND 
key_attr_summary_trans.row_foreign_key = t.id::TEXT AND 
key_attr_summary_trans.column_identifier = 'key_attractions_summary' AND 
key_attr_summary_trans.language_code = name_trans.language_code AND 
key_attr_summary_trans.translation_status = 'published_live' LEFT JOIN 
public.translations pilgrim_cred_info_trans ON 
pilgrim_cred_info_trans.table_identifier = 'trails' AND 
pilgrim_cred_info_trans.row_foreign_key = t.id::TEXT AND 
pilgrim_cred_info_trans.column_identifier = 'pilgrim_credential_info' AND 
pilgrim_cred_info_trans.language_code = name_trans.language_code AND 
pilgrim_cred_info_trans.translation_status = 'published_live' LEFT JOIN 
public.translations contact_org_name_trans ON 
contact_org_name_trans.table_identifier = 'trails' AND 
contact_org_name_trans.row_foreign_key = t.id::TEXT AND 
contact_org_name_trans.column_identifier = 'contact_organization_name' AND 
contact_org_name_trans.language_code = name_trans.language_code AND 
contact_org_name_trans.translation_status = 'published_live' LEFT JOIN 
public.translations data_source_credit_trans ON 
data_source_credit_trans.table_identifier = 'trails' AND 
data_source_credit_trans.row_foreign_key = t.id::TEXT AND 
data_source_credit_trans.column_identifier = 'primary_data_source_credit' AND 
data_source_credit_trans.language_code = name_trans.language_code AND 
data_source_credit_trans.translation_status = 'published_live' LEFT JOIN 
public.translations data_licence_info_trans ON 
data_licence_info_trans.table_identifier = 'trails' AND 
data_licence_info_trans.row_foreign_key = t.id::TEXT AND 
data_licence_info_trans.column_identifier = 'data_licence_info' AND 
data_licence_info_trans.language_code = name_trans.language_code AND 
data_licence_info_trans.translation_status = 'published_live' LEFT JOIN 
public.translations general_notes_trans ON general_notes_trans.table_identifier 
= 'trails' AND general_notes_trans.row_foreign_key = t.id::TEXT AND 
general_notes_trans.column_identifier = 'general_notes_for_pilgrims' AND 
general_notes_trans.language_code = name_trans.language_code AND 
general_notes_trans.translation_status = 'published_live' LEFT JOIN 
public.translations meta_desc_seo_trans ON meta_desc_seo_trans.table_identifier 
= 'trails' AND meta_desc_seo_trans.row_foreign_key = t.id::TEXT AND 
meta_desc_seo_trans.column_identifier = 'meta_description_seo' AND 
meta_desc_seo_trans.language_code = name_trans.language_code AND 
meta_desc_seo_trans.translation_status = 'published_live' LEFT JOIN 
public.translations wp_excerpt_trans ON wp_excerpt_trans.table_identifier = 
'trails' AND wp_excerpt_trans.row_foreign_key = t.id::TEXT AND 
wp_excerpt_trans.column_identifier = 'wordpress_excerpt' AND 
wp_excerpt_trans.language_code = name_trans.language_code AND 
wp_excerpt_trans.translation_status = 'published_live' -- Join for Logo Media 
and its alt text translation LEFT JOIN public.media logo_m ON t.logo_media_id = 
logo_m.id LEFT JOIN public.translations logo_alt_trans ON 
logo_alt_trans.table_identifier = 'media' -- Assuming 'media' table_identifier 
for media captions/alt_text AND logo_alt_trans.row_foreign_key = 
logo_m.id::TEXT AND logo_alt_trans.column_identifier = 'alt_text' -- Assuming 
'alt_text' as the column for media alt text AND logo_alt_trans.language_code = 
name_trans.language_code AND logo_alt_trans.translation_status = 
'published_live' -- Join for Banner Media and its alt text translation LEFT 
JOIN public.media banner_m ON t.banner_media_id = banner_m.id LEFT JOIN 
public.translations banner_alt_trans ON banner_alt_trans.table_identifier = 
'media' AND banner_alt_trans.row_foreign_key = banner_m.id::TEXT AND 
banner_alt_trans.column_identifier = 'alt_text' AND 
banner_alt_trans.language_code = name_trans.language_code AND 
banner_alt_trans.translation_status = 'published_live' WHERE -- Base filtering 
for view content (RLS will further refine) t.deleted_at IS NULL ; COMMENT ON 
VIEW public.v_trails_detailed_localized IS 'Provides a comprehensive, 
denormalized, and localized representation of a single trail''s core attributes 
and primary media. Each row represents a trail in a specific language. Related 
collections like regions, routes, terrain/usage types are fetched separately. 
Version: V2.' ; 3. Output Columns (Abridged list - includes key non-translated, 
primary translated, and media fields. The DDL shows all output columns.) Column 
Name Data Type Description trail_id BIGINT The unique ID of the trail. 
trail_slug TEXT The URL-friendly slug of the trail. is_featured BOOLEAN Flag 
indicating if the trail is featured. trail_operational_status 
public.trail_operational_status_enum Operational status of the trail. 
trail_content_visibility_status public.content_visibility_status_enum 
Visibility status of the base trail record. language_code TEXT The language 
code (e.g., 'en', 'it') for the translated textual fields in this row. name 
TEXT The translated name of the trail in the specified language_code . 
short_description TEXT The translated short description of the trail in the 
specified language_code . full_description TEXT The translated full description 
of the trail in the specified language_code . ... (other translated fields) ... 
TEXT ... best_seasons_to_walk_en TEXT[] Array of recommended seasons/months in 
English (base language). Individual element translation handled by API. 
logo_media_id BIGINT ID of the logo media item. logo_media_variants JSONB JSON 
object with URLs for different image variants of the logo. logo_media_alt_text 
TEXT Translated alt text for the logo in the specified language_code . 
banner_media_id BIGINT ID of the banner media item. banner_media_variants JSONB 
JSON object with URLs for different image variants of the banner. 
banner_media_alt_text TEXT Translated alt text for the banner in the specified 
language_code . trail_created_at TIMESTAMPTZ Creation timestamp of the trail 
record. trail_updated_at TIMESTAMPTZ Last update timestamp of the trail record. 
4. Example Usage To get details for trail ID 1 in Italian: SQL SELECT trail_id, 
trail_slug, name, -- This will be the Italian name short_description, -- 
Italian short description logo_media_variants ->> 'thumbnail_100x100' AS 
logo_thumbnail_url, logo_media_alt_text -- Italian alt text for logo FROM 
public.v_trails_detailed_localized WHERE trail_id = 1 AND language_code = 'it' 
AND trail_content_visibility_status = 'published' ; -- Assuming API applies 
this visibility 5. Underlying Tables & Key Joins Primary Table: public.trails 
(aliased as t ) Key Joins: public.translations (multiple LEFT JOIN s, one INNER 
JOIN for name ): For all translatable text fields of the trails entity itself. 
public.media (aliased as logo_m , banner_m ): For logo and banner image 
details. public.translations (again, for alt_text of media items). 
public.profiles (aliased as cb , ub ): Optional, for created/updated by user 
details. 6. RLS (Row-Level Security) Considerations The view should be defined 
with SECURITY INVOKER (default). RLS policies on the underlying public.trails , 
public.media , and public.translations tables will apply based on the querying 
user's permissions. The view's base WHERE clause ( t.deleted_at IS NULL ) 
provides an initial filter. API queries should further filter by 
trail_content_visibility_status = 'published' for public access. 7. Performance 
& Optimization Notes Indexing on public.translations : Absolutely critical. A 
composite index on (table_identifier, column_identifier, row_foreign_key, 
language_code, translation_status) is vital for performance due to multiple 
joins. Indexing on public.trails : Indexes on id (PK), slug , logo_media_id , 
banner_media_id , content_visibility_status , deleted_at are important. 
Indexing on public.media : Index on id (PK). Complexity: This view involves 
many LEFT JOIN s to the translations table. For languages with many missing 
translations, this is efficient. If all translations are usually present, 
performance should be monitored. Materialized View Consideration: If read 
performance for frequently accessed trails in specific languages becomes a 
bottleneck, this view could be a candidate for materialization, refreshed 
periodically. Separate Collections: Related collections (regions, terrain 
types, usage types, routes) are not aggregated into this view to keep its 
complexity manageable. The API layer should fetch these via separate, efficient 
queries filtered by trail_id , potentially using other summary views (like 
public.routes_summary_view ) or direct table queries. 8. Assumptions & 
Dependencies Assumes the public.translations table structure (with 
table_identifier , column_identifier , row_foreign_key , language_code , 
translated_text , translation_status ). Assumes translation_status = 
'published_live' (or equivalent) is used to identify production-ready 
translations. Assumes media.image_variants_json and 
media.storage_object_path_original (or similar) exist as per the public.media 
table spec. Assumes media translations for alt_text use table_identifier = 
'media' and column_identifier = 'alt_text' . Translation of TEXT[] fields like 
best_seasons_to_walk and alternate_names (where each element is translatable): 
This view shows a simplified approach for alternate_names_concat (concatenating 
or taking the first if multiple exist for a language, which isn't ideal) and 
returns the base English array for best_seasons_to_walk_en . Robust per-element 
translation of arrays is better handled at the API/application layer after 
fetching the base array and its trail_id . 9. Next-Action Checklist 🔴 Finalize 
translations table linkage: Confirm table_identifier , column_identifier , 
row_foreign_key usage, and translation_status values for all translatable 
fields of trails and media . 🟠 Implement and Test DDL: Create the 
public.v_trails_detailed_localized view in the database. 🟠 Test Performance: 
Thoroughly test query performance against this view, especially with various 
languages and data volumes. 🟢 Optimize Joins: Review join strategies if 
performance issues are identified. Consider if any LEFT JOIN to translations 
could be an INNER JOIN if a translation is mandatory for display. 🟢 Document 
for API Consumers: Clearly document the view's output, expected query patterns 
(especially filtering by language_code and trail_id ), and the strategy for 
fetching related collections (like regions, routes, terrain/usage types). 🟢 
Consider API Layer Aggregation: Re-confirm that aggregating related collections 
(terrain types, usage types, regions, routes) will be handled by the API layer 
making separate queries, rather than trying to embed them all as complex JSON 
arrays directly within this SQL view. Specification: 
public.v_routes_detailed_localized (View) 1. Purpose & Primary Use-Cases 
Purpose: To provide a comprehensive, denormalized, and localized representation 
of a single route's attributes, including its translated textual content, key 
statistics, parent trail context, and primary associated media details (map, 
banner, GPX). Each row in the view represents a route in a specific language. 
Primary Use-Cases: Supplying data for the GET 
/routes/{route_id}?lang={language_code} API endpoint, simplifying backend 
logic. Rendering a route's main detail page on a website or mobile application 
in the user's selected language. Internal reporting requiring detailed, 
localized route information. 2. View Definition (SQL DDL) SQL CREATE OR REPLACE 
VIEW public.v_routes_detailed_localized AS SELECT r.id AS route_id, r.slug AS 
route_slug, r.trail_id, t.name AS trail_name_en, -- Parent trail's English name 
for context t.slug AS trail_slug, r.route_code, r.is_primary_route_for_trail, 
r.route_category, r.alternative_to_route_id, r.is_featured_route, 
r.operational_status AS route_operational_status, r.content_visibility_status 
AS route_content_visibility_status, r.deleted_at AS route_deleted_at, 
r.total_distance_km, -- Auto-calculated r.estimated_duration_days, 
r.estimated_total_elevation_gain_meters, -- Auto-calculated r.route_difficulty, 
r.start_town_id, st.name AS start_town_name_en, -- Example join to towns for 
English name r.end_town_id, et.name AS end_town_name_en, -- Example join to 
towns for English name r.created_at AS route_created_at, r.updated_at AS 
route_updated_at, rcb.email AS route_created_by_email, -- Example rub.email AS 
route_updated_by_email, -- Example -- Language of this particular localized 
record for the route's own fields name_trans.language_code, -- Translated Route 
Fields name_trans.translated_text AS name, alt_name_trans.translated_text AS 
route_alternate_name, short_desc_trans.translated_text AS short_description, 
full_desc_trans.translated_text AS full_description, 
theme_focus_trans.translated_text AS route_theme_or_focus, 
curation_source_trans.translated_text AS route_curation_source, -- V1 
translatable start_desc_trans.translated_text AS start_point_description, 
end_desc_trans.translated_text AS end_point_description, 
terrain_summary_trans.translated_text AS terrain_summary_for_route, 
waymarking_nav_trans.translated_text AS waymarking_and_navigation_details, 
public_transit_trans.translated_text AS public_transit_at_start_end, 
accessibility_notes_trans.translated_text AS accessibility_notes, 
general_notes_trans.translated_text AS general_notes_for_route, 
meta_desc_seo_trans.translated_text AS meta_description_seo, 
wp_excerpt_trans.translated_text AS wordpress_excerpt, r.best_seasons_for_route 
AS best_seasons_for_route_en, -- Base English array -- Map Overview Media 
Details map_m.id AS map_overview_media_id, map_m.storage_object_path_original 
AS map_overview_media_original_url, map_m.image_variants_json AS 
map_overview_media_variants, map_alt_trans.translated_text AS 
map_overview_media_alt_text, -- Banner Media Details banner_m.id AS 
banner_media_id, banner_m.storage_object_path_original AS 
banner_media_original_url, banner_m.image_variants_json AS 
banner_media_variants, banner_alt_trans.translated_text AS 
banner_media_alt_text, -- Overall GPX Media Details gpx_m.id AS 
overall_gpx_media_id, gpx_m.storage_object_path_original AS 
overall_gpx_file_url, -- URL to the actual GPX file gpx_m.file_name_original AS 
overall_gpx_file_name, gpx_m.file_size_bytes_original AS 
overall_gpx_file_size_bytes FROM public.routes r JOIN public.trails t ON 
r.trail_id = t.id LEFT JOIN public.towns st ON r.start_town_id = st.id -- For 
English start town name LEFT JOIN public.towns et ON r.end_town_id = et.id -- 
For English end town name LEFT JOIN public.profiles rcb ON 
r.created_by_profile_id = rcb.id LEFT JOIN public.profiles rub ON 
r.updated_by_profile_id = rub.id -- Join for Route Name (drives the language 
for each view row) INNER JOIN public.translations name_trans ON 
name_trans.table_identifier = 'routes' AND name_trans.row_foreign_key = 
r.id::TEXT AND name_trans.column_identifier = 'name' AND 
name_trans.translation_status = 'published_live' -- Left Joins for other 
translatable fields of the route entity LEFT JOIN public.translations 
alt_name_trans ON alt_name_trans.table_identifier = 'routes' AND 
alt_name_trans.row_foreign_key = r.id::TEXT AND 
alt_name_trans.column_identifier = 'route_alternate_name' AND 
alt_name_trans.language_code = name_trans.language_code AND 
alt_name_trans.translation_status = 'published_live' LEFT JOIN 
public.translations short_desc_trans ON short_desc_trans.table_identifier = 
'routes' AND short_desc_trans.row_foreign_key = r.id::TEXT AND 
short_desc_trans.column_identifier = 'short_description' AND 
short_desc_trans.language_code = name_trans.language_code AND 
short_desc_trans.translation_status = 'published_live' LEFT JOIN 
public.translations full_desc_trans ON full_desc_trans.table_identifier = 
'routes' AND full_desc_trans.row_foreign_key = r.id::TEXT AND 
full_desc_trans.column_identifier = 'full_description' AND 
full_desc_trans.language_code = name_trans.language_code AND 
full_desc_trans.translation_status = 'published_live' LEFT JOIN 
public.translations theme_focus_trans ON theme_focus_trans.table_identifier = 
'routes' AND theme_focus_trans.row_foreign_key = r.id::TEXT AND 
theme_focus_trans.column_identifier = 'route_theme_or_focus' AND 
theme_focus_trans.language_code = name_trans.language_code AND 
theme_focus_trans.translation_status = 'published_live' LEFT JOIN 
public.translations curation_source_trans ON 
curation_source_trans.table_identifier = 'routes' AND 
curation_source_trans.row_foreign_key = r.id::TEXT AND 
curation_source_trans.column_identifier = 'route_curation_source' AND 
curation_source_trans.language_code = name_trans.language_code AND 
curation_source_trans.translation_status = 'published_live' LEFT JOIN 
public.translations start_desc_trans ON start_desc_trans.table_identifier = 
'routes' AND start_desc_trans.row_foreign_key = r.id::TEXT AND 
start_desc_trans.column_identifier = 'start_point_description' AND 
start_desc_trans.language_code = name_trans.language_code AND 
start_desc_trans.translation_status = 'published_live' LEFT JOIN 
public.translations end_desc_trans ON end_desc_trans.table_identifier = 
'routes' AND end_desc_trans.row_foreign_key = r.id::TEXT AND 
end_desc_trans.column_identifier = 'end_point_description' AND 
end_desc_trans.language_code = name_trans.language_code AND 
end_desc_trans.translation_status = 'published_live' LEFT JOIN 
public.translations terrain_summary_trans ON 
terrain_summary_trans.table_identifier = 'routes' AND 
terrain_summary_trans.row_foreign_key = r.id::TEXT AND 
terrain_summary_trans.column_identifier = 'terrain_summary_for_route' AND 
terrain_summary_trans.language_code = name_trans.language_code AND 
terrain_summary_trans.translation_status = 'published_live' LEFT JOIN 
public.translations waymarking_nav_trans ON 
waymarking_nav_trans.table_identifier = 'routes' AND 
waymarking_nav_trans.row_foreign_key = r.id::TEXT AND 
waymarking_nav_trans.column_identifier = 'waymarking_and_navigation_details' 
AND waymarking_nav_trans.language_code = name_trans.language_code AND 
waymarking_nav_trans.translation_status = 'published_live' LEFT JOIN 
public.translations public_transit_trans ON 
public_transit_trans.table_identifier = 'routes' AND 
public_transit_trans.row_foreign_key = r.id::TEXT AND 
public_transit_trans.column_identifier = 'public_transit_at_start_end' AND 
public_transit_trans.language_code = name_trans.language_code AND 
public_transit_trans.translation_status = 'published_live' LEFT JOIN 
public.translations accessibility_notes_trans ON 
accessibility_notes_trans.table_identifier = 'routes' AND 
accessibility_notes_trans.row_foreign_key = r.id::TEXT AND 
accessibility_notes_trans.column_identifier = 'accessibility_notes' AND 
accessibility_notes_trans.language_code = name_trans.language_code AND 
accessibility_notes_trans.translation_status = 'published_live' LEFT JOIN 
public.translations general_notes_trans ON general_notes_trans.table_identifier 
= 'routes' AND general_notes_trans.row_foreign_key = r.id::TEXT AND 
general_notes_trans.column_identifier = 'general_notes_for_route' AND 
general_notes_trans.language_code = name_trans.language_code AND 
general_notes_trans.translation_status = 'published_live' LEFT JOIN 
public.translations meta_desc_seo_trans ON meta_desc_seo_trans.table_identifier 
= 'routes' AND meta_desc_seo_trans.row_foreign_key = r.id::TEXT AND 
meta_desc_seo_trans.column_identifier = 'meta_description_seo' AND 
meta_desc_seo_trans.language_code = name_trans.language_code AND 
meta_desc_seo_trans.translation_status = 'published_live' LEFT JOIN 
public.translations wp_excerpt_trans ON wp_excerpt_trans.table_identifier = 
'routes' AND wp_excerpt_trans.row_foreign_key = r.id::TEXT AND 
wp_excerpt_trans.column_identifier = 'wordpress_excerpt' AND 
wp_excerpt_trans.language_code = name_trans.language_code AND 
wp_excerpt_trans.translation_status = 'published_live' -- Map Overview Media 
LEFT JOIN public.media map_m ON r.map_overview_media_id = map_m.id LEFT JOIN 
public.translations map_alt_trans ON map_alt_trans.table_identifier = 'media' 
AND map_alt_trans.row_foreign_key = map_m.id::TEXT AND 
map_alt_trans.column_identifier = 'alt_text' AND map_alt_trans.language_code = 
name_trans.language_code AND map_alt_trans.translation_status = 
'published_live' -- Banner Media LEFT JOIN public.media banner_m ON 
r.banner_media_id = banner_m.id LEFT JOIN public.translations banner_alt_trans 
ON banner_alt_trans.table_identifier = 'media' AND 
banner_alt_trans.row_foreign_key = banner_m.id::TEXT AND 
banner_alt_trans.column_identifier = 'alt_text' AND 
banner_alt_trans.language_code = name_trans.language_code AND 
banner_alt_trans.translation_status = 'published_live' -- Overall GPX Media 
LEFT JOIN public.media gpx_m ON r.overall_gpx_media_id = gpx_m.id -- No alt 
text for GPX typically WHERE r.deleted_at IS NULL ; COMMENT ON VIEW 
public.v_routes_detailed_localized IS 'Provides comprehensive, denormalized, 
and localized details for a single route, including parent trail context and 
primary media. Each row represents a route in a specific language. Segments are 
fetched separately. Version: V2.' ; 3. Output Columns (Abridged list - includes 
key non-translated, primary translated, parent trail, and media fields. The DDL 
shows all output columns.) Column Name Data Type Description route_id BIGINT 
The unique ID of the route. route_slug TEXT The URL-friendly slug of the route. 
trail_id BIGINT ID of the parent trail. trail_name_en TEXT English name of the 
parent trail. trail_slug TEXT Slug of the parent trail. 
route_operational_status public.trail_operational_status_enum Operational 
status of the route. route_content_visibility_status 
public.content_visibility_status_enum Visibility status of the base route 
record. total_distance_km REAL Auto-calculated total distance of the route. 
estimated_total_elevation_gain_meters INTEGER Auto-calculated total elevation 
gain of the route. language_code TEXT The language code (e.g., 'en', 'it') for 
the translated textual fields in this row. name TEXT The translated name of the 
route in the specified language_code . short_description TEXT The translated 
short description of the route in the specified language_code . ... (other 
translated fields) ... TEXT ... best_seasons_for_route_en TEXT[] Array of 
recommended seasons/months in English (base language). Individual element 
translation by API. map_overview_media_id BIGINT ID of the map overview media 
item. map_overview_media_variants JSONB Image variants for the map overview. 
map_overview_media_alt_text TEXT Translated alt text for the map overview media 
in the specified language_code . banner_media_id BIGINT ID of the banner media 
item. banner_media_variants JSONB Image variants for the banner. 
banner_media_alt_text TEXT Translated alt text for the banner media in the 
specified language_code . overall_gpx_media_id BIGINT ID of the overall GPX 
media item. overall_gpx_file_url TEXT Direct URL to the original GPX file (from 
media.storage_object_path_original ). overall_gpx_file_name TEXT Original file 
name of the GPX track. 4. Example Usage To get details for route ID 20 in 
Italian: SQL SELECT route_id, route_slug, name, -- Italian name trail_name_en, 
-- English trail name for context total_distance_km, 
map_overview_media_variants ->> 'display_800w' AS map_image_url, 
map_overview_media_alt_text -- Italian alt text for map FROM 
public.v_routes_detailed_localized WHERE route_id = 20 AND language_code = 'it' 
AND route_content_visibility_status = 'published' ; -- Assuming API applies 
this 5. Underlying Tables & Key Joins Primary Table: public.routes (aliased as 
r ) Key Joins: public.trails (as t ): For parent trail context. public.towns 
(as st , et ): For start/end town names (English only in this view, 
translations via separate query if needed for towns). public.translations 
(multiple LEFT JOIN s, one INNER JOIN for name ): For all translatable text 
fields of the routes entity and its primary media. public.media (as map_m , 
banner_m , gpx_m ): For map, banner, and GPX file details. public.profiles (as 
rcb , rub ): Optional, for created/updated by user details. 6. RLS (Row-Level 
Security) Considerations View defined with SECURITY INVOKER (default). RLS 
policies on public.routes , public.trails , public.media , public.towns , and 
public.translations will apply. The view's base WHERE clause ( r.deleted_at IS 
NULL ) provides initial filtering. API queries should further filter by 
route_content_visibility_status = 'published' and ensure the parent trail is 
also visible. 7. Performance & Optimization Notes Indexing on 
public.translations : Crucial (composite index on (table_identifier, 
column_identifier, row_foreign_key, language_code, translation_status) ). 
Indexing on public.routes : Indexes on id (PK), slug , trail_id , media FKs, 
content_visibility_status , deleted_at . Indexing on public.trails : Indexes on 
id (PK). Indexing on public.media : Index on id (PK). Complexity: Similar to 
v_trails_detailed_localized , involves many joins. Performance monitoring is 
advised. Materialized View: Could be a candidate for materialization if read 
performance is critical for frequently accessed routes. Segments: The ordered 
list of segments for a route is not included in this view to avoid excessive 
complexity and large row sizes (if segments were exploded). Segments should be 
fetched via a separate API call using route_id , potentially utilizing 
public.segments_summary_view or querying public.segments directly (and its 
translations/media). 8. Assumptions & Dependencies Assumes public.translations 
table structure and translation_status = 'published_live' . Assumes 
public.media table structure including image_variants_json , 
storage_object_path_original , file_name_original , file_size_bytes_original . 
Assumes alt_text for media is translated via public.translations with 
table_identifier = 'media' . Assumes towns.name provides the English name; full 
town localization would be via town-specific API/view. Translation of 
best_seasons_for_route (TEXT[]) is handled by API layer. 9. Next-Action 
Checklist 🔴 Finalize translations table linkage: Confirm all table_identifier 
and column_identifier values for routes and media translatable fields. 🟠 
Implement and Test DDL: Create the public.v_routes_detailed_localized view. 🟠 
Test Performance: Test with various languages, data volumes, and common filter 
conditions. 🟢 Optimize Joins/Consider Materialization: Based on performance 
testing. 🟢 Document for API Consumers: Detail output columns, query patterns, 
and the strategy for fetching the associated list of segments. 🟢 API Layer for 
Segments: Ensure the API layer efficiently fetches and integrates the ordered 
list of segments (summary or full) when a client requests route details with 
segments. Specification: public.v_segments_detailed_localized (View) 1. Purpose 
& Primary Use-Cases Purpose: To provide a comprehensive, denormalized, and 
localized representation of a single segment's attributes. This includes its 
translated textual content, pre-calculated geometric statistics, linked 
waypoint information (summary), dominant terrain type details, and GPX file 
information. Each row in the view represents a segment in a specific language. 
Primary Use-Cases: Supplying data for the GET 
/segments/{segment_id}?lang={language_code} API endpoint, simplifying backend 
logic for fetching detailed segment information. Rendering a segment's detail 
page or section within a route display on a website or mobile application in 
the user's selected language. Internal reporting or data analysis requiring 
detailed, localized segment data. 2. View Definition (SQL DDL) SQL CREATE OR 
REPLACE VIEW public.v_segments_detailed_localized AS SELECT s.id AS segment_id, 
s.slug AS segment_slug, s.name AS segment_name_en, -- Base English name for 
reference s.start_waypoint_id, wp_start.name AS start_waypoint_name_en, -- 
English name of start waypoint s.end_waypoint_id, wp_end.name AS 
end_waypoint_name_en, -- English name of end waypoint s.path_geom, -- Consider 
if this should be systematically excluded by default in API and only included 
on demand s.distance_km, s.estimated_walking_time_minutes, 
s.elevation_gain_meters, s.elevation_loss_meters, s.min_elevation_meters, 
s.max_elevation_meters, s.average_gradient_percentage, 
s.elevation_profile_data, s.segment_difficulty, s.dominant_terrain_type_id, 
dtm.code AS dominant_terrain_code, dtm.icon_identifier AS 
dominant_terrain_icon_identifier, s.sun_exposure_level, 
s.recommended_travel_direction, s.operational_status AS 
segment_operational_status, s.content_visibility_status AS 
segment_content_visibility_status, s.deleted_at AS segment_deleted_at, 
s.is_detour_for_segment_id, s.gpx_media_id, gpx_m.storage_object_path_original 
AS gpx_file_url, gpx_m.file_name_original AS gpx_file_name, 
s.primary_data_source_segment, s.created_at AS segment_created_at, s.updated_at 
AS segment_updated_at, scb.email AS segment_created_by_email, -- Example 
sub.email AS segment_updated_by_email, -- Example -- Language of this 
particular localized record name_trans.language_code, -- Translated Segment 
Fields name_trans.translated_text AS name, short_desc_trans.translated_text AS 
short_description, detailed_desc_trans.translated_text AS 
detailed_description_notes, waymarking_notes_trans.translated_text AS 
waymarking_on_segment_notes, suitability_notes_trans.translated_text AS 
segment_suitability_notes, water_notes_trans.translated_text AS 
water_sources_general_notes, resupply_notes_trans.translated_text AS 
resupply_options_general_notes, cultural_notes_trans.translated_text AS 
segment_cultural_historical_notes, emergency_notes_trans.translated_text AS 
emergency_access_notes, weather_advice_trans.translated_text AS 
segment_weather_advice, -- Translated Dominant Terrain Name 
dtm_name_trans.translated_text AS dominant_terrain_name FROM public.segments s 
LEFT JOIN public.waypoints wp_start ON s.start_waypoint_id = wp_start.id LEFT 
JOIN public.waypoints wp_end ON s.end_waypoint_id = wp_end.id LEFT JOIN 
public.terrain_types_master dtm ON s.dominant_terrain_type_id = dtm.id LEFT 
JOIN public.media gpx_m ON s.gpx_media_id = gpx_m.id LEFT JOIN public.profiles 
scb ON s.created_by_profile_id = scb.id LEFT JOIN public.profiles sub ON 
s.updated_by_profile_id = sub.id -- Join for Segment Name (drives the language 
for each view row) INNER JOIN public.translations name_trans ON 
name_trans.table_identifier = 'segments' AND name_trans.row_foreign_key = 
s.id::TEXT AND name_trans.column_identifier = 'name' AND 
name_trans.translation_status = 'published_live' -- Left Joins for other 
translatable fields of the segment entity LEFT JOIN public.translations 
short_desc_trans ON short_desc_trans.table_identifier = 'segments' AND 
short_desc_trans.row_foreign_key = s.id::TEXT AND 
short_desc_trans.column_identifier = 'short_description' AND 
short_desc_trans.language_code = name_trans.language_code AND 
short_desc_trans.translation_status = 'published_live' LEFT JOIN 
public.translations detailed_desc_trans ON detailed_desc_trans.table_identifier 
= 'segments' AND detailed_desc_trans.row_foreign_key = s.id::TEXT AND 
detailed_desc_trans.column_identifier = 'detailed_description_notes' AND 
detailed_desc_trans.language_code = name_trans.language_code AND 
detailed_desc_trans.translation_status = 'published_live' LEFT JOIN 
public.translations waymarking_notes_trans ON 
waymarking_notes_trans.table_identifier = 'segments' AND 
waymarking_notes_trans.row_foreign_key = s.id::TEXT AND 
waymarking_notes_trans.column_identifier = 'waymarking_on_segment_notes' AND 
waymarking_notes_trans.language_code = name_trans.language_code AND 
waymarking_notes_trans.translation_status = 'published_live' LEFT JOIN 
public.translations suitability_notes_trans ON 
suitability_notes_trans.table_identifier = 'segments' AND 
suitability_notes_trans.row_foreign_key = s.id::TEXT AND 
suitability_notes_trans.column_identifier = 'segment_suitability_notes' AND 
suitability_notes_trans.language_code = name_trans.language_code AND 
suitability_notes_trans.translation_status = 'published_live' LEFT JOIN 
public.translations water_notes_trans ON water_notes_trans.table_identifier = 
'segments' AND water_notes_trans.row_foreign_key = s.id::TEXT AND 
water_notes_trans.column_identifier = 'water_sources_general_notes' AND 
water_notes_trans.language_code = name_trans.language_code AND 
water_notes_trans.translation_status = 'published_live' LEFT JOIN 
public.translations resupply_notes_trans ON 
resupply_notes_trans.table_identifier = 'segments' AND 
resupply_notes_trans.row_foreign_key = s.id::TEXT AND 
resupply_notes_trans.column_identifier = 'resupply_options_general_notes' AND 
resupply_notes_trans.language_code = name_trans.language_code AND 
resupply_notes_trans.translation_status = 'published_live' LEFT JOIN 
public.translations cultural_notes_trans ON 
cultural_notes_trans.table_identifier = 'segments' AND 
cultural_notes_trans.row_foreign_key = s.id::TEXT AND 
cultural_notes_trans.column_identifier = 'segment_cultural_historical_notes' 
AND cultural_notes_trans.language_code = name_trans.language_code AND 
cultural_notes_trans.translation_status = 'published_live' LEFT JOIN 
public.translations emergency_notes_trans ON 
emergency_notes_trans.table_identifier = 'segments' AND 
emergency_notes_trans.row_foreign_key = s.id::TEXT AND 
emergency_notes_trans.column_identifier = 'emergency_access_notes' AND 
emergency_notes_trans.language_code = name_trans.language_code AND 
emergency_notes_trans.translation_status = 'published_live' LEFT JOIN 
public.translations weather_advice_trans ON 
weather_advice_trans.table_identifier = 'segments' AND 
weather_advice_trans.row_foreign_key = s.id::TEXT AND 
weather_advice_trans.column_identifier = 'segment_weather_advice' AND 
weather_advice_trans.language_code = name_trans.language_code AND 
weather_advice_trans.translation_status = 'published_live' -- Join for 
Translated Dominant Terrain Name LEFT JOIN public.translations dtm_name_trans 
ON dtm_name_trans.table_identifier = 'terrain_types_master' AND 
dtm_name_trans.row_foreign_key = dtm.id::TEXT AND 
dtm_name_trans.column_identifier = 'name' AND dtm_name_trans.language_code = 
name_trans.language_code AND dtm_name_trans.translation_status = 
'published_live' WHERE s.deleted_at IS NULL ; COMMENT ON VIEW 
public.v_segments_detailed_localized IS 'Provides comprehensive, denormalized, 
and localized details for a single segment, including geometric stats, waypoint 
info, dominant terrain, and GPX media. Each row is a segment in a specific 
language. Additional terrain and media gallery items are fetched separately. 
Version: V2.' ; 3. Output Columns (Abridged list - includes key non-translated, 
primary translated, and related entity fields. The DDL shows all output 
columns.) Column Name Data Type Description segment_id BIGINT The unique ID of 
the segment. segment_slug TEXT The URL-friendly slug of the segment. 
segment_name_en TEXT Base English name of the segment. start_waypoint_id BIGINT 
ID of the start waypoint. start_waypoint_name_en TEXT English name of the start 
waypoint (full waypoint details via separate API if needed). end_waypoint_id 
BIGINT ID of the end waypoint. end_waypoint_name_en TEXT English name of the 
end waypoint. path_geom GEOMETRY The full 3D path geometry (LineStringZ). 
distance_km REAL Auto-calculated distance of the segment. ... (other geometric 
stats) ... ... ... elevation_profile_data JSONB Auto-generated data for 
elevation profile charts. dominant_terrain_code TEXT Code of the dominant 
terrain type. dominant_terrain_icon_identifier TEXT Icon identifier for the 
dominant terrain. segment_operational_status 
public.trail_operational_status_enum Operational status of the segment. 
segment_content_visibility_status public.content_visibility_status_enum 
Visibility status of the base segment record. gpx_media_id BIGINT ID of the GPX 
media item. gpx_file_url TEXT URL to the original GPX file. language_code TEXT 
The language code for the translated fields in this row. name TEXT Translated 
name of the segment. short_description TEXT Translated short description of the 
segment. ... (other translated fields) ... TEXT ... dominant_terrain_name TEXT 
Translated name of the dominant terrain type. 4. Example Usage To get details 
for segment ID 501 in Italian: SQL SELECT segment_id, segment_slug, name, -- 
Italian name distance_km, dominant_terrain_name, -- Italian terrain name 
gpx_file_url FROM public.v_segments_detailed_localized WHERE segment_id = 501 
AND language_code = 'it' AND segment_content_visibility_status = 'published' ; 
-- Assuming API applies visibility 5. Underlying Tables & Key Joins Primary 
Table: public.segments (aliased as s ) Key Joins: public.waypoints (as wp_start 
, wp_end ): For start/end waypoint names. public.terrain_types_master (as dtm 
): For dominant terrain details. public.media (as gpx_m ): For GPX file 
details. public.translations (multiple LEFT JOIN s, one INNER JOIN for name ): 
For all translatable text fields of the segments entity and its dominant 
terrain. public.profiles (as scb , sub ): Optional, for user details. 6. RLS 
(Row-Level Security) Considerations View defined with SECURITY INVOKER 
(default). RLS policies on public.segments , public.waypoints , 
public.terrain_types_master , public.media , and public.translations will 
apply. The view's base WHERE clause ( s.deleted_at IS NULL ) provides initial 
filtering. API queries should further filter by 
segment_content_visibility_status = 'published' and ensure it's part of a 
visible route/trail. 7. Performance & Optimization Notes Indexing: Critical 
indexes on public.translations (composite), public.segments ( id , slug , FKs, 
path_geom GIST), public.waypoints ( id ), public.terrain_types_master ( id ), 
public.media ( id ). path_geom and elevation_profile_data : These can be large. 
APIs should consider allowing clients to selectively include/exclude them 
(e.g., using SELECT column specification in Supabase PostgREST calls) to manage 
payload size. The geometric stats ( distance_km , etc.) are pre-calculated on 
segments which is a major performance benefit. Materialized View: Could be a 
candidate for materialization if reads are very frequent and data changes less 
often. Separate Collections: segment_additional_terrain_types and segment_media 
(gallery) are not aggregated into this view. They should be fetched by the API 
layer using separate, efficient queries filtered by segment_id . 8. Assumptions 
& Dependencies Assumes public.translations structure and translation_status = 
'published_live' . Assumes public.media contains GPX files with relevant 
metadata. Assumes terrain_types_master.name is the translatable field for 
terrain names. English names for waypoints are fetched; full waypoint 
localization would be via a waypoint-specific API/view. 9. Next-Action 
Checklist 🔴 Finalize translations table linkage: Confirm all table_identifier 
and column_identifier values for segments and terrain_types_master translatable 
fields. 🟠 Implement and Test DDL: Create the 
public.v_segments_detailed_localized view. 🟠 Test Performance: Test with 
various languages, data volumes, and especially when path_geom or 
elevation_profile_data are selected. 🟢 Optimize Joins/Consider 
Materialization: Based on performance testing. 🟢 Document for API Consumers: 
Detail output columns, query patterns (especially language and segment ID 
filtering), and the strategy for fetching related collections (additional 
terrain, media gallery). 🟢 API Layer for Collections: Ensure the API layer can 
efficiently fetch and integrate segment_additional_terrain_types (with their 
localized names) and segment_media (with localized captions/alt-text and image 
variants). 
