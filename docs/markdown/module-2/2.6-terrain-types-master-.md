# 2.6 terrain_types_master_

  
https://gemini.google.com/u/1/app/9ed6b32c76b55d3a?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/8d62cfd96b565ac8 
https://gemini.google.com/u/1/app/2d30425fc8a5984a * * * * * ### Updated 
Production-Ready Specification Table Name: `public.terrain_types_master` 1\. 
Purpose & Primary Use-Cases This table stores a canonical, centrally managed 
list of distinct terrain types encountered on pilgrimage trails (e.g., 
"forest_path," "paved_road"). It provides structured, translatable data for 
consistent classification, UI representation (icons, display names), and 
filtering capabilities across the platform. Key User-Story Touchpoints: - 
Pilgrim (Anna) - Story A1 & A2 (Route/Stage Exploration): Allows Anna to 
understand terrain types via consistent, translated names and icons associated 
with trails and segments. - Platform Administrator (Admin Team) - Story D1 
(Managing Content): Admins manage the definitive list of terrain types, 
ensuring data quality and consistency. - UI/UX: Provides structured data 
(`code`, `icon_identifier`, and link to translations) for clear display in 
filters, legends, and details. 2\. Schema | Column Name | Data Type | 
Constraints | Description (Translatable fields via public.translations) | | 
`id` | `integer` | PRIMARY KEY, GENERATED ALWAYS AS IDENTITY | Unique 
identifier for each terrain type. | | `code` | `text` | NOT NULL, UNIQUE, CHECK 
(`code` ~ '^[a-z0-9_]+$' AND char_length(`code`) &lt;= 50) | Machine-readable, 
stable code (e.g., "forest_path"). Not for direct display. | | `name` | `text` 
| | *Handled by `public.translations` table* (English base for reference if 
desired, but primary source is `translations`). | | `description` | `text` | | 
*Handled by `public.translations` table* (English base for reference if 
desired, but primary source is `translations`). | | `icon_identifier` | `text` 
| CHECK (`icon_identifier` IS NULL OR char_length(`icon_identifier`) &lt;= 100) 
| Identifier (e.g., CSS class, SVG name) for an icon. | | `notes` | `text` | | 
Internal administrative notes. Not typically for public display. | | 
`display_order` | `integer` | NOT NULL DEFAULT 0 | Optional order for 
displaying terrain types in UI lists/filters. | | `is_active` | `boolean` | NOT 
NULL DEFAULT `true` | Flag to indicate if the terrain type is active and 
available for use. | | `created_at` | `timestamptz` | NOT NULL DEFAULT `now()` 
| Timestamp of record creation. | | `created_by_profile_id` | `uuid` | 
REFERENCES `public.profiles(id)` ON DELETE SET NULL | Profile ID of the user 
who created this record. | | `updated_at` | `timestamptz` | NOT NULL DEFAULT 
`now()` | Timestamp of last update (auto-updated by trigger). | | 
`updated_by_profile_id` | `uuid` | REFERENCES `public.profiles(id)` ON DELETE 
SET NULL | Profile ID of the user who last updated this record. | 3\. 
PostgreSQL DDL SQL ``` -- This DDL assumes the 'public' schema is in use and 
'public.profiles' table exists. CREATE TABLE public.terrain_types_master ( id 
INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY, -- code TEXT NOT NULL UNIQUE 
CHECK (code ~ '^[a-z0-9_]+$' AND char_length(code) <= 50), -- icon_identifier 
TEXT CHECK (icon_identifier IS NULL OR char_length(icon_identifier) <= 100), -- 
notes TEXT, -- display_order INTEGER NOT NULL DEFAULT 0, -- is_active BOOLEAN 
NOT NULL DEFAULT true, -- V2 Enhancement created_at TIMESTAMPTZ NOT NULL 
DEFAULT now(), -- created_by_profile_id UUID REFERENCES public.profiles(id) ON 
DELETE SET NULL, -- V2 Enhancement updated_at TIMESTAMPTZ NOT NULL DEFAULT 
now(), -- updated_by_profile_id UUID REFERENCES public.profiles(id) ON DELETE 
SET NULL -- V2 Enhancement ); -- Indexes CREATE INDEX IF NOT EXISTS 
idx_terrain_types_master_code ON public.terrain_types_master(code); -- CREATE 
INDEX IF NOT EXISTS idx_terrain_types_master_display_order ON 
public.terrain_types_master(display_order); -- CREATE INDEX IF NOT EXISTS 
idx_terrain_types_master_is_active ON public.terrain_types_master(is_active); 
-- V2 Enhancement -- Trigger for audit columns (created_by_profile_id, 
updated_at, updated_by_profile_id) -- This function can be generic for master 
tables or specific. CREATE OR REPLACE FUNCTION 
public.set_master_table_audit_meta() RETURNS TRIGGER AS $$ BEGIN NEW.updated_at 
= NOW(); IF (TG_OP = 'INSERT') THEN IF NEW.created_by_profile_id IS NULL THEN 
-- Allow seeding without a user NEW.created_by_profile_id := auth.uid(); END 
IF; IF NEW.updated_by_profile_id IS NULL THEN NEW.updated_by_profile_id := 
auth.uid(); END IF; ELSIF (TG_OP = 'UPDATE') THEN NEW.updated_by_profile_id = 
auth.uid(); NEW.created_at = OLD.created_at; -- Preserve original creation 
audit fields NEW.created_by_profile_id = OLD.created_by_profile_id; END IF; 
RETURN NEW; END; $$ LANGUAGE plpgsql SECURITY DEFINER; CREATE TRIGGER 
trigger_terrain_types_master_audit_meta BEFORE INSERT OR UPDATE ON 
public.terrain_types_master FOR EACH ROW EXECUTE FUNCTION 
public.set_master_table_audit_meta(); -- Comments COMMENT ON TABLE 
public.terrain_types_master IS 'Master list of distinct terrain types 
encountered on trails (e.g., forest_path, paved_road). Provides canonical 
definitions for consistent classification. Version: V2.'; -- COMMENT ON COLUMN 
public.terrain_types_master.id IS 'Unique identifier for the terrain type. 
Version: V2.'; -- COMMENT ON COLUMN public.terrain_types_master.code IS 'A 
machine-readable, stable code for the terrain type (e.g., "forest_path"). Used 
for internal referencing, not for direct public display. Should be lowercase 
with underscores. Version: V2.'; -- COMMENT ON COLUMN 
public.terrain_types_master.icon_identifier IS 'Identifier (e.g., CSS class 
name, SVG file name) for an icon representing this terrain type. Version: V2.'; 
-- COMMENT ON COLUMN public.terrain_types_master.notes IS 'Internal 
administrative notes about this terrain type, its usage, or definition nuances. 
Not typically for public display. Version: V2.'; -- COMMENT ON COLUMN 
public.terrain_types_master.display_order IS 'Optional: an integer value to 
control the order in which terrain types are presented in administrative 
interfaces or user-facing selection lists/filters. Version: V2.'; -- COMMENT ON 
COLUMN public.terrain_types_master.is_active IS 'Flag to indicate if the 
terrain type is active and available for new associations. Default true. 
Version: V2.'; COMMENT ON COLUMN public.terrain_types_master.created_at IS 
'Timestamp of when the terrain type record was created. Version: V2.'; -- 
COMMENT ON COLUMN public.terrain_types_master.created_by_profile_id IS 'Profile 
ID of the user who created this terrain type record. Version: V2.'; COMMENT ON 
COLUMN public.terrain_types_master.updated_at IS 'Timestamp of when the terrain 
type record was last updated. Auto-updated by trigger. Version: V2.'; -- 
COMMENT ON COLUMN public.terrain_types_master.updated_by_profile_id IS 'Profile 
ID of the user who last updated this terrain type record. Version: V2.'; ``` 
4\. JSON Schema Mirror JSON ``` { "title": "terrain_type_master", 
"description": "Master list of distinct terrain types encountered on trails, 
providing canonical definitions for classification. Version: V2.", "type": 
"object", "properties": { "id": { "type": "integer", "format": "int32", 
"description": "Unique identifier for the terrain type. Read-only.", -- 
"readOnly": true }, "code": { "type": "string", "maxLength": 50, "pattern": 
"^[a-z0-9_]+$", "description": "A machine-readable, stable code (e.g., 
\"forest_path\"). Not for direct public display. Must be unique." -- }, 
"icon_identifier": { "type": ["string", "null"], "maxLength": 100, 
"description": "Identifier (e.g., CSS class name, file name) for an icon 
representing this terrain type." -- }, "notes": { "type": ["string", "null"], 
"description": "Internal administrative notes about this terrain type." -- }, 
"display_order": { "type": "integer", "default": 0, "description": "Optional: 
an order for displaying terrain types in admin UIs or selection lists." -- }, 
"is_active": { "type": "boolean", "default": true, "description": "Flag to 
indicate if the terrain type is active and available for use." }, "created_at": 
{ "type": "string", "format": "date-time", "description": "Timestamp of record 
creation. Read-only.", -- "readOnly": true }, "created_by_profile_id": { 
"type": ["string", "null"], "format": "uuid", "description": "Profile ID 
(public.profiles.id) of the user who created this record. Read-only.", 
"readOnly": true }, "updated_at": { "type": "string", "format": "date-time", 
"description": "Timestamp of last update. Read-only.", -- "readOnly": true }, 
"updated_by_profile_id": { "type": ["string", "null"], "format": "uuid", 
"description": "Profile ID (public.profiles.id) of the user who last updated 
this record. Read-only.", "readOnly": true } }, "required": [ "code", 
"display_order", "is_active", "created_at", "updated_at" ], "primary_key": 
["id"], "unique_constraints": [ {"columns": ["code"], "name": 
"terrain_types_master_code_key"} -- ] } ``` 5\. Relationships & Integrity - 
This is a master data table. - Referenced by: - `public.trail_terrain_types` 
(junction table): `terrain_type_id` FK references `terrain_types_master.id` 
with `ON DELETE RESTRICT`. - `public.segments`: `dominant_terrain_type_id` FK 
references `terrain_types_master.id` with `ON DELETE SET NULL`. - 
`public.segment_additional_terrain_types` (junction table): `terrain_type_id` 
FK references `terrain_types_master.id` with `ON DELETE RESTRICT`. - `ON DELETE 
RESTRICT` on junction table FKs prevents deletion of a master type if actively 
used, ensuring data integrity. 6\. Multilingual Strategy - The `code` field is 
language-neutral. - User-facing display names (for "name") and descriptions 
(for "description") are managed in the central `public.translations` table. - 
Linkage: `translations.table_name = 'terrain_types_master'`, 
`translations.column_name = 'name'` (or 'description'), `translations.row_id = 
terrain_types_master.id`. 7\. Role-Based Workflow & RLS Notes - Content 
Management: Foundational master data, typically managed by Platform 
Administrators. - Workflow Fields: `created_at`, `updated_at`, 
`created_by_profile_id`, `updated_by_profile_id`, and `is_active` manage 
lifecycle and audit. - Note: The RLS policies outlined above rely on the 
existence and correct implementation of global RLS helper functions (e.g., 
public.has_role(TEXT) , public.is_platform_admin() , specific regional/trail 
management checks) that authenticate users and verify their roles stored in the 
public.profiles table." This reinforces that the table-specific RLS is part of 
a larger auth system. - RLS Policy Stubs: - Public Read Access: Publicly 
readable for active types. SQL ``` CREATE POLICY "Allow public read access to 
active terrain_types_master" ON public.terrain_types_master FOR SELECT USING 
(is_active = true); -- V2 Enhancement: Filter by is_active ``` - Admin Write 
Access: Restricted to privileged roles. SQL ``` CREATE POLICY "Allow admin full 
access on terrain_types_master" ON public.terrain_types_master FOR ALL USING 
(public.is_platform_admin()) -- Assumes helper function WITH CHECK 
(public.is_platform_admin()); -- ``` - Audit trigger 
`set_master_table_audit_meta` is `SECURITY DEFINER`. 8\. ENUM vs. Lookup 
Discussion - This table is a lookup table, replacing previous `TEXT[]` field 
approaches. - Advantages: Allows richer associated data (`icon_identifier`, 
`display_order`), easier i18n, and robust querying without schema changes for 
new types. 9\. UI/UX Enablement - `code`: Stable internal identifier. - 
`icon_identifier`: Informs UI which icon to display. - Translated 
names/descriptions from `public.translations` used for display. - 
`display_order`: Controls presentation order in UI elements. - `is_active`: 
Ensures only relevant, active types are shown in selection lists. 10\. Key 
Considerations & Definitions - `code` Uniqueness and Stability: `code` must be 
unique and stable (lowercase snake_case). - Icon System Dependency: 
`icon_identifier` relies on a frontend icon system. - Granularity: Define types 
at a meaningful level for users and admins. 11\. Scalability & Future-Proofing 
- Expected to have a relatively small number of rows, posing no scaling 
challenge. - Easily extensible by adding new rows or columns if more attributes 
are needed. 12\. Next-Action Checklist 1. 🔴 Implement DDL: Create the 
`public.terrain_types_master` table using the updated DDL, including the new 
`is_active`, `created_by_profile_id`, `updated_by_profile_id` columns, indexes, 
and the `set_master_table_audit_meta` trigger. 2. 🔴 Implement Orphaned 
Translation Cleanup Trigger: Add an `AFTER DELETE` trigger on 
`public.terrain_types_master` that calls 
`public.cleanup_related_translations('terrain_types_master', OLD.id)` for 
'name' and 'description' fields. 3. 🟠 Populate Initial Seed Data: Define and 
insert essential V1 seed rows for `terrain_types_master` (e.g., `code`, 
`icon_identifier`, `display_order`, `is_active`). Seed English `name` and 
`description` into `public.translations`. 4. 🟠 Implement RLS Policies & Helper 
Functions: Define, implement, and test RLS policies, including 
`public.is_platform_admin()`. 5. 🟠 Confirm Referencing Tables' FK Constraints: 
- Ensure `public.trail_terrain_types.terrain_type_id` references 
`public.terrain_types_master(id)` with `ON DELETE RESTRICT`. - Ensure 
`public.segments.dominant_terrain_type_id` references 
`public.terrain_types_master(id)` with `ON DELETE SET NULL`. - Ensure 
`public.segment_additional_terrain_types.terrain_type_id` references 
`public.terrain_types_master(id)` with `ON DELETE RESTRICT`. 6. 🟢 Application 
Logic for `is_active`: Ensure application logic (e.g., for populating admin UIs 
or selection dropdowns) filters for `is_active = true` when fetching terrain 
types for new associations. * * * * * 
