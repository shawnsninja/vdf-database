# 2.8 usage_types_master

  
https://gemini.google.com/u/1/app/9ed6b32c76b55d3a?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/8d62cfd96b565ac8 
https://gemini.google.com/u/1/app/2d30425fc8a5984a * * * * * ### Updated 
Production-Ready Specification Table Name: `public.usage_types_master` 1\. 
Purpose & Primary Use-Cases This table stores a canonical, centrally managed 
list of distinct permitted or common usage types for pilgrimage trails (e.g., 
"walking_only," "cycling_allowed_sections," "equestrian_friendly"). It provides 
structured, translatable data for consistent classification, clear 
communication to users, UI representation (icons, display names), and filtering 
capabilities across the platform. Key User-Story Touchpoints: - Pilgrim (Anna) 
- Story A1 (Route Exploration): Allows Anna to understand how a trail can be 
used and to filter trails based on usage types that match her intended 
activity. - Platform Administrator (Admin Team) - Story D1 (Managing Content): 
Admins manage the definitive list of usage types, ensuring clarity and 
consistency. - UI/UX: Provides structured data (`code`, `icon_identifier`, and 
link to translations) for clear and consistent display. 2\. Schema | Column 
Name | Data Type | Constraints | Description (Translatable fields via 
public.translations) | | `id` | `integer` | PRIMARY KEY, GENERATED ALWAYS AS 
IDENTITY | Unique identifier for each usage type. | | `code` | `text` | NOT 
NULL, UNIQUE, CHECK (`code` ~ '^[a-z0-9_]+$' AND char_length(`code`) &lt;= 50) 
| Machine-readable, stable code (e.g., "cycling_allowed_sections"). Not for 
direct display. | | `name` | `text` | | *Handled by `public.translations` 
table* (English base for reference if desired, but primary source is 
`translations`). | | `description` | `text` | | *Handled by 
`public.translations` table* (English base for reference if desired, but 
primary source is `translations`). | | `icon_identifier` | `text` | CHECK 
(`icon_identifier` IS NULL OR char_length(`icon_identifier`) &lt;= 100) | 
Identifier (e.g., CSS class, SVG name) for an icon. | | `notes` | `text` | | 
Internal administrative notes. Not typically for public display. | | 
`display_order` | `integer` | NOT NULL DEFAULT 0 | Optional order for 
displaying usage types in UI lists/filters. | | `is_active` | `boolean` | NOT 
NULL DEFAULT `true` | Flag to indicate if the usage type is active and 
available for use. | | `created_at` | `timestamptz` | NOT NULL DEFAULT `now()` 
| Timestamp of record creation. | | `created_by_profile_id` | `uuid` | 
REFERENCES `public.profiles(id)` ON DELETE SET NULL | Profile ID of the user 
who created this record. | | `updated_at` | `timestamptz` | NOT NULL DEFAULT 
`now()` | Timestamp of last update (auto-updated by trigger). | | 
`updated_by_profile_id` | `uuid` | REFERENCES `public.profiles(id)` ON DELETE 
SET NULL | Profile ID of the user who last updated this record. | 3\. 
PostgreSQL DDL SQL ``` -- This DDL assumes the 'public' schema is in use and 
'public.profiles' table exists. CREATE TABLE public.usage_types_master ( id 
INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY, -- code TEXT NOT NULL UNIQUE 
CHECK (code ~ '^[a-z0-9_]+$' AND char_length(code) <= 50), -- icon_identifier 
TEXT CHECK (icon_identifier IS NULL OR char_length(icon_identifier) <= 100), -- 
notes TEXT, -- display_order INTEGER NOT NULL DEFAULT 0, -- is_active BOOLEAN 
NOT NULL DEFAULT true, -- V2 Enhancement created_at TIMESTAMPTZ NOT NULL 
DEFAULT now(), -- created_by_profile_id UUID REFERENCES public.profiles(id) ON 
DELETE SET NULL, -- V2 Enhancement updated_at TIMESTAMPTZ NOT NULL DEFAULT 
now(), -- updated_by_profile_id UUID REFERENCES public.profiles(id) ON DELETE 
SET NULL -- V2 Enhancement ); -- Indexes CREATE INDEX IF NOT EXISTS 
idx_usage_types_master_code ON public.usage_types_master(code); -- CREATE INDEX 
IF NOT EXISTS idx_usage_types_master_display_order ON 
public.usage_types_master(display_order); -- CREATE INDEX IF NOT EXISTS 
idx_usage_types_master_is_active ON public.usage_types_master(is_active); -- V2 
Enhancement -- Trigger for audit columns (created_by_profile_id, updated_at, 
updated_by_profile_id) -- Reusing the generic master table audit trigger 
function defined for terrain_types_master -- Ensure 
'public.set_master_table_audit_meta()' is defined as: -- CREATE OR REPLACE 
FUNCTION public.set_master_table_audit_meta() -- RETURNS TRIGGER AS $$ -- BEGIN 
-- NEW.updated_at = NOW(); -- IF (TG_OP = 'INSERT') THEN -- IF 
NEW.created_by_profile_id IS NULL THEN -- NEW.created_by_profile_id := 
auth.uid(); -- END IF; -- IF NEW.updated_by_profile_id IS NULL THEN -- 
NEW.updated_by_profile_id := auth.uid(); -- END IF; -- ELSIF (TG_OP = 'UPDATE') 
THEN -- NEW.updated_by_profile_id = auth.uid(); -- NEW.created_at = 
OLD.created_at; -- NEW.created_by_profile_id = OLD.created_by_profile_id; -- 
END IF; -- RETURN NEW; -- END; -- $$ LANGUAGE plpgsql SECURITY DEFINER; CREATE 
TRIGGER trigger_usage_types_master_audit_meta BEFORE INSERT OR UPDATE ON 
public.usage_types_master FOR EACH ROW EXECUTE FUNCTION 
public.set_master_table_audit_meta(); -- Using the same generic trigger -- 
Comments COMMENT ON TABLE public.usage_types_master IS 'Master list of distinct 
permitted or common usage types for trails (e.g., walking_only, 
cycling_allowed_sections). Provides canonical definitions. Version: V2.'; -- 
COMMENT ON COLUMN public.usage_types_master.id IS 'Unique identifier for the 
usage type. Version: V2.'; -- COMMENT ON COLUMN public.usage_types_master.code 
IS 'A machine-readable, stable code for the usage type (e.g., 
"cycling_allowed_sections"). Used for internal referencing and linking, not for 
direct public display. Should be lowercase with underscores. Version: V2.'; -- 
COMMENT ON COLUMN public.usage_types_master.icon_identifier IS 'Identifier 
(e.g., CSS class name, SVG file name) for an icon representing this usage type. 
Version: V2.'; -- COMMENT ON COLUMN public.usage_types_master.notes IS 
'Internal administrative notes about this usage type, its definition, or 
intended application. Not typically for public display. Version: V2.'; -- 
COMMENT ON COLUMN public.usage_types_master.display_order IS 'Optional: an 
integer value to control the order in which usage types are presented in 
administrative interfaces or user-facing selection lists/filters. Version: 
V2.'; -- COMMENT ON COLUMN public.usage_types_master.is_active IS 'Flag to 
indicate if the usage type is active and available for new associations. 
Default true. Version: V2.'; COMMENT ON COLUMN 
public.usage_types_master.created_at IS 'Timestamp of when the usage type 
record was created. Version: V2.'; -- COMMENT ON COLUMN 
public.usage_types_master.created_by_profile_id IS 'Profile ID of the user who 
created this usage type record. Version: V2.'; COMMENT ON COLUMN 
public.usage_types_master.updated_at IS 'Timestamp of when the usage type 
record was last updated. Auto-updated by trigger. Version: V2.'; -- COMMENT ON 
COLUMN public.usage_types_master.updated_by_profile_id IS 'Profile ID of the 
user who last updated this usage type record. Version: V2.'; ``` 4\. JSON 
Schema Mirror JSON ``` { "title": "usage_type_master", "description": "Master 
list of distinct permitted or common usage types for trails. Version: V2.", 
"type": "object", "properties": { "id": { "type": "integer", "format": "int32", 
"description": "Unique identifier for the usage type. Read-only.", "readOnly": 
true }, "code": { "type": "string", "maxLength": 50, "pattern": "^[a-z0-9_]+$", 
"description": "A machine-readable, stable code (e.g., 
\"cycling_allowed_sections\"). Not for direct public display. Must be unique." 
}, "icon_identifier": { "type": ["string", "null"], "maxLength": 100, 
"description": "Identifier (e.g., CSS class name, file name) for an icon 
representing this usage type." }, "notes": { "type": ["string", "null"], 
"description": "Internal administrative notes about this usage type." }, 
"display_order": { "type": "integer", "default": 0, "description": "Optional: 
an order for displaying usage types in admin UIs or selection lists." }, 
"is_active": { "type": "boolean", "default": true, "description": "Flag to 
indicate if the usage type is active and available for use." }, "created_at": { 
"type": "string", "format": "date-time", "description": "Timestamp of record 
creation. Read-only.", "readOnly": true }, "created_by_profile_id": { "type": 
["string", "null"], "format": "uuid", "description": "Profile ID 
(public.profiles.id) of the user who created this record. Read-only.", 
"readOnly": true }, "updated_at": { "type": "string", "format": "date-time", 
"description": "Timestamp of last update. Read-only.", "readOnly": true }, 
"updated_by_profile_id": { "type": ["string", "null"], "format": "uuid", 
"description": "Profile ID (public.profiles.id) of the user who last updated 
this record. Read-only.", "readOnly": true } }, "required": [ "code", 
"display_order", "is_active", "created_at", "updated_at" ], "primary_key": 
["id"], "unique_constraints": [ {"columns": ["code"], "name": 
"usage_types_master_code_key"} ] } ``` 5\. Relationships & Integrity - This is 
a master data table. - Referenced by `public.trail_usage_types` (junction 
table): `usage_type_id` FK references `usage_types_master.id` with `ON DELETE 
RESTRICT`. This prevents deletion of a master type if actively used. 6\. 
Multilingual Strategy - The `code` field is language-neutral. - User-facing 
display "name" and "description" are managed in the central 
`public.translations` table, keyed by `table_name='usage_types_master'`, 
`column_name` ('name' or 'description'), and `row_id=usage_types_master.id`. 
7\. Role-Based Workflow & RLS Notes - Content Management: Foundational master 
data, typically managed by Platform Administrators. - Workflow Fields: 
`created_at`, `updated_at`, `created_by_profile_id`, `updated_by_profile_id`, 
and `is_active` manage lifecycle and audit. - Note: The RLS policies outlined 
above rely on the existence and correct implementation of global RLS helper 
functions (e.g., public.has_role(TEXT) , public.is_platform_admin() , specific 
regional/trail management checks) that authenticate users and verify their 
roles stored in the public.profiles table." This reinforces that the 
table-specific RLS is part of a larger auth system. - RLS Policy Stubs: - 
Public Read Access: Publicly readable for active types. SQL ``` CREATE POLICY 
"Allow public read access to active usage_types_master" ON 
public.usage_types_master FOR SELECT USING (is_active = true); -- V2 
Enhancement ``` - Admin Write Access: Restricted to privileged roles. SQL ``` 
CREATE POLICY "Allow admin full access on usage_types_master" ON 
public.usage_types_master FOR ALL USING (public.is_platform_admin()) -- Assumes 
helper function WITH CHECK (public.is_platform_admin()); -- ``` - Audit trigger 
`set_master_table_audit_meta` (or equivalent) is `SECURITY DEFINER`. 8\. ENUM 
vs. Lookup Discussion - This table is a lookup table, replacing the old 
`trails.permitted_uses TEXT[]` field. - Advantages: Allows richer associated 
data (`icon_identifier`, `notes`), easier i18n, and robust querying without 
schema changes for new types. 9\. UI/UX Enablement - `code`: Stable internal 
identifier. - `icon_identifier`: Informs UI which icon to display. - Translated 
names/descriptions from `public.translations` used for display. - 
`display_order`: Controls presentation order in UI. - `is_active`: Ensures only 
relevant types are shown in selection lists. 10\. Key Considerations & 
Definitions - `code` Uniqueness and Stability: `code` must be unique and stable 
(lowercase snake_case). - Icon System Dependency: `icon_identifier` relies on a 
frontend icon system. - Granularity: Define types at a meaningful level. 11\. 
Scalability & Future-Proofing - Expected to have a relatively small number of 
rows. - Easily extensible by adding new rows or columns. 12\. Next-Action 
Checklist 1. 🔴 Implement DDL: Create the `public.usage_types_master` table 
using the updated DDL, including the new `is_active`, `created_by_profile_id`, 
`updated_by_profile_id` columns, indexes, and the audit trigger (e.g., 
`set_master_table_audit_meta`). 2. 🔴 Implement Orphaned Translation Cleanup 
Trigger: Add an `AFTER DELETE` trigger on `public.usage_types_master` that 
calls `public.cleanup_related_translations('usage_types_master', OLD.id)` for 
'name' and 'description' fields. 3. 🟠 Define and Populate Initial Seed Data: 
Define essential V1 seed rows for `usage_types_master` (e.g., `code`, 
`icon_identifier`, `display_order`, `is_active`). Seed English `name` and 
`description` into `public.translations`. 4. 🟠 Implement RLS Policies & Helper 
Functions: Define, implement, and test RLS policies, including 
`public.is_platform_admin()`. 5. 🟠 Confirm Referencing Tables: Ensure 
`public.trail_usage_types.usage_type_id` correctly references this table with 
`ON DELETE RESTRICT`. 6. 🟢 Application Logic for `is_active`: Ensure 
application logic (e.g., for populating admin UIs or selection dropdowns) 
filters for `is_active = true` when fetching usage types for new associations. 
* * * * * 
