# 4d.0.3 - Security & Authentication Architecture Specificationcument

  https://gemini.google.com/u/1/app/0e3ccfac5f6b71bb SQL ``` CREATE OR REPLACE 
VIEW public.event_details_enriched_view AS SELECT ed.waypoint_id, -- Core 
Waypoint Information (example fields from waypoints, assuming these exist) 
wp.default_name AS waypoint_default_name, -- Assuming 'default_name' on 
waypoints is the primary language name wp.latitude AS waypoint_latitude, 
wp.longitude AS waypoint_longitude, csm_wp.code AS 
waypoint_visibility_status_code, -- Code for 'published', 'draft', etc. -- 
Event Details (from events_details and joined master tables) 
ed.default_event_name_official, etm.default_name AS event_type_name, etm.code 
AS event_type_code, etm.icon_identifier AS event_type_icon_identifier, 
ed.event_theme_or_focus_tag_ids, -- Application layer can resolve these IDs to 
names from tags_master ed.default_description_long, ed.start_datetime, 
ed.end_datetime, ed.is_recurring_event, erfm.default_name AS 
recurrence_frequency_name, erfm.code AS recurrence_frequency_code, 
ed.default_recurrence_detail_text, edclm.default_name AS 
date_certainty_level_name, edclm.code AS date_certainty_level_code, 
edclm.default_advice AS date_certainty_level_advice, ed.exception_dates, 
ed.default_specific_next_occurrence_dates_text, ed.default_organizer_name, 
ed.event_website_or_social_media_url, ed.contact_phone_event, 
ed.contact_email_event, ed.default_entry_fee_or_ticket_info, 
ed.default_location_details_within_waypoint, easm.default_name AS 
attendance_scale_name, easm.code AS attendance_scale_code, 
easm.approximate_range AS attendance_scale_approximate_range, 
ed.default_impact_on_accommodation_notes, 
ed.default_impact_on_trail_access_notes, 
ed.default_impact_on_local_services_notes, 
ed.default_general_impact_notes_for_pilgrims, 
ed.default_pilgrim_participation_info, -- Related Attraction (if any) 
ed.related_attraction_waypoint_id, related_wp.default_name AS 
related_attraction_waypoint_name, -- Name of the related waypoint -- Data 
Verification ed.data_last_verified_at, verifier_profile.public_display_name AS 
data_verified_by_user_display_name, -- Audit Timestamps for Event Details 
record itself ed.created_at AS event_detail_created_at, ed.updated_at AS 
event_detail_updated_at, ed.deleted_at AS event_detail_deleted_at, -- Included 
for completeness, though view filters it out by default -- Audit User 
Information (Display Names) creator_profile.public_display_name AS 
created_by_user_display_name, updater_profile.public_display_name AS 
updated_by_user_display_name, -- Raw Foreign Keys for further lookups if needed 
by application ed.event_type_id, ed.recurrence_frequency_id, 
ed.future_date_estimation_level_id, ed.expected_attendance_scale_id, 
ed.created_by_profile_id, ed.updated_by_profile_id, 
ed.data_verified_by_profile_id FROM public.events_details ed JOIN 
public.waypoints wp ON ed.waypoint_id = wp.id LEFT JOIN 
public.content_statuses_master csm_wp ON wp.content_visibility_status_id = 
csm_wp.id AND csm_wp.is_active = true -- Assuming content_statuses_master has 
an is_active flag LEFT JOIN public.event_types_master etm ON ed.event_type_id = 
etm.id AND etm.is_active = true -- Ensure joined master records are active LEFT 
JOIN public.event_recurrence_frequencies_master erfm ON 
ed.recurrence_frequency_id = erfm.id AND erfm.is_active = true -- Ensure joined 
master records are active LEFT JOIN public.event_date_certainty_levels_master 
edclm ON ed.future_date_estimation_level_id = edclm.id AND edclm.is_active = 
true -- Ensure joined master records are active LEFT JOIN 
public.event_attendance_scales_master easm ON ed.expected_attendance_scale_id = 
easm.id AND easm.is_active = true -- Ensure joined master records are active 
LEFT JOIN public.profiles creator_profile ON ed.created_by_profile_id = 
creator_profile.id LEFT JOIN public.profiles updater_profile ON 
ed.updated_by_profile_id = updater_profile.id LEFT JOIN public.profiles 
verifier_profile ON ed.data_verified_by_profile_id = verifier_profile.id LEFT 
JOIN public.waypoints related_wp ON ed.related_attraction_waypoint_id = 
related_wp.id -- For the name of the related attraction waypoint WHERE 
ed.deleted_at IS NULL; -- Typically, views show non-deleted records by default 
COMMENT ON VIEW public.event_details_enriched_view IS 'Provides a 
comprehensive, denormalized view of event details (Version 1.0). It enriches 
event data with human-readable names from related master tables (event types, 
recurrence frequencies, date certainty levels, attendance scales) and includes 
basic information from the parent waypoint (name, visibility status) and linked 
profiles (creator, updater, verifier). The view displays active, non-deleted 
event details. RLS from underlying tables apply.'; ``` Key features and 
considerations for this view: 1. Denormalization: It joins `events_details` 
with `waypoints`, all the event-specific master tables, and `profiles` to 
provide related information in a single source, simplifying client-side 
queries. 2. Primary Language Content: Shows `default_name` (and similar 
`default_...` fields) from `events_details` and its master tables, representing 
content in the primary reference language. The application layer remains 
responsible for fetching translations from `public.translations`. 3. Master 
Table Activity: It explicitly joins with `is_active = true` for all master 
tables to ensure that the descriptive names come from currently active master 
records. 4. Profile Information: Includes `public_display_name` from the 
`profiles` table for users who created, updated, or verified the event details. 
5. Waypoint Information: Includes basic information from the parent `waypoints` 
table like its default name and visibility status code. *This assumes 
`waypoints.default_name` and `waypoints.content_visibility_status_id` (linking 
to `content_statuses_master.id` which has a `code`) exist and that 
`content_statuses_master` has an `is_active` flag. Adjust joins as needed based 
on the final `waypoints` schema.* 6. Filtering: The `WHERE ed.deleted_at IS 
NULL` clause ensures that soft-deleted event details are not included by 
default. 7. RLS (Row-Level Security): - This view is defined as `SECURITY 
INVOKER` by default (not explicitly stated, but this is PostgreSQL's default). 
This means that RLS policies on the underlying tables (`events_details`, 
`waypoints`, `profiles`, etc.) will be applied based on the querying user's 
permissions. - The RLS policy already defined on `public.events_details` (which 
checks the parent waypoint's publication status) will effectively control which 
rows are visible through this view. 8. Tag Names: 
`event_theme_or_focus_tag_ids` are included. Displaying tag names would require 
further unnesting or array aggregation logic, which can be complex in a view 
and might be better handled at the application layer or in a dedicated 
function/procedure if needed. 9. Clarity in Naming: Aliases are used for 
columns from joined tables to avoid ambiguity and provide clarity (e.g., 
`event_type_name`, `waypoint_default_name`). This view should serve as a good 
starting point for many common queries related to displaying event information. 
