# 4.21 event_types_master

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/0e3ccfac5f6b71bb ### Updated Production-Ready 
Specification: `public.event_types_master` Version: 1.1 Date: May 18, 2025 #### 
1\. Purpose & Primary Use-Cases The `event_types_master` table defines the 
various categories or types of events that can occur (e.g., "Religious Feast 
Day," "Cultural Festival," "Local Market"). Its purpose is to provide a 
standardized, translatable classification for events, which helps in filtering, 
UI display (icons), and overall data consistency. Key user-story touchpoints 
include pilgrims filtering events by type, understanding event nature, admins 
categorizing events, and the system populating filters and icons. #### 2\. 
Schema | column | data_type | constraints | description | | `id` | `INTEGER` | 
`Primary Key, Generated always as identity` | Unique identifier for the event 
type. | | `code` | `TEXT` | `Unique, Not Null, CHECK (length(code) > 0 AND 
length(code) <= 50 AND code ~ '^[a-z0-9_]+$')` | Short, stable, 
machine-readable code (e.g., 'religious_feast', 'cultural_festival'). 
Snake_case. | | `default_name` | `TEXT` | `Not Null, CHECK 
(length(default_name) > 0 AND length(default_name) <= 100)` | Human-readable 
name in the primary reference language. (Translatable via 
`public.translations`) | | `default_description` | `TEXT` | `Nullable` | 
Optional description in the primary reference language of the event type. 
(Translatable via `public.translations`) | | `icon_identifier` | `TEXT` | 
`Nullable, CHECK (icon_identifier IS NULL OR length(icon_identifier) <= 100)` | 
Name, class, or path for a UI icon associated with this event type. | | 
`sort_order` | `INTEGER` | `Not Null, Default 0` | Determines the display order 
in UI lists or filters. | | `is_active` | `BOOLEAN` | `Not Null, Default true` 
| If true, this event type is active and can be used. | | `created_at` | 
`TIMESTAMPTZ` | `Not Null, Default now()` | Timestamp of record creation. | | 
`updated_at` | `TIMESTAMPTZ` | `Not Null, Default now()` | Timestamp of last 
update (auto-updated by trigger). | | `created_by_profile_id` | `UUID` | 
`Nullable, Foreign Key to public.profiles(id) ON DELETE SET NULL` | Profile ID 
of the user who created this record. | | `updated_by_profile_id` | `UUID` | 
`Nullable, Foreign Key to public.profiles(id) ON DELETE SET NULL` | Profile ID 
of the user who last updated this record. | #### 3\. PostgreSQL DDL SQL ``` 
CREATE TABLE public.event_types_master ( id INTEGER GENERATED ALWAYS AS 
IDENTITY PRIMARY KEY, code TEXT UNIQUE NOT NULL CHECK (length(code) > 0 AND 
length(code) <= 50 AND code ~ '^[a-z0-9_]+$'), default_name TEXT NOT NULL CHECK 
(length(default_name) > 0 AND length(default_name) <= 100), default_description 
TEXT NULL, icon_identifier TEXT NULL CHECK (icon_identifier IS NULL OR 
length(icon_identifier) <= 100), sort_order INTEGER NOT NULL DEFAULT 0, 
is_active BOOLEAN NOT NULL DEFAULT true, created_at TIMESTAMPTZ NOT NULL 
DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), 
created_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE SET 
NULL, updated_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE 
SET NULL ); COMMENT ON TABLE public.event_types_master IS 'Master list of event 
types (e.g., festival, market, religious celebration). Replaces 
event_type_enum. Version 1.1'; COMMENT ON COLUMN public.event_types_master.id 
IS 'Unique identifier for the event type. Primary Key.'; COMMENT ON COLUMN 
public.event_types_master.code IS 'Short, stable, machine-readable code 
(snake_case). Max 50 chars. Must be unique.'; COMMENT ON COLUMN 
public.event_types_master.default_name IS 'Human-readable name in the primary 
reference language for UI. (Translatable via public.translations). Max 100 
chars.'; COMMENT ON COLUMN public.event_types_master.default_description IS 
'Optional description in the primary reference language of the event type. 
(Translatable via public.translations).'; COMMENT ON COLUMN 
public.event_types_master.icon_identifier IS 'Name, class, or path for a UI 
icon. Max 100 chars.'; COMMENT ON COLUMN public.event_types_master.sort_order 
IS 'Determines the display order in UI lists or filters.'; COMMENT ON COLUMN 
public.event_types_master.is_active IS 'If true, this event type is active and 
can be used.'; COMMENT ON COLUMN public.event_types_master.created_at IS 
'Timestamp of record creation.'; COMMENT ON COLUMN 
public.event_types_master.updated_at IS 'Timestamp of last update (auto-updated 
by trigger).'; COMMENT ON COLUMN 
public.event_types_master.created_by_profile_id IS 'Profile ID of the user who 
created this record. FK to public.profiles(id).'; COMMENT ON COLUMN 
public.event_types_master.updated_by_profile_id IS 'Profile ID of the user who 
last updated this record. FK to public.profiles(id).'; -- Indexes CREATE INDEX 
ix_event_types_master_active_sort ON public.event_types_master (is_active, 
sort_order); CREATE INDEX ix_event_types_master_created_by ON 
public.event_types_master (created_by_profile_id) WHERE created_by_profile_id 
IS NOT NULL; CREATE INDEX ix_event_types_master_updated_by ON 
public.event_types_master (updated_by_profile_id) WHERE updated_by_profile_id 
IS NOT NULL; ``` #### 4\. Triggers/Functions SQL ``` -- Standard updated_at 
trigger (e.g., using extensions.moddatetime or a custom function) CREATE 
TRIGGER handle_event_types_master_updated_at BEFORE UPDATE ON 
public.event_types_master FOR EACH ROW EXECUTE FUNCTION 
extensions.moddatetime('updated_at'); -- Or 
public.set_current_timestamp_updated_at() COMMENT ON TRIGGER 
handle_event_types_master_updated_at ON public.event_types_master IS 'Trigger 
to automatically update updated_at timestamp on row modification.'; -- Orphaned 
translation cleanup trigger CREATE OR REPLACE FUNCTION 
public.cleanup_event_types_master_translations() RETURNS TRIGGER AS $$ BEGIN 
DELETE FROM public.translations WHERE table_identifier = 'event_types_master' 
AND column_identifier IN ('default_name', 'default_description') -- Specify 
translatable columns AND row_foreign_key = OLD.id::TEXT; RETURN OLD; END; $$ 
LANGUAGE plpgsql SECURITY DEFINER; COMMENT ON FUNCTION 
public.cleanup_event_types_master_translations() IS 'Cleans up orphaned 
translations from public.translations when an event_types_master record is 
deleted. Runs as SECURITY DEFINER. Ensure appropriate search_path if not using 
fully qualified names.'; CREATE TRIGGER 
trigger_cleanup_event_types_master_translations AFTER DELETE ON 
public.event_types_master FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_event_types_master_translations(); COMMENT ON TRIGGER 
trigger_cleanup_event_types_master_translations ON public.event_types_master IS 
'After deleting an event type, remove its associated translations from the 
public.translations table.'; ``` *(Assumption: `extensions.moddatetime` is 
available or `public.set_current_timestamp_updated_at()` is defined as per 
project standards and `public.translations` table exists).* #### 5\. JSON 
Schema Mirror JSON ``` { "title": "event_type_master", "description": "Master 
list of event types (e.g., festival, market, religious celebration). Replaces 
event_type_enum. Version 1.1.", "type": "object", "properties": { "id": { 
"type": "integer", "description": "Unique identifier. Primary Key.", 
"readOnly": true }, "code": { "type": "string", "description": "Short, stable, 
machine-readable code (snake_case). Max 50 chars. Must be unique.", "pattern": 
"^[a-z0-9_]+$", "maxLength": 50 }, "default_name": { "type": "string", 
"description": "Human-readable name in the primary reference language for UI. 
(Translatable via public.translations). Max 100 chars.", "maxLength": 100 }, 
"default_description": { "type": ["string", "null"], "description": "Optional 
description in the primary reference language of the event type. (Translatable 
via public.translations)." }, "icon_identifier": { "type": ["string", "null"], 
"maxLength": 100, "description": "Name, class, or path for a UI icon." }, 
"sort_order": { "type": "integer", "default": 0, "description": "Determines the 
display order in UI lists or filters." }, "is_active": { "type": "boolean", 
"default": true, "description": "If true, this event type is active and can be 
used." }, "created_at": { "type": "string", "format": "date-time", 
"description": "Timestamp of record creation.", "readOnly": true }, 
"updated_at": { "type": "string", "format": "date-time", "description": 
"Timestamp of last update (auto-updated by trigger).", "readOnly": true }, 
"created_by_profile_id": { "type": ["string", "null"], "format": "uuid", 
"description": "Profile ID of the user who created this record. FK to 
public.profiles(id)." }, "updated_by_profile_id": { "type": ["string", "null"], 
"format": "uuid", "description": "Profile ID of the user who last updated this 
record. FK to public.profiles(id)." } }, "required": [ "code", "default_name", 
"sort_order", "is_active" ], "primary_key": ["id"], "unique_constraints": [ 
{"columns": ["code"], "name": "event_types_master_code_key"} ], "foreign_keys": 
[ {"columns": ["created_by_profile_id"], "references_table": "public.profiles", 
"references_columns": ["id"], "on_delete": "SET NULL"}, {"columns": 
["updated_by_profile_id"], "references_table": "public.profiles", 
"references_columns": ["id"], "on_delete": "SET NULL"} ] } ``` #### 6\. 
Relationships & Integrity - Primary Key: `id` (INTEGER) - Unique Constraint: 
`code` must be unique. - Foreign Key References FROM other tables: - 
`events_details.event_type_id` will reference `event_types_master.id` (ON 
DELETE RESTRICT recommended, to prevent deleting a type if it's in use). - 
Array Foreign Key: None in this table. #### 7\. Multilingual Strategy - 
`default_name`: Name in the primary reference language. (Translatable via 
`public.translations`) - `default_description`: Description in the primary 
reference language. (Translatable via `public.translations`) - An `AFTER 
DELETE` trigger on this table 
(`trigger_cleanup_event_types_master_translations`) ensures orphaned 
translations are removed from `public.translations`. #### 8\. Role-Based 
Workflow & RLS Notes - Key Fields: `is_active` for lifecycle management. - RLS 
Policies: - 🟢 Allow public read access to all active event types. SQL ``` 
CREATE POLICY "Allow public read access to active event types" ON 
public.event_types_master FOR SELECT USING (is_active = true); ``` - 🟢 Allow 
authenticated users with 'admin_platform' or 'admin_super' roles to manage all 
event types. SQL ``` CREATE POLICY "Allow platform admins to manage event 
types" ON public.event_types_master FOR ALL USING ( auth.role() = 
'authenticated' AND (SELECT public.has_role_on_profile(auth.uid(), 
'admin_platform') OR public.has_role_on_profile(auth.uid(), 'admin_super')) ) 
WITH CHECK ( auth.role() = 'authenticated' AND (SELECT 
public.has_role_on_profile(auth.uid(), 'admin_platform') OR 
public.has_role_on_profile(auth.uid(), 'admin_super')) ); ``` - 🟠 `ON DELETE 
RESTRICT` from `events_details` will prevent deletion if an event type is in 
use. Deactivation via `is_active = false` is the preferred method for retiring 
types. #### 9\. ENUM vs Lookup Discussion - 🟢 Decision: This table 
`event_types_master` *is* the result of promoting the original 
`event_type_enum`. - Reason: Essential for categorizing diverse events. Allows 
translatable names, descriptive text, icon association, and logical sorting for 
UI, providing a much richer and more maintainable system than a simple ENUM. 
#### 10\. UI/UX Enablement - `default_name` (translated): For filter labels, 
event type display. - `icon_identifier`: Drives map icons for event waypoints 
or icons in event listings. - `sort_order`: Ensures logical presentation in 
filters. - `default_description` (translated): Can provide tooltips or further 
context about what an event type entails. - `is_active`: Used to filter types 
available in selection UIs for content managers. #### 11\. Auditing & Lifecycle 
Management - Audit Columns: `created_at`, `updated_at` (auto-managed by trigger 
`handle_event_types_master_updated_at`). `created_by_profile_id`, 
`updated_by_profile_id` for admin change tracking. - Lifecycle: `is_active` 
flag manages whether the event type is available for use. #### 12\. Scalability 
& Future-Proofing - Lookup Table Structure: Easily supports adding new event 
types or modifying attributes. - Manageable List: The number of distinct event 
types is expected to be moderate and stable. #### 13\. Seed Data (V1.1) | code 
| default_name | default_description | icon_identifier | sort_order | is_active 
| created_by_profile_id | updated_by_profile_id | | 
'religious_feast_day_procession' | 'Religious Feast/Procession' | 'Celebrations 
related to religious feast days, often including processions.' | 
'icon-event-religious' | 10 | true | `[ADMIN_UUID]` | `[ADMIN_UUID]` | | 
'local_saint_patron_festival' | 'Local Saint/Patron Festival' | 'Festivals 
honoring a local patron saint.' | 'icon-event-saint' | 20 | true | 
`[ADMIN_UUID]` | `[ADMIN_UUID]` | | 'cultural_historical_festival' | 
'Cultural/Historical Festival' | 'Events celebrating local culture, history, or 
traditions (e.g., medieval reenactments).' | 'icon-event-cultural' | 30 | true 
| `[ADMIN_UUID]` | `[ADMIN_UUID]` | | 'music_arts_festival' | 'Music/Arts 
Festival' | 'Festivals focused on music, visual arts, or performing arts.' | 
'icon-event-music-arts' | 40 | true | `[ADMIN_UUID]` | `[ADMIN_UUID]` | | 
'food_wine_sagra' | 'Food/Wine Festival (Sagra)' | 'Local festivals celebrating 
specific foods, wines, or agricultural products.' | 'icon-event-sagra' | 50 | 
true | `[ADMIN_UUID]` | `[ADMIN_UUID]` | | 'weekly_market' | 'Weekly Market' | 
'Regularly scheduled weekly markets for general goods or produce.' | 
'icon-event-market-weekly' | 60 | true | `[ADMIN_UUID]` | `[ADMIN_UUID]` | | 
'monthly_antiques_market' | 'Monthly Antiques/Craft Market' | 'Markets 
occurring monthly, often focused on antiques, crafts, or collectibles.' | 
'icon-event-market-monthly' | 70 | true | `[ADMIN_UUID]` | `[ADMIN_UUID]` | | 
'sporting_event_local' | 'Local Sporting Event' | 'Community sporting events or 
competitions.' | 'icon-event-sport' | 80 | true | `[ADMIN_UUID]` | 
`[ADMIN_UUID]` | | 'pilgrimage_specific_gathering' | 'Pilgrimage Specific 
Gathering' | 'Events or gatherings specifically for or by pilgrims.' | 
'icon-event-pilgrimage' | 90 | true | `[ADMIN_UUID]` | `[ADMIN_UUID]` | | 
'conference_workshop' | 'Conference/Workshop' | 'Formal gatherings for specific 
topics, if relevant to pilgrims.' | 'icon-event-conference' | 100 | true | 
`[ADMIN_UUID]` | `[ADMIN_UUID]` | | 'public_holiday_observance' | 'Public 
Holiday Observance' | 'General public holiday observances that might impact 
services or attract crowds.' | 'icon-event-holiday' | 110 | true | 
`[ADMIN_UUID]` | `[ADMIN_UUID]` | | 'exhibition_art_craft' | 'Exhibition 
(Art/Craft)' | 'Temporary displays of art, crafts, or other items of interest.' 
| 'icon-event-exhibition' | 120 | true | `[ADMIN_UUID]` | `[ADMIN_UUID]` | | 
'other_event' | 'Other Event' | 'Miscellaneous events not fitting other 
categories.' | 'icon-event-other' | 900 | true | `[ADMIN_UUID]` | 
`[ADMIN_UUID]` | *(Note: `[ADMIN_UUID]` is a placeholder for an actual 
admin/system user profile ID used for seeding.)* #### 14\. Next-Action 
Checklist - 🔴 Create Table: Execute the DDL for `public.event_types_master`. - 
🔴 Create Indexes: Execute DDL for `ix_event_types_master_active_sort`, 
`ix_event_types_master_created_by`, `ix_event_types_master_updated_by`. - 🔴 
Implement `updated_at` Trigger: Ensure `extensions.moddatetime` or equivalent 
`public.set_current_timestamp_updated_at()` is available and create 
`handle_event_types_master_updated_at` trigger. - 🔴 Implement Orphan 
Translation Cleanup Trigger: Create 
`public.cleanup_event_types_master_translations()` function and apply 
`trigger_cleanup_event_types_master_translations` (AFTER `public.translations` 
table exists). Ensure `SECURITY DEFINER` functions have hardened `search_path`. 
- 🔴 RLS Policies: Review and apply defined RLS policies. Ensure 
`public.has_role_on_profile` helper function exists. - 🔴 Seed Data: Insert 
initial V1.1 data. - 🟢 Iconography: Define `icon_identifier` convention/source 
and prepare assets. - 🟢 Population Logic: Define how `created_by_profile_id` 
and `updated_by_profile_id` will be populated by the application layer during 
admin operations. 
