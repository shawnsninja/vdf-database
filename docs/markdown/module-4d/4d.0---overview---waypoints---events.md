# 4d.0 - overview - waypoints - events

  https://gemini.google.com/u/1/app/cd801fb8de131fa6 
https://gemini.google.com/u/1/app/0e3ccfac5f6b71bb ### Updated Module Overview: 
4d. Waypoint - Events Version: 1.1 (reflecting V2.1 checklist application and 
i18n corrections) Date: May 18, 2025 This document provides a master recap and 
architecture overview for the "4d. Waypoint - Events" database module of the 
pilgrimage-platform. It details how tables, translation mechanisms, security 
policies, API considerations, and other database objects interlock, along with 
a recommended build order for successful deployment. #### 1\. Executive Summary 
This database module provides a robust framework for managing detailed 
information about events associated with pilgrimage waypoints. It enables 
pilgrims to discover and plan around local festivals, markets, and other 
happenings, while empowering content managers to curate and maintain accurate 
event data using standardized classifications and audit trails, thereby 
enriching the overall pilgrimage experience. All translatable text fields store 
their primary reference language content directly, with other language versions 
managed in the central `public.translations` table. #### 2\. Group-Level 
Snapshot | Group | Key Tables | Primary Purpose | Top Inter-Group Links | | 4d. 
Waypoint - Events | `events_details` (v1.3), `event_types_master` (v1.1), 
`event_recurrence_frequencies_master` (v1.1), `event_attendance_scales_master` 
(v1.1), `event_date_certainty_levels_master` (v1.1) | Stores comprehensive 
details for events linked to waypoints, including their classification, timing, 
scale, and data verification. | `waypoints` (Module 4a - Core Waypoint Info), 
`profiles` (Module 1 - User Info), `tags_master` (Module 4a - Shared Tags), 
`public.translations` (Module 1) | * * * * * #### 3\. Narrative Walkthrough The 
"4d. Waypoint - Events" group centralizes all event-specific information. - 
`event_types_master` (v1.1): Defines the various categories of events (e.g., 
"Religious Feast Day," "Local Market"). Its primary key is an auto-generated 
`id` (INTEGER). It includes `code`, `default_name`, `default_description`, 
`icon_identifier`, `sort_order`, `is_active`, and standard audit columns. - 
`event_recurrence_frequencies_master` (v1.1): Standardizes terms for how often 
recurring events occur (e.g., "Annually," "Weekly"). Its primary key is an 
auto-generated `id` (INTEGER). It includes `code`, `default_name`, 
`default_description`, `sort_order`, `is_active`, and standard audit columns. - 
`event_attendance_scales_master` (v1.1): Categorizes events by expected 
attendance size (e.g., "Small - Local," "Large - National"). Its primary key is 
an auto-generated `id` (INTEGER). It includes `code`, `default_name`, 
`default_description`, `approximate_range`, `sort_order`, `is_active`, and 
standard audit columns. - `event_date_certainty_levels_master` (v1.1): 
Specifies the confidence level for future dates of recurring events (e.g., 
"Confirmed," "Pattern-Based Estimate"). Its primary key is an auto-generated 
`id` (INTEGER). It includes `code`, `default_name`, `default_description`, 
`default_advice`, `sort_order`, `is_active`, and standard audit columns. - 
`events_details` (v1.3): This is the central table, storing detailed 
information for waypoints that are event locations. Its primary key is 
`waypoint_id` (BIGINT), which is also a foreign key to `public.waypoints(id)`. 
- Key Relationships & Cardinalities: - It has a 1-to-1 relationship with the 
`waypoints` table (via `waypoint_id`). - Connects to `event_types_master` via 
`event_type_id` (Many-to-One). - Connects to 
`event_recurrence_frequencies_master` via `recurrence_frequency_id` 
(Many-to-One). - Connects to `event_attendance_scales_master` via 
`expected_attendance_scale_id` (Many-to-One). - Connects to 
`event_date_certainty_levels_master` via `future_date_estimation_level_id` 
(Many-to-One). - Connects to `tags_master` via `event_theme_or_focus_tag_ids` 
(INTEGER[]), representing a Many-to-Many relationship for event themes. - 
Critical Triggers: - `trigger_validate_event_theme_tags` (BEFORE INSERT OR 
UPDATE on `events_details`) ensures `event_theme_or_focus_tag_ids` reference 
valid and active entries in `tags_master`. - All tables in this module have a 
trigger (e.g., `handle_*_updated_at`) to automatically update the `updated_at` 
timestamp on row modification. - All tables in this module (`events_details` 
and the four master tables) have an `AFTER DELETE` trigger (e.g., 
`trigger_cleanup_*_translations`) to remove their associated orphaned entries 
from the `public.translations` table. - Default Values: - `events_details`: 
`is_recurring_event` defaults to `false`; `created_at` and `updated_at` default 
to `now()`. - Master tables: `id` is `GENERATED ALWAYS AS IDENTITY`, 
`sort_order` defaults to `0`, `is_active` defaults to `true`, and `created_at`, 
`updated_at` default to `now()`. * * * * * #### 4\. Cross-Cutting Concerns - 
Users & Roles: - Ownership and moderation are tracked in `events_details` via 
`created_by_profile_id`, `updated_by_profile_id`, and 
`data_verified_by_profile_id`, which are foreign keys to `public.profiles(id)`. 
- All master tables in this module also now include `created_by_profile_id` and 
`updated_by_profile_id`. - RLS policies leverage these, typically granting 
broader access based on user roles (e.g., 'admin_platform', 
'regional_content_manager') using helper functions like 
`public.has_role_on_profile()`. - Translations / i18n: - Numerous text fields 
in `events_details` (e.g., `default_event_name_official`, 
`default_description_long`) store their primary reference language content 
directly and are marked as translatable via the central `public.translations` 
table. - For the master tables, fields like `default_name`, 
`default_description` (and `default_advice` for 
`event_date_certainty_levels_master`; `approximate_range` for 
`event_attendance_scales_master`) store primary reference language text and are 
translatable via `public.translations`. - `event_theme_or_focus_tag_ids` links 
to `tags_master`, whose `default_name` field is assumed to be translated via 
`public.translations`. - AFTER DELETE triggers on all tables in this module 
ensure orphaned translations are cleaned up. - ENUM & Taxonomy Registry: - All 
previous ENUM types related to events have been promoted to dedicated master 
lookup tables within this module, each with `code`, `default_name`, 
`is_active`, `sort_order`, and audit columns. - The text array 
`event_theme_or_focus_tags` in `events_details` was correctly replaced by 
`event_theme_or_focus_tag_ids` (integer array), linking to `tags_master(id)`. - 
Media & Files: - The `event_types_master` table includes an `icon_identifier` 
column (TEXT) for UI icons. No other tables in this module directly link to 
`public.media`. Event-specific images would typically be associated via the 
parent `waypoints` media linking strategy (e.g., `waypoint_media`). - Audit / 
Soft-Delete / Versioning: - Standard Audit Columns: All tables in this module 
(`events_details` and the four master tables) now include `created_at`, 
`updated_at` (auto-updated), `created_by_profile_id` (FK to `profiles`), and 
`updated_by_profile_id` (FK to `profiles`). - `events_details` has specific 
data verification tracking with `data_last_verified_at` and 
`data_verified_by_profile_id`. - Soft-Delete: `events_details` includes a 
`deleted_at` timestamp column. Master tables use an `is_active BOOLEAN NOT NULL 
DEFAULT true` flag for lifecycle management. - Versioning: Schema versions are 
noted in table comments. Content versioning is not implemented at the row 
level. * * * * * #### 5\. Security & Access Control ðŸ” - RLS Overview: 
Row-Level Security policies are implemented for all tables in this module. - 
Public users generally have read-only access to active master data and event 
details linked to published and non-deleted waypoints. - Authenticated users 
with specific roles (e.g., 'admin_platform', 'regional_content_manager', or a 
dedicated 'event_manager' if defined) have broader CRUD permissions, often 
contingent on the parent waypoint's status or regional assignments. - Policies 
extensively use helper functions like `public.has_role_on_profile(auth.uid(), 
'role_code')` and `auth.uid()` for ownership checks. - Dedicated `SECURITY 
DEFINER` functions: - `public.check_event_theme_tags_exist()`: Validates tags 
linked to `events_details`. - `public.cleanup_*_translations()`: Functions for 
cleaning up orphaned translations for each table in this module. These must 
have their `search_path` hardened. - Anon vs Authenticated Access: Anonymous 
users have read-only access to published event information and active master 
list data. Authenticated users, depending on their roles, gain write/update 
capabilities. * * * * * #### 6\. Prerequisite Objects & Build Order âš™ï¸ The 
following order should be observed for deployment (assuming base types, 
`public.profiles`, `public.waypoints`, `public.tags_master`, 
`public.translations`, and helper function `extensions.moddatetime` or 
equivalent already exist): 1. Functions (SQL/PLPGSQL): - 
`public.check_event_theme_tags_exist()` (updated to check 
`tags_master.is_active`). - `public.cleanup_event_types_master_translations()`. 
- `public.cleanup_event_recurrence_frequencies_master_translations()`. - 
`public.cleanup_event_attendance_scales_master_translations()`. - 
`public.cleanup_event_date_certainty_levels_master_translations()`. - 
`public.cleanup_events_details_translations()`. 2. Core Tables (with PK/FK, 
audit columns, `is_active` flags): - `public.event_types_master` (v1.1) - 
`public.event_recurrence_frequencies_master` (v1.1) - 
`public.event_attendance_scales_master` (v1.1) - 
`public.event_date_certainty_levels_master` (v1.1) - `public.events_details` 
(v1.3) 3. Seed Data: Populate all master tables with initial seed data 
(including `default_name`, `code`, `is_active`, `sort_order`, and placeholder 
audit user IDs). 4. Views: - `public.event_details_enriched_view` (optional but 
recommended for API efficiency). 5. Indexes: Apply all defined indexes on these 
tables (for FKs, `is_active`/`sort_order` pairs, GIN indexes, etc.). 6. 
Triggers: - Apply `updated_at` triggers to all five tables. - Apply 
`trigger_validate_event_theme_tags` to `events_details`. - Apply orphan 
translation cleanup triggers (`trigger_cleanup_*_translations`) to all five 
tables. 7. RLS Policies: Enable RLS and apply all defined policies to all five 
tables. * * * * * #### 7\. API Endpoints Summary (Conceptual) - `GET /events`: 
Lists event details, supporting filters (date, type, location), pagination, and 
language preferences. Leverages the `event_details_enriched_view`. - `POST 
/events`: Creates a new event detail record (linked to a waypoint). - `GET 
/events/{waypoint_id}`: Retrieves comprehensive details for a specific event. 
Leverages the `event_details_enriched_view`. - `PATCH /events/{waypoint_id}`: 
Updates an existing event detail record. - `GET /event_types`: Lists available 
event types. - `GET /event_recurrence_frequencies`: Lists available recurrence 
frequencies. - `GET /event_attendance_scales`: Lists available attendance 
scales. - `GET /event_date_certainty_levels`: Lists available date certainty 
levels. * * * * * #### 8\. Performance & Optimization Extras - Key Indexes: - 
`events_details`: on `waypoint_id` (PK), `event_type_id`, `start_datetime`, 
`is_recurring_event`, GIN index on `event_theme_or_focus_tag_ids`, and 
`deleted_at`. Indexes on audit FKs and `related_attraction_waypoint_id`. - 
Master tables: PK on `id`, UNIQUE on `code`, and on `(is_active, sort_order)`. 
Indexes on audit FKs. - View Usage: The `public.event_details_enriched_view` is 
recommended to optimize read operations by pre-joining data. - Partitioning: 
Not planned for V1. `events_details` could be a candidate for date-based 
partitioning in the future if volume grows significantly. - Caching: Master 
data tables are good candidates for application-level caching due to their 
relatively static nature. * * * * * #### 9\. Visuals (Conceptual ERD - Module 
Focus) Code snippet ``` erDiagram waypoints { bigint id PK text default_name 
uuid content_visibility_status_id FK boolean deleted_at } profiles { uuid id PK 
text public_display_name } tags_master { integer id PK text default_name 
boolean is_active } translations { bigint id PK text table_identifier text 
column_identifier text row_foreign_key text language_code FK } 
event_types_master { integer id PK text code UK text default_name text 
icon_identifier boolean is_active uuid created_by_profile_id FK uuid 
updated_by_profile_id FK } event_recurrence_frequencies_master { integer id PK 
text code UK text default_name boolean is_active uuid created_by_profile_id FK 
uuid updated_by_profile_id FK } event_attendance_scales_master { integer id PK 
text code UK text default_name boolean is_active uuid created_by_profile_id FK 
uuid updated_by_profile_id FK } event_date_certainty_levels_master { integer id 
PK text code UK text default_name boolean is_active uuid created_by_profile_id 
FK uuid updated_by_profile_id FK } events_details { bigint waypoint_id PK FK 
text default_event_name_official integer event_type_id FK integer[] 
event_theme_or_focus_tag_ids FK timestamptz start_datetime boolean 
is_recurring_event integer recurrence_frequency_id FK integer 
future_date_estimation_level_id FK integer expected_attendance_scale_id FK uuid 
created_by_profile_id FK uuid updated_by_profile_id FK uuid 
data_verified_by_profile_id FK timestamptz deleted_at } events_details ||--o{ 
waypoints : "details_for_waypoint" events_details }o--|| event_types_master : 
"is_of_type" events_details }o--o| event_recurrence_frequencies_master : 
"recurs_at_frequency" events_details }o--o| event_attendance_scales_master : 
"has_attendance_scale" events_details }o--o| event_date_certainty_levels_master 
: "has_date_certainty" events_details }o--o| tags_master : "themed_with_tags 
(array)" events_details }o--o| profiles : "created_by" events_details }o--o| 
profiles : "updated_by" events_details }o--o| profiles : "data_verified_by" 
event_types_master o--o{ profiles : "audit_info" 
event_recurrence_frequencies_master o--o{ profiles : "audit_info" 
event_attendance_scales_master o--o{ profiles : "audit_info" 
event_date_certainty_levels_master o--o{ profiles : "audit_info" 
event_types_master ..> translations : "translatable_fields" 
event_recurrence_frequencies_master ..> translations : "translatable_fields" 
event_attendance_scales_master ..> translations : "translatable_fields" 
event_date_certainty_levels_master ..> translations : "translatable_fields" 
events_details ..> translations : "translatable_fields" ``` * * * * * #### 10\. 
Data & Workflow Flowchart (Simplified) 1. Admin/Content Manager (Setup & 
Maintenance): - Populates/Manages master tables (`event_types_master`, 
`event_recurrence_frequencies_master`, etc.) ensuring `is_active` is true for 
usable entries. Audit fields (`created_by_profile_id`, `updated_by_profile_id`) 
are populated. 2. Admin/Content Manager (Event Creation/Update): - Selects or 
creates a parent `waypoint`. - Creates/updates an `events_details` record, 
linking it to the `waypoint_id`. - Fills in `default_event_name_official`, 
`start_datetime`, selects type, frequency, scale, certainty from master tables, 
and links tags. - `check_event_theme_tags_exist` trigger validates tags. 
`updated_at` trigger fires. Audit fields populated. 3. Translator (Content 
Internationalization): - (Via separate interface/process) Adds translations for 
`default_` fields from `events_details` and master tables into 
`public.translations`, linking via `table_identifier`, `column_identifier`, and 
`row_foreign_key`. 4. Admin/Content Manager (Verification): - Periodically 
verifies event data, updating `data_last_verified_at` and 
`data_verified_by_profile_id` in `events_details`. 5. Pilgrim/End-User 
(Consumption): - Accesses event data via API (e.g., `GET /events` or `GET 
/events/{waypoint_id}`). - API layer (potentially using 
`event_details_enriched_view` and RPC functions for translations) fetches event 
details. - RLS policies ensure only published/accessible events are shown. - 
Application UI interprets date logic and displays event information in user's 
preferred language. 6. System (Deletion Cleanup): - If an `events_details` 
record (or a master table record) is deleted, its corresponding `AFTER DELETE` 
trigger fires to remove associated entries from `public.translations`. * * * * 
* #### 11\. Critical Gaps & Risks - ðŸ”´ `tags_master.is_active` Dependency: The 
`trigger_validate_event_theme_tags` on `events_details` requires `tags_master` 
to have an `is_active` column for correct validation. This external dependency 
must be met. (User confirmed `tags_master` is updated). - ðŸŸ  Application Logic 
for Date Interpretation: The complexity of accurately interpreting and 
displaying recurring event dates (considering `is_recurring_event`, 
`recurrence_frequency_id`, `default_recurrence_detail_text`, 
`future_date_estimation_level_id`, `exception_dates`, 
`default_specific_next_occurrence_dates_text`) resides heavily in the 
application layer and requires robust implementation and thorough testing. - ðŸŸ  
Translation Workflow: A clear workflow and interface for managing translations 
in `public.translations` for all translatable fields in this module is 
essential. - ðŸŸ¢ Iconography Management: A system for managing and associating 
`icon_identifier` values from `event_types_master` with actual UI assets needs 
to be in place. * * * * * #### 12\. Scalability & Future-Proof Notes - 
Structured Data: The use of master tables and detailed, specific columns in 
`events_details` provides a strong, flexible foundation for current and future 
needs. - Auditability: Comprehensive audit trails (`created_at`, `updated_at`, 
`created_by_profile_id`, `updated_by_profile_id` on all tables, plus specific 
verification fields in `events_details`) enhance data governance. - 
Internationalization: Centralized translation strategy is robust. - Future Date 
Queries: For very complex querying based on calculated future occurrences of 
recurring events, a dedicated `event_occurrences` table might be a future (V2+) 
consideration if performance with current structure becomes an issue for such 
specific queries. * * * * * #### 13\. Next Steps (Module Completion & 
Integration) 1. P1: Final DDL Execution: Execute all DDL for tables, functions, 
triggers, indexes, and views as finalized for this module, respecting the build 
order. 2. P1: Seed Master Data: Populate all master tables 
(`event_types_master`, `event_recurrence_frequencies_master`, 
`event_attendance_scales_master`, `event_date_certainty_levels_master`) with 
agreed initial data, ensuring audit columns are appropriately set. 3. P1: 
Implement RLS Policies: Apply all Row-Level Security policies. 4. P2: Develop 
API Layer: Implement API endpoints, leveraging the 
`event_details_enriched_view` and creating necessary RPC functions for data 
fetching and translation assembly. 5. P2: Application Logic: Develop robust 
application-side logic for date interpretation, display, and filtering. 6. P2: 
Content Management Interface: Ensure the admin/content management UI correctly 
supports all fields, including links to master data and the new 
audit/verification fields. 7. P2: Testing: Conduct thorough testing of data 
integrity (triggers, constraints), API functionality, RLS, and the date logic. 
