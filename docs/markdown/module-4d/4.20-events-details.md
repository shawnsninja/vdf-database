# 4.20 events_details

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/0b1e359defacbcc9 
https://gemini.google.com/u/1/app/0e3ccfac5f6b71bb * * * * * ### Updated 
Production-Ready Specification: `public.events_details` Version: 1.3 (Based on 
original 1.2 with V2.1 Checklist & i18n corrections Applied) Date: May 18, 2025 
#### 1\. Purpose & Primary Use-Cases The `events_details` table stores 
specific, detailed information for waypoints categorized as event locations 
(e.g., local festivals, religious celebrations, markets). It extends the 
generic `waypoints` entry to include crucial event-specific data like official 
names, types, themes, detailed descriptions, comprehensive date/time 
information (including recurrence patterns and certainty levels), organizer 
details, potential impacts on pilgrims, and participation information. This 
enables pilgrims to discover and plan around events, and administrators to 
manage this data. #### 2\. Schema | column | data_type | constraints | 
description | | `waypoint_id` | `BIGINT` | `Primary Key, Foreign Key to 
waypoints(id) ON DELETE CASCADE` | Links to the generic `waypoints` table 
(event's primary location). PK. | | `default_event_name_official` | `TEXT` | 
`Not Null, CHECK (length(default_event_name_official) > 0 AND 
length(default_event_name_official) <= 255)` | Official or most common name of 
the event in the primary reference language. (Translatable via 
`public.translations`) | | `event_type_id` | `INTEGER` | `Not Null, Foreign Key 
to event_types_master(id) ON DELETE RESTRICT` | The primary category or type of 
event, linking to `event_types_master`. | | `event_theme_or_focus_tag_ids` | 
`INTEGER[]` | `Nullable` | Array of FKs to `tags_master(id)` describing the 
event's theme/focus. Validated by trigger. | | `default_description_long` | 
`TEXT` | `Nullable` | Detailed description of the event in the primary 
reference language. (Translatable via `public.translations`) | | 
`start_datetime` | `TIMESTAMPTZ` | `Not Null` | Precise start date/time of the 
first known or next confirmed instance. Anchor for recurring events. | | 
`end_datetime` | `TIMESTAMPTZ` | `Nullable` | Precise end date/time of the 
instance defined by `start_datetime`. | | `is_recurring_event` | `BOOLEAN` | 
`Not Null, Default false` | True if this event happens regularly. | | 
`recurrence_frequency_id` | `INTEGER` | `Nullable, Foreign Key to 
event_recurrence_frequencies_master(id) ON DELETE SET NULL` | If recurring, the 
general frequency, linking to `event_recurrence_frequencies_master`. | | 
`default_recurrence_detail_text` | `TEXT` | `Nullable` | Human-readable 
description of the recurrence pattern in the primary reference language. 
(Translatable via `public.translations`) | | `future_date_estimation_level_id` 
| `INTEGER` | `Nullable, Foreign Key to event_date_certainty_levels_master(id) 
ON DELETE SET NULL` | Confidence level for predicting future occurrences, 
linking to `event_date_certainty_levels_master`. | | `exception_dates` | 
`DATE[]` | `Nullable` | Array of specific dates (YYYY-MM-DD) on which a 
normally recurring event will NOT take place. | | 
`default_specific_next_occurrence_dates_text` | `TEXT` | `Nullable` | Confirmed 
upcoming dates as text in the primary reference language. (Translatable via 
`public.translations`) | | `default_organizer_name` | `TEXT` | `Nullable, CHECK 
(default_organizer_name IS NULL OR length(default_organizer_name) <= 200)` | 
Name of the organizing body in the primary reference language. (Translatable 
via `public.translations`) | | `event_website_or_social_media_url` | `TEXT` | 
`Nullable, CHECK (event_website_or_social_media_url IS NULL OR 
(length(event_website_or_social_media_url) <= 2048 AND 
event_website_or_social_media_url ~* '^https?://.+'))` | Official website or 
social media page URL for the event. | | `contact_phone_event` | `TEXT` | 
`Nullable, CHECK (contact_phone_event IS NULL OR length(contact_phone_event) <= 
50)` | Contact phone number for event inquiries. | | `contact_email_event` | 
`TEXT` | `Nullable, CHECK (contact_email_event IS NULL OR 
(length(contact_email_event) <= 254 AND contact_email_event ~* 
'^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'))` | Contact email address 
for event inquiries. | | `default_entry_fee_or_ticket_info` | `TEXT` | 
`Nullable` | Information on costs to attend in the primary reference language. 
(Translatable via `public.translations`) | | 
`default_location_details_within_waypoint` | `TEXT` | `Nullable` | Specific 
location details if event is at a large waypoint, in the primary reference 
language. (Translatable via `public.translations`) | | 
`expected_attendance_scale_id` | `INTEGER` | `Nullable, Foreign Key to 
event_attendance_scales_master(id) ON DELETE SET NULL` | Estimation of the 
event's size/crowd level, linking to `event_attendance_scales_master`. | | 
`default_impact_on_accommodation_notes` | `TEXT` | `Nullable` | Notes on how 
event might affect accommodation, in the primary reference language. 
(Translatable via `public.translations`) | | 
`default_impact_on_trail_access_notes` | `TEXT` | `Nullable` | Notes on how 
event might affect trail access, in the primary reference language. 
(Translatable via `public.translations`) | | 
`default_impact_on_local_services_notes` | `TEXT` | `Nullable` | Notes on how 
event might affect local services, in the primary reference language. 
(Translatable via `public.translations`) | | 
`default_general_impact_notes_for_pilgrims` | `TEXT` | `Nullable` | Other 
general impacts or advice for pilgrims, in the primary reference language. 
(Translatable via `public.translations`) | | 
`default_pilgrim_participation_info` | `TEXT` | `Nullable` | Information on how 
pilgrims can participate, in the primary reference language. (Translatable via 
`public.translations`) | | `related_attraction_waypoint_id` | `BIGINT` | 
`Nullable, Foreign Key to waypoints(id) ON DELETE SET NULL` | If event is tied 
to another specific attraction waypoint. | | `data_last_verified_at` | 
`TIMESTAMPTZ` | `Nullable` | Timestamp when event details (especially dates, 
recurrence) were last verified. | | `data_verified_by_profile_id` | `UUID` | 
`Nullable, Foreign Key to profiles(id) ON DELETE SET NULL` | Profile ID of the 
user who last verified this event's details. | | `created_at` | `TIMESTAMPTZ` | 
`Not Null, Default now()` | Timestamp of record creation. | | 
`created_by_profile_id` | `UUID` | `Nullable, Foreign Key to profiles(id) ON 
DELETE SET NULL` | Profile ID of the user who created this record. | | 
`updated_at` | `TIMESTAMPTZ` | `Not Null, Default now()` | Timestamp of last 
update (auto-updated by trigger). | | `updated_by_profile_id` | `UUID` | 
`Nullable, Foreign Key to profiles(id) ON DELETE SET NULL` | Profile ID of the 
user who last updated this record. | | `deleted_at` | `TIMESTAMPTZ` | 
`Nullable` | Timestamp for soft deletion. | #### 3\. PostgreSQL DDL SQL ``` 
CREATE TABLE public.events_details ( waypoint_id BIGINT PRIMARY KEY, 
default_event_name_official TEXT NOT NULL CHECK 
(length(default_event_name_official) > 0 AND 
length(default_event_name_official) <= 255), event_type_id INTEGER NOT NULL, 
event_theme_or_focus_tag_ids INTEGER[] NULL, default_description_long TEXT 
NULL, start_datetime TIMESTAMPTZ NOT NULL, end_datetime TIMESTAMPTZ NULL, 
is_recurring_event BOOLEAN NOT NULL DEFAULT FALSE, recurrence_frequency_id 
INTEGER NULL, default_recurrence_detail_text TEXT NULL, 
future_date_estimation_level_id INTEGER NULL, exception_dates DATE[] NULL, 
default_specific_next_occurrence_dates_text TEXT NULL, default_organizer_name 
TEXT NULL CHECK (default_organizer_name IS NULL OR 
length(default_organizer_name) <= 200), event_website_or_social_media_url TEXT 
NULL CHECK (event_website_or_social_media_url IS NULL OR 
(length(event_website_or_social_media_url) <= 2048 AND 
event_website_or_social_media_url ~* '^https?://.+')), contact_phone_event TEXT 
NULL CHECK (contact_phone_event IS NULL OR length(contact_phone_event) <= 50), 
contact_email_event TEXT NULL CHECK (contact_email_event IS NULL OR 
(length(contact_email_event) <= 254 AND contact_email_event ~* 
'^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')), 
default_entry_fee_or_ticket_info TEXT NULL, 
default_location_details_within_waypoint TEXT NULL, 
expected_attendance_scale_id INTEGER NULL, 
default_impact_on_accommodation_notes TEXT NULL, 
default_impact_on_trail_access_notes TEXT NULL, 
default_impact_on_local_services_notes TEXT NULL, 
default_general_impact_notes_for_pilgrims TEXT NULL, 
default_pilgrim_participation_info TEXT NULL, related_attraction_waypoint_id 
BIGINT NULL, data_last_verified_at TIMESTAMPTZ NULL, 
data_verified_by_profile_id UUID NULL, created_at TIMESTAMPTZ NOT NULL DEFAULT 
now(), created_by_profile_id UUID NULL, updated_at TIMESTAMPTZ NOT NULL DEFAULT 
now(), updated_by_profile_id UUID NULL, deleted_at TIMESTAMPTZ NULL, CONSTRAINT 
fk_waypoint FOREIGN KEY(waypoint_id) REFERENCES public.waypoints(id) ON DELETE 
CASCADE, CONSTRAINT fk_event_type FOREIGN KEY(event_type_id) REFERENCES 
public.event_types_master(id) ON DELETE RESTRICT, CONSTRAINT 
fk_recurrence_frequency FOREIGN KEY(recurrence_frequency_id) REFERENCES 
public.event_recurrence_frequencies_master(id) ON DELETE SET NULL, CONSTRAINT 
fk_future_date_estimation_level FOREIGN KEY(future_date_estimation_level_id) 
REFERENCES public.event_date_certainty_levels_master(id) ON DELETE SET NULL, 
CONSTRAINT fk_expected_attendance_scale FOREIGN 
KEY(expected_attendance_scale_id) REFERENCES 
public.event_attendance_scales_master(id) ON DELETE SET NULL, CONSTRAINT 
fk_related_attraction_waypoint FOREIGN KEY(related_attraction_waypoint_id) 
REFERENCES public.waypoints(id) ON DELETE SET NULL, CONSTRAINT 
fk_created_by_profile FOREIGN KEY(created_by_profile_id) REFERENCES 
public.profiles(id) ON DELETE SET NULL, CONSTRAINT fk_updated_by_profile 
FOREIGN KEY(updated_by_profile_id) REFERENCES public.profiles(id) ON DELETE SET 
NULL, CONSTRAINT fk_data_verified_by_profile FOREIGN 
KEY(data_verified_by_profile_id) REFERENCES public.profiles(id) ON DELETE SET 
NULL ); COMMENT ON TABLE public.events_details IS 'Specific details for events, 
extending the waypoints table. Version 1.3'; COMMENT ON COLUMN 
public.events_details.waypoint_id IS 'Links to the generic waypoints table 
(event''s primary location). PK. [cite: 12]'; COMMENT ON COLUMN 
public.events_details.default_event_name_official IS 'Official or most common 
name of the event in the primary reference language. (Translatable via 
public.translations). Max 255 chars. [cite: 14]'; COMMENT ON COLUMN 
public.events_details.event_type_id IS 'FK to event_types_master. Primary 
category/type of event. [cite: 15]'; COMMENT ON COLUMN 
public.events_details.event_theme_or_focus_tag_ids IS 'Array of FKs to 
tags_master. Describes event theme/focus. Integrity enforced by 
trigger_validate_event_theme_tags. [cite: 17, 83]'; COMMENT ON COLUMN 
public.events_details.default_description_long IS 'Detailed description of the 
event in the primary reference language. (Translatable via 
public.translations). [cite: 18]'; COMMENT ON COLUMN 
public.events_details.start_datetime IS 'Precise start date/time of the first 
known or next confirmed instance. Anchor for recurring events. [cite: 19, 85]'; 
COMMENT ON COLUMN public.events_details.end_datetime IS 'Precise end date/time 
of the instance defined by start_datetime. [cite: 21, 86]'; COMMENT ON COLUMN 
public.events_details.is_recurring_event IS 'True if this event happens 
regularly. [cite: 22, 87]'; COMMENT ON COLUMN 
public.events_details.recurrence_frequency_id IS 'FK to 
event_recurrence_frequencies_master. General frequency if recurring. [cite: 23, 
88]'; COMMENT ON COLUMN public.events_details.default_recurrence_detail_text IS 
'Human-readable description of the recurrence pattern in the primary reference 
language. (Translatable via public.translations). [cite: 25, 88]'; COMMENT ON 
COLUMN public.events_details.future_date_estimation_level_id IS 'FK to 
event_date_certainty_levels_master. Confidence level for predicted future 
occurrences. [cite: 26, 89]'; COMMENT ON COLUMN 
public.events_details.exception_dates IS 'Array of specific dates (YYYY-MM-DD) 
on which a normally recurring event will NOT take place. [cite: 28, 90]'; 
COMMENT ON COLUMN 
public.events_details.default_specific_next_occurrence_dates_text IS 'Confirmed 
upcoming dates as text in the primary reference language. (Translatable via 
public.translations). [cite: 30, 91]'; COMMENT ON COLUMN 
public.events_details.default_organizer_name IS 'Name of the organizing body in 
the primary reference language. (Translatable via public.translations). Max 200 
chars. [cite: 31, 92]'; COMMENT ON COLUMN 
public.events_details.event_website_or_social_media_url IS 'Official website or 
social media page URL for the event. Max 2048 chars. Must be a valid URL 
format. [cite: 33, 93]'; COMMENT ON COLUMN 
public.events_details.contact_phone_event IS 'Contact phone number for event 
inquiries. Max 50 chars. [cite: 34, 94]'; COMMENT ON COLUMN 
public.events_details.contact_email_event IS 'Contact email address for event 
inquiries. Max 254 chars, basic regex validation. [cite: 35, 95]'; COMMENT ON 
COLUMN public.events_details.default_entry_fee_or_ticket_info IS 'Information 
on costs to attend, ticketing, or if free, in the primary reference language. 
(Translatable via public.translations). [cite: 37, 96]'; COMMENT ON COLUMN 
public.events_details.default_location_details_within_waypoint IS 'Specific 
location details if event is at a large waypoint, in the primary reference 
language. (Translatable via public.translations). [cite: 38, 97]'; COMMENT ON 
COLUMN public.events_details.expected_attendance_scale_id IS 'FK to 
event_attendance_scales_master. Estimation of event size/crowd level. [cite: 
39, 98]'; COMMENT ON COLUMN 
public.events_details.default_impact_on_accommodation_notes IS 'Notes on how 
event might affect accommodation, in the primary reference language. 
(Translatable via public.translations). [cite: 41, 99]'; COMMENT ON COLUMN 
public.events_details.default_impact_on_trail_access_notes IS 'Notes on how 
event might affect trail access, in the primary reference language. 
(Translatable via public.translations). [cite: 42, 100]'; COMMENT ON COLUMN 
public.events_details.default_impact_on_local_services_notes IS 'Notes on how 
event might affect local services, in the primary reference language. 
(Translatable via public.translations). [cite: 43, 101]'; COMMENT ON COLUMN 
public.events_details.default_general_impact_notes_for_pilgrims IS 'Other 
general impacts or advice for pilgrims, in the primary reference language. 
(Translatable via public.translations). [cite: 44, 102]'; COMMENT ON COLUMN 
public.events_details.default_pilgrim_participation_info IS 'Information on how 
pilgrims can participate, in the primary reference language. (Translatable via 
public.translations). [cite: 45, 103]'; COMMENT ON COLUMN 
public.events_details.related_attraction_waypoint_id IS 'FK to waypoints.id if 
event is tied to another specific attraction waypoint. [cite: 46, 104]'; 
COMMENT ON COLUMN public.events_details.data_last_verified_at IS 'Timestamp 
when event details were last verified. [cite: 48, 105]'; COMMENT ON COLUMN 
public.events_details.data_verified_by_profile_id IS 'Profile ID of the user 
who last verified this event''s details (especially dates). [cite: 49, 106]'; 
COMMENT ON COLUMN public.events_details.created_at IS 'Timestamp of record 
creation. [cite: 51, 107]'; COMMENT ON COLUMN 
public.events_details.created_by_profile_id IS 'Profile ID of the user who 
created this record. [cite: 52, 108]'; COMMENT ON COLUMN 
public.events_details.updated_at IS 'Timestamp of last update. [cite: 109]'; 
COMMENT ON COLUMN public.events_details.updated_by_profile_id IS 'Profile ID of 
the user who last updated this record. [cite: 55, 109]'; COMMENT ON COLUMN 
public.events_details.deleted_at IS 'Timestamp for soft deletion. [cite: 56, 
110]'; -- Indexes CREATE INDEX ix_events_details_event_type_id ON 
public.events_details(event_type_id); CREATE INDEX 
ix_events_details_start_datetime ON public.events_details(start_datetime); 
CREATE INDEX ix_events_details_is_recurring_event ON 
public.events_details(is_recurring_event); CREATE INDEX 
ix_events_details_event_theme_or_focus_tag_ids ON public.events_details USING 
GIN (event_theme_or_focus_tag_ids) WHERE event_theme_or_focus_tag_ids IS NOT 
NULL; CREATE INDEX ix_events_details_deleted_at ON 
public.events_details(deleted_at) WHERE deleted_at IS NOT NULL; CREATE INDEX 
ix_events_details_created_by_profile_id ON 
public.events_details(created_by_profile_id) WHERE created_by_profile_id IS NOT 
NULL; CREATE INDEX ix_events_details_updated_by_profile_id ON 
public.events_details(updated_by_profile_id) WHERE updated_by_profile_id IS NOT 
NULL; CREATE INDEX ix_events_details_data_verified_by_profile_id ON 
public.events_details(data_verified_by_profile_id) WHERE 
data_verified_by_profile_id IS NOT NULL; CREATE INDEX 
ix_events_details_related_attraction_waypoint_id ON 
public.events_details(related_attraction_waypoint_id) WHERE 
related_attraction_waypoint_id IS NOT NULL; ``` #### 4\. Triggers/Functions SQL 
``` -- Standard updated_at trigger CREATE TRIGGER 
handle_events_details_updated_at BEFORE UPDATE ON public.events_details FOR 
EACH ROW EXECUTE FUNCTION extensions.moddatetime('updated_at'); -- Or 
public.set_current_timestamp_updated_at() COMMENT ON TRIGGER 
handle_events_details_updated_at ON public.events_details IS 'Trigger to 
automatically update updated_at timestamp on row modification.'; -- Array FK 
Validation for event_theme_or_focus_tag_ids CREATE OR REPLACE FUNCTION 
public.check_event_theme_tags_exist() RETURNS TRIGGER AS $$ DECLARE tag_id 
INTEGER; tag_active BOOLEAN; BEGIN IF TG_OP = 'INSERT' OR (TG_OP = 'UPDATE' AND 
NEW.event_theme_or_focus_tag_ids IS DISTINCT FROM 
OLD.event_theme_or_focus_tag_ids) THEN IF NEW.event_theme_or_focus_tag_ids IS 
NOT NULL THEN FOREACH tag_id IN ARRAY NEW.event_theme_or_focus_tag_ids LOOP 
SELECT tm.is_active INTO tag_active FROM public.tags_master tm WHERE tm.id = 
tag_id; IF NOT FOUND OR tag_active = FALSE THEN RAISE EXCEPTION 'Invalid or 
inactive tag_id % found in event_theme_or_focus_tag_ids. It does not exist or 
is not active in public.tags_master.', tag_id; END IF; END LOOP; END IF; END 
IF; RETURN NEW; END; $$ LANGUAGE plpgsql SECURITY DEFINER; COMMENT ON FUNCTION 
public.check_event_theme_tags_exist() IS 'Checks if all IDs in 
event_theme_or_focus_tag_ids exist and are active in tags_master. Used by 
trigger on events_details. Runs as SECURITY DEFINER.'; CREATE TRIGGER 
trigger_validate_event_theme_tags BEFORE INSERT OR UPDATE OF 
event_theme_or_focus_tag_ids ON public.events_details FOR EACH ROW EXECUTE 
FUNCTION public.check_event_theme_tags_exist(); COMMENT ON TRIGGER 
trigger_validate_event_theme_tags ON public.events_details IS 'Ensures that all 
tags in event_theme_or_focus_tag_ids are valid and active entries in 
tags_master.'; -- Orphaned translation cleanup trigger CREATE OR REPLACE 
FUNCTION public.cleanup_events_details_translations() RETURNS TRIGGER AS $$ 
BEGIN DELETE FROM public.translations WHERE table_identifier = 'events_details' 
AND column_identifier IN ( 'default_event_name_official', 
'default_description_long', 'default_recurrence_detail_text', 
'default_specific_next_occurrence_dates_text', 'default_organizer_name', 
'default_entry_fee_or_ticket_info', 'default_location_details_within_waypoint', 
'default_impact_on_accommodation_notes', 
'default_impact_on_trail_access_notes', 
'default_impact_on_local_services_notes', 
'default_general_impact_notes_for_pilgrims', 
'default_pilgrim_participation_info' ) AND row_foreign_key = 
OLD.waypoint_id::TEXT; -- PK of events_details is waypoint_id RETURN OLD; END; 
$$ LANGUAGE plpgsql SECURITY DEFINER; COMMENT ON FUNCTION 
public.cleanup_events_details_translations() IS 'Cleans up orphaned 
translations from public.translations when an events_details record is deleted. 
Runs as SECURITY DEFINER.'; CREATE TRIGGER 
trigger_cleanup_events_details_translations AFTER DELETE ON 
public.events_details FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_events_details_translations(); COMMENT ON TRIGGER 
trigger_cleanup_events_details_translations ON public.events_details IS 'After 
deleting an event''s details, remove its associated translations from the 
public.translations table.'; ``` *(Assumes `extensions.moddatetime` or 
`public.set_current_timestamp_updated_at()` exists, `public.translations` table 
exists, and `tags_master` has an `is_active` column).* #### 5\. JSON Schema 
Mirror JSON ``` { "title": "event_detail", "description": "Stores specific 
details for waypoints categorized as event locations. Version 1.3", "type": 
"object", "properties": { "waypoint_id": { "type": "integer", "format": 
"int64", "description": "PK, FK to waypoints.id. [cite: 12]" }, 
"default_event_name_official": { "type": "string", "maxLength": 255, 
"description": "Official or most common name of the event in the primary 
reference language. (Translatable via public.translations) [cite: 14]" }, 
"event_type_id": { "type": "integer", "description": "FK to event_types_master. 
Primary category/type of event. [cite: 15]" }, "event_theme_or_focus_tag_ids": 
{ "type": ["array", "null"], "items": { "type": "integer" }, "description": 
"Array of FKs to tags_master. Describes event theme/focus. Validated by 
trigger. [cite: 17]" }, "default_description_long": { "type": ["string", 
"null"], "description": "Detailed description of the event in the primary 
reference language. (Translatable via public.translations) [cite: 18]" }, 
"start_datetime": { "type": "string", "format": "date-time", "description": 
"Precise start date/time of the first known or next confirmed instance. [cite: 
19]" }, "end_datetime": { "type": ["string", "null"], "format": "date-time", 
"description": "Precise end date/time of the instance. [cite: 21]" }, 
"is_recurring_event": { "type": "boolean", "default": false, "description": 
"True if this event happens regularly. [cite: 22]" }, 
"recurrence_frequency_id": { "type": ["integer", "null"], "description": "FK to 
event_recurrence_frequencies_master. General frequency if recurring. [cite: 
23]" }, "default_recurrence_detail_text": { "type": ["string", "null"], 
"description": "Human-readable description of the recurrence pattern in the 
primary reference language. (Translatable via public.translations) [cite: 25]" 
}, "future_date_estimation_level_id": { "type": ["integer", "null"], 
"description": "FK to event_date_certainty_levels_master. Confidence level for 
predicted future occurrences. [cite: 26]" }, "exception_dates": { "type": 
["array", "null"], "items": { "type": "string", "format": "date" }, 
"description": "Specific dates event will NOT take place. [cite: 28]" }, 
"default_specific_next_occurrence_dates_text": { "type": ["string", "null"], 
"description": "Confirmed upcoming dates as text in the primary reference 
language. (Translatable via public.translations) [cite: 30]" }, 
"default_organizer_name": { "type": ["string", "null"], "maxLength": 200, 
"description": "Name of the organizing body in the primary reference language. 
(Translatable via public.translations) [cite: 31]" }, 
"event_website_or_social_media_url": { "type": ["string", "null"], "format": 
"url", "pattern": "^https?://.+", "maxLength": 2048, "description": "Official 
website or social media page URL. [cite: 33]" }, "contact_phone_event": { 
"type": ["string", "null"], "maxLength": 50, "description": "Contact phone 
number. [cite: 34]" }, "contact_email_event": { "type": ["string", "null"], 
"format": "email", "maxLength": 254, "description": "Contact email address. 
[cite: 35]" }, "default_entry_fee_or_ticket_info": { "type": ["string", 
"null"], "description": "Information on costs to attend in the primary 
reference language. (Translatable via public.translations) [cite: 37]" }, 
"default_location_details_within_waypoint": { "type": ["string", "null"], 
"description": "Specific location details if event is at a large waypoint, in 
the primary reference language. (Translatable via public.translations) [cite: 
38]" }, "expected_attendance_scale_id": { "type": ["integer", "null"], 
"description": "FK to event_attendance_scales_master. Estimation of event size. 
[cite: 39]" }, "default_impact_on_accommodation_notes": { "type": ["string", 
"null"], "description": "Notes on impact on accommodation in the primary 
reference language. (Translatable via public.translations) [cite: 41]" }, 
"default_impact_on_trail_access_notes": { "type": ["string", "null"], 
"description": "Notes on impact on trail access in the primary reference 
language. (Translatable via public.translations) [cite: 42]" }, 
"default_impact_on_local_services_notes": { "type": ["string", "null"], 
"description": "Notes on impact on local services in the primary reference 
language. (Translatable via public.translations) [cite: 43]" }, 
"default_general_impact_notes_for_pilgrims": { "type": ["string", "null"], 
"description": "Other general impacts or advice for pilgrims in the primary 
reference language. (Translatable via public.translations) [cite: 44]" }, 
"default_pilgrim_participation_info": { "type": ["string", "null"], 
"description": "Information on how pilgrims can participate in the primary 
reference language. (Translatable via public.translations) [cite: 45]" }, 
"related_attraction_waypoint_id": { "type": ["integer", "null"], "format": 
"int64", "description": "FK to waypoints.id if event is tied to another 
specific attraction. [cite: 46]" }, "data_last_verified_at": { "type": 
["string", "null"], "format": "date-time", "description": "Timestamp when event 
details were last verified. [cite: 48]" }, "data_verified_by_profile_id": { 
"type": ["string", "null"], "format": "uuid", "description": "Profile ID of the 
user who last verified this event's details. [cite: 49]" }, "created_at": { 
"type": "string", "format": "date-time", "readOnly": true, "description": 
"Timestamp of record creation. [cite: 51]" }, "created_by_profile_id": { 
"type": ["string", "null"], "format": "uuid", "description": "Profile ID of the 
user who created this record. [cite: 52]" }, "updated_at": { "type": "string", 
"format": "date-time", "readOnly": true, "description": "Timestamp of last 
update. [cite: 53]" }, "updated_by_profile_id": { "type": ["string", "null"], 
"format": "uuid", "description": "Profile ID of the user who last updated this 
record. [cite: 55]" }, "deleted_at": { "type": ["string", "null"], "format": 
"date-time", "readOnly": true, "description": "Timestamp for soft deletion. 
[cite: 56]" } }, "required": ["waypoint_id", "default_event_name_official", 
"event_type_id", "start_datetime", "is_recurring_event", "created_at", 
"updated_at" ] } ``` #### 6\. Relationships & Integrity - Primary Key: 
`waypoint_id` (BIGINT) - Foreign Keys: - `waypoint_id` REFERENCES 
`public.waypoints(id)` ON DELETE CASCADE - `event_type_id` REFERENCES 
`public.event_types_master(id)` ON DELETE RESTRICT - `recurrence_frequency_id` 
REFERENCES `public.event_recurrence_frequencies_master(id)` ON DELETE SET NULL 
- `future_date_estimation_level_id` REFERENCES 
`public.event_date_certainty_levels_master(id)` ON DELETE SET NULL - 
`expected_attendance_scale_id` REFERENCES 
`public.event_attendance_scales_master(id)` ON DELETE SET NULL - 
`related_attraction_waypoint_id` REFERENCES `public.waypoints(id)` ON DELETE 
SET NULL - `data_verified_by_profile_id` REFERENCES `public.profiles(id)` ON 
DELETE SET NULL - `created_by_profile_id` REFERENCES `public.profiles(id)` ON 
DELETE SET NULL - `updated_by_profile_id` REFERENCES `public.profiles(id)` ON 
DELETE SET NULL - Array Foreign Keys: `event_theme_or_focus_tag_ids` references 
`tags_master(id)`. Integrity enforced by `trigger_validate_event_theme_tags` 
(which now checks `is_active` on `tags_master`). #### 7\. Multilingual Strategy 
- The following fields store content in the primary reference language and are 
(Translatable via `public.translations`): `default_event_name_official`, 
`default_description_long`, `default_recurrence_detail_text`, 
`default_specific_next_occurrence_dates_text`, `default_organizer_name`, 
`default_entry_fee_or_ticket_info`, `default_location_details_within_waypoint`, 
`default_impact_on_accommodation_notes`, 
`default_impact_on_trail_access_notes`, 
`default_impact_on_local_services_notes`, 
`default_general_impact_notes_for_pilgrims`, 
`default_pilgrim_participation_info`. - An `AFTER DELETE` trigger 
(`trigger_cleanup_events_details_translations`) on this table ensures orphaned 
translations are removed from `public.translations`. #### 8\. Role-Based 
Workflow & RLS Notes - Key Fields for Roles/Workflows: `created_by_profile_id`, 
`updated_by_profile_id`, `data_verified_by_profile_id`, `deleted_at`. - RLS 
Policies: - 🟢 Public users can read event details linked to published and not 
deleted waypoints. SQL ``` CREATE POLICY "Allow public read access to published 
event details" ON public.events_details FOR SELECT USING ( EXISTS ( SELECT 1 
FROM public.waypoints w JOIN public.content_statuses_master csm ON 
w.content_visibility_status_id = csm.id -- Assuming 
content_visibility_status_id is FK to content_statuses_master.id WHERE w.id = 
events_details.waypoint_id AND w.deleted_at IS NULL AND csm.code = 'published' 
-- Assuming 'published' is the code for visible status ) ); ``` - 🟢 
Authenticated users with 'admin_platform' or 'admin_super' roles can manage all 
event details. SQL ``` CREATE POLICY "Allow platform admins to manage event 
details" ON public.events_details FOR ALL USING ( auth.role() = 'authenticated' 
AND (SELECT public.has_role_on_profile(auth.uid(), 'admin_platform') OR 
public.has_role_on_profile(auth.uid(), 'admin_super')) AND EXISTS (SELECT 1 
FROM public.waypoints w WHERE w.id = events_details.waypoint_id AND 
w.deleted_at IS NULL) -- Ensure parent waypoint exists and is not deleted ) 
WITH CHECK ( auth.role() = 'authenticated' AND (SELECT 
public.has_role_on_profile(auth.uid(), 'admin_platform') OR 
public.has_role_on_profile(auth.uid(), 'admin_super')) AND EXISTS (SELECT 1 
FROM public.waypoints w WHERE w.id = events_details.waypoint_id AND 
w.deleted_at IS NULL) AND (NOT (TG_OP = 'UPDATE' AND OLD.waypoint_id IS 
DISTINCT FROM NEW.waypoint_id)) -- Prevent reparenting waypoint_id ); ``` - 🟠 
The original RLS used `profiles.role_name IN ('manager', 'admin')`. This has 
been updated to use a helper function `public.has_role_on_profile` for 
consistency with platform standards. The roles 'manager' and 'admin' should map 
to appropriate platform roles like 'admin_platform' or 
'regional_content_manager'. #### 9\. ENUM vs Lookup Discussion - 🟢 All 
original ENUMs previously associated with event details (`event_type_enum`, 
`event_recurrence_frequency_enum`, `event_attendance_scale_enum`, 
`event_date_certainty_enum`) have been successfully promoted to their 
respective master tables (`event_types_master`, 
`event_recurrence_frequencies_master`, `event_attendance_scales_master`, 
`event_date_certainty_levels_master`). - 🟢 `event_theme_or_focus_tags` 
(text[]) was correctly promoted to `event_theme_or_focus_tag_ids` (integer[]) 
linking to `tags_master`. #### 10\. UI/UX Enablement - Date Handling: 
`start_datetime`, `end_datetime`, `is_recurring_event`, 
`recurrence_frequency_id` (via master table), `default_recurrence_detail_text`, 
`future_date_estimation_level_id` (via master table), `exception_dates`, 
`default_specific_next_occurrence_dates_text` collectively provide 
comprehensive timing information. - Filtering & Icons: `event_type_id` (via 
master table) and `event_theme_or_focus_tag_ids` (via `tags_master`) will drive 
filtering and potentially icon display. - Impact Assessment: The various 
`default_impact_*_notes` fields are crucial for pilgrim planning. #### 11\. 
Auditing & Lifecycle Management - Audit Columns: `created_at`, `updated_at` 
(auto-managed by trigger), `created_by_profile_id`, `updated_by_profile_id`. - 
Specific Audit: `data_last_verified_at`, `data_verified_by_profile_id` for 
tracking content verification. - Lifecycle: `deleted_at` for soft deletion, 
typically initiated by deletion of the parent waypoint record due to `ON DELETE 
CASCADE` on `waypoint_id` FK. #### 12\. Scalability & Future-Proofing - 
Structured Dates: Date-related fields offer a good foundation. - Master Tables: 
Use of master tables promotes flexibility. - Partitioning: Potentially by 
`start_datetime` if volume becomes very large (Post V2.1 consideration). #### 
13\. Seed Data - ⚪ N/A - This table stores transactional detail data linked to 
waypoints, not predefined master data. #### 14\. Next-Action Checklist - 🔴 
Prerequisite Master Tables: Ensure `public.waypoints`, `public.profiles`, 
`public.tags_master` (with `is_active` column), 
`public.content_statuses_master`, `public.event_types_master`, 
`public.event_recurrence_frequencies_master`, 
`public.event_attendance_scales_master`, and 
`public.event_date_certainty_levels_master` are created and populated. - 🔴 
Create Table: Execute the DDL for `public.events_details`. - 🔴 Create Indexes: 
Execute DDL for all defined indexes. - 🔴 Implement `updated_at` Trigger: 
Ensure `extensions.moddatetime` or equivalent and create 
`handle_events_details_updated_at` trigger. - 🔴 Implement Array FK Validation 
Trigger: Create/Update and apply `trigger_validate_event_theme_tags` ensuring 
it checks `tags_master.is_active`. Solidify `SECURITY DEFINER` status and 
`search_path`. - 🔴 Implement Orphan Translation Cleanup Trigger: Create and 
apply `trigger_cleanup_events_details_translations` (after 
`public.translations` table and the function exist). Solidify `SECURITY 
DEFINER` status and `search_path`. - 🔴 RLS Policies: Review, adapt (using 
helper functions), and apply defined RLS policies. Ensure helper functions like 
`public.has_role_on_profile` are available. - 🟠 Application Logic for Dates: 
Develop robust application-layer logic for interpreting and displaying complex 
event recurrence and certainty. - 🟠 Population Logic: Define application layer 
logic for audit FKs (`created_by_profile_id`, `updated_by_profile_id`, 
`data_verified_by_profile_id`). - 🟢 Review `ON DELETE` actions for all FKs to 
ensure they align with desired data retention policies (current ones seem 
reasonable). 
