# 4d.0.2 - API concepts

  https://gemini.google.com/u/1/app/0e3ccfac5f6b71bb Okay, I'm ready to 
conceptualize the API for Module 4d (Waypoint - Events). ### Key Conceptual API 
Endpoints 1. Endpoint: List Events near a Location or along a Trail/Route - 
Purpose: To allow users to discover events happening within a certain 
geographical area, near a specific waypoint, or associated with a trail/route 
they are interested in, often within a specified date range. - Path Pattern: 
`/events` - Query Params / Filters / Options: - 
`near_waypoint_id={waypoint_id}` (BIGINT): ID of a central waypoint. - 
`trail_id={trail_id}` (BIGINT): Filter events associated with a specific trail. 
- `route_id={route_id}` (BIGINT): Filter events associated with a specific 
route. - `latitude={lat}&longitude={lon}&radius_km={radius}` (FLOAT, FLOAT, 
INT): For geo-fenced searches. - `start_date={YYYY-MM-DD}` (DATE): Events 
starting on or after this date. - `end_date={YYYY-MM-DD}` (DATE): Events ending 
on or before this date. - `event_type_codes={code1,code2}` (TEXT): 
Comma-separated list of `event_types_master.code`. - `theme_tag_ids={id1,id2}` 
(TEXT): Comma-separated list of `tags_master.id`. - `min_certainty_code={code}` 
(TEXT): Minimum `event_date_certainty_levels_master.code`. - 
`lang={language_code}` (TEXT, e.g., `it`): For returning translatable fields in 
the specified language. - `page={N}` (INT, default 1), `per_page={M}` (INT, 
default 20): For pagination. - `sort_by={field}` (TEXT, default 
`start_datetime`): e.g., `start_datetime`, `waypoint_name`. - 
`order={asc|desc}` (TEXT, default `asc`). 2. Endpoint: Get Specific Event 
Details - Purpose: To retrieve comprehensive information for a single event, 
identified by its parent `waypoint_id`. - Path Pattern: `/events/{waypoint_id}` 
(where `{waypoint_id}` is the `events_details.waypoint_id`) - Query Params / 
Filters / Options: - `lang={language_code}` (TEXT, e.g., `it`): For returning 
translatable fields in the specified language. 3. Endpoint: List Event Master 
Data - Purpose: To fetch lists of available event types, recurrence 
frequencies, attendance scales, or date certainty levels, typically for 
populating UI filters or forms. - Path Pattern Examples: - `/event_types` - 
`/event_recurrence_frequencies` - `/event_attendance_scales` - 
`/event_date_certainty_levels` - Query Params / Filters / Options: - 
`lang={language_code}` (TEXT, e.g., `it`): For returning translatable fields 
(`default_name`, `default_description`, etc.) in the specified language. - 
`sort_by={field}` (TEXT, default `sort_order` or `default_name`): Field to sort 
by. - `order={asc|desc}` (TEXT, default `asc`). * * * * * ### Example JSON 
Responses 1. `GET 
/events?near_waypoint_id=123&start_date=2025-07-01&event_type_codes=food_wine_sa
gra&lang=it` JSON ``` { "pagination": { "current_page": 1, "per_page": 20, 
"total_items": 1, "total_pages": 1 }, "data": [ { "waypoint_id": 123, 
"waypoint_name": { // Name from waypoints table, translated "default": "Piazza 
Centrale di Assisi", "translations": { "it": "Piazza Centrale di Assisi" } }, 
"event_name_official": { "default": "Assisi Annual Summer Food Fair", 
"translations": { "it": "Sagra Estiva di Assisi" } }, "start_datetime": 
"2025-07-15T18:00:00Z", "end_datetime": "2025-07-18T23:00:00Z", "event_type": { 
"code": "food_wine_sagra", "name": { // Name from event_types_master, 
translated "default": "Food/Wine Festival (Sagra)", "translations": { "it": 
"Sagra Enogastronomica" } }, "icon_identifier": "icon-event-sagra" }, 
"recurrence_frequency": null, // Example: not recurring or not specified 
"date_certainty_level": { "code": "confirmed_specific_dates", "name": { // Name 
from event_date_certainty_levels_master, translated "default": "Confirmed 
Specific Dates", "translations": { "it": "Date Specifiche Confermate" } }, 
"advice": { // Advice from event_date_certainty_levels_master, translated 
"default": "Dates are confirmed. Plan with confidence.", "translations": { 
"it": "Le date sono confermate. Pianifica con fiducia." } } }, 
"attendance_scale": { "code": "medium_regional", "name": { // Name from 
event_attendance_scales_master, translated "default": "Medium - Regional 
Attraction", "translations": { "it": "Medio - Attrattiva Regionale" } }, 
"approximate_range": { // Range from event_attendance_scales_master, translated 
"default": "200 - 1,000", "translations": { "it": "200 - 1.000" } } }, 
"location_details_within_waypoint": { "default": "Main square", "translations": 
{ "it": "Piazza principale" } }, "event_website_or_social_media_url": 
"https://example.com/assisi-sagra" } ] } ``` 2. `GET /events/123?lang=it` JSON 
``` { "waypoint_id": 123, "waypoint_name": { "default": "Piazza Centrale di 
Assisi", "translations": { "it": "Piazza Centrale di Assisi" } }, 
"waypoint_latitude": 43.0700, "waypoint_longitude": 12.6170, 
"waypoint_visibility_status_code": "published", "event_name_official": { 
"default": "Assisi Annual Summer Food Fair", "translations": { "it": "Sagra 
Estiva di Assisi" } }, "event_type": { "code": "food_wine_sagra", "name": { 
"default": "Food/Wine Festival (Sagra)", "translations": { "it": "Sagra 
Enogastronomica" } }, "icon_identifier": "icon-event-sagra" }, 
"event_theme_or_focus_tag_ids": [5, 12], // IDs; client resolves to names via 
/tags endpoint if needed "description_long": { "default": "A wonderful fair 
celebrating local Umbrian cuisine and wines, held annually.", "translations": { 
"it": "Una meravigliosa sagra che celebra la cucina e i vini umbri locali, che 
si tiene ogni anno." } }, "start_datetime": "2025-07-15T18:00:00Z", 
"end_datetime": "2025-07-18T23:00:00Z", "is_recurring_event": true, 
"recurrence_frequency": { "code": "annually", "name": { "default": "Annually", 
"translations": { "it": "Annuale" } } }, "recurrence_detail_text": { "default": 
"Every year, the third weekend of July, Friday to Sunday.", "translations": { 
"it": "Ogni anno, il terzo fine settimana di luglio, da venerdÃ¬ a domenica." } 
}, "date_certainty_level": { "code": "confirmed_specific_dates", "name": { 
"default": "Confirmed Specific Dates", "translations": { "it": "Date Specifiche 
Confermate" } }, "advice": { "default": "Dates are confirmed. Plan with 
confidence.", "translations": { "it": "Le date sono confermate. Pianifica con 
fiducia." } } }, "exception_dates": null, 
"specific_next_occurrence_dates_text": { "default": "2025: July 15-18; 2026: 
July 14-17 (estimated)", "translations": { "it": "2025: 15-18 luglio; 2026: 
14-17 luglio (stimato)" } }, "organizer_name": { "default": "Assisi Local 
Council", "translations": { "it": "Comune di Assisi" } }, 
"event_website_or_social_media_url": "https://example.com/assisi-sagra", 
"contact_phone_event": "+39 075 XXX XXXX", "contact_email_event": 
"eventi@comune.assisi.pg.it", "entry_fee_or_ticket_info": { "default": "Free 
entry to the general fair, individual food/wine purchases.", "translations": { 
"it": "Ingresso gratuito alla fiera generale, acquisti individuali di 
cibo/vino." } }, "location_details_within_waypoint": { "default": "Main square 
and surrounding streets.", "translations": { "it": "Piazza principale e vie 
limitrofe." } }, "attendance_scale": { "code": "medium_regional", "name": { 
"default": "Medium - Regional Attraction", "translations": { "it": "Medio - 
Attrattiva Regionale" } }, "approximate_range": { "default": "200 - 1,000", 
"translations": { "it": "200 - 1.000" } } }, "impact_on_accommodation_notes": { 
"default": "Accommodation can be scarce; book well in advance.", 
"translations": { "it": "L'alloggio puÃ² essere scarso; prenotare con largo 
anticipo." } }, "impact_on_trail_access_notes": null, 
"impact_on_local_services_notes": { "default": "Restaurants and shops may have 
extended hours but expect crowds.", "translations": { "it": "Ristoranti e 
negozi potrebbero avere orari prolungati ma aspettatevi folla." } }, 
"general_impact_notes_for_pilgrims": null, "pilgrim_participation_info": null, 
"related_attraction_waypoint_id": null, "data_last_verified_at": 
"2025-03-01T10:00:00Z", "data_verified_by_user_display_name": "Sofia Admin", 
"created_by_user_display_name": "ContentManagerX", "event_detail_created_at": 
"2024-11-10T09:00:00Z", "event_detail_updated_at": "2025-03-01T10:00:00Z" } ``` 
3. `GET /event_types?lang=it` JSON ``` [ { "id": 1, "code": 
"religious_feast_day_procession", "name": { "default": "Religious 
Feast/Procession", "translations": { "it": "Festa Religiosa/Processione" } }, 
"description": { "default": "Celebrations related to religious feast days, 
often including processions.", "translations": { "it": "Celebrazioni legate a 
feste religiose, che spesso includono processioni." } }, "icon_identifier": 
"icon-event-religious", "sort_order": 10 }, { "id": 2, "code": 
"food_wine_sagra", "name": { "default": "Food/Wine Festival (Sagra)", 
"translations": { "it": "Sagra Enogastronomica" } }, "description": { 
"default": "Local festivals celebrating specific foods, wines, or agricultural 
products.", "translations": { "it": "Feste locali che celebrano cibi, vini o 
prodotti agricoli specifici." } }, "icon_identifier": "icon-event-sagra", 
"sort_order": 50 } // ... more event types ] ``` * * * * * ### Database-Support 
Analysis 1. Endpoint: `GET /events` (List Events) - Indexes: - Sufficient for 
basic filtering by `events_details.start_datetime` 
(`ix_events_details_start_datetime`). - If querying by `trail_id` or `route_id` 
becomes common, `events_details` would need a way to link to trails/routes 
(perhaps via `waypoints` relationships or directly if events can span broader 
areas). Assuming events are tied to specific `waypoints`, and `waypoints` are 
linked to trails/routes, the query might involve joins through `waypoints`. - 
`event_type_id` is indexed (`ix_events_details_event_type_id`). For filtering 
by `event_type_codes`, the application would first query `event_types_master` 
to get IDs for codes, then use `event_type_id IN (...)`. - 
`event_theme_or_focus_tag_ids` has a GIN index 
(`ix_events_details_event_theme_or_focus_tag_ids`), which is good for `@>` 
(contains) or `&&` (overlaps) operations. - Geo-spatial queries (`latitude`, 
`longitude`, `radius_km`) would require PostGIS extension and spatial indexes 
on `waypoints.geom`. - Join Complexity: - High. This endpoint will likely use 
the `public.event_details_enriched_view` (or similar logic in a function) to 
gather data from `events_details`, `waypoints`, and all the event-specific 
master tables. - The view itself handles many joins. Further joins to 
`public.translations` would be needed for each translatable field if not 
handled by a Supabase RPC function that encapsulates this. - Performance 
Gotchas: - RLS on `events_details` (checking parent `waypoints` status) will 
add overhead but is necessary. Ensuring `waypoints` and 
`content_statuses_master` are well-indexed for these RLS checks is key. - 
Complex date range queries combined with multiple filters (tags, types, geo) 
can be slow. Careful query construction and ensuring all filterable columns are 
indexed is crucial. - Pagination with `OFFSET` can be slow on large datasets; 
keyset pagination is preferred if performance becomes an issue. - Missing 
Data?: - No obvious missing data for core event discovery within the 
`events_details` and its master tables. The main dependency is well-structured 
`waypoints` data, including their geo-location and links to trails/routes. 2. 
Endpoint: `GET /events/{waypoint_id}` (Get Specific Event Details) - Indexes: - 
Primary key lookup on `events_details.waypoint_id` is efficient. - Join 
Complexity: - Similar to the list endpoint but for a single record. The 
`public.event_details_enriched_view` (queried with `WHERE waypoint_id = ...`) 
or an equivalent database function would be ideal to fetch all necessary data, 
including names from master tables. - Translations would add lookups to 
`public.translations`. - Performance Gotchas: - RLS on `events_details` still 
applies. - Minimal gotchas for a single PK lookup, assuming the view/function 
is optimized. - Missing Data?: No. 3. Endpoint: `GET /event_types` (and other 
master data endpoints) - Indexes: - `event_types_master.id` (PK), 
`event_types_master.code` (UNIQUE), `ix_event_types_master_active_sort` are 
sufficient. Similar indexes exist for other master tables. - Join Complexity: - 
Low for fetching the master data itself. - If translations are included 
directly in the response (as shown in the example), it requires a join to 
`public.translations` for each record and each translatable field. A Supabase 
RPC function could assemble this. - Performance Gotchas: - RLS on master tables 
(checking `is_active`) is simple. - Tables are small, so performance should be 
good. - Missing Data?: No. * * * * * ### Immediate Schema Tweaks (if any) 1. ðŸ”´ 
`tags_master.is_active` Column: The `check_event_theme_tags_exist()` trigger 
for `events_details.event_theme_or_focus_tag_ids` was updated to check 
`tags_master.is_active`. The `tags_master` table (from Module 4 Waypoints - 
General) must have an `is_active BOOLEAN NOT NULL DEFAULT true` column and 
appropriate indexes. - *Rationale*: Ensures that events are not linked to 
inactive/retired tags. This implies a review of `tags_master` spec. 2. ðŸŸ  
`waypoints` table fields for View: The `public.event_details_enriched_view` 
assumes `waypoints` has `default_name` (for waypoint's primary language name) 
and `content_visibility_status_id` (linking to `content_statuses_master.id`). 
It also assumes `content_statuses_master` has an `is_active` flag. These need 
to be confirmed or adjusted in the view based on the final `waypoints` and 
`content_statuses_master` schemas. - *Rationale*: Ensures the view can 
correctly pull necessary contextual information from the parent waypoint. 3. ðŸŸ¢ 
Geo-spatial Index on `waypoints`: If `GET /events` with geo-filters 
(`latitude`, `longitude`, `radius_km`) is a priority, the `waypoints` table 
needs a PostGIS `GEOGRAPHY` or `GEOMETRY` column and a spatial index (e.g., 
GIST) on it. - *Rationale*: Essential for performant location-based event 
searches. This is more of a `waypoints` table concern but impacts this API. 4. 
ðŸŸ¢ `icon_identifier` for other Event Master Tables: `event_types_master` has 
`icon_identifier`. Consider if `event_recurrence_frequencies_master`, 
`event_attendance_scales_master`, or `event_date_certainty_levels_master` would 
benefit from an `icon_identifier` field for richer UI representation, though 
it's not critical. - *Rationale*: Potential UI enhancement for consistency if 
icons are desired for these attributes. 
