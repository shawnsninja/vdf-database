# 4.23 event_attendance_scales_master

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/0e3ccfac5f6b71bb ### Updated Production-Ready 
Specification: `public.event_attendance_scales_master` Version: 1.1 (Based on 
original 1.0 with V2.1 Checklist & i18n correction Applied) Date: May 18, 2025 
#### 1\. Purpose & Primary Use-Cases The `event_attendance_scales_master` table 
defines standardized categories for the expected attendance or crowd size of an 
event (e.g., "Small - Local," "Medium - Regional," "Large - National"). Its 
purpose is to provide pilgrims with a general understanding of an event's 
scale, helping them gauge potential impacts on crowds, accommodation 
availability, and overall experience, using consistent and translatable terms. 
#### 2\. Schema | column | data_type | constraints | description | | `id` | 
`INTEGER` | `Primary Key, Generated always as identity` | Unique identifier for 
the event attendance scale. | | `code` | `TEXT` | `Unique, Not Null, CHECK 
(length(code) > 0 AND length(code) <= 50 AND code ~ '^[a-z0-9_]+$')` | Short, 
stable, machine-readable code (e.g., 'small_local', 'large_national'). 
Snake_case. | | `default_name` | `TEXT` | `Not Null, CHECK 
(length(default_name) > 0 AND length(default_name) <= 100)` | Human-readable 
name in the primary reference language. (Translatable via 
`public.translations`) | | `default_description` | `TEXT` | `Nullable` | 
Optional description in the primary reference language providing more context. 
(Translatable via `public.translations`) | | `approximate_range` | `TEXT` | 
`Nullable, CHECK (approximate_range IS NULL OR length(approximate_range) <= 
50)` | Optional textual representation of attendance numbers (e.g., "Under 
100"). (Translatable via `public.translations`) | | `sort_order` | `INTEGER` | 
`Not Null, Default 0` | Determines the display order in UI lists or filters. | 
| `is_active` | `BOOLEAN` | `Not Null, Default true` | If true, this attendance 
scale is active and can be used. | | `created_at` | `TIMESTAMPTZ` | `Not Null, 
Default now()` | Timestamp of record creation. | | `updated_at` | `TIMESTAMPTZ` 
| `Not Null, Default now()` | Timestamp of last update (auto-updated by 
trigger). | | `created_by_profile_id` | `UUID` | `Nullable, Foreign Key to 
public.profiles(id) ON DELETE SET NULL` | Profile ID of the user who created 
this record. | | `updated_by_profile_id` | `UUID` | `Nullable, Foreign Key to 
public.profiles(id) ON DELETE SET NULL` | Profile ID of the user who last 
updated this record. | #### 3\. PostgreSQL DDL SQL ``` CREATE TABLE 
public.event_attendance_scales_master ( id INTEGER GENERATED ALWAYS AS IDENTITY 
PRIMARY KEY, code TEXT UNIQUE NOT NULL CHECK (length(code) > 0 AND length(code) 
<= 50 AND code ~ '^[a-z0-9_]+$'), default_name TEXT NOT NULL CHECK 
(length(default_name) > 0 AND length(default_name) <= 100), default_description 
TEXT NULL, approximate_range TEXT NULL CHECK (approximate_range IS NULL OR 
length(approximate_range) <= 50), sort_order INTEGER NOT NULL DEFAULT 0, 
is_active BOOLEAN NOT NULL DEFAULT true, created_at TIMESTAMPTZ NOT NULL 
DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), 
created_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE SET 
NULL, updated_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE 
SET NULL ); COMMENT ON TABLE public.event_attendance_scales_master IS 'Master 
list of event attendance scales (e.g., small, medium, large). Replaces 
event_attendance_scale_enum. Version 1.1'; COMMENT ON COLUMN 
public.event_attendance_scales_master.id IS 'Unique identifier for the event 
attendance scale. Primary Key.'; COMMENT ON COLUMN 
public.event_attendance_scales_master.code IS 'Short, stable, machine-readable 
code (snake_case). Max 50 chars. Must be unique.'; COMMENT ON COLUMN 
public.event_attendance_scales_master.default_name IS 'Human-readable name in 
the primary reference language. (Translatable via public.translations). Max 100 
chars.'; COMMENT ON COLUMN 
public.event_attendance_scales_master.default_description IS 'Optional 
description in the primary reference language of the attendance scale. 
(Translatable via public.translations).'; COMMENT ON COLUMN 
public.event_attendance_scales_master.approximate_range IS 'Optional textual 
representation of attendance numbers (e.g., "Under 100", "1,000-5,000"). 
(Translatable via public.translations). Max 50 chars.'; COMMENT ON COLUMN 
public.event_attendance_scales_master.sort_order IS 'Determines the display 
order in UI lists or filters.'; COMMENT ON COLUMN 
public.event_attendance_scales_master.is_active IS 'If true, this attendance 
scale is active and can be used.'; COMMENT ON COLUMN 
public.event_attendance_scales_master.created_at IS 'Timestamp of record 
creation.'; COMMENT ON COLUMN public.event_attendance_scales_master.updated_at 
IS 'Timestamp of last update (auto-updated by trigger).'; COMMENT ON COLUMN 
public.event_attendance_scales_master.created_by_profile_id IS 'Profile ID of 
the user who created this record. FK to public.profiles(id).'; COMMENT ON 
COLUMN public.event_attendance_scales_master.updated_by_profile_id IS 'Profile 
ID of the user who last updated this record. FK to public.profiles(id).'; -- 
Indexes CREATE INDEX ix_event_attendance_scales_master_active_sort ON 
public.event_attendance_scales_master (is_active, sort_order); CREATE INDEX 
ix_event_attendance_scales_master_created_by ON 
public.event_attendance_scales_master (created_by_profile_id) WHERE 
created_by_profile_id IS NOT NULL; CREATE INDEX 
ix_event_attendance_scales_master_updated_by ON 
public.event_attendance_scales_master (updated_by_profile_id) WHERE 
updated_by_profile_id IS NOT NULL; ``` #### 4\. Triggers/Functions SQL ``` -- 
Standard updated_at trigger CREATE TRIGGER 
handle_event_attendance_scales_master_updated_at BEFORE UPDATE ON 
public.event_attendance_scales_master FOR EACH ROW EXECUTE FUNCTION 
extensions.moddatetime('updated_at'); -- Or 
public.set_current_timestamp_updated_at() COMMENT ON TRIGGER 
handle_event_attendance_scales_master_updated_at ON 
public.event_attendance_scales_master IS 'Trigger to automatically update 
updated_at timestamp on row modification.'; -- Orphaned translation cleanup 
trigger CREATE OR REPLACE FUNCTION 
public.cleanup_event_attendance_scales_master_translations() RETURNS TRIGGER AS 
$$ BEGIN DELETE FROM public.translations WHERE table_identifier = 
'event_attendance_scales_master' AND column_identifier IN ('default_name', 
'default_description', 'approximate_range') -- Specify translatable columns AND 
row_foreign_key = OLD.id::TEXT; RETURN OLD; END; $$ LANGUAGE plpgsql SECURITY 
DEFINER; COMMENT ON FUNCTION 
public.cleanup_event_attendance_scales_master_translations() IS 'Cleans up 
orphaned translations from public.translations when an 
event_attendance_scales_master record is deleted. Runs as SECURITY DEFINER.'; 
CREATE TRIGGER trigger_cleanup_event_attendance_scales_master_translations 
AFTER DELETE ON public.event_attendance_scales_master FOR EACH ROW EXECUTE 
FUNCTION public.cleanup_event_attendance_scales_master_translations(); COMMENT 
ON TRIGGER trigger_cleanup_event_attendance_scales_master_translations ON 
public.event_attendance_scales_master IS 'After deleting an attendance scale, 
remove its associated translations from the public.translations table.'; ``` 
*(Assumption: `extensions.moddatetime` is available or 
`public.set_current_timestamp_updated_at()` is defined, and 
`public.translations` table exists).* #### 5\. JSON Schema Mirror JSON ``` { 
"title": "event_attendance_scale_master", "description": "Master list of event 
attendance scales (e.g., small, medium, large). Replaces 
event_attendance_scale_enum. Version 1.1.", "type": "object", "properties": { 
"id": { "type": "integer", "description": "Unique identifier. Primary Key.", 
"readOnly": true }, "code": { "type": "string", "description": "Short, stable, 
machine-readable code (snake_case). Max 50 chars. Must be unique.", "pattern": 
"^[a-z0-9_]+$", "maxLength": 50 }, "default_name": { "type": "string", 
"description": "Human-readable name in the primary reference language. 
(Translatable via public.translations). Max 100 chars.", "maxLength": 100 }, 
"default_description": { "type": ["string", "null"], "description": "Optional 
description in the primary reference language of the attendance scale. 
(Translatable via public.translations)." }, "approximate_range": { "type": 
["string", "null"], "maxLength": 50, "description": "Optional textual 
representation of attendance numbers (e.g., \"Under 100\", \"1,000-5,000\"). 
(Translatable via public.translations)." }, "sort_order": { "type": "integer", 
"default": 0, "description": "Determines the display order in UI lists or 
filters." }, "is_active": { "type": "boolean", "default": true, "description": 
"If true, this attendance scale is active and can be used." }, "created_at": { 
"type": "string", "format": "date-time", "description": "Timestamp of record 
creation.", "readOnly": true }, "updated_at": { "type": "string", "format": 
"date-time", "description": "Timestamp of last update (auto-updated by 
trigger).", "readOnly": true }, "created_by_profile_id": { "type": ["string", 
"null"], "format": "uuid", "description": "Profile ID of the user who created 
this record. FK to public.profiles(id)." }, "updated_by_profile_id": { "type": 
["string", "null"], "format": "uuid", "description": "Profile ID of the user 
who last updated this record. FK to public.profiles(id)." } }, "required": [ 
"code", "default_name", "sort_order", "is_active" ], "primary_key": ["id"], 
"unique_constraints": [ {"columns": ["code"], "name": 
"event_attendance_scales_master_code_key"} ], "foreign_keys": [ {"columns": 
["created_by_profile_id"], "references_table": "public.profiles", 
"references_columns": ["id"], "on_delete": "SET NULL"}, {"columns": 
["updated_by_profile_id"], "references_table": "public.profiles", 
"references_columns": ["id"], "on_delete": "SET NULL"} ] } ``` #### 6\. 
Relationships & Integrity - Primary Key: `id` (INTEGER) - Unique Constraint: 
`code` must be unique. - Foreign Key References FROM other tables: - 
`events_details.expected_attendance_scale_id` will reference 
`event_attendance_scales_master.id`. Recommend `ON DELETE RESTRICT`. - Array 
Foreign Key: None. #### 7\. Multilingual Strategy - `default_name`: Name in the 
primary reference language. (Translatable via `public.translations`) - 
`default_description`: Description in the primary reference language. 
(Translatable via `public.translations`) - `approximate_range`: Textual range 
in the primary reference language. (Translatable via `public.translations`) - 
An `AFTER DELETE` trigger 
(`trigger_cleanup_event_attendance_scales_master_translations`) ensures 
orphaned translations are removed. #### 8\. Role-Based Workflow & RLS Notes - 
Key Fields: `is_active`. - RLS Policies: - 🟢 Allow public read access to 
active scales. SQL ``` CREATE POLICY "Allow public read access to active event 
attendance scales" ON public.event_attendance_scales_master FOR SELECT USING 
(is_active = true); ``` - 🟢 Allow platform admins to manage scales. SQL ``` 
CREATE POLICY "Allow platform admins to manage event attendance scales" ON 
public.event_attendance_scales_master FOR ALL USING ( auth.role() = 
'authenticated' AND (SELECT public.has_role_on_profile(auth.uid(), 
'admin_platform') OR public.has_role_on_profile(auth.uid(), 'admin_super')) ) 
WITH CHECK ( auth.role() = 'authenticated' AND (SELECT 
public.has_role_on_profile(auth.uid(), 'admin_platform') OR 
public.has_role_on_profile(auth.uid(), 'admin_super')) ); ``` - 🟠 `ON DELETE 
RESTRICT` from `events_details` (when defined) is preferred. #### 9\. ENUM vs 
Lookup Discussion - 🟢 Decision: This table `event_attendance_scales_master` 
*is* the result of promoting the original `event_attendance_scale_enum`. - 
Reason: Allows for translatable names, nuanced descriptions (including 
approximate number ranges), and a controlled vocabulary. #### 10\. UI/UX 
Enablement - `default_name` (translated): For displaying the attendance scale. 
- `default_description` (translated): Can be used for tooltips. - 
`approximate_range` (translated): Can provide a more concrete idea of numbers. 
- `sort_order`: To list scales logically. - `is_active`: Filters values for 
admin UIs. #### 11\. Auditing & Lifecycle Management - Audit Columns: 
`created_at`, `updated_at`, `created_by_profile_id`, `updated_by_profile_id`. - 
Lifecycle: `is_active` flag. #### 12\. Scalability & Future-Proofing - 
Manageable List: The number of distinct attendance scales will be small. - 
Flexibility: Easy to refine descriptions or add a new scale. #### 13\. Seed 
Data (V1.1) | code | default_name | sort_order | default_description | 
approximate_range | is_active | created_by_profile_id | updated_by_profile_id | 
| 'small_local' | 'Small - Local Gathering' | 10 | 'Primarily attended by the 
local community; minimal impact on wider resources.' | 'Under 200' | true | 
`[ADMIN_UUID]` | `[ADMIN_UUID]` | | 'medium_regional' | 'Medium - Regional 
Attraction' | 20 | 'Attracts visitors from the surrounding region; noticeable 
increase in local activity.' | '200 - 1,000' | true | `[ADMIN_UUID]` | 
`[ADMIN_UUID]` | | 'large_national' | 'Large - National Interest' | 30 | 'Draws 
attendees from across the country; significant impact on local resources and 
accommodation likely.' | '1,000 - 10,000' | true | `[ADMIN_UUID]` | 
`[ADMIN_UUID]` | | 'massive_international' | 'Massive - International Event' | 
40 | 'Major event attracting international visitors; expect extensive crowds 
and resource strain.' | '10,000+' | true | `[ADMIN_UUID]` | `[ADMIN_UUID]` | | 
'variable_attendance' | 'Variable Attendance' | 50 | 'Attendance can vary 
significantly year to year or based on specific factors.' | 'Varies' | true | 
`[ADMIN_UUID]` | `[ADMIN_UUID]` | *(Note: `[ADMIN_UUID]` is a placeholder for 
an actual admin/system user profile ID used for seeding.)* #### 14\. 
Next-Action Checklist - 🔴 Create Table: Execute DDL for 
`public.event_attendance_scales_master`. - 🔴 Create Indexes: Execute DDL for 
new indexes. - 🔴 Implement `updated_at` Trigger. - 🔴 Implement Orphan 
Translation Cleanup Trigger (after `public.translations` and function exist). - 
🔴 RLS Policies: Review and apply. Ensure helper functions are available. - 🔴 
Seed Data: Insert initial V1.1 data. - 🟢 Population Logic: Define application 
layer logic for audit FKs. - 🟢 Review ON DELETE for FK from `events_details` 
(recommend `ON DELETE RESTRICT`). 
