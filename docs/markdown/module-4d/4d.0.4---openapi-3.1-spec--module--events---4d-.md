# 4d.0.4 - OpenAPI 3.1 Spec (Module_ events - 4d)

  https://gemini.google.com/u/1/app/0e3ccfac5f6b71bb ### OpenAPI 3.1 Spec 
(Module: events - 4d) YAML ``` openapi: 3.1.0 info: title: Pilgrimage Platform 
- Events API version: v1.0.0 description: API for managing and retrieving event 
information related to pilgrimage waypoints. servers: - url: 
https://<your-project-ref>.supabase.co/rest/v1 # Replace with your actual 
Supabase URL description: Supabase Production Server - url: 
http://localhost:54321/rest/v1 # For local Supabase development via Docker 
description: Local Supabase Server components: securitySchemes: BearerAuth: 
type: http scheme: bearer bearerFormat: JWT description: Supabase JWT for 
authenticated requests. parameters: LangParameter: name: lang in: query 
description: ISO language code for translatable content (e.g., 'it', 'en'). 
required: false schema: type: string example: 'it' PageParameter: name: page 
in: query description: Page number for pagination. required: false schema: 
type: integer default: 1 minimum: 1 PageSizeParameter: name: page_size in: 
query description: Number of items per page for pagination. required: false 
schema: type: integer default: 20 minimum: 1 maximum: 100 
WaypointIdPathParameter: name: waypoint_id in: path required: true description: 
The unique identifier of the waypoint associated with the event. schema: type: 
integer format: int64 EventTypeIdPathParameter: name: event_type_id in: path 
required: true description: The unique identifier of the event type. schema: 
type: integer EventRecurrenceFrequencyIdPathParameter: name: frequency_id in: 
path required: true description: The unique identifier of the event recurrence 
frequency. schema: type: integer EventAttendanceScaleIdPathParameter: name: 
scale_id in: path required: true description: The unique identifier of the 
event attendance scale. schema: type: integer 
EventDateCertaintyLevelIdPathParameter: name: level_id in: path required: true 
description: The unique identifier of the event date certainty level. schema: 
type: integer schemas: ErrorResponse: type: object properties: message: type: 
string description: A human-readable summary of the error. code: type: string 
description: PostgREST error code or custom application error code. details: 
type: string nullable: true description: More specific details or structural 
information about the error. hint: type: string nullable: true description: 
Optional hint on how to resolve the error. required: - message - code 
Pagination: type: object properties: current_page: type: integer per_page: 
type: integer total_items: type: integer total_pages: type: integer required: - 
current_page - per_page - total_items - total_pages TranslationsMap: # Reusable 
schema for the translations object type: object description: Key-value pairs of 
language codes to translated text. additionalProperties: type: string example: 
it: "Testo tradotto" fr: "Texte traduit" EventTypeMaster: type: object 
description: Defines a category or type of event. properties: id: type: integer 
format: int32 readOnly: true code: type: string maxLength: 50 default_name: 
type: string maxLength: 100 description: Name in the primary reference 
language. name_translations: # Translations for default_name $ref: 
'#/components/schemas/TranslationsMap' default_description: type: string 
nullable: true description: Description in the primary reference language. 
description_translations: # Translations for default_description $ref: 
'#/components/schemas/TranslationsMap' icon_identifier: type: string nullable: 
true maxLength: 100 sort_order: type: integer default: 0 is_active: type: 
boolean default: true created_at: type: string format: date-time readOnly: true 
updated_at: type: string format: date-time readOnly: true 
created_by_profile_id: type: string format: uuid nullable: true readOnly: true 
updated_by_profile_id: type: string format: uuid nullable: true readOnly: true 
required: - code - default_name - sort_order - is_active 
EventRecurrenceFrequencyMaster: type: object description: Defines standard 
terms for event recurrence frequency. properties: id: type: integer format: 
int32 readOnly: true code: type: string maxLength: 50 default_name: type: 
string maxLength: 100 description: Name in the primary reference language. 
name_translations: $ref: '#/components/schemas/TranslationsMap' 
default_description: type: string nullable: true description: Description in 
the primary reference language. description_translations: $ref: 
'#/components/schemas/TranslationsMap' sort_order: type: integer default: 0 
is_active: type: boolean default: true # Standard audit columns (created_at, 
etc.) would be here required: - code - default_name - sort_order - is_active 
EventAttendanceScaleMaster: type: object description: Defines categories for 
expected event attendance size. properties: id: type: integer format: int32 
readOnly: true code: type: string maxLength: 50 default_name: type: string 
maxLength: 100 description: Name in the primary reference language. 
name_translations: $ref: '#/components/schemas/TranslationsMap' 
default_description: type: string nullable: true description: Description in 
the primary reference language. description_translations: $ref: 
'#/components/schemas/TranslationsMap' approximate_range: # This field itself 
is translatable type: string nullable: true maxLength: 50 description: Textual 
representation of attendance numbers (primary reference language). 
approximate_range_translations: $ref: '#/components/schemas/TranslationsMap' 
sort_order: type: integer default: 0 is_active: type: boolean default: true # 
Standard audit columns would be here required: - code - default_name - 
sort_order - is_active EventDateCertaintyLevelMaster: type: object description: 
Defines confidence levels for future event dates. properties: id: type: integer 
format: int32 readOnly: true code: type: string maxLength: 50 default_name: 
type: string maxLength: 100 description: Name in the primary reference 
language. name_translations: $ref: '#/components/schemas/TranslationsMap' 
default_description: type: string nullable: true description: Description in 
the primary reference language. description_translations: $ref: 
'#/components/schemas/TranslationsMap' default_advice: type: string nullable: 
true description: Specific advice for pilgrims in the primary reference 
language. advice_translations: $ref: '#/components/schemas/TranslationsMap' 
sort_order: type: integer default: 0 is_active: type: boolean default: true # 
Standard audit columns would be here required: - code - default_name - 
sort_order - is_active EventDetail: # Base schema for event details data type: 
object description: Detailed information for an event linked to a waypoint. 
properties: waypoint_id: type: integer format: int64 
default_event_name_official: type: string maxLength: 255 
event_name_official_translations: $ref: '#/components/schemas/TranslationsMap' 
event_type_id: type: integer event_theme_or_focus_tag_ids: type: array items: { 
type: integer } nullable: true default_description_long: type: string nullable: 
true description_long_translations: $ref: 
'#/components/schemas/TranslationsMap' start_datetime: type: string format: 
date-time end_datetime: type: string format: date-time nullable: true 
is_recurring_event: type: boolean default: false recurrence_frequency_id: type: 
integer nullable: true default_recurrence_detail_text: type: string nullable: 
true recurrence_detail_text_translations: $ref: 
'#/components/schemas/TranslationsMap' future_date_estimation_level_id: type: 
integer nullable: true exception_dates: type: array items: { type: string, 
format: date } nullable: true default_specific_next_occurrence_dates_text: 
type: string nullable: true specific_next_occurrence_dates_text_translations: 
$ref: '#/components/schemas/TranslationsMap' default_organizer_name: type: 
string nullable: true maxLength: 200 organizer_name_translations: $ref: 
'#/components/schemas/TranslationsMap' event_website_or_social_media_url: type: 
string format: url nullable: true maxLength: 2048 contact_phone_event: type: 
string nullable: true maxLength: 50 contact_email_event: type: string format: 
email nullable: true maxLength: 254 default_entry_fee_or_ticket_info: type: 
string nullable: true entry_fee_or_ticket_info_translations: $ref: 
'#/components/schemas/TranslationsMap' 
default_location_details_within_waypoint: type: string nullable: true 
location_details_within_waypoint_translations: $ref: 
'#/components/schemas/TranslationsMap' expected_attendance_scale_id: type: 
integer nullable: true default_impact_on_accommodation_notes: type: string 
nullable: true impact_on_accommodation_notes_translations: $ref: 
'#/components/schemas/TranslationsMap' default_impact_on_trail_access_notes: 
type: string nullable: true impact_on_trail_access_notes_translations: $ref: 
'#/components/schemas/TranslationsMap' default_impact_on_local_services_notes: 
type: string nullable: true impact_on_local_services_notes_translations: $ref: 
'#/components/schemas/TranslationsMap' 
default_general_impact_notes_for_pilgrims: type: string nullable: true 
general_impact_notes_for_pilgrims_translations: $ref: 
'#/components/schemas/TranslationsMap' default_pilgrim_participation_info: 
type: string nullable: true pilgrim_participation_info_translations: $ref: 
'#/components/schemas/TranslationsMap' related_attraction_waypoint_id: type: 
integer format: int64 nullable: true data_last_verified_at: type: string 
format: date-time nullable: true data_verified_by_profile_id: type: string 
format: uuid nullable: true created_at: type: string format: date-time 
readOnly: true created_by_profile_id: type: string format: uuid nullable: true 
updated_at: type: string format: date-time readOnly: true 
updated_by_profile_id: type: string format: uuid nullable: true deleted_at: 
type: string format: date-time nullable: true readOnly: true required: - 
waypoint_id - default_event_name_official - event_type_id - start_datetime - 
is_recurring_event EventDetailEnriched: # Schema for GET /events/{waypoint_id} 
and list items allOf: - $ref: '#/components/schemas/EventDetail' - type: object 
properties: waypoint_default_name: { type: string, nullable: true } 
waypoint_default_name_translations: { $ref: 
'#/components/schemas/TranslationsMap' } waypoint_latitude: { type: number, 
format: double, nullable: true } waypoint_longitude: { type: number, format: 
double, nullable: true } waypoint_visibility_status_code: { type: string, 
nullable: true } event_type_name: { type: string, nullable: true, description: 
"Name of the event type (default or translated based on lang param)" } 
event_type_name_translations: { $ref: '#/components/schemas/TranslationsMap' } 
event_type_code: { type: string, nullable: true } event_type_icon_identifier: { 
type: string, nullable: true } recurrence_frequency_name: { type: string, 
nullable: true } recurrence_frequency_name_translations: { $ref: 
'#/components/schemas/TranslationsMap' } recurrence_frequency_code: { type: 
string, nullable: true } date_certainty_level_name: { type: string, nullable: 
true } date_certainty_level_name_translations: { $ref: 
'#/components/schemas/TranslationsMap' } date_certainty_level_code: { type: 
string, nullable: true } date_certainty_level_advice: { type: string, nullable: 
true } date_certainty_level_advice_translations: { $ref: 
'#/components/schemas/TranslationsMap' } attendance_scale_name: { type: string, 
nullable: true } attendance_scale_name_translations: { $ref: 
'#/components/schemas/TranslationsMap' } attendance_scale_code: { type: string, 
nullable: true } attendance_scale_approximate_range: { type: string, nullable: 
true } attendance_scale_approximate_range_translations: { $ref: 
'#/components/schemas/TranslationsMap' } related_attraction_waypoint_name: { 
type: string, nullable: true } related_attraction_waypoint_name_translations: { 
$ref: '#/components/schemas/TranslationsMap' } 
data_verified_by_user_display_name: { type: string, nullable: true } 
created_by_user_display_name: { type: string, nullable: true } 
updated_by_user_display_name: { type: string, nullable: true } 
EventDetailCreation: # For POST /events type: object allOf: - $ref: 
'#/components/schemas/EventDetail' # For creation, waypoint_id is required. 
Other readOnly fields are not part of request. # Example of removing readOnly 
properties for a request body (not fully fleshed out here for brevity): # 
properties: (list only writable fields) EventDetailUpdate: # For PATCH 
/events/{waypoint_id} type: object description: Data for updating an existing 
event detail record. All fields are optional for PATCH. properties: # All 
properties from EventDetail, but none are required default_event_name_official: 
{ type: string, maxLength: 255, nullable: true } 
event_name_official_translations: { $ref: 
'#/components/schemas/TranslationsMap', nullable: true } # Allow updating 
translations event_type_id: { type: integer, nullable: true } # ... all other 
updatable fields from EventDetail, marked as nullable: true start_datetime: { 
type: string, format: date-time, nullable: true } # etc. security: - 
BearerAuth: [] paths: /events: get: summary: List Events description: Retrieves 
a list of events. # Utilizes the event_details_enriched_view or similar 
server-side logic. operationId: listEvents tags: ["Events"] parameters: - $ref: 
'#/components/parameters/LangParameter' - $ref: 
'#/components/parameters/PageParameter' - $ref: 
'#/components/parameters/PageSizeParameter' - name: near_waypoint_id in: query 
schema: { type: integer, format: int64 } - name: start_date in: query schema: { 
type: string, format: date } - name: end_date in: query schema: { type: string, 
format: date } - name: event_type_codes # Comma-separated string of codes in: 
query schema: { type: string } responses: '200': description: A paginated list 
of enriched event details. content: application/json: schema: type: object 
properties: pagination: { $ref: '#/components/schemas/Pagination' } data: type: 
array items: { $ref: '#/components/schemas/EventDetailEnriched' } default: { 
$ref: '#/components/responses/DefaultError' } post: summary: Create Event 
Detail description: Creates a new event detail record. Assumes `waypoint_id` is 
provided in the body. operationId: createEventDetail tags: ["Events"] 
requestBody: required: true content: application/json: schema: { $ref: 
'#/components/schemas/EventDetailCreation' } responses: '201': description: 
Event detail created. content: application/json: { schema: { $ref: 
'#/components/schemas/EventDetail' } } default: { $ref: 
'#/components/responses/DefaultError' } /events/{waypoint_id}: get: summary: 
Get Event Detail by Waypoint ID description: Retrieves detailed information for 
a specific event. # Utilizes the event_details_enriched_view or similar 
server-side logic. operationId: getEventDetailByWaypointId tags: ["Events"] 
parameters: - $ref: '#/components/parameters/WaypointIdPathParameter' - $ref: 
'#/components/parameters/LangParameter' responses: '200': description: Detailed 
information about the event. content: application/json: { schema: { $ref: 
'#/components/schemas/EventDetailEnriched' } } default: { $ref: 
'#/components/responses/DefaultError' } patch: summary: Update Event Detail 
description: Partially updates an existing event detail record. operationId: 
updateEventDetail tags: ["Events"] parameters: - $ref: 
'#/components/parameters/WaypointIdPathParameter' requestBody: required: true 
content: application/json: schema: { $ref: 
'#/components/schemas/EventDetailUpdate' } responses: '200': description: Event 
detail updated. content: application/json: { schema: { $ref: 
'#/components/schemas/EventDetail' } } default: { $ref: 
'#/components/responses/DefaultError' } /event_types: get: summary: List Event 
Types description: Retrieves a list of all available event types. operationId: 
listEventTypes tags: ["Events Master Data"] parameters: - $ref: 
'#/components/parameters/LangParameter' responses: '200': description: A list 
of event types. content: application/json: schema: type: array items: { $ref: 
'#/components/schemas/EventTypeMaster' } default: { $ref: 
'#/components/responses/DefaultError' } # For brevity, GET by ID for 
/event_types and full CRUD for other master tables are omitted, # but would 
follow similar patterns to /event_types and /events respectively if needed. # 
List endpoints for other master tables: /event_recurrence_frequencies: get: 
summary: List Event Recurrence Frequencies tags: ["Events Master Data"] 
parameters: [- $ref: '#/components/parameters/LangParameter'] responses: '200': 
description: A list of event recurrence frequencies. content: application/json: 
schema: type: array items: { $ref: 
'#/components/schemas/EventRecurrenceFrequencyMaster' } default: { $ref: 
'#/components/responses/DefaultError' } /event_attendance_scales: get: summary: 
List Event Attendance Scales tags: ["Events Master Data"] parameters: [- $ref: 
'#/components/parameters/LangParameter'] responses: '200': description: A list 
of event attendance scales. content: application/json: schema: type: array 
items: { $ref: '#/components/schemas/EventAttendanceScaleMaster' } default: { 
$ref: '#/components/responses/DefaultError' } /event_date_certainty_levels: 
get: summary: List Event Date Certainty Levels tags: ["Events Master Data"] 
parameters: [- $ref: '#/components/parameters/LangParameter'] responses: '200': 
description: A list of event date certainty levels. content: application/json: 
schema: type: array items: { $ref: 
'#/components/schemas/EventDateCertaintyLevelMaster' } default: { $ref: 
'#/components/responses/DefaultError' } responses: # Shared response components 
NotFound: description: The specified resource was not found. content: { 
application/json: { schema: { $ref: '#/components/schemas/ErrorResponse'}}} 
DefaultError: description: An unexpected error occurred. content: { 
application/json: { schema: { $ref: '#/components/schemas/ErrorResponse'}}} ``` 
* * * * * ### Quick-Start Examples 1. List upcoming cultural festivals (default 
language): Bash ``` curl -X GET\ 
'https://<your-project-ref>.supabase.co/rest/v1/events?start_date=2025-07-01&eve
nt_type_codes=cultural_historical_festival&page_size=3'\ -H 'apikey: 
<YOUR_SUPABASE_ANON_KEY>'\ -H 'Authorization: Bearer 
<YOUR_USER_JWT_IF_AUTHENTICATED_ACCESS_IS_NEEDED>' ``` Sample Response Snippet: 
JSON ``` { "pagination": { "current_page": 1, "per_page": 3, "total_items": 1, 
"total_pages": 1 }, "data": [ { "waypoint_id": 789, "waypoint_default_name": 
"Old Town Square", "default_event_name_official": "Medieval Times Revival", 
"event_name_official_translations": { "it": "Rievocazione Tempi Medievali" }, 
"start_datetime": "2025-08-10T10:00:00Z", "event_type_name": 
"Cultural/Historical Festival", "event_type_code": 
"cultural_historical_festival" } ] } ``` 2. Get specific event details for 
waypoint ID 789, requesting Italian: Bash ``` curl -X GET\ 
'https://<your-project-ref>.supabase.co/rest/v1/events/789?lang=it'\ -H 
'apikey: <YOUR_SUPABASE_ANON_KEY>'\ -H 'Authorization: Bearer 
<YOUR_USER_JWT_IF_AUTHENTICATED_ACCESS_IS_NEEDED>' ``` Sample Response Snippet: 
JSON ``` { "waypoint_id": 789, "waypoint_default_name": "Piazza della Città 
Vecchia", // Assuming lang=it makes this Italian 
"waypoint_default_name_translations": { "en": "Old Town Square" }, 
"default_event_name_official": "Rievocazione Tempi Medievali", 
"event_name_official_translations": { "en": "Medieval Times Revival" }, 
"start_datetime": "2025-08-10T10:00:00Z", "event_type_name": "Festival 
Culturale/Storico", // Translated from event_types_master 
"default_description_long": "Una fantastica rievocazione della vita medievale 
con spettacoli e mercati.", "description_long_translations": { "en": "A 
fantastic reenactment of medieval life with shows and markets." } } ``` 3. 
Update (PATCH) event details for waypoint ID 789 (requires auth): Bash ``` curl 
-X PATCH\ 
'https://<your-project-ref>.supabase.co/rest/v1/events?waypoint_id=eq.789'\ -H 
'apikey: <YOUR_SUPABASE_ANON_KEY>'\ -H 'Authorization: Bearer 
<YOUR_AUTHENTICATED_ADMIN_JWT>'\ -H 'Content-Type: application/json'\ -H 
'Prefer: return=representation'\ -d '{ "default_organizer_name": "Historical 
Society Updated", "organizer_name_translations": { "it": "Società Storica 
Aggiornata" }, "contact_phone_event": "+390551234568" }' ``` Sample Response 
(200 OK): JSON ``` { "waypoint_id": 789, "default_event_name_official": 
"Rievocazione Tempi Medievali", "default_organizer_name": "Historical Society 
Updated", "contact_phone_event": "+390551234568", "updated_at": 
"2025-05-18T21:00:00Z" // ... other fields, translations would be written to 
translations table by backend logic } ``` * * * * * ### Implementation Notes - 
🟢 Schema OK for Core Functionality: The database schema for Module 4d, with 
the `default_` naming convention for primary language text and established 
audit/master table patterns, supports these API endpoints. - View Usage: - The 
`public.event_details_enriched_view` (as defined and corrected previously) is 
critical for efficiently serving `GET /events` and `GET /events/{waypoint_id}`. 
It pre-joins necessary data, reducing query complexity at the API layer. - 
Translation Handling: - For GET requests with a `lang` parameter, a Supabase 
Edge Function or Database Function (RPC) is the recommended approach to: 1. 
Query the base data (e.g., from `event_details_enriched_view`). 2. For each 
translatable field (e.g., `default_event_name_official`, `event_type_name` from 
the view), look up the corresponding translation in `public.translations` using 
the item's ID (e.g., `events_details.waypoint_id` or `event_types_master.id`) 
and the target language. 3. Construct the response by providing the 
`default_...` field (primary reference language text) and the 
`..._translations` object map. - For POST/PATCH requests that include 
translation objects (e.g., `event_name_official_translations`), the backend 
function must parse this and write appropriate entries to the 
`public.translations` table. - 🔴 `tags_master.is_active`: The 
`check_event_theme_tags_exist()` trigger (on `events_details`) correctly relies 
on `tags_master.is_active`. This dependency on an external module's table 
structure (`tags_master`) must be satisfied. (User has confirmed this table is 
updated). - Geo-spatial Queries: If `near_waypoint_id` or lat/lon/radius 
filters on `GET /events` are implemented with high performance, the `waypoints` 
table needs PostGIS capabilities and spatial indexes. The API function would 
perform the spatial query against `waypoints` and then join with 
`events_details` or its enriched view. - Write Operations: - `POST /events` 
would likely insert into `public.events_details`. The `created_by_profile_id` 
must be set from the authenticated user's JWT. - `PATCH /events/{waypoint_id}` 
updates `public.events_details`. `updated_by_profile_id` must be set. - RLS 
policies on `events_details` and master tables will gate these operations. - 
Database triggers (`check_event_theme_tags_exist`, `updated_at` handlers, 
orphan translation cleanup on delete) are crucial. 
