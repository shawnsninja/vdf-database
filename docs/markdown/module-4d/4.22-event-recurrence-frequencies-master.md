# 4.22 event_recurrence_frequencies_master

  
https://gemini.google.com/u/1/app/bf28f389cd093e55?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/0e3ccfac5f6b71bb ### Updated Production-Ready 
Specification: `public.event_recurrence_frequencies_master` Version: 1.1 Date: 
May 18, 2025 #### 1\. Purpose & Primary Use-Cases The 
`event_recurrence_frequencies_master` table defines the standard terms for how 
often a recurring event takes place (e.g., "Annually," "Monthly," "Weekly"). 
Its purpose is to provide a consistent, translatable vocabulary for describing 
event recurrence, aiding in user understanding and potential future logic for 
predicting event occurrences. Key user-story touchpoints include pilgrims 
understanding recurrence patterns, admins specifying frequencies, and the 
system displaying this information. #### 2\. Schema | column | data_type | 
constraints | description | | `id` | `INTEGER` | `Primary Key, Generated always 
as identity` | Unique identifier for the event recurrence frequency. | | `code` 
| `TEXT` | `Unique, Not Null, CHECK (length(code) > 0 AND length(code) <= 50 
AND code ~ '^[a-z0-9_]+$')` | Short, stable, machine-readable code (e.g., 
'annually', 'monthly'). Snake_case. | | `default_name` | `TEXT` | `Not Null, 
CHECK (length(default_name) > 0 AND length(default_name) <= 100)` | 
Human-readable name in the primary reference language. (Translatable via 
`public.translations`) | | `default_description` | `TEXT` | `Nullable` | 
Optional description in the primary reference language providing more context. 
(Translatable via `public.translations`) | | `sort_order` | `INTEGER` | `Not 
Null, Default 0` | Determines the display order in UI lists or filters. | | 
`is_active` | `BOOLEAN` | `Not Null, Default true` | If true, this frequency is 
active and can be used. | | `created_at` | `TIMESTAMPTZ` | `Not Null, Default 
now()` | Timestamp of record creation. | | `updated_at` | `TIMESTAMPTZ` | `Not 
Null, Default now()` | Timestamp of last update (auto-updated by trigger). | | 
`created_by_profile_id` | `UUID` | `Nullable, Foreign Key to 
public.profiles(id) ON DELETE SET NULL` | Profile ID of the user who created 
this record. | | `updated_by_profile_id` | `UUID` | `Nullable, Foreign Key to 
public.profiles(id) ON DELETE SET NULL` | Profile ID of the user who last 
updated this record. | #### 3\. PostgreSQL DDL SQL ``` CREATE TABLE 
public.event_recurrence_frequencies_master ( id INTEGER GENERATED ALWAYS AS 
IDENTITY PRIMARY KEY, code TEXT UNIQUE NOT NULL CHECK (length(code) > 0 AND 
length(code) <= 50 AND code ~ '^[a-z0-9_]+$'), default_name TEXT NOT NULL CHECK 
(length(default_name) > 0 AND length(default_name) <= 100), default_description 
TEXT NULL, sort_order INTEGER NOT NULL DEFAULT 0, is_active BOOLEAN NOT NULL 
DEFAULT true, created_at TIMESTAMPTZ NOT NULL DEFAULT now(), updated_at 
TIMESTAMPTZ NOT NULL DEFAULT now(), created_by_profile_id UUID NULL REFERENCES 
public.profiles(id) ON DELETE SET NULL, updated_by_profile_id UUID NULL 
REFERENCES public.profiles(id) ON DELETE SET NULL ); COMMENT ON TABLE 
public.event_recurrence_frequencies_master IS 'Master list of event recurrence 
frequencies (e.g., annually, monthly, weekly). Replaces 
event_recurrence_frequency_enum. Version 1.1'; COMMENT ON COLUMN 
public.event_recurrence_frequencies_master.id IS 'Unique identifier for the 
event recurrence frequency. Primary Key.'; COMMENT ON COLUMN 
public.event_recurrence_frequencies_master.code IS 'Short, stable, 
machine-readable code (snake_case). Max 50 chars. Must be unique.'; COMMENT ON 
COLUMN public.event_recurrence_frequencies_master.default_name IS 
'Human-readable name in the primary reference language for UI. (Translatable 
via public.translations). Max 100 chars.'; COMMENT ON COLUMN 
public.event_recurrence_frequencies_master.default_description IS 'Optional 
description in the primary reference language of the frequency. (Translatable 
via public.translations).'; COMMENT ON COLUMN 
public.event_recurrence_frequencies_master.sort_order IS 'Determines the 
display order in UI lists or filters.'; COMMENT ON COLUMN 
public.event_recurrence_frequencies_master.is_active IS 'If true, this 
frequency is active and can be used.'; COMMENT ON COLUMN 
public.event_recurrence_frequencies_master.created_at IS 'Timestamp of record 
creation.'; COMMENT ON COLUMN 
public.event_recurrence_frequencies_master.updated_at IS 'Timestamp of last 
update (auto-updated by trigger).'; COMMENT ON COLUMN 
public.event_recurrence_frequencies_master.created_by_profile_id IS 'Profile ID 
of the user who created this record. FK to public.profiles(id).'; COMMENT ON 
COLUMN public.event_recurrence_frequencies_master.updated_by_profile_id IS 
'Profile ID of the user who last updated this record. FK to 
public.profiles(id).'; -- Indexes CREATE INDEX 
ix_event_recurrence_freq_master_active_sort ON 
public.event_recurrence_frequencies_master (is_active, sort_order); CREATE 
INDEX ix_event_recurrence_freq_master_created_by ON 
public.event_recurrence_frequencies_master (created_by_profile_id) WHERE 
created_by_profile_id IS NOT NULL; CREATE INDEX 
ix_event_recurrence_freq_master_updated_by ON 
public.event_recurrence_frequencies_master (updated_by_profile_id) WHERE 
updated_by_profile_id IS NOT NULL; ``` #### 4\. Triggers/Functions SQL ``` -- 
Standard updated_at trigger CREATE TRIGGER 
handle_event_recurrence_freq_master_updated_at BEFORE UPDATE ON 
public.event_recurrence_frequencies_master FOR EACH ROW EXECUTE FUNCTION 
extensions.moddatetime('updated_at'); -- Or 
public.set_current_timestamp_updated_at() COMMENT ON TRIGGER 
handle_event_recurrence_freq_master_updated_at ON 
public.event_recurrence_frequencies_master IS 'Trigger to automatically update 
updated_at timestamp on row modification.'; -- Orphaned translation cleanup 
trigger CREATE OR REPLACE FUNCTION 
public.cleanup_event_recurrence_freq_master_translations() RETURNS TRIGGER AS 
$$ BEGIN DELETE FROM public.translations WHERE table_identifier = 
'event_recurrence_frequencies_master' AND column_identifier IN ('default_name', 
'default_description') -- Specify translatable columns AND row_foreign_key = 
OLD.id::TEXT; RETURN OLD; END; $$ LANGUAGE plpgsql SECURITY DEFINER; COMMENT ON 
FUNCTION public.cleanup_event_recurrence_freq_master_translations() IS 'Cleans 
up orphaned translations from public.translations when an 
event_recurrence_frequencies_master record is deleted. Runs as SECURITY 
DEFINER. Ensure appropriate search_path if not using fully qualified names.'; 
CREATE TRIGGER trigger_cleanup_event_recurrence_freq_master_translations AFTER 
DELETE ON public.event_recurrence_frequencies_master FOR EACH ROW EXECUTE 
FUNCTION public.cleanup_event_recurrence_freq_master_translations(); COMMENT ON 
TRIGGER trigger_cleanup_event_recurrence_freq_master_translations ON 
public.event_recurrence_frequencies_master IS 'After deleting a recurrence 
frequency, remove its associated translations from the public.translations 
table.'; ``` *(Assumption: `extensions.moddatetime` is available or 
`public.set_current_timestamp_updated_at()` is defined as per project 
standards, and `public.translations` table exists).* #### 5\. JSON Schema 
Mirror JSON ``` { "title": "event_recurrence_frequency_master", "description": 
"Master list of event recurrence frequencies (e.g., annually, monthly, weekly). 
Replaces event_recurrence_frequency_enum. Version 1.1.", "type": "object", 
"properties": { "id": { "type": "integer", "description": "Unique identifier. 
Primary Key.", "readOnly": true }, "code": { "type": "string", "description": 
"Short, stable, machine-readable code (snake_case). Max 50 chars. Must be 
unique.", "pattern": "^[a-z0-9_]+$", "maxLength": 50 }, "default_name": { 
"type": "string", "description": "Human-readable name in the primary reference 
language for UI. (Translatable via public.translations). Max 100 chars.", 
"maxLength": 100 }, "default_description": { "type": ["string", "null"], 
"description": "Optional description in the primary reference language of the 
frequency. (Translatable via public.translations)." }, "sort_order": { "type": 
"integer", "default": 0, "description": "Determines the display order in UI 
lists or filters." }, "is_active": { "type": "boolean", "default": true, 
"description": "If true, this frequency is active and can be used." }, 
"created_at": { "type": "string", "format": "date-time", "description": 
"Timestamp of record creation.", "readOnly": true }, "updated_at": { "type": 
"string", "format": "date-time", "description": "Timestamp of last update 
(auto-updated by trigger).", "readOnly": true }, "created_by_profile_id": { 
"type": ["string", "null"], "format": "uuid", "description": "Profile ID of the 
user who created this record. FK to public.profiles(id)." }, 
"updated_by_profile_id": { "type": ["string", "null"], "format": "uuid", 
"description": "Profile ID of the user who last updated this record. FK to 
public.profiles(id)." } }, "required": [ "code", "default_name", "sort_order", 
"is_active" ], "primary_key": ["id"], "unique_constraints": [ {"columns": 
["code"], "name": "event_recurrence_frequencies_master_code_key"} ], 
"foreign_keys": [ {"columns": ["created_by_profile_id"], "references_table": 
"public.profiles", "references_columns": ["id"], "on_delete": "SET NULL"}, 
{"columns": ["updated_by_profile_id"], "references_table": "public.profiles", 
"references_columns": ["id"], "on_delete": "SET NULL"} ] } ``` #### 6\. 
Relationships & Integrity - Primary Key: `id` (INTEGER) - Unique Constraint: 
`code` must be unique. - Foreign Key References FROM other tables: - 
`events_details.recurrence_frequency_id` will reference 
`event_recurrence_frequencies_master.id`. Recommend `ON DELETE RESTRICT` for 
data integrity, ensuring a frequency definition is not removed if actively 
used. - Array Foreign Key: None. #### 7\. Multilingual Strategy - 
`default_name`: Name in the primary reference language. (Translatable via 
`public.translations`) - `default_description`: Description in the primary 
reference language. (Translatable via `public.translations`) - An `AFTER 
DELETE` trigger (`trigger_cleanup_event_recurrence_freq_master_translations`) 
ensures orphaned translations are removed. #### 8\. Role-Based Workflow & RLS 
Notes - Key Fields: `is_active`. - RLS Policies: - 🟢 Allow public read access 
to active frequencies. SQL ``` CREATE POLICY "Allow public read access to 
active event recurrence frequencies" ON 
public.event_recurrence_frequencies_master FOR SELECT USING (is_active = true); 
``` - 🟢 Allow platform admins to manage frequencies. SQL ``` CREATE POLICY 
"Allow platform admins to manage event recurrence frequencies" ON 
public.event_recurrence_frequencies_master FOR ALL USING ( auth.role() = 
'authenticated' AND (SELECT public.has_role_on_profile(auth.uid(), 
'admin_platform') OR public.has_role_on_profile(auth.uid(), 'admin_super')) ) 
WITH CHECK ( auth.role() = 'authenticated' AND (SELECT 
public.has_role_on_profile(auth.uid(), 'admin_platform') OR 
public.has_role_on_profile(auth.uid(), 'admin_super')) ); ``` - 🟠 `ON DELETE 
RESTRICT` from `events_details` (when defined) will prevent deletion if a 
frequency is in use. Deactivation via `is_active = false` is preferred. #### 
9\. ENUM vs Lookup Discussion - 🟢 Decision: This table 
`event_recurrence_frequencies_master` *is* the result of promoting the original 
`event_recurrence_frequency_enum`. - Reason: Provides translatable names, 
optional descriptive context, and a controlled vocabulary, offering better 
maintainability and clarity. #### 10\. UI/UX Enablement - `default_name` 
(translated): For displaying the recurrence frequency (e.g., "Repeats: 
Annually"). - `default_description` (translated): Can be used for tooltips or 
help text. - `sort_order`: To list frequencies logically (e.g., daily, weekly, 
monthly, annually). - `is_active`: Filters values for admin UIs. #### 11\. 
Auditing & Lifecycle Management - Audit Columns: `created_at`, `updated_at` 
(auto-managed). `created_by_profile_id`, `updated_by_profile_id` for admin 
tracking. - Lifecycle: `is_active` flag. #### 12\. Scalability & 
Future-Proofing - Manageable List: The number of common recurrence frequencies 
is small and stable. - Flexibility: Easy to add new frequencies or refine 
descriptions. #### 13\. Seed Data (V1.1) | code | default_name | sort_order | 
default_description | is_active | created_by_profile_id | updated_by_profile_id 
| | 'daily' | 'Daily' | 10 | 'Event occurs every day.' | true | `[ADMIN_UUID]` 
| `[ADMIN_UUID]` | | 'weekly' | 'Weekly' | 20 | 'Event occurs once a week, 
typically on the same day(s).' | true | `[ADMIN_UUID]` | `[ADMIN_UUID]` | | 
'bi_weekly' | 'Bi-Weekly' | 30 | 'Event occurs every two weeks.' | true | 
`[ADMIN_UUID]` | `[ADMIN_UUID]` | | 'monthly' | 'Monthly' | 40 | 'Event occurs 
once a month, often on a specific day or week.' | true | `[ADMIN_UUID]` | 
`[ADMIN_UUID]` | | 'annually' | 'Annually' | 50 | 'Event occurs once a year, 
typically around the same date or period.' | true | `[ADMIN_UUID]` | 
`[ADMIN_UUID]` | | 'other_frequency' | 'Other Frequency' | 900 | 'Event recurs 
at a frequency not covered by standard options. See recurrence_detail_text for 
specifics.' | true | `[ADMIN_UUID]` | `[ADMIN_UUID]` | *(Note: `[ADMIN_UUID]` 
is a placeholder for an actual admin/system user profile ID used for seeding. 
Seed data adapted from.)* #### 14\. Next-Action Checklist - 🔴 Create Table: 
Execute DDL for `public.event_recurrence_frequencies_master`. - 🔴 Create 
Indexes: Execute DDL for `ix_event_recurrence_freq_master_active_sort`, 
`ix_event_recurrence_freq_master_created_by`, 
`ix_event_recurrence_freq_master_updated_by`. - 🔴 Implement `updated_at` 
Trigger: Ensure `extensions.moddatetime` or equivalent and create trigger. - 🔴 
Implement Orphan Translation Cleanup Trigger: Create 
`public.cleanup_event_recurrence_freq_master_translations()` function and apply 
`trigger_cleanup_event_recurrence_freq_master_translations` (AFTER 
`public.translations` table exists). Ensure `SECURITY DEFINER` functions have 
hardened `search_path`. - 🔴 RLS Policies: Review and apply defined RLS 
policies. Ensure `public.has_role_on_profile` helper function exists. - 🔴 Seed 
Data: Insert initial V1.1 data. - 🟢 Population Logic: Define how 
`created_by_profile_id` and `updated_by_profile_id` will be populated by the 
application layer during admin operations. - 🟢 Review ON DELETE for FK from 
`events_details` to this table when `events_details` is finalized (recommend 
`ON DELETE RESTRICT`). 
