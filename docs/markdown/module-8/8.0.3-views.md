# 8.0.3 views

  https://gemini.google.com/u/1/app/5b5f3092ace62463 * * * * * Production-Ready 
Specification: Module 8 Views Version: 1.0 Date: May 18, 2025 This document 
outlines the specifications for views designed to simplify querying and data 
access for the Platform Content module (Module 8), focusing on articles and 
their associated media. View 1: `public.published_articles_view` 
---------------------------------------- 1\. View Name 
public.published_articles_view 2\. Version & Date - Version: 1.0 - Date: May 
18, 2025 3\. Purpose & Primary Use-Cases To provide a denormalized, read-only 
list of articles that are currently published and not soft-deleted. This view 
includes key author details and featured image information, making it suitable 
for populating public-facing article listings or individual article displays. 
Content fields are presented in the platform's primary reference language 
(English). 4\. Source Tables - `public.articles` - `public.profiles` - 
`public.media` 5\. View Definition (DDL) SQL ``` CREATE OR REPLACE VIEW 
public.published_articles_view AS SELECT a.id, a.title, -- In primary reference 
language a.slug, a.excerpt, -- In primary reference language a.body_content, -- 
In primary reference language (consider if full body is always needed in a list 
view) a.publication_date, a.author_profile_id AS author_id, 
p.public_display_name AS author_public_display_name, p.public_avatar_media_id 
AS author_avatar_media_id, -- App layer can use this to get actual URL from 
media table + image_variants_json a.featured_image_media_id, 
fm.storage_bucket_name AS featured_image_bucket_name, 
fm.storage_object_path_original AS featured_image_storage_object_path, -- App 
layer can construct URL fm.image_variants_json AS featured_image_variants_json, 
-- Provides different sizes/formats fm.default_alt_text AS 
featured_image_default_alt_text, -- In primary reference language a.tags, 
a.associated_trail_id, a.associated_region_id, a.associated_town_id, 
a.created_at AS article_created_at, a.updated_at AS article_updated_at FROM 
public.articles a LEFT JOIN public.profiles p ON a.author_profile_id = p.id 
LEFT JOIN public.media fm ON a.featured_image_media_id = fm.id WHERE 
a.article_status = 'published'::public.content_visibility_status_enum AND 
a.deleted_at IS NULL; COMMENT ON VIEW public.published_articles_view IS 
'Provides a denormalized view of published articles with author and featured 
image details, primarily in the reference language. Module 8. Version 1.0.'; 
``` 6\. Column Descriptions | Column | Source Table(s) / Logic | Description | 
| `id` | `articles.id` | Unique identifier of the article. | | `title` | 
`articles.title` | Title of the article (in primary reference language). | | 
`slug` | `articles.slug` | URL-friendly slug for the article. | | `excerpt` | 
`articles.excerpt` | Short summary of the article (in primary reference 
language). | | `body_content` | `articles.body_content` | Main content of the 
article (in primary reference language). | | `publication_date` | 
`articles.publication_date` | Date and time the article was published. | | 
`author_id` | `articles.author_profile_id` | UUID of the article's author 
(references `profiles.id`). | | `author_public_display_name` | 
`profiles.public_display_name` | Public display name of the author. | | 
`author_avatar_media_id` | `profiles.public_avatar_media_id` | Media ID of the 
author's avatar. Application layer can use this to construct the full URL via 
`public.media` and `image_variants_json`. | | `featured_image_media_id` | 
`articles.featured_image_media_id` | Media ID of the article's featured image. 
| | `featured_image_bucket_name` | `media.storage_bucket_name` (from featured 
image join) | Storage bucket for the featured image. | | 
`featured_image_storage_object_path` | `media.storage_object_path_original` 
(from featured image join) | Original storage path for the featured image. | | 
`featured_image_variants_json` | `media.image_variants_json` (from featured 
image join) | JSONB object containing paths to different variants (sizes, 
formats) of the featured image. | | `featured_image_default_alt_text` | 
`media.default_alt_text` (from featured image join) | Default alt text for the 
featured image (in primary reference language). | | `tags` | `articles.tags` | 
Array of tags associated with the article. | | `associated_trail_id` | 
`articles.associated_trail_id` | Optional ID of an associated trail. | | 
`associated_region_id` | `articles.associated_region_id` | Optional ID of an 
associated region. | | `associated_town_id` | `articles.associated_town_id` | 
Optional ID of an associated town. | | `article_created_at` | 
`articles.created_at` | Timestamp of when the article record was created. | | 
`article_updated_at` | `articles.updated_at` | Timestamp of when the article 
record was last updated. | 7\. Querying & Usage Notes - This view is designed 
for read-only access to articles intended for public display. - Textual content 
fields (`title`, `excerpt`, `body_content`, `featured_image_default_alt_text`) 
are presented in the platform's primary reference language (English). - For 
displaying content in other languages, the application layer should query the 
`public.translations` table using the `articles.id` (for article content) or 
`featured_image_media_id` (for featured image alt text) as the 
`row_foreign_key`, along with the appropriate `table_identifier` and 
`column_identifier`. Alternatively, a dedicated database function accepting a 
language code is recommended for more complex translation retrieval logic. - 
The `author_avatar_media_id`, `featured_image_bucket_name`, 
`featured_image_storage_object_path`, and `featured_image_variants_json` 
columns provide the necessary information for applications to construct full, 
optimized image URLs. 8\. RLS Considerations - The view's `WHERE` clause 
intrinsically filters for articles where `article_status = 'published'` and 
`deleted_at IS NULL`. - Row-Level Security policies on the underlying tables 
(`public.articles`, `public.profiles`, `public.media`) will still be enforced 
when this view is queried. - For public access, ensure appropriate `SELECT` 
grants are applied to this view for roles like `anonymous` or 
`authenticated_user`. Example: SQL ``` -- GRANT SELECT ON 
public.published_articles_view TO authenticated_user; -- GRANT SELECT ON 
public.published_articles_view TO anonymous_user; ``` 9\. Dependencies - 
`public.articles` table - `public.profiles` table - `public.media` table - 
`public.content_visibility_status_enum` type (used by 
`public.articles.article_status`) 10\. Next-Action Checklist - ðŸ”´ Create View: 
Execute the `CREATE OR REPLACE VIEW public.published_articles_view` DDL. - ðŸŸ¢ 
Test: Thoroughly test the view with various data scenarios (e.g., articles 
with/without authors, with/without featured images). - ðŸŸ¢ Performance: Monitor 
performance under load. For very high-traffic scenarios, consider if a 
materialized view would be more appropriate (though this adds complexity for 
data freshness). - ðŸ”´ Security: Review and apply necessary `GRANT` permissions 
for relevant user roles. - ðŸŸ  Translations Strategy: Confirm application-level 
or database function strategy for fetching translations for fields served by 
this view. * * * * * View 2: `public.article_media_details_view` 
------------------------------------------- 1\. View Name 
public.article_media_details_view 2\. Version & Date - Version: 1.0 - Date: May 
18, 2025 3\. Purpose & Primary Use-Cases To provide a denormalized, read-only 
list of all approved media items associated with articles through the 
public.article_media linking table. This includes media role information, 
display order, paths to media files, and any text overrides (primarily in the 
reference language). It is useful for constructing image galleries or 
displaying inline media elements for a specific article. 4\. Source Tables - 
`public.article_media` - `public.media` - `public.media_roles_master` 5\. View 
Definition (DDL) SQL ``` CREATE OR REPLACE VIEW 
public.article_media_details_view AS SELECT am.id AS article_media_id, 
am.article_id, am.media_id, am.media_role_code, mrm.default_display_name AS 
media_role_name, -- In primary reference language am.display_order, 
am.caption_override, -- In primary reference language am.alt_text_override, -- 
In primary reference language m.storage_bucket_name, 
m.storage_object_path_original, m.image_variants_json, m.default_alt_text AS 
media_default_alt_text, -- Fallback, in primary reference language 
m.default_caption AS media_default_caption, -- Fallback, in primary reference 
language m.file_mime_type, m.image_width_px_original, 
m.image_height_px_original, am.created_at AS link_created_at, am.updated_at AS 
link_updated_at FROM public.article_media am JOIN public.media m ON am.media_id 
= m.id JOIN public.media_roles_master mrm ON am.media_role_code = mrm.role_code 
WHERE m.deleted_at IS NULL AND m.media_status = 
'published_approved'::public.media_status_enum -- Only show published/approved 
media items AND mrm.is_active = true; -- Only consider active media roles 
COMMENT ON VIEW public.article_media_details_view IS 'Provides denormalized 
details for approved media items linked to articles, including roles and text 
overrides (in primary reference language). For Module 8. Version 1.0.'; ``` 6\. 
Column Descriptions | Column | Source Table(s) / Logic | Description | | 
`article_media_id` | `article_media.id` | Unique ID of the link between an 
article and a media item. | | `article_id` | `article_media.article_id` | ID of 
the article this media is linked to. | | `media_id` | `article_media.media_id` 
| ID of the linked media item. | | `media_role_code` | 
`article_media.media_role_code` | Code for the role this media plays in the 
article (e.g., `gallery_image`). | | `media_role_name` | 
`media_roles_master.default_display_name` | Human-readable name of the media 
role (in primary reference language). | | `display_order` | 
`article_media.display_order` | Display order for this media item within its 
role for the article. | | `caption_override` | `article_media.caption_override` 
| Context-specific caption for this media in this article (in primary reference 
language). | | `alt_text_override` | `article_media.alt_text_override` | 
Context-specific alt text for this media in this article (in primary reference 
language). | | `storage_bucket_name` | `media.storage_bucket_name` | Storage 
bucket of the linked media item. | | `storage_object_path_original` | 
`media.storage_object_path_original` | Original storage path of the linked 
media item. | | `image_variants_json` | `media.image_variants_json` | JSONB 
object with paths to different variants (sizes, formats) of the media item. | | 
`media_default_alt_text` | `media.default_alt_text` | Fallback default alt text 
from the media item itself (in primary reference language). | | 
`media_default_caption` | `media.default_caption` | Fallback default caption 
from the media item itself (in primary reference language). | | 
`file_mime_type` | `media.file_mime_type` | MIME type of the media item. | | 
`image_width_px_original` | `media.image_width_px_original` | Original width of 
the media item in pixels (if an image). | | `image_height_px_original` | 
`media.image_height_px_original` | Original height of the media item in pixels 
(if an image). | | `link_created_at` | `article_media.created_at` | Timestamp 
of when the link record in `article_media` was created. | | `link_updated_at` | 
`article_media.updated_at` | Timestamp of when the link record in 
`article_media` was last updated. | 7\. Querying & Usage Notes - Typically 
queried by `article_id` to retrieve all associated media details for a specific 
article. - Text fields (`media_role_name`, `caption_override`, 
`alt_text_override`, `media_default_alt_text`, `media_default_caption`) are 
presented in the platform's primary reference language. - For displaying 
content in other languages, the application layer should query the 
`public.translations` table for the `caption_override` and `alt_text_override` 
(using `article_media.id` as `row_foreign_key`) and for `media_role_name` 
(using `media_roles_master.role_code` as `row_foreign_key`). Fallback media 
captions/alt text would also need translation lookup using `media.id`. A 
dedicated database function is recommended for complex translation logic. - The 
view's `WHERE` clause filters for media items that are `published_approved` and 
media roles that are `is_active`. 8\. RLS Considerations - RLS on underlying 
tables (`public.article_media`, `public.media`, `public.media_roles_master`) 
will be enforced. - Access to this view should ideally be controlled based on 
the user's permission to view the parent article referenced by 
`article_media.article_id`. This might involve: - A `SECURITY INVOKER` view 
where RLS policies on `article_media` (which in turn could check `articles`) 
handle access. - Joining with `public.articles` within the view's RLS policy 
(if view-level RLS is added) to check the parent article's status and RLS. - 
Example (conceptual, assuming RLS on `article_media` checks parent article 
visibility): <!-- end list --> SQL ``` -- GRANT SELECT ON 
public.article_media_details_view TO authenticated_user; -- GRANT SELECT ON 
public.article_media_details_view TO anonymous_user; -- (Actual access depends 
on RLS policies on public.article_media) ``` 9\. Dependencies - 
`public.article_media` table - `public.media` table - 
`public.media_roles_master` table - `public.media_status_enum` type (used by 
`public.media.media_status`) 10\. Next-Action Checklist - ðŸ”´ Create View: 
Execute the `CREATE OR REPLACE VIEW public.article_media_details_view` DDL. - 
ðŸŸ¢ Test: Thoroughly test with various articles, media items, roles, and 
overrides. - ðŸŸ¢ Performance: Monitor performance, especially when querying for 
articles with many media items. Ensure underlying table indexes are effective. 
- ðŸ”´ Security: Review and apply necessary `GRANT` permissions. Define and test 
RLS policies on the base `public.article_media` table to ensure this view 
exposes data correctly according to user permissions for the parent article. - 
ðŸŸ  Translations Strategy: Confirm application-level or database function 
strategy for fetching translations for fields served by this view. 
