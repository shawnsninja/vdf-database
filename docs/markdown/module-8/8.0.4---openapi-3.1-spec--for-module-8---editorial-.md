# 8.0.4 - OpenAPI 3.1 Spec (for Module 8 - editorial)

  https://gemini.google.com/u/1/app/5b5f3092ace62463 * * * * * ### OpenAPI 3.1 
Spec (for Module 8) YAML ``` openapi: 3.1.0 info: title: Platform Content API 
(Module 8) version: v1.0 description: |- API for managing platform content, 
including articles, their associated media, and media role definitions. This 
module enables creation, retrieval, and management of general content like news 
and informational posts. Primary reference language for content is English. 
Other languages are provided via translation objects. servers: - url: 
https://<your-project-ref>.supabase.co/rest/v1 description: Supabase Project 
REST API - url: http://localhost:54321/rest/v1 # Local Supabase docker instance 
description: Local Supabase instance security: - BearerAuth: [] # Applies 
BearerAuth to all operations unless overridden paths: /articles: get: summary: 
List Published Articles operationId: listPublishedArticles tags: - Articles 
parameters: - name: lang in: query description: ISO language code for localized 
content (e.g., 'it'). Defaults to English. required: false schema: type: string 
example: it - name: tags in: query description: Comma-separated list of tags to 
filter articles by (e.g., 'history,nature'). required: false schema: type: 
string - name: region_id in: query description: Filter articles associated with 
a specific region ID. required: false schema: type: integer format: int64 - 
name: trail_id in: query description: Filter articles associated with a 
specific trail ID. required: false schema: type: integer format: int64 - name: 
town_id in: query description: Filter articles associated with a specific town 
ID. required: false schema: type: integer format: int64 - name: sort_by in: 
query description: Field to sort articles by. required: false schema: type: 
string enum: [publication_date, title, created_at] default: publication_date - 
name: order in: query description: Sort order. required: false schema: type: 
string enum: [asc, desc] default: desc - $ref: '#/components/parameters/Page' - 
$ref: '#/components/parameters/PageSize' responses: '200': description: A 
paginated list of published articles. content: application/json: schema: type: 
object properties: pagination: $ref: '#/components/schemas/Pagination' data: 
type: array items: $ref: '#/components/schemas/ArticleSummary' # Use a summary 
for lists default: $ref: '#/components/responses/ErrorResponse' # DB 
Optimization: Leverages public.published_articles_view and GIN index on 
articles.tags. # A database function could further optimize translation and 
complex filtering. post: summary: Create a New Article operationId: 
createArticle tags: - Articles security: - BearerAuth: ['admin_platform', 
'regional_content_manager'] # Example scopes requestBody: required: true 
content: application/json: schema: $ref: '#/components/schemas/ArticleCreate' 
responses: '201': description: Article created successfully. content: 
application/json: schema: $ref: '#/components/schemas/Article' '400': $ref: 
'#/components/responses/ErrorValidation' '401': $ref: 
'#/components/responses/ErrorUnauthorized' '403': $ref: 
'#/components/responses/ErrorForbidden' default: $ref: 
'#/components/responses/ErrorResponse' /articles/{article_slug}: get: summary: 
Get Article by Slug operationId: getArticleBySlug tags: - Articles parameters: 
- name: article_slug in: path required: true description: The URL-friendly slug 
of the article. schema: type: string - name: lang in: query description: ISO 
language code for localized content. Defaults to English. required: false 
schema: type: string responses: '200': description: Detailed information about 
the article. content: application/json: schema: $ref: 
'#/components/schemas/ArticleDetail' # A more detailed schema '404': $ref: 
'#/components/responses/ErrorNotFound' default: $ref: 
'#/components/responses/ErrorResponse' # DB Optimization: Uses index on 
articles.slug. # A database function get_article_by_slug(slug, lang) is highly 
recommended for optimal data assembly, # including translated content and 
associated media gallery (from article_media_details_view). /media-roles: get: 
summary: List Media Roles operationId: listMediaRoles tags: - MediaRoles 
parameters: - name: lang in: query description: ISO language code for localized 
content. Defaults to English. required: false schema: type: string responses: 
'200': description: A list of active media roles. content: application/json: 
schema: type: array items: $ref: '#/components/schemas/MediaRole' default: 
$ref: '#/components/responses/ErrorResponse' # DB Optimization: Queries 
public.media_roles_master with index on is_active. post: summary: Create a 
Media Role operationId: createMediaRole tags: - MediaRoles security: - 
BearerAuth: ['admin_platform'] # Example scope requestBody: required: true 
content: application/json: schema: $ref: '#/components/schemas/MediaRoleCreate' 
responses: '201': description: Media role created successfully. content: 
application/json: schema: $ref: '#/components/schemas/MediaRole' '400': $ref: 
'#/components/responses/ErrorValidation' default: $ref: 
'#/components/responses/ErrorResponse' /media-roles/{role_code}: get: summary: 
Get Media Role by Code operationId: getMediaRoleByCode tags: - MediaRoles 
parameters: - name: role_code in: path required: true description: The unique 
code of the media role. schema: type: string - name: lang in: query 
description: ISO language code for localized content. Defaults to English. 
required: false schema: type: string responses: '200': description: Detailed 
information about the media role. content: application/json: schema: $ref: 
'#/components/schemas/MediaRole' '404': $ref: 
'#/components/responses/ErrorNotFound' default: $ref: 
'#/components/responses/ErrorResponse' /articles/{article_slug}/media: get: 
summary: List Media for an Article operationId: listArticleMedia tags: - 
Articles - Media parameters: - name: article_slug in: path required: true 
description: The slug of the article. schema: type: string - name: lang in: 
query description: ISO language code for localized overrides. Defaults to 
English. required: false schema: type: string responses: '200': description: A 
list of media items linked to the article. content: application/json: schema: 
type: array items: $ref: '#/components/schemas/ArticleMediaItem' # Schema 
representing an item from article_media_details_view '404': $ref: 
'#/components/responses/ErrorNotFound' # If article not found default: $ref: 
'#/components/responses/ErrorResponse' # DB Optimization: Uses 
public.article_media_details_view, joining article_media, media, and 
media_roles_master. # Query needs to first get article ID from slug. 
components: securitySchemes: BearerAuth: type: http scheme: bearer 
bearerFormat: JWT description: "Supabase JWT token obtained after login. 
Example: `Authorization: Bearer YOUR_JWT_TOKEN`" parameters: Page: name: page 
in: query description: Page number for pagination. required: false schema: 
type: integer default: 1 minimum: 1 PageSize: name: page_size in: query 
description: Number of items per page. required: false schema: type: integer 
default: 10 minimum: 1 maximum: 100 schemas: Pagination: type: object 
properties: page: type: integer example: 1 page_size: type: integer example: 10 
total_items: type: integer example: 153 total_pages: type: integer example: 16 
# --- Article Schemas --- ArticleBase: type: object properties: title: # This 
field holds the English (primary reference) version type: string maxLength: 255 
description: "Title of the article (in primary reference language - English)." 
title_translations: type: object additionalProperties: type: string 
description: "Translations for the title, mapping language_code to translated 
title text." example: {"it": "Titolo Dell'Articolo", "fr": "Titre de 
l'article"} slug: type: string maxLength: 255 pattern: 
'^[a-z0-9]+(?:-[a-z0-9]+)*$' description: "URL-friendly slug." excerpt: # 
English version type: string nullable: true maxLength: 500 description: "Short 
summary of the article (in primary reference language - English)." 
excerpt_translations: type: object nullable: true additionalProperties: type: 
string description: "Translations for the excerpt." author_profile_id: type: 
string format: uuid nullable: true publication_date: type: string format: 
date-time nullable: true article_status: $ref: 
'#/components/schemas/ContentVisibilityStatusEnum' # Assuming this enum is 
globally defined featured_image_media_id: type: string format: uuid nullable: 
true associated_trail_id: type: integer format: int64 nullable: true 
associated_region_id: type: integer format: int64 nullable: true 
associated_town_id: type: integer format: int64 nullable: true tags: type: 
array items: type: string nullable: true ArticleSummary: # For list views 
allOf: - $ref: '#/components/schemas/ArticleBase' - type: object properties: 
id: type: integer format: int64 readOnly: true author_public_display_name: # 
Denormalized from profiles type: string nullable: true 
featured_image_thumbnail_url: # Example constructed URL type: string format: 
url nullable: true # publication_date is already in ArticleBase ArticleCreate: 
# For POST /articles type: object required: - title # English title is required 
- body_content # English body_content is required properties: title: type: 
string maxLength: 255 description: "Title of the article (in primary reference 
language - English)." title_translations: type: object additionalProperties: 
type: string slug: # Optional on create, can be auto-generated type: string 
maxLength: 255 pattern: '^[a-z0-9]+(?:-[a-z0-9]+)*$' nullable: true 
body_content: # English version type: string description: "Main content of the 
article (in primary reference language - English)." body_content_translations: 
type: object additionalProperties: type: string excerpt: # English version 
type: string nullable: true maxLength: 500 excerpt_translations: type: object 
nullable: true additionalProperties: type: string author_profile_id: # Usually 
set to current user or by admin type: string format: uuid nullable: true 
publication_date: type: string format: date-time nullable: true article_status: 
$ref: '#/components/schemas/ContentVisibilityStatusEnum' default: 'draft' 
featured_image_media_id: type: string format: uuid nullable: true 
associated_trail_id: type: integer format: int64 nullable: true 
associated_region_id: type: integer format: int64 nullable: true 
associated_town_id: type: integer format: int64 nullable: true tags: type: 
array items: type: string nullable: true Article: # Represents the DB table 
public.articles allOf: - $ref: '#/components/schemas/ArticleBase' - type: 
object properties: id: type: integer format: int64 readOnly: true body_content: 
# English version type: string description: "Main content of the article (in 
primary reference language - English)." body_content_translations: type: object 
additionalProperties: type: string description: "Translations for the body 
content." created_at: type: string format: date-time readOnly: true updated_at: 
type: string format: date-time readOnly: true created_by_profile_id: type: 
string format: uuid nullable: true readOnly: true # Typically set by system 
updated_by_profile_id: type: string format: uuid nullable: true readOnly: true 
# Typically set by system deleted_at: type: string format: date-time nullable: 
true readOnly: true ArticleDetail: # For GET /articles/{slug} response allOf: - 
$ref: '#/components/schemas/Article' # Includes full body_content - type: 
object properties: author: # Denormalized author details type: object nullable: 
true properties: id: type: string format: uuid public_display_name: type: 
string avatar_url: # Example constructed URL type: string format: url nullable: 
true featured_image_details: # Denormalized featured image details type: object 
nullable: true properties: media_id: type: string format: uuid alt_text: # 
English version type: string nullable: true alt_text_translations: type: object 
additionalProperties: type: string variants: # From media.image_variants_json 
type: object additionalProperties: # e.g., "thumbnail", "large" type: string # 
path to variant example: {"thumbnail": "/media/uuid-featured/thumb.webp", 
"large": "/media/uuid-featured/large.jpg"} gallery: # From 
article_media_details_view type: array items: $ref: 
'#/components/schemas/ArticleMediaItem' ArticleMediaItem: # Represents an item 
in an article's media gallery type: object properties: article_media_id: type: 
integer format: int64 media_id: type: string format: uuid media_role_code: 
type: string media_role_name: # English version type: string 
media_role_name_translations: type: object additionalProperties: type: string 
display_order: type: integer caption_override: # English version type: string 
nullable: true caption_override_translations: type: object 
additionalProperties: type: string alt_text_override: # English version type: 
string nullable: true alt_text_override_translations: type: object 
additionalProperties: type: string # Media file details from public.media 
storage_bucket_name: type: string storage_object_path_original: type: string 
image_variants_json: type: object additionalProperties: type: string 
file_mime_type: type: string # --- MediaRole Schemas --- MediaRoleBase: type: 
object properties: default_display_name: # English version type: string 
maxLength: 100 default_display_name_translations: type: object 
additionalProperties: type: string default_description: # English version type: 
string nullable: true maxLength: 255 default_description_translations: type: 
object nullable: true additionalProperties: type: string icon_identifier: type: 
string nullable: true maxLength: 50 is_active: type: boolean default: true 
MediaRoleCreate: # For POST /media-roles type: object required: - role_code - 
default_display_name # English name is required properties: role_code: type: 
string maxLength: 50 pattern: '^[a-z0-9_]+$' default_display_name: type: string 
maxLength: 100 default_display_name_translations: type: object 
additionalProperties: type: string default_description: type: string nullable: 
true maxLength: 255 default_description_translations: type: object nullable: 
true additionalProperties: type: string icon_identifier: type: string nullable: 
true maxLength: 50 is_active: type: boolean default: true MediaRole: # 
Represents the DB table public.media_roles_master allOf: - $ref: 
'#/components/schemas/MediaRoleBase' - type: object properties: role_code: 
type: string maxLength: 50 pattern: '^[a-z0-9_]+$' created_at: type: string 
format: date-time readOnly: true updated_at: type: string format: date-time 
readOnly: true created_by_profile_id: type: string format: uuid nullable: true 
readOnly: true updated_by_profile_id: type: string format: uuid nullable: true 
readOnly: true # --- Shared Enum (Assuming it's globally available or defined 
elsewhere) --- ContentVisibilityStatusEnum: type: string enum: [draft, 
pending_review, published, archived, private_link] description: "Status of 
content visibility." # --- Standard Error Schemas --- Error: type: object 
required: - code - message properties: code: type: string description: A 
slug-style error code. example: "resource_not_found" message: type: string 
description: A human-readable message explaining the error. example: "The 
requested article could not be found." detail: # Matches PostgREST error detail 
and our earlier Security spec type: string # Can also be an object for 
validation errors nullable: true description: More specific details or 
field-specific errors. example: "Article with slug 'non-existent-slug' not 
found." hint: type: string nullable: true description: An optional hint on how 
to resolve the error. # PostgREST also includes "details" string which can be 
more technical. responses: ErrorResponse: description: Generic error response. 
content: application/json: schema: $ref: '#/components/schemas/Error' 
ErrorNotFound: description: The specified resource was not found. content: 
application/json: schema: $ref: '#/components/schemas/Error' ErrorValidation: 
description: Validation failed for the request. content: application/json: 
schema: $ref: '#/components/schemas/Error' # Detail might contain an object 
with field errors ErrorUnauthorized: description: Authentication credentials 
missing or invalid. content: application/json: schema: $ref: 
'#/components/schemas/Error' ErrorForbidden: description: Authenticated user 
does not have permission for the action. content: application/json: schema: 
$ref: '#/components/schemas/Error' # External Docs (Optional, for more detailed 
API guidelines) # externalDocs: # description: Find more info here # url: 
https://example.com/api-docs ``` * * * * * ### 2\. Quick-Start Examples 1. List 
Published Articles (filtered by tag, requesting Italian) Bash ``` curl -X GET 
"https://<your-project-ref>.supabase.co/rest/v1/articles?tags=history&lang=it&pa
ge_size=1"\ -H "apikey: <YOUR_SUPABASE_ANON_KEY>"\ -H "Authorization: Bearer 
<YOUR_USER_JWT>" ``` *Sample Response (compacted):* JSON ``` { "pagination": 
{"page": 1, "page_size": 1, "total_items": 5, "total_pages": 5}, "data": [ { 
"id": 101, "title": "La Battaglia Storica", "title_translations": {"en": "The 
Historic Battle"}, "slug": "la-battaglia-storica", "excerpt": "Un evento 
cruciale nella storia...", "excerpt_translations": {"en": "A crucial event in 
history..."}, "author_public_display_name": "Mario Bianchi", 
"featured_image_thumbnail_url": "/media/uuid-img-battle/thumb.webp", 
"publication_date": "2024-10-15T00:00:00Z" } ] } ``` 2. Get Single Article 
Detail (requesting Italian) Bash ``` curl -X GET 
"https://<your-project-ref>.supabase.co/rest/v1/articles/la-battaglia-storica?la
ng=it"\ -H "apikey: <YOUR_SUPABASE_ANON_KEY>"\ -H "Authorization: Bearer 
<YOUR_USER_JWT>" ``` *Sample Response (compacted):* JSON ``` { "id": 101, 
"title": "La Battaglia Storica", "title_translations": {"en": "The Historic 
Battle"}, "slug": "la-battaglia-storica", "body_content": "Testo completo della 
battaglia...", "body_content_translations": {"en": "Full text of the 
battle..."}, "author": {"id": "uuid-author-2", "public_display_name": "Mario 
Bianchi"}, "featured_image_details": {"media_id": "uuid-img-battle", 
"alt_text": "Dipinto della battaglia", "alt_text_translations": {"en": 
"Painting of the battle"}, "variants": {"large": 
"/media/uuid-img-battle/large.jpg"}}, "gallery": [ {"media_id": "uuid-map-img", 
"media_role_name": "Mappa", "media_role_name_translations": {"en": "Map"}, 
"caption_override": "Mappa delle posizioni", "caption_override_translations": 
{"en": "Map of positions"}} ] } ``` 3. Create a New Article (as an 
admin/editor) Bash ``` curl -X POST 
"https://<your-project-ref>.supabase.co/rest/v1/articles"\ -H "apikey: 
<YOUR_SUPABASE_ANON_KEY>"\ -H "Authorization: Bearer <YOUR_ADMIN_JWT>"\ -H 
"Content-Type: application/json"\ -H "Prefer: return=representation"\ -d '{ 
"title": "New Pilgrim Shelter Opens", "title_translations": { "it": "Apre Nuovo 
Rifugio Pellegrino" }, "body_content": "Details about the new shelter...", 
"body_content_translations": { "it": "Dettagli sul nuovo rifugio..." }, 
"article_status": "published", "publication_date": "2025-05-20T00:00:00Z", 
"tags": ["shelter", "news"] }' ``` *Sample Response (201 Created):* JSON ``` { 
"id": 102, "slug": "new-pilgrim-shelter-opens", // Auto-generated if not 
provided and logic exists "title": "New Pilgrim Shelter Opens", 
"title_translations": { "it": "Apre Nuovo Rifugio Pellegrino" }, 
"body_content": "Details about the new shelter...", 
"body_content_translations": { "it": "Dettagli sul nuovo rifugio..." }, 
"article_status": "published", "publication_date": "2025-05-20T00:00:00Z", 
"tags": ["shelter", "news"], "created_at": "2025-05-18T21:30:00Z" // ... other 
fields with defaults or nulls } ``` * * * * * ### 3\. Implementation Notes - 🟢 
Schema OK: The database schema for `public.articles`, 
`public.media_roles_master`, and `public.article_media` generally supports 
these API endpoints. - Views: - 🟢 The `public.published_articles_view` is 
highly beneficial for `GET /articles` and the main content of `GET 
/articles/{article_slug}`. - 🟢 The `public.article_media_details_view` is 
crucial for populating the `gallery` in `GET /articles/{article_slug}`. - 
Indexes: - 🟢 Existing indexes on `articles.slug`, `articles.article_status`, 
`articles.tags` (GIN), and FKs are important. - 🟢 Indexes on 
`media_roles_master.is_active` and `article_media` FKs and composite keys 
support their respective endpoints. - Database Functions (Highly Recommended): 
- To efficiently implement the specified translation model (`title`, 
`title_translations`, etc.) and to assemble complex responses (like the article 
detail with its gallery), PostgreSQL functions callable via RPC are strongly 
recommended. - For example, `get_article_for_api(p_slug TEXT, p_lang TEXT)` 
could query base tables/views, join `public.translations` intelligently for 
*all* translatable fields, and structure the nested JSON as required by the 
OpenAPI spec. This centralizes complex query logic and translation handling in 
the database, simplifying the API gateway. - Translation Handling: If not using 
database functions that handle translation internally, the API backend will 
need to: 1. Fetch the main entity (e.g., article data where `title` is 
English). 2. Fetch corresponding entries from `public.translations` for each 
translatable field for all required languages (or at least for the languages 
needed in the `*_translations` object). 3. Construct the response object with 
`fieldName` (English) and `fieldName_translations` (object of other languages). 
- Slug Generation: For `POST /articles`, if `slug` is not provided, 
application-layer or a DB trigger logic will be needed to generate it from the 
title, ensuring uniqueness. - Authorization: Write endpoints (`POST /articles`, 
`POST /media-roles`) need robust authorization logic based on user roles 
(`admin_platform`, `regional_content_manager`, etc.) as defined in the security 
blueprint. RLS policies on the tables are the primary enforcement mechanism. 
