# 8.3 article_media

  https://gemini.google.com/u/1/app/5b5f3092ace62463 Production-Ready 
Specification: public.article_media Table Version: 1.0 (Checklist REV 
05-18-25-A Applied) Date: May 18, 2025 1\. Purpose & Primary Use-Cases Mission 
Statement: To link articles in public.articles with media items from 
public.media, enabling the inclusion of multiple images or other media within 
an article (e.g., for galleries or specific inline placements). Each link 
specifies the role of the media in the article context, its display order, and 
allows for overriding default captions or alt text. This table is part of 
Module 8 (Platform Content). 2\. Schema | Column | Data Type | Constraints | 
Description | | `id` | `BIGINT` | `PRIMARY KEY, GENERATED ALWAYS AS IDENTITY` | 
Unique identifier for the article-media link. | | `article_id` | `BIGINT` | 
`NOT NULL, REFERENCES public.articles(id) ON DELETE CASCADE ON UPDATE CASCADE` 
| Foreign key to `public.articles`. If article is deleted, this link is 
removed. | | `media_id` | `UUID` | `NOT NULL, REFERENCES public.media(id) ON 
DELETE RESTRICT ON UPDATE CASCADE` | Foreign key to `public.media`. Prevents 
media deletion if linked. | | `media_role_code` | `TEXT` | `NOT NULL, 
REFERENCES public.media_roles_master(role_code) ON DELETE RESTRICT ON UPDATE 
CASCADE` | Role of this media within the article context (e.g., 
`gallery_image`, `inline_image`), FK to `public.media_roles_master`. Prevents 
role deletion if used. | | `display_order` | `INTEGER` | `NOT NULL, DEFAULT 1, 
CHECK (display_order > 0)` | Order of appearance for media items, typically 
within the same `article_id` and `media_role_code`. | | `caption_override` | 
`TEXT` | `NULLABLE, CHECK (caption_override IS NULL OR 
char_length(caption_override) <= 500)` | Optional override for the media's 
default caption, specific to this article context. Max 500 chars. (Translatable 
via `public.translations`) | | `alt_text_override` | `TEXT` | `NULLABLE, CHECK 
(alt_text_override IS NULL OR char_length(alt_text_override) <= 255)` | 
Optional override for the media's default alt text, specific to this article 
context. Max 255 chars. (Translatable via `public.translations`) | | 
`created_at` | `TIMESTAMPTZ` | `NOT NULL, DEFAULT now()` | Timestamp of when 
this link was created. | | `updated_at` | `TIMESTAMPTZ` | `NOT NULL, DEFAULT 
now()` | Timestamp of when this link was last updated (auto-updated). | | 
`created_by_profile_id` | `UUID` | `NULLABLE, REFERENCES public.profiles(id) ON 
DELETE SET NULL ON UPDATE NO ACTION` | Profile ID of the user who created this 
link. | | `updated_by_profile_id` | `UUID` | `NULLABLE, REFERENCES 
public.profiles(id) ON DELETE SET NULL ON UPDATE NO ACTION` | Profile ID of the 
user who last updated this link. | 3\. PostgreSQL DDL SQL ``` CREATE TABLE 
public.article_media ( id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY, 
article_id BIGINT NOT NULL REFERENCES public.articles(id) ON DELETE CASCADE ON 
UPDATE CASCADE, media_id UUID NOT NULL REFERENCES public.media(id) ON DELETE 
RESTRICT ON UPDATE CASCADE, media_role_code TEXT NOT NULL REFERENCES 
public.media_roles_master(role_code) ON DELETE RESTRICT ON UPDATE CASCADE, 
display_order INTEGER NOT NULL DEFAULT 1, caption_override TEXT NULL, 
alt_text_override TEXT NULL, created_at TIMESTAMPTZ NOT NULL DEFAULT now(), 
updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), created_by_profile_id UUID NULL 
REFERENCES public.profiles(id) ON DELETE SET NULL ON UPDATE NO ACTION, 
updated_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE SET 
NULL ON UPDATE NO ACTION, CONSTRAINT check_article_media_display_order_positive 
CHECK (display_order > 0), CONSTRAINT 
check_article_media_caption_override_length CHECK (caption_override IS NULL OR 
char_length(caption_override) <= 500), CONSTRAINT 
check_article_media_alt_text_override_length CHECK (alt_text_override IS NULL 
OR char_length(alt_text_override) <= 255), CONSTRAINT uq_article_media_link 
UNIQUE (article_id, media_id, media_role_code) -- Prevents linking the same 
media in the same role multiple times for one article. -- Consider UNIQUE 
(article_id, media_role_code, display_order) if order must be unique per role. 
App logic often handles order. ); -- Indexes CREATE INDEX 
idx_article_media_article_id ON public.article_media (article_id); CREATE INDEX 
idx_article_media_media_id ON public.article_media (media_id); CREATE INDEX 
idx_article_media_media_role_code ON public.article_media (media_role_code); 
CREATE INDEX idx_article_media_article_role_order ON public.article_media 
(article_id, media_role_code, display_order); CREATE INDEX 
idx_article_media_created_by_profile_id ON public.article_media 
(created_by_profile_id) WHERE created_by_profile_id IS NOT NULL; CREATE INDEX 
idx_article_media_updated_by_profile_id ON public.article_media 
(updated_by_profile_id) WHERE updated_by_profile_id IS NOT NULL; -- Comments 
COMMENT ON TABLE public.article_media IS 'Links articles to media items, 
defining the role, order, and providing translatable text overrides. Module 8. 
Version 1.0.'; COMMENT ON COLUMN public.article_media.id IS 'PK. Unique 
identifier for the article-media link.'; COMMENT ON COLUMN 
public.article_media.article_id IS 'FK to public.articles.id. Identifies the 
article. ON DELETE CASCADE.'; COMMENT ON COLUMN public.article_media.media_id 
IS 'FK to public.media.id. Identifies the media item. ON DELETE RESTRICT.'; 
COMMENT ON COLUMN public.article_media.media_role_code IS 'FK to 
public.media_roles_master.role_code. Role of this media within the article. ON 
DELETE RESTRICT.'; COMMENT ON COLUMN public.article_media.display_order IS 
'Order of appearance for media items, typically within the same article_id and 
media_role_code. Default 1.'; COMMENT ON COLUMN 
public.article_media.caption_override IS 'Optional override for the media''s 
default caption, specific to this article context. Max 500 chars. (Translatable 
via public.translations)'; COMMENT ON COLUMN 
public.article_media.alt_text_override IS 'Optional override for the media''s 
default alt text, specific to this article context. Max 255 chars. 
(Translatable via public.translations)'; COMMENT ON COLUMN 
public.article_media.created_at IS 'Timestamp of when this link was created.'; 
COMMENT ON COLUMN public.article_media.updated_at IS 'Timestamp of when this 
link was last updated (auto-updated by trigger).'; COMMENT ON COLUMN 
public.article_media.created_by_profile_id IS 'Profile ID of the user who 
created this link. FK to profiles.id. ON DELETE SET NULL, ON UPDATE NO 
ACTION.'; COMMENT ON COLUMN public.article_media.updated_by_profile_id IS 
'Profile ID of the user who last updated this link. FK to profiles.id. ON 
DELETE SET NULL, ON UPDATE NO ACTION.'; COMMENT ON CONSTRAINT 
uq_article_media_link ON public.article_media IS 'Ensures a specific media item 
is not linked with the same role multiple times to the same article.'; ``` 4\. 
Triggers/Functions SQL ``` -- Trigger for general updated_at timestamp CREATE 
TRIGGER handle_article_media_updated_at BEFORE UPDATE ON public.article_media 
FOR EACH ROW EXECUTE FUNCTION extensions.moddatetime('updated_at'); COMMENT ON 
TRIGGER handle_article_media_updated_at ON public.article_media IS 
'Automatically updates the updated_at timestamp whenever a row is modified.'; 
-- Trigger function to clean up related translations on delete CREATE OR 
REPLACE FUNCTION public.cleanup_article_media_translations() RETURNS TRIGGER AS 
$$ BEGIN IF TG_OP = 'DELETE' THEN DELETE FROM public.translations WHERE 
table_identifier = 'article_media' AND column_identifier IN 
('caption_override', 'alt_text_override') -- Specify translatable columns AND 
row_foreign_key = OLD.id::text; -- Using the surrogate PK of article_media END 
IF; RETURN OLD; END; $$ LANGUAGE plpgsql SECURITY DEFINER; COMMENT ON FUNCTION 
public.cleanup_article_media_translations() IS 'Removes related entries from 
public.translations for caption_override and alt_text_override when an 
article_media link is deleted. Runs as SECURITY DEFINER. Ensure search_path is 
secure.'; -- Apply the cleanup trigger for translations CREATE TRIGGER 
trigger_cleanup_article_media_translations_after_delete AFTER DELETE ON 
public.article_media FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_article_media_translations(); COMMENT ON TRIGGER 
trigger_cleanup_article_media_translations_after_delete ON public.article_media 
IS 'After an article_media link is deleted, removes its associated translations 
for overrides from the public.translations table.'; ``` 5\. JSON Schema Mirror 
JSON ``` { "title": "article_media", "description": "Links articles to media 
items, defining the role, order, and providing translatable text overrides for 
captions and alt text. Module 8. Version 1.0.", "type": "object", "properties": 
{ "id": { "type": "integer", "format": "int64", "description": "PK. Unique 
identifier for the article-media link.", "readOnly": true }, "article_id": { 
"type": "integer", "format": "int64", "description": "FK to public.articles.id. 
Identifies the article." }, "media_id": { "type": "string", "format": "uuid", 
"description": "FK to public.media.id. Identifies the media item." }, 
"media_role_code": { "type": "string", "description": "FK to 
public.media_roles_master.role_code. Role of this media within the article." }, 
"display_order": { "type": "integer", "default": 1, "minimum": 1, 
"description": "Order of appearance for media items." }, "caption_override": { 
"type": ["string", "null"], "maxLength": 500, "description": "Optional override 
for the media's default caption. Max 500 chars. (Translatable via 
public.translations)" }, "alt_text_override": { "type": ["string", "null"], 
"maxLength": 255, "description": "Optional override for the media's default alt 
text. Max 255 chars. (Translatable via public.translations)" }, "created_at": { 
"type": "string", "format": "date-time", "description": "Timestamp of when this 
link was created.", "readOnly": true }, "updated_at": { "type": "string", 
"format": "date-time", "description": "Timestamp of when this link was last 
updated.", "readOnly": true }, "created_by_profile_id": { "type": ["string", 
"null"], "format": "uuid", "description": "Profile ID of the user who created 
this link. FK to public.profiles." }, "updated_by_profile_id": { "type": 
["string", "null"], "format": "uuid", "description": "Profile ID of the user 
who last updated this link. FK to public.profiles." } }, "required": [ 
"article_id", "media_id", "media_role_code", "display_order" ], "primary_key": 
["id"], "unique_constraints": [ {"columns": ["article_id", "media_id", 
"media_role_code"], "name": "uq_article_media_link"} ], "foreign_keys": [ 
{"columns": ["article_id"], "references_table": "public.articles", 
"references_columns": ["id"], "on_delete": "CASCADE", "on_update": "CASCADE"}, 
{"columns": ["media_id"], "references_table": "public.media", 
"references_columns": ["id"], "on_delete": "RESTRICT", "on_update": "CASCADE"}, 
{"columns": ["media_role_code"], "references_table": 
"public.media_roles_master", "references_columns": ["role_code"], "on_delete": 
"RESTRICT", "on_update": "CASCADE"}, {"columns": ["created_by_profile_id"], 
"references_table": "public.profiles", "references_columns": ["id"], 
"on_delete": "SET NULL", "on_update": "NO ACTION"}, {"columns": 
["updated_by_profile_id"], "references_table": "public.profiles", 
"references_columns": ["id"], "on_delete": "SET NULL", "on_update": "NO 
ACTION"} ] } ``` 6\. Relationships & Integrity - Primary Key: `id` (BIGINT). - 
Foreign Keys: - `article_id` references `public.articles(id) ON DELETE CASCADE 
ON UPDATE CASCADE`. - `media_id` references `public.media(id) ON DELETE 
RESTRICT ON UPDATE CASCADE`. - `media_role_code` references 
`public.media_roles_master(role_code) ON DELETE RESTRICT ON UPDATE CASCADE`. - 
`created_by_profile_id` references `public.profiles(id) ON DELETE SET NULL ON 
UPDATE NO ACTION`. - `updated_by_profile_id` references `public.profiles(id) ON 
DELETE SET NULL ON UPDATE NO ACTION`. - Unique Constraint: 
`uq_article_media_link` on `(article_id, media_id, media_role_code)` prevents 
duplicate linking of the same media with the same role to an article. - Mermaid 
ER Snippet: Code snippet ``` erDiagram articles ||--|{ article_media : 
"has_media_via" media ||--|{ article_media : "linked_to_article_via" 
media_roles_master ||--|{ article_media : "defines_role_for_link" profiles 
||--o{ article_media : "audit_created_by" profiles ||--o{ article_media : 
"audit_updated_by" article_media { BIGINT id PK BIGINT article_id FK UUID 
media_id FK TEXT media_role_code FK INTEGER display_order TEXT caption_override 
"Translatable" TEXT alt_text_override "Translatable" UUID created_by_profile_id 
FK UUID updated_by_profile_id FK TIMESTAMPTZ created_at TIMESTAMPTZ updated_at 
UQ "article_id, media_id, media_role_code" } ``` 7\. Multilingual Strategy - 
Translatable Fields: `caption_override` and `alt_text_override` allow 
context-specific translations for linked media. These store primary reference 
language text directly. - Translated versions are stored in 
`public.translations` linked by `table_identifier = 'article_media'`, 
`column_identifier` (e.g., 'caption_override'), and `row_foreign_key = 
article_media.id::text`. - An `AFTER DELETE` trigger 
(`trigger_cleanup_article_media_translations_after_delete`) ensures orphaned 
translations for these overrides are removed. 8\. Role-Based Workflow & RLS 
Notes - Key Fields: `article_id` (for relating to parent RLS), 
`created_by_profile_id`. - RLS Policies: - Enable RLS: `ALTER TABLE 
public.article_media ENABLE ROW LEVEL SECURITY;` - Force RLS for table owners: 
`ALTER TABLE public.article_media FORCE ROW LEVEL SECURITY;` - 🟢 Policy 1: 
Users can view media links associated with articles they can view. This often 
means checking the status of the parent article. SQL ``` CREATE POLICY "Users 
can view media for viewable articles" ON public.article_media FOR SELECT USING 
( EXISTS ( SELECT 1 FROM public.articles a WHERE a.id = article_id AND 
a.article_status = 'published'::public.content_visibility_status_enum AND 
a.deleted_at IS NULL ) ); ``` - 🟢 Policy 2: Users who can edit an article 
(e.g., author of draft, admin, regional manager for their content) can add, 
update, and delete media links for that article. *(This requires a helper 
function or checking permissions on the parent `articles` table. For 
simplicity, a placeholder for checking parent article edit rights is used).* 
SQL ``` -- Assuming a function like public.can_edit_article(article_id BIGINT) 
RETURNS BOOLEAN CREATE POLICY "Users who can edit articles can manage their 
media links" ON public.article_media FOR ALL USING ( 
public.can_edit_article(article_id) ) -- Placeholder for actual permission 
check logic WITH CHECK ( public.can_edit_article(article_id) ); -- Placeholder 
``` *A more direct approach without a helper function might involve sub-selects 
or joins in the USING clause to check the `articles` table for ownership/role 
permissions, similar to the `articles` RLS policies.* 9\. ENUM vs Lookup 
Discussion - 🟢 `media_role_code` appropriately references the 
`media_roles_master` lookup table. 10\. UI/UX Enablement - Columns powering UI: 
`media_id` (to fetch media details), `media_role_code` (to understand context), 
`display_order`, `caption_override` (translated), `alt_text_override` 
(translated). - Indexed Fields: PK, all FKs, and `(article_id, media_role_code, 
display_order)` for efficient querying of an article's media. 11\. Auditing & 
Lifecycle Management - Audit Columns: `created_at`, `updated_at` 
(auto-managed). `created_by_profile_id`, `updated_by_profile_id`. - Lifecycle: 
These linking records are typically created and deleted as part of managing the 
parent article's content. No separate `is_active` or `deleted_at` on this table 
itself; `ON DELETE CASCADE` from `articles` handles removal. 12\. Scalability & 
Future-Proofing - Scalability: Standard linking table. Performance depends on 
indexing and volume of articles/media. - Future-Proofing: Allows adding more 
media roles over time via `media_roles_master`. 13\. Seed Data - ⚪ N/A - This 
table stores transactional linking data, not predefined master data requiring 
seeding. 14\. Next-Action Checklist - 🔴 Dependency Note: Depends on 
`public.articles`, `public.media`, `public.media_roles_master`, and 
`public.profiles`. Ensure these are created first. The translation cleanup 
trigger depends on `public.translations`. - 🔴 Create Table: Execute DDL for 
`public.article_media`. - 🔴 Create Indexes: Execute DDL for all defined 
indexes. - 🔴 Implement Triggers: - Apply `handle_article_media_updated_at` 
trigger. - Create and apply `public.cleanup_article_media_translations()` 
function and its trigger. - 🔴 Implement RLS Policies: Define and apply RLS 
policies. This may require developing helper functions (e.g., 
`public.can_edit_article(article_id BIGINT)`) or more complex `USING` clauses. 
- 🟠 Application Logic: Develop application logic for managing (adding, 
removing, reordering) media within articles and handling the display of media 
based on its role and overrides. - 🟠 Audit Field Population: Ensure 
`created_by_profile_id` and `updated_by_profile_id` are correctly populated by 
the application layer or appropriate RLS context. * * * * * 
