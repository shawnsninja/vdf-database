# 8.0 overview

  https://gemini.google.com/u/1/app/5b5f3092ace62463 * * * * * Module 8: 
Platform Content - Overview Version: 1.0 Date: May 18, 2025 This document 
provides a master recap and architecture overview for Module 8: Platform 
Content, part of the Via di Francesco Pilgrimage Platform database. It details 
how tables, views, translation mechanisms, security policies, and API 
considerations interlock for managing general platform content like news and 
articles. 1\. Executive Summary Module 8 establishes the framework for 
creating, managing, and displaying dynamic content such as news, blog posts, 
and informational articles on the pilgrimage platform. It supports rich text 
content, multimedia integration (featured images and galleries), author 
attribution, associations with other platform entities (trails, regions, 
towns), and robust multilingual capabilities. The module is designed with clear 
audit trails and Role-Based Access Control (RLS) to ensure content integrity 
and appropriate access. Key outputs include structured data readily consumable 
by frontend applications via a well-defined API, including denormalized views 
for common read patterns. The primary business goals unlocked by this module 
include: - Enhanced user engagement through timely news, articles, and stories. 
- A flexible system for content managers to publish rich, multimedia content. - 
Multilingual presentation of articles to cater to a global audience. - Clear 
attribution and content lifecycle management. 2\. Group-Level Snapshot | Group 
| Key Tables & Views | Primary Purpose | Top Inter-Group Links (Illustrative) | 
| 8\. Platform Content Module | Tables: &lt;br> `public.articles` (v1.0) 
&lt;br> `public.media_roles_master` (v1.0) &lt;br> `public.article_media` 
(v1.0) &lt;br>&lt;br> Views: &lt;br> `public.published_articles_view` (v1.0) 
&lt;br> `public.article_media_details_view` (v1.0) | Manages textual and 
multimedia articles, defines semantic roles for media within articles, and 
links articles to specific media items. Views provide convenient, denormalized 
access to published content and article media. | `articles` to `profiles` 
(Module 1 - for authors, audit) &lt;br> `articles` to `media` (Module 1 - for 
featured image) &lt;br> `article_media` to `media` (Module 1) &lt;br> 
`articles`, `media_roles_master`, `article_media` to `translations` (Module 1 - 
for multilingual content) | 3\. Narrative Walkthrough This module centers 
around the `public.articles` table, which stores the core information for each 
piece of content, such as its title, slug, body, excerpt, author, and 
publication status. Textual fields in `articles` designated as translatable 
store their content in the platform's primary reference language (English), 
with other language versions managed in the `public.translations` table (Module 
1). To support rich multimedia content: - `public.media_roles_master` defines a 
controlled vocabulary for the roles media items can play (e.g., 
`gallery_image`, `inline_image`). This table's descriptive fields are also 
translatable. - `public.article_media` is a linking table connecting an article 
in `public.articles` to one or more media items in `public.media` (Module 1). 
Each link is assigned a role via `media_role_code` (from `media_roles_master`) 
and includes a `display_order`. This table also allows for `caption_override` 
and `alt_text_override` for linked media, specific to its use in that article; 
these overrides are translatable. - The `public.articles` table itself can link 
to a single `featured_image_media_id` directly. Two primary views facilitate 
data retrieval: - `public.published_articles_view`: Provides a denormalized 
look at articles that are published and not deleted, joining with `profiles` 
for author information and `media` for featured image details (in the primary 
reference language). - `public.article_media_details_view`: Offers a 
comprehensive view of all media items linked to articles, including their 
resolved role names, media file details, and any text overrides (in the primary 
reference language). Cleanup triggers are implemented on `articles`, 
`media_roles_master`, and `article_media` to remove orphaned translation 
entries from `public.translations` upon deletion of parent records. 4\. 
Cross-Cutting Concerns - Translations / i18n: - Translatable fields in 
`articles` (`title`, `body_content`, `excerpt`), `media_roles_master` 
(`default_display_name`, `default_description`), and `article_media` 
(`caption_override`, `alt_text_override`) store primary reference language 
(English) text directly. - All other language versions are stored in 
`public.translations` (Module 1), linked by `table_identifier`, 
`column_identifier`, and `row_foreign_key`. - `AFTER DELETE` triggers on these 
three tables ensure orphaned translation entries are removed. - Media Handling: 
- `articles.featured_image_media_id` provides a direct link for a primary 
article image. - The `article_media` table, in conjunction with 
`media_roles_master` and `public.media` (Module 1), facilitates gallery 
functionality and the use of multiple, contextually defined images per article. 
This includes leveraging `media.image_variants_json` for responsive images. - 
Audit / Lifecycle Management: - All tables in this module (`articles`, 
`media_roles_master`, `article_media`) include standard audit columns: 
`created_at`, `updated_at` (with `extensions.moddatetime` trigger), 
`created_by_profile_id`, and `updated_by_profile_id` (referencing 
`public.profiles`). - `articles` uses a `deleted_at` column for soft deletion 
and an `article_status` field (linking to `content_visibility_status_enum`) for 
its lifecycle. - `media_roles_master` uses an `is_active` flag. `article_media` 
links are typically hard-deleted if the parent article is deleted (via `ON 
DELETE CASCADE`). 5\. Security & Access Control ðŸ” - Authentication Provider: 
Supabase Auth is assumed, leveraging JWTs with roles derived from 
`public.profiles.roles`. - RLS Overview: Row-Level Security is applied to all 
tables: - `public.articles`: - Public users can `SELECT` published, non-deleted 
articles. - Authenticated authors can `INSERT`, and `UPDATE`/`DELETE` their own 
articles if in 'draft' or 'pending_review' status. - Users with roles like 
'admin_platform' or 'regional_content_manager' have broader `ALL` permissions 
(potentially with additional checks for regional managers). - 
`public.media_roles_master`: - Public users can `SELECT` active roles. - 
'admin_platform' users can `ALL` (CRUD). - `public.article_media`: - `SELECT` 
access is typically tied to the ability to view the parent article. - 
`INSERT`/`UPDATE`/`DELETE` permissions are tied to edit rights on the parent 
article. - Helper Functions for RLS: Policies will leverage existing helper 
functions like `public.has_role(TEXT)` and may require new specific helpers 
like `public.can_edit_article(article_id BIGINT)`. 6\. API Endpoints Summary 
(Conceptual) Key conceptual API endpoints for Module 8 include: - `GET 
/v1/articles`: Lists published articles with filtering (tags, associated 
entities), sorting, and pagination. Supports `lang` parameter for localized 
content. - `POST /v1/articles`: Creates a new article. Requires appropriate 
authentication and role. - `GET /v1/articles/{slug}`: Retrieves detailed 
information for a single published article by its slug, including full content, 
author, featured image, and media gallery. Supports `lang` parameter. - `GET 
/v1/media-roles`: Lists active media roles. Supports `lang` parameter. - `POST 
/v1/media-roles`: Creates a new media role (admin only). - `GET 
/v1/articles/{article_slug}/media`: Lists all media items associated with a 
specific article. *(Refer to the "Module 8 OpenAPI 3.1 Specification" for 
detailed definitions).* 7\. Prerequisite Objects & Build Order (for Module 8 
components) Assumes Module 1 (`profiles`, `media`, `translations`, 
`languages_master`) and global ENUMs (e.g., `content_visibility_status_enum`) 
are already in place. 1. Table: `public.media_roles_master` (defines roles for 
media) 2. Table: `public.articles` (core content table) 3. Table: 
`public.article_media` (links articles to media) 4. Triggers: Apply 
`updated_at` and translation cleanup triggers to all three tables. 5. Views: - 
`public.published_articles_view` - `public.article_media_details_view` 6. RLS 
Policies: Apply to all tables and potentially views. 7. Seed Data: Populate 
`public.media_roles_master` with initial roles. 8\. Performance & Optimization 
Extras - Key Indexes: All tables have appropriate primary keys, foreign key 
indexes, and specific indexes for common query patterns (e.g., `articles.slug`, 
`articles.article_status`, GIN index on `articles.tags`, composite index on 
`article_media(article_id, media_role_code, display_order)`). - Views: The 
`published_articles_view` and `article_media_details_view` are designed to 
denormalize data for common read operations. - Database Functions: For API 
endpoints requiring complex data assembly (especially with dynamic translations 
for multiple fields and nested objects), creating PostgreSQL functions that 
return JSONB is highly recommended to optimize performance and simplify API 
gateway logic. 9\. Visuals (Conceptual ERD - Module 8 Key Tables & Links) Code 
snippet ``` erDiagram profiles ||--o{ articles : "authored_by" profiles ||--o{ 
articles : "audit_created_by" profiles ||--o{ articles : "audit_updated_by" 
media ||--o{ articles : "featured_image" media_roles_master { TEXT role_code PK 
TEXT default_display_name "Translatable" BOOLEAN is_active -- audit columns } 
articles { BIGINT id PK TEXT title "Translatable" TEXT slug UK TEXT 
body_content "Translatable" UUID author_profile_id FK UUID 
featured_image_media_id FK content_visibility_status_enum article_status -- 
audit columns -- association FKs (trail, region, town) } article_media { BIGINT 
id PK BIGINT article_id FK UUID media_id FK TEXT media_role_code FK INTEGER 
display_order TEXT caption_override "Translatable" -- audit columns } 
translations { BIGINT id PK TEXT table_identifier TEXT column_identifier TEXT 
row_foreign_key TEXT language_code FK -- audit columns } articles ||--|{ 
article_media : "has_gallery_item" media ||--|{ article_media : "is_linked_via" 
media_roles_master ||--|{ article_media : "defines_role_for" articles ..> 
translations : "content_translated_in" media_roles_master ..> translations : 
"role_name_translated_in" article_media ..> translations : 
"override_translated_in" profiles ||--o{ media_roles_master : 
"audit_created_by" profiles ||--o{ media_roles_master : "audit_updated_by" 
profiles ||--o{ article_media : "audit_created_by" profiles ||--o{ 
article_media : "audit_updated_by" ``` 10\. Critical Gaps & Risks (for Module 8 
implementation) - ðŸ”´ Application Logic for Slug Generation: Robust, unique slug 
generation for `articles` needs to be handled at the application layer or via a 
database trigger. - ðŸŸ  Content Ingestion Workflow: The workflow for authors 
creating content in a non-primary-reference language (e.g., Italian) and how it 
gets into `public.articles` (English primary) and `public.translations` 
(Italian version) needs clear definition at the application level. - ðŸŸ  RLS 
Helper Functions: If complex RLS logic is required (e.g., 
`regional_content_manager` access tied to `articles.associated_region_id`), 
dedicated helper functions must be securely implemented and tested. - ðŸŸ  
Translation Quality & Management: While the schema supports translations, the 
process for generating, reviewing, and updating translations is external to 
this DB module's DDL. 11\. Scalability & Future-Proof Notes - The design with 
`articles`, `media_roles_master`, and `article_media` provides a scalable 
solution for managing rich content. - The use of `TEXT` for `body_content` in 
`articles` allows for flexibility (Markdown, HTML). - Consideration for 
Full-Text Search (FTS) on `articles.title`, `articles.body_content`, 
`articles.excerpt`, and `articles.tags` is a V2+ enhancement for improved 
searchability. - The module can be extended with other content types if needed 
in the future. 12\. Next Steps (for Module 8 implementation) - P1 ðŸ”´ Implement 
table DDL for `media_roles_master`, `articles`, and `article_media`. - P1 ðŸ”´ 
Implement all defined indexes and constraints. - P1 ðŸ”´ Implement `updated_at` 
and translation cleanup triggers for all three tables. - P1 ðŸ”´ Implement RLS 
policies for all three tables, including necessary helper functions if any. - 
P1 ðŸŸ¢ Seed initial data for `public.media_roles_master`. - P1 ðŸ”´ Create the 
database views: `public.published_articles_view` and 
`public.article_media_details_view`. - P2 ðŸŸ  Develop and test application-layer 
logic for slug generation and content ingestion/translation workflow. - P2 ðŸŸ  
Define and implement any complex RLS helper functions. - P2 ðŸ”µ Develop API 
endpoints based on the OpenAPI specification, ideally leveraging database 
functions for complex read operations. 
