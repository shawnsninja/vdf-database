# 8.2 media_roles_master

  https://gemini.google.com/u/1/app/5b5f3092ace62463 Production-Ready 
Specification: public.media_roles_master Table Version: 1.0 (Checklist REV 
05-18-25-A Applied) Date: May 18, 2025 1\. Purpose & Primary Use-Cases Mission 
Statement: To define and manage a controlled vocabulary of roles or contexts 
for media items when they are linked to other entities (e.g., an image used as 
a 'gallery_image' in an article, an 'avatar' for a profile, or a 
'featured_image' for a trail). This table provides semantic meaning to media 
links, enabling consistent handling and display across the platform. It forms 
part of Module 8 (Platform Content). 2\. Schema | Column | Data Type | 
Constraints | Description | | `role_code` | `TEXT` | `PRIMARY KEY, NOT NULL, 
CHECK (role_code = lower(role_code) AND role_code ~ '^[a-z0-9_]+$' AND 
char_length(role_code) > 0 AND char_length(role_code) <= 50)` | ðŸŸ  PK. Short, 
unique, machine-readable, lowercase code (e.g., `gallery_image`, 
`profile_avatar`). Max 50 chars. | | `default_display_name` | `TEXT` | `NOT 
NULL, CHECK (char_length(default_display_name) > 0 AND 
char_length(default_display_name) <= 100)` | Human-readable name in the primary 
reference language (e.g., "Gallery Image"). Max 100 chars. (Translatable via 
`public.translations`) | | `default_description` | `TEXT` | `NULLABLE, CHECK 
(default_description IS NULL OR char_length(default_description) <= 255)` | 
Detailed description of the role in the primary reference language. Max 255 
chars. (Translatable via `public.translations`) | | `icon_identifier` | `TEXT` 
| `NULLABLE, CHECK (icon_identifier IS NULL OR char_length(icon_identifier) <= 
50)` | Optional identifier for a UI icon representing the role (e.g., a 
Material Design Icon name). Max 50 chars. | | `is_active` | `BOOLEAN` | `NOT 
NULL, DEFAULT true` | If true, this media role is active and can be assigned in 
linking tables. | | `created_at` | `TIMESTAMPTZ` | `NOT NULL, DEFAULT now()` | 
Timestamp of role definition creation. | | `updated_at` | `TIMESTAMPTZ` | `NOT 
NULL, DEFAULT now()` | Timestamp of last role definition update (auto-updated 
by trigger). | | `created_by_profile_id` | `UUID` | `NULLABLE, REFERENCES 
public.profiles(id) ON DELETE SET NULL ON UPDATE NO ACTION` | Profile ID of the 
user who initially created this role. | | `updated_by_profile_id` | `UUID` | 
`NULLABLE, REFERENCES public.profiles(id) ON DELETE SET NULL ON UPDATE NO 
ACTION` | Profile ID of the user who last updated this role. | 3\. PostgreSQL 
DDL SQL ``` CREATE TABLE public.media_roles_master ( role_code TEXT NOT NULL 
PRIMARY KEY, default_display_name TEXT NOT NULL, default_description TEXT NULL, 
icon_identifier TEXT NULL, is_active BOOLEAN NOT NULL DEFAULT true, created_at 
TIMESTAMPTZ NOT NULL DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL DEFAULT 
now(), created_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE 
SET NULL ON UPDATE NO ACTION, updated_by_profile_id UUID NULL REFERENCES 
public.profiles(id) ON DELETE SET NULL ON UPDATE NO ACTION, CONSTRAINT 
check_media_role_code_format CHECK (role_code = lower(role_code) AND role_code 
~ '^[a-z0-9_]+$' AND char_length(role_code) > 0 AND char_length(role_code) <= 
50), CONSTRAINT check_media_role_default_display_name_length CHECK 
(char_length(default_display_name) > 0 AND char_length(default_display_name) <= 
100), CONSTRAINT check_media_role_default_description_length CHECK 
(default_description IS NULL OR char_length(default_description) <= 255), 
CONSTRAINT check_media_role_icon_identifier_length CHECK (icon_identifier IS 
NULL OR char_length(icon_identifier) <= 50) ); -- Indexes CREATE INDEX 
idx_media_roles_master_is_active ON public.media_roles_master (is_active); 
CREATE INDEX idx_media_roles_master_created_by_profile_id ON 
public.media_roles_master (created_by_profile_id) WHERE created_by_profile_id 
IS NOT NULL; CREATE INDEX idx_media_roles_master_updated_by_profile_id ON 
public.media_roles_master (updated_by_profile_id) WHERE updated_by_profile_id 
IS NOT NULL; -- Comments COMMENT ON TABLE public.media_roles_master IS 'Defines 
a controlled vocabulary of roles for media items when linked to other entities 
(e.g., gallery_image for an article). Module 8. Version 1.0.'; COMMENT ON 
COLUMN public.media_roles_master.role_code IS 'PK. Machine-readable code (e.g., 
gallery_image, profile_avatar). Lowercase, snake_case, >0 and <=50 chars.'; 
COMMENT ON COLUMN public.media_roles_master.default_display_name IS 'Default 
human-readable name in the primary reference language (e.g., "Gallery Image"). 
>0 and <=100 chars. (Translatable via public.translations)'; COMMENT ON COLUMN 
public.media_roles_master.default_description IS 'Default detailed description 
of the role in the primary reference language. Max 255 chars. (Translatable via 
public.translations)'; COMMENT ON COLUMN 
public.media_roles_master.icon_identifier IS 'Optional identifier for a UI icon 
representing the role (e.g., a Material Design Icon name). Max 50 chars.'; 
COMMENT ON COLUMN public.media_roles_master.is_active IS 'If true, this media 
role is active and can be assigned in linking tables. Default is true.'; 
COMMENT ON COLUMN public.media_roles_master.created_at IS 'Timestamp of role 
definition creation.'; COMMENT ON COLUMN public.media_roles_master.updated_at 
IS 'Timestamp of last role definition update (auto-updated by trigger).'; 
COMMENT ON COLUMN public.media_roles_master.created_by_profile_id IS 'Profile 
ID of the user who initially created this role. FK to profiles.id. ON DELETE 
SET NULL, ON UPDATE NO ACTION.'; COMMENT ON COLUMN 
public.media_roles_master.updated_by_profile_id IS 'Profile ID of the user who 
last updated this role. FK to profiles.id. ON DELETE SET NULL, ON UPDATE NO 
ACTION.'; ``` 4\. Triggers/Functions SQL ``` -- Trigger for general updated_at 
timestamp CREATE TRIGGER handle_media_roles_master_updated_at BEFORE UPDATE ON 
public.media_roles_master FOR EACH ROW EXECUTE FUNCTION 
extensions.moddatetime('updated_at'); COMMENT ON TRIGGER 
handle_media_roles_master_updated_at ON public.media_roles_master IS 
'Automatically updates the updated_at timestamp whenever a row is modified.'; 
-- Trigger function to clean up related translations on delete CREATE OR 
REPLACE FUNCTION public.cleanup_media_roles_master_translations() RETURNS 
TRIGGER AS $$ BEGIN IF TG_OP = 'DELETE' THEN DELETE FROM public.translations 
WHERE table_identifier = 'media_roles_master' AND column_identifier IN 
('default_display_name', 'default_description') -- Specify translatable columns 
AND row_foreign_key = OLD.role_code; END IF; RETURN OLD; END; $$ LANGUAGE 
plpgsql SECURITY DEFINER; COMMENT ON FUNCTION 
public.cleanup_media_roles_master_translations() IS 'Removes related entries 
from public.translations for default_display_name and default_description when 
a media_roles_master entry is deleted. Runs as SECURITY DEFINER. Ensure 
search_path is secure.'; -- Apply the cleanup trigger for translations CREATE 
TRIGGER trigger_cleanup_media_roles_master_translations_after_delete AFTER 
DELETE ON public.media_roles_master FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_media_roles_master_translations(); COMMENT ON TRIGGER 
trigger_cleanup_media_roles_master_translations_after_delete ON 
public.media_roles_master IS 'After a media role is deleted, removes its 
associated translations from the public.translations table.'; ``` 5\. JSON 
Schema Mirror JSON ``` { "title": "media_role_master", "description": "Defines 
a controlled vocabulary of roles for media items (e.g., gallery_image for an 
article). Module 8. Version 1.0.", "type": "object", "properties": { 
"role_code": { "type": "string", "description": "PK. Machine-readable code 
(e.g., gallery_image, profile_avatar). Lowercase, snake_case, >0 and <=50 
chars.", "pattern": "^[a-z0-9_]+$", "minLength": 1, "maxLength": 50 }, 
"default_display_name": { "type": "string", "description": "Default 
human-readable name in the primary reference language (e.g., \"Gallery 
Image\"). >0 and <=100 chars. (Translatable via public.translations)", 
"minLength": 1, "maxLength": 100 }, "default_description": { "type": ["string", 
"null"], "description": "Default detailed description of the role in the 
primary reference language. Max 255 chars. (Translatable via 
public.translations)", "maxLength": 255 }, "icon_identifier": { "type": 
["string", "null"], "description": "Optional identifier for a UI icon 
representing the role (e.g., a Material Design Icon name). Max 50 chars.", 
"maxLength": 50 }, "is_active": { "type": "boolean", "default": true, 
"description": "If true, this media role is active and can be assigned in 
linking tables." }, "created_at": { "type": "string", "format": "date-time", 
"description": "Timestamp of role definition creation.", "readOnly": true }, 
"updated_at": { "type": "string", "format": "date-time", "description": 
"Timestamp of last role definition update.", "readOnly": true }, 
"created_by_profile_id": { "type": ["string", "null"], "format": "uuid", 
"description": "Profile ID of the user who initially created this role. FK to 
public.profiles." }, "updated_by_profile_id": { "type": ["string", "null"], 
"format": "uuid", "description": "Profile ID of the user who last updated this 
role. FK to public.profiles." } }, "required": [ "role_code", 
"default_display_name", "is_active" ], "primary_key": ["role_code"], 
"foreign_keys": [ {"columns": ["created_by_profile_id"], "references_table": 
"public.profiles", "references_columns": ["id"], "on_delete": "SET NULL", 
"on_update": "NO ACTION"}, {"columns": ["updated_by_profile_id"], 
"references_table": "public.profiles", "references_columns": ["id"], 
"on_delete": "SET NULL", "on_update": "NO ACTION"} ] } ``` 6\. Relationships & 
Integrity - Primary Key: `role_code` (TEXT). - Foreign Keys: - 
`created_by_profile_id` references `public.profiles(id) ON DELETE SET NULL ON 
UPDATE NO ACTION`. - `updated_by_profile_id` references `public.profiles(id) ON 
DELETE SET NULL ON UPDATE NO ACTION`. - Referenced By: This table will be 
referenced by various `[entity]_media` linking tables (e.g., 
`public.article_media.media_role_code`). `ON DELETE RESTRICT` should be 
considered for these incoming FKs to prevent deletion of a role if it's in use. 
- Mermaid ER Snippet: Code snippet ``` erDiagram profiles ||--o{ 
media_roles_master : "audit_created_by" profiles ||--o{ media_roles_master : 
"audit_updated_by" article_media }o--|| media_roles_master : "uses_role" 
media_roles_master { TEXT role_code PK TEXT default_display_name "Translatable" 
TEXT default_description "Translatable" TEXT icon_identifier BOOLEAN is_active 
UUID created_by_profile_id FK UUID updated_by_profile_id FK TIMESTAMPTZ 
created_at TIMESTAMPTZ updated_at } ``` 7\. Multilingual Strategy - 
Translatable Fields: `default_display_name` and `default_description` store 
their primary reference language text (English) directly. - Translated versions 
are stored in `public.translations` linked by `table_identifier = 
'media_roles_master'`, `column_identifier` (e.g., 'default_display_name'), and 
`row_foreign_key = media_roles_master.role_code`. - An `AFTER DELETE` trigger 
(`trigger_cleanup_media_roles_master_translations_after_delete`) ensures 
orphaned translations are removed. 8\. Role-Based Workflow & RLS Notes - Key 
Fields: `is_active`. - RLS Policies: - Enable RLS: `ALTER TABLE 
public.media_roles_master ENABLE ROW LEVEL SECURITY;` - Force RLS for table 
owners: `ALTER TABLE public.media_roles_master FORCE ROW LEVEL SECURITY;` - ðŸŸ¢ 
Policy 1: Allow public read access to active media role definitions. SQL ``` 
CREATE POLICY "Public can read active media roles" ON public.media_roles_master 
FOR SELECT USING (is_active = true); ``` - ðŸŸ¢ Policy 2: Allow platform 
administrators to manage all media role definitions. SQL ``` CREATE POLICY 
"Admins can manage all media roles" ON public.media_roles_master FOR ALL USING 
(public.has_role('admin_platform') OR public.has_role('admin_super')) -- Using 
example roles WITH CHECK (public.has_role('admin_platform') OR 
public.has_role('admin_super')); ``` - ðŸŸ  Caution: Deactivating roles 
(`is_active = false`) is preferred over deletion if roles are in use by 
`[entity]_media` tables, especially if those linking tables use `ON DELETE 
RESTRICT`. 9\. ENUM vs Lookup Discussion - ðŸŸ¢ This table *is* a lookup table 
(master table) and is appropriately designed as such to provide flexibility and 
descriptive attributes for media roles. 10\. UI/UX Enablement - Columns 
powering UI: `role_code`, `default_display_name` (translated), 
`default_description` (translated), `icon_identifier`. - Indexed Fields: PK 
(`role_code`), `is_active`. 11\. Auditing & Lifecycle Management - Audit 
Columns: `created_at`, `updated_at` (auto-managed via `extensions.moddatetime` 
trigger). `created_by_profile_id`, `updated_by_profile_id` for tracking user 
actions. - Lifecycle: Role availability is managed by the `is_active` flag. 
12\. Scalability & Future-Proofing - Scalability: The table is expected to 
remain small and performant. - Future-Proofing: The structure is robust. 
`icon_identifier` provides UI flexibility. New roles can be added easily. 13\. 
Seed Data - ðŸŸ¢ Example Seed Data (Primary reference language: English): | 
role_code | default_display_name | default_description | icon_identifier | 
is_active | created_by_profile_id | updated_by_profile_id | | 
:-------------------- | :------------------------ | 
:---------------------------------------- | :-------------- | :-------- | 
:-------------------- | :-------------------- | | `gallery_image` | `Gallery 
Image` | `Image used in a content gallery.` | `image_aspect_ratio` | `true` | 
`[ADMIN_UUID]` | `[ADMIN_UUID]` | | `inline_image` | `Inline Content Image` | 
`Image embedded within body text.` | `image` | `true` | `[ADMIN_UUID]` | 
`[ADMIN_UUID]` | | `featured_image` | `Featured Image` | `Primary 
representative image.` | `star` | `true` | `[ADMIN_UUID]` | `[ADMIN_UUID]` | | 
`profile_avatar` | `Profile Avatar` | `User's public avatar image.` | `person` 
| `true` | `[ADMIN_UUID]` | `[ADMIN_UUID]` | | `background_image` | `Background 
Image` | `Image used for backgrounds or banners.` | `landscape` | `true` | 
`[ADMIN_UUID]` | `[ADMIN_UUID]` | *(`[ADMIN_UUID]` is a placeholder for an 
actual admin/system user profile ID). 14\. Next-Action Checklist - ðŸ”´ 
Dependency Note: The DDL includes FKs to `public.profiles`. Ensure 
`public.profiles` table exists before these constraints are applied. The 
translation cleanup trigger depends on `public.translations`. - ðŸ”´ Create 
Table: Execute DDL for `public.media_roles_master`. - ðŸ”´ Create Indexes: 
Execute DDL for defined indexes. - ðŸ”´ Implement Triggers: - Apply 
`handle_media_roles_master_updated_at` trigger. - Create and apply 
`public.cleanup_media_roles_master_translations()` function and its trigger. - 
ðŸ”´ Implement RLS Policies: Define and apply RLS policies as specified. - ðŸ”´ 
Pre-populate Seed Data: Insert initial V1 media roles as suggested. - ðŸŸ¢ Define 
`icon_identifier` Convention: If used, establish a clear convention for 
`icon_identifier` assets. - ðŸŸ  Audit Field Population: Confirm and document the 
process for populating `created_by_profile_id` and `updated_by_profile_id`. * * 
* * * 
