# 1.0 overview - User & Content Infrastructure Module

  https://gemini.google.com/u/1/app/2bce50b57d89d351 
https://gemini.google.com/u/1/app/440838222ac514d7 
https://gemini.google.com/u/1/app/1881f72a50cc0fbc * * * * * User & Content 
Infrastructure Module Overview ============================================= 
Version: 2.3 (Clarifications on Translatable Field Handling and API 
Representation) Date: May 18, 2025 This document provides a master recap and 
architecture overview for the User & Content Infrastructure Module of the 
pilgrimage-platform database. It details how tables, ENUMs, translation 
mechanisms, security policies, API considerations, and other database objects 
interlock, along with a recommended build order for successful deployment. The 
five key tables forming this module are `profiles`, `user_roles_master`, 
`languages_master`, `media`, and `translations`. 1\. Executive Summary 
--------------------- This database module establishes the foundational 
framework for managing users, their roles (synchronized to 
auth.users.raw_app_meta_data.roles for JWT inclusion), multilingual content, 
and media assets within the pilgrimage platform. It enables core 
functionalities such as user authentication extensions (via Supabase Auth), 
role-based access control (RBAC), personalized user experiences, user activity 
tracking (via profiles.last_activity_at), and a centralized system for handling 
all platform media. Key enhancements include standardized audit columns 
(created_by_profile_id, updated_by_profile_id) across all tables for better 
tracking, and icon_identifier fields for improved UI consistency in master 
tables. A core principle for multilingual content is that main table columns 
designated as translatable (e.g., user_roles_master.default_display_name, 
media.default_alt_text) store their content directly in the primary reference 
language (English). The public.translations table then stores the corresponding 
text for all other supported languages. The API representation makes this clear 
by providing the base field (e.g., default_alt_text containing English) and a 
corresponding default_alt_text_translations object for other languages. Primary 
business goals unlocked include: - Secure and distinct user data management 
extending Supabase's authentication. - Flexible permission systems through 
defined user roles available in JWTs. - Global reach via robust multilingual 
support for platform content and UI, with English as the primary reference 
language directly in main tables and other languages managed through a central 
`translations` table. - Efficient management and delivery of media assets like 
images, with comprehensive audit trails and translatable descriptive text. * * 
* * * 2\. Group-Level Snapshot ------------------------ | Group | Key Tables | 
Primary Purpose | Top Inter-Group Links | | 1\. User & Content Infrastructure 
Module | `profiles`, `user_roles_master`, `languages_master`, `media`, 
`translations` | Manages user-specific data (including roles synchronized to 
auth system), defines roles, lists supported languages, stores media metadata, 
and holds translations for content across the platform. Primary language 
(English) content resides in main tables; other languages are in 
`translations`. | `profiles` to `auth.users` (Supabase built-in, including 
`raw_app_meta_data.roles` sync) &lt;br> `profiles` to `media` (for avatars) 
&lt;br> `profiles` to `languages_master` (for preferred language) &lt;br> All 
tables to `profiles` (for `created_by_profile_id`, `updated_by_profile_id` 
audit fields) &lt;br> Various tables to `translations` & `media`. | * * * * * 
3\. Narrative Walkthrough ------------------------- This module forms the 
bedrock for user identity, permissions, internationalization (i18n), and media 
management. - `languages_master` (v2.1): - Definitive list of supported 
languages for the platform. - Stores `language_code`, native name 
(`display_name_native`), English name (`display_name_en` - this specific `_en` 
suffix is intentional in the DB), `icon_identifier`, active/primary flags, and 
standard audit columns. - Powers language selectors and guides the 
`translations` system. `is_primary_content_language` flags the reference 
language (English). - `user_roles_master` (v2.1): - Defines all application 
roles (e.g., 'pilgrim_user'). - Holds `role_code`, the default display name and 
description in the primary reference language (English) directly in 
`default_display_name` and `default_description` columns, `icon_identifier`, 
hierarchy level, system/active flags, and standard audit columns. These English 
texts are translatable via `public.translations` for other languages. - Source 
for role definitions. `AFTER DELETE` trigger cleans associated entries in 
`public.translations`. `profiles.roles` are validated against this table. - 
`profiles` (v2.3): - Extends `auth.users` (1:1). Stores app-specific user data. 
- Includes `roles` array (source of truth, synchronized to 
`auth.users.raw_app_meta_data.roles` via triggers), preferences, public info 
(e.g., `public_bio` stored in language of submission or primary reference 
language), `account_status`, `last_activity_at`, and standard audit columns. 
`public_bio` can be translated via `public.translations` if it becomes 
centrally managed. - Triggers: `handle_new_user` (creates profile, sets initial 
roles in `profiles` and `auth.users`), `check_profile_roles` (validates roles), 
`sync_profile_roles_to_auth_user` (updates `auth.users.raw_app_meta_data.roles` 
on `profiles.roles` change). - `media` (v2.2): - Central metadata for media 
files. - Stores Storage refs, `uploader_profile_id` (effectively 
`created_by_profile_id`), `updated_by_profile_id` (for moderation/admin edits), 
default alternative text (`default_alt_text`) and caption (`default_caption`) 
in the primary reference language (English) directly in their respective 
columns, `image_variants_json`, `media_status`, `last_linked_or_used_at`. These 
English texts are translatable via `public.translations`. - `AFTER DELETE` 
trigger cleans associated entries in `public.translations`. ENUMs for types, 
licenses, statuses. - `translations` (v2.1): - Stores translated text for 
fields from other tables that are not in the primary reference language 
(English). - Links `language_code` to text identified by `table_identifier`, 
`column_identifier`, `row_foreign_key`. - Includes `translation_status`, 
`translated_by_profile_id` (content author), `translation_last_updated_at`, and 
standard row audit columns (`created_by_profile_id`, `updated_by_profile_id`). 
- Orphaned translation cleanup is critical and handled by `AFTER DELETE` 
triggers on the parent tables (e.g., `user_roles_master`, `media`). * * * * * 
4\. Cross-Cutting Concerns -------------------------- - Users & Roles: - 
`profiles.roles` is the primary store for a user's roles, synchronized to 
`auth.users.raw_app_meta_data.roles` for JWT inclusion. - Standard audit 
columns (`created_by_profile_id`, `updated_by_profile_id` referencing 
`profiles.id`) are on all tables in this module. `uploader_profile_id` in 
`media` serves as its `created_by_profile_id`. - Translations / i18n: - 
`languages_master` defines supported languages. The primary reference language 
(English) content is stored directly in the main columns of translatable tables 
(e.g., `user_roles_master.default_display_name`, `media.default_alt_text`). The 
only exception is `languages_master.display_name_en`, which is an explicit 
column for the English name of a language. - The `public.translations` table 
stores text for all other languages. - API representation will provide the base 
field containing the English text (e.g., `default_alt_text`) and a 
corresponding `default_alt_text_translations` object (e.g. `{ "it": "Testo 
alternativo italiano" }`) for other languages. If a `lang` parameter is used in 
an API request, the base field itself may be resolved to the requested 
language. - `AFTER DELETE` triggers on parent tables (e.g., 
`user_roles_master`, `media`) are critical for removing orphaned `translations` 
entries. - ENUM & Taxonomy Registry: - `profiles`: `units_preference_enum`, 
`pilgrim_experience_enum`, `user_account_status_enum`. - `media`: 
`media_asset_type_enum`, `media_licence_enum`, `media_status_enum`. - 
`languages_master`, `user_roles_master` include `icon_identifier`. - Media & 
Files: - Files reside in Supabase Storage. - The `media` table holds metadata, 
including `image_variants_json` (populated by application/backend processes) 
and `last_linked_or_used_at` to aid in cleaning up unlinked media. - Audit / 
Soft-Delete / Versioning: - Standard Audit Columns: All tables include 
`created_at`, `updated_at` (with `extensions.moddatetime` trigger or 
equivalent), `created_by_profile_id`, and `updated_by_profile_id`. For `media`, 
`uploader_profile_id` is analogous to `created_by_profile_id`. - `profiles` 
includes `last_activity_at`. - Soft Deletes: `profiles.account_status` manages 
user account lifecycle; `user_roles_master.deleted_at` (complemented by 
`is_role_active`); `media.deleted_at`. * * * * * 5\. Security & Access Control 
ğŸ” -------------------------------- - Authentication Provider: Supabase Auth is 
utilized, leveraging JWTs. - Roles from `public.profiles.roles` are 
synchronized to `auth.users.raw_app_meta_data.roles` for availability in JWT 
claims. - RLS Overview: Extensively applied across all tables. Policies are 
defined in individual table specifications. - Dedicated SECURITY DEFINER 
Functions: - `public.check_profile_roles()` - `public.handle_new_user()` 
(updated to also set `auth.users.raw_app_meta_data.roles` and 
`profiles.last_activity_at`) - `public.sync_profile_roles_to_auth_user()` (new, 
for `profiles` trigger to update `auth.users`) - 
`public.cleanup_user_roles_master_translations()` - 
`public.cleanup_media_translations()` - `public.cleanup_profile_translations()` 
(conditional, if `profiles.public_bio` becomes system-translatable) - 
Conceptual `public.update_media_last_linked_timestamp()` to be triggered by 
media linking tables. - Key Helper Functions for RLS (typically `STABLE 
SECURITY INVOKER` or `SECURITY DEFINER` with caution): - 
`public.has_role(TEXT)` (checks current authenticated user's roles from 
`profiles` or JWT claim) - `public.has_role_on_profile(UUID, TEXT)` (checks a 
specific user's roles) - (Other administrative check functions like 
`is_platform_admin()` can be built using these.) * * * * * 6\. API Endpoints 
Summary ------------------------- This module provides foundational data for 
users, content structure, and internationalization. Key conceptual API 
endpoints, as detailed in the "API Specification Conceptualization - User & 
Content Infrastructure Module (v1.0)", include: - `GET /profiles/me`: Retrieves 
the current authenticated user's profile. Translatable fields like `public_bio` 
will be returned in the language specified by the `lang` parameter if a 
translation exists, otherwise in the primary reference language (English). A 
`public_bio_translations` object may also provide all available language 
versions. Role details and avatar information can be included. - `GET 
/languages`: Lists available platform languages, filterable and sortable. - 
`GET /media/{media_id}`: Fetches a media item's details. Translatable fields 
like `default_alt_text` and `default_caption` are resolved based on the `lang` 
parameter, with the base field containing English and a `*_translations` object 
providing other versions. The API design ensures that the primary reference 
language (English) content is directly available in base fields (e.g., 
`media.default_alt_text`), with translations for other languages accessible via 
a corresponding `[fieldname]_translations` object. * * * * * 7\. Prerequisite 
Objects & Build Order âš™ï¸ ----------------------------------------- The build 
order assumes `auth.users` table and `extensions.moddatetime` function (or an 
equivalent `handle_updated_at` that also manages `updated_by_profile_id`) 
exist. Foreign keys for audit columns (`created_by_profile_id`, 
`updated_by_profile_id`) on `languages_master`, `user_roles_master`, and 
`media` linking to `public.profiles` are typically added via `ALTER TABLE` 
after `public.profiles` is created to manage dependencies. 1. Global Helper 
Functions (SQL/PLPGSQL) (Define public.has_role(TEXT) and 
public.has_role_on_profile(UUID, TEXT). Their full implementation depends on 
profiles.) SQL ``` -- Example stubs if profiles not yet available for full 
function definition CREATE OR REPLACE FUNCTION public.has_role(role_to_check 
TEXT) RETURNS BOOLEAN AS $$BEGIN RETURN FALSE; END;$$ LANGUAGE plpgsql STABLE 
SECURITY INVOKER; -- [cite: 209] CREATE OR REPLACE FUNCTION 
public.has_role_on_profile(target_user_id uuid, role_to_check TEXT) RETURNS 
BOOLEAN AS $$BEGIN RETURN FALSE; END;$$ LANGUAGE plpgsql STABLE SECURITY 
INVOKER; -- [cite: 210] ``` 2. Types & ENUMs SQL ``` DO $$ BEGIN IF NOT EXISTS 
(SELECT 1 FROM pg_type WHERE typname = 'units_preference_enum') THEN CREATE 
TYPE public.units_preference_enum AS ENUM ('metric', 'imperial'); END IF; -- 
[cite: 211, 483] IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 
'pilgrim_experience_enum') THEN CREATE TYPE public.pilgrim_experience_enum AS 
ENUM ('novice_first_pilgrimage', 'intermediate_few_pilgrimages', 
'experienced_many_pilgrimages', 'long_distance_veteran'); END IF; -- [cite: 
212, 483] IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 
'user_account_status_enum') THEN CREATE TYPE public.user_account_status_enum AS 
ENUM ('active', 'pending_verification', 'email_unconfirmed', 
'suspended_by_admin', 'deactivated_by_user'); END IF; -- [cite: 213, 484] IF 
NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'media_asset_type_enum') THEN 
CREATE TYPE public.media_asset_type_enum AS ENUM ('image', 'document_pdf', 
'audio_clip', 'video_clip', 'gpx_file', 'other_file'); END IF; -- [cite: 214, 
1101] IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 
'media_licence_enum') THEN CREATE TYPE public.media_licence_enum AS ENUM 
('all_rights_reserved', 'cc_by', 'cc_by_sa', 'cc_by_nd', 'cc_by_nc', 
'cc_by_nc_sa', 'cc_by_nc_nd', 'cc0_public_domain', 
'uploader_owns_contact_for_use', 'official_permission_granted', 
'unknown_licence'); END IF; -- [cite: 215, 1102] IF NOT EXISTS (SELECT 1 FROM 
pg_type WHERE typname = 'media_status_enum') THEN CREATE TYPE 
public.media_status_enum AS ENUM ('processing_upload', 'pending_review', 
'published_approved', 'rejected_hidden', 'archived', 'error_uploading'); END 
IF; -- [cite: 216, 1103] END$$; ``` 3. Core Tables & Deferred FK Constraints 
(DDL extracts based on individual table specs V2.1/V2.2/V2.3) SQL ``` -- 
languages_master table (v2.1) CREATE TABLE public.languages_master ( -- [cite: 
218] language_code text NOT NULL PRIMARY KEY, display_name_native text NOT 
NULL, -- [cite: 770] display_name_en text NOT NULL, -- [cite: 775] Note: "_en" 
is intentional here icon_identifier text NULL, -- [cite: 779] 
is_active_for_platform boolean NOT NULL DEFAULT false, -- [cite: 783] 
is_primary_content_language boolean NOT NULL DEFAULT false, -- [cite: 786] 
display_order_ui integer NULL UNIQUE, -- [cite: 790] created_at timestamp with 
time zone NOT NULL DEFAULT now(), -- [cite: 218, 793] updated_at timestamp with 
time zone NOT NULL DEFAULT now(), -- [cite: 218, 796] created_by_profile_id 
uuid NULL, -- [cite: 218, 800] updated_by_profile_id uuid NULL, -- [cite: 218, 
804] CONSTRAINT check_language_code_format CHECK (language_code ~ 
'^[a-z]{2}(-[A-Z]{2})?$' AND char_length(language_code) >= 2 AND 
char_length(language_code) <= 5) -- [cite: 218, 765] ); -- user_roles_master 
table (v2.1) CREATE TABLE public.user_roles_master ( -- [cite: 219] role_code 
text NOT NULL PRIMARY KEY, -- [cite: 595] default_display_name text NOT NULL, 
-- Stores English [cite: 219, 601] default_description text NULL, -- Stores 
English [cite: 219, 607] icon_identifier text NULL, -- [cite: 219, 613] 
permissions_summary_json jsonb NULL, -- [cite: 220, 617] role_hierarchy_level 
integer NULL, -- [cite: 220, 623] is_system_role boolean NOT NULL DEFAULT 
false, -- [cite: 220, 629] is_role_active boolean NOT NULL DEFAULT true, -- 
[cite: 220, 635] default_for_new_pilgrim_users boolean NOT NULL DEFAULT false, 
-- [cite: 220, 639] created_at timestamp with time zone NOT NULL DEFAULT now(), 
-- [cite: 220, 644] updated_at timestamp with time zone NOT NULL DEFAULT now(), 
-- [cite: 220, 647] created_by_profile_id uuid NULL, -- [cite: 220, 651] 
updated_by_profile_id uuid NULL, -- [cite: 220, 655] deleted_at timestamp with 
time zone NULL, -- [cite: 220, 659] CONSTRAINT check_role_code_format CHECK 
(role_code = lower(role_code) AND role_code ~ '^[a-z0-9_]+$') -- [cite: 220, 
594] ); -- media table (v2.2) CREATE TABLE public.media ( -- [cite: 221] id 
uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY, -- [cite: 1012] 
uploader_profile_id uuid NULL, -- Serves as created_by [cite: 221, 1015] 
storage_bucket_name text NOT NULL, -- [cite: 221, 1020] 
storage_object_path_original text NOT NULL UNIQUE, -- [cite: 221, 1023] 
file_name_original text NOT NULL, -- [cite: 221, 1026] file_mime_type text NOT 
NULL, -- [cite: 221, 1030] file_size_bytes_original bigint NULL CHECK 
(file_size_bytes_original IS NULL OR file_size_bytes_original > 0), -- [cite: 
221, 1033] image_width_px_original integer NULL CHECK (image_width_px_original 
IS NULL OR image_width_px_original > 0), -- [cite: 222, 1036] 
image_height_px_original integer NULL CHECK (image_height_px_original IS NULL 
OR image_height_px_original > 0), -- [cite: 222, 1039] image_variants_json 
jsonb NULL, -- [cite: 222, 1044] default_alt_text text NULL, -- Stores English 
[cite: 222, 1048] default_caption text NULL, -- Stores English [cite: 222, 
1052] attribution_text text NULL, -- [cite: 222, 1056] attribution_url text 
NULL CHECK (attribution_url IS NULL OR attribution_url ~* '^https?://.+'), -- 
[cite: 222, 1062] licence public.media_licence_enum NULL DEFAULT 
'all_rights_reserved', -- [cite: 222, 1065] media_asset_type 
public.media_asset_type_enum NOT NULL DEFAULT 'image', -- [cite: 222, 1067] 
media_status public.media_status_enum NOT NULL DEFAULT 'pending_review', -- 
[cite: 222, 1071] tags text[] NULL, -- [cite: 223, 1074] 
checksum_sha256_original text NULL UNIQUE, -- [cite: 223, 1077] 
dominant_color_hex text NULL CHECK (dominant_color_hex IS NULL OR 
dominant_color_hex ~ '^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$'), -- [cite: 223, 
1081] last_linked_or_used_at timestamp with time zone NULL, -- [cite: 223, 
1085] created_at timestamp with time zone NOT NULL DEFAULT now(), -- [cite: 
223, 1088] updated_at timestamp with time zone NOT NULL DEFAULT now(), -- 
[cite: 223, 1090] updated_by_profile_id uuid NULL, -- [cite: 224, 1095] 
deleted_at timestamp with time zone NULL -- [cite: 224, 1098] ); -- profiles 
table (v2.3) CREATE TABLE public.profiles ( -- [cite: 224] id uuid NOT NULL 
PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE, -- [cite: 224, 381] 
roles text[] NOT NULL, -- [cite: 224, 385] username text NULL UNIQUE, -- [cite: 
224, 390] full_name text NULL, -- [cite: 224, 394] public_display_name text 
NULL UNIQUE, -- [cite: 224, 399] public_avatar_media_id uuid NULL REFERENCES 
public.media(id) ON DELETE SET NULL, -- [cite: 225, 403] public_bio text NULL, 
-- Stores content in primary ref lang or lang of submission [cite: 225, 407] 
preferred_language_code text NOT NULL DEFAULT 'en' REFERENCES 
public.languages_master(language_code) ON UPDATE CASCADE ON DELETE RESTRICT, -- 
[cite: 225, 412] preferred_units_of_measure public.units_preference_enum NOT 
NULL DEFAULT 'metric', -- [cite: 225, 415] preferred_timezone text NULL DEFAULT 
'Europe/Rome', -- [cite: 225, 419] pilgrim_experience_level 
public.pilgrim_experience_enum NULL, -- [cite: 226, 422] 
pilgrimage_interests_tags text[] NULL, -- [cite: 226, 426] 
contributor_organization_name text NULL, -- [cite: 226, 430] 
contributor_organization_role text NULL, -- [cite: 226, 434] 
contact_public_email text NULL, -- [cite: 226, 438] website_url_profile text 
NULL, -- [cite: 226, 442] notification_preferences_json jsonb NULL, -- [cite: 
226, 445] is_profile_publicly_visible boolean NOT NULL DEFAULT false, -- [cite: 
226, 449] contribution_score integer NOT NULL DEFAULT 0, -- [cite: 226, 453] 
account_status public.user_account_status_enum NOT NULL DEFAULT 'active', -- 
[cite: 226, 456] terms_accepted_at timestamp with time zone NULL, -- [cite: 
226, 460] last_login_at timestamp with time zone NULL, -- [cite: 226, 463] 
last_activity_at timestamp with time zone NULL, -- [cite: 226, 467] created_at 
timestamp with time zone NOT NULL DEFAULT now(), -- [cite: 226, 471] updated_at 
timestamp with time zone NOT NULL DEFAULT now(), -- [cite: 227, 475] 
updated_by_profile_id uuid NULL REFERENCES public.profiles(id) ON DELETE SET 
NULL, -- [cite: 227, 480] CONSTRAINT check_preferred_language_code_format CHECK 
(preferred_language_code ~ '^[a-z]{2}(-[A-Z]{2})?$'), -- [cite: 227, 412] 
CONSTRAINT check_contact_public_email_format CHECK (contact_public_email IS 
NULL OR contact_public_email ~* 
'^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'), -- [cite: 227, 438] 
CONSTRAINT check_website_url_profile_format CHECK (website_url_profile IS NULL 
OR website_url_profile ~* '^https?://.+'), -- [cite: 227, 442] CONSTRAINT 
check_contribution_score_non_negative CHECK (contribution_score >= 0) -- [cite: 
227, 454] ); -- Add Deferred Foreign Key Constraints for audit columns ALTER 
TABLE public.languages_master ADD CONSTRAINT fk_languages_created_by FOREIGN 
KEY (created_by_profile_id) REFERENCES public.profiles(id) ON DELETE SET NULL; 
-- [cite: 227] ALTER TABLE public.languages_master ADD CONSTRAINT 
fk_languages_updated_by FOREIGN KEY (updated_by_profile_id) REFERENCES 
public.profiles(id) ON DELETE SET NULL; -- [cite: 228] ALTER TABLE 
public.user_roles_master ADD CONSTRAINT fk_user_roles_created_by FOREIGN KEY 
(created_by_profile_id) REFERENCES public.profiles(id) ON DELETE SET NULL; -- 
[cite: 229] ALTER TABLE public.user_roles_master ADD CONSTRAINT 
fk_user_roles_updated_by FOREIGN KEY (updated_by_profile_id) REFERENCES 
public.profiles(id) ON DELETE SET NULL; -- [cite: 230] ALTER TABLE public.media 
ADD CONSTRAINT fk_media_uploader_profile FOREIGN KEY (uploader_profile_id) 
REFERENCES public.profiles(id) ON DELETE SET NULL; -- [cite: 231] ALTER TABLE 
public.media ADD CONSTRAINT fk_media_updated_by_profile FOREIGN KEY 
(updated_by_profile_id) REFERENCES public.profiles(id) ON DELETE SET NULL; -- 
[cite: 232] -- translations table (v2.1) CREATE TABLE public.translations ( -- 
[cite: 235] id bigserial PRIMARY KEY, -- [cite: 235, 910] table_identifier text 
NOT NULL CHECK (char_length(table_identifier) > 0), -- [cite: 235, 913] 
column_identifier text NOT NULL CHECK (char_length(column_identifier) > 0), -- 
[cite: 235, 917] row_foreign_key text NOT NULL, -- [cite: 235, 921] PK from 
source table as text language_code text NOT NULL REFERENCES 
public.languages_master(language_code) ON UPDATE CASCADE ON DELETE RESTRICT, -- 
[cite: 235, 926] translated_text text NOT NULL, -- [cite: 235, 929] 
translation_status text NULL CHECK (translation_status IN ('draft', 
'needs_review', 'published_live', 'needs_update') OR translation_status IS 
NULL), -- [cite: 235, 933] translated_by_profile_id uuid NULL REFERENCES 
public.profiles(id) ON DELETE SET NULL, -- [cite: 235, 935] 
translation_last_updated_at timestamp with time zone NULL, -- [cite: 236, 938] 
created_at timestamp with time zone NOT NULL DEFAULT now(), -- [cite: 236, 941] 
updated_at timestamp with time zone NOT NULL DEFAULT now(), -- [cite: 236, 944] 
created_by_profile_id uuid NULL REFERENCES public.profiles(id) ON DELETE SET 
NULL, -- [cite: 236, 948] updated_by_profile_id uuid NULL REFERENCES 
public.profiles(id) ON DELETE SET NULL, -- [cite: 236, 952] CONSTRAINT 
uq_translation_entry UNIQUE (table_identifier, column_identifier, 
row_foreign_key, language_code) -- [cite: 236, 955] ); ``` 4. Trigger Functions 
(These include check_profile_roles, handle_new_user (updated for role sync and 
last_activity_at), sync_profile_roles_to_auth_user, 
cleanup_user_roles_master_translations, cleanup_media_translations, and the 
conceptual update_media_last_linked_timestamp.) The definitions for these 
functions as provided in profiles.docx (v2.3 sections 4) and other 
specifications (e.g., media spec for its translation cleanup ) are assumed. 5. 
Views SQL ``` CREATE OR REPLACE VIEW public.public_profiles_view AS SELECT 
p.id, p.public_display_name, p.public_avatar_media_id, 
m.storage_object_path_original AS public_avatar_url, -- Example, consider using 
image_variants_json for actual URL p.public_bio, p.pilgrimage_interests_tags, 
p.contributor_organization_name, p.website_url_profile FROM public.profiles p 
LEFT JOIN public.media m ON p.public_avatar_media_id = m.id WHERE 
p.is_profile_publicly_visible = true AND p.account_status = 
'active'::public.user_account_status_enum; -- [cite: 237] ``` 6. Indexes & 
Constraints (Additional) (Indexes are consolidated from individual table specs. 
For example, GIN indexes on profiles.roles and media.tags, and B-tree indexes 
on status fields and audit FKs like idx_profiles_last_activity_at are 
important). 7. Triggers (Application of DML Triggers) (Apply all updated_at 
triggers, role validation/sync triggers (check_profile_roles, 
sync_profile_roles_to_auth_user on profiles), the new user trigger 
(handle_new_user on auth.users), and translation cleanup triggers (e.g., on 
user_roles_master, media)). 8. RLS Policies (Enable RLS on all tables. Policy 
definitions detailed in individual table specs should be applied consistently, 
using helper functions like public.has_role()). 9. Seed Data: - Seed data for 
`languages_master` (v2.1 Section 13) and `user_roles_master` (v2.1 Section 13) 
should be populated, ensuring new columns like `icon_identifier` and audit 
columns are included with appropriate placeholders like `[ADMIN_UUID]`. * * * * 
* 8\. Performance & Optimization Extras ------------------------------------- - 
Key Indexes: Comprehensive indexing, as defined in individual table 
specifications (versions 2.1, 2.2, 2.3), including for audit columns and 
`profiles.last_activity_at`, is crucial. - Database Functions for Complex API 
Responses: As emphasized, creating PostgreSQL functions to assemble complex 
JSON responses involving joins and translation resolution (e.g., for `GET 
/profiles/me`) is highly recommended to optimize performance and simplify API 
gateway logic. - Full-Text Search: Noted as a V2+ improvement for text fields 
in `media`, `profiles` (`public_bio`), and `translations` (`translated_text`). 
- Partitioning: `media` and `translations` tables are candidates for 
partitioning post-V2 if they grow very large. - Caching: `languages_master` and 
`user_roles_master` are excellent candidates for application-level caching due 
to their relatively static nature and frequent access. * * * * * 9\. Visuals 
(Conceptual ERD - Key Tables & Links) 
------------------------------------------------- *(The Mermaid ERD provided in 
the original document v2.2, Section 9, generally remains valid for depicting 
key relationships within this module, reflecting audit links and translation 
connections. Key is that `user_roles_master.default_display_name` (English) is 
in the table, and `translations` links for other languages.)* Code snippet ``` 
erDiagram auth_users ||--o{ profiles : "has_profile" profiles }o--|| 
languages_master : "prefers_language" profiles }o--|| media : "has_avatar 
(optional)" profiles }o--o| profiles : "updated_by (admin)" profiles { uuid id 
PK text[] roles text public_bio # Stores English or submission lang timestamptz 
last_activity_at uuid updated_by_profile_id FK uuid created_by_profile_id FK 
"Implicitly self or system" } profiles ..> translations : 
"public_bio_translated_in (conceptual)" user_roles_master { text role_code PK 
text default_display_name # Stores English text icon_identifier uuid 
created_by_profile_id FK uuid updated_by_profile_id FK } profiles ..> 
user_roles_master : "has_roles" user_roles_master }o--o| profiles : 
"audit_user_roles_created" user_roles_master }o--o| profiles : 
"audit_user_roles_updated" user_roles_master ..> translations : 
"default_display_name_translated_in" languages_master { text language_code PK 
text display_name_en # Explicit English name column text icon_identifier uuid 
created_by_profile_id FK uuid updated_by_profile_id FK } languages_master 
}o--o| profiles : "audit_languages_created" languages_master }o--o| profiles : 
"audit_languages_updated" media { uuid id PK text default_alt_text # Stores 
English uuid uploader_profile_id FK "is_created_by" uuid updated_by_profile_id 
FK "is_updated_by_admin_moderator" } media }o--|| profiles : "uploaded_by" 
media }o--o| profiles : "updated_by_admin" media ..> translations : 
"default_alt_text_translated_in" translations { bigint id PK text 
table_identifier text column_identifier text row_foreign_key text language_code 
FK text translated_text uuid translated_by_profile_id FK uuid 
created_by_profile_id FK uuid updated_by_profile_id FK } translations }o--|| 
languages_master : "is_in_language" translations }o--o| profiles : 
"content_translated_by" translations }o--o| profiles : "row_created_by" 
translations }o--o| profiles : "row_updated_by" ``` * * * * * 10\. Critical 
Gaps & Risks -------------------------- - ğŸ”´ Implementation of RLS Helper 
Functions: Secure and correct implementation of `public.has_role(TEXT)`, 
`public.has_role_on_profile(UUID, TEXT)` remains paramount for effective access 
control. - ğŸ”´ Orphaned Translations Cleanup Triggers: These `AFTER DELETE` 
triggers *must* be implemented correctly on ALL parent tables with translatable 
fields (e.g., `user_roles_master`, `media`, and potentially `profiles` if 
`public_bio` becomes system-translatable) to maintain data integrity in 
`public.translations`. - ğŸŸ  Population Logic for Audit Fields & 
`last_activity_at`: - The application layer or specific database triggers need 
to correctly populate `created_by_profile_id` and `updated_by_profile_id` 
(especially for admin actions or system processes where `auth.uid()` from a JWT 
might not be the direct actor, or for setting these on behalf of another user). 
- The mechanism for updating `profiles.last_activity_at` (e.g., via API calls 
on significant user actions, or specific DB triggers on related tables like 
`user_waypoint_short_tips`, `accommodation_reviews`) needs to be robustly 
defined and implemented. - ğŸŸ  Role Synchronization Robustness: Thoroughly test 
the `profiles.roles` to `auth.users.raw_app_meta_data.roles` synchronization 
handled by the `handle_new_user` and `sync_profile_roles_to_auth_user` 
triggers. - ğŸŸ  Backend Media Processing: The full pipeline for media (variant 
generation for `image_variants_json`, checksum calculation, dominant color 
extraction, etc.) is a significant backend development task. - ğŸŸ¢ Clarity on 
`lang` Parameter Behavior: Ensure consistent backend logic for how the `lang` 
API parameter resolves the main field content versus populating the 
`*_translations` object, ideally handled by shared database functions. * * * * 
* 11\. Scalability & Future-Proof Notes ------------------------------------- - 
Standardized audit columns, clear translation strategy, and robust role 
synchronization improve system integrity and future capabilities. - The 
architecture, with considerations for FTS and potential partitioning for 
`media` and `translations` tables, supports future growth. * * * * * 12\. Next 
Steps --------------- - P1 ğŸ”´ Implement and Test Core RLS Helper Functions 
(`public.has_role()`, `public.has_role_on_profile()`). - P1 ğŸ”´ Implement and 
Test Orphaned Translation Cleanup Triggers on `user_roles_master`, `media`, and 
other relevant tables as they are developed. - P1 ğŸ”´ Implement and Test Role 
Synchronization triggers (`handle_new_user`, `sync_profile_roles_to_auth_user`) 
and update `handle_new_user` to correctly initialize `last_activity_at`. - P1 âš™ï¸ 
Execute Full Build Order for this module, including all DDL updates from table 
specs v2.1/v2.2/v2.3, deferred FK constraints, indexes, and triggers. - P1 ğŸŸ¢ 
Seed Initial Data for `languages_master` (v2.1) and `user_roles_master` (v2.1), 
including `icon_identifier` and audit columns with appropriate `[ADMIN_UUID]` 
placeholders. - P2 ğŸŸ  Define and Implement consistent Population Logic for 
`created_by_profile_id`, `updated_by_profile_id` (application layer or advanced 
triggers). - P2 ğŸŸ  Define and Implement update mechanism for 
`profiles.last_activity_at`. - P2 ğŸŸ  Develop Backend Media Processing Logic 
(variants, checksums, etc., for `media` table). - P2 ğŸŸ  Plan and Implement 
Triggers for `media.last_linked_or_used_at` on all media *linking* tables. - P2 
ğŸŸ  Define clear conventions for `icon_identifier` usage and asset sources. * * 
* * * 
