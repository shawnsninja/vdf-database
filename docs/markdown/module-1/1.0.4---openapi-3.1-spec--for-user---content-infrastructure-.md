# 1.0.4 - OpenAPI 3.1 Spec (for User & Content Infrastructure)

  https://gemini.google.com/u/1/app/1881f72a50cc0fbc ### 1\. OpenAPI 3.1 Spec 
(for User & Content Infrastructure - Re-Clarified) YAML ``` openapi: 3.1.0 
info: title: Via di Francesco - User & Content Infrastructure API version: 
"v1.0-module1-reclarified" description: | API endpoints for managing users 
(profiles), roles, languages, media assets, and translations. This module forms 
the foundational layer for user identity, permissions, internationalization 
(i18n), and media management. Primary reference language (English) content is 
served in base fields (e.g., `default_display_name`). Other language 
translations are provided in corresponding `[fieldname]_translations` objects. 
The field `display_name_en` in the LanguageMaster schema reflects its actual 
database column name. servers: - url: https://api.viadifrancesco.example.com/v1 
# Placeholder description: Production Server - url: http://localhost:3000/v1 # 
Placeholder description: Development Server tags: - name: User Profiles 
description: Managing user-specific data and authentication-related profile 
information. - name: User Roles description: Defining and managing user roles 
for role-based access control (RBAC). (Primarily Admin) - name: Languages 
description: Managing supported languages for platform internationalization. 
(Primarily Admin for CUD, Public Read) - name: Media description: Managing 
metadata for media assets (images, documents, etc.). - name: Translations 
description: Managing translated text content for various entities across the 
platform. (Primarily Admin/Translator) components: schemas: # ENUMERATIONS 
(from DB specs for Module 1) UnitsPreferenceEnum: type: string enum: [metric, 
imperial] description: User's preference for units of measure. 
PilgrimExperienceEnum: type: string enum: [novice_first_pilgrimage, 
intermediate_few_pilgrimages, experienced_many_pilgrimages, 
long_distance_veteran, null] nullable: true description: Self-assessed pilgrim 
experience level. UserAccountStatusEnum: type: string enum: [active, 
pending_verification, email_unconfirmed, suspended_by_admin, 
deactivated_by_user] description: Current status of the user's application 
account. MediaAssetTypeEnum: type: string enum: [image, document_pdf, 
audio_clip, video_clip, gpx_file, other_file] description: General type of 
media asset. MediaLicenceEnum: type: string enum: [all_rights_reserved, cc_by, 
cc_by_sa, cc_by_nd, cc_by_nc, cc_by_nc_sa, cc_by_nc_nd, cc0_public_domain, 
uploader_owns_contact_for_use, official_permission_granted, unknown_licence, 
null] nullable: true description: Usage license associated with the media item. 
MediaStatusEnum: type: string enum: [processing_upload, pending_review, 
published_approved, rejected_hidden, archived, error_uploading] description: 
Current workflow/visibility status of the media item. TranslationDBStatusEnum: 
# From translations.translation_status CHECK constraint type: string enum: 
[draft, needs_review, published_live, needs_update, null] nullable: true 
description: Workflow status of a translation entry in the database. # CORE 
SCHEMAS for Module 1 Profile: description: Application-specific user data, 
extending Supabase's auth.users. type: object properties: id: type: string 
format: uuid description: User's ID from auth.users table. readOnly: true 
roles: type: array items: type: string description: Array of role codes (e.g., 
"pilgrim_user"). Synchronized to auth.users.raw_app_meta_data.roles. username: 
type: string nullable: true description: Optional unique username for community 
features. full_name: type: string nullable: true description: User's full name. 
Stored in the primary reference language or language of submission. 
public_display_name: type: string nullable: true description: Name shown 
publicly. Stored in the primary reference language or language of submission. 
User-set or derived. Unique if provided. public_avatar_media_id: type: string 
format: uuid nullable: true description: ID of the media item (from media 
table) for the public avatar. public_avatar_details: # For 
include=avatar_details $ref: '#/components/schemas/MediaItemMinimal' nullable: 
true readOnly: true public_bio: type: string nullable: true description: "Short 
public biography, stored in the primary reference language (English) or the 
language of submission, as per database design[cite: 554]." 
public_bio_translations: type: object additionalProperties: # language_code 
type: string # translated text for public_bio nullable: true description: 
"Translations for the public biography, if applicable and translated via the 
translations table." example: it: "Pellegrino che esplora la Via di Francesco." 
preferred_language_code: type: string default: 'en' pattern: 
'^[a-z]{2}(-[A-Z]{2})?$' description: User's preferred language (IETF tag). FK 
to languages_master. preferred_units_of_measure: $ref: 
'#/components/schemas/UnitsPreferenceEnum' preferred_timezone: type: string 
nullable: true default: 'Europe/Rome' description: User's preferred IANA 
timezone string. pilgrim_experience_level: $ref: 
'#/components/schemas/PilgrimExperienceEnum' pilgrimage_interests_tags: type: 
array items: type: string nullable: true description: Array of interest tags 
for pilgrim users. contributor_organization_name: type: string nullable: true 
contributor_organization_role: type: string nullable: true 
contact_public_email: type: string format: email nullable: true 
website_url_profile: type: string format: url nullable: true 
notification_preferences_json: type: object nullable: true 
additionalProperties: true is_profile_publicly_visible: type: boolean default: 
false contribution_score: type: integer default: 0 minimum: 0 readOnly: true # 
Typically managed by system account_status: $ref: 
'#/components/schemas/UserAccountStatusEnum' terms_accepted_at: type: string 
format: date-time nullable: true last_login_at: type: string format: date-time 
nullable: true readOnly: true last_activity_at: type: string format: date-time 
nullable: true readOnly: true created_at: type: string format: date-time 
readOnly: true updated_at: type: string format: date-time readOnly: true 
updated_by_profile_id: # Admin use type: string format: uuid nullable: true 
readOnly: true role_details: # For include=role_details type: array items: 
$ref: '#/components/schemas/UserRoleMasterSummary' readOnly: true required: - 
id - roles - preferred_language_code - preferred_units_of_measure - 
is_profile_publicly_visible - account_status - created_at - updated_at 
ProfileInput: description: Data for updating a user's own profile. type: object 
properties: username: { type: string, nullable: true } full_name: { type: 
string, nullable: true } public_display_name: { type: string, nullable: true } 
public_avatar_media_id: { type: string, format: uuid, nullable: true } 
public_bio: { type: string, nullable: true, description: "Public biography in 
the primary reference language (English) or language of submission. For other 
specific language versions, use the main /translations endpoint." } 
preferred_language_code: { type: string, pattern: '^[a-z]{2}(-[A-Z]{2})?$' } 
preferred_units_of_measure: { $ref: '#/components/schemas/UnitsPreferenceEnum' 
} preferred_timezone: { type: string, nullable: true } 
pilgrim_experience_level: { $ref: '#/components/schemas/PilgrimExperienceEnum' 
} pilgrimage_interests_tags: { type: array, items: { type: string }, nullable: 
true } contributor_organization_name: { type: string, nullable: true } 
contributor_organization_role: { type: string, nullable: true } 
contact_public_email: { type: string, format: email, nullable: true } 
website_url_profile: { type: string, format: url, nullable: true } 
notification_preferences_json: { type: object, nullable: true, 
additionalProperties: true } is_profile_publicly_visible: { type: boolean } 
terms_accepted_at: { type: string, format: "date-time", nullable: true } 
UserRoleMaster: description: Defines an available user role within the 
platform. type: object properties: role_code: type: string description: Short, 
unique, machine-readable, lowercase role code (e.g., "pilgrim_user"). 
default_display_name: # DB column name, stores English type: string 
description: "Human-readable name in the primary reference language 
(English)[cite: 601]." default_display_name_translations: type: object 
additionalProperties: { type: string } # lang_code: translated_text nullable: 
true description: "Translations for the role's display name, from the 
translations table[cite: 602]." default_description: # DB column name, stores 
English type: string nullable: true description: "Detailed description in the 
primary reference language (English)[cite: 607]." 
default_description_translations: type: object additionalProperties: { type: 
string } # lang_code: translated_text nullable: true description: "Translations 
for the role's description, from the translations table[cite: 608]." 
icon_identifier: type: string nullable: true description: Optional identifier 
for a UI icon representing the role[cite: 613]. permissions_summary_json: type: 
object additionalProperties: true nullable: true description: JSONB storing a 
human-readable summary of key permissions[cite: 617]. role_hierarchy_level: 
type: integer nullable: true is_system_role: type: boolean default: false 
is_role_active: type: boolean default: true default_for_new_pilgrim_users: 
type: boolean default: false created_at: type: string format: date-time 
readOnly: true updated_at: type: string format: date-time readOnly: true 
created_by_profile_id: type: string format: uuid nullable: true readOnly: true 
updated_by_profile_id: type: string format: uuid nullable: true readOnly: true 
deleted_at: type: string format: date-time nullable: true readOnly: true 
required: - role_code - default_display_name - is_system_role - is_role_active 
- default_for_new_pilgrim_users - created_at - updated_at UserRoleMasterInput: 
# For Admin POST/PUT description: Data for creating or updating a user role. 
type: object properties: role_code: # Required on POST, not on PUT (path param) 
type: string pattern: '^[a-z0-9_]+$' default_display_name: # This will be the 
English version to store in the main column type: string description: "Display 
name in the primary reference language (English)." default_description: # This 
will be the English version to store in the main column type: string nullable: 
true description: "Description in the primary reference language (English)." 
icon_identifier: type: string nullable: true permissions_summary_json: type: 
object additionalProperties: true nullable: true role_hierarchy_level: type: 
integer nullable: true is_system_role: type: boolean is_role_active: type: 
boolean default_for_new_pilgrim_users: type: boolean required: - 
default_display_name # English version - is_system_role - is_role_active - 
default_for_new_pilgrim_users UserRoleMasterSummary: # For embedding in 
Profile.role_details type: object properties: role_code: type: string 
display_name: # This would be translated based on the main request's 'lang' 
parameter type: string description: "Display name of the role, translated if 
'lang' parameter was provided." icon_identifier: type: string nullable: true 
required: [role_code, display_name] LanguageMaster: description: Defines a 
language supported by the platform. type: object properties: language_code: 
type: string pattern: '^[a-z]{2}(-[A-Z]{2})?$' minLength: 2 maxLength: 5 
display_name_native: type: string description: "The name of the language in its 
own native script and language[cite: 770]." display_name_en: # This is the 
actual DB column name [cite: 772] type: string description: "The common name of 
the language in English[cite: 775]." icon_identifier: type: string nullable: 
true description: "Optional UI icon identifier[cite: 779]." 
is_active_for_platform: type: boolean default: false 
is_primary_content_language: type: boolean default: false display_order_ui: 
type: integer nullable: true created_at: type: string format: date-time 
readOnly: true updated_at: type: string format: date-time readOnly: true 
created_by_profile_id: type: string format: uuid nullable: true readOnly: true 
updated_by_profile_id: type: string format: uuid nullable: true readOnly: true 
required: - language_code - display_name_native - display_name_en - 
is_active_for_platform - is_primary_content_language - created_at - updated_at 
LanguageMasterInput: # For Admin POST/PUT description: Data for creating or 
updating a language. type: object properties: language_code: # Required on POST 
type: string pattern: '^[a-z]{2}(-[A-Z]{2})?$' minLength: 2 maxLength: 5 
display_name_native: type: string display_name_en: # Actual column name type: 
string icon_identifier: type: string nullable: true is_active_for_platform: 
type: boolean is_primary_content_language: type: boolean display_order_ui: 
type: integer nullable: true required: - display_name_native - display_name_en 
- is_active_for_platform - is_primary_content_language MediaItem: description: 
Metadata for a media asset. type: object properties: id: type: string format: 
uuid readOnly: true uploader_profile_id: type: string format: uuid nullable: 
true readOnly: true # Set on creation uploader_profile_summary: # For 
include=uploader_summary type: object readOnly: true nullable: true properties: 
id: { type: string, format: uuid } public_display_name: { type: string, 
nullable: true } storage_bucket_name: type: string 
storage_object_path_original: type: string description: "Unique path to 
original object. Example: uploads/images/2025/05/{uuid}_original.jpg" 
file_name_original: type: string file_mime_type: type: string 
file_size_bytes_original: type: integer format: int64 nullable: true 
image_width_px_original: type: integer nullable: true image_height_px_original: 
type: integer nullable: true image_variants_json: type: object 
additionalProperties: { type: string } # variant_name: path_to_variant 
nullable: true description: "Relative paths for optimized versions. Example: 
{\"thumb_s\": \"variants/uuid_thumb_s.webp\"} [cite: 1045]" default_alt_text: # 
DB column name, stores English type: string nullable: true description: 
"Default alt text in the primary reference language (English)[cite: 1049]." 
default_alt_text_translations: type: object additionalProperties: { type: 
string } nullable: true description: "Translations for alt text, from the 
translations table." default_caption: # DB column name, stores English type: 
string nullable: true description: "Default caption in the primary reference 
language (English)[cite: 1054]." default_caption_translations: type: object 
additionalProperties: { type: string } nullable: true description: 
"Translations for caption, from the translations table." attribution_text: # DB 
column name, primary reference language type: string nullable: true 
description: "Attribution text in the primary reference language. Potentially 
translatable via translations table[cite: 1058]." 
attribution_text_translations: type: object additionalProperties: {type: string 
} nullable: true description: "Translations for attribution text, from the 
translations table." attribution_url: type: string format: url nullable: true 
licence: $ref: '#/components/schemas/MediaLicenceEnum' media_asset_type: $ref: 
'#/components/schemas/MediaAssetTypeEnum' media_status: $ref: 
'#/components/schemas/MediaStatusEnum' tags: type: array items: { type: string 
} nullable: true checksum_sha256_original: type: string nullable: true 
readOnly: true # Set by backend dominant_color_hex: type: string pattern: 
'^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$' nullable: true readOnly: true # Set by 
backend last_linked_or_used_at: type: string format: date-time nullable: true 
readOnly: true created_at: type: string format: date-time readOnly: true 
updated_at: type: string format: date-time readOnly: true 
updated_by_profile_id: type: string format: uuid nullable: true readOnly: true 
deleted_at: type: string format: date-time nullable: true readOnly: true 
required: - id - storage_bucket_name - storage_object_path_original - 
file_name_original - file_mime_type - media_asset_type - media_status - 
created_at - updated_at MediaItemMinimal: # For embedding (e.g. 
Profile.public_avatar_details) description: Minimal media item details, 
typically for an image. type: object properties: id: { type: string, format: 
uuid } media_asset_type: { $ref: '#/components/schemas/MediaAssetTypeEnum' } 
file_mime_type: { type: string } default_alt_text: { type: string, nullable: 
true, description: "Alt text in requested language, or primary reference 
language (English)." } # Resolved by API image_variants_json: { type: object, 
additionalProperties: { type: string }, nullable: true } attribution_text: { 
type: string, nullable: true, description: "Attribution text in requested 
language, or primary reference language (English)." } # Resolved by API 
required: [id, media_asset_type, file_mime_type] MediaItemInput: # For POST 
(metadata registration) description: Data for registering new media metadata. 
File upload is separate. type: object properties: storage_bucket_name: { type: 
string } storage_object_path_original: { type: string } file_name_original: { 
type: string } file_mime_type: { type: string } file_size_bytes_original: { 
type: integer, format: int64, nullable: true } default_alt_text: { type: 
string, nullable: true, description: "Alt text in primary reference language 
(English)." } default_caption: { type: string, nullable: true, description: 
"Caption in primary reference language (English)." } attribution_text: { type: 
string, nullable: true, description: "Attribution text in primary reference 
language (English)." } attribution_url: { type: string, format: url, nullable: 
true } licence: { $ref: '#/components/schemas/MediaLicenceEnum' } 
media_asset_type: { $ref: '#/components/schemas/MediaAssetTypeEnum' } tags: { 
type: array, items: { type: string }, nullable: true } required: - 
storage_bucket_name - storage_object_path_original - file_name_original - 
file_mime_type - media_asset_type MediaItemUpdateInput: # For PUT (updating 
existing media metadata) description: Data for updating existing media 
metadata. type: object properties: default_alt_text: { type: string, nullable: 
true, description: "Alt text in primary reference language (English)." } 
default_caption: { type: string, nullable: true, description: "Caption in 
primary reference language (English)." } attribution_text: { type: string, 
nullable: true, description: "Attribution text in primary reference language 
(English)." } attribution_url: { type: string, format: url, nullable: true } 
licence: { $ref: '#/components/schemas/MediaLicenceEnum' } media_status: { 
$ref: '#/components/schemas/MediaStatusEnum' } # Moderator/Admin tags: { type: 
array, items: { type: string }, nullable: true } TranslationEntry: description: 
Stores a single piece of translated text. type: object properties: id: type: 
integer format: int64 readOnly: true table_identifier: type: string 
description: "Name of the source table (e.g., 'user_roles_master')[cite: 914]." 
column_identifier: type: string description: "Name of the column being 
translated (e.g., 'default_display_name')[cite: 918]." row_foreign_key: type: 
string description: "PK value of the source record as text[cite: 922]." 
language_code: type: string description: "Language of this translated text. FK 
to languages_master[cite: 927]." translated_text: type: string description: 
"The actual translated content[cite: 930]." translation_status: $ref: 
'#/components/schemas/TranslationDBStatusEnum' translated_by_profile_id: type: 
string format: uuid nullable: true translation_last_updated_at: type: string 
format: date-time nullable: true created_at: type: string format: date-time 
readOnly: true updated_at: type: string format: date-time readOnly: true 
created_by_profile_id: type: string format: uuid nullable: true readOnly: true 
updated_by_profile_id: type: string format: uuid nullable: true readOnly: true 
required: - id - table_identifier - column_identifier - row_foreign_key - 
language_code - translated_text - created_at - updated_at 
TranslationEntryInput: # For Admin/Translator POST/PUT description: Data for 
creating or updating a translation entry. type: object properties: 
table_identifier: { type: string } column_identifier: { type: string } 
row_foreign_key: { type: string } language_code: { type: string } 
translated_text: { type: string } translation_status: { $ref: 
'#/components/schemas/TranslationDBStatusEnum' } required: - table_identifier - 
column_identifier - row_foreign_key - language_code - translated_text # UTILITY 
SCHEMAS ErrorResponse: # Standard Error Object (from Auth blueprint) type: 
object properties: code: type: string description: A machine-readable error 
code slug. example: "resource_not_found" message: type: string description: A 
human-readable summary of the error. example: "The requested resource could not 
be found." detail: type: string nullable: true description: More specific 
details or field-specific errors. hint: type: string nullable: true 
description: Optional hint on how to resolve the error. required: - code - 
message Pagination: type: object properties: total_items: type: integer 
description: Total number of items available across all pages. total_pages: 
type: integer description: Total number of pages. current_page: type: integer 
description: The current page number (1-indexed). page_size: type: integer 
description: The number of items per page. required: - total_items - 
total_pages - current_page - page_size # PAGINATED RESPONSE WRAPPERS 
PaginatedProfiles: type: object properties: data: type: array items: $ref: 
'#/components/schemas/Profile' pagination: $ref: 
'#/components/schemas/Pagination' required: [data, pagination] 
PaginatedUserRoleMasters: type: object properties: data: type: array items: 
$ref: '#/components/schemas/UserRoleMaster' pagination: $ref: 
'#/components/schemas/Pagination' required: [data, pagination] 
PaginatedLanguageMasters: type: object properties: data: type: array items: 
$ref: '#/components/schemas/LanguageMaster' pagination: $ref: 
'#/components/schemas/Pagination' required: [data, pagination] 
PaginatedMediaItems: type: object properties: data: type: array items: $ref: 
'#/components/schemas/MediaItem' pagination: $ref: 
'#/components/schemas/Pagination' required: [data, pagination] 
PaginatedTranslationEntries: type: object properties: data: type: array items: 
$ref: '#/components/schemas/TranslationEntry' pagination: $ref: 
'#/components/schemas/Pagination' required: [data, pagination] parameters: 
Page: name: page in: query description: Page number for pagination (1-indexed). 
required: false schema: type: integer default: 1 minimum: 1 PageSize: name: 
page_size in: query description: Number of items per page. required: false 
schema: type: integer default: 20 minimum: 1 maximum: 100 # Max page size Lang: 
name: lang in: query description: | ISO language code for requesting translated 
content. If provided, the main field (e.g. `public_bio`, 
`default_display_name`) will be returned in the requested language if a 
translation exists, otherwise it defaults to the primary reference language 
(English). The corresponding `[fieldname]_translations` object will always list 
all available translations for that field. required: false schema: type: string 
example: "it" Include: name: include in: query description: Comma-separated 
list of related resources to include (e.g., `role_details`, `avatar_details`, 
`uploader_summary`). required: false schema: type: string SortBy: name: sort_by 
in: query description: Field to sort by (e.g., `created_at`, 
`default_display_name`). Prepend '-' for descending order (e.g. `-created_at`). 
required: false schema: type: string # Specific filters 
IsActiveForPlatformFilter: name: is_active_for_platform in: query description: 
Filter languages by their active status. schema: type: boolean 
MediaStatusFilter: name: media_status in: query description: Filter media items 
by status. schema: $ref: '#/components/schemas/MediaStatusEnum' 
MediaAssetTypeFilter: name: media_asset_type in: query description: Filter 
media items by asset type. schema: $ref: 
'#/components/schemas/MediaAssetTypeEnum' TranslationTableIdentifierFilter: 
name: table_identifier in: query description: Filter translations by source 
table name. schema: type: string TranslationLanguageCodeFilter: name: 
language_code in: query description: Filter translations by language code. 
schema: type: string responses: # Standard error responses UnauthorizedError: 
description: Authentication information is missing or invalid. content: 
application/json: { schema: { $ref: '#/components/schemas/ErrorResponse' } } 
ForbiddenError: description: Authenticated user does not have permission for 
the action. content: application/json: { schema: { $ref: 
'#/components/schemas/ErrorResponse' } } NotFoundError: description: The 
requested resource was not found. content: application/json: { schema: { $ref: 
'#/components/schemas/ErrorResponse' } } BadRequestError: description: The 
request was malformed or contained invalid parameters. content: 
application/json: { schema: { $ref: '#/components/schemas/ErrorResponse' } } 
UnprocessableEntityError: description: The request was well-formed but contains 
semantic errors (e.g., validation failure, unique constraint). content: 
application/json: { schema: { $ref: '#/components/schemas/ErrorResponse' } } 
TooManyRequestsError: description: Rate limit exceeded. headers: Retry-After: { 
schema: { type: integer }, description: "Seconds to wait before retrying." } 
content: application/json: { schema: { $ref: 
'#/components/schemas/ErrorResponse' } } InternalServerError: description: An 
unexpected error occurred on the server. content: application/json: { schema: { 
$ref: '#/components/schemas/ErrorResponse' } } securitySchemes: bearerAuth: # 
From global Auth & Security Blueprint type: http scheme: bearer bearerFormat: 
JWT description: "Uses JWT Bearer token. Roles from `public.profiles.roles` are 
synchronized to `auth.users.raw_app_meta_data.roles` for JWT inclusion." 
security: # Default security for all paths, can be overridden - bearerAuth: [] 
paths: # PROFILES /profiles/me: get: tags: [User Profiles] summary: Get current 
user's profile description: Retrieve detailed profile information for the 
currently authenticated user. operationId: getCurrentUserProfile parameters: - 
$ref: '#/components/parameters/Include' # e.g. role_details,avatar_details - 
$ref: '#/components/parameters/Lang' # For role_details display_name, avatar 
alt_text, and profile's own translatable fields responses: '200': description: 
Successful retrieval of user profile. content: application/json: { schema: { 
$ref: '#/components/schemas/Profile' } } '401': { $ref: 
'#/components/responses/UnauthorizedError' } put: # Exemplar WRITE for Profile 
tags: [User Profiles] summary: Update current user's profile description: 
Allows an authenticated user to update their own profile information. 
operationId: updateCurrentUserProfile requestBody: required: true content: 
application/json: { schema: { $ref: '#/components/schemas/ProfileInput' } } 
responses: '200': description: Profile updated successfully. content: 
application/json: { schema: { $ref: '#/components/schemas/Profile' } } '400': { 
$ref: '#/components/responses/BadRequestError' } '401': { $ref: 
'#/components/responses/UnauthorizedError' } '422': { $ref: 
'#/components/responses/UnprocessableEntityError' } # LANGUAGES /languages: 
get: tags: [Languages] summary: List available platform languages description: 
Fetches a list of languages. Publicly accessible for active languages. 
operationId: listLanguages security: [] # Public read for active languages 
parameters: - $ref: '#/components/parameters/IsActiveForPlatformFilter' - $ref: 
'#/components/parameters/SortBy' # e.g. display_order_ui, display_name_en - 
$ref: '#/components/parameters/Page' - $ref: '#/components/parameters/PageSize' 
responses: '200': description: A list of languages. content: application/json: 
{ schema: { $ref: '#/components/schemas/PaginatedLanguageMasters' } } post: # 
Exemplar WRITE for LanguageMaster (Admin) tags: [Languages] summary: Create a 
new language (Admin) description: Adds a new language to the platform. Requires 
admin privileges. operationId: createLanguage requestBody: required: true 
content: application/json: schema: allOf: - $ref: 
'#/components/schemas/LanguageMasterInput' - type: object # Ensure 
language_code is required for POST required: [language_code] responses: '201': 
description: Language created successfully. content: application/json: { 
schema: { $ref: '#/components/schemas/LanguageMaster' } } '400': { $ref: 
'#/components/responses/BadRequestError' } '401': { $ref: 
'#/components/responses/UnauthorizedError' } '403': { $ref: 
'#/components/responses/ForbiddenError' } '422': { $ref: 
'#/components/responses/UnprocessableEntityError' } /languages/{language_code}: 
get: tags: [Languages] summary: Get a specific language description: Retrieves 
details for a specific language code. Publicly accessible. operationId: 
getLanguageByCode security: [] # Public read parameters: - name: language_code 
in: path required: true description: The language code (e.g., 'en', 'it'). 
schema: { type: string } responses: '200': description: Language details. 
content: application/json: { schema: { $ref: 
'#/components/schemas/LanguageMaster' } } '404': { $ref: 
'#/components/responses/NotFoundError' } # USER ROLES (Admin) /user_roles: get: 
tags: [User Roles] summary: List user roles (Admin) description: Retrieves a 
list of all defined user roles. Requires admin privileges. operationId: 
listUserRoles parameters: - $ref: '#/components/parameters/SortBy' # e.g. 
role_code, default_display_name - $ref: '#/components/parameters/Page' - $ref: 
'#/components/parameters/PageSize' responses: '200': description: A list of 
user roles. content: application/json: { schema: { $ref: 
'#/components/schemas/PaginatedUserRoleMasters' } } '401': { $ref: 
'#/components/responses/UnauthorizedError' } '403': { $ref: 
'#/components/responses/ForbiddenError' } post: # Exemplar WRITE for 
UserRoleMaster (Admin) tags: [User Roles] summary: Create a new user role 
(Admin) description: Adds a new user role definition. Requires admin 
privileges. operationId: createUserRole requestBody: required: true content: 
application/json: schema: allOf: - $ref: 
'#/components/schemas/UserRoleMasterInput' - type: object # Ensure role_code is 
required for POST required: [role_code] responses: '201': description: User 
role created successfully. content: application/json: { schema: { $ref: 
'#/components/schemas/UserRoleMaster' } } '400': { $ref: 
'#/components/responses/BadRequestError' } '401': { $ref: 
'#/components/responses/UnauthorizedError' } '403': { $ref: 
'#/components/responses/ForbiddenError' } '422': { $ref: 
'#/components/responses/UnprocessableEntityError' } /user_roles/{role_code}: 
get: tags: [User Roles] summary: Get a specific user role (Admin) description: 
Retrieves details for a specific user role. Requires admin privileges for most 
roles, some system roles might be public. operationId: getUserRoleByCode 
parameters: - name: role_code in: path required: true description: The role 
code. schema: { type: string } - $ref: '#/components/parameters/Lang' # For 
translated name/description responses: '200': description: User role details. 
content: application/json: { schema: { $ref: 
'#/components/schemas/UserRoleMaster' } } '401': { $ref: 
'#/components/responses/UnauthorizedError' } # If not admin and role isn't 
public '403': { $ref: '#/components/responses/ForbiddenError' } '404': { $ref: 
'#/components/responses/NotFoundError' } # MEDIA /media: get: tags: [Media] 
summary: List media items description: Retrieve a list of media items. Access 
depends on media_status and RLS. Public typically sees 'published_approved'. 
operationId: listMediaItems # Security: Default bearerAuth applies for 
non-public. Can be security: [] if RLS handles public access to 
published_approved. parameters: - $ref: 
'#/components/parameters/MediaStatusFilter' - $ref: 
'#/components/parameters/MediaAssetTypeFilter' - $ref: 
'#/components/parameters/Lang' - $ref: '#/components/parameters/SortBy' - $ref: 
'#/components/parameters/Page' - $ref: '#/components/parameters/PageSize' - 
$ref: '#/components/parameters/Include' # e.g. uploader_summary responses: 
'200': description: A list of media items. content: application/json: { schema: 
{ $ref: '#/components/schemas/PaginatedMediaItems' } } '400': { $ref: 
'#/components/responses/BadRequestError' } post: # Exemplar WRITE for MediaItem 
(Authenticated User) tags: [Media] summary: Register new media metadata 
description: Registers metadata for a new media item. Actual file upload to 
Storage is a separate step. `uploader_profile_id` is set from authenticated 
user. operationId: createMediaItemMetadata requestBody: required: true content: 
application/json: { schema: { $ref: '#/components/schemas/MediaItemInput' } } 
responses: '201': description: Media item metadata registered successfully. 
content: application/json: { schema: { $ref: '#/components/schemas/MediaItem' } 
} '400': { $ref: '#/components/responses/BadRequestError' } '401': { $ref: 
'#/components/responses/UnauthorizedError' } '422': { $ref: 
'#/components/responses/UnprocessableEntityError' } /media/{media_id}: get: 
tags: [Media] summary: Get media item details description: Retrieve metadata 
for a specific media item. operationId: getMediaItemById parameters: - name: 
media_id in: path required: true description: UUID of the media item. schema: { 
type: string, format: uuid } - $ref: '#/components/parameters/Lang' - $ref: 
'#/components/parameters/Include' # e.g. uploader_summary responses: '200': 
description: Media item details. content: application/json: { schema: { $ref: 
'#/components/schemas/MediaItem' } } '404': { $ref: 
'#/components/responses/NotFoundError' } put: # Owner, Moderator, Admin tags: 
[Media] summary: Update media item metadata description: Allows an owner or 
authorized role to update media metadata. operationId: updateMediaItemMetadata 
parameters: - name: media_id in: path required: true schema: { type: string, 
format: uuid } requestBody: required: true content: application/json: { schema: 
{ $ref: '#/components/schemas/MediaItemUpdateInput' } } responses: '200': 
description: Media item metadata updated. content: application/json: { schema: 
{ $ref: '#/components/schemas/MediaItem' } } '400': { $ref: 
'#/components/responses/BadRequestError' } '401': { $ref: 
'#/components/responses/UnauthorizedError' } '403': { $ref: 
'#/components/responses/ForbiddenError' } '404': { $ref: 
'#/components/responses/NotFoundError' } '422': { $ref: 
'#/components/responses/UnprocessableEntityError' } # TRANSLATIONS 
(Admin/Translator) /translations: get: tags: [Translations] summary: List 
translation entries (Admin/Translator) description: Retrieves a list of 
translation entries. Requires admin/translator privileges. operationId: 
listTranslationEntries parameters: - $ref: 
'#/components/parameters/TranslationTableIdentifierFilter' - $ref: 
'#/components/parameters/TranslationLanguageCodeFilter' - name: row_foreign_key 
in: query schema: { type: string } - name: column_identifier in: query schema: 
{ type: string } - $ref: '#/components/parameters/SortBy' - $ref: 
'#/components/parameters/Page' - $ref: '#/components/parameters/PageSize' 
responses: '200': description: A list of translation entries. content: 
application/json: { schema: { $ref: 
'#/components/schemas/PaginatedTranslationEntries' } } '401': { $ref: 
'#/components/responses/UnauthorizedError' } '403': { $ref: 
'#/components/responses/ForbiddenError' } post: # Exemplar WRITE for 
TranslationEntry (Admin/Translator) tags: [Translations] summary: Create a new 
translation entry (Admin/Translator) description: Adds a new translation entry. 
Requires admin/translator privileges. operationId: createTranslationEntry 
requestBody: required: true content: application/json: { schema: { $ref: 
'#/components/schemas/TranslationEntryInput' } } responses: '201': description: 
Translation entry created. content: application/json: { schema: { $ref: 
'#/components/schemas/TranslationEntry' } } '400': { $ref: 
'#/components/responses/BadRequestError' } '401': { $ref: 
'#/components/responses/UnauthorizedError' } '403': { $ref: 
'#/components/responses/ForbiddenError' } '422': { $ref: 
'#/components/responses/UnprocessableEntityError' } 
/translations/{translation_id}: get: tags: [Translations] summary: Get a 
specific translation entry (Admin/Translator) description: Retrieves details 
for a specific translation entry. Requires admin/translator privileges. 
operationId: getTranslationEntryById parameters: - name: translation_id in: 
path required: true description: ID of the translation entry. schema: { type: 
integer, format: int64 } responses: '200': description: Translation entry 
details. content: application/json: { schema: { $ref: 
'#/components/schemas/TranslationEntry' } } '401': { $ref: 
'#/components/responses/UnauthorizedError' } '403': { $ref: 
'#/components/responses/ForbiddenError' } '404': { $ref: 
'#/components/responses/NotFoundError' } ``` ### 2\. Quick-Start Examples 1. 
Get Current User's Profile (with Italian preference for resolved fields and 
avatar details): Bash ``` curl -X GET 
'https://api.viadifrancesco.example.com/v1/profiles/me?include=role_details,avat
ar_details&lang=it'\ -H 'Authorization: Bearer <YOUR_USER_JWT>'\ -H 'apikey: 
<YOUR_SUPABASE_ANON_KEY>' ``` *Sample JSON Response:* JSON ``` { "id": 
"123e4567-e89b-12d3-a456-426614174000", "roles": ["pilgrim_user"], "username": 
"anna_pilgrim", "public_display_name": "Anna R.", "public_bio": "Pellegrino che 
esplora la Via di Francesco.", // Resolved to Italian due to lang=it 
"public_bio_translations": { // All available translations for public_bio "en": 
"Pilgrim exploring the Via di Francesco.", "it": "Pellegrino che esplora la Via 
di Francesco." }, "preferred_language_code": "it", 
"preferred_units_of_measure": "metric", "account_status": "active", 
"role_details": [ { "role_code": "pilgrim_user", "display_name": "Utente 
Pellegrino", // Resolved from user_roles_master default_display_name and its 
translations "icon_identifier": "person" } ], "public_avatar_details": { "id": 
"a1b2c3d4-e5f6-7890-1234-567890abcdef", "media_asset_type": "image", 
"file_mime_type": "image/jpeg", "default_alt_text": "Avatar di Anna R.", // 
Resolved from media default_alt_text and its translations 
"image_variants_json": { "thumb_s_webp": "variants/a1b2_thumb_s.webp" } }, 
"created_at": "2024-01-15T10:00:00Z", "updated_at": "2025-05-10T14:30:00Z" } 
``` 2. List Media Items (Images, published, with Italian alt text/caption 
preference): Bash ``` curl -X GET 
'https://api.viadifrancesco.example.com/v1/media?media_asset_type=image&media_st
atus=published_approved&page_size=1&lang=it'\ -H 'apikey: 
<YOUR_SUPABASE_ANON_KEY>' ``` *Sample JSON Response:* JSON ``` { "data": [ { 
"id": "mediauuid001", "storage_bucket_name": "platform-media", 
"storage_object_path_original": "images/trailA/image1.jpg", 
"file_name_original": "Beautiful scenery.jpg", "file_mime_type": "image/jpeg", 
"image_variants_json": {"thumb_s_webp": "variants/mediauuid001_thumb_s.webp"}, 
"default_alt_text": "Una splendida vista delle montagne sul Sentiero A.", // 
Resolved to Italian "default_alt_text_translations": { "en": "A stunning view 
of the mountains on Trail A.", "it": "Una splendida vista delle montagne sul 
Sentiero A." }, "default_caption": "Alba sugli Appennini.", // Resolved to 
Italian "default_caption_translations": { "en": "Sunrise over the Apennines.", 
"it": "Alba sugli Appennini." }, "media_asset_type": "image", "media_status": 
"published_approved", "created_at": "2025-03-10T08:00:00Z", "updated_at": 
"2025-03-10T09:30:00Z" } ], "pagination": { "total_items": 150, "total_pages": 
150, "current_page": 1, "page_size": 1 } } ``` 3. Admin Updates a User Role's 
English Description (Primary Language Content): This example shows updating the 
main default_description (English). Translations would be managed via the 
/translations endpoint. Bash ``` curl -X PUT 
'https://api.viadifrancesco.example.com/v1/user_roles/community_guide'\ -H 
'Authorization: Bearer <YOUR_ADMIN_JWT>'\ -H 'apikey: 
<YOUR_SUPABASE_ANON_KEY>'\ -H 'Content-Type: application/json'\ -d '{ 
"default_display_name": "Community Guide", "default_description": "A trusted 
pilgrim who provides local insights, helps other users, and can suggest content 
updates.", "icon_identifier": "local_library", "role_hierarchy_level": 50, 
"is_system_role": false, "is_role_active": true, 
"default_for_new_pilgrim_users": false }' ``` *Sample JSON Response (200 OK):* 
JSON ``` { "role_code": "community_guide", "default_display_name": "Community 
Guide", "default_display_name_translations": null, // Assuming no other 
translations exist yet "default_description": "A trusted pilgrim who provides 
local insights, helps other users, and can suggest content updates.", 
"default_description_translations": null, "icon_identifier": "local_library", 
"permissions_summary_json": null, "role_hierarchy_level": 50, "is_system_role": 
false, "is_role_active": true, "default_for_new_pilgrim_users": false, 
"created_at": "2025-05-18T20:15:00Z", // Original creation time "updated_at": 
"2025-05-18T21:05:00Z", // New update time "created_by_profile_id": 
"admin-user-uuid", "updated_by_profile_id": "admin-user-uuid-who-updated", 
"deleted_at": null } ``` ### 3\. Implementation Notes - SQL Views/Indexes: - 
The database schemas for Module 1 (versions 2.1, 2.2, 2.3) are well-indexed. - 
Database Functions for Complex GETs and Translation Resolution: This remains a 
critical recommendation. For endpoints like `GET /profiles/me` or `GET 
/media/{media_id}` that involve `include` parameters and resolving the main 
field content based on the `lang` parameter (while also providing the 
`*_translations` object), PostgreSQL functions are ideal. - These functions 
would fetch the base entity, identify translatable fields, query 
`public.translations` for those fields and the specific `row_foreign_key`, and 
then construct the response. If `lang=it` is passed, the function would place 
the Italian text into the main field (e.g., `public_bio`) if available, 
otherwise, the English content from the base table column remains. The 
`public_bio_translations` object would contain all key-value pairs of available 
translations. - Schema Status: - 🟢 Schema OK. The V2.1/V2.2/V2.3 database 
specifications for Module 1 align with this API model where base fields (e.g., 
`default_display_name` in `user_roles_master`) store the primary reference 
language (English), and the `*_translations` objects in the API response are 
populated from the `public.translations` table. The one exception, 
`languages_master.display_name_en`, is correctly reflected in the API as 
`display_name_en` because that is its actual database column name. - 
Translation Handling in API Backend: - When a `lang` query parameter is 
provided, the API backend (or the database functions) should: 1. Retrieve the 
main entity. The direct columns for translatable fields (e.g., 
`media.default_alt_text`) contain the English version. 2. For each such 
translatable field, query the `public.translations` table to get all language 
versions and populate the corresponding `[fieldname]_translations` object in 
the API response. 3. For the main field in the API response (e.g., 
`default_alt_text` in the `MediaItem` schema), if `lang=it` was requested and 
an Italian translation exists in `default_alt_text_translations`, then the 
value of `default_alt_text` should be the Italian text. Otherwise, it should 
remain the English text from the base table. - Write Operations (Primary 
Language vs. Other Translations): - When creating/updating an entity (e.g., via 
`POST /user_roles` or `PUT /media/{media_id}`), the input schema fields like 
`default_display_name` or `default_alt_text` will populate the main columns in 
the respective tables (which store the English/primary reference language 
content). - To add or update translations for *other* languages, clients must 
use the dedicated `/translations` endpoint (e.g., `POST /translations` or `PUT 
/translations/{id}`). 
