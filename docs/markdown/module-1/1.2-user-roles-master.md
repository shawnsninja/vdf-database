# 1.2 user_roles_master

  https://gemini.google.com/u/1/app/fd47ede3d905a3f2 
https://gemini.google.com/u/1/app/440838222ac514d7 Production-Ready 
Specification: public.user_roles_master Table Version: 2.1 (Checklist 
V2-05-17-B Applied) Date: 2025-05-17 1. Purpose & Primary Use-Cases Mission 
Statement: To define and describe all available user roles within the 
pilgrimage platform, serving as the authoritative source for role codes, their 
default names/descriptions (in the primary reference language), permission 
summaries, UI icons, and audit trails for changes. Key User-Story Touchpoints: 
â€¢ Pilgrim, Host, Manager: Their assigned roles originate from this table. 
[cite: 428] â€¢ Platform Administrator: Manages role definitions and assignments. 
[cite: 429] â€¢ System: `handle_new_user` trigger queries for default role; 
`check_profile_roles` trigger validates against this table. [cite: 430] 2. 
Schema | column | data_type | constraints | description | | 
:------------------------------ | :------------------------ | 
:-------------------------------------------------------------------------------
---------------------------------------------------- | 
:-------------------------------------------------------------------------------
--------------------------------------------------------------------------------
---------------------------------------- | | role_code | text | Primary Key, 
Not Null, CHECK (`role_code` = lower(`role_code`) AND `role_code` ~ 
'^[a-z0-9_]+$') | ðŸŸ  Short, unique, machine-readable, lowercase role code 
(e.g., `pilgrim_user`). Used in `profiles.roles`. [cite: 1371] | | 
default_display_name | text | Not Null | Human-readable name in the primary 
reference language (e.g., "Pilgrim User"). (Translatable via 
`public.translations`) [cite: 1371] | | default_description | text | Nullable | 
Detailed description of the role in the primary reference language. 
(Translatable via `public.translations`) [cite: 1371] | | icon_identifier | 
text | Nullable | Optional identifier for a UI icon representing the role 
(e.g., a Material Design Icon name like 'person_outline'). | | 
permissions_summary_json | jsonb | Nullable | JSONB storing a human-readable 
summary of key permissions (e.g., `{"can_edit_own_profile": true}`). For 
documentation/admin UI; enforcement via RLS/app logic. [cite: 1371] | | 
role_hierarchy_level | integer | Nullable | Optional numerical level for role 
precedence (e.g., admin=100, pilgrim=10). Higher implies more privileges. 
[cite: 1371] | | is_system_role | boolean | Not Null, Default false | If true, 
this is a core system role (e.g., `admin_super`, `pilgrim_user`) resistant to 
easy deletion/modification. [cite: 1371] | | is_role_active | boolean | Not 
Null, Default true | If true, the role is active and assignable. Inactive roles 
might be deprecated or for future use. [cite: 1371] | | 
default_for_new_pilgrim_users | boolean | Not Null, Default false, Unique 
Partial Index `uq_one_default_for_new_pilgrim_users` WHERE 
(`default_for_new_pilgrim_users` = TRUE) | ðŸŸ  If true, this `role_code` is 
auto-assigned to new standard pilgrim users. Only one role should have this 
true. [cite: 1371] | | created_at | timestamp with time zone | Not Null, 
Default `now()` | Timestamp of role definition creation. | | updated_at | 
timestamp with time zone | Not Null, Default `now()` | Timestamp of last role 
definition update (auto-updated by trigger). | | created_by_profile_id | uuid | 
Nullable, Foreign Key to `public.profiles(id)` ON DELETE SET NULL | Profile ID 
of the user who initially created this role entry. | | updated_by_profile_id | 
uuid | Nullable, Foreign Key to `public.profiles(id)` ON DELETE SET NULL | 
Profile ID of the user who last updated this role entry. | | deleted_at | 
timestamp with time zone | Nullable | Timestamp for soft deletion of a role 
definition. Prefer `is_role_active = false` for retiring roles in use. Checked 
by `check_profile_roles` trigger. [cite: 1371] | 3. PostgreSQL DDL -- Table 
Definition CREATE TABLE public.user_roles_master ( role_code text NOT NULL 
PRIMARY KEY, default_display_name text NOT NULL, default_description text NULL, 
icon_identifier text NULL, permissions_summary_json jsonb NULL, 
role_hierarchy_level integer NULL, is_system_role boolean NOT NULL DEFAULT 
false, is_role_active boolean NOT NULL DEFAULT true, 
default_for_new_pilgrim_users boolean NOT NULL DEFAULT false, created_at 
timestamp with time zone NOT NULL DEFAULT now(), updated_at timestamp with time 
zone NOT NULL DEFAULT now(), created_by_profile_id uuid NULL REFERENCES 
public.profiles(id) ON DELETE SET NULL, updated_by_profile_id uuid NULL 
REFERENCES public.profiles(id) ON DELETE SET NULL, deleted_at timestamp with 
time zone NULL, CONSTRAINT check_role_code_format CHECK (role_code = 
lower(role_code) AND role_code ~ '^[a-z0-9_]+$') ); -- Unique Partial Index to 
ensure only one role is default for new pilgrim users CREATE UNIQUE INDEX 
uq_one_default_for_new_pilgrim_users ON public.user_roles_master 
(default_for_new_pilgrim_users) WHERE (default_for_new_pilgrim_users = TRUE); 
[cite: 1374] -- Indexes CREATE INDEX idx_user_roles_master_active_default ON 
public.user_roles_master (is_role_active, default_for_new_pilgrim_users); 
[cite: 1375] CREATE INDEX idx_user_roles_master_created_by_profile_id ON 
public.user_roles_master (created_by_profile_id) WHERE created_by_profile_id IS 
NOT NULL; CREATE INDEX idx_user_roles_master_updated_by_profile_id ON 
public.user_roles_master (updated_by_profile_id) WHERE updated_by_profile_id IS 
NOT NULL; -- Comments COMMENT ON TABLE public.user_roles_master IS 'Defines all 
available user roles, their default names/descriptions (in primary reference 
language), permission summaries, UI icons, and audit trails for RBAC. Version 
2.1.'; [cite: 1376] COMMENT ON COLUMN public.user_roles_master.role_code IS 
'PK. Short, unique, machine-readable, lowercase role code (e.g., pilgrim_user). 
Used in profiles.roles.'; [cite: 1377] COMMENT ON COLUMN 
public.user_roles_master.default_display_name IS 'Human-readable name in the 
primary reference language. (Translatable via translations table).'; COMMENT ON 
COLUMN public.user_roles_master.default_description IS 'Detailed description of 
the role in the primary reference language. (Translatable via translations 
table).'; COMMENT ON COLUMN public.user_roles_master.icon_identifier IS 
'Optional identifier for a UI icon representing the role (e.g., a Material 
Design Icon name like ''person_outline'').'; COMMENT ON COLUMN 
public.user_roles_master.permissions_summary_json IS 'JSONB storing a 
human-readable summary of key permissions. For documentation/admin UI; 
enforcement via RLS/app logic.'; COMMENT ON COLUMN 
public.user_roles_master.is_system_role IS 'If true, this is a core system role 
resistant to easy deletion/modification.'; COMMENT ON COLUMN 
public.user_roles_master.default_for_new_pilgrim_users IS 'If true, role is 
auto-assigned to new pilgrims. Enforced unique true value by partial index.'; 
COMMENT ON COLUMN public.user_roles_master.created_by_profile_id IS 'Profile ID 
of the user who initially created this role entry. FK to profiles.id. ON DELETE 
SET NULL.'; COMMENT ON COLUMN public.user_roles_master.updated_by_profile_id IS 
'Profile ID of the user who last updated this role entry. FK to profiles.id. ON 
DELETE SET NULL.'; COMMENT ON COLUMN public.user_roles_master.deleted_at IS 
'Timestamp for soft deletion. Prefer is_role_active = false for retiring roles 
in use. Used by profiles.check_profile_roles trigger.'; 4. Triggers/Functions 
-- Trigger for updated_at timestamp CREATE TRIGGER 
handle_user_roles_master_updated_at BEFORE UPDATE ON public.user_roles_master 
FOR EACH ROW EXECUTE FUNCTION extensions.moddatetime('updated_at'); -- Using 
Supabase standard [cite: 1384] -- Trigger function to clean up related 
translations on delete CREATE OR REPLACE FUNCTION 
public.cleanup_user_roles_master_translations() RETURNS TRIGGER AS $$ BEGIN 
DELETE FROM public.translations WHERE table_identifier = 'user_roles_master' 
AND row_foreign_key = OLD.role_code; RETURN OLD; END; $$ LANGUAGE plpgsql 
SECURITY DEFINER; -- Apply the cleanup trigger for translations CREATE TRIGGER 
trigger_cleanup_user_roles_master_translations AFTER DELETE ON 
public.user_roles_master FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_user_roles_master_translations(); 5. JSON Schema Mirror { 
"title": "user_role_master", "description": "Defines user roles, their default 
display attributes (translatable), permission summaries, UI icons, and audit 
trails. Version 2.1.", "type": "object", "properties": { "role_code": { "type": 
"string", "description": "PK. Machine-readable role code.", "pattern": 
"^[a-z0-9_]+$" }, "default_display_name": { "type": "string", "description": 
"Default human-readable name (primary lang). Translatable." }, 
"default_description": { "type": ["string", "null"], "description": "Default 
detailed description (primary lang). Translatable." }, "icon_identifier": { 
"type": ["string", "null"], "description": "Optional UI icon identifier." }, 
"permissions_summary_json": { "type": ["object", "null"], "description": "JSONB 
summary of permissions for UI/docs." }, "role_hierarchy_level": { "type": 
["integer", "null"], "description": "Optional numerical hierarchy level." }, 
"is_system_role": { "type": "boolean", "default": false, "description": "True 
if a core system role." }, "is_role_active": { "type": "boolean", "default": 
true, "description": "True if role is active and assignable." }, 
"default_for_new_pilgrim_users": { "type": "boolean", "default": false, 
"description": "True if auto-assigned to new users (only one)." }, 
"created_at": { "type": "string", "format": "date-time", "description": 
"Timestamp of creation.", "readOnly": true }, "updated_at": { "type": "string", 
"format": "date-time", "description": "Timestamp of last update.", "readOnly": 
true }, "created_by_profile_id": { "type": ["string", "null"], "format": 
"uuid", "description": "Profile ID of creator." }, "updated_by_profile_id": { 
"type": ["string", "null"], "format": "uuid", "description": "Profile ID of 
last updater." }, "deleted_at": { "type": ["string", "null"], "format": 
"date-time", "description": "Timestamp for soft deletion.", "readOnly": true } 
}, "required": [ "role_code", "default_display_name", "is_system_role", 
"is_role_active", "default_for_new_pilgrim_users" ], "primary_key": 
["role_code"], "unique_constraints": [ {"columns": 
["default_for_new_pilgrim_users"], "name": 
"uq_one_default_for_new_pilgrim_users", "where_clause": 
"default_for_new_pilgrim_users = TRUE"} ], "foreign_keys": [ {"columns": 
["created_by_profile_id"], "references_table": "public.profiles", 
"references_columns": ["id"], "on_delete": "SET NULL"}, {"columns": 
["updated_by_profile_id"], "references_table": "public.profiles", 
"references_columns": ["id"], "on_delete": "SET NULL"} ] } 6. Relationships & 
Integrity Primary Key: `role_code` (text). Foreign Keys: â€¢ 
`created_by_profile_id` references `public.profiles(id)`: ON DELETE SET NULL. â€¢ 
`updated_by_profile_id` references `public.profiles(id)`: ON DELETE SET NULL. 
Referenced By: `profiles.roles` (validated by `check_profile_roles()` trigger). 
`translations` table for translatable fields. Junction/Lookup Tables: This 
table *is* a lookup table. Mermaid ER Snippet: erDiagram profiles { uuid id PK 
} user_roles_master { text role_code PK text default_display_name 
"Translatable" text default_description "Translatable" text icon_identifier 
boolean default_for_new_pilgrim_users "Partial UK (TRUE)" boolean 
is_role_active uuid created_by_profile_id FK uuid updated_by_profile_id FK 
timestamptz deleted_at } translations { text table_identifier; text 
column_identifier; text row_foreign_key } profiles ..> user_roles_master : 
"roles array contains role_code" user_roles_master ..> translations : 
"default_display_name translated in" user_roles_master ..> translations : 
"default_description translated in" user_roles_master }o--o| profiles : 
"created_by (admin)" user_roles_master }o--o| profiles : "updated_by (admin)" 
7. Multilingual Strategy Translatable Fields: `default_display_name`, 
`default_description` store primary reference language text. Translated 
versions are in `public.translations`. An `AFTER DELETE` trigger on this table 
ensures orphaned translations are cleaned up. 8. Role-Based Workflow & RLS 
Notes Key Fields: `is_system_role`, `is_role_active`, 
`default_for_new_pilgrim_users`, `deleted_at`. RLS Policies: â€¢ ðŸŸ¢ Public read 
for active/system roles. ```sql CREATE POLICY "select_active_or_system_roles" 
ON public.user_roles_master FOR SELECT USING (is_role_active = true OR 
is_system_role = true); ``` â€¢ ðŸŸ¢ Admins manage all role definitions. ```sql 
CREATE POLICY "admin_manage_all_user_roles" ON public.user_roles_master FOR ALL 
USING (public.has_role('admin_platform') OR public.has_role('admin_super')) 
WITH CHECK (public.has_role('admin_platform') OR 
public.has_role('admin_super')); ``` ðŸŸ  Caution on modifying/deleting 
`is_system_role` roles. 9. ENUM vs Lookup Discussion ðŸŸ¢ This table *is* a 
lookup table, which is appropriate. 10. UI/UX Enablement Columns powering UI: 
`default_display_name` (translated), `default_description` (translated), 
`icon_identifier`, `permissions_summary_json`, `is_role_active`, 
`is_system_role`. Indexed Fields: PK, `idx_user_roles_master_active_default`. 
11. Auditing & Lifecycle Management Audit Columns: `created_at`, `updated_at` 
(auto-managed). `created_by_profile_id`, `updated_by_profile_id` added for 
admin change tracking. Lifecycle: `is_role_active` for retiring roles. 
`deleted_at` for hard deletion (checked by `profiles` trigger). 12. Scalability 
& Future-Proofing Scalability: Table will remain small and performant. 
Future-Proofing: `role_hierarchy_level`, `permissions_summary_json`, 
`icon_identifier` allow for evolution. 13. Seed Data (V1) | role_code | 
default_display_name | default_description | icon_identifier | is_system_role | 
is_role_active | default_for_new_pilgrim_users | created_by_profile_id | 
updated_by_profile_id | | :------------------------ | :------------------------ 
| :--------------------------------------- | :-------------- | :------------- | 
:------------- | :---------------------------- | :-------------------- | 
:-------------------- | | 'pilgrim_user' | 'Pilgrim User' | 'Standard user 
planning or on a pilgrimage.' | 'person' | true | true | true | `[ADMIN_UUID]` 
| `[ADMIN_UUID]` | | 'accommodation_host' | 'Accommodation Host' | 'Manages 
accommodation listings.' | 'hotel' | false | true | false | `[ADMIN_UUID]` | 
`[ADMIN_UUID]` | | 'regional_content_manager'| 'Regional Content Manager'| 
'Manages content for specific regions.' | 'edit_location' | false | true | 
false | `[ADMIN_UUID]` | `[ADMIN_UUID]` | | 'content_moderator' | 'Content 
Moderator' | 'Moderates user-generated content.' | 'gavel' | false | true | 
false | `[ADMIN_UUID]` | `[ADMIN_UUID]` | | 'admin_platform' | 'Platform 
Administrator' | 'Manages overall platform settings.' | 'admin_panel_settings' 
| true | true | false | `[ADMIN_UUID]` | `[ADMIN_UUID]` | | 'admin_super' | 
'Super Administrator' | 'Full system access, manages core data.' | 'security' | 
true | true | false | `[ADMIN_UUID]` | `[ADMIN_UUID]` | *(Note: `[ADMIN_UUID]` 
is a placeholder for an actual admin/system user profile ID used for seeding.)* 
14. Next-Action Checklist â€¢ ðŸ”´ Create Table: Execute DDL for 
`public.user_roles_master` including new audit columns and `icon_identifier`. â€¢ 
ðŸ”´ Create Unique Partial Index `uq_one_default_for_new_pilgrim_users`. â€¢ ðŸŸ¢ 
Create Additional Indexes: `idx_user_roles_master_active_default` and indexes 
for audit FKs. â€¢ ðŸ”´ Implement `updated_at` Trigger using 
`extensions.moddatetime`. â€¢ ðŸ”´ Implement Translations Cleanup Trigger: Create 
and apply `trigger_cleanup_user_roles_master_translations` (AFTER 
`public.translations` table is created). â€¢ ðŸ”´ Pre-populate Seed Data: Insert 
initial V1 roles as defined in Section 13. â€¢ ðŸŸ¢ Define `icon_identifier` 
convention/source for roles. â€¢ ðŸŸ  Define how `created_by_profile_id` and 
`updated_by_profile_id` will be populated (application layer for admin actions, 
or manually for migrations). 
