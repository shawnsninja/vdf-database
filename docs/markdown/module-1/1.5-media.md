# 1.5 media

  https://gemini.google.com/u/1/app/fd47ede3d905a3f2 
https://gemini.google.com/u/1/app/440838222ac514d7 Production-Ready 
Specification: public.media Table Version: 2.2 (Checklist V2-05-17-B Applied) 
Date: 2025-05-17 1. Purpose & Primary Use-Cases Mission Statement: To act as 
the central metadata repository for every individual media file (images 
primarily for V1, extensible to other types) used on the platform, referencing 
files in Supabase Storage and holding descriptive, technical, workflow, and 
administrative information, including audit trails for creation and updates. 
Key User-Story Touchpoints: â€¢ Pilgrim (Anna): Views images associated with 
platform content. â€¢ Host (Marco): Uploads and manages images for his 
accommodation. â€¢ Regional Manager (Sofia): Manages media for regional content. 
â€¢ Platform Administrator: Oversees all media, manages statuses, with auditable 
actions. â€¢ System/Developer: Implements upload/optimization pipeline, serves 
correct image variants, relies on audit fields. 2. Schema | column | data_type 
| constraints | description | | :------------------------------ | 
:------------------------ | 
:-------------------------------------------------------------------------------
----------------------------- | 
:-------------------------------------------------------------------------------
--------------------------------------------------------------------------------
---------------------------------------- | | id | uuid | Primary Key, Default 
`gen_random_uuid()` | Unique identifier for the media item. | | 
uploader_profile_id | uuid | Nullable, References `profiles(id)` ON DELETE SET 
NULL | Profile ID of the user who uploaded this media. (Serves as 
`created_by`). If uploader's profile is deleted, media is kept, uploader link 
becomes NULL. | | storage_bucket_name | text | Not Null | Name of the Supabase 
Storage bucket (e.g., 'platform-media'). | | storage_object_path_original | 
text | Not Null, Unique (`uq_media_storage_object_path`) | Full, unique path to 
the original uploaded object within its bucket (e.g., 
`uploads/images/2025/05/{uuid}_original.jpg`). | | file_name_original | text | 
Not Null | Original filename as provided by the uploader (e.g., "La Verna 
Sunset.jpg"). | | file_mime_type | text | Not Null | MIME type of the original 
file (e.g., 'image/jpeg', 'image/png', 'application/pdf'). | | 
file_size_bytes_original | bigint | Nullable, CHECK (`file_size_bytes_original` 
IS NULL OR `file_size_bytes_original` > 0) | Size of the original uploaded file 
in bytes. | | image_width_px_original | integer | Nullable, CHECK 
(`image_width_px_original` IS NULL OR `image_width_px_original` > 0) | For 
images, the original width in pixels. Null if not an image or if not 
applicable. | | image_height_px_original | integer | Nullable, CHECK 
(`image_height_px_original` IS NULL OR `image_height_px_original` > 0) | For 
images, the original height in pixels. Null if not an image or if not 
applicable. | | image_variants_json | jsonb | Nullable | ðŸŸ  JSONB storing 
relative paths for optimized image versions. Populated by app layer/backend. 
Ex: `{"thumb_s": "path/to_thumb.webp", "display_l": "path/to_display.jpg"}`. | 
| default_alt_text | text | Nullable | Default alternative text in the primary 
reference language for accessibility (WCAG). (Translatable via 
`public.translations`) | | default_caption | text | Nullable | Default caption 
in the primary reference language for display. (Translatable via 
`public.translations`) | | attribution_text | text | Nullable | Credit for the 
photographer/source. (Potentially Translatable via `public.translations`) | | 
attribution_url | text | Nullable, CHECK (`attribution_url` IS NULL OR 
`attribution_url` ~* '^https?://.+') | URL linking to the source or license. 
Validated format. | | licence | media_licence_enum | Nullable, Default 
`'all_rights_reserved'` | Usage license associated with the media item. | | 
media_asset_type | media_asset_type_enum | Not Null, Default `'image'` | 
General type of media asset (e.g., 'image', 'document_pdf'). | | media_status | 
media_status_enum | Not Null, Default `'pending_review'` | Current 
workflow/visibility status of the media item. | | tags | text[] | Nullable | 
Array of keywords/tags for categorizing or searching media. | | 
checksum_sha256_original | text | Nullable, Unique 
(`uq_media_checksum_original`) | SHA256 checksum of the original file. Used for 
de-duplication. Unique if not NULL. | | dominant_color_hex | text | Nullable, 
CHECK (`dominant_color_hex` IS NULL OR `dominant_color_hex` ~ 
'^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$') | Optional dominant color of an image 
(hex code), for UI placeholders. | | last_linked_or_used_at | timestamp with 
time zone | Nullable | Timestamp when this media item was last actively linked. 
Useful for cleanup of orphaned media. Updated by triggers on linking tables. | 
| created_at | timestamp with time zone | Not Null, Default `now()` | Timestamp 
of when this media record was created. | | updated_at | timestamp with time 
zone | Not Null, Default `now()` | Timestamp of when this media record was last 
updated (auto-updated by general row update trigger). | | updated_by_profile_id 
| uuid | Nullable, References `public.profiles(id)` ON DELETE SET NULL | 
Profile ID of the user who last significantly updated this media record (e.g., 
status change, key metadata update). ON DELETE SET NULL. | | deleted_at | 
timestamp with time zone | Nullable | Timestamp for soft deletion. Media marked 
as deleted might be scheduled for actual file removal from storage. | 3. 
PostgreSQL DDL -- ENUM Types (ensure these are created globally or before this 
table if not already existing) DO $$ BEGIN IF NOT EXISTS (SELECT 1 FROM pg_type 
WHERE typname = 'media_asset_type_enum') THEN CREATE TYPE 
public.media_asset_type_enum AS ENUM ('image', 'document_pdf', 'audio_clip', 
'video_clip', 'gpx_file', 'other_file'); END IF; IF NOT EXISTS (SELECT 1 FROM 
pg_type WHERE typname = 'media_licence_enum') THEN CREATE TYPE 
public.media_licence_enum AS ENUM ('all_rights_reserved', 'cc_by', 'cc_by_sa', 
'cc_by_nd', 'cc_by_nc', 'cc_by_nc_sa', 'cc_by_nc_nd', 'cc0_public_domain', 
'uploader_owns_contact_for_use', 'official_permission_granted', 
'unknown_licence'); END IF; IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname 
= 'media_status_enum') THEN CREATE TYPE public.media_status_enum AS ENUM 
('processing_upload', 'pending_review', 'published_approved', 
'rejected_hidden', 'archived', 'error_uploading'); END IF; END$$; -- Table 
Definition CREATE TABLE public.media ( id uuid NOT NULL DEFAULT 
gen_random_uuid() PRIMARY KEY, uploader_profile_id uuid NULL REFERENCES 
public.profiles(id) ON DELETE SET NULL, -- Serves as created_by_profile_id 
storage_bucket_name text NOT NULL, storage_object_path_original text NOT NULL, 
file_name_original text NOT NULL, file_mime_type text NOT NULL, 
file_size_bytes_original bigint NULL, image_width_px_original integer NULL, 
image_height_px_original integer NULL, image_variants_json jsonb NULL, 
default_alt_text text NULL, default_caption text NULL, attribution_text text 
NULL, attribution_url text NULL, licence public.media_licence_enum NULL DEFAULT 
'all_rights_reserved', media_asset_type public.media_asset_type_enum NOT NULL 
DEFAULT 'image', media_status public.media_status_enum NOT NULL DEFAULT 
'pending_review', tags text[] NULL, checksum_sha256_original text NULL, 
dominant_color_hex text NULL, last_linked_or_used_at timestamp with time zone 
NULL, created_at timestamp with time zone NOT NULL DEFAULT now(), updated_at 
timestamp with time zone NOT NULL DEFAULT now(), updated_by_profile_id uuid 
NULL REFERENCES public.profiles(id) ON DELETE SET NULL, deleted_at timestamp 
with time zone NULL, CONSTRAINT uq_media_storage_object_path UNIQUE 
(storage_object_path_original), CONSTRAINT uq_media_checksum_original UNIQUE 
(checksum_sha256_original), CONSTRAINT check_file_size_positive CHECK 
(file_size_bytes_original IS NULL OR file_size_bytes_original > 0), CONSTRAINT 
check_image_width_positive CHECK (image_width_px_original IS NULL OR 
image_width_px_original > 0), CONSTRAINT check_image_height_positive CHECK 
(image_height_px_original IS NULL OR image_height_px_original > 0), CONSTRAINT 
check_dominant_color_hex_format CHECK (dominant_color_hex IS NULL OR 
dominant_color_hex ~ '^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$'), CONSTRAINT 
check_attribution_url_format CHECK (attribution_url IS NULL OR attribution_url 
~* '^https?://.+') ); -- Indexes CREATE INDEX idx_media_uploader_profile_id ON 
public.media (uploader_profile_id) WHERE uploader_profile_id IS NOT NULL; 
CREATE INDEX idx_media_updated_by_profile_id ON public.media 
(updated_by_profile_id) WHERE updated_by_profile_id IS NOT NULL; CREATE INDEX 
idx_media_asset_type_status ON public.media (media_asset_type, media_status); 
CREATE INDEX idx_media_tags ON public.media USING GIN (tags); CREATE INDEX 
idx_media_deleted_at ON public.media (deleted_at) WHERE deleted_at IS NOT NULL; 
CREATE INDEX idx_media_last_linked_or_used_at ON public.media 
(last_linked_or_used_at) WHERE last_linked_or_used_at IS NOT NULL; -- Comments 
COMMENT ON TABLE public.media IS 'Central metadata repository for media files, 
referencing files in Supabase Storage and including audit trails. Version 
2.2.'; COMMENT ON COLUMN public.media.uploader_profile_id IS 'Profile ID of the 
user who uploaded this media (serves as created_by). If uploader''s profile is 
deleted, this becomes NULL.'; COMMENT ON COLUMN 
public.media.image_variants_json IS 'JSONB storing relative paths/identifiers 
for optimized versions (e.g., thumbnails, webp). Populated by the application 
layer/backend. Example: {"thumb_s": "variants/uuid_thumb_s.webp", "display_l": 
"variants/uuid_display_l.jpg"}.'; COMMENT ON COLUMN 
public.media.default_alt_text IS 'Default alternative text in the primary 
reference language for accessibility (WCAG). (Translatable via ''translations'' 
table).'; COMMENT ON COLUMN public.media.default_caption IS 'Default caption in 
the primary reference language for display. (Translatable via ''translations'' 
table).'; COMMENT ON COLUMN public.media.updated_by_profile_id IS 'Profile ID 
of the user who last significantly updated this media record (e.g., status 
change, key metadata update). ON DELETE SET NULL.'; COMMENT ON COLUMN 
public.media.last_linked_or_used_at IS 'Timestamp when this media item was last 
actively linked. Updated by triggers on linking tables. Useful for identifying 
orphaned media.'; 4. Triggers/Functions -- Trigger for general updated_at 
timestamp CREATE TRIGGER handle_media_updated_at BEFORE UPDATE ON public.media 
FOR EACH ROW EXECUTE FUNCTION extensions.moddatetime('updated_at'); -- Standard 
Supabase trigger for updated_at -- Trigger function to clean up related 
translations on delete CREATE OR REPLACE FUNCTION 
public.cleanup_media_translations() RETURNS TRIGGER AS $$ BEGIN DELETE FROM 
public.translations WHERE table_identifier = 'media' AND row_foreign_key = 
OLD.id::text; RETURN OLD; END; $$ LANGUAGE plpgsql SECURITY DEFINER; -- Apply 
the cleanup trigger for translations CREATE TRIGGER 
trigger_cleanup_media_translations AFTER DELETE ON public.media FOR EACH ROW 
EXECUTE FUNCTION public.cleanup_media_translations(); -- Conceptual Trigger 
function to update 'last_linked_or_used_at' (to be called by triggers on media 
*linking* tables) -- (Definition as provided previously) /* CREATE OR REPLACE 
FUNCTION public.update_media_last_linked_timestamp() RETURNS TRIGGER AS $$ ... 
$$ LANGUAGE plpgsql SECURITY DEFINER; */ 5. JSON Schema Mirror { "title": 
"media_item", "description": "Master record for a media asset, including 
metadata, references to cloud storage, and audit trails. Content in 
'default_alt_text' and 'default_caption' is in the primary reference language. 
Version 2.2.", "type": "object", "properties": { "id": { "type": "string", 
"format": "uuid", "description": "PK. Unique identifier.", "default": 
"gen_random_uuid()", "readOnly": true }, "uploader_profile_id": { "type": 
["string", "null"], "format": "uuid", "description": "FK to profiles.id of 
uploader (created_by)." }, "storage_bucket_name": { "type": "string", 
"description": "Supabase Storage bucket name." }, 
"storage_object_path_original": { "type": "string", "description": "Unique path 
to original object in bucket." }, "file_name_original": { "type": "string", 
"description": "Original uploader filename." }, "file_mime_type": { "type": 
"string", "description": "MIME type of original file." }, 
"file_size_bytes_original": { "type": ["integer", "null"], "format": "int64", 
"description": "Size of original file in bytes.", "minimum": 1 }, 
"image_width_px_original": { "type": ["integer", "null"], "description": 
"Original width in pixels (for images).", "minimum": 1 }, 
"image_height_px_original": { "type": ["integer", "null"], "description": 
"Original height in pixels (for images).", "minimum": 1 }, 
"image_variants_json": { "type": ["object", "null"], "description": "JSONB with 
paths to optimized image versions. Populated by app/backend. Ex: {\"thumb_s\": 
\"path/to_thumb.webp\"}.", "examples": [ { "thumb_s_webp": 
"variants/uuid_thumb_s.webp", "display_l_jpeg": "variants/uuid_display_l.jpg" } 
] }, "default_alt_text": { "type": ["string", "null"], "description": "Default 
alt text (primary lang). Translatable." }, "default_caption": { "type": 
["string", "null"], "description": "Default caption (primary lang). 
Translatable." }, "attribution_text": { "type": ["string", "null"], 
"description": "Credit/source. Potentially translatable." }, "attribution_url": 
{ "type": ["string", "null"], "format": "url", "pattern": "^https?://.+", 
"description": "URL to source/license." }, "licence": { "$ref": 
"#/definitions/media_licence_enum", "default": "all_rights_reserved" }, 
"media_asset_type": { "$ref": "#/definitions/media_asset_type_enum", "default": 
"image" }, "media_status": { "$ref": "#/definitions/media_status_enum", 
"default": "pending_review" }, "tags": { "type": ["array", "null"], "items": { 
"type": "string" }, "description": "Keywords/tags for categorization." }, 
"checksum_sha256_original": { "type": ["string", "null"], "description": 
"SHA256 checksum of original file for de-duplication. Unique if not NULL." }, 
"dominant_color_hex": { "type": ["string", "null"], "pattern": 
"^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$", "description": "Optional dominant color 
of image (hex)." }, "last_linked_or_used_at": { "type": ["string", "null"], 
"format": "date-time", "description": "Timestamp last actively linked. For 
orphaned media cleanup." }, "created_at": { "type": "string", "format": 
"date-time", "description": "Timestamp of record creation.", "readOnly": true 
}, "updated_at": { "type": "string", "format": "date-time", "description": 
"Timestamp of last metadata update.", "readOnly": true }, 
"updated_by_profile_id": { "type": ["string", "null"], "format": "uuid", 
"description": "FK to profiles.id of last significant updater." }, 
"deleted_at": { "type": ["string", "null"], "format": "date-time", 
"description": "Timestamp for soft deletion.", "readOnly": true } }, 
"required": [ "id", "storage_bucket_name", "storage_object_path_original", 
"file_name_original", "file_mime_type", "media_asset_type", "media_status" ], 
"primary_key": ["id"], "unique_constraints": [ {"columns": 
["storage_object_path_original"], "name": "uq_media_storage_object_path"}, 
{"columns": ["checksum_sha256_original"], "name": "uq_media_checksum_original", 
"allow_null_results": true} ], "foreign_keys": [ {"columns": 
["uploader_profile_id"], "references_table": "public.profiles", 
"references_columns": ["id"], "on_delete": "SET NULL"}, {"columns": 
["updated_by_profile_id"], "references_table": "public.profiles", 
"references_columns": ["id"], "on_delete": "SET NULL"} ], "definitions": { 
"media_asset_type_enum": { "type": "string", "enum": ["image", "document_pdf", 
"audio_clip", "video_clip", "gpx_file", "other_file"] }, "media_licence_enum": 
{ "type": "string", "enum": [ "all_rights_reserved", "cc_by", "cc_by_sa", 
"cc_by_nd", "cc_by_nc", "cc_by_nc_sa", "cc_by_nc_nd", "cc0_public_domain", 
"uploader_owns_contact_for_use", "official_permission_granted", 
"unknown_licence" ]}, "media_status_enum": { "type": "string", "enum": [ 
"processing_upload", "pending_review", "published_approved", "rejected_hidden", 
"archived", "error_uploading" ]} } } 6. Relationships & Integrity Primary Key: 
`id` (uuid). Foreign Keys: â€¢ `uploader_profile_id` references 
`public.profiles(id)`: ON DELETE SET NULL (serves as `created_by`). â€¢ 
`updated_by_profile_id` references `public.profiles(id)`: ON DELETE SET NULL. 
Linking: Central repository, referenced by other linking tables (e.g., 
`waypoint_media`) or direct FKs. Orphaned Media Management: 
`last_linked_or_used_at` is updated by triggers on linking tables. 7. 
Multilingual Strategy Translatable Fields: `default_alt_text`, 
`default_caption`, optionally `attribution_text` via `public.translations`. 
`AFTER DELETE` trigger on `media` cleans related translations. 8. Role-Based 
Workflow & RLS Notes Key Fields: `uploader_profile_id`, `media_status`, 
`updated_by_profile_id`, `deleted_at`. RLS Policies: (As defined in Media Spec 
v2.1 - public read published, authenticated insert, user manage own, 
moderator/admin update, admin delete). Population of `updated_by_profile_id` 
should be handled by application logic during moderation actions covered by 
RLS. 9. ENUM vs Lookup Discussion ðŸŸ¢ ENUMs (`media_asset_type_enum`, 
`media_licence_enum`, `media_status_enum`) are appropriate. 10. UI/UX 
Enablement Columns for UI: `image_variants_json`, `default_alt_text` 
(translated), `default_caption` (translated), `dominant_color_hex`, 
`media_status`, `tags`. Performance: Indexes on `tags` (GIN), 
`(media_asset_type, media_status)`, FKs, `last_linked_or_used_at`. 11. Auditing 
& Lifecycle Management Audit Columns: `uploader_profile_id` (as created\_by), 
`created_at`, `updated_at`, `updated_by_profile_id`. Soft Deletes: 
`deleted_at`. File storage cleanup is a separate background process. 12. 
Scalability & Future-Proofing Scalability: UUID PKs, Supabase Storage, JSONB 
are scalable. Partitioning V2+ option. Future-Proofing: ENUMs, `tags`, `jsonb` 
offer flexibility. `last_linked_or_used_at` aids maintenance. 13. Seed Data âšª 
N/A - This table stores transactional media metadata, not predefined master 
data requiring seeding. 14. Next-Action Checklist â€¢ ðŸ”´ Implement ENUM Types. â€¢ 
ðŸ”´ Create Table: Execute DDL for `public.media`. â€¢ ðŸ”´ Create Indexes. â€¢ ðŸ”´ 
Implement `updated_at` Trigger (e.g., `extensions.moddatetime`). â€¢ ðŸ”´ Implement 
Translations Cleanup Trigger: Create and apply 
`trigger_cleanup_media_translations` (AFTER `public.translations` table 
exists). â€¢ ðŸŸ  Develop Backend Media Processing Logic: For uploads, checksums, 
optimization, populating `image_variants_json`, and metadata extraction. This 
includes defining the structure and keys for `image_variants_json`. â€¢ ðŸŸ  Define 
Population Logic for `updated_by_profile_id`: Ensure application logic or 
specific triggers populate this during moderation/admin updates. â€¢ ðŸŸ  Plan 
Orphaned Media File Cleanup Process from Storage. â€¢ ðŸŸ  Implement Triggers for 
`last_linked_or_used_at`: On all media *linking* tables. â€¢ ðŸŸ¢ Consider 
Full-Text Search on text fields (`default_alt_text`, `default_caption`, `tags`, 
`file_name_original`) for V2+. 
