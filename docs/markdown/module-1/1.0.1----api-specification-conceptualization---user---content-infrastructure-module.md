# 1.0.1 -  API Specification Conceptualization - User & Content Infrastructure Module

  https://gemini.google.com/u/1/app/440838222ac514d7 API Specification 
Conceptualization - User & Content Infrastructure Module Version: 1.0 Date: 
2025-05-17 This document outlines key conceptual API endpoints, example 
responses, database support analysis, and potential schema tweaks for the User 
& Content Infrastructure Module. This module includes the `profiles`, 
`user_roles_master`, `languages_master`, `media`, and `translations` tables. 
### 1. Key Conceptual API Endpoints 1. **Endpoint: Get Current User's Profile** 
* **Purpose**: Retrieve detailed profile information for the currently 
authenticated user to personalize their experience and manage settings. * 
**Path Pattern**: `GET /profiles/me` * **Query Params / Filters / Options**: * 
`include` (optional, string, comma-separated): e.g., `role_details` (to expand 
`role_codes` with their names/descriptions from `user_roles_master`, including 
translations if a `lang` param is also present), `avatar_details` (to get the 
full media object for `public_avatar_media_id`). * `lang` (optional, string, 
e.g., `it`): ISO language code. If `include=role_details` is used, role 
names/descriptions would be returned in this language if available, otherwise 
in the primary reference language. 2. **Endpoint: List Available Platform 
Languages** * **Purpose**: Fetch a list of languages actively supported by the 
platform, typically for populating UI language selectors. * **Path Pattern**: 
`GET /languages` * **Query Params / Filters / Options**: * 
`is_active_for_platform` (optional, boolean, default `true`): Filters languages 
based on their active status for platform use. * `sort_by` (optional, string, 
default `display_order_ui`): Field to sort by (e.g., `display_order_ui`, 
`display_name_en`). * `order` (optional, string, default `asc`): Sort order 
(`asc` or `desc`). 3. **Endpoint: Get Media Item Details** * **Purpose**: 
Retrieve comprehensive metadata for a specific media item, including its 
variants and translated text for fields like alt text and caption. * **Path 
Pattern**: `GET /media/{media_id}` (where `{media_id}` is the UUID of the media 
item) * **Query Params / Filters / Options**: * `lang` (optional, string, e.g., 
`it`): The desired language code for translatable fields (`default_alt_text`, 
`default_caption`). If not provided, or if a translation doesn't exist for the 
requested language, the API should return the text from the primary reference 
language. * `include_uploader_profile` (optional, boolean, default `false`): If 
true, includes basic public details of the uploader profile. --- ### 2. Example 
JSON Responses 1. **`GET 
/profiles/me?include=role_details,avatar_details&lang=it`** ```json { "id": 
"123e4567-e89b-12d3-a456-426614174000", "username": "anna_pilgrim", 
"full_name": "Anna Rossi", "public_display_name": "Anna R.", "public_bio": 
"Pilgrim exploring the Via di Francesco. Love history and nature!", 
"preferred_language_code": "it", "preferred_units_of_measure": "metric", 
"pilgrim_experience_level": "intermediate_few_pilgrimages", 
"pilgrimage_interests_tags": ["history", "nature", "spirituality"], 
"is_profile_publicly_visible": true, "account_status": "active", "roles": [ { 
"role_code": "pilgrim_user", "default_display_name": "Utente Pellegrino", 
"icon_identifier": "person", "translations": [ {"lang": "en", 
"default_display_name": "Pilgrim User"} ] }, { "role_code": 
"content_moderator", "default_display_name": "Moderatore Contenuti", 
"icon_identifier": "gavel", "translations": [ {"lang": "en", 
"default_display_name": "Content Moderator"} ] } ], "public_avatar": { "id": 
"a1b2c3d4-e5f6-7890-1234-567890abcdef", "media_asset_type": "image", 
"file_mime_type": "image/jpeg", "default_alt_text": "Avatar di Anna R.", 
"translations": [ {"lang": "en", "default_alt_text": "Anna R. avatar"} ], 
"image_variants_json": { "thumb_s_webp": "variants/a1b2c3d4_thumb_s.webp", 
"display_m_jpeg": "variants/a1b2c3d4_display_m.jpg" }, "attribution_text": null 
}, "created_at": "2024-01-15T10:00:00Z", "updated_at": "2025-05-10T14:30:00Z", 
"updated_by_profile_id": null } ``` 2. **`GET 
/languages?is_active_for_platform=true&sort_by=display_order_ui`** ```json [ { 
"language_code": "en", "display_name_native": "English", "display_name_en": 
"English", "icon_identifier": "flag-icon-gb", "is_primary_content_language": 
true, "display_order_ui": 1 }, { "language_code": "it", "display_name_native": 
"Italiano", "display_name_en": "Italian", "icon_identifier": "flag-icon-it", 
"is_primary_content_language": false, "display_order_ui": 2 } ] ``` 3. **`GET 
/media/a1b2c3d4-e5f6-7890-1234-567890abcdef?lang=it&include_uploader_profile=tru
e`** ```json { "id": "a1b2c3d4-e5f6-7890-1234-567890abcdef", 
"uploader_profile": { "id": "123e4567-e89b-12d3-a456-426614174000", 
"public_display_name": "Anna R." }, "storage_bucket_name": "platform-media", 
"storage_object_path_original": "originals/2024/avatars/anna_r_original.jpg", 
"file_name_original": "anna_avatar.jpg", "file_mime_type": "image/jpeg", 
"file_size_bytes_original": 102400, "image_width_px_original": 800, 
"image_height_px_original": 800, "image_variants_json": { "thumb_s_webp": 
"variants/a1b2c3d4_thumb_s.webp", "display_m_jpeg": 
"variants/a1b2c3d4_display_m.jpg" }, "default_alt_text": "Avatar di Anna R.", 
"default_caption": "Il mio nuovo avatar!", "translations": [ {"lang": "en", 
"default_alt_text": "Anna R. avatar", "default_caption": "My new avatar!"} ], 
"attribution_text": "Foto scattata da Marco", "attribution_url": null, 
"licence": "cc_by", "media_asset_type": "image", "media_status": 
"published_approved", "tags": ["avatar", "profile"], "created_at": 
"2024-01-15T10:05:00Z", "updated_at": "2024-01-15T11:00:00Z", 
"updated_by_profile_id": "system_moderator_uuid" } ``` --- ### 3. 
Database-Support Analysis 1. **Endpoint: `GET /profiles/me`** * **Indexes**: 
Primary key on `profiles.id` is sufficient for the main lookup. Indexes on 
`user_roles_master.role_code` (PK) and `media.id` (PK) support includes. 
`idx_translations_lookup` aids role translations. * **Join Complexity**: Basic 
profile data is simple. Including `role_details` with translations requires 
multiple lookups (profile -> roles array -> user_roles_master -> translations). 
* **Recommendation**: A **database function** (e.g., 
`get_user_profile_details(profile_id uuid, request_lang_code text)`) is highly 
recommended to encapsulate this logic and return a complete JSON object, 
optimizing data retrieval. * **Performance Gotchas**: RLS policies on 
`profiles`, `user_roles_master`, and `translations` are generally efficient. 
The main complexity is efficiently assembling the nested `role_details` with 
translations. * **Missing Data?**: No obvious missing data for core profile 
needs. 2. **Endpoint: `GET /languages`** * **Indexes**: 
`idx_languages_master_active_order` (on `is_active_for_platform, 
display_order_ui`) is ideal for common filtering and sorting. * **Join 
Complexity**: Single table query; no joins required. * **Performance Gotchas**: 
Minimal; table is small and RLS is simple. * **Missing Data?**: No. 3. 
**Endpoint: `GET /media/{media_id}`** * **Indexes**: `media.id` (PK) for the 
main lookup. `idx_translations_lookup` for alt text/caption translations. 
`idx_media_uploader_profile_id` for optional uploader profile join. * **Join 
Complexity**: Fetching the base media item is simple. Handling translations for 
`default_alt_text` and `default_caption` involves a join or lookup to 
`translations`. Optional join to `profiles` for uploader info. * 
**Recommendation**: Similar to profiles, a **database function** (e.g., 
`get_media_details(target_media_id uuid, request_lang_code text, 
include_uploader boolean)`) could streamline fetching the media item with its 
translations and optional uploader data. * **Performance Gotchas**: RLS on 
`media` (checking status and `deleted_at`) is efficient with existing indexes. 
* **Missing Data?**: No obvious missing fields. --- ### 4. Immediate Schema 
Tweaks (if any) The User & Content Infrastructure module's tables, after 
re-evaluation against Checklist V2-05-17-B, are largely robust and 
well-prepared to support these conceptual API endpoints. The schema tweaks 
identified during those re-evaluations (addition of audit columns like 
`updated_by_profile_id`, `icon_identifier` fields, and ensuring translation 
cleanup mechanisms are in place) have already addressed many potential API 
needs. No *new critical (ðŸ”´ Must-fix)* schema adjustments are identified solely 
from this API conceptualization exercise that were not already covered in the 
table spec updates (Versions 2.1/2.2). * ðŸŸ¢ **Optional future/Optimization**: * 
**Database Functions for Complex Objects**: Strongly consider creating 
PostgreSQL functions callable via RPC (e.g., for Supabase) to assemble complex 
JSON responses like the user profile with full role details (including 
translations) or media items with their translations. This shifts complexity to 
the database, potentially improving performance and simplifying the API 
gateway/backend-for-frontend logic. * ðŸŸ  **Full-Text Search (FTS)**: For 
enhanced search capabilities over fields like `media.default_alt_text`, 
`media.default_caption`, `media.tags`, `profiles.public_bio`, etc., 
implementing FTS (`tsvector` columns and GIN indexes) would be a valuable V2+ 
improvement. This was noted as an improvement during individual table reviews. 
The current schema provides a solid foundation. The primary focus for efficient 
API delivery will be on crafting performant queries or database functions for 
complex data aggregation, especially involving translations. 
