# 1.5.1 public.trail_media

  https://gemini.google.com/u/1/app/431cc17871bb821b ``` # Media Linking & 
Processing Specifications (V1 Draft) Date: May 18, 2025 ## ðŸ“œ Part 1: Table 
Specification - `public.trail_media` ### 1. Purpose & Primary Use-Cases This 
table links records from `public.trails` to specific media items in 
`public.media`, assigning a semantic role to each link. It enables trails to 
have multiple associated images or other media files, such as a prominent hero 
image, a gallery of representative photos, and illustrative static map 
graphics. This allows for rich visual storytelling and detailed information 
presentation for each trail. **Key User-Story Touchpoints:** * Pilgrim (Anna): 
Views hero images when exploring a trail, browses image galleries to get a feel 
for the trail's scenery and points of interest, and looks at static map images 
for overviews. * Regional Content Manager (Sofia) / Platform Administrator: 
Uploads, selects, and curates images for trail hero sections, galleries, and 
map illustrations. Manages captions, alt text, and display order for these 
media items. * System/Developer: Retrieves media based on roles for display in 
different UI contexts (e.g., fetching the `featured_image` for the trail page 
header, or all `gallery_image` items for a carousel). ### 2. Schema | Column 
Name | Data Type | Constraints | Description (Translatable fields marked) | | 
:---------------------- | :------------ | 
:-------------------------------------------------------------------------------
--------------------------------- | 
:-------------------------------------------------------------------------------
--------------------------------------------------------------------------------
------ | | `id` | `BIGINT` | `PRIMARY KEY, GENERATED ALWAYS AS IDENTITY` | 
Unique identifier for this trail-media link. | | `trail_id` | `BIGINT` | `NOT 
NULL, REFERENCES public.trails(id) ON DELETE CASCADE` | The ID of the trail 
this media is associated with. | | `media_id` | `UUID` | `NOT NULL, REFERENCES 
public.media(id) ON DELETE RESTRICT` | The ID of the media item from 
`public.media`. `ON DELETE RESTRICT` to prevent deleting media still in use by 
a trail. | | `media_role_code` | `TEXT` | `NOT NULL, REFERENCES 
public.media_roles_master(code) ON DELETE RESTRICT ON UPDATE CASCADE` | 
Semantic role of the media in the context of this trail (e.g., 
'featured_image', 'gallery_image', 'map_image_static'). From 
`public.media_roles_master`. | | `display_order` | `SMALLINT` | `NOT NULL, 
DEFAULT 0` | Order for displaying media items within a specific role for this 
trail (e.g., sequence in a gallery). | | `caption_override` | `TEXT` | `NULL` | 
Optional override for the media's default caption, specific to its use with 
this trail. Primary reference language (English). (Translatable via 
`public.translations`) | | `alt_text_override` | `TEXT` | `NULL` | Optional 
override for the media's default alt text, specific to its use with this trail, 
for accessibility. Primary reference language (English). (Translatable via 
`public.translations`) | | `created_at` | `TIMESTAMPTZ` | `NOT NULL, DEFAULT 
now()` | Timestamp of when this link record was created. | | 
`created_by_profile_id` | `UUID` | `NULL, REFERENCES public.profiles(id) ON 
DELETE SET NULL` | Profile ID of the user who created this link. | | 
`updated_at` | `TIMESTAMPTZ` | `NOT NULL, DEFAULT now()` | Timestamp of when 
this link record was last updated (auto-updated by trigger). | | 
`updated_by_profile_id` | `UUID` | `NULL, REFERENCES public.profiles(id) ON 
DELETE SET NULL` | Profile ID of the user who last updated this link. | | | | 
`UNIQUE (trail_id, media_id, media_role_code)` | Prevents linking the same 
media item with the same role to the same trail multiple times. | | | | `UNIQUE 
(trail_id, display_order, media_role_code)` | Ensures display order is unique 
within a specific role for a given trail. | ### 3. PostgreSQL DDL ```sql -- 
Assumes the following tables exist: -- public.trails (id BIGINT PK) -- 
public.media (id UUID PK) -- public.media_roles_master (code TEXT PK) -- 
public.profiles (id UUID PK) -- public.translations (for translatable fields) 
-- Assumes standard functions like public.set_current_timestamp_updated_at() or 
extensions.moddatetime exist. -- Assumes 
public.cleanup_related_translations(TEXT, TEXT) function exists. CREATE TABLE 
public.trail_media ( id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY, 
trail_id BIGINT NOT NULL REFERENCES public.trails(id) ON DELETE CASCADE, 
media_id UUID NOT NULL REFERENCES public.media(id) ON DELETE RESTRICT, 
media_role_code TEXT NOT NULL REFERENCES public.media_roles_master(code) ON 
DELETE RESTRICT ON UPDATE CASCADE, display_order SMALLINT NOT NULL DEFAULT 0, 
caption_override TEXT NULL, alt_text_override TEXT NULL, created_at TIMESTAMPTZ 
NOT NULL DEFAULT now(), created_by_profile_id UUID NULL REFERENCES 
public.profiles(id) ON DELETE SET NULL, updated_at TIMESTAMPTZ NOT NULL DEFAULT 
now(), updated_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE 
SET NULL, CONSTRAINT uq_trail_media_link UNIQUE (trail_id, media_id, 
media_role_code), CONSTRAINT uq_trail_media_role_order UNIQUE (trail_id, 
display_order, media_role_code) ); -- Indexes CREATE INDEX IF NOT EXISTS 
idx_trail_media_trail_id ON public.trail_media(trail_id); CREATE INDEX IF NOT 
EXISTS idx_trail_media_media_id ON public.trail_media(media_id); CREATE INDEX 
IF NOT EXISTS idx_trail_media_media_role_code ON 
public.trail_media(media_role_code); CREATE INDEX IF NOT EXISTS 
idx_trail_media_created_by_profile_id ON 
public.trail_media(created_by_profile_id) WHERE created_by_profile_id IS NOT 
NULL; CREATE INDEX IF NOT EXISTS idx_trail_media_updated_by_profile_id ON 
public.trail_media(updated_by_profile_id) WHERE updated_by_profile_id IS NOT 
NULL; -- Comments COMMENT ON TABLE public.trail_media IS 'Links trails to media 
items (galleries, hero images, static maps), defining display order, role, and 
translatable caption/alt-text overrides. V1.0'; COMMENT ON COLUMN 
public.trail_media.id IS 'Surrogate unique identifier for the trail-media 
link.'; COMMENT ON COLUMN public.trail_media.trail_id IS 'Foreign key to the 
public.trails table.'; COMMENT ON COLUMN public.trail_media.media_id IS 
'Foreign key to the public.media table. Restricted delete to prevent orphaned 
links if media is in use.'; COMMENT ON COLUMN 
public.trail_media.media_role_code IS 'Semantic role of the media in relation 
to the trail. FK to public.media_roles_master.code.'; COMMENT ON COLUMN 
public.trail_media.display_order IS 'Order for displaying media items within a 
specific role for this trail (e.g., sequence in a gallery). Default 0.'; 
COMMENT ON COLUMN public.trail_media.caption_override IS 'Optional override for 
the media''s default caption, specific to its use with this trail. Primary 
reference language (English). (Translatable via public.translations using 
trail_media.id).'; COMMENT ON COLUMN public.trail_media.alt_text_override IS 
'Optional override for the media''s default alt text, specific to its use with 
this trail. Primary reference language (English). (Translatable via 
public.translations using trail_media.id).'; COMMENT ON COLUMN 
public.trail_media.created_at IS 'Timestamp of when this link record was 
created.'; COMMENT ON COLUMN public.trail_media.created_by_profile_id IS 
'Profile ID of the user who created this link.'; COMMENT ON COLUMN 
public.trail_media.updated_at IS 'Timestamp of when this link record was last 
updated (auto-updated by trigger).'; COMMENT ON COLUMN 
public.trail_media.updated_by_profile_id IS 'Profile ID of the user who last 
updated this link.'; -- Standard updated_at trigger CREATE TRIGGER 
trigger_trail_media_set_updated_at BEFORE UPDATE ON public.trail_media FOR EACH 
ROW EXECUTE FUNCTION public.set_current_timestamp_updated_at(); -- Or 
extensions.moddatetime('updated_at') COMMENT ON TRIGGER 
trigger_trail_media_set_updated_at ON public.trail_media IS 'Automatically 
updates the updated_at timestamp on row modification.'; -- Orphaned translation 
cleanup trigger for trail_media's own translatable fields CREATE OR REPLACE 
FUNCTION public.cleanup_trail_media_translations() RETURNS TRIGGER AS $$ BEGIN 
IF TG_OP = 'DELETE' THEN DELETE FROM public.translations WHERE table_identifier 
= 'trail_media' AND row_foreign_key = OLD.id::TEXT; -- Uses the surrogate PK of 
trail_media END IF; RETURN OLD; END; $$ LANGUAGE plpgsql SECURITY DEFINER; 
COMMENT ON FUNCTION public.cleanup_trail_media_translations() IS 'Removes 
related entries from public.translations for trail_media.caption_override and 
trail_media.alt_text_override when a trail_media record is deleted. Runs as 
SECURITY DEFINER.'; CREATE TRIGGER 
trigger_cleanup_trail_media_translations_after_delete AFTER DELETE ON 
public.trail_media FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_trail_media_translations(); COMMENT ON TRIGGER 
trigger_cleanup_trail_media_translations_after_delete ON public.trail_media IS 
'After a trail_media link is deleted, removes its associated translations from 
the public.translations table.'; -- Conceptual Trigger to update 
media.last_linked_or_used_at -- This function would be global, and each media 
linking table (like trail_media) -- would call it. -- CREATE OR REPLACE 
FUNCTION public.update_media_last_linked_timestamp_on_link() -- RETURNS TRIGGER 
AS $$ -- BEGIN -- UPDATE public.media -- SET last_linked_or_used_at = NOW() -- 
WHERE id = NEW.media_id; -- RETURN NEW; -- END; -- $$ LANGUAGE plpgsql SECURITY 
DEFINER; -- CREATE TRIGGER trigger_trail_media_update_media_timestamp -- AFTER 
INSERT OR UPDATE OF media_id ON public.trail_media -- FOR EACH ROW -- EXECUTE 
FUNCTION public.update_media_last_linked_timestamp_on_link(); -- COMMENT ON 
TRIGGER trigger_trail_media_update_media_timestamp ON public.trail_media -- IS 
'Updates media.last_linked_or_used_at when a media item is linked or its link 
is updated in trail_media.'; -- (A similar trigger might be needed on DELETE to 
check if media should be "unlinked", though this is complex if media is shared) 
``` ### 4\. JSON Schema Mirror JSON ``` { "title": "trail_media_link", 
"description": "Links trails to media items (galleries, hero images, static 
maps), defining display order, role, and translatable caption/alt-text 
overrides. V1.0", "type": "object", "properties": { "id": { "type": "integer", 
"format": "int64", "description": "Surrogate unique identifier for the 
trail-media link.", "readOnly": true }, "trail_id": { "type": "integer", 
"format": "int64", "description": "Foreign key to the public.trails table." }, 
"media_id": { "type": "string", "format": "uuid", "description": "Foreign key 
to the public.media table." }, "media_role_code": { "type": "string", 
"description": "Semantic role of the media in relation to the trail. FK to 
public.media_roles_master.code." }, "display_order": { "type": "integer", 
"format": "int16", "default": 0, "description": "Order for displaying media 
items within a specific role for this trail." }, "caption_override": { "type": 
["string", "null"], "description": "Optional override for the media's default 
caption, specific to this trail link. Primary reference language (English). 
(Translatable via public.translations using trail_media.id)." }, 
"alt_text_override": { "type": ["string", "null"], "description": "Optional 
override for the media's default alt text, specific to this trail link. Primary 
reference language (English). (Translatable via public.translations using 
trail_media.id)." }, "created_at": { "type": "string", "format": "date-time", 
"description": "Timestamp of when this link record was created.", "readOnly": 
true }, "created_by_profile_id": { "type": ["string", "null"], "format": 
"uuid", "description": "Profile ID of the user who created this link." }, 
"updated_at": { "type": "string", "format": "date-time", "description": 
"Timestamp of when this link record was last updated.", "readOnly": true }, 
"updated_by_profile_id": { "type": ["string", "null"], "format": "uuid", 
"description": "Profile ID of the user who last updated this link." } }, 
"required": [ "trail_id", "media_id", "media_role_code", "display_order", 
"created_at", "updated_at" ], "primary_key": ["id"], "unique_constraints": [ 
{"columns": ["trail_id", "media_id", "media_role_code"], "name": 
"uq_trail_media_link"}, {"columns": ["trail_id", "display_order", 
"media_role_code"], "name": "uq_trail_media_role_order"} ], "foreign_keys": [ 
{"columns": ["trail_id"], "references_table": "public.trails", 
"references_columns": ["id"], "on_delete": "CASCADE"}, {"columns": 
["media_id"], "references_table": "public.media", "references_columns": ["id"], 
"on_delete": "RESTRICT"}, {"columns": ["media_role_code"], "references_table": 
"public.media_roles_master", "references_columns": ["code"], "on_delete": 
"RESTRICT", "on_update": "CASCADE"}, {"columns": ["created_by_profile_id"], 
"references_table": "public.profiles", "references_columns": ["id"], 
"on_delete": "SET NULL"}, {"columns": ["updated_by_profile_id"], 
"references_table": "public.profiles", "references_columns": ["id"], 
"on_delete": "SET NULL"} ] } ``` ### 5\. Relationships & Integrity - Primary 
Key: `id BIGINT` (surrogate key). - Foreign Keys: - `trail_id` references 
`public.trails(id)` `ON DELETE CASCADE`. If a trail is deleted, its media links 
are removed. - `media_id` references `public.media(id)` `ON DELETE RESTRICT`. 
Prevents deletion of media if it's actively linked to a trail. - 
`media_role_code` references `public.media_roles_master(code)` `ON DELETE 
RESTRICT ON UPDATE CASCADE`. Ensures role integrity. - Audit FKs 
(`created_by_profile_id`, `updated_by_profile_id`) reference 
`public.profiles(id)` `ON DELETE SET NULL`. - Unique Constraints: - `UNIQUE 
(trail_id, media_id, media_role_code)`: Prevents the same media item from being 
linked to the same trail with the exact same role multiple times. - `UNIQUE 
(trail_id, display_order, media_role_code)`: Ensures `display_order` is unique 
within a specific role for a given trail (e.g., for gallery image sequencing). 
### 6\. Multilingual Strategy - Translatable Fields: `caption_override`, 
`alt_text_override`. - Mechanism: These fields store their primary reference 
language (English) text directly. Translations into other languages are managed 
in the central `public.translations` table, linked by `table_identifier = 
'trail_media'`, `column_identifier` (e.g., 'caption_override'), and 
`row_foreign_key = trail_media.id::TEXT`. - Fallback: If an override is `NULL`, 
the application should fall back to `public.media.default_caption` or 
`public.media.default_alt_text` respectively. - Orphan Cleanup: The 
`trigger_cleanup_trail_media_translations_after_delete` trigger ensures that 
when a `trail_media` record is deleted, its specific translations for overrides 
are removed from `public.translations`. ### 7\. Role-Based Workflow & RLS Notes 
- Content Management: Admins (`admin_platform`) and Regional Content Managers 
(`regional_content_manager`) will typically manage these media links. - RLS 
Policy Sketch: - Public Read Access: `SELECT` allowed if the parent 
`public.trails` record is published and not deleted. SQL ``` CREATE POLICY 
"Allow public read access to trail_media" ON public.trail_media FOR SELECT 
USING ( EXISTS ( SELECT 1 FROM public.trails t WHERE t.id = 
trail_media.trail_id AND t.content_visibility_status = 
'published'::public.content_visibility_status_enum -- Assuming ENUM value AND 
t.deleted_at IS NULL ) ); ``` - Content Manager Write Access: `INSERT`, 
`UPDATE`, `DELETE` allowed for roles like `admin_platform` or 
`regional_content_manager` if they have rights to manage the parent `trail_id`. 
This often involves a helper function. SQL ``` CREATE POLICY "Allow content 
managers to manage trail_media" ON public.trail_media FOR ALL USING ( (SELECT 
public.has_role('admin_platform')) OR -- Using platform standard helper (SELECT 
public.has_role('regional_content_manager') AND 
public.user_manages_trail(trail_media.trail_id)) -- Example helper ) WITH CHECK 
( (SELECT public.has_role('admin_platform')) OR (SELECT 
public.has_role('regional_content_manager') AND 
public.user_manages_trail(trail_media.trail_id)) ); ``` - (The 
`public.user_manages_trail(BIGINT)` helper function would need to be defined, 
checking regional assignments or other criteria). ### 8\. ENUM vs. Lookup 
Discussion - N/A for this table directly, as `media_role_code` correctly 
references the `public.media_roles_master` lookup table. ### 9\. UI/UX 
Enablement - Drives trail galleries (`gallery_image` role) with ordering via 
`display_order`. - Provides the main hero image (`featured_image` role) for 
trail pages. - Allows for specific map graphics (`map_image_static` role). - 
Contextual captions and alt text enhance accessibility and information. ### 
10\. Key Considerations & Definitions - Role Cardinality: - A trail should 
likely have only one `featured_image`. This would be an application-level or 
admin UI guideline, or potentially a more complex database constraint (e.g., 
filtered unique index on `(trail_id, media_role_code) WHERE media_role_code = 
'featured_image'`). For V1, UI guidance is often sufficient. - Multiple 
`gallery_image` and `map_image_static` entries per trail are expected. - 
`display_order` Management: Admins/managers should be able to set and reorder. 
For new gallery images, the application could default to `MAX(display_order) + 
1` for that trail and role. - `media_id` ON DELETE RESTRICT: This is important. 
If a media item is deleted from `public.media`, but it's still linked here, the 
delete should be prevented to maintain integrity. An admin would need to unlink 
it from `trail_media` first. ### 11\. Scalability & Future-Proofing - Standard 
linking table structure; scales with the number of trails and media items. - 
Use of `media_roles_master` allows for adding new types of media associations 
for trails in the future without schema changes to `trail_media` itself (just 
new role codes). ### 12\. Seed Data - N/A. This is a transactional linking 
table; data is created as media is associated with trails. ### 13\. Next-Action 
Checklist 1. ðŸ”´ Verify Dependencies: Ensure `public.trails`, `public.media`, 
`public.media_roles_master`, `public.profiles`, and `public.translations` 
tables are created and V2 compliant. 2. ðŸ”´ Define `media_roles_master` Entries: 
Confirm/add necessary `code` values to `public.media_roles_master` (e.g., 
`featured_image`, `gallery_image`, `map_image_static`). 3. ðŸ”´ Implement DDL: 
Execute the `CREATE TABLE public.trail_media` DDL, including all constraints, 
indexes, and comments. 4. ðŸ”´ Implement Triggers: - Apply the `updated_at` 
trigger. - Create and apply the 
`trigger_cleanup_trail_media_translations_after_delete`. - *(Optional but 
Recommended)* Implement logic/triggers for `media.last_linked_or_used_at` 
updates via a global function called by this table's trigger. 5. ðŸŸ  RLS 
Policies & Helper Functions: Define and implement RLS policies. This includes 
creating and testing any necessary helper functions like 
`public.user_manages_trail(BIGINT)`. 6. ðŸŸ¢ Application Logic: - Develop 
UI/backend logic for managing `display_order`. - Implement fallback logic for 
`caption_override`/`alt_text_override` to use 
`media.default_caption`/`alt_text`. - Consider application-level enforcement 
for role cardinalities if not done in DB (e.g., one `featured_image`). 7. ðŸŸ¢ 
Data Migration: If there's existing implicit trail media data, plan migration. 
* * * * * 
