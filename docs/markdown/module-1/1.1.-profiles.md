# 1.1. profiles

  
https://gemini.google.com/u/1/app/ea09d2cc0b5505fe?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/fd47ede3d905a3f2 
https://gemini.google.com/u/1/app/440838222ac514d7 Production-Ready 
Specification: public.profiles Table Version: 2.3 (Checklist V2-05-17-B 
Applied, Role Sync & Last Activity Added) Date: May 18, 2025 1. Purpose & 
Primary Use-Cases Mission Statement: To store application-specific user data, 
extending Supabase's built-in `auth.users` table via a one-to-one relationship. 
This table manages user identity for display, assigns roles for permissions 
(which are then synchronized to `auth.users.raw_app_meta_data.roles` for JWT 
inclusion), stores preferences for personalization, contributor information, 
tracks account status, last user activity, and audit trails for administrative 
updates. Key User-Story Touchpoints: â€¢ Pilgrim (Anna): Underpins identity, 
preferences (A6: language via `preferred_language_code`, A2/A3: units via 
`preferred_units_of_measure`), personalization (experience level, interests), 
and links to her contributions (A8: votes, tips - though these are in separate 
linking tables). Roles assigned here are available in her JWT. Her 
`last_activity_at` timestamp helps the platform provide relevant recent content 
or notifications. â€¢ Host (Marco): Defines his role (via `roles` array, 
synchronized to JWT), stores listing-related contact details 
(`contact_public_email`, `contributor_organization_name`), and manages his 
account status (`account_status`) for platform access (Story B1). â€¢ Regional 
Manager (Sofia): Defines her role (via `roles` array, synchronized to JWT) and 
identity for content management tasks (Stories C1, C2). â€¢ Platform 
Administrator: Central table for user management (Story D1), role assignment 
(via `roles` array, synchronized to JWT), status monitoring (`account_status`), 
and observing user activity trends via `last_activity_at`. 2. Schema | column | 
data_type | constraints | description | | :------------------------------ | 
:------------------------ | 
:-------------------------------------------------------------------------------
--------------------------------------------------------- | 
:-------------------------------------------------------------------------------
--------------------------------------------------------------------------------
------------------------------------ | | id | uuid | Primary Key, References 
`auth.users(id)` ON DELETE CASCADE | User's ID from `auth.users` table. Forms 
the 1:1 link. Profile deleted if auth user is deleted. | | roles | text[] | Not 
Null | Array of role codes (e.g., `{"pilgrim_user", "accommodation_host"}`). 
Values validated by `check_profile_roles` trigger. Synchronized to 
`auth.users.raw_app_meta_data.roles`. | | username | text | Nullable, Unique 
(`uq_profiles_username`) | Optional unique username for community features. 
Unique if provided. | | full_name | text | Nullable | User's full name for 
internal or formal use. | | public_display_name | text | Nullable, Unique 
(`uq_profiles_public_display_name`) | Name shown publicly (e.g., on tips). 
User-set or derived. Unique if provided. | | public_avatar_media_id | uuid | 
Nullable, References `media(id)` ON DELETE SET NULL | ðŸŸ  ID of the media item 
(from `media` table) to be used as the public avatar. Allows leveraging the 
central media system. | | public_bio | text | Nullable | Short public biography 
(e.g., max 500 characters, enforced by application). User-generated content. | 
| preferred_language_code | text | Not Null, Default 'en', References 
`languages_master(language_code)` ON UPDATE CASCADE ON DELETE RESTRICT, CHECK 
(`preferred_language_code` ~ '^[a-z]{2}(-[A-Z]{2})?$') | ðŸŸ  User's preferred 
language (ISO 639-1 or IETF tag, e.g., 'en', 'it', 'en-US'). FK to 
`languages_master`. Pattern allows for regional codes. Default 'en'. | | 
preferred_units_of_measure | units_preference_enum | Not Null, Default 'metric' 
| User's preference for distances/elevations ('metric', 'imperial'). | | 
preferred_timezone | text | Nullable, Default 'Europe/Rome' | User's preferred 
IANA timezone string (e.g., 'America/New_York'). | | pilgrim_experience_level | 
pilgrim_experience_enum | Nullable | For 'pilgrim_user' role, self-assessed 
experience level. | | pilgrimage_interests_tags | text[] | Nullable | For 
pilgrim users, array of interest tags (e.g., `{"spirituality", "history"}`). | 
| contributor_organization_name | text | Nullable | Organization name if user 
contributes on its behalf. | | contributor_organization_role | text | Nullable 
| User's role within that organization. | | contact_public_email | text | 
Nullable, CHECK (`contact_public_email` IS NULL OR `contact_public_email` ~* 
'^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$') | ðŸŸ  Publicly visible email 
address, if provided and distinct from login. Validated format. | | 
website_url_profile | text | Nullable, CHECK (`website_url_profile` IS NULL OR 
`website_url_profile` ~* '^https?://.+') | ðŸŸ  Personal or organizational 
website URL. Validated format. | | notification_preferences_json | jsonb | 
Nullable | User preferences for platform notifications (e.g., 
`{"new_trail_warnings": true}`). Structure defined by application. | | 
is_profile_publicly_visible | boolean | Not Null, Default false | Master switch 
for public visibility of `public_*` profile fields. | | contribution_score | 
integer | Not Null, Default 0, CHECK (`contribution_score` >= 0) | Score based 
on positive contributions. | | account_status | user_account_status_enum | Not 
Null, Default 'active' | Current status of the user's application account. 
Initial status may be set by `handle_new_user` trigger. | | terms_accepted_at | 
timestamp with time zone | Nullable | Timestamp of last terms and conditions 
acceptance. | | last_login_at | timestamp with time zone | Nullable | Timestamp 
of user's last login (updated by application). | | last_activity_at | timestamp 
with time zone | Nullable | Timestamp of the last recorded user activity (e.g., 
interaction, content submission). Mechanism for updates (API, triggers) to be 
defined. | | created_at | timestamp with time zone | Not Null, Default `now()` 
| Timestamp of profile record creation (`created_by` is implicitly 
`profiles.id`). | | updated_at | timestamp with time zone | Not Null, Default 
`now()` | Timestamp of last profile update (auto-updated by general row update 
trigger). | | updated_by_profile_id | uuid | Nullable, References 
`public.profiles(id)` ON DELETE SET NULL | Profile ID of another user 
(typically an admin) who last made significant updates to this profile record. 
ON DELETE SET NULL. | 3. PostgreSQL DDL -- ENUM Types (ensure these are created 
globally first as per module build order) DO $$ BEGIN IF NOT EXISTS (SELECT 1 
FROM pg_type WHERE typname = 'units_preference_enum') THEN CREATE TYPE 
public.units_preference_enum AS ENUM ('metric', 'imperial'); END IF; IF NOT 
EXISTS (SELECT 1 FROM pg_type WHERE typname = 'pilgrim_experience_enum') THEN 
CREATE TYPE public.pilgrim_experience_enum AS ENUM ('novice_first_pilgrimage', 
'intermediate_few_pilgrimages', 'experienced_many_pilgrimages', 
'long_distance_veteran'); END IF; IF NOT EXISTS (SELECT 1 FROM pg_type WHERE 
typname = 'user_account_status_enum') THEN CREATE TYPE 
public.user_account_status_enum AS ENUM ('active', 'pending_verification', 
'email_unconfirmed', 'suspended_by_admin', 'deactivated_by_user'); END IF; 
END$$; -- Table Definition CREATE TABLE public.profiles ( id uuid NOT NULL 
PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE, roles text[] NOT NULL, 
username text NULL UNIQUE, full_name text NULL, public_display_name text NULL 
UNIQUE, public_avatar_media_id uuid NULL REFERENCES public.media(id) ON DELETE 
SET NULL, public_bio text NULL, preferred_language_code text NOT NULL DEFAULT 
'en' REFERENCES public.languages_master(language_code) ON UPDATE CASCADE ON 
DELETE RESTRICT, preferred_units_of_measure public.units_preference_enum NOT 
NULL DEFAULT 'metric', preferred_timezone text NULL DEFAULT 'Europe/Rome', 
pilgrim_experience_level public.pilgrim_experience_enum NULL, 
pilgrimage_interests_tags text[] NULL, contributor_organization_name text NULL, 
contributor_organization_role text NULL, contact_public_email text NULL, 
website_url_profile text NULL, notification_preferences_json jsonb NULL, 
is_profile_publicly_visible boolean NOT NULL DEFAULT false, contribution_score 
integer NOT NULL DEFAULT 0, account_status public.user_account_status_enum NOT 
NULL DEFAULT 'active', terms_accepted_at timestamp with time zone NULL, 
last_login_at timestamp with time zone NULL, last_activity_at timestamp with 
time zone NULL, -- New column created_at timestamp with time zone NOT NULL 
DEFAULT now(), updated_at timestamp with time zone NOT NULL DEFAULT now(), 
updated_by_profile_id uuid NULL REFERENCES public.profiles(id) ON DELETE SET 
NULL, CONSTRAINT check_preferred_language_code_format CHECK 
(preferred_language_code ~ '^[a-z]{2}(-[A-Z]{2})?$'), CONSTRAINT 
check_contact_public_email_format CHECK (contact_public_email IS NULL OR 
contact_public_email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'), 
CONSTRAINT check_website_url_profile_format CHECK (website_url_profile IS NULL 
OR website_url_profile ~* '^https?://.+'), CONSTRAINT 
check_contribution_score_non_negative CHECK (contribution_score >= 0) ); -- 
Indexes CREATE INDEX idx_profiles_roles ON public.profiles USING GIN (roles); 
CREATE INDEX idx_profiles_pilgrimage_interests_tags ON public.profiles USING 
GIN (pilgrimage_interests_tags); CREATE INDEX idx_profiles_account_status ON 
public.profiles (account_status); CREATE INDEX 
idx_profiles_updated_by_profile_id ON public.profiles (updated_by_profile_id) 
WHERE updated_by_profile_id IS NOT NULL; CREATE INDEX 
idx_profiles_last_activity_at ON public.profiles (last_activity_at DESC NULLS 
LAST) WHERE last_activity_at IS NOT NULL; -- Index for new column -- Comments 
COMMENT ON TABLE public.profiles IS 'Stores application-specific user data, 
extending Supabase Auth users. Manages identity, roles (synchronized to 
auth.users), preferences, contributor context, account status, activity 
timestamps, and admin update audit. Version 2.3.'; COMMENT ON COLUMN 
public.profiles.id IS 'User''s ID from auth.users table (PK, FK). Profile 
deleted if auth user is deleted. Implicitly `created_by`.'; COMMENT ON COLUMN 
public.profiles.roles IS 'Array of role codes (e.g., {"pilgrim_user"}). 
Validated by `check_profile_roles` trigger. Synchronized to 
`auth.users.raw_app_meta_data.roles`.'; COMMENT ON COLUMN 
public.profiles.last_activity_at IS 'Timestamp of the last recorded significant 
user activity (e.g., interaction, content submission). Mechanism for updates 
(API calls, specific DB triggers) to be defined.'; COMMENT ON COLUMN 
public.profiles.updated_by_profile_id IS 'Profile ID of another user (typically 
an admin) who last made significant updates to this profile record. ON DELETE 
SET NULL.'; 4. Triggers/Functions -- Trigger for general updated_at timestamp 
CREATE TRIGGER handle_profiles_updated_at BEFORE UPDATE ON public.profiles FOR 
EACH ROW EXECUTE FUNCTION extensions.moddatetime('updated_at'); -- Trigger 
function for checking roles array integrity CREATE OR REPLACE FUNCTION 
public.check_profile_roles() RETURNS TRIGGER AS $$ DECLARE role_code_val TEXT; 
invalid_roles TEXT[]; active_role_exists BOOLEAN; BEGIN IF TG_OP = 'INSERT' OR 
NEW.roles IS DISTINCT FROM OLD.roles THEN IF NEW.roles IS NULL OR 
array_length(NEW.roles, 1) IS NULL OR array_length(NEW.roles, 1) = 0 THEN RAISE 
EXCEPTION 'profiles.roles cannot be empty or NULL.'; END IF; FOREACH 
role_code_val IN ARRAY NEW.roles LOOP SELECT EXISTS (SELECT 1 FROM 
public.user_roles_master urm WHERE urm.role_code = role_code_val AND 
urm.is_role_active = TRUE AND urm.deleted_at IS NULL) INTO active_role_exists; 
IF NOT active_role_exists THEN invalid_roles := array_append(invalid_roles, 
role_code_val); END IF; END LOOP; IF array_length(invalid_roles, 1) > 0 THEN 
RAISE EXCEPTION 'Invalid, inactive, or deleted role(s) in profiles.roles: %', 
array_to_string(invalid_roles, ', '); END IF; END IF; RETURN NEW; END; $$ 
LANGUAGE plpgsql SECURITY DEFINER; COMMENT ON FUNCTION 
public.check_profile_roles() IS 'Ensures that roles assigned in 
public.profiles.roles exist, are active, and not soft-deleted in 
public.user_roles_master. Runs as SECURITY DEFINER.'; -- Apply the roles check 
trigger CREATE TRIGGER trigger_check_profile_roles_on_insert_or_update BEFORE 
INSERT OR UPDATE OF roles ON public.profiles FOR EACH ROW EXECUTE FUNCTION 
public.check_profile_roles(); COMMENT ON TRIGGER 
trigger_check_profile_roles_on_insert_or_update ON public.profiles IS 
'Validates roles against user_roles_master before profile insert or roles 
update.'; -- Trigger function to synchronize profiles.roles to 
auth.users.raw_app_meta_data.roles CREATE OR REPLACE FUNCTION 
public.sync_profile_roles_to_auth_user() RETURNS TRIGGER AS $$ BEGIN UPDATE 
auth.users SET raw_app_meta_data = COALESCE(raw_app_meta_data, '{}'::jsonb) || 
jsonb_build_object('roles', NEW.roles) WHERE id = NEW.id; RETURN NEW; END; $$ 
LANGUAGE plpgsql SECURITY DEFINER; COMMENT ON FUNCTION 
public.sync_profile_roles_to_auth_user() IS 'Synchronizes the roles from 
public.profiles to auth.users.raw_app_meta_data.roles for JWT inclusion. Runs 
as SECURITY DEFINER. Ensure appropriate search_path if function becomes 
complex.'; -- Apply the roles synchronization trigger CREATE TRIGGER 
trigger_sync_roles_to_auth_user_on_profile_change AFTER INSERT OR UPDATE OF 
roles ON public.profiles FOR EACH ROW EXECUTE FUNCTION 
public.sync_profile_roles_to_auth_user(); COMMENT ON TRIGGER 
trigger_sync_roles_to_auth_user_on_profile_change ON public.profiles IS 'When 
roles in public.profiles are inserted or updated, synchronizes them to 
auth.users.raw_app_meta_data.roles.'; -- Trigger function for auto-creating 
profile on new auth.users entry & setting initial roles in auth.users CREATE OR 
REPLACE FUNCTION public.handle_new_user() RETURNS TRIGGER AS $$ DECLARE 
default_role_code TEXT; initial_account_status public.user_account_status_enum 
:= 'active'; new_user_email TEXT; initial_profile_roles TEXT[]; BEGIN 
new_user_email := NEW.email; IF NEW.email_confirmed_at IS NULL AND 
NEW.phone_confirmed_at IS NULL THEN initial_account_status := 
'email_unconfirmed'; END IF; SELECT role_code INTO default_role_code FROM 
public.user_roles_master WHERE default_for_new_pilgrim_users = TRUE AND 
is_role_active = TRUE AND deleted_at IS NULL LIMIT 1; IF default_role_code IS 
NULL THEN RAISE WARNING 'No default role found in user_roles_master. Falling 
back to ''pilgrim_user''. Configure a default role.'; default_role_code := 
'pilgrim_user'; END IF; initial_profile_roles := 
ARRAY[default_role_code]::text[]; -- Insert into public.profiles INSERT INTO 
public.profiles (id, roles, preferred_language_code, account_status, username, 
public_display_name, created_at, updated_at, last_activity_at) -- Added 
last_activity_at VALUES ( NEW.id, initial_profile_roles, 'en', -- Platform 
default language initial_account_status, 
COALESCE(NEW.raw_user_meta_data->>'username', split_part(new_user_email, '@', 
1) || '_' || substr(NEW.id::text, 1, 4)), 
COALESCE(NEW.raw_user_meta_data->>'full_name', NEW.raw_user_meta_data->>'name', 
split_part(new_user_email, '@', 1)), now(), -- created_at now(), -- updated_at 
now() -- last_activity_at set to now on creation ) ON CONFLICT (id) DO NOTHING; 
-- Update auth.users with the initial roles for JWT inclusion UPDATE auth.users 
SET raw_app_meta_data = COALESCE(raw_app_meta_data, '{}'::jsonb) || 
jsonb_build_object('roles', initial_profile_roles) WHERE id = NEW.id; RETURN 
NEW; END; $$ LANGUAGE plpgsql SECURITY DEFINER; COMMENT ON FUNCTION 
public.handle_new_user() IS 'Trigger function to automatically create a user 
profile in public.profiles when a new user signs up in auth.users. It sets 
initial default roles in both public.profiles.roles and 
auth.users.raw_app_meta_data.roles, and initializes last_activity_at. Runs as 
SECURITY DEFINER.'; -- Apply the new user trigger to auth.users table CREATE 
TRIGGER on_auth_user_created AFTER INSERT ON auth.users FOR EACH ROW EXECUTE 
FUNCTION public.handle_new_user(); COMMENT ON TRIGGER on_auth_user_created ON 
auth.users IS 'After a new user is created in auth.users, this trigger creates 
their corresponding profile and sets initial roles and activity timestamp.'; -- 
Conditional: Trigger function to clean up related translations for profiles /* 
(Definition as in V2.1/V2.2 spec) */ 5. JSON Schema Mirror { "title": 
"profile", "description": "Stores application-specific user profile data, 
extending Supabase Auth users. Manages identity, roles (synchronized to 
auth.users for JWT), preferences, contributor context, account status, activity 
timestamps, and admin update audit. Version 2.3.", "type": "object", 
"properties": { "id": { "type": "string", "format": "uuid", "description": 
"User's ID from auth.users table (PK). Implicitly created_by."}, "roles": { 
"type": "array", "items": { "type": "string" }, "description": "Array of role 
codes. Validated by trigger. Synchronized to 
auth.users.raw_app_meta_data.roles. Cannot be empty.", "minItems": 1 }, 
"username": { "type": ["string", "null"], "description": "Optional unique 
username." }, "full_name": { "type": ["string", "null"], "description": "User's 
full name." }, "public_display_name": { "type": ["string", "null"], 
"description": "Publicly shown name. Unique if provided." }, 
"public_avatar_media_id": { "type": ["string", "null"], "format": "uuid", 
"description": "FK to media.id for public avatar." }, "public_bio": { "type": 
["string", "null"], "maxLength": 500, "description": "Short public biography 
(app-enforced max length)." }, "preferred_language_code": { "type": "string", 
"default": "en", "pattern": "^[a-z]{2}(-[A-Z]{2})?$", "description": "User's 
preferred language (IETF tag). FK to languages_master." }, 
"preferred_units_of_measure": { "$ref": "#/definitions/units_preference_enum", 
"default": "metric" }, "preferred_timezone": { "type": ["string", "null"], 
"default": "Europe/Rome", "description": "IANA timezone string." }, 
"pilgrim_experience_level": { "$ref": "#/definitions/pilgrim_experience_enum" 
}, "pilgrimage_interests_tags": { "type": ["array", "null"], "items": { "type": 
"string" }, "description": "Array of interest tags." }, 
"contributor_organization_name": { "type": ["string", "null"], "description": 
"Organization name if contributing for one." }, 
"contributor_organization_role": { "type": ["string", "null"], "description": 
"User's role in that organization." }, "contact_public_email": { "type": 
["string", "null"], "format": "email", "description": "Publicly visible email. 
Validated format." }, "website_url_profile": { "type": ["string", "null"], 
"format": "url", "description": "Personal/organizational website URL. Validated 
format." }, "notification_preferences_json": { "type": ["object", "null"], 
"description": "JSONB for notification preferences." }, 
"is_profile_publicly_visible": { "type": "boolean", "default": false, 
"description": "Master switch for public visibility of profile." }, 
"contribution_score": { "type": "integer", "default": 0, "minimum": 0, 
"description": "Score from positive contributions." }, "account_status": { 
"$ref": "#/definitions/user_account_status_enum", "default": "active" }, 
"terms_accepted_at": { "type": ["string", "null"], "format": "date-time", 
"description": "Timestamp of last terms acceptance." }, "last_login_at": { 
"type": ["string", "null"], "format": "date-time", "description": "Timestamp of 
user's last login (app-updated)." }, "last_activity_at": { "type": ["string", 
"null"], "format": "date-time", "description": "Timestamp of the last recorded 
user activity." }, "created_at": { "type": "string", "format": "date-time", 
"description": "Timestamp of profile creation.", "readOnly": true }, 
"updated_at": { "type": "string", "format": "date-time", "description": 
"Timestamp of last profile update.", "readOnly": true }, 
"updated_by_profile_id": { "type": ["string", "null"], "format": "uuid", 
"description": "Profile ID of user (typically admin) who last updated this 
profile." } }, "required": [ "id", "roles", "preferred_language_code", 
"preferred_units_of_measure", "is_profile_publicly_visible", 
"contribution_score", "account_status" ], "primary_key": ["id"], 
"unique_constraints": [ {"columns": ["username"], "name": 
"uq_profiles_username", "allow_null_results": true}, {"columns": 
["public_display_name"], "name": "uq_profiles_public_display_name", 
"allow_null_results": true} ], "foreign_keys": [ {"columns": ["id"], 
"references_table": "auth.users", "references_columns": ["id"], "on_delete": 
"CASCADE"}, {"columns": ["public_avatar_media_id"], "references_table": 
"public.media", "references_columns": ["id"], "on_delete": "SET NULL"}, 
{"columns": ["preferred_language_code"], "references_table": 
"public.languages_master", "references_columns": ["language_code"], 
"on_delete": "RESTRICT", "on_update": "CASCADE"}, {"columns": 
["updated_by_profile_id"], "references_table": "public.profiles", 
"references_columns": ["id"], "on_delete": "SET NULL"} ], "definitions": { 
"units_preference_enum": { "type": "string", "enum": ["metric", "imperial"] }, 
"pilgrim_experience_enum": { "type": ["string", "null"], "enum": [null, 
"novice_first_pilgrimage", "intermediate_few_pilgrimages", 
"experienced_many_pilgrimages", "long_distance_veteran"] }, 
"user_account_status_enum": { "type": "string", "enum": ["active", 
"pending_verification", "email_unconfirmed", "suspended_by_admin", 
"deactivated_by_user"] } } } 6. Relationships & Integrity Primary Key: `id` 
(uuid). Foreign Keys: To `auth.users`, `media`, `languages_master`, and 
self-referencing `updated_by_profile_id`. Array Foreign Key: `roles` (text[]) 
integrity with `user_roles_master` maintained by `check_profile_roles()` 
trigger. Synchronization: `roles` are synchronized to 
`auth.users.raw_app_meta_data.roles` via `handle_new_user()` and 
`sync_profile_roles_to_auth_user()` triggers for JWT inclusion. Mermaid ER 
Snippet: erDiagram auth_users ||--o{ profiles : "has one" profiles }o--|| media 
: "avatar (optional)" profiles }o--|| languages_master : "prefers lang" 
profiles ..> user_roles_master : "roles from" profiles }o--o| profiles : 
"updated_by (admin)" auth_users { uuid id PK } media { uuid id PK } 
languages_master { text language_code PK } user_roles_master { text role_code 
PK } profiles { uuid id PK text[] roles uuid public_avatar_media_id FK text 
preferred_language_code FK uuid updated_by_profile_id FK 
user_account_status_enum account_status timestamptz last_activity_at } 7. 
Multilingual Strategy Translatable Fields: For V1, `public_bio` is 
user-generated content stored in the language of submission. If it (or other 
fields like `full_name` if used publicly) were to become centrally managed and 
translated, they would use `public.translations` with `table_identifier: 
'profiles'`, `column_identifier: 'public_bio'`, and `row_foreign_key: 
[profiles.id]`. An orphan-cleanup trigger on `profiles` would then be needed. 
Driving Field: `preferred_language_code` signals the application for UI and 
content language. 8. Role-Based Workflow & RLS Notes Key Fields for 
Roles/Workflows: â€¢ `roles` (text[]): Core field determining user capabilities 
and access. Integrity enforced by `check_profile_roles()` trigger. Initial 
role(s) set by `handle_new_user()` trigger and synchronized to 
`auth.users.raw_app_meta_data.roles`. â€¢ `account_status` 
(user_account_status_enum): Manages user lifecycle. â€¢ `last_activity_at`: 
Provides data for user engagement tracking. Recommended Row-Level-Security 
(RLS) Policies: â€¢ ðŸŸ¢ Policy 1: Users can read their own profile. ```sql CREATE 
POLICY "select_own_profile" ON public.profiles FOR SELECT USING (auth.uid() = 
id); ``` â€¢ ðŸŸ¢ Policy 2: Users can update their own profile. ```sql CREATE 
POLICY "update_own_profile" ON public.profiles FOR UPDATE USING (auth.uid() = 
id) WITH CHECK (auth.uid() = id); ``` â€¢ ðŸŸ  Policy 3: Allow public read of 
specific profile aspects via a `public_profiles_view` (recommended) where 
`is_profile_publicly_visible = true` and `account_status = 
'active'::public.user_account_status_enum`. â€¢ ðŸŸ¢ Policy 4: Admins can manage 
all profiles (requires `public.has_role_on_profile(UUID, TEXT)` helper). ```sql 
CREATE POLICY "admin_manage_all_profiles" ON public.profiles FOR ALL USING 
(public.has_role_on_profile(auth.uid(), 'admin_platform') OR 
public.has_role_on_profile(auth.uid(), 'admin_super')) WITH CHECK 
(public.has_role_on_profile(auth.uid(), 'admin_platform') OR 
public.has_role_on_profile(auth.uid(), 'admin_super')); ``` RLS may also 
leverage roles present in the JWT (from `auth.users.raw_app_meta_data.roles`) 
for broader checks. 9. ENUM vs Lookup Discussion ðŸŸ¢ `units_preference_enum`, 
`pilgrim_experience_enum`, `user_account_status_enum` remain ENUMs for V1. 10. 
UI/UX Enablement Columns powering UI: `preferred_language_code`, 
`public_display_name`, `public_avatar_media_id`, `public_bio`, `roles`, 
`last_activity_at`, etc. Indexed Fields for UX Performance: GIN indexes on 
`roles`, `pilgrimage_interests_tags`. B-tree index on `account_status`, 
`last_activity_at`. 11. Auditing & Lifecycle Management Audit Columns: 
`created_at`, `updated_at`. `id` is implicit `created_by`. 
`updated_by_profile_id` tracks non-owner (admin) updates. `roles` changes are 
reflected in `auth.users.raw_app_meta_data.roles`. Lifecycle: `account_status` 
enum. `last_activity_at` provides activity data. Hard delete cascades from 
`auth.users`. 12. Scalability & Future-Proofing `roles` Array: Text array with 
GIN index is adequate. Partitioning: Not foreseen as needed. 13. Seed Data âšª 
N/A - Profile records are created dynamically upon user registration. 14. 
Next-Action Checklist â€¢ ðŸ”´ Implement ENUM Types. â€¢ ðŸ”´ Create Table: Execute DDL 
for `public.profiles` (including `last_activity_at`). â€¢ ðŸ”´ Create Indexes 
(including for `last_activity_at`). â€¢ ðŸ”´ Implement `updated_at` Trigger. â€¢ ðŸ”´ 
Implement Profile Creation & Role Sync Logic: * Update and apply 
`public.handle_new_user()` trigger on `auth.users` (to set `last_activity_at` 
and sync roles). * Create and apply `public.sync_profile_roles_to_auth_user()` 
function and its trigger on `public.profiles`. â€¢ ðŸ”´ Implement `roles` Integrity 
Check: Create and apply `public.check_profile_roles()` trigger. â€¢ ðŸŸ  Test role 
synchronization mechanism thoroughly. â€¢ ðŸŸ  Define `updated_by_profile_id` 
Population Logic for admin actions. â€¢ ðŸŸ  Define and implement update mechanism 
for `last_activity_at` (e.g., via API calls on significant user actions or 
specific DB triggers on related tables). â€¢ ðŸŸ¢ Consider Full-Text Search on 
profile text fields for V2+. â€¢ ðŸŸ¢ Conditional Translations Cleanup Trigger for 
`public_bio` if it becomes system-translatable. 
