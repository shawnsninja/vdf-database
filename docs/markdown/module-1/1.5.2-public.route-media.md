# 1.5.2 public.route_media

  https://gemini.google.com/u/1/app/431cc17871bb821b Markdown ``` # Table 
Specification - `public.route_media` (V1 Draft) Date: May 18, 2025 ### 1. 
Purpose & Primary Use-Cases This table links records from `public.routes` to 
specific media items in `public.media`, assigning a semantic role to each link. 
While `public.routes` has direct foreign keys for a primary GPX track 
(`overall_gpx_media_id`), a primary map overview image 
(`map_overview_media_id`), and a primary banner image (`banner_media_id`)[cite: 
2334, 2335, 2336], this `public.route_media` table is intended for 
**additional** media. Its primary purpose is to support image galleries 
specific to a route, showcasing its character, key sections, or points of 
interest not covered by segment-level media. It could also potentially link to 
other types of illustrative media if defined by appropriate roles. **Key 
User-Story Touchpoints:** * **Pilgrim (Anna)**: Browse a gallery of images for 
a selected route to get a better visual understanding of its scenery, terrain, 
and highlights before deciding or while planning. * **Regional Content Manager 
(Sofia) / Platform Administrator**: Uploading, selecting, and curating images 
for route-specific galleries. Managing captions, alt text, and display order 
for these media items. * **System/Developer**: Retrieving all media with a 
`gallery_image` role for a specific route to display in a carousel or gallery 
view on the route's detail page. ### 2. Schema | Column Name | Data Type | 
Constraints | Description (Translatable fields marked) | | 
:---------------------- | :------------ | 
:-------------------------------------------------------------------------------
--------------------------------- | 
:-------------------------------------------------------------------------------
--------------------------------------------------------------------------------
------ | | `id` | `BIGINT` | `PRIMARY KEY, GENERATED ALWAYS AS IDENTITY` | 
Unique identifier for this route-media link. | | `route_id` | `BIGINT` | `NOT 
NULL, REFERENCES public.routes(id) ON DELETE CASCADE` | The ID of the route 
this media is associated with[cite: 2302]. | | `media_id` | `UUID` | `NOT NULL, 
REFERENCES public.media(id) ON DELETE RESTRICT` | The ID of the media item from 
`public.media`. `ON DELETE RESTRICT` to prevent deleting media still in use. | 
| `media_role_code` | `TEXT` | `NOT NULL, REFERENCES 
public.media_roles_master(code) ON DELETE RESTRICT ON UPDATE CASCADE` | 
Semantic role of the media for this route (e.g., 'gallery_image'). From 
`public.media_roles_master`. | | `display_order` | `SMALLINT` | `NOT NULL, 
DEFAULT 0` | Order for displaying media items within a specific role for this 
route (e.g., sequence in a gallery). Admins can reorder. | | `caption_override` 
| `TEXT` | `NULL` | Optional override for the media's default caption, specific 
to its use with this route. Primary reference language (English). (Translatable 
via `public.translations`) | | `alt_text_override` | `TEXT` | `NULL` | Optional 
override for the media's default alt text, specific to its use with this route, 
for accessibility. Primary reference language (English). (Translatable via 
`public.translations`) | | `created_at` | `TIMESTAMPTZ` | `NOT NULL, DEFAULT 
now()` | Timestamp of when this link record was created. | | 
`created_by_profile_id` | `UUID` | `NULL, REFERENCES public.profiles(id) ON 
DELETE SET NULL` | Profile ID of the user who created this link. | | 
`updated_at` | `TIMESTAMPTZ` | `NOT NULL, DEFAULT now()` | Timestamp of when 
this link record was last updated (auto-updated by trigger). | | 
`updated_by_profile_id` | `UUID` | `NULL, REFERENCES public.profiles(id) ON 
DELETE SET NULL` | Profile ID of the user who last updated this link. | | | | 
`UNIQUE (route_id, media_id, media_role_code)` | Prevents linking the same 
media item with the same role to the same route multiple times. | | | | `UNIQUE 
(route_id, display_order, media_role_code)` | Ensures display order is unique 
within a specific role for a given route. | ### 3. PostgreSQL DDL ```sql -- 
Assumes the following tables exist: -- public.routes (id BIGINT PK) [cite: 
2302] -- public.media (id UUID PK) [cite: 857] -- public.media_roles_master 
(code TEXT PK) -- public.profiles (id UUID PK) -- public.translations (for 
translatable fields) -- Assumes standard functions like 
public.set_current_timestamp_updated_at() or extensions.moddatetime exist. -- 
Assumes public.cleanup_related_translations(TEXT, TEXT) function exists. CREATE 
TABLE public.route_media ( id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY, 
route_id BIGINT NOT NULL REFERENCES public.routes(id) ON DELETE CASCADE, 
media_id UUID NOT NULL REFERENCES public.media(id) ON DELETE RESTRICT, 
media_role_code TEXT NOT NULL REFERENCES public.media_roles_master(code) ON 
DELETE RESTRICT ON UPDATE CASCADE, display_order SMALLINT NOT NULL DEFAULT 0, 
caption_override TEXT NULL, alt_text_override TEXT NULL, created_at TIMESTAMPTZ 
NOT NULL DEFAULT now(), created_by_profile_id UUID NULL REFERENCES 
public.profiles(id) ON DELETE SET NULL, updated_at TIMESTAMPTZ NOT NULL DEFAULT 
now(), updated_by_profile_id UUID NULL REFERENCES public.profiles(id) ON DELETE 
SET NULL, CONSTRAINT uq_route_media_link UNIQUE (route_id, media_id, 
media_role_code), CONSTRAINT uq_route_media_role_order UNIQUE (route_id, 
display_order, media_role_code) ); -- Indexes CREATE INDEX IF NOT EXISTS 
idx_route_media_route_id ON public.route_media(route_id); CREATE INDEX IF NOT 
EXISTS idx_route_media_media_id ON public.route_media(media_id); CREATE INDEX 
IF NOT EXISTS idx_route_media_media_role_code ON 
public.route_media(media_role_code); CREATE INDEX IF NOT EXISTS 
idx_route_media_created_by_profile_id ON 
public.route_media(created_by_profile_id) WHERE created_by_profile_id IS NOT 
NULL; CREATE INDEX IF NOT EXISTS idx_route_media_updated_by_profile_id ON 
public.route_media(updated_by_profile_id) WHERE updated_by_profile_id IS NOT 
NULL; -- Comments COMMENT ON TABLE public.route_media IS 'Links routes to 
additional media items (e.g., galleries), defining display order, role, and 
translatable caption/alt-text overrides. Supplements direct media FKs on 
public.routes. V1.0'; COMMENT ON COLUMN public.route_media.id IS 'Surrogate 
unique identifier for the route-media link.'; COMMENT ON COLUMN 
public.route_media.route_id IS 'Foreign key to the public.routes table.'; 
COMMENT ON COLUMN public.route_media.media_id IS 'Foreign key to the 
public.media table. Restricted delete to prevent orphaned links if media is in 
use.'; COMMENT ON COLUMN public.route_media.media_role_code IS 'Semantic role 
of the media in relation to the route. FK to public.media_roles_master.code.'; 
COMMENT ON COLUMN public.route_media.display_order IS 'Order for displaying 
media items within a specific role for this route (e.g., sequence in a 
gallery). Admins can reorder. Default 0.'; COMMENT ON COLUMN 
public.route_media.caption_override IS 'Optional override for the media''s 
default caption, specific to its use with this route. Primary reference 
language (English). (Translatable via public.translations using 
route_media.id).'; COMMENT ON COLUMN public.route_media.alt_text_override IS 
'Optional override for the media''s default alt text, specific to its use with 
this route. Primary reference language (English). (Translatable via 
public.translations using route_media.id).'; COMMENT ON COLUMN 
public.route_media.created_at IS 'Timestamp of when this link record was 
created.'; COMMENT ON COLUMN public.route_media.created_by_profile_id IS 
'Profile ID of the user who created this link.'; COMMENT ON COLUMN 
public.route_media.updated_at IS 'Timestamp of when this link record was last 
updated (auto-updated by trigger).'; COMMENT ON COLUMN 
public.route_media.updated_by_profile_id IS 'Profile ID of the user who last 
updated this link.'; -- Standard updated_at trigger CREATE TRIGGER 
trigger_route_media_set_updated_at BEFORE UPDATE ON public.route_media FOR EACH 
ROW EXECUTE FUNCTION public.set_current_timestamp_updated_at(); -- Or 
extensions.moddatetime('updated_at') COMMENT ON TRIGGER 
trigger_route_media_set_updated_at ON public.route_media IS 'Automatically 
updates the updated_at timestamp on row modification.'; -- Orphaned translation 
cleanup trigger for route_media's own translatable fields CREATE OR REPLACE 
FUNCTION public.cleanup_route_media_translations() RETURNS TRIGGER AS $$ BEGIN 
IF TG_OP = 'DELETE' THEN DELETE FROM public.translations WHERE table_identifier 
= 'route_media' AND row_foreign_key = OLD.id::TEXT; -- Uses the surrogate PK of 
route_media END IF; RETURN OLD; END; $$ LANGUAGE plpgsql SECURITY DEFINER; 
COMMENT ON FUNCTION public.cleanup_route_media_translations() IS 'Removes 
related entries from public.translations for route_media.caption_override and 
route_media.alt_text_override when a route_media record is deleted. Runs as 
SECURITY DEFINER.'; CREATE TRIGGER 
trigger_cleanup_route_media_translations_after_delete AFTER DELETE ON 
public.route_media FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_route_media_translations(); COMMENT ON TRIGGER 
trigger_cleanup_route_media_translations_after_delete ON public.route_media IS 
'After a route_media link is deleted, removes its associated translations from 
the public.translations table.'; -- (Conceptual trigger to update 
media.last_linked_or_used_at would be similar to trail_media) ``` ### 4\. JSON 
Schema Mirror JSON ``` { "title": "route_media_link", "description": "Links 
routes to additional media items (e.g., galleries), defining display order, 
role, and translatable caption/alt-text overrides. Supplements direct media FKs 
on public.routes. V1.0", "type": "object", "properties": { "id": { "type": 
"integer", "format": "int64", "description": "Surrogate unique identifier for 
the route-media link.", "readOnly": true }, "route_id": { "type": "integer", 
"format": "int64", "description": "Foreign key to the public.routes table." }, 
"media_id": { "type": "string", "format": "uuid", "description": "Foreign key 
to the public.media table." }, "media_role_code": { "type": "string", 
"description": "Semantic role of the media in relation to the route. FK to 
public.media_roles_master.code." }, "display_order": { "type": "integer", 
"format": "int16", "default": 0, "description": "Order for displaying media 
items within a specific role for this route." }, "caption_override": { "type": 
["string", "null"], "description": "Optional override for the media's default 
caption, specific to this route link. Primary reference language (English). 
(Translatable via public.translations using route_media.id)." }, 
"alt_text_override": { "type": ["string", "null"], "description": "Optional 
override for the media's default alt text, specific to this route link. Primary 
reference language (English). (Translatable via public.translations using 
route_media.id)." }, "created_at": { "type": "string", "format": "date-time", 
"description": "Timestamp of when this link record was created.", "readOnly": 
true }, "created_by_profile_id": { "type": ["string", "null"], "format": 
"uuid", "description": "Profile ID of the user who created this link." }, 
"updated_at": { "type": "string", "format": "date-time", "description": 
"Timestamp of when this link record was last updated.", "readOnly": true }, 
"updated_by_profile_id": { "type": ["string", "null"], "format": "uuid", 
"description": "Profile ID of the user who last updated this link." } }, 
"required": [ "route_id", "media_id", "media_role_code", "display_order", 
"created_at", "updated_at" ], "primary_key": ["id"], "unique_constraints": [ 
{"columns": ["route_id", "media_id", "media_role_code"], "name": 
"uq_route_media_link"}, {"columns": ["route_id", "display_order", 
"media_role_code"], "name": "uq_route_media_role_order"} ], "foreign_keys": [ 
{"columns": ["route_id"], "references_table": "public.routes", 
"references_columns": ["id"], "on_delete": "CASCADE"}, {"columns": 
["media_id"], "references_table": "public.media", "references_columns": ["id"], 
"on_delete": "RESTRICT"}, {"columns": ["media_role_code"], "references_table": 
"public.media_roles_master", "references_columns": ["code"], "on_delete": 
"RESTRICT", "on_update": "CASCADE"}, {"columns": ["created_by_profile_id"], 
"references_table": "public.profiles", "references_columns": ["id"], 
"on_delete": "SET NULL"}, {"columns": ["updated_by_profile_id"], 
"references_table": "public.profiles", "references_columns": ["id"], 
"on_delete": "SET NULL"} ] } ``` ### 5\. Relationships & Integrity - Primary 
Key: `id BIGINT` (surrogate key). - Foreign Keys: - `route_id` references 
`public.routes(id)` `ON DELETE CASCADE`. - `media_id` references 
`public.media(id)` `ON DELETE RESTRICT`. - `media_role_code` references 
`public.media_roles_master(code)` `ON DELETE RESTRICT ON UPDATE CASCADE`. - 
Audit FKs to `public.profiles(id)` `ON DELETE SET NULL`. - Unique Constraints: 
- `UNIQUE (route_id, media_id, media_role_code)` - `UNIQUE (route_id, 
display_order, media_role_code)` ### 6\. Multilingual Strategy - Translatable 
Fields: `caption_override`, `alt_text_override`. - Mechanism: Store English in 
these columns; other languages in `public.translations` linked via 
`route_media.id`. Fallback to `media.default_caption/alt_text` if overrides are 
`NULL`. - Orphan Cleanup: 
`trigger_cleanup_route_media_translations_after_delete` handles this. ### 7\. 
Role-Based Workflow & RLS Notes - Content Management: Primarily by Admins 
(`admin_platform`) and Regional Content Managers (`regional_content_manager`). 
- RLS Policy Sketch: - Public Read: `SELECT` if parent `public.routes` is 
published and not deleted. SQL ``` CREATE POLICY "Allow public read access to 
route_media" ON public.route_media FOR SELECT USING ( EXISTS ( SELECT 1 FROM 
public.routes r JOIN public.trails t ON r.trail_id = t.id -- Assuming routes 
are visible if their parent trail is also published WHERE r.id = 
route_media.route_id AND r.content_visibility_status = 
'published'::public.content_visibility_status_enum AND r.deleted_at IS NULL AND 
t.content_visibility_status = 
'published'::public.content_visibility_status_enum -- Check trail status AND 
t.deleted_at IS NULL ) ); ``` - Content Manager Write Access: `INSERT`, 
`UPDATE`, `DELETE` for roles like `admin_platform` or 
`regional_content_manager` if they can manage the parent `route_id`. SQL ``` 
CREATE POLICY "Allow content managers to manage route_media" ON 
public.route_media FOR ALL USING ( (SELECT public.has_role('admin_platform')) 
OR (SELECT public.has_role('regional_content_manager') AND 
public.user_manages_route(route_media.route_id)) -- Conceptual helper ) WITH 
CHECK ( (SELECT public.has_role('admin_platform')) OR (SELECT 
public.has_role('regional_content_manager') AND 
public.user_manages_route(route_media.route_id)) ); ``` (The 
`public.user_manages_route(BIGINT)` helper function would need to be defined, 
likely checking management of the parent trail/region). ### 8\. ENUM vs. Lookup 
Discussion - N/A for this table directly; relies on 
`public.media_roles_master`. ### 9\. UI/UX Enablement - Populates 
route-specific image galleries (`gallery_image` role). - Allows for additional 
illustrative maps or visuals beyond the route's primary ones. - `display_order` 
ensures consistent presentation. ### 10\. Key Considerations & Definitions - 
Media Roles for Routes: - `gallery_image`: This should be the primary role used 
by this table for V1, allowing multiple images to form a route gallery. - 
`map_image_detailed` (Potential New Role for `media_roles_master`): If needed 
for detailed static map sections specific to a route, beyond the single 
`map_overview_media_id` on `public.routes`. For V1, focus on `gallery_image`. - 
Avoid functional overlap with `public.routes` direct FKs 
(`overall_gpx_media_id`, `map_overview_media_id`, `banner_media_id`). This 
table is for *additional* media. - `display_order`: Should default to 0. 
Admins/managers set this for ordering within a role (e.g., gallery sequence). 
Application can provide logic to suggest next available order on insert. - `ON 
DELETE RESTRICT` for `media_id`: Important for media asset integrity. ### 11\. 
Scalability & Future-Proofing - Standard linking table design, scales with the 
number of routes and associated media. - Flexible due to `media_roles_master`. 
### 12\. Seed Data - N/A. Transactional data. ### 13\. Next-Action Checklist 1. 
🔴 Verify Dependencies: `public.routes`, `public.media`, 
`public.media_roles_master`, `public.profiles`, `public.translations` must be 
V2 compliant. 2. 🔴 Confirm `media_roles_master` Entries: Ensure 
`gallery_image` and any other desired roles (e.g., `map_image_detailed` if 
pursued) exist in `public.media_roles_master`. 3. 🔴 Implement DDL: Execute the 
`CREATE TABLE public.route_media` DDL. 4. 🔴 Implement Triggers: Apply 
`updated_at` and `cleanup_route_media_translations` triggers. 5. 🟠 RLS 
Policies & Helper Functions: Define, implement, and test RLS policies. Create 
helper functions like `public.user_manages_route(BIGINT)`. 6. 🟢 Application 
Logic: For `display_order` management and caption/alt text fallbacks. 7. 🟢 
Data Migration: Plan if relevant. * * * * * This completes the specification 
for `public.route_media`. Please let me know which parent entity and media 
linking table you'd like to address next from the list we identified. 
