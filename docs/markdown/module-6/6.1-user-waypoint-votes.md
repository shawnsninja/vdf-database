# 6.1 user_waypoint_votes

  
https://gemini.google.com/u/1/app/28b5eb1f3acf0522?is_sa=1&android-min-version=3
01356232&ios-min-version=322.0&campaign_id=bkws&utm_source=google&utm_medium=cpc
&utm_campaign=2024enUS_gemfeb&pt=9008&mt=8&ct=p-growth-sem-bkws 
https://gemini.google.com/u/1/app/39ab8052602be0ce 
https://gemini.google.com/u/1/app/8f9ebd64aa0fd57f ### 3\. Updated 
Production-Ready Specification: `public.user_waypoint_votes` Version: 2.1.1 
(Internal revision post-checklist review) Date: May 18, 2025 1\. Purpose & 
Primary Use-Cases - Mission Statement: To enable authenticated users (pilgrims) 
to cast a simple "thumbs up" or "thumbs down" vote on specific waypoints, 
providing a quick community sentiment indicator and supporting features like 
sorting by popularity. - Key User-Story Touchpoints: - Pilgrim (Anna) - Story 
A8: Directly allows Anna to see "thumbs up/down" counts for waypoints and 
contribute her own vote, helping her gauge community sentiment. - Host (Marco): 
Indirectly allows Marco to gauge pilgrim sentiment towards his accommodation 
via aggregated vote counts. - Regional Manager (Sofia): Indirectly allows Sofia 
to identify well-regarded or potentially problematic waypoints based on vote 
patterns. - Admin Team - Story D1 & D2: Allows admins to oversee voting 
activity and potentially use aggregated vote data to inform content curation. 
2\. Schema | column | data_type | constraints | description | | `profile_id` | 
`uuid` | `PRIMARY KEY (Part 1/2)`, `NOT NULL`, `FOREIGN KEY to 
public.profiles(id) ON DELETE CASCADE` | The ID from the `profiles` table of 
the user casting the vote. If the user's profile is deleted, their vote is also 
removed. | | `waypoint_id` | `integer` | `PRIMARY KEY (Part 2/2)`, `NOT NULL`, 
`FOREIGN KEY to public.waypoints(id) ON DELETE CASCADE` | The ID from the 
`waypoints` table that is being voted on. If the waypoint is deleted, 
corresponding votes are also removed. Crucial: Confirm type matches 
`waypoints.id`. | | `vote_type` | `public.vote_type_enum` | `NOT NULL` | The 
type of vote cast by the user ('up' or 'down'). | | `vote_source_platform` | 
`text` | `NULLABLE` | Optional: Indicates the platform from which the vote was 
cast (e.g., 'web_app_v1', 'mobile_ios_v1'). Useful for analytics. | | 
`created_at` | `timestamp with time zone` | `NOT NULL`, `DEFAULT now()` | 
Timestamp of when the vote was initially cast. | | `updated_at` | `timestamp 
with time zone` | `NOT NULL`, `DEFAULT now()` | Timestamp of when the vote was 
last modified (e.g., `vote_type` changed, or `deleted_at` status changed). 
Auto-updated by a database trigger. | | `deleted_at` | `timestamp with time 
zone` | `NULLABLE` | Timestamp for soft deletion. If set, the vote is 
considered retracted or inactive but preserved for history. Active votes have 
`NULL`. | 3\. PostgreSQL DDL SQL ``` -- ENUM Type Definition (if not already 
created globally) DO $$ BEGIN IF NOT EXISTS (SELECT 1 FROM pg_type WHERE 
typname = 'vote_type_enum') THEN CREATE TYPE public.vote_type_enum AS ENUM 
('up', 'down'); END IF; END $$; -- Table Definition for user_waypoint_votes 
CREATE TABLE public.user_waypoint_votes ( profile_id uuid NOT NULL, waypoint_id 
integer NOT NULL, -- CRITICAL: Confirm this matches the data type of 
public.waypoints.id (e.g., integer, bigint, uuid) vote_type 
public.vote_type_enum NOT NULL, vote_source_platform text NULL, created_at 
timestamptz NOT NULL DEFAULT now(), updated_at timestamptz NOT NULL DEFAULT 
now(), deleted_at timestamptz NULL, CONSTRAINT user_waypoint_votes_pkey PRIMARY 
KEY (profile_id, waypoint_id), CONSTRAINT user_waypoint_votes_profile_id_fkey 
FOREIGN KEY (profile_id) REFERENCES public.profiles(id) ON DELETE CASCADE, 
CONSTRAINT user_waypoint_votes_waypoint_id_fkey FOREIGN KEY (waypoint_id) 
REFERENCES public.waypoints(id) ON DELETE CASCADE ); -- Comments on Table and 
Columns COMMENT ON TABLE public.user_waypoint_votes IS 'Stores user votes 
(up/down) for specific waypoints. Supports soft deletion for vote retractions. 
Version 2.1.1.'; COMMENT ON COLUMN public.user_waypoint_votes.profile_id IS 'FK 
to profiles.id of the user who cast the vote. Part of PK.'; COMMENT ON COLUMN 
public.user_waypoint_votes.waypoint_id IS 'FK to waypoints.id of the waypoint 
being voted on. Part of PK. CRITICAL: Confirm data type matches waypoints.id.'; 
COMMENT ON COLUMN public.user_waypoint_votes.vote_type IS 'The type of vote: 
''up'' or ''down''. Uses public.vote_type_enum.'; COMMENT ON COLUMN 
public.user_waypoint_votes.vote_source_platform IS 'Optional: Platform from 
which the vote was cast (e.g., ''web_app_v1'', ''mobile_ios_v1''). For 
analytics.'; COMMENT ON COLUMN public.user_waypoint_votes.created_at IS 
'Timestamp of when the vote was initially cast.'; COMMENT ON COLUMN 
public.user_waypoint_votes.updated_at IS 'Timestamp of when the vote record was 
last updated (vote type changed or soft deleted/restored). Auto-updated by 
trigger.'; COMMENT ON COLUMN public.user_waypoint_votes.deleted_at IS 
'Timestamp for soft deletion. If set, the vote is considered 
retracted/inactive.'; -- Index for efficient aggregation of active votes 
(primarily if not solely relying on triggers to waypoints table) CREATE INDEX 
IF NOT EXISTS idx_user_waypoint_votes_active ON public.user_waypoint_votes 
(waypoint_id, vote_type) WHERE (deleted_at IS NULL); -- Generic Trigger 
Function to update 'updated_at' timestamp (if not already created globally) 
CREATE OR REPLACE FUNCTION public.handle_updated_at() RETURNS TRIGGER AS $$ 
BEGIN NEW.updated_at = NOW(); RETURN NEW; END; $$ LANGUAGE plpgsql; -- Trigger 
for user_waypoint_votes table 'updated_at' CREATE TRIGGER 
on_user_waypoint_votes_updated_at BEFORE UPDATE ON public.user_waypoint_votes 
FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at(); -- Trigger Function 
to update aggregated counts on the 'waypoints' table (CRITICAL) -- (Assumes 
public.waypoints table has up_vote_count INTEGER and down_vote_count INTEGER 
columns) CREATE OR REPLACE FUNCTION public.update_waypoint_vote_counts() 
RETURNS TRIGGER AS $$ BEGIN -- Handle INSERT operations IF (TG_OP = 'INSERT') 
THEN IF NEW.deleted_at IS NULL THEN -- Only count active votes IF NEW.vote_type 
= 'up' THEN UPDATE public.waypoints SET up_vote_count = up_vote_count + 1 WHERE 
id = NEW.waypoint_id; ELSE -- 'down' UPDATE public.waypoints SET 
down_vote_count = down_vote_count + 1 WHERE id = NEW.waypoint_id; END IF; END 
IF; -- Handle DELETE operations (Hard Deletes) ELSIF (TG_OP = 'DELETE') THEN IF 
OLD.deleted_at IS NULL THEN -- Only reverse active votes IF OLD.vote_type = 
'up' THEN UPDATE public.waypoints SET up_vote_count = GREATEST(0, up_vote_count 
- 1) WHERE id = OLD.waypoint_id; ELSE -- 'down' UPDATE public.waypoints SET 
down_vote_count = GREATEST(0, down_vote_count - 1) WHERE id = OLD.waypoint_id; 
END IF; END IF; -- Handle UPDATE operations ELSIF (TG_OP = 'UPDATE') THEN -- 
Case 1: Vote retracted (deleted_at changed from NULL to NOT NULL) IF 
OLD.deleted_at IS NULL AND NEW.deleted_at IS NOT NULL THEN IF OLD.vote_type = 
'up' THEN UPDATE public.waypoints SET up_vote_count = GREATEST(0, up_vote_count 
- 1) WHERE id = OLD.waypoint_id; ELSE -- 'down' UPDATE public.waypoints SET 
down_vote_count = GREATEST(0, down_vote_count - 1) WHERE id = OLD.waypoint_id; 
END IF; -- Case 2: Vote reinstated (deleted_at changed from NOT NULL to NULL) 
ELSIF OLD.deleted_at IS NOT NULL AND NEW.deleted_at IS NULL THEN IF 
NEW.vote_type = 'up' THEN UPDATE public.waypoints SET up_vote_count = 
up_vote_count + 1 WHERE id = NEW.waypoint_id; ELSE -- 'down' UPDATE 
public.waypoints SET down_vote_count = down_vote_count + 1 WHERE id = 
NEW.waypoint_id; END IF; -- Case 3: Active vote type changed (deleted_at was 
NULL and remains NULL) ELSIF OLD.deleted_at IS NULL AND NEW.deleted_at IS NULL 
AND OLD.vote_type <> NEW.vote_type THEN IF OLD.vote_type = 'up' THEN -- 
Decrement old up-vote UPDATE public.waypoints SET up_vote_count = GREATEST(0, 
up_vote_count - 1) WHERE id = OLD.waypoint_id; ELSE -- Decrement old down-vote 
UPDATE public.waypoints SET down_vote_count = GREATEST(0, down_vote_count - 1) 
WHERE id = OLD.waypoint_id; END IF; IF NEW.vote_type = 'up' THEN -- Increment 
new up-vote UPDATE public.waypoints SET up_vote_count = up_vote_count + 1 WHERE 
id = NEW.waypoint_id; ELSE -- Increment new down-vote UPDATE public.waypoints 
SET down_vote_count = down_vote_count + 1 WHERE id = NEW.waypoint_id; END IF; 
END IF; END IF; RETURN NULL; -- Result is ignored since this is an AFTER 
trigger END; $$ LANGUAGE plpgsql SECURITY DEFINER; -- SECURITY DEFINER if 
waypoints table has restrictive RLS for users -- Apply the vote count trigger 
CREATE TRIGGER after_user_waypoint_votes_change AFTER INSERT OR UPDATE OR 
DELETE ON public.user_waypoint_votes FOR EACH ROW EXECUTE FUNCTION 
public.update_waypoint_vote_counts(); -- RLS Policies ALTER TABLE 
public.user_waypoint_votes ENABLE ROW LEVEL SECURITY; CREATE POLICY "Pilgrims 
can insert their own votes" ON public.user_waypoint_votes FOR INSERT TO 
authenticated WITH CHECK (auth.uid() = profile_id); CREATE POLICY "Pilgrims can 
update their own votes" ON public.user_waypoint_votes FOR UPDATE TO 
authenticated USING (auth.uid() = profile_id) WITH CHECK (auth.uid() = 
profile_id); CREATE POLICY "Pilgrims can view their own votes" ON 
public.user_waypoint_votes FOR SELECT TO authenticated USING (auth.uid() = 
profile_id); -- Optional: Grant direct read access to active votes if needed by 
clients beyond aggregated counts. -- CREATE POLICY "Authenticated users can 
view active public votes" -- ON public.user_waypoint_votes FOR SELECT -- TO 
authenticated -- USING (deleted_at IS NULL); COMMENT ON POLICY "Pilgrims can 
insert their own votes" ON public.user_waypoint_votes IS 'Allows authenticated 
users to insert their own votes.'; COMMENT ON POLICY "Pilgrims can update their 
own votes" ON public.user_waypoint_votes IS 'Allows authenticated users to 
update their own votes (change type, retract, or reinstate).'; COMMENT ON 
POLICY "Pilgrims can view their own votes" ON public.user_waypoint_votes IS 
'Allows authenticated users to view their own vote records.'; ``` 4\. JSON 
Schema Mirror JSON ``` { "title": "user_waypoint_vote", "description": "Records 
an authenticated user's 'thumbs up' or 'thumbs down' vote for a specific 
waypoint. Handles vote changes and retractions via soft delete. Version 
2.1.1.", "type": "object", "properties": { "profile_id": { "type": "string", 
"format": "uuid", "description": "FK to profiles.id of the user who cast the 
vote. Part of the composite PK." }, "waypoint_id": { "type": "integer", 
"description": "FK to waypoints.id of the waypoint being voted on. Part of the 
composite PK. CRITICAL: Confirm data type matches waypoints.id." }, 
"vote_type": { "$ref": "#/definitions/vote_type_enum", "description": "The type 
of vote cast ('up' or 'down')." }, "vote_source_platform": { "type": ["string", 
"null"], "description": "Optional: Platform from which the vote was cast (e.g., 
'web_app_v1', 'mobile_ios_v1'). For analytics." }, "created_at": { "type": 
"string", "format": "date-time", "description": "Timestamp of when the vote was 
initially cast.", "readOnly": true }, "updated_at": { "type": "string", 
"format": "date-time", "description": "Timestamp of when the vote record was 
last updated (vote type changed or soft deleted/restored). Auto-updated by 
trigger.", "readOnly": true }, "deleted_at": { "type": ["string", "null"], 
"format": "date-time", "description": "Timestamp for soft deletion. If set, the 
vote is considered retracted/inactive.", "readOnly": true } }, "required": [ 
"profile_id", "waypoint_id", "vote_type", "created_at", "updated_at" ], 
"primary_key": ["profile_id", "waypoint_id"], "definitions": { 
"vote_type_enum": { "type": "string", "enum": ["up", "down"], "description": 
"The type of vote: 'up' or 'down'." } } } ``` 5\. Relationships & Integrity - 
Foreign Keys: - `profile_id` references `public.profiles(id)` (`ON DELETE 
CASCADE`). - `waypoint_id` references `public.waypoints(id)` (`ON DELETE 
CASCADE`). - Junction Table: Acts as a many-to-many junction between `profiles` 
and `waypoints` for votes. - `vote_type_enum` remains an ENUM. - Mermaid ER 
Snippet: Code snippet ``` erDiagram profiles { uuid id PK } waypoints { integer 
id PK "CRITICAL: Confirm type" } user_waypoint_votes { uuid profile_id PK, FK 
integer waypoint_id PK, FK "CRITICAL: Confirm type" vote_type_enum vote_type 
text vote_source_platform timestamptz created_at timestamptz updated_at 
timestamptz deleted_at } profiles ||--o{ user_waypoint_votes : "casts" 
waypoints ||--o{ user_waypoint_votes : "receives_vote_for" waypoints { integer 
up_vote_count "DENORMALIZED" integer down_vote_count "DENORMALIZED" } ``` 6\. 
Multilingual Strategy - Not Directly Applicable: This table stores `vote_type` 
('up', 'down') which are internal system values. UI representation is handled 
by the frontend. - `vote_source_platform` is for internal analytics and not 
typically translated. 7\. Role-Based Workflow & RLS Notes - Key Fields for 
Workflow: `profile_id`, `created_at`, `updated_at`, `deleted_at`. - RLS 
Policies: - Table RLS is enabled. - Authenticated users can insert their own 
votes (`WITH CHECK (auth.uid() = profile_id)`). - Authenticated users can 
update their own votes (`USING (auth.uid() = profile_id) WITH CHECK (auth.uid() 
= profile_id)`). - Authenticated users can view their own votes (`USING 
(auth.uid() = profile_id)`). - Anonymous access (`anon` role) should generally 
be denied. - Admin access is typically via `service_role` or specific admin 
policies if needed for direct manipulation (not common for this table). 8\. 
ENUM vs Lookup Discussion - `vote_type_enum` (`'up'`, `'down'`): Remains an 
ENUM. This is appropriate as values are simple, binary, and unlikely to need 
extended metadata or i18n for the ENUM values themselves. 9\. UI/UX Enablement 
- Columns Powering UI: `vote_type` (indirectly via aggregated counts on 
`waypoints`), `deleted_at` (for UI state of user's own vote). - Performance for 
UX: - CRITICAL: Denormalized `up_vote_count` and `down_vote_count` on the 
`waypoints` table, updated by the `update_waypoint_vote_counts` trigger, are 
essential for fast display and sorting. - Composite PK `(profile_id, 
waypoint_id)` is efficient for checking existing votes. 10\. Auditing & 
Lifecycle Management - Audit Columns: `created_at`, `updated_at`. `profile_id` 
serves as the implicit creator/updater ID due to RLS ownership rules. Separate 
`created_by_profile_id`/`updated_by_profile_id` are deemed redundant here. - 
Soft Deletion: `deleted_at` for vote retractions. - Data Integrity: `ON DELETE 
CASCADE` on FKs prevents orphaned votes. 11\. Scalability & Future-Proofing - 
Partitioning: Not anticipated as necessary for V1/V2. - Vote Abuse/Spam: Future 
consideration (V2+); schema could be extended (e.g., `ip_address_hash`). 12\. 
Seed Data - Not applicable; this table contains user-generated transactional 
data. 13\. Next-Action Checklist 1. 🔴 CRITICAL: Confirm 
`user_waypoint_votes.waypoint_id` Data Type: Rigorously verify and align the 
`integer` data type for `user_waypoint_votes.waypoint_id` with 
`public.waypoints.id`. Adjust DDL for `user_waypoint_votes` and the 
`update_waypoint_vote_counts` trigger function if `waypoints.id` is different 
(e.g., `bigint`, `uuid`). 2. 🔴 CRITICAL: Implement `waypoints` Table 
Modifications: Ensure `up_vote_count INTEGER NOT NULL DEFAULT 0` and 
`down_vote_count INTEGER NOT NULL DEFAULT 0` columns are added to 
`public.waypoints`. 3. 🔴 CRITICAL: Implement and Test 
`update_waypoint_vote_counts` Trigger: Create and assign this trigger to 
`public.user_waypoint_votes`. Ensure the trigger function correctly references 
the `waypoints.id` column (type and name) and consider making it `SECURITY 
DEFINER` if `waypoints` RLS would prevent direct updates by the user triggering 
the vote. If `SECURITY DEFINER` is used, ensure `search_path` is hardened. 4. 
🟢 RLS Policies: Implement and test all defined RLS policies. 5. 🟢 
`updated_at` Trigger: Ensure `public.handle_updated_at()` and its trigger are 
correctly implemented. 6. 🟢 Application Logic: Develop robust backend logic 
for vote submission/UPSERT pattern. 7. 🟢 Backfill Counts: If `waypoints` data 
exists, run a one-time script to populate denormalized vote counts. 8. 🟢 
Documentation: Note the deliberate omission of 
`created_by_profile_id`/`updated_by_profile_id` due to RLS ownership model. 
