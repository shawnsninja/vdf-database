# 6.3 tip_categories_master

  https://gemini.google.com/u/1/app/39ab8052602be0ce 
https://gemini.google.com/u/1/app/8f9ebd64aa0fd57f ### Updated Production-Ready 
Specification: `public.tip_categories_master` Version: 2.1 Date: May 18, 2025 
1\. Purpose & Primary Use-Cases Mission Statement: To define and manage a 
standardized list of categories for user-submitted tips 
(user_waypoint_short_tips). This table supports multilingual display of 
category names (via public.translations), allows for associated metadata like 
icons and sort order, and enables consistent filtering and organization of tips 
across the platform. It includes audit fields for administrative changes. Key 
User-Story Touchpoints: * Pilgrim (Anna): Indirectly benefits by seeing 
categorized tips, potentially with icons, and being able to filter tips by 
category. * Regional Manager (Sofia) & Admin Team: Directly use these 
categories for managing and understanding tip content, potentially in their 
preferred language within admin interfaces. Admins manage the available 
categories. 2\. Schema | column | data_type | constraints | description | | 
`category_code` | `text` | `PRIMARY KEY`, `NOT NULL` | Unique code for the 
category (e.g., 'practical_advice', 'safety_observation'). | | `default_name` | 
`text` | `NOT NULL` | Default human-readable name for the category in the 
primary reference language (e.g., English). (Translatable via 
`public.translations`) | | `default_description` | `text` | `NULLABLE` | 
Optional default detailed description of the category in the primary reference 
language. (Translatable via `public.translations`) | | `icon_identifier` | 
`text` | `NULLABLE` | Optional identifier for an icon associated with this 
category (e.g., 'icon-lightbulb', 'icon-warning'). | | `is_active` | `boolean` 
| `NOT NULL`, `DEFAULT true` | Whether the category is currently active and 
available for use/display. | | `sort_order` | `smallint` | `NOT NULL`, `DEFAULT 
0` | Defines a sort order for displaying categories in UI lists. | | 
`created_at` | `timestamp with time zone` | `NOT NULL`, `DEFAULT now()` | 
Timestamp of when the category was created. | | `updated_at` | `timestamp with 
time zone` | `NOT NULL`, `DEFAULT now()` | Timestamp of when the category was 
last updated. Auto-updated by a trigger. | | `created_by_profile_id` | `uuid` | 
`NULLABLE`, `REFERENCES public.profiles(id) ON DELETE SET NULL` | Profile ID of 
the user who created this category. | | `updated_by_profile_id` | `uuid` | 
`NULLABLE`, `REFERENCES public.profiles(id) ON DELETE SET NULL` | Profile ID of 
the user who last updated this category. | 3\. PostgreSQL DDL SQL ``` -- Table 
Definition for tip_categories_master CREATE TABLE public.tip_categories_master 
( category_code text NOT NULL PRIMARY KEY, default_name text NOT NULL, 
default_description text NULL, icon_identifier text NULL, is_active boolean NOT 
NULL DEFAULT true, sort_order smallint NOT NULL DEFAULT 0, created_at timestamp 
with time zone NOT NULL DEFAULT now(), updated_at timestamp with time zone NOT 
NULL DEFAULT now(), created_by_profile_id uuid NULL REFERENCES 
public.profiles(id) ON DELETE SET NULL, updated_by_profile_id uuid NULL 
REFERENCES public.profiles(id) ON DELETE SET NULL ); -- Comments on Table and 
Columns COMMENT ON TABLE public.tip_categories_master IS 'Master table for 
defining categories for user-submitted tips, supporting i18n, icons, audit, and 
lifecycle. Version 2.1.'; COMMENT ON COLUMN 
public.tip_categories_master.category_code IS 'PK. Unique code for the category 
(e.g., ''practical_advice'', ''safety_observation'').'; [cite: 499] COMMENT ON 
COLUMN public.tip_categories_master.default_name IS 'Default human-readable 
name for the category in the primary reference language (e.g., English). 
(Translatable via public.translations)'; COMMENT ON COLUMN 
public.tip_categories_master.default_description IS 'Optional default detailed 
description of the category in the primary reference language. (Translatable 
via public.translations)'; COMMENT ON COLUMN 
public.tip_categories_master.icon_identifier IS 'Optional identifier for an 
icon associated with this category (e.g., ''icon-lightbulb'', 
''icon-warning'').'; [cite: 503] COMMENT ON COLUMN 
public.tip_categories_master.is_active IS 'Whether the category is currently 
active and available for use/display. Defaults to true.'; [cite: 504] COMMENT 
ON COLUMN public.tip_categories_master.sort_order IS 'Defines a sort order for 
displaying categories in UI lists. Defaults to 0.'; [cite: 505] COMMENT ON 
COLUMN public.tip_categories_master.created_at IS 'Timestamp of when the 
category was created.'; [cite: 506] COMMENT ON COLUMN 
public.tip_categories_master.updated_at IS 'Timestamp of when the category was 
last updated. Auto-updated by a trigger.'; [cite: 507] COMMENT ON COLUMN 
public.tip_categories_master.created_by_profile_id IS 'Profile ID of the user 
who created this category. FK to profiles.id. ON DELETE SET NULL.'; COMMENT ON 
COLUMN public.tip_categories_master.updated_by_profile_id IS 'Profile ID of the 
user who last updated this category. FK to profiles.id. ON DELETE SET NULL.'; 
-- Indexes CREATE INDEX ix_tip_categories_master_active_order ON 
public.tip_categories_master (is_active, sort_order); CREATE INDEX 
ix_tip_categories_master_created_by ON public.tip_categories_master 
(created_by_profile_id) WHERE created_by_profile_id IS NOT NULL; CREATE INDEX 
ix_tip_categories_master_updated_by ON public.tip_categories_master 
(updated_by_profile_id) WHERE updated_by_profile_id IS NOT NULL; -- Trigger for 
updated_at timestamp (Ensure public.handle_updated_at() function exists) CREATE 
TRIGGER on_tip_categories_master_updated_at BEFORE UPDATE ON 
public.tip_categories_master FOR EACH ROW EXECUTE FUNCTION 
public.handle_updated_at(); -- Assuming public.handle_updated_at() is the 
standard function [cite: 508] -- Trigger for cleaning up related translations 
(Ensure public.cleanup_tip_categories_master_translations() function is 
created) CREATE OR REPLACE FUNCTION 
public.cleanup_tip_categories_master_translations() RETURNS TRIGGER AS $$ BEGIN 
DELETE FROM public.translations WHERE table_identifier = 
'tip_categories_master' AND row_foreign_key = OLD.category_code; RETURN OLD; 
END; $$ LANGUAGE plpgsql SECURITY DEFINER; CREATE TRIGGER 
trigger_cleanup_translations_on_tip_category_delete AFTER DELETE ON 
public.tip_categories_master FOR EACH ROW EXECUTE FUNCTION 
public.cleanup_tip_categories_master_translations(); COMMENT ON TRIGGER 
trigger_cleanup_translations_on_tip_category_delete ON 
public.tip_categories_master IS 'Cleans up orphaned translations from 
public.translations when a tip category is deleted.'; -- RLS Policies ALTER 
TABLE public.tip_categories_master ENABLE ROW LEVEL SECURITY; CREATE POLICY 
"Admins can manage tip categories" ON public.tip_categories_master FOR ALL TO 
authenticated USING (public.has_role_on_profile(auth.uid(), 'admin_platform')) 
-- Adjust role check as needed WITH CHECK 
(public.has_role_on_profile(auth.uid(), 'admin_platform')); -- Adjust role 
check as needed CREATE POLICY "Public can view active tip categories" ON 
public.tip_categories_master FOR SELECT USING (is_active = true); COMMENT ON 
POLICY "Admins can manage tip categories" ON public.tip_categories_master IS 
'Allows platform administrators (or users with equivalent roles) to manage all 
tip categories.'; COMMENT ON POLICY "Public can view active tip categories" ON 
public.tip_categories_master IS 'Allows all users (anonymous and authenticated) 
to view active tip categories.'; ``` 4\. JSON Schema Mirror JSON ``` { "title": 
"tip_category_master", "description": "Defines a standardized category for 
user-submitted tips, supporting i18n, icons, audit, and lifecycle. Version 
2.1.", "type": "object", "properties": { "category_code": { "type": "string", 
"description": "PK. Unique code for the category (e.g., 'practical_advice')." 
}, "default_name": { "type": "string", "description": "Default human-readable 
name for the category in the primary reference language (e.g., English). 
(Translatable via public.translations)" }, "default_description": { "type": 
["string", "null"], "description": "Optional default detailed description of 
the category in the primary reference language. (Translatable via 
public.translations)" }, "icon_identifier": { "type": ["string", "null"], 
"description": "Optional identifier for an icon associated with this category 
(e.g., 'icon-lightbulb')." }, "is_active": { "type": "boolean", "default": 
true, "description": "Whether the category is currently active and available 
for use/display." }, "sort_order": { "type": "integer", "format": "int16", 
"default": 0, "description": "Defines a sort order for displaying categories in 
UI lists." }, "created_at": { "type": "string", "format": "date-time", 
"description": "Timestamp of when the category was created.", "readOnly": true 
}, "updated_at": { "type": "string", "format": "date-time", "description": 
"Timestamp of when the category was last updated. Auto-updated by a trigger.", 
"readOnly": true }, "created_by_profile_id": { "type": ["string", "null"], 
"format": "uuid", "description": "Profile ID of the user who created this 
category. FK to profiles.id." }, "updated_by_profile_id": { "type": ["string", 
"null"], "format": "uuid", "description": "Profile ID of the user who last 
updated this category. FK to profiles.id." } }, "required": [ "category_code", 
"default_name", "is_active", "sort_order", "created_at", "updated_at" ], 
"primary_key": ["category_code"], "foreign_keys": [ {"columns": 
["created_by_profile_id"], "references_table": "public.profiles", 
"references_columns": ["id"], "on_delete": "SET NULL"}, {"columns": 
["updated_by_profile_id"], "references_table": "public.profiles", 
"references_columns": ["id"], "on_delete": "SET NULL"} ] } ``` 5\. 
Relationships & Integrity - Primary Key: `category_code` (text). - Foreign Key 
Relationship (Incoming): Referenced by 
`user_waypoint_short_tips.tip_category_code` with `ON DELETE SET NULL` and `ON 
UPDATE CASCADE`. - Audit Relationships: `created_by_profile_id` and 
`updated_by_profile_id` reference `public.profiles(id)` with `ON DELETE SET 
NULL`. - Translations: `default_name` and `default_description` are stored in 
the primary reference language. Other language versions are stored in 
`public.translations` table, linked by `table_identifier = 
'tip_categories_master'`, `column_identifier = ('default_name' or 
'default_description')`, and `row_foreign_key = 
tip_categories_master.category_code`. The 
`trigger_cleanup_translations_on_tip_category_delete` ensures orphaned 
translations are removed. - Mermaid ER Snippet: Code snippet ``` erDiagram 
profiles { uuid id PK } tip_categories_master { text category_code PK text 
default_name "(Translatable)" text default_description "(Translatable)" text 
icon_identifier boolean is_active smallint sort_order uuid 
created_by_profile_id FK uuid updated_by_profile_id FK timestamptz created_at 
timestamptz updated_at } user_waypoint_short_tips { bigint id PK text 
tip_category_code FK } translations { text table_identifier text 
column_identifier text row_foreign_key text language_code FK } 
tip_categories_master ||--o{ user_waypoint_short_tips : "categorizes" 
tip_categories_master }o--o| profiles : "created_by" tip_categories_master 
}o--o| profiles : "updated_by" tip_categories_master ..> translations : 
"default_name translated_in" tip_categories_master ..> translations : 
"default_description translated_in" ``` 6\. Multilingual Strategy - The 
`default_name` and `default_description` columns store the category's name and 
description in the primary reference language (e.g., English). - These fields 
are translatable via the `public.translations` table. - The 
`trigger_cleanup_translations_on_tip_category_delete` ensures that when a 
category is deleted, its associated translations are also removed from 
`public.translations`. 7\. Role-Based Workflow & RLS Notes - Key Fields for 
Roles/Workflows: `is_active` (managed by Admins to control 
visibility/usability). Audit columns `created_by_profile_id` and 
`updated_by_profile_id` track administrative changes. - RLS Policies: - Admins 
(e.g., users with `admin_platform` role) have full CRUD access. - All users 
(including anonymous) can read active (`is_active = true`) categories. This is 
essential for populating category filters and displaying category information 
in the UI. 8\. ENUM vs Lookup Discussion - This table *is* a lookup table, 
which is appropriate for managing categories that require i18n, icons, sort 
order, an active status, and auditability. It replaces the previous 
`tip_category_enum`. 9\. UI/UX Enablement - Columns powering UI: `default_name` 
(translated via `public.translations`), `default_description` (translated), 
`icon_identifier`, `is_active`, `sort_order`. - Indexed Fields for UX 
Performance: `ix_tip_categories_master_active_order` supports efficient 
fetching of active categories in the desired display order. The Primary Key on 
`category_code` ensures fast lookups. 10\. Auditing & Lifecycle Management - 
Audit Columns: `created_at`, `updated_at` (auto-updated by 
`public.handle_updated_at` trigger), `created_by_profile_id`, 
`updated_by_profile_id`. - Lifecycle: Managed by the `is_active` boolean. 
Admins can deactivate categories to retire them without deleting, preserving 
historical data integrity for tips already using those categories (though `ON 
DELETE SET NULL` is on `user_waypoint_short_tips.tip_category_code`). 11\. 
Scalability & Future-Proofing - Scalability: The table is expected to remain 
small and performant. - Future-Proofing: The structure with `icon_identifier`, 
`sort_order`, and robust auditing and i18n support is well-suited for future 
enhancements. 12\. Seed Data (Example) It's recommended to seed this table with 
initial categories. created_by_profile_id and updated_by_profile_id should be 
set to an admin user's UUID. SQL ``` -- Example Seed Data (replace [ADMIN_UUID] 
with an actual admin profile_id) INSERT INTO public.tip_categories_master 
(category_code, default_name, default_description, icon_identifier, is_active, 
sort_order, created_by_profile_id, updated_by_profile_id) VALUES 
('practical_advice', 'Practical Advice', 'General tips related to practicality, 
gear, or general information.', 'icon-lightbulb', true, 10, '[ADMIN_UUID]', 
'[ADMIN_UUID]'), ('safety_observation', 'Safety Observation', 'Tips related to 
safety, warnings, or potential hazards.', 'icon-warning', true, 20, 
'[ADMIN_UUID]', '[ADMIN_UUID]'), ('hidden_gem', 'Hidden Gem', 'Tips about 
lesser-known spots or positive experiences.', 'icon-star', true, 30, 
'[ADMIN_UUID]', '[ADMIN_UUID]'), ('poi_correction', 'POI Correction', 'Tips 
suggesting corrections to Point of Interest information.', 'icon-edit', true, 
40, '[ADMIN_UUID]', '[ADMIN_UUID]'); -- Corresponding example entries in 
public.translations would be needed for 'it', etc. -- E.g., for 
'practical_advice' name in Italian: -- INSERT INTO public.translations 
(table_identifier, column_identifier, row_foreign_key, language_code, 
translated_text, created_by_profile_id, updated_by_profile_id) -- VALUES 
('tip_categories_master', 'default_name', 'practical_advice', 'it', 'Consigli 
Pratici', '[ADMIN_UUID]', '[ADMIN_UUID]'); ``` 13\. Next-Action Checklist - ðŸ”´ 
Create Table & Indexes: Execute the DDL for `public.tip_categories_master`, 
including audit columns and new indexes. - ðŸ”´ Implement `updated_at` Trigger: 
Ensure `public.handle_updated_at()` function exists and create the 
`on_tip_categories_master_updated_at` trigger. - ðŸ”´ Implement Orphaned 
Translation Cleanup Trigger: Create the 
`public.cleanup_tip_categories_master_translations()` function and the 
`trigger_cleanup_translations_on_tip_category_delete` trigger. - ðŸ”´ Implement 
RLS Policies: Apply the defined RLS policies for admin management and public 
read access. - ðŸ”´ Seed Data: Populate with initial categories and ensure 
corresponding primary language entries are set. Plan for adding translations 
into the `public.translations` table. - ðŸŸ¢ Define `icon_identifier` Convention: 
Establish a clear convention for `icon_identifier` values (e.g., CSS class 
names, SVG file names/IDs) and ensure frontend components can interpret them. - 
ðŸŸ¢ Verify Foreign Key in `user_waypoint_short_tips`: Confirm that 
`user_waypoint_short_tips.tip_category_code` is updated to correctly reference 
`tip_categories_master.category_code` with `ON DELETE SET NULL` and `ON UPDATE 
CASCADE`. 
