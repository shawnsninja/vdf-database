# 6.0.4 -  OpenAPI 3.1 Spec (for UserInteractionModule)

  https://gemini.google.com/u/1/app/8f9ebd64aa0fd57f Okay, I'm ready. CREATE 
OPENAPI FOR UserInteractionModule ### 1\. OpenAPI 3.1 Spec (for 
UserInteractionModule) YAML ``` openapi: 3.1.0 info: title: User Interaction 
API version: v1.0.0 description: |- API for managing user interactions like 
waypoint tips and votes, and tip categories. Supports multilingual content for 
categories. servers: - url: https://api.pilgrimage-platform.com/v1 # Conceptual 
description: Main API server components: securitySchemes: BearerAuth: # 
Standard Bearer Token anuth for authenticated users type: http scheme: bearer 
bearerFormat: JWT schemas: Error: type: object properties: code: type: string 
description: An application-specific error code. example: "validation_failed" 
message: type: string description: A human-readable message providing more 
details about the error. example: "Input validation failed for one or more 
fields." details: # Optional: for field-specific errors type: object 
additionalProperties: type: string example: field_name: "Error message for this 
specific field." required: - code - message Pagination: type: object 
properties: current_page: type: integer description: The current page number. 
example: 1 per_page: type: integer description: Number of items requested per 
page. example: 10 total_items: type: integer description: Total number of items 
available. example: 123 total_pages: type: integer description: Total number of 
pages available. example: 13 required: - current_page - per_page - total_items 
- total_pages TipCategory: # Based on tip_categories_master and 
view_tip_categories_localized type: object properties: category_code: type: 
string description: Unique code for the category. example: "practical_advice" 
default_name: # This is the 'name_en' if English is primary reference type: 
string description: Name of the category in the primary reference language 
(e.g., English). example: "Practical Advice" name_translations: type: object 
additionalProperties: type: string description: "Key-value map of language 
codes to translated category names. May contain only the translation for a 
requested 'lang' parameter." example: it: "Consiglio Pratico" 
default_description: type: string nullable: true description: Description of 
the category in the primary reference language. example: "General tips related 
to practicality, gear, or general information." description_translations: type: 
object nullable: true additionalProperties: type: string description: 
"Key-value map of language codes to translated category descriptions. May 
contain only the translation for a requested 'lang' parameter." example: it: 
"Consigli generali relativi alla praticit√†, attrezzatura o informazioni 
generali." icon_identifier: type: string nullable: true description: Optional 
identifier for a UI icon. example: "icon-lightbulb" sort_order: type: integer 
format: int32 # smallint description: Sort order for UI display. example: 10 # 
is_active is true due to view/endpoint filtering, not usually returned in a 
list of active items # Audit fields (created_at, etc.) can be added if needed 
for API response required: - category_code - default_name 
TipCategoryListResponse: type: object properties: data: type: array items: 
$ref: '#/components/schemas/TipCategory' required: - data AuthorSummary: type: 
object properties: profile_id: type: string format: uuid description: Profile 
ID of the author. public_display_name: type: string nullable: true description: 
Public display name of the author. # avatar_url: string (optional, would 
require join to media) required: - profile_id WaypointTip: # Based on 
user_waypoint_short_tips type: object properties: id: type: integer format: 
int64 # bigint description: Unique ID of the tip. readOnly: true tip_text: 
type: string description: The content of the tip (max 500 characters). example: 
"Great place for a quick break and water refill!" language_code: type: string 
description: Language code of the submitted tip_text. example: "en" 
tip_category: # Nested summary of the category type: object properties: 
category_code: type: string example: "practical_advice" default_name: type: 
string example: "Practical Advice" localized_name: # Name localized to 
requested lang param type: string example: "Practical Advice" # or "Consiglio 
Pratico" if lang=it required: - category_code - default_name - localized_name 
nullable: true author: $ref: '#/components/schemas/AuthorSummary' 
is_pinned_by_admin: type: boolean description: True if an admin has pinned this 
tip. created_at: type: string format: date-time description: Timestamp of tip 
creation. readOnly: true # Moderation fields (moderation_status, 
moderated_by_profile_id etc.) are typically not exposed on public GET list. # 
They would be part of an admin-specific endpoint or GET 
/tips/{tip_id}/details_with_moderation_info required: - id - tip_text - 
language_code - author - is_pinned_by_admin - created_at 
WaypointTipListResponse: type: object properties: data: type: array items: 
$ref: '#/components/schemas/WaypointTip' pagination: $ref: 
'#/components/schemas/Pagination' required: - data - pagination 
NewWaypointTipRequest: type: object properties: tip_text: type: string 
maxLength: 500 description: The content of the tip. language_code: type: string 
description: Language code of the submitted tip. example: "en" 
tip_category_code: type: string nullable: true description: Optional category 
code for the tip. example: "practical_advice" required: - tip_text - 
language_code TipModerationRequest: # For PATCH /admin/tips/{tip_id}/moderation 
type: object properties: moderation_status: $ref: 
'#/components/schemas/ContentModerationStatusEnum' # Defined below 
is_pinned_by_admin: type: boolean moderation_notes_internal: type: string 
nullable: true required: - moderation_status ContentModerationStatusEnum: type: 
string enum: - pending_approval - approved_visible - rejected_hidden - 
flagged_for_review_by_admin - archived_by_admin WaypointVote: # Response for 
POST/GET my_vote type: object properties: waypoint_id: type: integer # Assuming 
integer, confirm with waypoints.id type description: ID of the waypoint voted 
on. profile_id: type: string format: uuid description: ID of the profile that 
cast the vote. vote_type: $ref: '#/components/schemas/VoteTypeEnum' # Defined 
below created_at: type: string format: date-time updated_at: type: string 
format: date-time # deleted_at is usually not exposed directly, vote presence 
implies not deleted required: - waypoint_id - profile_id - vote_type - 
created_at - updated_at NewWaypointVoteRequest: type: object properties: 
vote_type: $ref: '#/components/schemas/VoteTypeEnum' required: - vote_type 
VoteTypeEnum: type: string enum: - up - down security: # Global security, can 
be overridden at operation level - BearerAuth: [] paths: /tip_categories: get: 
summary: List Tip Categories description: Retrieves a list of active tip 
categories, localized to the requested language. tags: - Tip Categories 
parameters: - name: lang in: query description: ISO language code for 
localization (e.g., 'it', 'en'). required: false schema: type: string - name: 
sort_by in: query description: Field to sort by (e.g., 'sort_order', 
'localized_name'). Default 'sort_order'. required: false schema: type: string - 
name: order in: query description: Sort order ('asc' or 'desc'). Default 'asc'. 
required: false schema: type: string enum: [asc, desc] responses: '200': 
description: A list of tip categories. # Uses view_tip_categories_localized for 
optimized DB query content: application/json: schema: $ref: 
'#/components/schemas/TipCategoryListResponse' # Actually an array directly for 
now # type: array # items: # $ref: '#/components/schemas/TipCategory' default: 
description: Unexpected error. content: application/json: schema: $ref: 
'#/components/schemas/Error' /admin/tip_categories: # Exemplar WRITE for 
TipCategory (Admin) post: summary: Create Tip Category (Admin) description: 
Allows an administrator to create a new tip category. tags: - Tip Categories 
Admin security: - BearerAuth: ['admin'] # Conceptual scope for admin 
requestBody: required: true content: application/json: schema: # Define a 
specific request schema if different from TipCategory response type: object 
properties: category_code: type: string default_name: type: string 
default_description: type: string nullable: true icon_identifier: type: string 
nullable: true sort_order: type: integer format: int32 is_active: # Admin can 
set this on creation type: boolean default: true required: - category_code - 
default_name responses: '201': description: Tip category created successfully. 
content: application/json: schema: $ref: '#/components/schemas/TipCategory' # 
Returns the created category '400': # Bad Request (e.g. validation error, code 
exists) $ref: '#/components/responses/BadRequestError' '401': # Unauthorized 
$ref: '#/components/responses/UnauthorizedError' '403': # Forbidden (not admin) 
$ref: '#/components/responses/ForbiddenError' default: $ref: 
'#/components/responses/DefaultError' /waypoints/{waypoint_id}/tips: get: 
summary: List Tips for a Waypoint description: Retrieves publicly visible tips 
for a specific waypoint. tags: - Waypoint Tips parameters: - name: waypoint_id 
in: path required: true description: ID of the waypoint. schema: type: integer 
# Assuming integer, confirm with waypoints.id type - name: lang in: query 
description: ISO language code for localizing tip category names. required: 
false schema: type: string - name: tip_category_code in: query description: 
Filter tips by a specific category code. required: false schema: type: string - 
name: page in: query description: Page number for pagination. required: false 
schema: type: integer default: 1 - name: per_page in: query description: Number 
of tips per page. required: false schema: type: integer default: 10 - name: 
sort_by in: query description: "Sort option (e.g. 'created_at', 
'pinned_first'). Default 'pinned_first' (is_pinned_by_admin DESC, created_at 
DESC)." required: false schema: type: string - name: order in: query 
description: "Sort order ('asc', 'desc'). Default 'desc' if sort_by is 
'created_at'." required: false schema: type: string enum: [asc, desc] 
responses: '200': description: A list of tips for the waypoint. # Query 
leverages user_waypoint_short_tips.is_publicly_visible and 
idx_user_waypoint_short_tips_visibility # Joins with profiles and 
view_tip_categories_localized (or similar logic) content: application/json: 
schema: $ref: '#/components/schemas/WaypointTipListResponse' '404': # Waypoint 
not found $ref: '#/components/responses/NotFoundError' default: $ref: 
'#/components/responses/DefaultError' post: # Exemplar WRITE for WaypointTip 
(User) summary: Submit a New Tip for a Waypoint description: Allows an 
authenticated user to submit a new tip for a waypoint. tags: - Waypoint Tips 
security: - BearerAuth: [] # Requires authenticated user parameters: - name: 
waypoint_id in: path required: true description: ID of the waypoint to submit 
the tip for. schema: type: integer # Assuming integer, confirm requestBody: 
required: true content: application/json: schema: $ref: 
'#/components/schemas/NewWaypointTipRequest' responses: '201': description: Tip 
submitted successfully (pending moderation). content: application/json: schema: 
$ref: '#/components/schemas/WaypointTip' # Returns the created tip (with its 
initial state) '400': # Bad Request (validation) $ref: 
'#/components/responses/BadRequestError' '401': # Unauthorized $ref: 
'#/components/responses/UnauthorizedError' '404': # Waypoint not found $ref: 
'#/components/responses/NotFoundError' default: $ref: 
'#/components/responses/DefaultError' /admin/tips/{tip_id}/moderation: # 
Exemplar WRITE for WaypointTip (Admin Moderation) patch: summary: Moderate a 
Waypoint Tip (Admin) description: Allows an administrator/moderator to update 
the moderation status of a tip. tags: - Waypoint Tips Admin security: - 
BearerAuth: ['moderator', 'admin'] # Conceptual scopes parameters: - name: 
tip_id in: path required: true description: ID of the tip to moderate. schema: 
type: integer format: int64 requestBody: required: true content: 
application/json: schema: $ref: '#/components/schemas/TipModerationRequest' 
responses: '200': description: Tip moderation status updated successfully. 
content: application/json: schema: $ref: '#/components/schemas/WaypointTip' # 
Returns the updated tip '400': # Bad Request (validation) $ref: 
'#/components/responses/BadRequestError' '401': # Unauthorized $ref: 
'#/components/responses/UnauthorizedError' '403': # Forbidden (not 
moderator/admin) $ref: '#/components/responses/ForbiddenError' '404': # Tip not 
found $ref: '#/components/responses/NotFoundError' default: $ref: 
'#/components/responses/DefaultError' /waypoints/{waypoint_id}/votes: # 
Exemplar WRITE for WaypointVote (User) post: summary: Cast or Update Vote for a 
Waypoint description: Allows an authenticated user to cast or change their vote 
(up/down) for a waypoint. Handles UPSERT logic. tags: - Waypoint Votes 
security: - BearerAuth: [] # Requires authenticated user parameters: - name: 
waypoint_id in: path required: true description: ID of the waypoint to vote on. 
schema: type: integer # Assuming integer, confirm requestBody: required: true 
content: application/json: schema: $ref: 
'#/components/schemas/NewWaypointVoteRequest' responses: '200': # Could be 200 
for update, 201 for new vote. Simplified to 200 for UPSERT. description: Vote 
cast/updated successfully. content: application/json: schema: $ref: 
'#/components/schemas/WaypointVote' # Returns the current state of the vote 
'400': # Bad Request (validation) $ref: 
'#/components/responses/BadRequestError' '401': # Unauthorized $ref: 
'#/components/responses/UnauthorizedError' '404': # Waypoint not found $ref: 
'#/components/responses/NotFoundError' default: $ref: 
'#/components/responses/DefaultError' delete: summary: Retract Vote for a 
Waypoint description: Allows an authenticated user to retract (soft delete) 
their vote for a waypoint. tags: - Waypoint Votes security: - BearerAuth: [] 
parameters: - name: waypoint_id in: path required: true description: ID of the 
waypoint from which to retract the vote. schema: type: integer # Assuming 
integer, confirm responses: '204': description: Vote retracted successfully. 
'401': $ref: '#/components/responses/UnauthorizedError' '404': # Vote not found 
(or waypoint not found) $ref: '#/components/responses/NotFoundError' default: 
$ref: '#/components/responses/DefaultError' # Shared response components (can 
be expanded) responses: NotFoundError: description: The specified resource was 
not found. content: application/json: schema: $ref: 
'#/components/schemas/Error' BadRequestError: description: The request was 
malformed or invalid. content: application/json: schema: $ref: 
'#/components/schemas/Error' UnauthorizedError: description: Authentication 
credentials were not provided or are invalid. content: application/json: 
schema: $ref: '#/components/schemas/Error' ForbiddenError: description: The 
authenticated user does not have permission to perform this action. content: 
application/json: schema: $ref: '#/components/schemas/Error' DefaultError: 
description: An unexpected error occurred. content: application/json: schema: 
$ref: '#/components/schemas/Error' ``` * * * * * ### 2\. Quick-Start Examples 
1. List active tip categories (localized to Italian): Bash ``` curl -X GET 
"https://api.pilgrimage-platform.com/v1/tip_categories?lang=it"\ -H 
"Authorization: Bearer <USER_JWT_TOKEN>"\ -H "apikey: <SUPABASE_ANON_KEY>" ``` 
Sample Response: JSON ``` { "data": [ { "category_code": "practical_advice", 
"default_name": "Practical Advice", "name_translations": { "it": "Consiglio 
Pratico" }, "default_description": "General tips related to practicality, gear, 
or general information.", "description_translations": { "it": "Consigli 
generali relativi alla praticit√†, attrezzatura o informazioni generali." }, 
"icon_identifier": "icon-lightbulb", "sort_order": 10 } ] } ``` 2. Submit a new 
tip for waypoint with ID 789: Bash ``` curl -X POST 
"https://api.pilgrimage-platform.com/v1/waypoints/789/tips"\ -H "Authorization: 
Bearer <USER_JWT_TOKEN>"\ -H "apikey: <SUPABASE_ANON_KEY>"\ -H "Content-Type: 
application/json"\ -d '{ "tip_text": "Fantastic panoramic view just off the 
main trail here!", "language_code": "en", "tip_category_code": "hidden_gem" }' 
``` Sample Response (201 Created): JSON ``` { "id": 123, // New tip ID 
"tip_text": "Fantastic panoramic view just off the main trail here!", 
"language_code": "en", "tip_category": { "category_code": "hidden_gem", 
"default_name": "Hidden Gem", // Assuming English is default "localized_name": 
"Hidden Gem" // Assuming lang not specified or matched default }, "author": { 
"profile_id": "uuid-current-user", "public_display_name": "CurrentUserDisplay" 
}, "is_pinned_by_admin": false, "created_at": "2025-05-18T21:30:00Z" // 
moderation_status would be 'pending_approval' server-side } ``` 3. Admin 
moderates tip with ID 123 (approves it): Bash ``` curl -X PATCH 
"https://api.pilgrimage-platform.com/v1/admin/tips/123/moderation"\ -H 
"Authorization: Bearer <ADMIN_JWT_TOKEN>"\ -H "apikey: <SUPABASE_ANON_KEY>"\ -H 
"Content-Type: application/json"\ -d '{ "moderation_status": 
"approved_visible", "is_pinned_by_admin": false }' ``` Sample Response (200 
OK): JSON ``` { "id": 123, "tip_text": "Fantastic panoramic view just off the 
main trail here!", "language_code": "en", // ... other fields ... 
"is_pinned_by_admin": false, "created_at": "2025-05-18T21:30:00Z" // now 
is_publicly_visible would be true } ``` * * * * * ### 3\. Implementation Notes 
- üü¢ Schema OK for Endpoints: The current database schema for 
`tip_categories_master`, `user_waypoint_short_tips`, and `user_waypoint_votes` 
largely supports these API endpoints. - Views for Optimization & 
Simplification: - `public.view_tip_categories_localized`: Crucial for the `GET 
/tip_categories` endpoint and for providing localized category data to the `GET 
/waypoints/{waypoint_id}/tips` endpoint. Ensure this view is created and 
includes `default_name`, `default_description`, `localized_name`, and 
`localized_description` (based on `current_setting('app.current_lang', true)`). 
- `public.view_waypoint_tips_detailed` (Recommended): For `GET 
/waypoints/{waypoint_id}/tips`, creating a dedicated view that joins 
`user_waypoint_short_tips` with `profiles` (for author `public_display_name`), 
`media` (for author `avatar_url` via `profiles.public_avatar_media_id`), and 
`public.view_tip_categories_localized` (for category details) would greatly 
simplify the API data retrieval logic and improve maintainability. - Indexes: - 
Existing indexes on `user_waypoint_short_tips` 
(`idx_user_waypoint_short_tips_visibility`, 
`idx_user_waypoint_short_tips_tip_category_code`) are good. - 
`view_tip_categories_localized` relies on indexes on `tip_categories_master` 
(`PK`, `ix_tip_categories_master_active_order`) and `translations` 
(`idx_translations_lookup`), which are in place. - Language Handling: The 
`lang` query parameter should be used by the API backend to set the 
`app.current_lang` PostgreSQL session variable before querying views like 
`view_tip_categories_localized`. - Write Operations: - `POST 
/waypoints/{waypoint_id}/votes`: Backend logic will need to handle the UPSERT 
behavior (insert if no vote, update if vote exists, manage `deleted_at` for 
retractions/re-votes) for the current authenticated user (`auth.uid()`). The 
`update_waypoint_vote_counts()` trigger is critical here. - `POST 
/waypoints/{waypoint_id}/tips`: Sets `profile_id` from `auth.uid()` and 
`moderation_status` to `'pending_approval'` by default. - `PATCH 
/admin/tips/{tip_id}/moderation`: Requires robust authorization to ensure only 
moderators/admins can call it. Updates `moderation_status`, 
`moderated_by_profile_id` (from `auth.uid()`), `moderation_timestamp`. - üî¥ 
Critical Dependencies (from previous reviews, re-iterated): - `waypoint_id` 
Data Type: Must be consistent between `waypoints.id` and referencing columns in 
`user_waypoint_short_tips` and `user_waypoint_votes`. - Moderator Check 
Function: The `public.check_if_user_is_moderator(UUID)` function (or 
equivalent) needs to be implemented for RLS on `user_waypoint_short_tips` to 
work for moderator actions. - `waypoints` table vote counts: Columns 
`up_vote_count`, `down_vote_count` must exist on `public.waypoints` for the 
`update_waypoint_vote_counts()` trigger to function. - User Tip Updates: The 
`PATCH /tips/{tip_id}` endpoint for users to update their own tips (e.g., 
retract via `deleted_at`, or edit `tip_text` if `moderation_status` is 
`pending_approval`) needs careful RLS and potentially trigger logic if editing 
an approved tip should reset its moderation status. This was discussed in the 
`user_waypoint_short_tips` spec. (This specific PATCH endpoint wasn't detailed 
in the YAML above to keep it to "one exemplar" but is a related consideration 
for a complete API). 
