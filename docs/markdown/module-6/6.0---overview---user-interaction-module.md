# 6.0 - overview - User Interaction Module

  https://gemini.google.com/u/1/app/7a9daee28ed15dc2 
https://gemini.google.com/u/1/app/8f9ebd64aa0fd57f Okay, I will update the "6. 
User Interaction Module" overview document in full, incorporating all the 
refinements and decisions we've made. This updated overview will provide a 
clear and current picture of the module. * * * * * User Interaction Module 
Overview -------------------------------- Version: 2.0 (Incorporating V2.1 
Table Specifications and API Conceptualization) Date: May 18, 2025 1\. 
Executive Summary This database module enables core user engagement by allowing 
pilgrims to cast votes on waypoints and share textual tips. It supports 
community sentiment analysis, content moderation for tips, and robust, 
multilingual category management for enhanced user experience. Key 
functionalities include capturing user votes which directly update waypoint 
popularity, managing user-submitted tips through a defined moderation workflow, 
and categorizing tips using a centralized, translatable system. These features 
directly fuel platform capabilities like sorting content by popularity and 
providing users with recent, practical, and categorized insights. 2\. 
Group-Level Snapshot | Group | Key Tables | Primary Purpose | Top Inter-Group 
Links | | 6\. User Interaction Module | `user_waypoint_votes`, 
`user_waypoint_short_tips`, `tip_categories_master` | Capturing user votes on 
waypoints, managing user-submitted tips with moderation, and defining 
standardized, translatable categories for tips. | `profiles` (for user 
identity/authorship), `waypoints` (for content being interacted with), 
`languages_master` (for tip language), `translations` (for category i18n). | 
3\. Narrative Walkthrough This module, "6. User Interaction Module," focuses on 
capturing direct user feedback and contributions related to waypoints. - 
`tip_categories_master` (v2.1): - Role: Defines a standardized, admin-managed 
list of categories for user tips. This supports multilingual display of 
category names and consistent tip organization. - üîë This table is referenced 
by `user_waypoint_short_tips` via `tip_category_code`. - Critical: - 
`category_code`: Primary key (e.g., 'practical_advice'). - `default_name`, 
`default_description`: Store the category name and description in the primary 
reference language (e.g., English). These fields are translatable via 
`public.translations`. - `icon_identifier`: Optional string for a UI icon. - 
`is_active`: Boolean to enable/disable categories. - `created_by_profile_id`, 
`updated_by_profile_id`: Standard audit columns linking to `profiles`. - 
`created_at`, `updated_at`: Timestamps for category definition, with 
`updated_at` managed by the `public.handle_updated_at` trigger. - An `AFTER 
DELETE` trigger (`trigger_cleanup_translations_on_tip_category_delete`) ensures 
orphaned entries in `public.translations` are removed. - `user_waypoint_votes` 
(v2.1.1): - Role: Enables authenticated users (pilgrims) to cast "thumbs up" or 
"thumbs down" votes on waypoints. - üîë This table acts as a many-to-many 
junction table between `profiles` and `waypoints` through its composite primary 
key `(profile_id, waypoint_id)`. Each user can vote once per waypoint. - 
Critical: - `vote_type`: An ENUM (`'up'`, `'down'`) indicating the vote. - 
`created_at`, `updated_at`: Timestamps for vote creation and modification, with 
`updated_at` managed by the `public.handle_updated_at` trigger. - `deleted_at`: 
For soft deletion (vote retraction). - `update_waypoint_vote_counts` trigger: 
This is a crucial `AFTER INSERT/UPDATE/DELETE` trigger that denormalizes 
`up_vote_count` and `down_vote_count` onto the `public.waypoints` table for 
performance. This requires `up_vote_count` and `down_vote_count` columns to 
exist on `public.waypoints`. - `user_waypoint_short_tips` (v2.1.1): - Role: 
Stores brief, user-submitted textual tips about waypoints, subject to a 
moderation workflow. - üîë This table has many-to-one relationships with 
`profiles` (tip author), `waypoints` (tip subject), `languages_master` (tip 
language), and `tip_categories_master` (tip category). - Critical: - 
`tip_text`: The content, with a 500-character limit enforced by a `CHECK` 
constraint. - `language_code`: Stores the language of the tip, FK to 
`languages_master`. - `tip_category_code`: Foreign key to 
`tip_categories_master.category_code` (`ON DELETE SET NULL`). - 
`moderation_status`: An ENUM (`'pending_approval'`, `'approved_visible'`, etc.) 
defaulting to `'pending_approval'`. - `is_publicly_visible`: A `STORED` 
generated column (PostgreSQL 12+) derived from `moderation_status = 
'approved_visible'::public.content_moderation_status_enum AND deleted_at IS 
NULL`. - `moderated_by_profile_id`, `moderation_timestamp`, 
`moderation_notes_internal`: For moderation audit trail. - `profile_id` serves 
as the creator ID. - `created_at`, `updated_at`, `deleted_at`: Standard audit 
and soft-delete columns, with `updated_at` managed by the 
`public.handle_updated_at` trigger. 4\. Cross-Cutting Concerns - Users & Roles: 
- `profile_id` from the `profiles` table is consistently used to link votes and 
tips to their authors. - Ownership is enforced via RLS, allowing users to 
manage their own contributions (e.g., insert, update under conditions, view 
their own votes/tips). - Moderation roles are critical for 
`user_waypoint_short_tips`, with fields like `moderated_by_profile_id` and 
specific RLS policies for moderators. The RLS policies rely on a function like 
`public.check_if_user_is_moderator(UUID)` for identifying users with moderation 
privileges. - Translations / i18n: - `tip_categories_master` now stores 
`default_name` and `default_description` in the primary reference language. 
These are translatable via `public.translations`. An `AFTER DELETE` trigger on 
`tip_categories_master` handles orphaned translation cleanup. - The 
`public.view_tip_categories_localized` view is available to provide category 
names and descriptions in the user's current language. - 
`user_waypoint_short_tips.tip_text` is stored in the language it was submitted 
in, indicated by `language_code` (FK to `languages_master`). This allows for 
UI-level filtering or future UI-driven translation features. - 
`user_waypoint_votes.vote_type` ('up', 'down') are internal system values; UI 
representation is handled by the frontend. - ENUM & Taxonomy Registry: - 
`public.vote_type_enum`: Used in `user_waypoint_votes.vote_type`. Defined as 
`('up', 'down')`. - `public.content_moderation_status_enum`: Used in 
`user_waypoint_short_tips.moderation_status`. Defined as `('pending_approval', 
'approved_visible', 'rejected_hidden', 'flagged_for_review_by_admin', 
'archived_by_admin')`. - Tip categories are managed by the 
`public.tip_categories_master` lookup table. - Media & Files: - 
`tip_categories_master.icon_identifier` can store a string to link categories 
to UI icons. No direct file storage is managed by these tables. - Audit / 
Soft-Delete / Versioning: - All three core tables include `created_at` (default 
`now()`) and `updated_at` (default `now()`, auto-updated by 
`public.handle_updated_at` trigger). - `tip_categories_master` now includes 
`created_by_profile_id` and `updated_by_profile_id`. - For 
`user_waypoint_votes`, `profile_id` serves as the creator/updater identifier 
due to RLS. - For `user_waypoint_short_tips`, `profile_id` is the author, and 
`moderated_by_profile_id` tracks moderation updates. - Soft Deletion: 
`user_waypoint_votes` and `user_waypoint_short_tips` implement soft deletion 
using a nullable `deleted_at` timestamp. `tip_categories_master` uses 
`is_active`. - Versioning: Detailed history of changes (e.g., previous 
`tip_text` values) is considered V2+ and not implemented. 5\. Security & Access 
Control üîê - RLS Overview: - Row Level Security is enabled for 
`user_waypoint_votes`, `user_waypoint_short_tips`, and `tip_categories_master`. 
- `tip_categories_master`: RLS allows admins to manage categories and public 
read access to active categories. - `user_waypoint_votes`: Policies allow 
authenticated users to insert, update (change vote type or retract via 
`deleted_at`), and view their own votes. - `user_waypoint_short_tips`: Policies 
allow authenticated users to insert their own tips (defaulting to 
'pending_approval'), view all publicly visible tips (via 
`is_publicly_visible`), view their own tips regardless of status, and update 
their own tips under specific conditions (e.g., retraction, or editing if still 
pending approval). Moderator policies (relying on 
`public.check_if_user_is_moderator(UUID)`) grant broader access for viewing and 
updating tips for moderation. - Dedicated SECURITY DEFINER Functions: - 
`public.cleanup_tip_categories_master_translations()`: For cleaning orphaned 
translations. - `public.update_waypoint_vote_counts()`: Modifies 
`public.waypoints` and may require `SECURITY DEFINER` if RLS on `waypoints` 
restricts direct updates by users. - The conceptual 
`public.check_if_user_is_moderator(UUID)` function, used for RLS on 
`user_waypoint_short_tips`, would likely need to be `SECURITY DEFINER` if it 
queries privileged role information. - Notes on `anon` vs `authenticated` 
access: - `user_waypoint_votes`: Anonymous users (`anon` role) generally do not 
have rights. Authenticated users interact with their own votes. - 
`user_waypoint_short_tips`: Anonymous users generally do not have write access. 
Read access for `anon` role is typically limited to tips where 
`is_publicly_visible = true`, often managed at the API gateway or by specific 
RLS if direct DB access is granted to `anon`. - `tip_categories_master`: 
Anonymous users can read active categories via the RLS policy. 6\. Prerequisite 
Objects & Build Order ‚öôÔ∏è (Order assumes auth.users, public.profiles, 
public.waypoints, public.languages_master, public.translations tables, and 
extensions.moddatetime or public.handle_updated_at function exist). 1. Global 
Helper Functions (SQL/PLPGSQL) - `public.handle_updated_at()`: Updates 
`updated_at` timestamp. - `public.check_if_user_is_moderator(UUID)`: (Needs 
definition) Checks if a user has moderator privileges. 2. Types & ENUMs - 
`public.vote_type_enum AS ENUM ('up', 'down');` - 
`public.content_moderation_status_enum AS ENUM ('pending_approval', ...);` 3. 
`public.waypoints` Table Modifications - Ensure `up_vote_count INTEGER NOT NULL 
DEFAULT 0` and `down_vote_count INTEGER NOT NULL DEFAULT 0` columns exist. 4. 
Core Table: `public.tip_categories_master` (v2.1) - Create table with 
`default_name`, `default_description`, audit columns. - DDL for 
`public.cleanup_tip_categories_master_translations()` trigger function. 5. Core 
Table: `public.user_waypoint_votes` (v2.1.1) - Create table. - DDL for 
`public.update_waypoint_vote_counts()` trigger function. 6. Core Table: 
`public.user_waypoint_short_tips` (v2.1.1) - Create table with generated column 
`is_publicly_visible`. 7. Views - `public.view_tip_categories_localized`: 
Provides localized category names. 8. Indexes & Constraints - Apply all defined 
PKs, FKs, CHECK constraints, and specific indexes for each table. 9. Triggers 
(Application of DML Triggers) - Apply `handle_updated_at` triggers to all three 
tables. - Apply `after_user_waypoint_votes_change` trigger to 
`user_waypoint_votes`. - Apply 
`trigger_cleanup_translations_on_tip_category_delete` to 
`tip_categories_master`. 10. RLS Policies - Enable RLS and apply all defined 
policies for each table. 11. Seed Data - Populate `tip_categories_master` with 
initial categories and their default names/descriptions. Ensure corresponding 
translations are planned/added to `public.translations`. 7\. Performance & 
Optimization Extras - Key Indexes & Why: - `user_waypoint_votes`: Composite PK 
`(profile_id, waypoint_id)` for uniqueness and lookups; 
`idx_user_waypoint_votes_active` for querying active votes. - 
`user_waypoint_short_tips`: `idx_user_waypoint_short_tips_visibility` for 
efficient display of public tips; `idx_user_waypoint_short_tips_moderation` for 
moderation queues; indexes on `profile_id`, `language_code`, 
`tip_category_code`. - `tip_categories_master`: PK on `category_code`; 
`ix_tip_categories_master_active_order` for UI lists. - Denormalization: - 
`up_vote_count` and `down_vote_count` on `public.waypoints`, updated by trigger 
from `user_waypoint_votes`, are critical for UI performance, avoiding costly 
aggregations. - Generated Column: - 
`user_waypoint_short_tips.is_publicly_visible` (`STORED`) simplifies queries 
for visible tips and improves read performance. - Views: - 
`public.view_tip_categories_localized` optimizes fetching and localizing tip 
category data for UI elements. 8\. Visuals (Conceptual ERD - Key Tables & 
Links) Code snippet ``` erDiagram profiles { uuid id PK # ... other fields } 
waypoints { integer id PK # CRITICAL: Confirm type string name integer 
up_vote_count "DENORMALIZED" integer down_vote_count "DENORMALIZED" # ... other 
fields } languages_master { text language_code PK # ... other fields } 
tip_categories_master { text category_code PK text default_name 
"(Translatable)" text default_description "(Translatable, Nullable)" text 
icon_identifier "(Nullable)" boolean is_active smallint sort_order uuid 
created_by_profile_id FK uuid updated_by_profile_id FK timestamptz created_at 
timestamptz updated_at } translations { bigint id PK # Assuming from main 
translations spec text table_identifier text column_identifier text 
row_foreign_key text language_code FK text translated_text # ... other fields } 
user_waypoint_votes { uuid profile_id PK, FK integer waypoint_id PK, FK # 
CRITICAL: Confirm type vote_type_enum vote_type text vote_source_platform 
"(Nullable)" timestamptz created_at timestamptz updated_at timestamptz 
deleted_at "(Nullable)" } user_waypoint_short_tips { bigint id PK uuid 
profile_id FK integer waypoint_id FK # CRITICAL: Confirm type text tip_text 
"CHECK len<=500" text language_code FK text tip_category_code FK "(Nullable)" 
text tip_source_platform "(Nullable)" content_moderation_status_enum 
moderation_status boolean is_publicly_visible "GENERATED" boolean 
is_pinned_by_admin uuid moderated_by_profile_id FK "(Nullable)" timestamptz 
moderation_timestamp "(Nullable)" text moderation_notes_internal "(Nullable)" 
timestamptz created_at timestamptz updated_at timestamptz deleted_at 
"(Nullable)" } profiles ||--o{ user_waypoint_votes : "casts_vote" waypoints 
||--o{ user_waypoint_votes : "receives_vote_for" profiles ||--o{ 
user_waypoint_short_tips : "submits_tip" waypoints ||--o{ 
user_waypoint_short_tips : "has_tip_about" languages_master ||--|| 
user_waypoint_short_tips : "tip_language_is" tip_categories_master ||--o{ 
user_waypoint_short_tips : "categorized_by" profiles ||--o{ 
user_waypoint_short_tips : "tip_moderated_by" profiles ||--o| 
tip_categories_master : "category_created_by" profiles ||--o| 
tip_categories_master : "category_updated_by" tip_categories_master ..> 
translations : "default_name translated_in" tip_categories_master ..> 
translations : "default_description translated_in" ``` 9\. Data & Workflow 
Flowchart - A. User Waypoint Vote Lifecycle: 1. User Action (Frontend): Pilgrim 
clicks "up-vote" or "down-vote" on a waypoint. 2. Application Backend: Receives 
request (`profile_id` from auth, `waypoint_id`, `vote_type`). Performs an 
UPSERT on `user_waypoint_votes`. - No existing vote: `INSERT` new record 
(`deleted_at = NULL`). - Existing vote (same `profile_id`, `waypoint_id`): - 
Different `vote_type` & `deleted_at IS NULL`: `UPDATE vote_type`. - Same 
`vote_type` & `deleted_at IS NULL` (re-click same): `UPDATE deleted_at = NOW()` 
(Retract). - `deleted_at IS NOT NULL` (re-vote after retraction): `UPDATE 
vote_type`, `deleted_at = NULL`. 3. Database (`user_waypoint_votes`): `BEFORE 
UPDATE` trigger updates `updated_at`. `AFTER INSERT/UPDATE/DELETE` trigger 
`after_user_waypoint_votes_change` fires. 4. Database (`waypoints` via 
trigger): `update_waypoint_vote_counts` function adjusts `up_vote_count` and 
`down_vote_count`. 5. End-User Consumption: Waypoints display aggregated 
counts. UI reflects user's own vote status. - B. User Waypoint Short Tip 
Lifecycle: 1. User Action (Frontend): Pilgrim submits a tip (`tip_text`, 
`tip_category_code` (optional), `language_code`). 2. Application Backend: 
Validates input. `INSERT` into `user_waypoint_short_tips`. `moderation_status` 
defaults to `'pending_approval'`. 3. Database (`user_waypoint_short_tips`): 
`is_publicly_visible` is computed. 4. Moderation Workflow (Admin Interface): 
Moderators view tips (e.g., `moderation_status = 'pending_approval'`). Can 
change `moderation_status`, set `is_pinned_by_admin`, add 
`moderation_notes_internal`. `moderated_by_profile_id` and 
`moderation_timestamp` are recorded. `updated_at` is updated. 5. User Action 
(Update/Retract Tip): Pilgrim views their own tips. Can retract (`deleted_at = 
NOW()`) or edit if `moderation_status = 'pending_approval'`. Edits to approved 
tips must revert status to `pending_approval` (critical business rule). 6. 
End-User Consumption: Pilgrims view tips where `is_publicly_visible = true`. 
Tips can be filtered by `language_code` or localized `tip_category_code`. 
Pinned tips are prominent. 10\. Critical Gaps & Risks - üî¥ `waypoints` Table 
Modifications & Vote Count Trigger (P1): `up_vote_count` and `down_vote_count` 
columns *must* be added to `public.waypoints`. The 
`public.update_waypoint_vote_counts()` trigger must be robustly implemented and 
tested. - üî¥ User Tip Edit Policy & RLS Definition (P1): Business rules for 
users editing their own tips (especially after approval) *must* be finalized. 
RLS policies and any associated application logic/triggers must correctly 
manage `moderation_status` changes upon such edits. - üî¥ Confirm `waypoint_id` 
Data Type (P1): Verify that `integer` (or chosen type) for `waypoint_id` in 
`user_waypoint_votes` and `user_waypoint_short_tips` matches 
`public.waypoints.id` type. Adjust all related DDL if necessary. - üî¥ Moderator 
Identification Function (P1): The `public.check_if_user_is_moderator(UUID)` 
function for `user_waypoint_short_tips` RLS *must* be implemented. - üü† 
Translation Data for Categories (P2): Ensure initial `tip_categories_master` 
seed data has corresponding entries in `public.translations` for all supported 
languages. - üü† Application Logic for Vote Lifecycle (P2): The UPSERT pattern 
for vote handling needs robust implementation in the application backend. 11\. 
Scalability & Future-Proof Notes - Partitioning: Not anticipated for V1 on 
`user_waypoint_votes` or `user_waypoint_short_tips`. Denormalization and 
indexing are primary strategies. - Text Search (V2+ for Tips): For 
`user_waypoint_short_tips.tip_text`, plan for PostgreSQL Full-Text Search (FTS) 
by adding a `tsvector` column and GIN index. - Vote Abuse/Spam (V2+ for Votes): 
Application-level rate limiting or other detection mechanisms may be needed. - 
Tip "Helpfulness" Voting / Reporting (V2+ for Tips): Current schema allows for 
future extension. - Audit Columns & Soft Deletion: Provide good foundational 
audit and data preservation. 12\. Next Steps (Module Finalization) 1. P1: 
Implement `waypoints` Table Modifications for vote counts. 2. P1: Implement and 
Test `update_waypoint_vote_counts` Trigger. 3. P1: Confirm and Align 
`waypoint_id` Data Type across tables. 4. P1: Finalize and Implement User Tip 
Edit Policy (RLS and any app/DB triggers). 5. P1: Define and Implement 
`public.check_if_user_is_moderator(UUID)`. 6. P1: Create 
`tip_categories_master` table, `view_tip_categories_localized`, associated 
triggers, RLS, and seed data (including planning for `translations` entries). 
7. P2: Fully Implement and Test All RLS Policies for all module tables. 8. P2: 
Develop and Test Application Backend Logic for vote lifecycle (UPSERT) and tip 
submission/moderation workflows. 9. P2: If applicable, create and run backfill 
script for denormalized vote counts on `waypoints`. 10. P2: Document the 
`app.current_lang` GUC setup or chosen language context mechanism for 
`view_tip_categories_localized`. * * * * * 
